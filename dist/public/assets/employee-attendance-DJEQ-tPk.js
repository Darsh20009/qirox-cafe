import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as o}from"./vendor-react-Bzsngnqy.js";import{c as ne,e as ie,i as ce,B as p,af as le,C,f as k,x as O,y as T,r as oe,j as X,o as de,q as D,W as me,A as ue}from"./index-61RjstaY.js";import{c as Z,l as _,b as H,e as G,d as pe,M as he,T as xe,a as R,L}from"./leaflet-Cu_ciSmi.js";import{C as fe}from"./calendar-Cex3TfGh.js";import{C as S}from"./circle-check-C68tr6Vl.js";import{C as ge}from"./circle-x-D9GYVDcC.js";import{B as je}from"./briefcase-FcHUEvv3.js";import{F as ye}from"./file-text-tC1Q1Af5.js";import{C as Ne}from"./circle-alert-DPdcINna.js";import{R as ve}from"./refresh-cw-DWvJTizr.js";import{C as M}from"./camera-v_eqnnci.js";import"./vendor-query-CX8ZYlKb.js";import"./vendor-utils-BKCsaWdX.js";function be(i,t,r){t.center!==r.center&&i.setLatLng(t.center),t.radius!=null&&t.radius!==r.radius&&i.setRadius(t.radius)}const we=Z(function({center:t,children:r,...d},m){const c=new _.Circle(t,d);return H(c,G(m,{overlayContainer:c}))},be),Ce=Z(function({positions:t,...r},d){const m=new _.Polyline(t,r);return H(m,G(d,{overlayContainer:m}))},function(t,r,d){r.positions!==d.positions&&t.setLatLngs(r.positions)}),z=pe(function(t,r){const d=new _.Popup(t,r.overlayContainer);return H(d,r)},function(t,r,{position:d},m){o.useEffect(function(){const{instance:n}=t;function h(l){l.popup===n&&(n.update(),m(!0))}function u(l){l.popup===n&&m(!1)}return r.map.on({popupopen:h,popupclose:u}),r.overlayContainer==null?(d!=null&&n.setLatLng(d),n.openOn(r.map)):r.overlayContainer.bindPopup(n),function(){r.map.off({popupopen:h,popupclose:u}),r.overlayContainer?.unbindPopup(),r.map.removeLayer(n)}},[t,r,m,d])});delete L.Icon.Default.prototype._getIconUrl;L.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});const ke=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),F=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function Se({userLocation:i,branchLocation:t,distance:r,mapsUrl:d,onClose:m,allBranches:c,selectedBranchId:n}){const h=c&&c.length>0?{lat:c.reduce((l,g)=>l+g.lat,0)/c.length,lng:c.reduce((l,g)=>l+g.lng,0)/c.length}:{lat:(i.lat+t.lat)/2,lng:(i.lng+t.lng)/2},u=c?12:r>5e3?11:r>1e3?13:14;return e.jsx(e.Fragment,{children:e.jsx("div",{className:"h-80 rounded-2xl overflow-hidden shadow-2xl",children:e.jsxs(he,{center:[h.lat,h.lng],zoom:u,style:{height:"100%",width:"100%"},scrollWheelZoom:!0,children:[e.jsx(xe,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:""}),e.jsx(R,{position:[i.lat,i.lng],icon:ke,children:e.jsx(z,{children:e.jsx("div",{dir:"rtl",children:"موقعك الحالي"})})}),c&&c.map(l=>e.jsx(R,{position:[l.lat,l.lng],icon:(l.id===n,F),children:e.jsx(z,{children:e.jsx("div",{dir:"rtl",children:l.nameAr})})},l.id)),!c&&e.jsx(R,{position:[t.lat,t.lng],icon:F,children:e.jsx(z,{children:e.jsx("div",{dir:"rtl",children:"موقع الفرع"})})}),n&&e.jsx(Ce,{positions:[[i.lat,i.lng],[t.lat,t.lng]],color:"rgb(217, 119, 6)",weight:2,opacity:.7,dashArray:"5, 5"}),e.jsx(we,{center:[i.lat,i.lng],radius:200,fillColor:"rgb(59, 130, 246)",fillOpacity:.1,color:"rgb(59, 130, 246)",weight:2})]})})})}function Je(){const[,i]=ne(),{toast:t}=ie(),[r,d]=o.useState(null),[m,c]=o.useState(!1),[n,h]=o.useState(null),[u,l]=o.useState(null),[g,j]=o.useState(null),[J,b]=o.useState(null),[K,P]=o.useState(!1),[x,w]=o.useState(null),[y,E]=o.useState(null),N=o.useRef(null),I=o.useRef(null),v=o.useRef(null);o.useEffect(()=>{const s=localStorage.getItem("currentEmployee");return s?(d(JSON.parse(s)),U()):i("/employee/gateway"),()=>{v.current&&v.current.getTracks().forEach(a=>a.stop())}},[i]);const U=async()=>{try{const s=await fetch("/api/attendance/my-status",{credentials:"include"});if(s.ok){const a=await s.json();h(a)}}catch(s){console.error("Error fetching attendance status:",s)}},A=o.useCallback(()=>{if(j(null),!navigator.geolocation){j("المتصفح لا يدعم تحديد الموقع");return}navigator.geolocation.getCurrentPosition(s=>{l({lat:s.coords.latitude,lng:s.coords.longitude})},s=>{switch(s.code){case s.PERMISSION_DENIED:j("تم رفض إذن تحديد الموقع. يرجى السماح بتحديد الموقع من إعدادات المتصفح.");break;case s.POSITION_UNAVAILABLE:j("معلومات الموقع غير متوفرة.");break;case s.TIMEOUT:j("انتهت مهلة طلب الموقع.");break;default:j("حدث خطأ غير معروف.")}},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[]);o.useEffect(()=>{A()},[A]);const W=async()=>{P(!0);try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});v.current=s,N.current&&(N.current.srcObject=s)}catch{t({title:"خطأ",description:"لا يمكن الوصول للكاميرا",variant:"destructive"}),P(!1)}},Q=async()=>{if(!N.current||!I.current)return;const s=N.current,a=I.current,q=a.getContext("2d");if(!q)return;a.width=s.videoWidth,a.height=s.videoHeight,q.drawImage(s,0,0);const B=a.toDataURL("image/jpeg",.8);b(B),v.current&&v.current.getTracks().forEach(f=>f.stop()),P(!1);const ae=await fetch(B).then(f=>f.blob()),V=new FormData;V.append("photo",ae,"attendance.jpg");try{const f=await fetch("/api/upload-attendance-photo",{method:"POST",body:V,credentials:"include"});if(f.ok){const re=await f.json();w(re.url)}else throw new Error("Upload failed")}catch{t({title:"خطأ",description:"فشل رفع الصورة",variant:"destructive"})}},Y=()=>{b(null),w(null),W()},$=async()=>{if(!u){t({title:"خطأ",description:"يرجى تحديد الموقع أولاً",variant:"destructive"});return}if(!x){t({title:"خطأ",description:"يرجى التقاط صورة أولاً",variant:"destructive"});return}c(!0);try{const s=await fetch("/api/attendance/check-in",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:u,photoUrl:x}),credentials:"include"}),a=await s.json();if(!s.ok){a.showMap&&a.mapsUrl&&a.userLocation&&a.branchLocation?E({userLocation:a.userLocation,branchLocation:a.branchLocation,distance:a.distance,mapsUrl:a.mapsUrl}):t({title:"خطأ",description:a.error||"فشل التحضير",variant:"destructive",duration:1e4});return}t({title:"تم التحضير",description:a.message}),U(),b(null),w(null)}catch(s){t({title:"خطأ",description:s.message||"فشل التحضير",variant:"destructive",duration:1e4})}finally{c(!1)}},ee=async()=>{if(!u){t({title:"خطأ",description:"يرجى تحديد الموقع أولاً",variant:"destructive"});return}if(!x){t({title:"خطأ",description:"يرجى التقاط صورة أولاً",variant:"destructive"});return}c(!0);try{const s=await fetch("/api/attendance/check-out",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:u,photoUrl:x}),credentials:"include"}),a=await s.json();if(!s.ok){a.showMap&&a.mapsUrl&&a.userLocation&&a.branchLocation?E({userLocation:a.userLocation,branchLocation:a.branchLocation,distance:a.distance,mapsUrl:a.mapsUrl}):t({title:"خطأ",description:a.error||"فشل الانصراف",variant:"destructive",duration:1e4});return}t({title:"تم الانصراف",description:a.message}),U(),b(null),w(null)}catch(s){t({title:"خطأ",description:s.message||"فشل الانصراف",variant:"destructive",duration:1e4})}finally{c(!1)}},te=()=>{localStorage.removeItem("currentEmployee"),i("/employee/gateway")};if(!r)return null;const se=new Date().toLocaleDateString("ar-SA",{weekday:"long",year:"numeric",month:"long",day:"numeric"});return e.jsx("div",{className:"min-h-screen bg-background p-4",dir:"rtl",children:e.jsxs("div",{className:"max-w-lg mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center",children:e.jsx(ce,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-primary",children:"تسجيل الحضور"}),e.jsx("p",{className:"text-muted-foreground text-xs",children:se})]})]}),e.jsx(p,{variant:"ghost",size:"icon",onClick:te,className:"text-muted-foreground hover:text-destructive","data-testid":"button-logout",children:e.jsx(le,{className:"w-5 h-5"})})]}),e.jsx(C,{className:"bg-card border-border mb-4",children:e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-primary text-lg font-bold",children:r.fullName?.charAt(0)||"م"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold font-playfair text-foreground","data-testid":"text-employee-name",children:r.fullName}),e.jsx("p",{className:"text-muted-foreground text-sm",children:r.jobTitle||"موظف"})]})]})})}),y&&e.jsx("div",{className:"mb-4",children:e.jsx(Se,{userLocation:y.userLocation,branchLocation:y.branchLocation,distance:y.distance,mapsUrl:y.mapsUrl,onClose:()=>E(null)})}),n&&e.jsxs(C,{className:"bg-card border-border mb-4",children:[e.jsx(O,{className:"pb-2",children:e.jsxs(T,{className:"text-primary flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5"}),"حالة اليوم والاجازات"]})}),e.jsxs(k,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2",children:n.hasCheckedOut?e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(S,{className:"w-5 h-5"}),e.jsx("span",{children:"تم الانصراف"})]}):n.hasCheckedIn?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary",children:[e.jsx(oe,{className:"w-5 h-5"}),e.jsxs("span",{children:["وقت الحضور: ",new Date(n.attendance?.checkInTime||"").toLocaleTimeString("ar-SA")]})]}),n.attendance?.isLate===1&&e.jsxs(X,{variant:"destructive",className:"text-xs",children:["تأخير ",n.attendance.lateMinutes," دقيقة"]})]}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ge,{className:"w-5 h-5"}),e.jsx("span",{children:"لم يتم التحضير بعد"})]})}),e.jsx("div",{className:"h-px bg-border"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"bg-primary/5 rounded-lg p-3",children:[e.jsx("p",{className:"text-muted-foreground text-xs mb-1",children:"وقت الحضور"}),e.jsx("p",{className:"text-primary font-semibold","data-testid":"text-checkin-time",children:n.todayCheckIn?new Date(n.todayCheckIn).toLocaleTimeString("ar-SA"):"لم يسجل بعد"})]}),e.jsxs("div",{className:"bg-primary/5 rounded-lg p-3",children:[e.jsx("p",{className:"text-muted-foreground text-xs mb-1",children:"وقت الانصراف"}),e.jsx("p",{className:"text-primary font-semibold","data-testid":"text-checkout-time",children:n.todayCheckOut?new Date(n.todayCheckOut).toLocaleTimeString("ar-SA"):"لم يسجل بعد"})]})]}),e.jsx("div",{className:"h-px bg-border"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary",children:[e.jsx(je,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"رصيد الاجازات"})]}),e.jsxs(X,{className:"bg-primary/10 text-primary border-primary/20",children:[n.leaveBalance||0," يوم"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"إجمالي الاجازات السنوية"}),e.jsxs("span",{children:[n.totalLeaves||0," يوم"]})]})]}),e.jsxs(p,{onClick:()=>i("/employee/leave-request"),className:"w-full gap-2 bg-[#B58B5A] hover:bg-[#B58B5A]/90 text-white","data-testid":"button-apply-leave",children:[e.jsx(ye,{className:"w-4 h-4"}),"التقديم على اجازة"]})]})]}),e.jsxs(C,{className:"bg-card border-border mb-4",children:[e.jsx(O,{className:"pb-2",children:e.jsxs(T,{className:"text-primary flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5"}),"الموقع"]})}),e.jsx(k,{children:g?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ne,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:g})]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:A,className:"border-primary/50 text-primary","data-testid":"button-retry-location",children:[e.jsx(ve,{className:"w-4 h-4 ml-1"}),"إعادة"]})]}):u?e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(S,{className:"w-5 h-5"}),e.jsx("span",{children:"تم تحديد الموقع"})]}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(D,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"جاري تحديد الموقع..."})]})})]}),e.jsxs(C,{className:"bg-card border-border mb-6",children:[e.jsxs(O,{className:"pb-2",children:[e.jsxs(T,{className:"text-primary flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"صورة الحضور"]}),e.jsx(me,{className:"text-muted-foreground text-xs",children:"التقط صورة سيلفي للتأكيد"})]}),e.jsxs(k,{children:[K?e.jsxs("div",{className:"space-y-3",children:[e.jsx("video",{ref:N,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full rounded-lg"}),e.jsxs(p,{onClick:Q,className:"w-full bg-primary hover:bg-primary/90","data-testid":"button-capture",children:[e.jsx(M,{className:"w-4 h-4 ml-2"}),"التقاط"]})]}):J?e.jsxs("div",{className:"space-y-3",children:[e.jsx("img",{src:J,alt:"Captured",className:"w-full rounded-lg"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:Y,className:"flex-1 border-primary/50 text-primary","data-testid":"button-retake",children:"إعادة التقاط"}),x&&e.jsxs("div",{className:"flex items-center text-green-600 text-sm",children:[e.jsx(S,{className:"w-4 h-4 ml-1"}),"تم الرفع"]})]})]}):e.jsxs(p,{onClick:W,variant:"outline",className:"w-full border-primary/50 text-primary","data-testid":"button-start-camera",children:[e.jsx(M,{className:"w-4 h-4 ml-2"}),"فتح الكاميرا"]}),e.jsx("canvas",{ref:I,className:"hidden"})]})]}),!n?.hasCheckedOut&&e.jsx("div",{className:"space-y-3",children:n?.hasCheckedIn?e.jsxs(p,{onClick:ee,disabled:m||!u||!x,className:"w-full h-14 bg-accent hover:bg-accent text-lg","data-testid":"button-check-out",children:[m?e.jsx(D,{className:"w-5 h-5 animate-spin ml-2"}):e.jsx(ue,{className:"w-5 h-5 ml-2"}),"تسجيل الانصراف"]}):e.jsxs(p,{onClick:$,disabled:m||!u||!x,className:"w-full h-14 bg-green-600 hover:bg-green-700 text-lg","data-testid":"button-check-in",children:[m?e.jsx(D,{className:"w-5 h-5 animate-spin ml-2"}):e.jsx(S,{className:"w-5 h-5 ml-2"}),"تسجيل الحضور"]})}),e.jsx("div",{className:"mt-6",children:e.jsx(p,{variant:"ghost",onClick:()=>i("/employee/dashboard"),className:"w-full text-muted-foreground hover:text-primary","data-testid":"button-back-dashboard",children:"العودة للوحة التحكم"})})]})})}export{Je as default};
