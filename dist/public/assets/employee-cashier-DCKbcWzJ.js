import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as c}from"./vendor-react-Bzsngnqy.js";import{c as Ge,e as He,i as de,B as o,X as Xe,D as me,Y as xe,j as I,E as pe,F as ue,H as he,Z as Ke,A as Qe,C as H,x as ge,y as be,f as X,P as fe,_ as Ye,o as ye,O as Ne,$ as Ze,M as et,L as C,U as tt,I as T,p as st,a0 as at,G as K,k as Q,a1 as rt,N as nt}from"./index-CLvpp2UE.js";import{a as it,b as je}from"./vendor-query-CX8ZYlKb.js";import{S as ct,a as ot,b as lt,c as dt,d as A}from"./select-BzAjeBJu.js";import{S as Y}from"./separator-bOiezkJy.js";import{S as mt}from"./switch-C9eC4DLi.js";import{B as xt,p as pt,a as ut,b as ht}from"./print-utils-uDVQrsY-.js";import{M as ve}from"./monitor-smartphone-5TJGBhDy.js";import{S as we}from"./settings-CIxkmZWE.js";import{W as gt}from"./wifi-BwJ6pui9.js";import{W as bt}from"./wifi-off-D42PO9HC.js";import{P as Ce}from"./printer-CMPCONS0.js";import{F as ft}from"./file-text-QZcL_gux.js";import{S as Se}from"./store-DQDE2-Yy.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-CqdH-ack.js";import"./html5-qrcode-scanner-BAmOd9U4.js";import"./camera-xRDbuTtR.js";function yt(h){const S=`
مرحباً ${h.customerName}

تم استلام طلبك بنجاح!

رقم الطلب: ${h.orderNumber}

تفاصيل الطلب:
${h.items.map(g=>`• ${g.coffeeItem.nameAr} × ${g.quantity} - ${(Number(g.coffeeItem.price)*g.quantity).toFixed(2)} ريال`).join(`
`)}

الإجمالي: ${h.total} ريال
طريقة الدفع: ${h.paymentMethod}

حالة الطلب: تحت التنفيذ

سنبلغك عند اكتمال طلبك. شكراً لتعاملك معنا!

CLUNY CAFE
`.trim(),E=h.phone.replace(/[^0-9]/g,"");return`https://wa.me/${E.startsWith("966")?E:`966${E.replace(/^0/,"")}`}?text=${encodeURIComponent(S)}`}function Lt(){const[,h]=Ge(),[S,E]=c.useState(null),[l,g]=c.useState([]),[y,N]=c.useState(""),[u,U]=c.useState(""),[$,k]=c.useState(""),[Z,j]=c.useState(0),[W,v]=c.useState(null),[ke,P]=c.useState(!1),[M,ee]=c.useState(""),[b,te]=c.useState("cash"),[Pe,se]=c.useState(!1),[ae,Nt]=c.useState(!1),[m,w]=c.useState(null),[q,J]=c.useState(""),[d,z]=c.useState(null),[re,R]=c.useState(!1),[n,ne]=c.useState(null),[f,D]=c.useState(!1),[Ie,Te]=c.useState(!1),[Ee,ie]=c.useState(!1),[O,$e]=c.useState(0),[p,L]=c.useState("pickup"),[Oe,V]=c.useState(!1),{toast:i}=He();c.useEffect(()=>{(async()=>{const s=localStorage.getItem("currentEmployee");if(s){const a=JSON.parse(s);if(!a.branchId)try{const r=await fetch("/api/verify-session");if(r.ok){const x=await r.json();x.employee?.branchId&&(a.branchId=x.employee.branchId,localStorage.setItem("currentEmployee",JSON.stringify(a)))}}catch(r){console.error("Error fetching branch info:",r)}E(a)}else h("/employee/gateway")})()},[h]),c.useEffect(()=>{const t=async()=>{try{const a=await fetch("/api/pos/status",{method:"GET"});if(a.ok){const r=await a.json();D(r.connected===!0)}else D(!1)}catch{D(!1)}};t();const s=setInterval(t,3e4);return()=>clearInterval(s)},[]),c.useEffect(()=>{const s=setTimeout(async()=>{if(u.length===9&&u.startsWith("5")){se(!0);try{const a=await fetch("/api/customers/lookup-by-phone",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:u})});if(a.ok){const r=await a.json();if(r.found&&r.customer){N(r.customer.name),k(r.customer.email||""),j(r.customer.points||0),v(r.customer.id),w(r.loyaltyCard||null),P(!1);const x=r.loyaltyCard?(r.loyaltyCard.freeCupsEarned||0)-(r.loyaltyCard.freeCupsRedeemed||0):0;i({title:"عميل مسجل",description:`مرحباً ${r.customer.name}! لديك ${r.customer.points||0} نقطة${x>0?` و ${x} أختام متاحة`:""}`,className:"bg-green-600 text-white"})}else v(null),w(null),N(""),k(""),j(0),P(!0)}else v(null),w(null),N(""),k(""),j(0),P(!0)}catch(a){console.error("Error checking customer:",a),v(null),w(null),N(""),k(""),j(0)}finally{se(!1)}}else u.length===0&&(v(null),w(null),N(""),k(""),j(0),P(!1))},500);return()=>clearTimeout(s)},[u,i]);const{data:Fe=[],isLoading:Ae}=it({queryKey:["/api/coffee-items"]}),_=je({mutationFn:async t=>{const s=`تأكيد الدفع نقداً للعميل: ${t.customerInfo.customerName}
رقم الجوال: ${t.customerInfo.phoneNumber}
الإجمالي: ${t.totalAmount} ريال`;if(!window.confirm(s))throw new Error("تم إلغاء تأكيد الدفع");const a=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create order");return a.json()},onSuccess:async t=>{const s=b==="cash"?"نقدي":b==="alinma"?"Alinma Pay":b==="ur"?"Ur Pay":b==="barq"?"Barq":b==="rajhi"?"بنك الراجحي":b==="pos"?"جهاز نقاط البيع":"تحويل بنكي",a=p==="dine-in"?"في الكافيه":p==="pickup"?"استلام":"توصيل";ne({orderNumber:t.orderNumber,customerName:y,customerPhone:u,items:l,subtotal:F().toFixed(2),discount:d?{code:d.code,percentage:d.percentage,amount:B().toFixed(2)}:void 0,total:t.totalAmount,paymentMethod:s,employeeName:S?.fullName||"",tableNumber:M||void 0,deliveryType:p,deliveryTypeAr:a,date:new Date().toISOString()});const r={phone:u,orderNumber:t.orderNumber,customerName:y,items:l,total:t.totalAmount,paymentMethod:s},x=yt(r);window.open(x,"_blank"),i({title:"تم إنشاء الطلب بنجاح",description:`رقم الطلب: ${t.orderNumber}`,className:"bg-green-600 text-white"}),await nt.invalidateQueries({queryKey:["/api/orders"]}),ze()},onError:()=>{i({title:"خطأ",description:"فشل إنشاء الطلب. يرجى المحاولة مرة أخرى",variant:"destructive"})}}),Me=je({mutationFn:async t=>{const s=await fetch("/api/customers/register-by-cashier",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const a=await s.json();throw new Error(a.error||"فشل تسجيل العميل")}return s.json()},onSuccess:async t=>{v(t.id),j(t.points||0),P(!1),i({title:"تم تسجيل العميل بنجاح",description:`تم تسجيل ${t.name} في النظام. يمكن للعميل تفعيل الحساب لاحقاً عبر نظام استعادة كلمة المرور.`,className:"bg-green-600 text-white"});try{const s=await fetch(`/api/loyalty/cards/phone/${t.phone}`);if(s.ok){const a=await s.json();w(a)}}catch(s){console.error("Error fetching loyalty card after registration:",s)}},onError:t=>{i({title:"خطأ في التسجيل",description:t.message,variant:"destructive"})}}),qe=()=>{if(!y.trim()){i({title:"خطأ",description:"يرجى إدخال اسم العميل",variant:"destructive"});return}Me.mutate({phone:u,name:y.trim(),email:$.trim()||void 0})},ze=()=>{g([]),N(""),U(""),k(""),j(0),v(null),w(null),P(!1),ee(""),te("cash"),J(""),z(null),L("pickup")},Re=t=>{const s=l.find(a=>a.coffeeItem.id===t.id);g(s?l.map(a=>a.coffeeItem.id===t.id?{...a,quantity:a.quantity+1}:a):[...l,{coffeeItem:t,quantity:1}])},ce=(t,s)=>{s<=0?g(l.filter(a=>a.coffeeItem.id!==t)):g(l.map(a=>a.coffeeItem.id===t?{...a,quantity:s}:a))},De=t=>{g(l.filter(s=>s.coffeeItem.id!==t))},F=()=>l.reduce((t,s)=>{let a=Number(s.coffeeItem.price);if(s.customization?.selectedSize){const x=s.coffeeItem.availableSizes?.find(le=>le.nameAr===s.customization?.selectedSize||le.nameEn===s.customization?.selectedSize);x&&(a=Number(x.price))}const r=s.customization?.totalAddonsPrice||0;return t+(a+r)*s.quantity},0),B=()=>d?F()*d.percentage/100:0,G=()=>{const t=F(),s=B();return(t-s).toFixed(2)},Le=async()=>{if(!q.trim()){i({title:"خطأ",description:"يرجى إدخال كود الخصم",variant:"destructive"});return}R(!0);try{const t=await fetch("/api/discount-codes/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:q})});let s;try{s=await t.json()}catch{i({title:"خطأ",description:"فشل قراءةاستجابةالخادم",variant:"destructive"}),R(!1);return}if(!t.ok||!s.valid){i({title:"كود خصم غير صالح",description:s.error||"الكود المدخل غير صحيح أو منتهي الصلاحية",variant:"destructive"}),z(null),R(!1);return}z({code:s.code,percentage:s.discountPercentage,reason:s.reason}),i({title:"تم تطبيق الخصم بنجاح",description:`${s.reason} - ${s.discountPercentage}%`,className:"bg-green-600 text-white"})}catch(t){console.error("Error validating discount code:",t),i({title:"خطأ",description:"فشل التحقق من كود الخصم",variant:"destructive"})}finally{R(!1)}},Be=()=>{J(""),z(null),i({title:"تم إزالةالخصم",description:"تم إلغاء الخصم من الطلب"})},Ue=async()=>{if(!n){i({title:"خطأ",description:"لا يوجد طلب للطباعة",variant:"destructive"});return}try{await pt({orderNumber:n.orderNumber,customerName:n.customerName,customerPhone:n.customerPhone,items:n.items,subtotal:n.subtotal,discount:n.discount,total:n.total,paymentMethod:n.paymentMethod,employeeName:n.employeeName,tableNumber:n.tableNumber,date:n.date}),i({title:"تم فتح نافذة الطباعة",description:"يمكنك الآن طباعة الإيصال",className:"bg-green-600 text-white"})}catch(t){console.error("Error printing receipt:",t),i({title:"خطأ",description:"فشل في فتح نافذة الطباعة",variant:"destructive"})}},We=async()=>{if(!n){i({title:"خطأ",description:"لا يوجد طلب للطباعة",variant:"destructive"});return}try{await ut({orderNumber:n.orderNumber,customerName:n.customerName,customerPhone:n.customerPhone,items:n.items,subtotal:n.subtotal,discount:n.discount,total:n.total,paymentMethod:n.paymentMethod,employeeName:n.employeeName,tableNumber:n.tableNumber,date:n.date}),i({title:"تم فتح نافذة الطباعة",description:"يمكنك الآن طباعة الفاتورة الضريبية",className:"bg-green-600 text-white"})}catch(t){console.error("Error printing tax invoice:",t),i({title:"خطأ",description:"فشل في فتح نافذة الطباعة",variant:"destructive"})}},oe=async()=>{if(!n){i({title:"خطأ",description:"لا يوجد طلب للطباعة",variant:"destructive"});return}try{await ht({orderNumber:n.orderNumber,customerName:n.customerName,customerPhone:n.customerPhone,items:n.items,subtotal:n.subtotal,discount:n.discount,total:n.total,paymentMethod:n.paymentMethod,employeeName:n.employeeName,tableNumber:n.tableNumber,deliveryType:n.deliveryType,deliveryTypeAr:n.deliveryTypeAr,date:n.date}),i({title:"تم فتح نوافذ الطباعة",description:"طباعة 3 إيصالات: فاتورة ضريبية، إيصال استلام، نسخة الكاشير",className:"bg-green-600 text-white"})}catch(t){console.error("Error printing all receipts:",t),i({title:"خطأ",description:"فشل في فتح نوافذ الطباعة",variant:"destructive"})}},Je=async()=>{try{(await fetch("/api/pos/cash-drawer/open",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"})).ok?i({title:"تم فتح الخزانة",description:"تم فتح درج النقود بنجاح",className:"bg-green-600 text-white"}):i({title:"خطأ",description:"فشل فتح الخزانة",variant:"destructive"})}catch(t){console.error("Error opening cash drawer:",t),i({title:"خطأ",description:"فشل الاتصال بالخادم",variant:"destructive"})}},Ve=async()=>{ie(!0);try{const t=await fetch("/api/pos/toggle",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});if(t.ok){const s=await t.json();D(s.connected),i({title:s.connected?"تم الاتصال بجهاز POS":"تم قطع الاتصال",description:s.connected?"الجهاز جاهز للدفع الإلكتروني":"تم إيقاف الاتصال بجهاز POS",className:s.connected?"bg-green-600 text-white":void 0})}else i({title:"خطأ",description:"فشل تغيير حالة الاتصال بجهاز POS",variant:"destructive"})}catch(t){console.error("Error toggling POS:",t),i({title:"خطأ",description:"فشل الاتصال بالخادم",variant:"destructive"})}finally{ie(!1)}},_e=async()=>{if(l.length===0){i({title:"خطأ",description:"يرجى إضافة عناصر للطلب",variant:"destructive"});return}const t=G(),s={customerId:W||void 0,customerInfo:{customerName:y,phoneNumber:u,customerEmail:$||void 0},items:l.map(a=>({coffeeItemId:a.coffeeItem.id,quantity:a.quantity,size:a.customization?.selectedSize||"Default",extras:a.customization?.addons?.map(r=>r.nameAr)||[],totalPrice:((Number(a.coffeeItem.price)+(a.customization?.totalAddonsPrice||0))*a.quantity).toFixed(2)})),totalAmount:parseFloat(t),paymentMethod:b,orderType:p,tableNumber:p==="dine-in"?M:void 0,branchId:S?.branchId,discountCode:d?.code,discountPercentage:d?.percentage||0};try{const a=await _.mutateAsync(s);a&&(i({title:"تم الطلب",description:"جاري تحضير الفواتير..."}),ne({orderNumber:a.orderNumber,customerName:y,customerPhone:u,items:l,subtotal:F().toFixed(2),discount:d?{code:d.code,percentage:d.percentage,amount:B().toFixed(2)}:void 0,total:a.totalAmount,paymentMethod:b==="cash"?"نقدي":"إلكتروني",employeeName:S?.fullName||"",tableNumber:M||void 0,deliveryType:p,date:new Date().toISOString()}),setTimeout(()=>{oe()},500))}catch(a){console.error("Order submission error:",a)}};return S?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-primary/5 to-background p-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-amber-500 to-amber-700 rounded-full flex items-center justify-center",children:e.jsx(de,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-accent",children:"نظام الكاشير"}),e.jsxs("p",{className:"text-gray-400 text-sm",children:["الموظف: ",S.fullName]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(o,{variant:"outline",onClick:()=>h("/employee/cashier/phone-lookup"),className:"border-primary/50 text-accent hover:bg-background0 hover:text-white","data-testid":"button-phone-lookup",children:[e.jsx(Xe,{className:"w-4 h-4 ml-2"}),"بحث برقم الهاتف"]}),e.jsxs(me,{open:Ie,onOpenChange:Te,children:[e.jsx(xe,{asChild:!0,children:e.jsxs("div",{className:"bg-[#2d1f1a] border border-primary/20 rounded-lg px-4 py-2 hover-elevate cursor-pointer","data-testid":"pos-settings-trigger",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:`w-4 h-4 ${f?"text-green-400":"text-gray-400"}`}),e.jsx("span",{className:"text-xs text-gray-400",children:"جهاز POS:"}),e.jsx(I,{variant:"outline",className:f?"border-green-500/30 text-green-400":"border-yellow-500/30 text-yellow-400",children:f?"متصل":"غير متصل"}),e.jsx(we,{className:"w-3 h-3 text-gray-500"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:f?"جاهز للدفع الإلكتروني":"انقر للإعدادات"})]})}),e.jsxs(pe,{className:"bg-[#2d1f1a] border-primary/20 text-white",children:[e.jsx(ue,{children:e.jsxs(he,{className:"text-accent flex items-center gap-2",children:[e.jsx(ve,{className:"w-5 h-5"}),"إعدادات جهاز نقاط البيع (POS)"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-[#1a1410] rounded-lg border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[f?e.jsx(gt,{className:"w-6 h-6 text-green-400"}):e.jsx(bt,{className:"w-6 h-6 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-200 font-medium",children:"حالة الاتصال"}),e.jsx("p",{className:`text-sm ${f?"text-green-400":"text-gray-500"}`,children:f?"متصل وجاهز للاستخدام":"غير متصل"})]})]}),e.jsx(mt,{checked:f,onCheckedChange:Ve,disabled:Ee,"data-testid":"switch-pos-connection"})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-[#1a1410]/50 rounded-lg",children:[e.jsxs("h4",{className:"text-accent font-medium flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),"معلومات الجهاز"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"نوع الاتصال"}),e.jsx("p",{className:"text-gray-300",children:"USB / شبكة محلية"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"حالة الجهاز"}),e.jsx("p",{className:f?"text-green-400":"text-yellow-400",children:f?"نشط":"في وضع الاستعداد"})]})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 p-3 bg-background0/10 rounded-lg border border-primary/20",children:[e.jsx("p",{className:"font-medium text-accent mb-1",children:"ملاحظة:"}),e.jsx("p",{children:"عند تفعيل جهاز POS، سيتم معالجة الدفعات الإلكترونية تلقائياً عبر الجهاز. تأكد من توصيل الجهاز بشكل صحيح قبل التفعيل."})]})]})]})]}),n&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{onClick:Ue,className:"bg-blue-600 hover:bg-blue-700 shadow-lg","data-testid":"button-print-receipt",children:[e.jsx(Ce,{className:"w-4 h-4 ml-2"}),"طباعة الإيصال"]}),e.jsxs(o,{onClick:We,className:"bg-purple-600 hover:bg-purple-700 shadow-lg","data-testid":"button-print-tax-invoice",children:[e.jsx(ft,{className:"w-4 h-4 ml-2"}),"فاتورة ضريبية"]}),e.jsxs(o,{onClick:oe,className:"bg-green-600 hover:bg-green-700 shadow-lg","data-testid":"button-print-all-receipts",children:[e.jsx(Ce,{className:"w-4 h-4 ml-2"}),"طباعة 3 إيصالات"]})]}),e.jsx(o,{size:"icon",variant:"outline",onClick:Je,className:"border-primary/50 text-accent hover:bg-background0 hover:text-white","data-testid":"button-open-drawer",title:"فتح الخزانة",children:e.jsx(Ke,{className:"w-5 h-5"})}),e.jsxs(o,{variant:"outline",onClick:()=>h("/employee/dashboard"),className:"border-primary/50 text-accent hover:bg-background0 hover:text-white","data-testid":"button-back-dashboard",children:[e.jsx(Qe,{className:"w-4 h-4 ml-2"}),"العودة"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(H,{className:"bg-[#2d1f1a] border-primary/20",children:[e.jsx(ge,{children:e.jsx(be,{className:"text-accent text-right",children:"القائمة"})}),e.jsx(X,{children:Ae?e.jsx("div",{className:"text-center text-gray-400 py-8",children:"جاري التحميل..."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:Fe.map(t=>e.jsx(H,{className:"bg-[#1a1410] border-primary/10 hover:border-primary/30 transition-colors",children:e.jsxs(X,{className:"p-4",children:[e.jsx("div",{className:"flex justify-between items-start mb-2",children:e.jsxs("div",{className:"text-right flex-1",children:[e.jsx("h3",{className:"text-accent font-bold mb-1","data-testid":`text-item-name-${t.id}`,children:t.nameAr}),e.jsx("p",{className:"text-gray-400 text-sm line-clamp-2",children:t.description})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs(I,{variant:"outline",className:"border-primary/30 text-accent",children:[Number(t.price).toFixed(2)," ريال"]}),e.jsxs(o,{size:"sm",onClick:()=>Re(t),className:"bg-green-600 hover:bg-green-700 text-white","data-testid":`button-add-${t.id}`,children:[e.jsx(fe,{className:"w-4 h-4 ml-1"}),"إضافة"]})]})]})},t.id))})})]})}),e.jsx("div",{className:"lg:col-span-1 space-y-4",children:e.jsxs(H,{className:"bg-[#2d1f1a] border-primary/20 sticky top-4",children:[e.jsx(ge,{children:e.jsxs(be,{className:"text-accent text-right flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"w-5 h-5"}),"الطلب الحالي"]}),e.jsx(I,{"data-testid":"badge-order-type",className:p==="dine-in"?"bg-purple-600 text-white":p==="pickup"?"bg-blue-600 text-white":"bg-green-600 text-white",children:p==="dine-in"?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"w-3 h-3 ml-1"}),"محلي"]}):p==="pickup"?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-3 h-3 ml-1"}),"استلام"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"w-3 h-3 ml-1"}),"توصيل"]})})]})}),e.jsx(X,{className:"space-y-4",children:l.length===0?e.jsx("div",{className:"text-center text-gray-400 py-8",children:"لا توجد عناصر في الطلب"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto",children:l.map(t=>e.jsxs("div",{className:"bg-[#1a1410] rounded-lg p-3",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"text-right flex-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h4",{className:"text-accent font-medium text-sm","data-testid":`text-order-item-${t.coffeeItem.id}`,children:t.coffeeItem.nameAr})}),e.jsxs("p",{className:"text-gray-400 text-xs",children:[Number(t.coffeeItem.price).toFixed(2)," ريال"]})]}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>De(t.coffeeItem.id),className:"text-red-500 hover:text-red-400 hover:bg-red-500/10","data-testid":`button-remove-${t.coffeeItem.id}`,children:e.jsx(Ze,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{size:"sm",variant:"outline",onClick:()=>ce(t.coffeeItem.id,t.quantity-1),className:"h-7 w-7 p-0 border-primary/30","data-testid":`button-decrease-${t.coffeeItem.id}`,children:e.jsx(et,{className:"w-3 h-3"})}),e.jsx("span",{className:"text-white font-bold min-w-[30px] text-center","data-testid":`text-quantity-${t.coffeeItem.id}`,children:t.quantity}),e.jsx(o,{size:"sm",variant:"outline",onClick:()=>ce(t.coffeeItem.id,t.quantity+1),className:"h-7 w-7 p-0 border-primary/30","data-testid":`button-increase-${t.coffeeItem.id}`,children:e.jsx(fe,{className:"w-3 h-3"})})]}),e.jsxs("span",{className:"font-bold text-accent",children:[(Number(t.coffeeItem.price)*t.quantity).toFixed(2)," ريال"]})]})]},t.coffeeItem.id))}),e.jsx(Y,{className:"bg-background0/20"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{className:"text-gray-300 text-right block",children:[e.jsx(tt,{className:"w-4 h-4 inline ml-2"}),"اسم العميل"]}),e.jsx(T,{value:y,onChange:t=>N(t.target.value),placeholder:"أدخل اسم العميل",className:"bg-[#1a1410] border-primary/30 text-white text-right","data-testid":"input-customer-name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{className:"text-gray-300 text-right block",children:[e.jsx(st,{className:"w-4 h-4 inline ml-2"}),"رقم الجوال (9 أرقام تبدأ بـ 5)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{value:u,onChange:t=>U(t.target.value),placeholder:"5xxxxxxxx",className:"bg-[#1a1410] border-primary/30 text-white text-right flex-1","data-testid":"input-customer-phone"}),e.jsxs(me,{open:Oe,onOpenChange:V,children:[e.jsx(xe,{asChild:!0,children:e.jsx(o,{variant:"outline",size:"icon",className:"border-primary/30 text-accent","data-testid":"button-scan-loyalty",children:e.jsx(at,{className:"w-4 h-4"})})}),e.jsxs(pe,{className:"bg-[#1a1410] border-primary/30 text-white max-w-md",children:[e.jsx(ue,{children:e.jsx(he,{className:"text-right text-accent",children:"مسح بطاقة الولاء"})}),e.jsx(xt,{showManualInput:!0,onCustomerFound:t=>{t.found&&t.card&&(U(t.card.phoneNumber.replace(/^966|^0/,"")),N(t.card.customerName||t.customer?.name||""),w(t.card),t.customer?.id&&(v(t.customer.id),j(t.customer.points||0)),V(!1),i({title:"تم العثور على العميل",description:`${t.card.customerName||"عميل"} - ${t.card.phoneNumber}`}))},onClose:()=>V(!1)})]})]})]}),Pe&&e.jsx("p",{className:"text-xs text-accent text-right animate-pulse",children:"جاري التحقق من العميل..."})]}),ke&&u.length===9&&e.jsxs("div",{className:"bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 space-y-3",children:[e.jsx("p",{className:"text-blue-300 text-sm text-right",children:"عميل غير مسجل - يمكنك تسجيله الآن"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-gray-300 text-right block text-xs",children:"البريد الإلكتروني (اختياري)"}),e.jsx(T,{value:$,onChange:t=>k(t.target.value),placeholder:"customer@example.com",type:"email",className:"bg-[#1a1410] border-blue-500/30 text-white text-right","data-testid":"input-customer-email"})]}),e.jsx(o,{onClick:qe,disabled:ae||!y.trim(),className:"w-full bg-blue-600 hover:bg-blue-700 text-white","data-testid":"button-register-customer",children:ae?"جاري التسجيل...":"تسجيل العميل"}),e.jsx("p",{className:"text-xs text-gray-400 text-right",children:"سيتمكن العميل من تفعيل حسابه لاحقاً عبر نظام استعادة كلمة المرور"})]}),W&&Z>0&&e.jsx("div",{className:"bg-gradient-to-r from-purple-900/30 to-blue-900/30 p-3 rounded-lg border border-purple-500/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(I,{variant:"outline",className:"border-purple-400 text-purple-300",children:[Z," نقطة"]}),e.jsx("span",{className:"text-purple-300 text-sm",children:"نقاط العميل"})]})}),W&&$&&e.jsx("div",{className:"text-xs text-gray-400 text-right",children:$}),m&&e.jsxs("div",{className:"bg-gradient-to-br from-amber-900/30 to-orange-900/30 p-4 rounded-lg border-2 border-primary/30 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-accent"}),e.jsx("span",{className:"text-accent font-semibold",children:"بطاقة كوبي"})]}),e.jsxs(I,{className:"bg-background0 text-black",children:[(m.freeCupsEarned||0)-(m.freeCupsRedeemed||0)," أختام"]})]}),e.jsx("div",{className:"flex items-center gap-1 justify-end",children:Array.from({length:10}).map((t,s)=>{const a=s<(m.freeCupsEarned||0),r=s<(m.freeCupsRedeemed||0);return e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border-2 ${r?"bg-gray-600 border-gray-500 text-gray-400 line-through":a?"bg-background0 border-primary text-black":"bg-gray-800 border-gray-600 text-gray-500"}`,children:r?"X":a?"•":s+1},s)})}),e.jsxs("p",{className:"text-xs text-gray-400 text-right flex items-center gap-1 justify-end",children:[e.jsx(K,{className:"w-3 h-3 text-accent"}),"المشروبات المجانية متاحة: ",Math.floor(((m.freeCupsEarned||0)-(m.freeCupsRedeemed||0))/10)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-gray-300 text-right block text-sm font-medium",children:"نوع الطلب"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs(o,{type:"button",variant:"outline",onClick:()=>L("dine-in"),className:`flex flex-col items-center gap-1 py-3 ${p==="dine-in"?"bg-purple-600 border-purple-500 text-white":"bg-[#1a1410] border-primary/30 text-gray-300"}`,"data-testid":"button-order-type-dinein",children:[e.jsx(Se,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"في الكافيه"})]}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>L("pickup"),className:`flex flex-col items-center gap-1 py-3 ${p==="pickup"?"bg-blue-600 border-blue-500 text-white":"bg-[#1a1410] border-primary/30 text-gray-300"}`,"data-testid":"button-order-type-pickup",children:[e.jsx(ye,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"استلام"})]}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>L("delivery"),className:`flex flex-col items-center gap-1 py-3 ${p==="delivery"?"bg-green-600 border-green-500 text-white":"bg-[#1a1410] border-primary/30 text-gray-300"}`,"data-testid":"button-order-type-delivery",children:[e.jsx(Ne,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"توصيل"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{className:"text-gray-300 text-right block",children:[e.jsx(de,{className:"w-4 h-4 inline ml-2"}),"رقم الطاولة (اختياري)"]}),e.jsx(T,{value:M,onChange:t=>ee(t.target.value),placeholder:"مثال: 5 أو A3",className:"bg-[#1a1410] border-primary/30 text-white text-right","data-testid":"input-table-number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-gray-300 text-right block",children:"طريقة الدفع"}),e.jsxs(ct,{value:b,onValueChange:t=>te(t),children:[e.jsx(ot,{className:"bg-[#1a1410] border-primary/30 text-white","data-testid":"select-payment-method",children:e.jsx(lt,{})}),e.jsxs(dt,{className:"bg-[#1a1410] border-primary/30 text-white",children:[e.jsx(A,{value:"cash",children:"نقدي"}),e.jsx(A,{value:"pos-network",children:"شبكة (POS)"}),e.jsx(A,{value:"pos",children:"مدى"}),e.jsx(A,{value:"apple_pay",children:"Apple Pay"}),e.jsx(A,{value:"qahwa-card",children:"بطاقة قهوة"})]})]}),b==="qahwa-card"&&m&&e.jsxs("div",{className:"bg-primary/30 border border-primary/50 rounded-lg p-4 space-y-3 mt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-accent text-sm",children:"عدد الأختام المراد استخدامها"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(T,{type:"number",min:"0",max:(m.freeCupsEarned||0)-(m.freeCupsRedeemed||0),value:O,onChange:t=>$e(Math.min(parseInt(t.target.value)||0,(m.freeCupsEarned||0)-(m.freeCupsRedeemed||0))),className:"bg-[#1a1410] border-primary/30 text-white text-center w-20","data-testid":"input-stamps-to-use"}),e.jsxs("span",{className:"text-accent text-sm",children:["من ",(m.freeCupsEarned||0)-(m.freeCupsRedeemed||0)]})]})]}),e.jsxs("div",{className:"bg-[#1a1410] rounded p-2 space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-400",children:"تفاصيل الحسم:"}),e.jsxs("p",{className:"text-accent text-sm",children:["الأختام المستخدمة: ",O," ختم"]}),e.jsx("p",{className:"text-accent text-sm",children:(()=>{const t=l.flatMap(r=>Array(r.quantity).fill(r.coffeeItem.price)).sort((r,x)=>x-r);let s=0;const a=[];for(let r=0;r<Math.min(O,t.length);r++)s+=t[r],a.push(t[r]);return`قيمة الخصم: ${s.toFixed(2)} ريال (${O} ختم = ${a.length} عنصر مجاني)`})()}),e.jsx("p",{className:"text-accent text-sm",children:(()=>{const t=l.flatMap(r=>Array(r.quantity).fill(r.coffeeItem.price)).sort((r,x)=>x-r);let s=0;for(let r=0;r<Math.min(O,t.length);r++)s+=t[r];return`السعر النهائي: ${Math.max(0,parseFloat(G())-s).toFixed(2)} ريال`})()})]})]})]}),e.jsxs("div",{className:"space-y-2 bg-gradient-to-br from-green-900/20 to-emerald-900/20 p-4 rounded-lg border border-green-500/20",children:[e.jsxs(C,{className:"text-gray-300 text-right block flex items-center justify-end gap-2",children:[e.jsx("span",{className:"text-green-400",children:"كود الخصم (اختياري)"}),e.jsx(K,{className:"w-5 h-5 text-green-400"})]}),e.jsx("p",{className:"text-xs text-gray-400 text-right mb-2",children:"هل لديك كود خصم؟ أدخله هنا للحصول على تخفيض فوري"}),d?e.jsx("div",{className:"bg-green-500/20 border-2 border-green-500/50 rounded-lg p-4 animate-pulse-slow",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 justify-end mb-1",children:[e.jsx("p",{className:"text-green-400 font-bold text-lg","data-testid":"text-applied-discount-code",children:d.code}),e.jsx(Q,{className:"w-5 h-5 text-green-400"})]}),e.jsx("p",{className:"text-sm text-green-300",children:d.reason})]}),e.jsxs("div",{className:"flex items-center gap-2 mr-4",children:[e.jsxs(I,{className:"bg-green-600 text-white text-base px-3 py-1",children:["-",d.percentage,"%"]}),e.jsx(o,{size:"sm",variant:"ghost",onClick:Be,className:"text-red-400 hover:text-red-300 hover:bg-red-500/10","data-testid":"button-remove-discount",children:e.jsx(rt,{className:"w-4 h-4"})})]})]})}):e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{value:q,onChange:t=>J(t.target.value.toUpperCase()),placeholder:"مثال: WELCOME10",className:"bg-[#1a1410] border-green-500/30 text-white text-right flex-1 focus:border-green-500","data-testid":"input-discount-code"}),e.jsx(o,{onClick:Le,disabled:re||!q.trim(),className:"bg-green-600 hover:bg-green-700 min-w-[100px]","data-testid":"button-apply-discount",children:re?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}),"جاري التحقق"]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 ml-2"}),"تطبيق"]})})]})]})]}),e.jsx(Y,{className:"bg-background0/20"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"المجموع الفرعي:"}),e.jsxs("span",{className:"text-gray-300","data-testid":"text-subtotal",children:[F().toFixed(2)," ريال"]})]}),d&&e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{className:"text-green-400",children:["الخصم (",d.percentage,"%):"]}),e.jsxs("span",{className:"text-green-400","data-testid":"text-discount-amount",children:["-",B().toFixed(2)," ريال"]})]}),e.jsx(Y,{className:"bg-background0/10"}),e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold",children:[e.jsx("span",{className:"text-accent",children:"الإجمالي:"}),e.jsxs("span",{className:"text-accent","data-testid":"text-total",children:[G()," ريال"]})]})]}),e.jsxs(o,{onClick:_e,disabled:_.isPending,className:"w-full bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white font-bold py-6","data-testid":"button-submit-order",children:[e.jsx(Q,{className:"w-5 h-5 ml-2"}),_.isPending?"جاري الإنشاء...":"إنشاء الطلب وإرسال واتساب"]})]})})]})})]})]})}):null}export{Lt as default};
