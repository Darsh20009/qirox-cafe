import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as c}from"./vendor-react-Bzsngnqy.js";import{a as X,b as D}from"./vendor-query-CX8ZYlKb.js";import{l as Y,L as i,B as h,$ as L,o as A,e as ee,c as se,A as ae,P as O,D as T,E as B,F as I,H as R,J as U,I as o,K as z,q as b,C as te,x as ne,y as le,V as re,f as ie,p as oe,U as ce,v as E,N as F}from"./index-CLvpp2UE.js";import{M as de,T as me,L as S,a as he}from"./leaflet-Cu_ciSmi.js";import{N as ge}from"./navigation-C4sukurV.js";import{U as ue}from"./undo-2-D0MQKSW7.js";import{C as xe}from"./circle-check-big-DlXUvwLH.js";import{u as pe,a as je}from"./hooks-Be5loCHH.js";import{P as fe}from"./Polygon-5vJjI_lU.js";import{A as ve,a as Ne,b as ye,c as be,d as we,e as Ce,f as ke,g as De}from"./alert-dialog-B2SJEjUD.js";import{S as q}from"./store-DQDE2-Yy.js";import{P as K}from"./pen-DQVHph_P.js";import"./vendor-utils-BKCsaWdX.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=Y("Pentagon",[["path",{d:"M10.83 2.38a2 2 0 0 1 2.34 0l8 5.74a2 2 0 0 1 .73 2.25l-3.04 9.26a2 2 0 0 1-1.9 1.37H7.04a2 2 0 0 1-1.9-1.37L2.1 10.37a2 2 0 0 1 .73-2.25z",key:"2hea0t"}]]);delete S.Icon.Default.prototype._getIconUrl;S.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"});const Ee=new S.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function Fe({points:t,setPoints:d}){return pe({click(l){const m={lat:l.latlng.lat,lng:l.latlng.lng};d([...t,m])}}),e.jsxs(e.Fragment,{children:[t.map((l,m)=>e.jsx(he,{position:[l.lat,l.lng],icon:Ee},m)),t.length>=3&&e.jsx(fe,{positions:t.map(l=>[l.lat,l.lng]),pathOptions:{color:"#9FB2B3",fillColor:"#9FB2B3",fillOpacity:.3,weight:2}})]})}function Le({center:t}){const d=je();return c.useEffect(()=>{t.lat&&t.lng&&d.setView([t.lat,t.lng],d.getZoom())},[t,d]),null}function Q({initialPoints:t=[],centerLat:d,centerLng:l,onBoundaryChange:m}){const N={lat:24.7136,lng:46.6753},[r,j]=c.useState(t),[p,u]=c.useState({lat:d||N.lat,lng:l||N.lng});c.useEffect(()=>{t.length>0&&j(t)},[t]),c.useEffect(()=>{d&&l&&u({lat:d,lng:l})},[d,l]),c.useEffect(()=>{m(r)},[r,m]);const x=c.useCallback(g=>{j(g)},[]),a=()=>{r.length>0&&j(r.slice(0,-1))},n=()=>{j([])},f=()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(g=>{u({lat:g.coords.latitude,lng:g.coords.longitude})},g=>{console.error("Error getting location:",g),alert("لم نستطع الحصول على موقعك الحالي")})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsx(i,{className:"text-foreground",children:"ارسم حدود الفرع (اضغط لإضافة نقاط)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:f,children:[e.jsx(ge,{className:"w-4 h-4 ml-1"}),"موقعي"]}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:a,disabled:r.length===0,children:[e.jsx(ue,{className:"w-4 h-4 ml-1"}),"تراجع"]}),e.jsxs(h,{type:"button",variant:"destructive",size:"sm",onClick:n,disabled:r.length===0,children:[e.jsx(L,{className:"w-4 h-4 ml-1"}),"مسح"]})]})]}),e.jsx("div",{className:"h-80 rounded-lg overflow-hidden border border-border bg-muted",children:e.jsxs(de,{center:[p.lat,p.lng],zoom:16,style:{height:"100%",width:"100%"},children:[e.jsx(me,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:19,crossOrigin:!0}),e.jsx(Le,{center:p}),e.jsx(Fe,{points:r,setPoints:x})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-primary/10 rounded-lg border border-primary/20",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-primary flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-foreground font-medium",children:"تعليمات الرسم:"}),e.jsxs("ul",{className:"text-muted-foreground text-xs space-y-1 mt-1",children:[e.jsx("li",{children:"• اضغط على الخريطة لإضافة نقاط الحدود"}),e.jsx("li",{children:"• تحتاج 3 نقاط على الأقل لتكوين شكل"}),e.jsx("li",{children:"• النقاط تتصل تلقائياً لتشكيل الحدود"})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:r.length>=3?e.jsxs("span",{className:"flex items-center gap-1 text-green-600 text-sm",children:[e.jsx(xe,{className:"w-4 h-4"}),r.length," نقاط"]}):e.jsxs("span",{className:"text-muted-foreground text-sm",children:[r.length,"/3 نقاط"]})})]})]})}function $e(){const{toast:t}=ee(),[,d]=se(),[l,m]=c.useState(!1),[N,r]=c.useState(!1),[j,p]=c.useState(!1),[u,x]=c.useState(null),[a,n]=c.useState({nameAr:"",nameEn:"",address:"",phone:"",locationLat:"",locationLng:"",geofenceRadius:"200",lateThresholdMinutes:"15",workingHoursOpen:"08:00",workingHoursClose:"23:00"}),[f,g]=c.useState([]),M=c.useCallback(s=>{g(s)},[]),{data:w=[],isLoading:V}=X({queryKey:["/api/branches"]}),C=D({mutationFn:s=>E("POST","/api/branches",s),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/branches"]}),t({title:"تم إنشاء الفرع بنجاح",description:"تم إنشاء الفرع وتعيين المدير."}),m(!1),y()},onError:s=>{t({title:"خطأ في إنشاء الفرع",description:s?.message||"حدث خطأ عند إنشاء الفرع",variant:"destructive"})}}),k=D({mutationFn:s=>E("PUT",`/api/branches/${s.id}`,s.updates),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/branches"]}),t({title:"تم تحديث الفرع بنجاح"}),r(!1),x(null),y()},onError:s=>{t({title:"خطأ في تحديث الفرع",description:s?.message||"حدث خطأ عند تحديث الفرع",variant:"destructive"})}}),H=D({mutationFn:s=>E("DELETE",`/api/branches/${s}`),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/branches"]}),t({title:"تم حذف الفرع بنجاح"}),p(!1),x(null)},onError:s=>{t({title:"خطأ في حذف الفرع",description:s?.message||"حدث خطأ عند حذف الفرع",variant:"destructive"})}}),Z=s=>{x(s),n({nameAr:s.nameAr||"",nameEn:s.nameEn||"",address:s.address||"",phone:s.phone||"",locationLat:s.location?.lat?.toString()||"",locationLng:s.location?.lng?.toString()||"",geofenceRadius:s.geofenceRadius?.toString()||"200",lateThresholdMinutes:s.lateThresholdMinutes?.toString()||"15",workingHoursOpen:s.workingHours?.open||"08:00",workingHoursClose:s.workingHours?.close||"23:00"}),g(s.geofenceBoundary||[]),r(!0)},_=s=>{x(s),p(!0)},G=s=>{if(s.preventDefault(),!u)return;const v=u.id;v&&k.mutate({id:v,updates:P()})},J=()=>{if(!u)return;const s=u.id;s&&H.mutate(s)},y=()=>{n({nameAr:"",nameEn:"",address:"",phone:"",locationLat:"",locationLng:"",geofenceRadius:"200",lateThresholdMinutes:"15",workingHoursOpen:"08:00",workingHoursClose:"23:00"}),g([])},P=()=>({nameAr:a.nameAr,nameEn:a.nameEn,address:a.address,phone:a.phone,location:a.locationLat&&a.locationLng?{lat:parseFloat(a.locationLat),lng:parseFloat(a.locationLng)}:void 0,geofenceRadius:parseInt(a.geofenceRadius)||200,geofenceBoundary:f.length>=3?f:void 0,lateThresholdMinutes:parseInt(a.lateThresholdMinutes)||15,workingHours:{open:a.workingHoursOpen,close:a.workingHoursClose}}),W=s=>{if(s.preventDefault(),!a.nameAr.trim()){t({title:"خطأ",description:"يجب إدخال اسم الفرع بالعربية",variant:"destructive"});return}C.mutate(P()),m(!1),y()};return e.jsxs("div",{className:"p-6 space-y-6 bg-white dark:bg-background min-h-screen",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>d("/admin/dashboard"),children:e.jsx(ae,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"إدارة الفروع"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"إضافة وتعديل فروع المقهى"})]})]}),e.jsxs(h,{onClick:()=>m(!0),className:"bg-accent hover:bg-accent",children:[e.jsx(O,{className:"w-4 h-4 ml-2"}),"إضافة فرع جديد"]})]}),e.jsx(T,{open:l,onOpenChange:m,children:e.jsxs(B,{className:"max-w-2xl",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx(R,{children:"إضافة فرع جديد"}),e.jsx(U,{children:"سيتم إنشاء حساب مدير للفرع تلقائياً عند الحفظ"})]}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"nameAr",children:"اسم الفرع (بالعربية) *"}),e.jsx(o,{id:"nameAr",required:!0,value:a.nameAr,onChange:s=>n({...a,nameAr:s.target.value}),placeholder:"فرع المربع"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"nameEn",children:"اسم الفرع (بالإنجليزي)"}),e.jsx(o,{id:"nameEn",value:a.nameEn,onChange:s=>n({...a,nameEn:s.target.value}),placeholder:"Al-Murabba Branch"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"address",children:"العنوان"}),e.jsx(o,{id:"address",value:a.address,onChange:s=>n({...a,address:s.target.value}),placeholder:"الرياض، طريق الملك فهد"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"phone",children:"رقم الهاتف"}),e.jsx(o,{id:"phone",value:a.phone,onChange:s=>n({...a,phone:s.target.value}),placeholder:"0501234567"})]})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),"إعدادات الموقع والحدود الجغرافية"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"locationLat",children:"خط العرض (Latitude)"}),e.jsx(o,{id:"locationLat",type:"number",step:"any",value:a.locationLat,onChange:s=>n({...a,locationLat:s.target.value}),placeholder:"24.7136"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"locationLng",children:"خط الطول (Longitude)"}),e.jsx(o,{id:"locationLng",type:"number",step:"any",value:a.locationLng,onChange:s=>n({...a,locationLng:s.target.value}),placeholder:"46.6753"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"geofenceRadius",children:"نطاق حدود الفرع الدائري (بالمتر) - اختياري"}),e.jsx(o,{id:"geofenceRadius",type:"number",value:a.geofenceRadius,onChange:s=>n({...a,geofenceRadius:s.target.value}),placeholder:"200"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يُستخدم فقط إذا لم ترسم حدود متعددة النقاط"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"lateThresholdMinutes",children:"عتبة التأخير (بالدقائق)"}),e.jsx(o,{id:"lateThresholdMinutes",type:"number",value:a.lateThresholdMinutes,onChange:s=>n({...a,lateThresholdMinutes:s.target.value}),placeholder:"15"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"بعد كم دقيقة يُعتبر الموظف متأخراً"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"workingHoursOpen",children:"وقت الافتتاح"}),e.jsx(o,{id:"workingHoursOpen",type:"time",value:a.workingHoursOpen,onChange:s=>n({...a,workingHoursOpen:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"workingHoursClose",children:"وقت الإغلاق"}),e.jsx(o,{id:"workingHoursClose",type:"time",value:a.workingHoursClose,onChange:s=>n({...a,workingHoursClose:s.target.value})})]})]})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4"}),"رسم حدود الفرع (اختياري - أدق من الدائرة)"]}),e.jsx(Q,{initialPoints:f,centerLat:a.locationLat?parseFloat(a.locationLat):void 0,centerLng:a.locationLng?parseFloat(a.locationLng):void 0,onBoundaryChange:M})]}),e.jsxs(z,{children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>m(!1),children:"إلغاء"}),e.jsx(h,{type:"submit",className:"bg-accent hover:bg-accent",disabled:C.isPending,children:C.isPending?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-4 h-4 animate-spin ml-2"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 ml-2"}),"حفظ الفرع"]})})]})]})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:V?e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx(b,{className:"w-8 h-8 animate-spin mx-auto text-accent"}),e.jsx("p",{className:"mt-2 text-muted-foreground",children:"جاري تحميل الفروع..."})]}):w&&w.length>0?w.map(s=>{const v=s.id;return e.jsxs(te,{className:"hover:shadow-md transition-shadow border-orange-100 dark:border-orange-900/30",children:[e.jsxs(ne,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(le,{className:"text-xl font-bold",children:s.nameAr}),e.jsx(q,{className:"w-5 h-5 text-accent"})]}),s.nameEn&&e.jsx(re,{children:s.nameEn})]}),e.jsxs(ie,{className:"space-y-3",children:[s.address&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(A,{className:"w-4 h-4"}),s.address]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(oe,{className:"w-4 h-4"}),s.phone]}),s.managerName&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ce,{className:"w-4 h-4"}),"المدير: ",s.managerName]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>Z(s),className:"flex-1","data-testid":`button-edit-branch-${v}`,children:[e.jsx(K,{className:"w-4 h-4 ml-1"}),"تعديل"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>_(s),className:"flex-1 text-destructive hover:text-destructive","data-testid":`button-delete-branch-${v}`,children:[e.jsx(L,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})]},v)}):e.jsxs("div",{className:"col-span-full text-center py-12 bg-gray-50 dark:bg-card rounded-xl border-2 border-dashed border-gray-200 dark:border-slate-800",children:[e.jsx(q,{className:"w-12 h-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold",children:"لا توجد فروع مضافة"}),e.jsx("p",{className:"text-muted-foreground",children:"ابدأ بإضافة أول فرع للمقهى الخاص بك"})]})}),e.jsx(T,{open:N,onOpenChange:s=>{r(s),s||(x(null),y())},children:e.jsxs(B,{className:"max-w-2xl",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx(R,{children:"تعديل الفرع"}),e.jsx(U,{children:"تعديل بيانات الفرع"})]}),e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-nameAr",children:"اسم الفرع (بالعربية) *"}),e.jsx(o,{id:"edit-nameAr",required:!0,value:a.nameAr,onChange:s=>n({...a,nameAr:s.target.value}),placeholder:"فرع المربع"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-nameEn",children:"اسم الفرع (بالإنجليزي)"}),e.jsx(o,{id:"edit-nameEn",value:a.nameEn,onChange:s=>n({...a,nameEn:s.target.value}),placeholder:"Al-Murabba Branch"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-address",children:"العنوان"}),e.jsx(o,{id:"edit-address",value:a.address,onChange:s=>n({...a,address:s.target.value}),placeholder:"الرياض، طريق الملك فهد"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-phone",children:"رقم الهاتف"}),e.jsx(o,{id:"edit-phone",value:a.phone,onChange:s=>n({...a,phone:s.target.value}),placeholder:"0501234567"})]})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4"}),"تعديل حدود الفرع"]}),e.jsx(Q,{initialPoints:f,centerLat:a.locationLat?parseFloat(a.locationLat):void 0,centerLng:a.locationLng?parseFloat(a.locationLng):void 0,onBoundaryChange:M})]}),e.jsxs(z,{children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>r(!1),children:"إلغاء"}),e.jsx(h,{type:"submit",className:"bg-accent hover:bg-accent",disabled:k.isPending,children:k.isPending?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-4 h-4 animate-spin ml-2"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4 ml-2"}),"حفظ التعديلات"]})})]})]})]})}),e.jsx(ve,{open:j,onOpenChange:p,children:e.jsxs(Ne,{dir:"rtl",children:[e.jsxs(ye,{children:[e.jsx(be,{children:"تأكيد حذف الفرع"}),e.jsxs(we,{children:['هل أنت متأكد من حذف الفرع "',u?.nameAr,'"؟ هذا الإجراء لا يمكن التراجع عنه.']})]}),e.jsxs(Ce,{children:[e.jsx(ke,{onClick:()=>x(null),children:"إلغاء"}),e.jsx(De,{onClick:J,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:H.isPending?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-4 h-4 animate-spin ml-2"}),"جاري الحذف..."]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4 ml-2"}),"تأكيد الحذف"]})})]})]})})]})}export{$e as default};
