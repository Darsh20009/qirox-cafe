var Sa=Object.defineProperty;var Ot=(i,a)=>()=>(i&&(a=i(i=0)),a);var Et=(i,a)=>{for(var s in a)Sa(i,s,{get:a[s],enumerable:!0})};var R={};Et(R,{AccountModel:()=>te,AccountTypes:()=>Zo,AccountingSnapshotModel:()=>Pr,AttendanceModel:()=>eo,BankStatementModel:()=>Ko,BankTransactionModel:()=>Xo,BranchModel:()=>Be,BranchStockModel:()=>be,BusinessConfigModel:()=>_e,CafeModel:()=>ze,CardCodeModel:()=>Bt,CartItemModel:()=>ve,CashRegisterModel:()=>Ja,CategoryModel:()=>kt,CoffeeItemAddonModel:()=>Yt,CoffeeItemIngredientModel:()=>qt,CoffeeItemModel:()=>ae,CostCenterModel:()=>Wo,CustomBannerModel:()=>Mt,CustomerModel:()=>ee,DailySummaryModel:()=>Ka,DeliveryDriverModel:()=>Ue,DeliveryIntegrationModel:()=>Je,DeliveryOrderModel:()=>Ge,DeliveryZoneModel:()=>Ke,DiscountCodeModel:()=>St,EmployeeModel:()=>he,EmployeeShiftAssignmentModel:()=>so,ExpenseErpModel:()=>It,ExpenseModel:()=>Ya,FiscalPeriodModel:()=>mn,IngredientItemModel:()=>Xt,IngredientModel:()=>nr,InvoiceModel:()=>ut,JournalEntryModel:()=>bt,KitchenOrderModel:()=>Xa,LoyaltyCardModel:()=>qe,LoyaltyRewardModel:()=>rr,LoyaltyTransactionModel:()=>tr,ManagerNotificationModel:()=>ao,MenuCategoryModel:()=>xa,NotificationModel:()=>ft,OrderItemModel:()=>br,OrderModel:()=>Z,PasswordResetTokenModel:()=>Jt,PasswordSetupOTPModel:()=>Kt,PaymentRecordModel:()=>Jo,PointTransferModel:()=>Ta,ProductAddonModel:()=>Le,ProductReviewModel:()=>Ar,PromoOfferModel:()=>Pa,PurchaseInvoiceModel:()=>gt,RawItemModel:()=>oe,RecipeDefinitionModel:()=>er,RecipeHistoryModel:()=>Ba,RecipeItemModel:()=>Ne,RecipeModel:()=>or,ReferralModel:()=>Dr,RevenueModel:()=>Wa,ShiftModel:()=>oo,StatusHistoryModel:()=>Ua,StockAlertModel:()=>Ve,StockMovementModel:()=>Re,StockTransferModel:()=>Dt,SupplierModel:()=>yt,TableModel:()=>fe,TaxInvoiceModel:()=>dt,TaxRateModel:()=>Yo,UnitConversionModel:()=>No,UserModel:()=>ar,VendorModel:()=>jr,WarehouseModel:()=>fr,WarehouseStockModel:()=>tn,WarehouseTransferModel:()=>Jr,insertAccountSchema:()=>es,insertAccountingSnapshotSchema:()=>Ho,insertAttendanceSchema:()=>Do,insertBranchSchema:()=>vo,insertBranchStockSchema:()=>Oo,insertCardCodeSchema:()=>go,insertCartItemSchema:()=>uo,insertCashRegisterSchema:()=>_o,insertCategorySchema:()=>Ao,insertCoffeeItemAddonSchema:()=>zo,insertCoffeeItemIngredientSchema:()=>Io,insertCoffeeItemSchema:()=>to,insertCustomerSchema:()=>lo,insertDeliveryDriverSchema:()=>cs,insertDeliveryIntegrationSchema:()=>ss,insertDeliveryOrderSchema:()=>ds,insertDeliveryZoneSchema:()=>is,insertDiscountCodeSchema:()=>po,insertEmployeeSchema:()=>ro,insertExpenseErpSchema:()=>ns,insertExpenseSchema:()=>$o,insertIngredientSchema:()=>ho,insertInvoiceSchema:()=>rs,insertJournalEntrySchema:()=>ts,insertKitchenOrderSchema:()=>Lo,insertLoyaltyCardSchema:()=>yo,insertLoyaltyRewardSchema:()=>bo,insertLoyaltyTransactionSchema:()=>fo,insertNotificationSchema:()=>Qo,insertOrderItemSchema:()=>co,insertOrderSchema:()=>io,insertPasswordResetTokenSchema:()=>mo,insertPaymentRecordSchema:()=>os,insertProductAddonSchema:()=>Uo,insertProductReviewSchema:()=>Vo,insertPurchaseInvoiceSchema:()=>Mo,insertRawItemSchema:()=>To,insertRecipeItemSchema:()=>Bo,insertReferralSchema:()=>Go,insertRevenueSchema:()=>Fo,insertStockMovementSchema:()=>qo,insertStockTransferSchema:()=>Eo,insertSupplierSchema:()=>Ro,insertTableSchema:()=>So,insertTaxInvoiceSchema:()=>ko,insertUserSchema:()=>wo,insertVendorSchema:()=>as});import $,{Schema as q}from"mongoose";import{z as c}from"zod";var nt,ae,Da,Le,Ca,Jr,Rn,Yt,Kr,Pa,Xr,xa,On,Mt,ja,ee,Na,Ta,Ra,Jt,en,Kt,Oa,ze,Ea,Ma,_e,En,Xt,Mn,Bn,er,Ba,qa,fr,qn,tn,ka,Be,$a,St,Fa,Z,_a,br,kn,ve,$n,qe,La,Ua,za,Bt,Va,tr,Ga,rr,Qa,nr,Fn,qt,Ha,kt,Za,ar,_n,fe,hr,dt,rn,Wa,Ir,Ya,nn,Ja,Ln,Ka,wr,Xa,an,eo,to,ro,no,he,vr,ao,Un,oo,on,so,io,co,uo,lo,mo,po,yo,go,fo,bo,ho,Io,wo,vo,Ao,So,Do,Co,oe,Po,yt,zn,be,xo,Dt,jo,gt,Vn,Ne,sn,or,Gn,Ve,cn,Re,Qn,No,To,Ro,Oo,Eo,Mo,Bo,qo,ko,$o,Fo,_o,Lo,Uo,zo,dn,Ar,Sr,Dr,un,ft,Vo,Go,Qo,Cr,Pr,Ho,Zo,ln,mn,pn,Wo,$t,te,Ft,bt,yn,Yo,ht,ut,_t,It,xr,jr,Lt,Jo,gn,Ko,Nr,Xo,es,ts,rs,ns,as,os,Tr,Je,Rr,Ke,sr,Ue,Ut,Ge,ss,is,cs,ds,T=Ot(()=>{"use strict";nt=new q({id:{type:String,required:!0},tenantId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},description:{type:String,required:!0},price:{type:Number,required:!0},oldPrice:{type:Number},category:{type:String,required:!0},menuType:{type:String,enum:["drinks","food"],default:"drinks"},imageUrl:{type:String},isAvailable:{type:Number,default:1,required:!0},availabilityStatus:{type:String,default:"available"},coffeeStrength:{type:String,default:"classic"},strengthLevel:{type:Number},isNewProduct:{type:Number,default:0},sku:{type:String,sparse:!0},sizeML:{type:Number},isGiftable:{type:Boolean,default:!1},groupId:{type:String,index:!0},availableSizes:[{nameAr:{type:String,required:!0},nameEn:{type:String},price:{type:Number,required:!0},sizeML:{type:Number},sku:{type:String},imageUrl:{type:String}}],recipeId:{type:String},costOfGoods:{type:Number,default:0},profitMargin:{type:Number,default:0},branchAvailability:[{branchId:{type:String},isAvailable:{type:Number,default:1}}],hasRecipe:{type:Number,default:0},requiresRecipe:{type:Number,default:1},createdByEmployeeId:{type:String},createdByBranchId:{type:String},publishedBranches:[{type:String}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});nt.index({tenantId:1});nt.index({tenantId:1,category:1});nt.index({tenantId:1,publishedBranches:1});nt.index({tenantId:1,isAvailable:1});nt.index({category:1});nt.index({publishedBranches:1});nt.index({isAvailable:1});nt.index({createdByBranchId:1});nt.index({id:1},{unique:!0});ae=$.model("CoffeeItem",nt),Da=new q({id:{type:String,required:!0,unique:!0},nameAr:{type:String,required:!0},nameEn:{type:String},category:{type:String,enum:["sugar","milk","shot","syrup","topping","size","other","flavor","Flavor","Shot"],required:!0},price:{type:Number,required:!0,default:0},isAvailable:{type:Number,default:1},isFree:{type:Number,default:0},rawItemId:{type:String},quantityPerUnit:{type:Number},unit:{type:String},orderIndex:{type:Number,default:0},sku:{type:String},imageUrl:{type:String},isAddonDrink:{type:Boolean,default:!1},isIndependentProduct:{type:Boolean,default:!1},linkedCoffeeItemId:{type:String},inventoryRawItemId:{type:String},linkedRawItemId:{type:String},createdAt:{type:Date,default:Date.now}},{timestamps:!1}),Le=$.model("ProductAddon",Da),Ca=new q({tenantId:{type:String,required:!0},fromWarehouseId:{type:String,required:!0},toWarehouseId:{type:String,required:!0},items:[{ingredientId:{type:String,required:!0},quantity:{type:Number,required:!0},unit:{type:String,required:!0}}],status:{type:String,enum:["pending","shipped","received","cancelled"],default:"pending"},notes:{type:String},createdBy:{type:String,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),Jr=$.model("WarehouseTransfer",Ca),Rn=new q({coffeeItemId:{type:String,required:!0},addonId:{type:String,required:!0},isDefault:{type:Number,default:0},defaultValue:{type:String},minQuantity:{type:Number,default:0},maxQuantity:{type:Number,default:10},createdAt:{type:Date,default:Date.now}});Rn.index({coffeeItemId:1,addonId:1},{unique:!0});Yt=$.model("CoffeeItemAddon",Rn),Kr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},description:{type:String},imageUrl:{type:String},offerType:{type:String,enum:["bundle","discount","bogo"],default:"bundle"},originalPrice:{type:Number,required:!0},offerPrice:{type:Number,required:!0},items:[{coffeeItemId:{type:String,required:!0},quantity:{type:Number,default:1},sizeOption:{type:String}}],isActive:{type:Number,default:1},startDate:{type:Date},endDate:{type:Date},sortOrder:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Kr.index({tenantId:1,isActive:1});Kr.index({id:1},{unique:!0});Pa=$.model("PromoOffer",Kr),Xr=new q({id:{type:String,required:!0},tenantId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},icon:{type:String,default:"Coffee"},department:{type:String,enum:["drinks","food"],default:"drinks"},orderIndex:{type:Number,default:0},isSystem:{type:Boolean,default:!1},isActive:{type:Number,default:1},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Xr.index({tenantId:1,isActive:1});Xr.index({id:1},{unique:!0});xa=$.model("MenuCategory",Xr),On=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},titleAr:{type:String,required:!0},titleEn:{type:String},subtitleAr:{type:String},subtitleEn:{type:String},imageUrl:{type:String,required:!0},linkType:{type:String,enum:["product","category","offer","external","none"],default:"none"},linkId:{type:String},externalUrl:{type:String},badgeAr:{type:String},badgeEn:{type:String},isActive:{type:Boolean,default:!0},orderIndex:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});On.index({tenantId:1,isActive:1,orderIndex:1});Mt=$.model("CustomBanner",On),ja=new q({phone:{type:String,required:!0,unique:!0},email:{type:String,unique:!0,sparse:!0},name:{type:String,required:!0},password:{type:String},registeredBy:{type:String,default:"self"},isPasswordSet:{type:Number,default:0},points:{type:Number,default:0},pendingPoints:{type:Number,default:0},walletBalance:{type:Number,default:0},walletPin:{type:String},carType:{type:String},carColor:{type:String},plateNumber:{type:String},saveCarInfo:{type:Number,default:0},createdAt:{type:Date,default:Date.now}}),ee=$.model("Customer",ja),Na=new q({tenantId:{type:String,required:!0},fromCustomerId:{type:String,required:!0},toCustomerId:{type:String,required:!0},points:{type:Number,required:!0},status:{type:String,enum:["completed","failed"],default:"completed"},createdAt:{type:Date,default:Date.now}}),Ta=$.model("PointTransfer",Na),Ra=new q({email:{type:String,required:!0},token:{type:String,required:!0,unique:!0},expiresAt:{type:Date,required:!0},used:{type:Number,default:0,required:!0},createdAt:{type:Date,default:Date.now}}),Jt=$.model("PasswordResetToken",Ra),en=new q({phone:{type:String,required:!0},otp:{type:String,required:!0},expiresAt:{type:Date,required:!0},used:{type:Number,default:0,required:!0},attempts:{type:Number,default:0,required:!0},createdAt:{type:Date,default:Date.now}});en.index({expiresAt:1},{expireAfterSeconds:0});en.index({phone:1});Kt=$.model("PasswordSetupOTP",en),Oa=new q({id:{type:String,required:!0,unique:!0},nameAr:{type:String,required:!0},nameEn:{type:String,required:!0},type:{type:String,enum:["demo","client"],default:"demo"},status:{type:String,enum:["active","inactive","suspended"],default:"active"},businessName:{type:String,required:!0},businessPhone:{type:String,required:!0},businessEmail:{type:String,required:!0},taxNumber:{type:String},vatPercentage:{type:Number,default:15},currency:{type:String,default:"SAR"},timezone:{type:String,default:"Asia/Riyadh"},subscriptionPlan:{type:String,enum:["free","starter","professional","enterprise"],default:"free"},features:{inventoryTracking:{type:Boolean,default:!1},loyaltyProgram:{type:Boolean,default:!1},zatcaCompliance:{type:Boolean,default:!1},advancedAnalytics:{type:Boolean,default:!1},customTheme:{type:Boolean,default:!1}},customBranding:{logoUrl:{type:String},primaryColor:{type:String},secondaryColor:{type:String}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),ze=$.model("Cafe",Oa),Ea=new q({provider:{type:String,enum:["none","neoleap","geidea"],default:"none"},enabledMethods:[{type:String}],neoleap:{clientId:{type:String},clientSecret:{type:String},merchantId:{type:String},baseUrl:{type:String,default:"https://api.neoleap.com.sa"},callbackUrl:{type:String}},geidea:{publicKey:{type:String},apiPassword:{type:String},baseUrl:{type:String,default:"https://api.merchant.geidea.net"},callbackUrl:{type:String}},cashEnabled:{type:Boolean,default:!0},posEnabled:{type:Boolean,default:!0},qahwaCardEnabled:{type:Boolean,default:!0},bankTransferEnabled:{type:Boolean,default:!1},stcPayEnabled:{type:Boolean,default:!1}},{_id:!1}),Ma=new q({tenantId:{type:String,required:!0,unique:!0},tradeNameAr:{type:String,required:!0},tradeNameEn:{type:String},activityType:{type:String,enum:["cafe","restaurant","both"],default:"cafe"},isFoodEnabled:{type:Boolean,default:!1},isDrinksEnabled:{type:Boolean,default:!0},vatNumber:{type:String},vatPercentage:{type:Number,default:15},currency:{type:String,default:"SAR"},timezone:{type:String,default:"Asia/Riyadh"},isMaintenanceMode:{type:Boolean,default:!1},maintenanceReason:{type:String,default:"maintenance"},paymentGateway:{type:Ea,default:()=>({provider:"none",enabledMethods:["cash"],cashEnabled:!0,posEnabled:!0,qahwaCardEnabled:!0,bankTransferEnabled:!1,stcPayEnabled:!1})},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),_e=$.model("BusinessConfig",Ma),En=new q({tenantId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},sku:{type:String},category:{type:String,enum:["beans","milk","syrups","packaging","other"],default:"other"},unit:{type:String,default:"g"},unitCost:{type:Number,required:!0,default:0},currentStock:{type:Number,default:0},minStockThreshold:{type:Number,default:0},maxStockLevel:{type:Number},reorderPoint:{type:Number},supplierId:{type:String},lastPriceCheck:{type:Date},priceHistory:[{date:{type:Date,default:Date.now},cost:{type:Number}}],isActive:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});En.index({tenantId:1,sku:1});Xt=$.model("IngredientItem",En),Mn=new q({tenantId:{type:String,required:!0},productId:{type:String,required:!0},ingredients:[{ingredientId:{type:String,required:!0},quantity:{type:Number,required:!0},unit:{type:String,required:!0},unitCost:{type:Number,default:0},totalCost:{type:Number,default:0}}],totalCost:{type:Number,default:0},version:{type:Number,default:1},isActive:{type:Boolean,default:!0},description:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),Bn=new q({tenantId:{type:String,required:!0},productId:{type:String,required:!0},recipeId:{type:String,required:!0},version:{type:Number,required:!0},ingredients:[{ingredientId:{type:String,required:!0},quantity:{type:Number,required:!0},unit:{type:String,required:!0}}],totalCost:{type:Number,default:0},reason:{type:String},createdAt:{type:Date,default:Date.now}});Mn.index({tenantId:1,productId:1,isActive:1});Bn.index({tenantId:1,productId:1,version:1});er=$.model("RecipeDefinition",Mn),Ba=$.model("RecipeHistory",Bn),qa=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},location:{lat:{type:Number},lng:{type:Number}},managerId:{type:String},isActive:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),fr=$.model("Warehouse",qa),qn=new q({tenantId:{type:String,required:!0},warehouseId:{type:String,required:!0},ingredientId:{type:String,required:!0},quantity:{type:Number,default:0},minStockLevel:{type:Number,default:0},maxStockLevel:{type:Number},updatedAt:{type:Date,default:Date.now}});qn.index({tenantId:1,warehouseId:1,ingredientId:1},{unique:!0});tn=$.model("WarehouseStock",qn),ka=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},cafeId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},address:{type:String,required:!0},phone:{type:String,required:!0},workingHours:{open:{type:String,default:"08:00"},close:{type:String,default:"23:00"}},location:{lat:{type:Number},lng:{type:Number}},geofenceRadius:{type:Number,default:200},geofenceBoundary:[{lat:{type:Number},lng:{type:Number}}],isActive:{type:q.Types.Mixed,default:!0},managerName:{type:String},managerId:{type:String},isMaintenanceMode:{type:Boolean,default:!1},lateThresholdMinutes:{type:Number,default:15},createdAt:{type:Date,default:Date.now}},{timestamps:!1}),Be=$.model("Branch",ka),$a=new q({code:{type:String,required:!0,unique:!0},discountPercentage:{type:Number,required:!0},reason:{type:String,required:!0},employeeId:{type:String,required:!0},isActive:{type:Number,default:1,required:!0},usageCount:{type:Number,default:0,required:!0},createdAt:{type:Date,default:Date.now}}),St=$.model("DiscountCode",$a),Fa=new q({tenantId:{type:String,required:!0},branchId:{type:String,required:!0},customerId:{type:String},orderNumber:{type:String,required:!0,unique:!0},orderType:{type:String,enum:["dine-in","pickup","delivery","car-pickup","car_pickup","regular","table","dine_in","curbside"],default:"dine-in"},pickupType:{type:String,enum:["inside","table","car"]},tableNumber:{type:String},arrivalTime:{type:String},dineIn:{type:Boolean,default:!1},carPickup:{type:Boolean,default:!1},carInfo:{carType:{type:String},carColor:{type:String},plateNumber:{type:String}},carType:{type:String},carColor:{type:String},carPlate:{type:String},plateNumber:{type:String},items:{type:q.Types.Mixed,required:!0},totalAmount:{type:Number,required:!0},dailyNumber:{type:Number},paymentMethod:{type:String,enum:["cash","pos","apple_pay","pos-network","alinma","rajhi","ur","barq","qahwa-card","stc-pay","mada"],required:!0},paymentDetails:{type:String},paymentReceiptUrl:{type:String},isOpenTab:{type:Boolean,default:!1},status:{type:String,default:"pending",required:!0},statusHistory:[{status:{type:String,required:!0},timestamp:{type:Date,default:Date.now},updatedBy:{type:String},notes:{type:String}}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),Z=$.model("Order",Fa),_a=new q({orderId:{type:String,required:!0},coffeeItemId:{type:String,required:!0},quantity:{type:Number,required:!0},unitPrice:{type:Number,required:!0},totalPrice:{type:Number,required:!0},customization:{selectedAddons:[{addonId:{type:String},nameAr:{type:String},quantity:{type:Number},price:{type:Number},category:{type:String},rawItemId:{type:String},quantityPerUnit:{type:Number},unit:{type:String}}],notes:{type:String},totalAddonsPrice:{type:Number,default:0}},productSnapshot:{coffeeItemId:{type:String},nameAr:{type:String},nameEn:{type:String},price:{type:Number},imageUrl:{type:String},category:{type:String}},lineItemId:{type:String}}),br=$.model("OrderItem",_a),kn=new q({id:{type:String,required:!0},sessionId:{type:String,required:!0},coffeeItemId:{type:String,required:!0},quantity:{type:Number,required:!0},selectedSize:{type:String},selectedAddons:[{type:String}],createdAt:{type:Date,default:Date.now}});kn.index({sessionId:1,id:1});ve=$.model("CartItem",kn),$n=new q({customerId:{type:String,required:!0},customerName:{type:String},phoneNumber:{type:String,required:!0},qrToken:{type:String,required:!0,unique:!0},cardNumber:{type:String,required:!0,unique:!0},cardPin:{type:String},cardDesign:{type:String,default:"classic"},reissuanceCount:{type:Number,default:0,required:!0},stamps:{type:Number,default:0,required:!0},freeCupsEarned:{type:Number,default:0,required:!0},freeCupsRedeemed:{type:Number,default:0,required:!0},points:{type:Number,default:0,required:!0},pendingPoints:{type:Number,default:0,required:!0},tier:{type:String,default:"bronze",required:!0},totalSpent:{type:Number,default:0,required:!0},discountCount:{type:Number,default:0,required:!0},status:{type:String,default:"active",required:!0},isActive:{type:Boolean,default:!0,required:!0},lastUsedAt:{type:Date},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});$n.index({customerId:1});qe=$.model("LoyaltyCard",$n),La=new q({tenantId:{type:String,required:!0},referenceId:{type:String,required:!0},referenceType:{type:String,enum:["order","stock_transfer","purchase_invoice"],required:!0},fromStatus:{type:String,required:!0},toStatus:{type:String,required:!0},changedBy:{type:String,required:!0},notes:{type:String},createdAt:{type:Date,default:Date.now}}),Ua=$.model("StatusHistory",La),za=new q({code:{type:String,required:!0,unique:!0},issuedForOrderId:{type:String,required:!0},drinkName:{type:String,required:!0},isRedeemed:{type:Number,default:0,required:!0},redeemedAt:{type:Date},redeemedByCardId:{type:String},createdAt:{type:Date,default:Date.now}}),Bt=$.model("CardCode",za),Va=new q({cardId:{type:String,required:!0},orderId:{type:String},type:{type:String,required:!0},pointsChange:{type:Number,required:!0},discountAmount:{type:Number},orderAmount:{type:Number},description:{type:String},employeeId:{type:String},createdAt:{type:Date,default:Date.now}}),tr=$.model("LoyaltyTransaction",Va),Ga=new q({nameAr:{type:String,required:!0},nameEn:{type:String},description:{type:String,required:!0},pointsCost:{type:Number,required:!0},discountPercentage:{type:Number},discountAmount:{type:Number},tier:{type:String},isActive:{type:Number,default:1,required:!0},createdAt:{type:Date,default:Date.now}}),rr=$.model("LoyaltyReward",Ga),Qa=new q({nameAr:{type:String,required:!0},nameEn:{type:String},isAvailable:{type:Number,default:1,required:!0},icon:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),nr=$.model("Ingredient",Qa),Fn=new q({coffeeItemId:{type:String,required:!0},ingredientId:{type:String,required:!0},quantity:{type:Number,required:!0,default:0},unit:{type:String,required:!0,default:"ml"},createdAt:{type:Date,default:Date.now}});Fn.index({coffeeItemId:1,ingredientId:1},{unique:!0});qt=$.model("CoffeeItemIngredient",Fn),Ha=new q({nameAr:{type:String,required:!0,unique:!0},nameEn:{type:String},description:{type:String},icon:{type:String},sortOrder:{type:Number,default:0},isActive:{type:Number,default:1,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),kt=$.model("Category",Ha),Za=new q({username:{type:String,required:!0,unique:!0},password:{type:String,required:!0}}),ar=$.model("User",Za),_n=new q({tableNumber:{type:String,required:!0},qrToken:{type:String,required:!0,unique:!0},branchId:{type:String,required:!0},capacity:{type:Number,default:4},location:{type:String},isActive:{type:Number,default:1,required:!0},isOccupied:{type:Number,default:0,required:!0},currentOrderId:{type:String},reservedFor:{customerName:{type:String},customerPhone:{type:String},customerId:{type:String},reservationDate:{type:Date},reservationTime:{type:String},numberOfGuests:{type:Number},reservedAt:{type:Date},reservedBy:{type:String},status:{type:String,enum:["pending","confirmed","cancelled","completed","expired"],default:"pending"},autoBookStartTime:{type:Date},autoExpiryTime:{type:Date},extensionCount:{type:Number,default:0},lastExtendedAt:{type:Date},emailNotificationSent:{type:Boolean,default:!1}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});_n.index({tableNumber:1,branchId:1},{unique:!0});fe=$.model("Table",_n),hr=new q({invoiceNumber:{type:String,required:!0,unique:!0},uuid:{type:String,required:!0,unique:!0},orderId:{type:String,required:!0},sellerName:{type:String,required:!0,default:"CLUNY CAFE"},sellerNameEn:{type:String,default:"CLUNY CAFE"},sellerVatNumber:{type:String,required:!0,default:"311234567890003"},sellerCrNumber:{type:String},sellerAddress:{type:String,required:!0,default:"\u0627\u0644\u0631\u064A\u0627\u0636\u060C \u0627\u0644\u0645\u0645\u0644\u0643\u0629 \u0627\u0644\u0639\u0631\u0628\u064A\u0629 \u0627\u0644\u0633\u0639\u0648\u062F\u064A\u0629"},sellerCity:{type:String,default:"\u0627\u0644\u0631\u064A\u0627\u0636"},sellerPostalCode:{type:String},sellerBuildingNumber:{type:String},sellerDistrict:{type:String},sellerCountry:{type:String,default:"SA"},branchId:{type:String},customerName:{type:String,required:!0},customerPhone:{type:String,required:!0},customerEmail:{type:String},customerVatNumber:{type:String},customerAddress:{type:String},invoiceType:{type:String,enum:["standard","simplified","debit_note","credit_note"],default:"simplified"},invoiceTypeCode:{type:String,default:"388"},transactionType:{type:String,enum:["B2B","B2C"],default:"B2C"},items:{type:q.Types.Mixed,required:!0},subtotal:{type:Number,required:!0},totalDiscountAmount:{type:Number,default:0},taxableAmount:{type:Number,required:!0},taxAmount:{type:Number,required:!0},totalAmount:{type:Number,required:!0},paymentMethod:{type:String,enum:["cash","pos","apple_pay","pos-network","alinma","rajhi","ur","barq","qahwa-card","stc-pay","mada"],required:!0},paymentMeans:{type:String},invoiceCounter:{type:Number,required:!0},previousInvoiceHash:{type:String},invoiceHash:{type:String,required:!0},qrCode:{type:String,required:!0},xmlContent:{type:String},pdfUrl:{type:String},invoiceDate:{type:Date,required:!0},supplyDate:{type:Date},zatcaStatus:{type:String,enum:["pending","submitted","accepted","rejected","cleared"],default:"pending"},zatcaSubmissionId:{type:String},zatcaResponse:{type:String},createdBy:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});hr.index({invoiceDate:-1});hr.index({branchId:1,invoiceDate:-1});hr.index({zatcaStatus:1});dt=$.model("TaxInvoice",hr),rn=new q({branchId:{type:String,required:!0},date:{type:Date,required:!0},orderId:{type:String},invoiceId:{type:String},category:{type:String,enum:["sales","delivery_fee","service_charge","other"],default:"sales"},description:{type:String},grossAmount:{type:Number,required:!0},vatAmount:{type:Number,required:!0},netAmount:{type:Number,required:!0},paymentMethod:{type:String,enum:["cash","pos","apple_pay","pos-network","alinma","rajhi","ur","barq","qahwa-card","stc-pay","mada"],required:!0},employeeId:{type:String},notes:{type:String},createdAt:{type:Date,default:Date.now}});rn.index({branchId:1,date:-1});rn.index({category:1});Wa=$.model("Revenue",rn),Ir=new q({branchId:{type:String,required:!0},date:{type:Date,required:!0},category:{type:String,enum:["inventory","salaries","rent","utilities","marketing","maintenance","supplies","other"],required:!0},subcategory:{type:String},description:{type:String,required:!0},amount:{type:Number,required:!0},vatAmount:{type:Number,default:0},totalAmount:{type:Number,required:!0},paymentMethod:{type:String,enum:["cash","bank_transfer","credit_card","check","other"],required:!0},vendorName:{type:String},vendorVatNumber:{type:String},invoiceNumber:{type:String},receiptUrl:{type:String},approvedBy:{type:String},createdBy:{type:String,required:!0},status:{type:String,enum:["pending","approved","rejected","paid"],default:"pending"},notes:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Ir.index({branchId:1,date:-1});Ir.index({category:1});Ir.index({status:1});Ya=$.model("Expense",Ir),nn=new q({branchId:{type:String,required:!0},date:{type:Date,required:!0},employeeId:{type:String,required:!0},openingBalance:{type:Number,required:!0},openingTime:{type:Date,required:!0},cashSales:{type:Number,default:0},cardSales:{type:Number,default:0},otherSales:{type:Number,default:0},cashExpenses:{type:Number,default:0},deposits:{type:Number,default:0},withdrawals:{type:Number,default:0},expectedCash:{type:Number,default:0},actualCash:{type:Number,default:0},difference:{type:Number,default:0},closingTime:{type:Date},closedBy:{type:String},status:{type:String,enum:["open","closed"],default:"open"},notes:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});nn.index({branchId:1,date:-1});nn.index({employeeId:1,date:-1});Ja=$.model("CashRegister",nn),Ln=new q({branchId:{type:String,required:!0},date:{type:Date,required:!0},totalOrders:{type:Number,default:0},totalRevenue:{type:Number,default:0},totalVatCollected:{type:Number,default:0},cashRevenue:{type:Number,default:0},cardRevenue:{type:Number,default:0},otherRevenue:{type:Number,default:0},salesRevenue:{type:Number,default:0},deliveryRevenue:{type:Number,default:0},totalCogs:{type:Number,default:0},totalExpenses:{type:Number,default:0},grossProfit:{type:Number,default:0},netProfit:{type:Number,default:0},profitMargin:{type:Number,default:0},totalDiscounts:{type:Number,default:0},cancelledOrders:{type:Number,default:0},cancelledAmount:{type:Number,default:0},isGenerated:{type:Number,default:0},generatedAt:{type:Date},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Ln.index({branchId:1,date:-1},{unique:!0});Ka=$.model("DailySummary",Ln),wr=new q({orderId:{type:String,required:!0},orderNumber:{type:String,required:!0},branchId:{type:String,required:!0},items:[{itemId:{type:String,required:!0},nameAr:{type:String,required:!0},quantity:{type:Number,required:!0},notes:{type:String},status:{type:String,enum:["pending","preparing","ready"],default:"pending"},preparedBy:{type:String},preparedAt:{type:Date}}],priority:{type:String,enum:["normal","high","urgent"],default:"normal"},orderType:{type:String,enum:["dine-in","takeaway","delivery"],required:!0},tableNumber:{type:String},customerName:{type:String},status:{type:String,enum:["pending","in_progress","ready","completed","cancelled"],default:"pending"},assignedTo:{type:String},startedAt:{type:Date},completedAt:{type:Date},estimatedTime:{type:Number},notes:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});wr.index({branchId:1,status:1});wr.index({assignedTo:1,status:1});wr.index({createdAt:-1});Xa=$.model("KitchenOrder",wr),an=new q({employeeId:{type:String,required:!0},branchId:{type:String,required:!0},checkInTime:{type:Date,required:!0},checkOutTime:{type:Date},checkInLocation:{lat:{type:Number,required:!0},lng:{type:Number,required:!0}},checkOutLocation:{lat:{type:Number},lng:{type:Number}},checkInPhoto:{type:String,required:!0},checkOutPhoto:{type:String},status:{type:String,enum:["checked_in","checked_out","late","absent"],default:"checked_in",required:!0},shiftDate:{type:Date,required:!0},notes:{type:String},isLate:{type:Number,default:0,required:!0},lateMinutes:{type:Number},isAtBranch:{type:Number,default:1},distanceFromBranch:{type:Number,default:0},checkOutIsAtBranch:{type:Number},checkOutDistanceFromBranch:{type:Number},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});an.index({employeeId:1,shiftDate:1});an.index({branchId:1,shiftDate:1});eo=$.model("Attendance",an),to=c.object({id:c.string(),tenantId:c.string().optional(),nameAr:c.string(),nameEn:c.string().optional(),description:c.string(),price:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i),oldPrice:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i).optional(),category:c.string(),imageUrl:c.string().optional(),isAvailable:c.number().optional(),availabilityStatus:c.string().optional(),coffeeStrength:c.string().optional(),strengthLevel:c.number().optional(),isNewProduct:c.number().optional(),createdByEmployeeId:c.string().optional(),createdByBranchId:c.string().optional(),publishedBranches:c.array(c.string()).optional(),availableSizes:c.array(c.object({nameAr:c.string(),nameEn:c.string().optional(),price:c.number(),sizeML:c.number().optional(),sku:c.string().optional(),imageUrl:c.string().optional()})).optional(),addons:c.array(c.object({id:c.string().optional(),nameAr:c.string(),nameEn:c.string().optional(),price:c.number(),category:c.string().optional(),imageUrl:c.string().optional()})).optional(),isGiftable:c.boolean().optional()}),ro=c.object({username:c.string(),password:c.string().optional(),fullName:c.string(),role:c.string(),title:c.string().optional(),phone:c.string(),jobTitle:c.string(),imageUrl:c.string().optional(),shiftTime:c.string().optional().nullable(),shiftStartTime:c.string().optional(),shiftEndTime:c.string().optional(),commissionPercentage:c.number().optional(),deviceBalance:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseInt(i):i).optional(),isActivated:c.number().optional(),branchId:c.string().optional(),employmentNumber:c.string().optional(),vehicleType:c.string().optional(),vehiclePlateNumber:c.string().optional(),vehicleColor:c.string().optional(),licenseNumber:c.string().optional(),isAvailableForDelivery:c.number().optional(),permissions:c.array(c.string()).optional(),allowedPages:c.array(c.string()).optional(),currentLocation:c.object({lat:c.number(),lng:c.number(),updatedAt:c.date().optional()}).optional()}),no=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String},username:{type:String,required:!0,unique:!0},password:{type:String},fullName:{type:String,required:!0},role:{type:String,required:!0},title:{type:String},phone:{type:String,required:!0,unique:!0},jobTitle:{type:String,required:!0},imageUrl:{type:String},shiftTime:{type:String},shiftStartTime:{type:String},shiftEndTime:{type:String},workDays:[{type:String}],commissionPercentage:{type:Number},deviceBalance:{type:Number,default:0},isActivated:{type:Number,default:0},isActive:{type:Number,default:1},branchId:{type:String},employmentNumber:{type:String},vehicleType:{type:String},vehiclePlateNumber:{type:String},vehicleColor:{type:String},licenseNumber:{type:String},isAvailableForDelivery:{type:Number,default:0},currentLocation:{lat:{type:Number},lng:{type:Number},updatedAt:{type:Date}},permissions:[{type:String}],allowedPages:[{type:String}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),he=$.model("Employee",no),vr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},managerId:{type:String},employeeId:{type:String,required:!0},employeeName:{type:String,required:!0},type:{type:String,enum:["late_checkin","left_branch","no_checkin","early_checkout","overtime"],required:!0},title:{type:String,required:!0},message:{type:String,required:!0},severity:{type:String,enum:["info","warning","critical"],default:"warning"},isRead:{type:Boolean,default:!1},isResolved:{type:Boolean,default:!1},metadata:{shiftStartTime:{type:String},actualCheckInTime:{type:String},lateMinutes:{type:Number},distanceFromBranch:{type:Number},location:{lat:{type:Number},lng:{type:Number}}},createdAt:{type:Date,default:Date.now}});vr.index({branchId:1,isRead:1});vr.index({managerId:1,isRead:1});vr.index({employeeId:1,createdAt:-1});ao=$.model("ManagerNotification",vr),Un=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},name:{type:String,required:!0},nameAr:{type:String,required:!0},startTime:{type:String,required:!0},endTime:{type:String,required:!0},breakDurationMinutes:{type:Number,default:60},isOvernight:{type:Boolean,default:!1},isActive:{type:Boolean,default:!0},color:{type:String,default:"#9FB2B3"},createdAt:{type:Date,default:Date.now}});Un.index({branchId:1,isActive:1});oo=$.model("Shift",Un),on=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},employeeId:{type:String,required:!0},shiftId:{type:String,required:!0},dayOfWeek:{type:Number,required:!0,min:0,max:6},effectiveFrom:{type:Date,required:!0},effectiveTo:{type:Date},isActive:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now}});on.index({employeeId:1,dayOfWeek:1,isActive:1});on.index({branchId:1,shiftId:1});so=$.model("EmployeeShiftAssignment",on),io=c.object({items:c.any(),totalAmount:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i),paymentMethod:c.string(),paymentDetails:c.string().optional(),paymentReceiptUrl:c.string().optional(),status:c.string().optional(),tableStatus:c.enum(["pending","payment_confirmed","preparing","ready","delivered","cancelled"]).optional(),orderType:c.enum(["regular","table","dine_in","dine-in"]).optional(),customerInfo:c.any().optional(),customerId:c.string().optional(),employeeId:c.string().optional(),assignedCashierId:c.string().optional(),branchId:c.string().optional(),tableNumber:c.string().optional(),tableId:c.string().optional(),customerNotes:c.string().optional(),cancellationReason:c.string().optional(),cancelledBy:c.enum(["customer","cashier"]).optional(),carPickup:c.any().optional(),carType:c.string().optional(),carColor:c.string().optional(),carPlate:c.string().optional(),deliveryType:c.enum(["pickup","delivery","dine-in","curbside"]).optional(),deliveryAddress:c.object({fullAddress:c.string().optional(),lat:c.number(),lng:c.number(),zone:c.string().optional(),isInDeliveryZone:c.boolean().optional()}).optional(),deliveryFee:c.number().optional(),driverId:c.string().optional(),driverLocation:c.object({lat:c.number(),lng:c.number(),updatedAt:c.date().optional()}).optional(),deliveryStatus:c.string().optional(),deliveryStartedAt:c.date().optional(),estimatedDeliveryTime:c.date().optional(),deliveredAt:c.date().optional(),costOfGoods:c.number().optional(),grossProfit:c.number().optional(),inventoryDeducted:c.number().optional(),inventoryDeductionDetails:c.array(c.object({rawItemId:c.string(),rawItemName:c.string(),quantity:c.number(),unit:c.string(),unitCost:c.number(),totalCost:c.number()})).optional()}).refine(i=>!(["alinma","ur","barq","rajhi"].includes(i.paymentMethod)&&!i.paymentReceiptUrl),{message:"\u0625\u064A\u0635\u0627\u0644 \u0627\u0644\u062F\u0641\u0639 \u0645\u0637\u0644\u0648\u0628 \u0644\u0637\u0631\u0642 \u0627\u0644\u062F\u0641\u0639 \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A\u0629",path:["paymentReceiptUrl"]}).refine(i=>!(i.deliveryType==="delivery"&&!i.deliveryAddress),{message:"\u0639\u0646\u0648\u0627\u0646 \u0627\u0644\u062A\u0648\u0635\u064A\u0644 \u0645\u0637\u0644\u0648\u0628 \u0644\u0637\u0644\u0628\u0627\u062A \u0627\u0644\u062A\u0648\u0635\u064A\u0644",path:["deliveryAddress"]}),co=c.object({orderId:c.string(),coffeeItemId:c.string(),quantity:c.number(),unitPrice:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i),totalPrice:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i)}),uo=c.object({sessionId:c.string(),coffeeItemId:c.string(),quantity:c.number()}),lo=c.object({phone:c.string(),email:c.string().email("\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D").optional(),name:c.string().min(2,"\u0627\u0644\u0627\u0633\u0645 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 \u062D\u0631\u0641\u064A\u0646"),password:c.string().min(4,"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 4 \u0623\u062D\u0631\u0641").optional(),registeredBy:c.enum(["self","cashier"]).optional(),isPasswordSet:c.number().optional(),points:c.number().optional(),carType:c.string().optional(),carColor:c.string().optional(),saveCarInfo:c.number().optional()}),mo=c.object({email:c.string(),token:c.string(),expiresAt:c.date()}),po=c.object({code:c.string(),discountPercentage:c.number(),reason:c.string(),employeeId:c.string(),isActive:c.number().optional()}),yo=c.object({customerName:c.string().optional(),phoneNumber:c.string()}),go=c.object({issuedForOrderId:c.string(),drinkName:c.string()}),fo=c.object({cardId:c.string(),orderId:c.string().optional(),type:c.string(),pointsChange:c.number(),discountAmount:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i).optional(),orderAmount:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i).optional(),description:c.string().optional(),employeeId:c.string().optional()}),bo=c.object({nameAr:c.string(),nameEn:c.string().optional(),description:c.string(),pointsCost:c.number(),discountPercentage:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i).optional(),discountAmount:c.union([c.string(),c.number()]).transform(i=>typeof i=="string"?parseFloat(i):i).optional(),tier:c.string().optional(),isActive:c.number().optional()}),ho=c.object({nameAr:c.string(),nameEn:c.string().optional(),isAvailable:c.number().optional(),icon:c.string().optional()}),Io=c.object({coffeeItemId:c.string(),ingredientId:c.string()}),wo=c.object({username:c.string(),password:c.string()}),vo=c.object({nameAr:c.string().min(2,"\u0627\u0633\u0645 \u0627\u0644\u0641\u0631\u0639 \u0645\u0637\u0644\u0648\u0628"),nameEn:c.string().optional(),address:c.string().min(5,"\u0627\u0644\u0639\u0646\u0648\u0627\u0646 \u0645\u0637\u0644\u0648\u0628"),phone:c.string().min(9,"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0645\u0637\u0644\u0648\u0628"),city:c.string().min(2,"\u0627\u0644\u0645\u062F\u064A\u0646\u0629 \u0645\u0637\u0644\u0648\u0628\u0629"),location:c.object({lat:c.number(),lng:c.number()}).optional(),mapsUrl:c.string().optional(),isActive:c.number().optional(),managerName:c.string().optional()}),Ao=c.object({nameAr:c.string().min(2,"\u0627\u0633\u0645 \u0627\u0644\u0641\u0626\u0629 \u0645\u0637\u0644\u0648\u0628"),nameEn:c.string().optional(),description:c.string().optional(),icon:c.string().optional(),sortOrder:c.number().optional(),isActive:c.number().optional()}),So=c.object({tableNumber:c.string().min(1,"\u0631\u0642\u0645 \u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u0637\u0644\u0648\u0628"),qrToken:c.string().optional(),branchId:c.string().min(1,"\u0645\u0639\u0631\u0651\u0641 \u0627\u0644\u0641\u0631\u0639 \u0645\u0637\u0644\u0648\u0628"),capacity:c.number().optional(),location:c.string().optional(),isActive:c.number().optional(),isOccupied:c.number().optional(),currentOrderId:c.string().optional(),reservedFor:c.object({customerName:c.string(),customerPhone:c.string(),customerId:c.string().optional(),reservationDate:c.coerce.date().optional(),reservationTime:c.string().optional(),numberOfGuests:c.number().optional(),reservedAt:c.coerce.date().optional(),reservedBy:c.string(),status:c.enum(["pending","confirmed","cancelled","completed"]).optional()}).optional()}),Do=c.object({employeeId:c.string(),branchId:c.string(),checkInTime:c.coerce.date(),checkOutTime:c.coerce.date().optional(),checkInLocation:c.object({lat:c.number(),lng:c.number()}),checkOutLocation:c.object({lat:c.number(),lng:c.number()}).optional(),checkInPhoto:c.string(),checkOutPhoto:c.string().optional(),status:c.enum(["checked_in","checked_out","late","absent"]).optional(),shiftDate:c.coerce.date(),notes:c.string().optional(),isLate:c.number().optional(),lateMinutes:c.number().optional()}),Co=new q({code:{type:String,required:!0,unique:!0},nameAr:{type:String,required:!0},nameEn:{type:String},description:{type:String},category:{type:String,enum:["ingredient","packaging","equipment","consumable","other"],required:!0},unit:{type:String,enum:["kg","g","liter","ml","piece","box","bag"],required:!0},unitCost:{type:Number,required:!0,default:0},minStockLevel:{type:Number,required:!0,default:0},maxStockLevel:{type:Number},supplierId:{type:String},isActive:{type:Number,default:1,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),oe=$.model("RawItem",Co),Po=new q({code:{type:String,required:!0,unique:!0},nameAr:{type:String,required:!0},nameEn:{type:String},contactPerson:{type:String},phone:{type:String,required:!0},email:{type:String},address:{type:String},city:{type:String},taxNumber:{type:String},paymentTerms:{type:String},notes:{type:String},isActive:{type:Number,default:1,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),yt=$.model("Supplier",Po),zn=new q({branchId:{type:String,required:!0},rawItemId:{type:String,required:!0},currentQuantity:{type:Number,required:!0,default:0},reservedQuantity:{type:Number,default:0},lastUpdated:{type:Date,default:Date.now},lastCountDate:{type:Date},notes:{type:String}});zn.index({branchId:1,rawItemId:1},{unique:!0});be=$.model("BranchStock",zn),xo=new q({transferNumber:{type:String,required:!0,unique:!0},fromBranchId:{type:String,required:!0},toBranchId:{type:String,required:!0},status:{type:String,enum:["pending","approved","in_transit","completed","cancelled"],default:"pending",required:!0},items:[{rawItemId:{type:String,required:!0},quantity:{type:Number,required:!0},notes:{type:String}}],requestedBy:{type:String,required:!0},approvedBy:{type:String},requestDate:{type:Date,default:Date.now},approvalDate:{type:Date},completionDate:{type:Date},notes:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),Dt=$.model("StockTransfer",xo),jo=new q({invoiceNumber:{type:String,required:!0,unique:!0},supplierId:{type:String,required:!0},branchId:{type:String,required:!0},status:{type:String,enum:["draft","pending","approved","received","cancelled"],default:"draft",required:!0},items:[{rawItemId:{type:String,required:!0},quantity:{type:Number,required:!0},unitCost:{type:Number,required:!0},totalCost:{type:Number,required:!0},notes:{type:String}}],subtotal:{type:Number,required:!0,default:0},taxAmount:{type:Number,default:0},discountAmount:{type:Number,default:0},totalAmount:{type:Number,required:!0,default:0},paymentStatus:{type:String,enum:["unpaid","partial","paid"],default:"unpaid",required:!0},paidAmount:{type:Number,default:0},invoiceDate:{type:Date,required:!0,default:Date.now},dueDate:{type:Date},receivedDate:{type:Date},receivedBy:{type:String},createdBy:{type:String,required:!0},approvedBy:{type:String},notes:{type:String},attachmentUrl:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),gt=$.model("PurchaseInvoice",jo),Vn=new q({coffeeItemId:{type:String,required:!0},rawItemId:{type:String,required:!0},quantity:{type:Number,required:!0},unit:{type:String,required:!0},notes:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Vn.index({coffeeItemId:1,rawItemId:1},{unique:!0});Ne=$.model("RecipeItem",Vn),sn=new q({coffeeItemId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},version:{type:Number,default:1,required:!0},isActive:{type:Boolean,default:!0,required:!0},totalCost:{type:Number,default:0,required:!0},ingredients:[{rawItemId:{type:String,required:!0},rawItemName:{type:String,required:!0},quantity:{type:Number,required:!0},unit:{type:String,required:!0},unitCost:{type:Number,required:!0},totalCost:{type:Number,required:!0}}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});sn.index({coffeeItemId:1,version:-1});sn.index({isActive:1});or=$.model("Recipe",sn),Gn=new q({branchId:{type:String,required:!0},rawItemId:{type:String,required:!0},alertType:{type:String,enum:["low_stock","out_of_stock","expiring_soon","expired"],required:!0},currentQuantity:{type:Number,required:!0},thresholdQuantity:{type:Number,required:!0},isRead:{type:Number,default:0,required:!0},isResolved:{type:Number,default:0,required:!0},resolvedBy:{type:String},resolvedAt:{type:Date},createdAt:{type:Date,default:Date.now}});Gn.index({branchId:1,isResolved:1});Ve=$.model("StockAlert",Gn),cn=new q({branchId:{type:String,required:!0},rawItemId:{type:String,required:!0},movementType:{type:String,enum:["purchase","sale","transfer_in","transfer_out","adjustment","waste","return"],required:!0},quantity:{type:Number,required:!0},previousQuantity:{type:Number,required:!0},newQuantity:{type:Number,required:!0},referenceType:{type:String,enum:["purchase_invoice","order","transfer","manual"]},referenceId:{type:String},notes:{type:String},createdBy:{type:String,required:!0},createdAt:{type:Date,default:Date.now}});cn.index({branchId:1,rawItemId:1});cn.index({createdAt:-1});Re=$.model("StockMovement",cn),Qn=new q({tenantId:{type:String,required:!0},fromUnit:{type:String,required:!0},toUnit:{type:String,required:!0},conversionFactor:{type:Number,required:!0},formula:{type:String}});Qn.index({tenantId:1,fromUnit:1,toUnit:1});No=$.model("UnitConversion",Qn),To=c.object({code:c.string(),nameAr:c.string(),nameEn:c.string().optional(),description:c.string().optional(),category:c.enum(["ingredient","packaging","equipment","consumable","other"]),unit:c.enum(["kg","g","liter","ml","piece","box","bag"]),unitCost:c.number().min(0),minStockLevel:c.number().min(0),maxStockLevel:c.number().min(0).optional(),supplierId:c.string().optional(),isActive:c.number().default(1)}),Ro=c.object({code:c.string(),nameAr:c.string(),nameEn:c.string().optional(),contactPerson:c.string().optional(),phone:c.string(),email:c.string().email().optional(),address:c.string().optional(),city:c.string().optional(),taxNumber:c.string().optional(),paymentTerms:c.string().optional(),notes:c.string().optional(),isActive:c.number().optional()}),Oo=c.object({branchId:c.string(),rawItemId:c.string(),currentQuantity:c.number().min(0),reservedQuantity:c.number().min(0).optional(),notes:c.string().optional()}),Eo=c.object({fromBranchId:c.string(),toBranchId:c.string(),items:c.array(c.object({rawItemId:c.string(),quantity:c.number().positive(),notes:c.string().optional()})),requestedBy:c.string(),notes:c.string().optional()}),Mo=c.object({supplierId:c.string(),branchId:c.string(),items:c.array(c.object({rawItemId:c.string(),quantity:c.number().positive(),unitCost:c.number().min(0),totalCost:c.number().min(0),notes:c.string().optional()})),subtotal:c.number().min(0),taxAmount:c.number().min(0).optional(),discountAmount:c.number().min(0).optional(),totalAmount:c.number().min(0),invoiceDate:c.coerce.date().optional(),dueDate:c.coerce.date().optional(),createdBy:c.string(),notes:c.string().optional()}),Bo=c.object({coffeeItemId:c.string(),rawItemId:c.string(),quantity:c.number().positive(),unit:c.string(),notes:c.string().optional()}),qo=c.object({branchId:c.string(),rawItemId:c.string(),movementType:c.enum(["purchase","sale","transfer_in","transfer_out","adjustment","waste","return"]),quantity:c.number(),previousQuantity:c.number(),newQuantity:c.number(),referenceType:c.enum(["purchase_invoice","order","transfer","manual"]).optional(),referenceId:c.string().optional(),notes:c.string().optional(),createdBy:c.string()}),ko=c.object({orderId:c.string(),customerName:c.string(),customerPhone:c.string(),customerEmail:c.string().optional(),customerVatNumber:c.string().optional(),customerAddress:c.string().optional(),invoiceType:c.enum(["standard","simplified","debit_note","credit_note"]).optional(),transactionType:c.enum(["B2B","B2C"]).optional(),items:c.array(c.object({itemId:c.string(),nameAr:c.string(),nameEn:c.string().optional(),quantity:c.number(),unitPrice:c.number(),discountAmount:c.number().optional(),taxRate:c.number().optional()})),paymentMethod:c.string(),branchId:c.string().optional(),createdBy:c.string().optional()}),$o=c.object({branchId:c.string(),date:c.coerce.date(),category:c.enum(["inventory","salaries","rent","utilities","marketing","maintenance","supplies","other"]),subcategory:c.string().optional(),description:c.string(),amount:c.number().positive(),vatAmount:c.number().min(0).optional(),paymentMethod:c.enum(["cash","bank_transfer","credit_card","check","other"]),vendorName:c.string().optional(),vendorVatNumber:c.string().optional(),invoiceNumber:c.string().optional(),receiptUrl:c.string().optional(),createdBy:c.string(),notes:c.string().optional()}),Fo=c.object({branchId:c.string(),date:c.coerce.date(),orderId:c.string().optional(),invoiceId:c.string().optional(),category:c.enum(["sales","delivery_fee","service_charge","other"]).optional(),description:c.string().optional(),grossAmount:c.number(),vatAmount:c.number(),netAmount:c.number(),paymentMethod:c.string(),employeeId:c.string().optional(),notes:c.string().optional()}),_o=c.object({branchId:c.string(),employeeId:c.string(),openingBalance:c.number().min(0)}),Lo=c.object({orderId:c.string(),orderNumber:c.string(),branchId:c.string(),items:c.array(c.object({itemId:c.string(),nameAr:c.string(),quantity:c.number(),notes:c.string().optional()})),priority:c.enum(["normal","high","urgent"]).optional(),orderType:c.enum(["dine-in","takeaway","delivery"]),tableNumber:c.string().optional(),customerName:c.string().optional(),notes:c.string().optional()}),Uo=c.object({id:c.string(),nameAr:c.string(),nameEn:c.string().optional(),category:c.enum(["sugar","milk","shot","syrup","topping","size","other","flavor","Flavor","Shot"]),price:c.number().min(0),isAvailable:c.number().optional().default(1),isFree:c.number().optional(),rawItemId:c.string().optional(),quantityPerUnit:c.number().optional(),unit:c.string().optional(),orderIndex:c.number().optional(),sku:c.string().optional(),imageUrl:c.string().optional(),isAddonDrink:c.boolean().optional(),isIndependentProduct:c.boolean().optional(),linkedCoffeeItemId:c.string().optional(),inventoryRawItemId:c.string().optional(),linkedRawItemId:c.string().optional()}),zo=c.object({coffeeItemId:c.string(),addonId:c.string(),isDefault:c.number().optional(),defaultValue:c.string().optional(),minQuantity:c.number().optional(),maxQuantity:c.number().optional()}),dn=new q({productId:{type:String,required:!0},customerId:{type:String,required:!0},rating:{type:Number,required:!0,min:1,max:5},comment:{type:String},adminReply:{type:String},adminReplyDate:{type:Date},isVerifiedPurchase:{type:Number,default:0},helpful:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});dn.index({productId:1,rating:1});dn.index({customerId:1});Ar=$.model("ProductReview",dn),Sr=new q({referrerId:{type:String,required:!0},referrerCode:{type:String,required:!0,unique:!1},referredCustomerId:{type:String},referredPhone:{type:String,required:!0},referredEmail:{type:String},status:{type:String,enum:["pending","completed","verified"],default:"pending"},pointsAwarded:{type:Number,default:0},referralBonus:{type:Number,default:50},referralDate:{type:Date,default:Date.now},completionDate:{type:Date},createdAt:{type:Date,default:Date.now}});Sr.index({referrerId:1});Sr.index({referrerCode:1});Sr.index({referredCustomerId:1});Dr=$.model("Referral",Sr),un=new q({customerId:{type:String,required:!0},title:{type:String,required:!0},message:{type:String,required:!0},type:{type:String,enum:["order_update","referral","loyalty","promotion","system"],default:"system"},relatedOrderId:{type:String},isRead:{type:Number,default:0},createdAt:{type:Date,default:Date.now}});un.index({customerId:1,createdAt:-1});un.index({isRead:1});ft=$.model("Notification",un),Vo=c.object({productId:c.string(),customerId:c.string(),rating:c.number().min(1).max(5),comment:c.string().optional(),isVerifiedPurchase:c.number().optional()}),Go=c.object({referrerId:c.string(),referredPhone:c.string(),referredEmail:c.string().optional()}),Qo=c.object({customerId:c.string(),title:c.string(),message:c.string(),type:c.enum(["order_update","referral","loyalty","promotion","system"]),relatedOrderId:c.string().optional()}),Cr=new q({tenantId:{type:String,required:!0},branchId:{type:String,required:!0},snapshotDate:{type:Date,default:Date.now,required:!0},snapshotType:{type:String,enum:["daily","monthly","custom"],default:"daily",required:!0},periodStart:{type:Date,required:!0},periodEnd:{type:Date,required:!0},totalRevenue:{type:Number,required:!0,default:0},totalOrders:{type:Number,required:!0,default:0},averageOrderValue:{type:Number,required:!0,default:0},totalCostOfGoods:{type:Number,required:!0,default:0},totalDiscounts:{type:Number,required:!0,default:0},totalDeliveryFees:{type:Number,required:!0,default:0},staffCosts:{type:Number,default:0},utilities:{type:Number,default:0},rent:{type:Number,default:0},marketing:{type:Number,default:0},otherExpenses:{type:Number,default:0},wasteAmount:{type:Number,required:!0,default:0},wastePercentage:{type:Number,required:!0,default:0},inventoryAdjustments:{type:Number,required:!0,default:0},grossProfit:{type:Number,required:!0,default:0},grossProfitMargin:{type:Number,required:!0,default:0},netProfit:{type:Number,default:0},netProfitMargin:{type:Number,default:0},vatPercentage:{type:Number,required:!0,default:0},totalVAT:{type:Number,required:!0,default:0},taxableAmount:{type:Number,required:!0,default:0},ordersWithCOGS:{type:Number,required:!0,default:0},uniqueProducts:{type:Number,required:!0,default:0},topProductsByRevenue:[{productId:{type:String,required:!0},productName:{type:String,required:!0},quantity:{type:Number,required:!0},revenue:{type:Number,required:!0}}],notes:{type:String},createdBy:{type:String,required:!0},approvedBy:{type:String},approvalDate:{type:Date},isApproved:{type:Number,default:0,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Cr.index({tenantId:1,branchId:1,snapshotDate:-1});Cr.index({tenantId:1,snapshotType:1});Cr.index({isApproved:1});Pr=$.model("AccountingSnapshot",Cr),Ho=c.object({tenantId:c.string(),branchId:c.string(),snapshotDate:c.date().optional(),snapshotType:c.enum(["daily","monthly","custom"]),periodStart:c.date(),periodEnd:c.date(),totalRevenue:c.number(),totalOrders:c.number(),averageOrderValue:c.number(),totalCostOfGoods:c.number(),totalDiscounts:c.number(),totalDeliveryFees:c.number(),staffCosts:c.number().optional(),utilities:c.number().optional(),rent:c.number().optional(),marketing:c.number().optional(),otherExpenses:c.number().optional(),wasteAmount:c.number(),wastePercentage:c.number(),inventoryAdjustments:c.number(),grossProfit:c.number(),grossProfitMargin:c.number(),netProfit:c.number().optional(),netProfitMargin:c.number().optional(),vatPercentage:c.number(),totalVAT:c.number(),taxableAmount:c.number(),ordersWithCOGS:c.number(),uniqueProducts:c.number(),topProductsByRevenue:c.array(c.object({productId:c.string(),productName:c.string(),quantity:c.number(),revenue:c.number()})).optional(),notes:c.string().optional(),createdBy:c.string(),approvedBy:c.string().optional()}),Zo={ASSET:"asset",LIABILITY:"liability",EQUITY:"equity",REVENUE:"revenue",EXPENSE:"expense",CONTRA:"contra"},ln=new q({tenantId:{type:String,required:!0},name:{type:String,required:!0},nameAr:{type:String,required:!0},startDate:{type:Date,required:!0},endDate:{type:Date,required:!0},status:{type:String,enum:["open","closed","locked"],default:"open"},closedBy:{type:String},closedAt:{type:Date},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});ln.index({tenantId:1,startDate:1});ln.index({tenantId:1,status:1});mn=$.model("FiscalPeriod",ln),pn=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},code:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},parentId:{type:String},branchId:{type:String},isActive:{type:Number,default:1},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});pn.index({tenantId:1,code:1},{unique:!0});pn.index({tenantId:1,branchId:1});Wo=$.model("CostCenter",pn),$t=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},accountNumber:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},accountType:{type:String,enum:["asset","liability","equity","revenue","expense","contra"],required:!0},parentAccountId:{type:String},normalBalance:{type:String,enum:["debit","credit"],required:!0},currency:{type:String,default:"SAR"},isActive:{type:Number,default:1},isSystemAccount:{type:Number,default:0},isBankAccount:{type:Number,default:0},bankName:{type:String},bankAccountNumber:{type:String},iban:{type:String},openingBalance:{type:Number,default:0},currentBalance:{type:Number,default:0},branchId:{type:String},costCenterId:{type:String},description:{type:String},level:{type:Number,default:1},path:{type:String,default:""},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});$t.index({tenantId:1,accountNumber:1},{unique:!0});$t.index({tenantId:1,accountType:1});$t.index({tenantId:1,parentAccountId:1});$t.index({tenantId:1,isActive:1});$t.index({tenantId:1,isBankAccount:1});te=$.model("Account",$t),Ft=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},entryNumber:{type:String,required:!0},entryDate:{type:Date,required:!0},fiscalPeriodId:{type:String},referenceType:{type:String,enum:["order","invoice","expense","adjustment","opening","closing","manual"]},referenceId:{type:String},description:{type:String,required:!0},lines:[{accountId:{type:String,required:!0},accountNumber:{type:String,required:!0},accountName:{type:String,required:!0},debit:{type:Number,default:0},credit:{type:Number,default:0},description:{type:String},costCenterId:{type:String},branchId:{type:String}}],totalDebit:{type:Number,default:0},totalCredit:{type:Number,default:0},isBalanced:{type:Number,default:1},status:{type:String,enum:["draft","posted","reversed","voided"],default:"draft"},reversedEntryId:{type:String},isAutoPosted:{type:Number,default:0},postedBy:{type:String},postedAt:{type:Date},createdBy:{type:String,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Ft.index({tenantId:1,entryNumber:1},{unique:!0});Ft.index({tenantId:1,entryDate:-1});Ft.index({tenantId:1,status:1});Ft.index({tenantId:1,referenceType:1,referenceId:1});Ft.index({"lines.accountId":1});bt=$.model("JournalEntry",Ft),yn=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},code:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},rate:{type:Number,required:!0},taxType:{type:String,enum:["vat","service","excise","withholding","other"],default:"vat"},isDefault:{type:Number,default:0},isActive:{type:Number,default:1},accountId:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});yn.index({tenantId:1,code:1},{unique:!0});yn.index({tenantId:1,isActive:1});Yo=$.model("TaxRate",yn),ht=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},invoiceNumber:{type:String,required:!0},invoiceDate:{type:Date,required:!0},dueDate:{type:Date},invoiceType:{type:String,enum:["sales","purchase","credit_note","debit_note"],default:"sales"},status:{type:String,enum:["draft","issued","sent","paid","partially_paid","overdue","cancelled","voided"],default:"draft"},customerId:{type:String},customerName:{type:String,required:!0},customerPhone:{type:String},customerEmail:{type:String},customerTaxNumber:{type:String},customerAddress:{type:String},vendorId:{type:String},vendorName:{type:String},vendorTaxNumber:{type:String},orderId:{type:String},lines:[{itemId:{type:String},description:{type:String,required:!0},quantity:{type:Number,required:!0},unitPrice:{type:Number,required:!0},discountAmount:{type:Number,default:0},discountPercent:{type:Number,default:0},taxRate:{type:Number,default:15},taxAmount:{type:Number,default:0},lineTotal:{type:Number,required:!0},costCenterId:{type:String}}],subtotal:{type:Number,required:!0},totalDiscount:{type:Number,default:0},totalTax:{type:Number,default:0},grandTotal:{type:Number,required:!0},amountPaid:{type:Number,default:0},amountDue:{type:Number,required:!0},currency:{type:String,default:"SAR"},exchangeRate:{type:Number,default:1},paymentTerms:{type:String},paymentMethod:{type:String},notes:{type:String},internalNotes:{type:String},zatcaUuid:{type:String},zatcaHash:{type:String},zatcaQrCode:{type:String},zatcaInvoiceXml:{type:String},zatcaStatus:{type:String,enum:["pending","submitted","accepted","rejected","cleared"]},zatcaSubmittedAt:{type:Date},zatcaResponseCode:{type:String},zatcaResponseMessage:{type:String},issuedBy:{type:String},issuedAt:{type:Date},paidAt:{type:Date},cancelledBy:{type:String},cancelledAt:{type:Date},cancellationReason:{type:String},linkedInvoiceId:{type:String},journalEntryId:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});ht.index({tenantId:1,invoiceNumber:1},{unique:!0});ht.index({tenantId:1,branchId:1,invoiceDate:-1});ht.index({tenantId:1,status:1});ht.index({tenantId:1,customerId:1});ht.index({tenantId:1,orderId:1});ht.index({tenantId:1,zatcaStatus:1});ht.index({zatcaUuid:1});ut=$.model("Invoice",ht),_t=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},expenseNumber:{type:String,required:!0},expenseDate:{type:Date,required:!0},category:{type:String,enum:["inventory","salaries","rent","utilities","marketing","maintenance","supplies","other"],required:!0},subcategory:{type:String},description:{type:String,required:!0},amount:{type:Number,required:!0},taxAmount:{type:Number,default:0},totalAmount:{type:Number,required:!0},paymentMethod:{type:String,enum:["cash","bank_transfer","check","credit_card","other"],default:"cash"},paymentReference:{type:String},vendorId:{type:String},vendorName:{type:String},invoiceNumber:{type:String},invoiceDate:{type:Date},attachmentUrls:[{type:String}],accountId:{type:String},costCenterId:{type:String},status:{type:String,enum:["draft","pending_approval","approved","rejected","paid","cancelled"],default:"draft"},requestedBy:{type:String,required:!0},approvedBy:{type:String},approvedAt:{type:Date},rejectedBy:{type:String},rejectedAt:{type:Date},rejectionReason:{type:String},paidBy:{type:String},paidAt:{type:Date},journalEntryId:{type:String},notes:{type:String},isRecurring:{type:Number,default:0},recurringFrequency:{type:String,enum:["weekly","monthly","quarterly","yearly"]},nextRecurringDate:{type:Date},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});_t.index({tenantId:1,expenseNumber:1},{unique:!0});_t.index({tenantId:1,branchId:1,expenseDate:-1});_t.index({tenantId:1,status:1});_t.index({tenantId:1,category:1});_t.index({tenantId:1,requestedBy:1});It=$.model("ExpenseErp",_t),xr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},code:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},taxNumber:{type:String},commercialRegistration:{type:String},phone:{type:String},email:{type:String},address:{type:String},city:{type:String},country:{type:String,default:"SA"},bankName:{type:String},bankAccountNumber:{type:String},iban:{type:String},paymentTerms:{type:String},creditLimit:{type:Number,default:0},currentBalance:{type:Number,default:0},contactPerson:{type:String},contactPhone:{type:String},notes:{type:String},isActive:{type:Number,default:1},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});xr.index({tenantId:1,code:1},{unique:!0});xr.index({tenantId:1,nameAr:1});xr.index({tenantId:1,isActive:1});jr=$.model("Vendor",xr),Lt=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},paymentNumber:{type:String,required:!0},paymentDate:{type:Date,required:!0},paymentType:{type:String,enum:["receipt","payment"],required:!0},referenceType:{type:String,enum:["invoice","expense","order","advance","refund"],required:!0},referenceId:{type:String,required:!0},customerId:{type:String},vendorId:{type:String},amount:{type:Number,required:!0},paymentMethod:{type:String,enum:["cash","bank_transfer","check","credit_card","pos","wallet","other"],required:!0},bankAccountId:{type:String},checkNumber:{type:String},transactionReference:{type:String},description:{type:String},status:{type:String,enum:["pending","completed","bounced","cancelled"],default:"completed"},journalEntryId:{type:String},processedBy:{type:String,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Lt.index({tenantId:1,paymentNumber:1},{unique:!0});Lt.index({tenantId:1,branchId:1,paymentDate:-1});Lt.index({tenantId:1,referenceType:1,referenceId:1});Lt.index({tenantId:1,customerId:1});Lt.index({tenantId:1,vendorId:1});Jo=$.model("PaymentRecord",Lt),gn=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},bankAccountId:{type:String,required:!0},statementDate:{type:Date,required:!0},startDate:{type:Date,required:!0},endDate:{type:Date,required:!0},openingBalance:{type:Number,required:!0},closingBalance:{type:Number,required:!0},totalCredits:{type:Number,default:0},totalDebits:{type:Number,default:0},transactionCount:{type:Number,default:0},status:{type:String,enum:["uploaded","in_progress","reconciled"],default:"uploaded"},reconciledBy:{type:String},reconciledAt:{type:Date},uploadedBy:{type:String,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});gn.index({tenantId:1,bankAccountId:1,statementDate:-1});gn.index({tenantId:1,status:1});Ko=$.model("BankStatement",gn),Nr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},bankStatementId:{type:String,required:!0},bankAccountId:{type:String,required:!0},transactionDate:{type:Date,required:!0},valueDate:{type:Date},description:{type:String,required:!0},reference:{type:String},debit:{type:Number,default:0},credit:{type:Number,default:0},balance:{type:Number,required:!0},transactionType:{type:String},isReconciled:{type:Number,default:0},matchedPaymentId:{type:String},matchedJournalEntryId:{type:String},matchConfidence:{type:Number},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Nr.index({tenantId:1,bankStatementId:1});Nr.index({tenantId:1,bankAccountId:1,transactionDate:-1});Nr.index({tenantId:1,isReconciled:1});Xo=$.model("BankTransaction",Nr),es=c.object({tenantId:c.string(),accountNumber:c.string(),nameAr:c.string(),nameEn:c.string().optional(),accountType:c.enum(["asset","liability","equity","revenue","expense","contra"]),parentAccountId:c.string().optional(),normalBalance:c.enum(["debit","credit"]),currency:c.string().default("SAR"),isActive:c.number().default(1),isSystemAccount:c.number().default(0),isBankAccount:c.number().default(0),bankName:c.string().optional(),bankAccountNumber:c.string().optional(),iban:c.string().optional(),openingBalance:c.number().default(0),branchId:c.string().optional(),costCenterId:c.string().optional(),description:c.string().optional()}),ts=c.object({tenantId:c.string(),entryDate:c.date(),fiscalPeriodId:c.string().optional(),referenceType:c.enum(["order","invoice","expense","adjustment","opening","closing","manual"]).optional(),referenceId:c.string().optional(),description:c.string(),lines:c.array(c.object({accountId:c.string(),accountNumber:c.string(),accountName:c.string(),debit:c.number().default(0),credit:c.number().default(0),description:c.string().optional(),costCenterId:c.string().optional(),branchId:c.string().optional()})),createdBy:c.string()}),rs=c.object({tenantId:c.string(),branchId:c.string(),invoiceDate:c.date(),dueDate:c.date().optional(),invoiceType:c.enum(["sales","purchase","credit_note","debit_note"]).default("sales"),customerId:c.string().optional(),customerName:c.string(),customerPhone:c.string().optional(),customerEmail:c.string().optional(),customerTaxNumber:c.string().optional(),customerAddress:c.string().optional(),vendorId:c.string().optional(),vendorName:c.string().optional(),vendorTaxNumber:c.string().optional(),orderId:c.string().optional(),lines:c.array(c.object({itemId:c.string().optional(),description:c.string(),quantity:c.number(),unitPrice:c.number(),discountAmount:c.number().default(0),discountPercent:c.number().default(0),taxRate:c.number().default(15)})),paymentTerms:c.string().optional(),paymentMethod:c.string().optional(),notes:c.string().optional(),internalNotes:c.string().optional()}),ns=c.object({tenantId:c.string(),branchId:c.string(),expenseDate:c.date(),category:c.enum(["inventory","salaries","rent","utilities","marketing","maintenance","supplies","other"]),subcategory:c.string().optional(),description:c.string(),amount:c.number(),taxAmount:c.number().default(0),paymentMethod:c.enum(["cash","bank_transfer","check","credit_card","other"]).default("cash"),paymentReference:c.string().optional(),vendorId:c.string().optional(),vendorName:c.string().optional(),invoiceNumber:c.string().optional(),invoiceDate:c.date().optional(),accountId:c.string().optional(),costCenterId:c.string().optional(),requestedBy:c.string(),notes:c.string().optional(),isRecurring:c.number().default(0),recurringFrequency:c.enum(["weekly","monthly","quarterly","yearly"]).optional()}),as=c.object({tenantId:c.string(),code:c.string(),nameAr:c.string(),nameEn:c.string().optional(),taxNumber:c.string().optional(),commercialRegistration:c.string().optional(),phone:c.string().optional(),email:c.string().optional(),address:c.string().optional(),city:c.string().optional(),country:c.string().default("SA"),bankName:c.string().optional(),bankAccountNumber:c.string().optional(),iban:c.string().optional(),paymentTerms:c.string().optional(),creditLimit:c.number().default(0),contactPerson:c.string().optional(),contactPhone:c.string().optional(),notes:c.string().optional()}),os=c.object({tenantId:c.string(),branchId:c.string(),paymentDate:c.date(),paymentType:c.enum(["receipt","payment"]),referenceType:c.enum(["invoice","expense","order","advance","refund"]),referenceId:c.string(),customerId:c.string().optional(),vendorId:c.string().optional(),amount:c.number(),paymentMethod:c.enum(["cash","bank_transfer","check","credit_card","pos","wallet","other"]),bankAccountId:c.string().optional(),checkNumber:c.string().optional(),transactionReference:c.string().optional(),description:c.string().optional(),processedBy:c.string()}),Tr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String},providerName:{type:String,enum:["noon_food","hunger_station","keeta","jahez","toyou","mrsool","careem","custom"],required:!0},providerNameAr:{type:String,required:!0},providerLogo:{type:String},apiKey:{type:String},apiSecret:{type:String},merchantId:{type:String},webhookUrl:{type:String},webhookSecret:{type:String},baseUrl:{type:String},isActive:{type:Number,default:0},isTestMode:{type:Number,default:1},autoAcceptOrders:{type:Number,default:0},autoAssignDriver:{type:Number,default:0},commissionPercent:{type:Number,default:0},fixedFee:{type:Number,default:0},settings:{type:q.Types.Mixed},lastSyncAt:{type:Date},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Tr.index({tenantId:1});Tr.index({tenantId:1,providerName:1});Tr.index({tenantId:1,isActive:1});Je=$.model("DeliveryIntegration",Tr),Rr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},nameAr:{type:String,required:!0},nameEn:{type:String},description:{type:String},zoneType:{type:String,enum:["polygon","radius","city","district"],default:"radius"},boundary:[{lat:{type:Number},lng:{type:Number}}],centerLat:{type:Number},centerLng:{type:Number},radiusKm:{type:Number,default:5},city:{type:String},district:{type:String},baseFee:{type:Number,default:10},feePerKm:{type:Number,default:2},minOrderAmount:{type:Number,default:0},maxOrderAmount:{type:Number},freeDeliveryThreshold:{type:Number},estimatedMinMinutes:{type:Number,default:20},estimatedMaxMinutes:{type:Number,default:45},isActive:{type:Number,default:1},priority:{type:Number,default:0},workingHours:[{dayOfWeek:{type:Number},openTime:{type:String},closeTime:{type:String}}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Rr.index({tenantId:1,branchId:1});Rr.index({tenantId:1,isActive:1});Rr.index({branchId:1,isActive:1});Ke=$.model("DeliveryZone",Rr),sr=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String},employeeId:{type:String},fullName:{type:String,required:!0},phone:{type:String,required:!0},email:{type:String},nationalId:{type:String},licenseNumber:{type:String},licenseExpiry:{type:Date},vehicleType:{type:String,enum:["motorcycle","car","bicycle","scooter"],default:"motorcycle"},vehiclePlate:{type:String},vehicleModel:{type:String},vehicleColor:{type:String},photoUrl:{type:String},status:{type:String,enum:["available","busy","offline","on_break"],default:"offline"},currentLat:{type:Number},currentLng:{type:Number},lastLocationUpdate:{type:Date},currentOrderId:{type:String},totalDeliveries:{type:Number,default:0},totalEarnings:{type:Number,default:0},rating:{type:Number,default:5},ratingCount:{type:Number,default:0},isActive:{type:Number,default:1},maxConcurrentOrders:{type:Number,default:3},workingZoneIds:[{type:String}],shiftStart:{type:String},shiftEnd:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});sr.index({tenantId:1});sr.index({tenantId:1,status:1,isActive:1});sr.index({tenantId:1,branchId:1});sr.index({phone:1});Ue=$.model("DeliveryDriver",sr),Ut=new q({id:{type:String,required:!0,unique:!0},tenantId:{type:String,required:!0},branchId:{type:String,required:!0},orderId:{type:String,required:!0},orderNumber:{type:String},deliveryType:{type:String,enum:["internal","external"],default:"internal"},externalProvider:{type:String},externalOrderId:{type:String},driverId:{type:String},driverName:{type:String},driverPhone:{type:String},customerName:{type:String,required:!0},customerPhone:{type:String,required:!0},customerAddress:{type:String,required:!0},customerAddressDetails:{type:String},customerLat:{type:Number,required:!0},customerLng:{type:Number,required:!0},branchLat:{type:Number},branchLng:{type:Number},distanceKm:{type:Number,default:0},deliveryFee:{type:Number,default:0},driverEarnings:{type:Number},status:{type:String,enum:["pending","accepted","assigned","picking_up","on_the_way","arrived","delivered","cancelled","returned"],default:"pending"},estimatedPickupTime:{type:Date},estimatedDeliveryTime:{type:Date},actualPickupTime:{type:Date},actualDeliveryTime:{type:Date},preparationMinutes:{type:Number,default:0},travelMinutes:{type:Number,default:0},totalEstimatedMinutes:{type:Number,default:0},driverCurrentLat:{type:Number},driverCurrentLng:{type:Number},driverLastUpdate:{type:Date},trackingHistory:[{lat:{type:Number},lng:{type:Number},timestamp:{type:Date},status:{type:String}}],notes:{type:String},customerNotes:{type:String},cancellationReason:{type:String},customerRating:{type:Number},customerFeedback:{type:String},proofOfDelivery:{type:String},signatureUrl:{type:String},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});Ut.index({tenantId:1,status:1});Ut.index({tenantId:1,branchId:1,status:1});Ut.index({tenantId:1,driverId:1,status:1});Ut.index({orderId:1});Ut.index({externalOrderId:1});Ge=$.model("DeliveryOrder",Ut),ss=c.object({tenantId:c.string(),branchId:c.string().optional(),providerName:c.enum(["noon_food","hunger_station","keeta","jahez","toyou","mrsool","careem","custom"]),providerNameAr:c.string(),providerLogo:c.string().optional(),apiKey:c.string().optional(),apiSecret:c.string().optional(),merchantId:c.string().optional(),webhookUrl:c.string().optional(),webhookSecret:c.string().optional(),baseUrl:c.string().optional(),isActive:c.number().default(0),isTestMode:c.number().default(1),autoAcceptOrders:c.number().default(0),autoAssignDriver:c.number().default(0),commissionPercent:c.number().default(0),fixedFee:c.number().default(0),settings:c.record(c.any()).optional()}),is=c.object({tenantId:c.string(),branchId:c.string(),nameAr:c.string(),nameEn:c.string().optional(),description:c.string().optional(),zoneType:c.enum(["polygon","radius","city","district"]).default("radius"),boundary:c.array(c.object({lat:c.number(),lng:c.number()})).optional(),centerLat:c.number().optional(),centerLng:c.number().optional(),radiusKm:c.number().default(5),city:c.string().optional(),district:c.string().optional(),baseFee:c.number().default(10),feePerKm:c.number().default(2),minOrderAmount:c.number().default(0),maxOrderAmount:c.number().optional(),freeDeliveryThreshold:c.number().optional(),estimatedMinMinutes:c.number().default(20),estimatedMaxMinutes:c.number().default(45),isActive:c.number().default(1),priority:c.number().default(0)}),cs=c.object({tenantId:c.string(),branchId:c.string().optional(),employeeId:c.string().optional(),fullName:c.string(),phone:c.string(),email:c.string().optional(),nationalId:c.string().optional(),licenseNumber:c.string().optional(),licenseExpiry:c.date().optional(),vehicleType:c.enum(["motorcycle","car","bicycle","scooter"]).default("motorcycle"),vehiclePlate:c.string().optional(),vehicleModel:c.string().optional(),vehicleColor:c.string().optional(),photoUrl:c.string().optional(),maxConcurrentOrders:c.number().default(3),workingZoneIds:c.array(c.string()).optional(),shiftStart:c.string().optional(),shiftEnd:c.string().optional()}),ds=c.object({tenantId:c.string(),branchId:c.string(),orderId:c.string(),orderNumber:c.string().optional(),deliveryType:c.enum(["internal","external"]).default("internal"),externalProvider:c.string().optional(),externalOrderId:c.string().optional(),driverId:c.string().optional(),customerName:c.string(),customerPhone:c.string(),customerAddress:c.string(),customerAddressDetails:c.string().optional(),customerLat:c.number(),customerLng:c.number(),branchLat:c.number().optional(),branchLng:c.number().optional(),distanceKm:c.number().default(0),deliveryFee:c.number().default(0),preparationMinutes:c.number().default(0),travelMinutes:c.number().default(0),notes:c.string().optional(),customerNotes:c.string().optional()})});var et={};Et(et,{checkMailServiceHealth:()=>ws,sendAbandonedCartEmail:()=>Ss,sendLoyaltyPointsEmail:()=>vn,sendOrderNotificationEmail:()=>Fr,sendPointsVerificationEmail:()=>Sn,sendPromotionEmail:()=>An,sendReferralEmail:()=>wn,sendReservationConfirmationEmail:()=>vs,sendReservationExpiryWarningEmail:()=>As,sendWelcomeEmail:()=>_r,testEmailConnection:()=>Dn});import hs from"nodemailer";async function Is(){try{let i={smtpHost:process.env.SMTP_HOST||"pro.eu.turbo-smtp.com",smtpPort:parseInt(process.env.SMTP_PORT||"587"),smtpUser:process.env.SMTP_USER,smtpPass:process.env.SMTP_PASS,smtpApiKey:process.env.SMTP2GO_API_KEY},a=process.env.NODE_ENV==="production";return console.log(`\u{1F4E7} Mail service initializing [${a?"PRODUCTION":"DEVELOPMENT"}]:`),console.log("   SMTP_HOST:",i.smtpHost?`\u2705 ${i.smtpHost}`:"\u274C"),console.log("   SMTP_PORT:",i.smtpPort),console.log("   SMTP_USER:",i.smtpUser?"\u2705":"\u274C"),console.log("   SMTP_PASS:",i.smtpPass?"\u2705":"\u274C"),i}catch(i){return console.error("Error loading SMTP secrets:",i),{smtpHost:"pro.eu.turbo-smtp.com",smtpPort:587,smtpUser:void 0,smtpPass:void 0}}}async function Xe(){if($r)return kr;let{smtpHost:i,smtpPort:a,smtpUser:s,smtpPass:u}=await Is();if(!s||!u)return console.warn("\u26A0\uFE0F SMTP credentials not configured. Email service disabled."),console.warn("   Required environment variables: SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_PORT"),$r=!0,null;try{console.log(`\u{1F4E7} Creating SMTP transporter for ${i}:${a}`),kr=hs.createTransport({host:i,port:a,secure:a===465,auth:{user:s,pass:u},tls:{rejectUnauthorized:!1,minVersion:"TLSv1.2"},connectionTimeout:15e3,greetingTimeout:15e3,socketTimeout:3e4,pool:!0,maxConnections:3,maxMessages:100}),$r=!0,console.log("\u2705 SMTP transporter created (verification on first use)"),kr.verify().then(()=>{console.log("\u2705 SMTP connection verified")}).catch(p=>{console.warn("\u26A0\uFE0F SMTP verification failed:",p.message),console.log("   Will retry on next email send...")})}catch(p){return console.error("\u274C Error creating SMTP transporter:",p.message),$r=!0,null}return kr}async function ws(){try{let i=await Xe();return i?(await i.verify(),{healthy:!0,message:"SMTP connection verified"}):{healthy:!1,message:"SMTP credentials not configured"}}catch(i){return{healthy:!1,message:`SMTP error: ${i.message}`}}}async function Fr(i,a,s,u,p,y){try{let h=await Xe();if(!h)return console.warn("\u26A0\uFE0F Email service not available for order notification."),!1;let v=process.env.SMTP_FROM||"noreply@cluny.cafe",D=u==="completed"?"\u0645\u0643\u062A\u0645\u0644":u==="preparing"||u==="in_progress"?"\u0642\u064A\u062F \u0627\u0644\u062A\u062D\u0636\u064A\u0631":u==="ready"?"\u062C\u0627\u0647\u0632":u==="cancelled"?"\u0645\u0644\u063A\u064A":"\u0642\u064A\u062F \u0627\u0644\u0645\u0639\u0627\u0644\u062C\u0629",O=u==="completed"?"#4CAF50":u==="ready"?"#2196F3":u==="in_progress"||u==="preparing"?"#FF9800":u==="cancelled"?"#f44336":"#9C27B0",M=u==="completed"?"\u2705":u==="ready"?"\u{1F3AF}":u==="in_progress"||u==="preparing"?"\u{1F468}\u200D\u{1F373}":u==="cancelled"?"\u274C":"\u23F3",B={from:v,to:i,subject:`\u062A\u062D\u062F\u064A\u062B \u0637\u0644\u0628\u0643 - ${s}`,headers:{"X-Priority":"3","X-MSMail-Priority":"Normal",Importance:"Normal","X-Mailer":"CLUNY CAFE","List-Unsubscribe":"<mailto:noreply@cluny.cafe>","X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},text:`\u0645\u0631\u062D\u0628\u0627\u064B ${a}
      
\u062A\u0645 \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0637\u0644\u0628\u0643.

\u0631\u0642\u0645 \u0627\u0644\u0637\u0644\u0628: ${s}
\u0627\u0644\u062D\u0627\u0644\u0629: ${D}
\u0627\u0644\u0645\u0628\u0644\u063A: ${p} \u0631\u064A\u0627\u0644

${u==="completed"?"\u0634\u0643\u0631\u0627\u064B \u0644\u0643! \u0637\u0644\u0628\u0643 \u062C\u0627\u0647\u0632 \u0644\u0644\u0627\u0633\u062A\u0644\u0627\u0645 \u0627\u0644\u0622\u0646.":u==="ready"?"\u0637\u0644\u0628\u0643 \u062C\u0627\u0647\u0632! \u062A\u0641\u0636\u0644 \u0644\u0644\u0627\u0633\u062A\u0644\u0627\u0645 \u0645\u0646 \u0627\u0644\u0641\u0631\u0639.":u==="in_progress"||u==="preparing"?"\u0641\u0631\u064A\u0642\u0646\u0627 \u064A\u062D\u0636\u0631 \u0637\u0644\u0628\u0643 \u0627\u0644\u0622\u0646.":u==="cancelled"?"\u062A\u0645 \u0625\u0644\u063A\u0627\u0621 \u0637\u0644\u0628\u0643.":"\u062C\u0627\u0631\u064A \u0645\u0639\u0627\u0644\u062C\u0629 \u0637\u0644\u0628\u0643."}

CLUNY CAFE
\u062A\u062C\u0631\u0628\u0629 \u0627\u0644\u0642\u0647\u0648\u0629 \u0627\u0644\u0641\u0627\u062E\u0631\u0629`,html:`
        <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <style type="text/css">
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
            .wrapper { background: #f5f5f5; padding: 20px; }
            .container { max-width: 500px; margin: 0 auto; background: #ffffff; padding: 30px; }
            .header { text-align: center; border-bottom: 2px solid #8B5A2B; padding-bottom: 20px; margin-bottom: 20px; }
            .header h1 { color: #8B5A2B; font-size: 28px; margin: 10px 0; }
            .tagline { color: #666; font-size: 13px; }
            .content { margin: 20px 0; }
            .greeting { font-size: 16px; color: #333; margin-bottom: 20px; }
            .status { background: ${O}; color: white; padding: 20px; text-align: center; margin: 20px 0; border-radius: 5px; }
            .status-value { font-size: 24px; font-weight: bold; }
            .details { background: #f9f9f9; padding: 15px; margin: 20px 0; border-right: 3px solid #8B5A2B; }
            .detail-row { padding: 8px 0; }
            .detail-label { color: #888; font-size: 12px; font-weight: bold; }
            .detail-value { color: #333; font-size: 16px; font-weight: bold; }
            .message { background: #faf5f0; padding: 15px; margin: 20px 0; border-radius: 5px; color: #5c3d2e; font-size: 14px; line-height: 1.5; }
            .footer { border-top: 1px solid #e0e0e0; padding-top: 15px; font-size: 12px; color: #888; text-align: center; margin-top: 20px; }
          </style>
        </head>
        <body>
          <div class="wrapper">
            <div class="container">
              <div class="header">
                <h1>CLUNY CAFE</h1>
                <p class="tagline">\u062A\u062C\u0631\u0628\u0629 \u0627\u0644\u0642\u0647\u0648\u0629 \u0627\u0644\u0641\u0627\u062E\u0631\u0629</p>
              </div>
              
              <div class="content">
                <div class="greeting">\u0645\u0631\u062D\u0628\u0627\u064B ${a}!</div>
                
                <div class="status">
                  <div style="font-size: 12px; margin-bottom: 10px;">\u062D\u0627\u0644\u0629 \u0627\u0644\u0637\u0644\u0628</div>
                  <div class="status-value">${D}</div>
                </div>
                
                <div class="details">
                  <div class="detail-row">
                    <div class="detail-label">\u0631\u0642\u0645 \u0627\u0644\u0637\u0644\u0628</div>
                    <div class="detail-value">${s}</div>
                  </div>
                  <div class="detail-row" style="margin-top: 10px;">
                    <div class="detail-label">\u0627\u0644\u0645\u0628\u0644\u063A \u0627\u0644\u0625\u062C\u0645\u0627\u0644\u064A</div>
                    <div class="detail-value">${p} \u0631\u064A\u0627\u0644</div>
                  </div>
                </div>
                
                <div class="message">
                  ${u==="completed"?"\u0634\u0643\u0631\u0627\u064B \u0644\u0643! \u0637\u0644\u0628\u0643 \u062C\u0627\u0647\u0632 \u0644\u0644\u0627\u0633\u062A\u0644\u0627\u0645 \u0627\u0644\u0622\u0646. \u0646\u062A\u0645\u0646\u0649 \u0623\u0646 \u062A\u0633\u062A\u0645\u062A\u0639 \u0628\u0642\u0647\u0648\u062A\u0643!":u==="ready"?"\u062A\u0645\u0627\u0645! \u0637\u0644\u0628\u0643 \u0623\u0635\u0628\u062D \u062C\u0627\u0647\u0632\u0627\u064B. \u062A\u0641\u0636\u0644 \u0644\u0644\u0627\u0633\u062A\u0644\u0627\u0645 \u0645\u0646 \u0627\u0644\u0641\u0631\u0639.":u==="in_progress"||u==="preparing"?"\u0642\u064A\u062F \u0627\u0644\u0625\u0639\u062F\u0627\u062F - \u0641\u0631\u064A\u0642\u0646\u0627 \u064A\u062D\u0636\u0631 \u0637\u0644\u0628\u0643 \u0627\u0644\u0622\u0646 \u0628\u0639\u0646\u0627\u064A\u0629.":u==="cancelled"?"\u062A\u0645 \u0625\u0644\u063A\u0627\u0621 \u0637\u0644\u0628\u0643. \u0625\u0630\u0627 \u0643\u0627\u0646 \u0644\u062F\u064A\u0643 \u0623\u064A \u0627\u0633\u062A\u0641\u0633\u0627\u0631\u060C \u062A\u0648\u0627\u0635\u0644 \u0645\u0639\u0646\u0627.":"\u0642\u064A\u062F \u0627\u0644\u0645\u0639\u0627\u0644\u062C\u0629 - \u0633\u064A\u062A\u0645 \u062A\u062D\u062F\u064A\u062B\u0643 \u0642\u0631\u064A\u0628\u0627\u064B."}
                </div>
              </div>
              
              <div class="footer">
                <p>\xA9 2025 CLUNY CAFE - \u062C\u0645\u064A\u0639 \u0627\u0644\u062D\u0642\u0648\u0642 \u0645\u062D\u0641\u0648\u0638\u0629</p>
                <p>\u0647\u0630\u0627 \u0627\u0644\u0628\u0631\u064A\u062F \u0645\u0631\u0633\u0644 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B. \u064A\u0631\u062C\u0649 \u0639\u062F\u0645 \u0627\u0644\u0631\u062F.</p>
              </div>
            </div>
          </div>
        </body>
        </html>
      `},F=await h.sendMail(B);return console.log(`\u2705 [TURBOSMTP] Mail sent successfully to ${i}. MessageID: ${F.messageId}`),!0}catch(h){return console.error("\u274C [TURBOSMTP] Detailed Send Error:",h),!1}}async function wn(i,a,s){let u=await Xe();if(!u)return console.log("\u{1F4E7} Email service not configured. Skipping email."),!1;try{return await u.sendMail({from:`"CLUNY CAFE" <${process.env.SMTP_FROM||"noreply@cluny.cafe"}>`,to:i,subject:"\u0627\u0646\u0636\u0645 \u0625\u0644\u0649 \u0628\u0631\u0646\u0627\u0645\u062C \u0627\u0644\u0625\u062D\u0627\u0644\u0627\u062A \u0627\u0644\u062E\u0627\u0635 \u0628\u0646\u0627",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl;">
          <h2>\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p>\u0634\u0627\u0631\u0643 \u0631\u0645\u0632 \u0627\u0644\u0625\u062D\u0627\u0644\u0629 \u0627\u0644\u062E\u0627\u0635 \u0628\u0643 \u0648\u0627\u062D\u0635\u0644 \u0639\u0644\u0649 \u0646\u0642\u0627\u0637!</p>
          <div style="background-color: #4CAF50; color: white; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: center;">
            <p style="font-size: 24px; font-weight: bold; margin: 0;">${s}</p>
          </div>
          <p>\u0627\u062D\u0635\u0644 \u0639\u0644\u0649 <strong>50 \u0646\u0642\u0637\u0629</strong> \u0644\u0643\u0644 \u0635\u062F\u064A\u0642 \u062A\u062D\u064A\u0644\u0647 \u0628\u0646\u062C\u0627\u062D!</p>
          <p>\u0627\u0633\u062A\u062E\u062F\u0645 \u0627\u0644\u0646\u0642\u0627\u0637 \u0644\u0644\u062D\u0635\u0648\u0644 \u0639\u0644\u0649 \u062E\u0635\u0648\u0645\u0627\u062A \u0648\u0639\u0631\u0648\u0636 \u062D\u0635\u0631\u064A\u0629.</p>
        </div>
      `}),console.log(`\u2705 Referral email sent to ${i}`),!0}catch(p){return console.error("\u274C Failed to send referral email:",p),!1}}async function vn(i,a,s,u){let p=await Xe();if(!p)return console.log("\u{1F4E7} Email service not configured. Skipping email."),!1;try{return await p.sendMail({from:`"CLUNY CAFE" <${process.env.SMTP_FROM||"noreply@cluny.cafe"}>`,to:i,subject:"\u0644\u0642\u062F \u062D\u0635\u0644\u062A \u0639\u0644\u0649 \u0646\u0642\u0627\u0637 \u062C\u062F\u064A\u062F\u0629!",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl;">
          <h2>\u0645\u0628\u0631\u0648\u0643 ${a}!</h2>
          <p>\u0644\u0642\u062F \u062D\u0635\u0644\u062A \u0639\u0644\u0649 \u0646\u0642\u0627\u0637 \u062C\u062F\u064A\u062F\u0629 \u0641\u064A \u062D\u0633\u0627\u0628\u0643!</p>
          <div style="background-color: #FFD700; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <p style="font-size: 18px;"><strong>\u0627\u0644\u0646\u0642\u0627\u0637 \u0627\u0644\u0645\u0643\u062A\u0633\u0628\u0629:</strong> +${s}</p>
            <p style="font-size: 18px;"><strong>\u0625\u062C\u0645\u0627\u0644\u064A \u0627\u0644\u0646\u0642\u0627\u0637:</strong> ${u}</p>
          </div>
          <p>\u0627\u0633\u062A\u062E\u062F\u0645 \u0646\u0642\u0627\u0637\u0643 \u0644\u0644\u062D\u0635\u0648\u0644 \u0639\u0644\u0649 \u062E\u0635\u0648\u0645\u0627\u062A \u0631\u0627\u0626\u0639\u0629!</p>
        </div>
      `}),console.log(`\u2705 Loyalty email sent to ${i}`),!0}catch(y){return console.error("\u274C Failed to send loyalty email:",y),!1}}async function An(i,a,s,u,p){let y=await Xe();if(!y)return!1;try{let v={from:process.env.SMTP_FROM||"noreply@cluny.cafe",to:i,subject:s,html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
          <h2 style="color: #8B5A2B;">\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p>${u}</p>
          ${p?`
            <div style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; text-align: center; margin: 20px 0;">
              <p>\u0627\u0633\u062A\u062E\u062F\u0645 \u0631\u0645\u0632 \u0627\u0644\u062E\u0635\u0645 \u0647\u0630\u0627:</p>
              <p style="font-size: 24px; font-weight: bold; color: #8B5A2B; margin: 0;">${p}</p>
            </div>
          `:""}
          <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; font-size: 12px; color: #888;">
            \u062A\u0645 \u0627\u0644\u0625\u0631\u0633\u0627\u0644 \u0628\u0648\u0627\u0633\u0637\u0629 \u0646\u0638\u0627\u0645 CLUNY CAFE
          </div>
        </div>
      `,headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})}};return await y.sendMail(v),!0}catch(h){return console.error("\u274C Failed to send promotion email:",h),!1}}async function vs(i,a,s,u,p,y,h){let v=await Xe();if(!v)return console.log("\u{1F4E7} Email service not configured. Skipping email."),!1;try{let D=process.env.SMTP_FROM||"noreply@cluny.cafe",O=new Date(u).toLocaleDateString("ar");return await v.sendMail({from:D,to:i,subject:`\u062A\u0623\u0643\u064A\u062F \u062D\u062C\u0632\u0643 - \u0637\u0627\u0648\u0644\u0629 ${s}`,headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px; border: 1px solid #eee; border-radius: 10px;">
          <h2 style="color: #8B5A2B;">\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p>\u062A\u0645 \u062A\u0623\u0643\u064A\u062F \u062D\u062C\u0632\u0643 \u0641\u064A CLUNY CAFE!</p>
          
          <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; border-right: 5px solid #8B5A2B;">
            <p><strong>\u0631\u0642\u0645 \u0627\u0644\u0637\u0627\u0648\u0644\u0629:</strong> ${s}</p>
            <p><strong>\u0627\u0644\u062A\u0627\u0631\u064A\u062E:</strong> ${O}</p>
            <p><strong>\u0627\u0644\u0648\u0642\u062A:</strong> ${p}</p>
            <p><strong>\u0639\u062F\u062F \u0627\u0644\u0636\u064A\u0648\u0641:</strong> ${y}</p>
            <p style="color: #FF6B6B;"><strong>\u064A\u0646\u062A\u0647\u064A \u0627\u0644\u062D\u062C\u0632 \u0641\u064A:</strong> ${new Date(h).toLocaleTimeString("ar",{hour:"2-digit",minute:"2-digit"})}</p>
          </div>

          <p style="color: #666; font-size: 14px;">
            <strong>\u0645\u0644\u0627\u062D\u0638\u0629 \u0645\u0647\u0645\u0629:</strong> \u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u062D\u062C\u0648\u0632\u0629 \u0644\u0645\u062F\u0629 \u0633\u0627\u0639\u0629 \u0648\u0627\u062D\u062F\u0629. \u0625\u0630\u0627 \u0643\u0646\u062A \u0628\u062D\u0627\u062C\u0629 \u0625\u0644\u0649 \u0627\u0644\u0645\u0632\u064A\u062F \u0645\u0646 \u0627\u0644\u0648\u0642\u062A\u060C \u064A\u0645\u0643\u0646\u0643 \u062A\u0645\u062F\u064A\u062F \u0627\u0644\u062D\u062C\u0632 \u0645\u0631\u0629 \u0648\u0627\u062D\u062F\u0629 \u0645\u0646 \u062A\u0637\u0628\u064A\u0642\u0646\u0627.
          </p>

          <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
          <p style="font-size: 12px; color: #999;">\u0634\u0643\u0631\u0627\u064B \u0644\u0627\u062E\u062A\u064A\u0627\u0631\u0643 CLUNY CAFE!</p>
        </div>
      `}),console.log(`\u2705 Reservation confirmation email sent to ${i}`),!0}catch(D){return console.error("\u274C Failed to send reservation email:",D),!1}}async function As(i,a,s,u){let p=await Xe();if(!p)return!1;try{let y=process.env.SMTP_FROM||"noreply@cluny.cafe",h=new Date(u).toLocaleTimeString("ar",{hour:"2-digit",minute:"2-digit"});return await p.sendMail({from:y,to:i,subject:"\u23F0 \u062A\u0630\u0643\u064A\u0631: \u062D\u062C\u0632\u0643 \u0633\u064A\u0646\u062A\u0647\u064A \u0628\u0639\u062F 15 \u062F\u0642\u064A\u0642\u0629",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px; border: 2px solid #FF6B6B; border-radius: 10px;">
          <h2 style="color: #FF6B6B;">\u062A\u0646\u0628\u064A\u0647!</h2>
          <p>\u0645\u0631\u062D\u0628\u0627\u064B ${a}</p>
          
          <div style="background-color: #FFE5E5; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p><strong>\u062D\u062C\u0632\u0643 \u0641\u064A \u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0631\u0642\u0645 ${s}</strong> \u0633\u064A\u0646\u062A\u0647\u064A \u0641\u064A:</p>
            <p style="font-size: 24px; color: #FF6B6B; font-weight: bold; margin: 10px 0;">${h}</p>
          </div>

          <p style="color: #333;">\u0625\u0630\u0627 \u0643\u0646\u062A \u0628\u062D\u0627\u062C\u0629 \u0625\u0644\u0649 \u0627\u0644\u0645\u0632\u064A\u062F \u0645\u0646 \u0627\u0644\u0648\u0642\u062A\u060C \u064A\u0645\u0643\u0646\u0643 <strong>\u062A\u0645\u062F\u064A\u062F \u0627\u0644\u062D\u062C\u0632 \u0644\u0633\u0627\u0639\u0629 \u0625\u0636\u0627\u0641\u064A\u0629</strong> \u0645\u0646 \u0627\u0644\u062A\u0637\u0628\u064A\u0642 \u0627\u0644\u0622\u0646!</p>

          <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
          <p style="font-size: 12px; color: #999;">\u0647\u0630\u0627 \u0627\u0644\u0628\u0631\u064A\u062F \u0645\u0631\u0633\u0644 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B\u060C \u064A\u0631\u062C\u0649 \u0639\u062F\u0645 \u0627\u0644\u0631\u062F.</p>
        </div>
      `}),console.log(`\u2705 Reservation expiry warning email sent to ${i}`),!0}catch(y){return console.error("\u274C Failed to send expiry warning email:",y),!1}}async function _r(i,a){let s=await Xe();if(!s)return!1;try{return await s.sendMail({from:`"CLUNY CAFE" <${process.env.SMTP_FROM||"noreply@cluny.cafe"}>`,to:i,subject:"\u0623\u0647\u0644\u0627\u064B \u0628\u0643 \u0641\u064A CLUNY CAFE! \u2615",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
          <h2 style="color: #8B5A2B;">\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p>\u064A\u0633\u0639\u062F\u0646\u0627 \u0627\u0646\u0636\u0645\u0627\u0645\u0643 \u0625\u0644\u064A\u0646\u0627 \u0641\u064A \u0639\u0627\u0626\u0644\u0629 CLUNY CAFE.</p>
          <p>\u064A\u0645\u0643\u0646\u0643 \u0627\u0644\u0622\u0646 \u0627\u0644\u0628\u062F\u0621 \u0641\u064A \u0637\u0644\u0628 \u0642\u0647\u0648\u062A\u0643 \u0627\u0644\u0645\u0641\u0636\u0644\u0629 \u0648\u062C\u0645\u0639 \u0627\u0644\u0646\u0642\u0627\u0637 \u0645\u0639 \u0643\u0644 \u0637\u0644\u0628!</p>
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
             <p>\u0627\u0633\u062A\u062E\u062F\u0645 \u062A\u0637\u0628\u064A\u0642\u0646\u0627 \u0644\u062A\u062C\u0631\u0628\u0629 \u0623\u0633\u0631\u0639 \u0648\u0623\u0633\u0647\u0644.</p>
          </div>
          <p>\u0646\u062A\u0637\u0644\u0639 \u0644\u062E\u062F\u0645\u062A\u0643 \u0642\u0631\u064A\u0628\u0627\u064B!</p>
        </div>
      `}),!0}catch(u){return console.error("\u274C Failed to send welcome email:",u),!1}}async function Ss(i,a){let s=await Xe();if(!s)return!1;try{return await s.sendMail({from:`"CLUNY CAFE" <${process.env.SMTP_FROM||"noreply@cluny.cafe"}>`,to:i,subject:"\u0646\u0633\u064A\u062A \u0634\u064A\u0626\u0627\u064B \u0641\u064A \u0639\u0631\u0628\u062A\u0643\u061F \u{1F6D2}",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
          <h2 style="color: #8B5A2B;">\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p>\u0644\u0627\u062D\u0638\u0646\u0627 \u0623\u0646\u0643 \u062A\u0631\u0643\u062A \u0628\u0639\u0636 \u0627\u0644\u0623\u0635\u0646\u0627\u0641 \u0627\u0644\u0631\u0627\u0626\u0639\u0629 \u0641\u064A \u0639\u0631\u0628\u0629 \u0627\u0644\u062A\u0633\u0648\u0642 \u0627\u0644\u062E\u0627\u0635\u0629 \u0628\u0643.</p>
          <p>\u0644\u0627 \u062A\u062F\u0639 \u0642\u0647\u0648\u062A\u0643 \u062A\u0628\u0631\u062F! \u0639\u062F \u0627\u0644\u0622\u0646 \u0648\u0623\u0643\u0645\u0644 \u0637\u0644\u0628\u0643 \u0642\u0628\u0644 \u0646\u0641\u0627\u062F \u0627\u0644\u0643\u0645\u064A\u0629.</p>
          <div style="margin: 20px 0;">
            <a href="https://cluny.ma3k.online/checkout" style="background-color: #8B5A2B; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">\u0623\u0643\u0645\u0644 \u0627\u0644\u0637\u0644\u0628 \u0627\u0644\u0622\u0646</a>
          </div>
        </div>
      `}),!0}catch(u){return console.error("\u274C Failed to send abandoned cart email:",u),!1}}async function Sn(i,a,s,u,p){let y=await Xe();if(!y)return console.log("[POINTS-VERIFY] Email service not configured. Code:",s),!1;try{return await y.sendMail({from:`"CLUNY CAFE" <${process.env.SMTP_FROM||"noreply@cluny.cafe"}>`,to:i,subject:"\u0631\u0645\u0632 \u062A\u0623\u0643\u064A\u062F \u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0627\u0644\u0646\u0642\u0627\u0637 - CLUNY CAFE",headers:{"X-SMTPAPI":JSON.stringify({api_key:process.env.SMTP2GO_API_KEY})},html:`
        <div style="font-family: Arial, sans-serif; direction: rtl; max-width: 500px; margin: 0 auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: #2D9B6E; margin: 0;">CLUNY CAFE</h1>
          </div>
          <h2 style="color: #333;">\u0645\u0631\u062D\u0628\u0627\u064B ${a}</h2>
          <p style="color: #555; font-size: 16px;">\u062A\u0645 \u0637\u0644\u0628 \u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0646\u0642\u0627\u0637\u0643 \u0644\u062E\u0635\u0645 \u0645\u0646 \u0637\u0644\u0628. \u064A\u0631\u062C\u0649 \u0645\u0634\u0627\u0631\u0643\u0629 \u0627\u0644\u0631\u0645\u0632 \u0627\u0644\u062A\u0627\u0644\u064A \u0645\u0639 \u0627\u0644\u0645\u0648\u0638\u0641:</p>
          <div style="background: linear-gradient(135deg, #2D9B6E, #1a7a50); padding: 25px; border-radius: 12px; margin: 20px 0; text-align: center;">
            <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 14px;">\u0631\u0645\u0632 \u0627\u0644\u062A\u0623\u0643\u064A\u062F</p>
            <p style="color: #fff; font-size: 36px; font-weight: bold; letter-spacing: 12px; margin: 0;">${s}</p>
          </div>
          <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="margin: 5px 0; color: #333;"><strong>\u0627\u0644\u0646\u0642\u0627\u0637 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645\u0629:</strong> ${u} \u0646\u0642\u0637\u0629</p>
            <p style="margin: 5px 0; color: #333;"><strong>\u0642\u064A\u0645\u0629 \u0627\u0644\u062E\u0635\u0645:</strong> ${p.toFixed(2)} \u0631\u064A\u0627\u0644</p>
          </div>
          <p style="color: #999; font-size: 12px; margin-top: 20px;">\u0647\u0630\u0627 \u0627\u0644\u0631\u0645\u0632 \u0635\u0627\u0644\u062D \u0644\u0645\u062F\u0629 10 \u062F\u0642\u0627\u0626\u0642 \u0641\u0642\u0637. \u0644\u0627 \u062A\u0634\u0627\u0631\u0643\u0647 \u0625\u0644\u0627 \u0645\u0639 \u0645\u0648\u0638\u0641 \u0643\u0644\u0648\u0646\u064A.</p>
          <p style="color: #999; font-size: 12px;">\u0625\u0630\u0627 \u0644\u0645 \u062A\u0637\u0644\u0628 \u0647\u0630\u0627 \u0627\u0644\u0631\u0645\u0632\u060C \u064A\u0631\u062C\u0649 \u062A\u062C\u0627\u0647\u0644 \u0647\u0630\u0647 \u0627\u0644\u0631\u0633\u0627\u0644\u0629.</p>
        </div>
      `}),console.log(`[POINTS-VERIFY] Verification email sent to ${i}`),!0}catch(h){return console.error("[POINTS-VERIFY] Failed to send verification email:",h),!1}}async function Dn(){let i=await Xe();if(!i)return console.log("\u26A0\uFE0F Email service not configured"),!1;try{return await i.verify(),console.log("\u2705 Email service connected successfully"),!0}catch(a){return console.error("\u274C Email service connection failed:",a),!1}}var kr,$r,He=Ot(()=>{"use strict";kr=null,$r=!1;setInterval(async()=>{try{let{CartItemModel:i,CustomerModel:a}=await Promise.resolve().then(()=>(T(),R)),s=new Date(Date.now()-60*60*1e3),u=new Date(Date.now()-2*60*60*1e3),p=await i.find({createdAt:{$gte:u,$lte:s}}).distinct("sessionId");p.length>0&&console.log(`\u{1F50D} Found ${p.length} potentially abandoned carts`)}catch(i){console.error("Abandoned Cart Check Error:",i)}},30*60*1e3)});var Lr={};Et(Lr,{appendOrderToSheet:()=>Ds});async function Ds(i,a="ORDER_NOTIFICATION"){return console.log(`\u2139\uFE0F [TURBOSMTP] Notification received for order ${i.orderNumber}. Google Sheets integration is disabled.`),Promise.resolve()}var Ur=Ot(()=>{"use strict"});var zr={};Et(zr,{calculateItemTax:()=>ta,createZATCAInvoice:()=>Os,formatDateISO:()=>aa,generateInvoiceHash:()=>na,generateInvoiceNumber:()=>ea,generateTLV:()=>xt,generateUUID:()=>Xn,generateZATCAQRCode:()=>ra,generateZATCAXML:()=>sa,getInvoiceByOrderId:()=>Es,getInvoiceStats:()=>Bs,getInvoicesByBranch:()=>Ms,getPaymentMeansCode:()=>oa});import Jn from"crypto";function Xn(){return Jn.randomUUID()}function ea(i){let a=new Date,s=a.getFullYear(),u=String(a.getMonth()+1).padStart(2,"0"),p=String(a.getDate()).padStart(2,"0"),y=String(i).padStart(6,"0");return`INV-${s}${u}${p}-${y}`}function ta(i){let a=i.taxRate??Kn,s=i.discountAmount??0,p=i.unitPrice*i.quantity-s,y=p*a,h=p+y;return{taxableAmount:Math.round(p*100)/100,taxAmount:Math.round(y*100)/100,totalAmount:Math.round(h*100)/100}}function xt(i,a){let s=Buffer.from(a,"utf8"),u=Buffer.alloc(2+s.length);return u[0]=i,u[1]=s.length,s.copy(u,2),u}function ra(i){let a=[xt(1,i.sellerName),xt(2,i.vatNumber),xt(3,i.timestamp),xt(4,i.totalWithVat),xt(5,i.vatAmount)];return i.invoiceHash&&a.push(xt(6,i.invoiceHash)),Buffer.concat(a).toString("base64")}function na(i,a){let s=a?`${a}${i}`:i;return Jn.createHash("sha256").update(s).digest("base64")}function aa(i){return i.toISOString()}function oa(i){return{cash:"10",pos:"30",stc:"30",alinma:"30",ur:"30",barq:"30",rajhi:"30",delivery:"10","qahwa-card":"48"}[i]||"30"}function sa(i){let a=new Date(i.invoiceDate),s=a.toISOString().split("T")[0],u=a.toISOString().split("T")[1].split(".")[0],p=i.items.map((y,h)=>{let v=y.taxableAmount||0,D=y.taxAmount||0,O=y.totalAmount||0,M=y.taxRate||.15,B=y.unitPrice||0,F=y.discountAmount||0,z=y.quantity||1;return`
    <cac:InvoiceLine>
      <cbc:ID>${h+1}</cbc:ID>
      <cbc:InvoicedQuantity unitCode="PCE">${z}</cbc:InvoicedQuantity>
      <cbc:LineExtensionAmount currencyID="SAR">${v.toFixed(2)}</cbc:LineExtensionAmount>
      <cac:TaxTotal>
        <cbc:TaxAmount currencyID="SAR">${D.toFixed(2)}</cbc:TaxAmount>
      </cac:TaxTotal>
      <cac:Item>
        <cbc:Name>${y.nameAr||"\u0645\u0646\u062A\u062C"}</cbc:Name>
        <cac:ClassifiedTaxCategory>
          <cbc:ID>S</cbc:ID>
          <cbc:Percent>${(M*100).toFixed(2)}</cbc:Percent>
          <cac:TaxScheme>
            <cbc:ID>VAT</cbc:ID>
          </cac:TaxScheme>
        </cac:ClassifiedTaxCategory>
      </cac:Item>
      <cac:Price>
        <cbc:PriceAmount currencyID="SAR">${B.toFixed(2)}</cbc:PriceAmount>${F>0?`
        <cac:AllowanceCharge>
          <cbc:ChargeIndicator>false</cbc:ChargeIndicator>
          <cbc:AllowanceChargeReason>Discount</cbc:AllowanceChargeReason>
          <cbc:Amount currencyID="SAR">${F.toFixed(2)}</cbc:Amount>
        </cac:AllowanceCharge>`:""}
      </cac:Price>
    </cac:InvoiceLine>`}).join("");return`<?xml version="1.0" encoding="UTF-8"?>
<Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
         xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
         xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
         xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">
  <cbc:ProfileID>reporting:1.0</cbc:ProfileID>
  <cbc:ID>${i.invoiceNumber}</cbc:ID>
  <cbc:UUID>${i.uuid}</cbc:UUID>
  <cbc:IssueDate>${s}</cbc:IssueDate>
  <cbc:IssueTime>${u}</cbc:IssueTime>
  <cbc:InvoiceTypeCode name="${i.transactionType==="B2B"?"0100000":"0200000"}">${i.invoiceTypeCode}</cbc:InvoiceTypeCode>
  <cbc:DocumentCurrencyCode>SAR</cbc:DocumentCurrencyCode>
  <cbc:TaxCurrencyCode>SAR</cbc:TaxCurrencyCode>
  <cac:InvoiceDocumentReference>
    <cbc:ID>${i.invoiceCounter}</cbc:ID>
  </cac:InvoiceDocumentReference>
  <cac:AdditionalDocumentReference>
    <cbc:ID>ICV</cbc:ID>
    <cbc:UUID>${i.invoiceCounter}</cbc:UUID>
  </cac:AdditionalDocumentReference>
  <cac:AdditionalDocumentReference>
    <cbc:ID>PIH</cbc:ID>
    <cac:Attachment>
      <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain">${i.previousInvoiceHash||""}</cbc:EmbeddedDocumentBinaryObject>
    </cac:Attachment>
  </cac:AdditionalDocumentReference>
  <cac:AdditionalDocumentReference>
    <cbc:ID>QR</cbc:ID>
    <cac:Attachment>
      <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain">${i.qrCode}</cbc:EmbeddedDocumentBinaryObject>
    </cac:Attachment>
  </cac:AdditionalDocumentReference>
  <cac:AccountingSupplierParty>
    <cac:Party>
      <cac:PartyIdentification>
        <cbc:ID schemeID="CRN">${i.sellerCrNumber||""}</cbc:ID>
      </cac:PartyIdentification>
      <cac:PostalAddress>
        <cbc:StreetName>${i.sellerAddress}</cbc:StreetName>
        <cbc:BuildingNumber>${i.sellerBuildingNumber||""}</cbc:BuildingNumber>
        <cbc:CityName>${i.sellerCity||"\u0627\u0644\u0631\u064A\u0627\u0636"}</cbc:CityName>
        <cbc:PostalZone>${i.sellerPostalCode||""}</cbc:PostalZone>
        <cbc:CountrySubentity>${i.sellerDistrict||""}</cbc:CountrySubentity>
        <cac:Country>
          <cbc:IdentificationCode>${i.sellerCountry}</cbc:IdentificationCode>
        </cac:Country>
      </cac:PostalAddress>
      <cac:PartyTaxScheme>
        <cbc:CompanyID>${i.sellerVatNumber}</cbc:CompanyID>
        <cac:TaxScheme>
          <cbc:ID>VAT</cbc:ID>
        </cac:TaxScheme>
      </cac:PartyTaxScheme>
      <cac:PartyLegalEntity>
        <cbc:RegistrationName>${i.sellerName}</cbc:RegistrationName>
      </cac:PartyLegalEntity>
    </cac:Party>
  </cac:AccountingSupplierParty>
  <cac:AccountingCustomerParty>
    <cac:Party>
      ${i.customerVatNumber?`
      <cac:PartyIdentification>
        <cbc:ID schemeID="VAT">${i.customerVatNumber}</cbc:ID>
      </cac:PartyIdentification>`:""}
      <cac:PostalAddress>
        <cbc:StreetName>${i.customerAddress||""}</cbc:StreetName>
        <cac:Country>
          <cbc:IdentificationCode>SA</cbc:IdentificationCode>
        </cac:Country>
      </cac:PostalAddress>
      ${i.customerVatNumber?`
      <cac:PartyTaxScheme>
        <cbc:CompanyID>${i.customerVatNumber}</cbc:CompanyID>
        <cac:TaxScheme>
          <cbc:ID>VAT</cbc:ID>
        </cac:TaxScheme>
      </cac:PartyTaxScheme>`:""}
      <cac:PartyLegalEntity>
        <cbc:RegistrationName>${i.customerName}</cbc:RegistrationName>
      </cac:PartyLegalEntity>
    </cac:Party>
  </cac:AccountingCustomerParty>
  <cac:PaymentMeans>
    <cbc:PaymentMeansCode>${i.paymentMeans||"10"}</cbc:PaymentMeansCode>
  </cac:PaymentMeans>
  <cac:TaxTotal>
    <cbc:TaxAmount currencyID="SAR">${i.taxAmount.toFixed(2)}</cbc:TaxAmount>
    <cac:TaxSubtotal>
      <cbc:TaxableAmount currencyID="SAR">${i.taxableAmount.toFixed(2)}</cbc:TaxableAmount>
      <cbc:TaxAmount currencyID="SAR">${i.taxAmount.toFixed(2)}</cbc:TaxAmount>
      <cac:TaxCategory>
        <cbc:ID>S</cbc:ID>
        <cbc:Percent>15.00</cbc:Percent>
        <cac:TaxScheme>
          <cbc:ID>VAT</cbc:ID>
        </cac:TaxScheme>
      </cac:TaxCategory>
    </cac:TaxSubtotal>
  </cac:TaxTotal>
  <cac:LegalMonetaryTotal>
    <cbc:LineExtensionAmount currencyID="SAR">${i.subtotal.toFixed(2)}</cbc:LineExtensionAmount>
    <cbc:TaxExclusiveAmount currencyID="SAR">${i.taxableAmount.toFixed(2)}</cbc:TaxExclusiveAmount>
    <cbc:TaxInclusiveAmount currencyID="SAR">${i.totalAmount.toFixed(2)}</cbc:TaxInclusiveAmount>
    <cbc:AllowanceTotalAmount currencyID="SAR">${i.totalDiscountAmount.toFixed(2)}</cbc:AllowanceTotalAmount>
    <cbc:PayableAmount currencyID="SAR">${i.totalAmount.toFixed(2)}</cbc:PayableAmount>
  </cac:LegalMonetaryTotal>
  ${p}
</Invoice>`}async function Os(i){let a=await dt.findOne().sort({invoiceCounter:-1}),s=(a?.invoiceCounter||0)+1,u=i.items.map(Ae=>{let Te=ta(Ae);return{itemId:Ae.itemId,nameAr:Ae.nameAr,nameEn:Ae.nameEn||"",quantity:Ae.quantity,unitPrice:Ae.unitPrice,discountAmount:Ae.discountAmount||0,taxableAmount:Te.taxableAmount,taxRate:Ae.taxRate??Kn,taxAmount:Te.taxAmount,totalAmount:Te.totalAmount}}),p=u.reduce((Ae,Te)=>Ae+Te.unitPrice*Te.quantity,0),y=u.reduce((Ae,Te)=>Ae+Te.discountAmount,0),h=u.reduce((Ae,Te)=>Ae+Te.taxableAmount,0),v=u.reduce((Ae,Te)=>Ae+Te.taxAmount,0),D=u.reduce((Ae,Te)=>Ae+Te.totalAmount,0),O=Xn(),M=ea(s),B=new Date,F=JSON.stringify({uuid:O,invoiceNumber:M,invoiceCounter:s,invoiceDate:B.toISOString(),totalAmount:D,taxAmount:v}),z=a?.invoiceHash,ne=na(F,z),H=ra({sellerName:Wn,vatNumber:Yn,timestamp:aa(B),totalWithVat:D.toFixed(2),vatAmount:v.toFixed(2),invoiceHash:ne}),Y=i.invoiceType||"simplified",ue=i.transactionType||(i.customerVatNumber?"B2B":"B2C"),Oe=Y==="standard"?"388":Y==="credit_note"?"381":Y==="debit_note"?"383":"388",ke=new dt({invoiceNumber:M,uuid:O,orderId:i.orderId,sellerName:Wn,sellerNameEn:Cs,sellerVatNumber:Yn,sellerAddress:Ps,sellerCity:Rs,sellerCountry:"SA",sellerCrNumber:xs,sellerBuildingNumber:js,sellerPostalCode:Ns,sellerDistrict:Ts,branchId:i.branchId,customerName:i.customerName,customerPhone:i.customerPhone,customerEmail:i.customerEmail,customerVatNumber:i.customerVatNumber,customerAddress:i.customerAddress,invoiceType:Y,invoiceTypeCode:Oe,transactionType:ue,items:u,subtotal:Math.round(p*100)/100,totalDiscountAmount:Math.round(y*100)/100,taxableAmount:Math.round(h*100)/100,taxAmount:Math.round(v*100)/100,totalAmount:Math.round(D*100)/100,paymentMethod:i.paymentMethod,paymentMeans:oa(i.paymentMethod),invoiceCounter:s,previousInvoiceHash:z,invoiceHash:ne,qrCode:H,invoiceDate:B,supplyDate:B,zatcaStatus:"pending",createdBy:i.createdBy}),vt=sa(ke);return ke.xmlContent=vt,await ke.save(),ke}async function Es(i){return dt.findOne({orderId:i})}async function Ms(i,a,s){let u={branchId:i};return(a||s)&&(u.invoiceDate={},a&&(u.invoiceDate.$gte=a),s&&(u.invoiceDate.$lte=s)),dt.find(u).sort({invoiceDate:-1})}async function Bs(i,a,s){let u={};i&&(u.branchId=i),(a||s)&&(u.invoiceDate={},a&&(u.invoiceDate.$gte=a),s&&(u.invoiceDate.$lte=s));let p=await dt.aggregate([{$match:u},{$group:{_id:null,totalInvoices:{$sum:1},totalRevenue:{$sum:"$totalAmount"},totalVat:{$sum:"$taxAmount"}}}]);return p.length===0?{totalInvoices:0,totalRevenue:0,totalVat:0,averageInvoiceValue:0}:{totalInvoices:p[0].totalInvoices,totalRevenue:p[0].totalRevenue,totalVat:p[0].totalVat,averageInvoiceValue:p[0].totalRevenue/p[0].totalInvoices}}var Kn,Wn,Cs,Yn,Ps,xs,js,Ns,Ts,Rs,xc,jc,Nc,Tc,Vr=Ot(()=>{"use strict";T();Kn=parseFloat(process.env.VAT_RATE||"0.15"),Wn=process.env.ZATCA_SELLER_NAME||"CLUNY CAFE",Cs=process.env.ZATCA_SELLER_NAME_EN||"CLUNY CAFE",Yn=process.env.ZATCA_VAT_NUMBER||"311234567890003",Ps=process.env.ZATCA_SELLER_ADDRESS||"\u0627\u0644\u0631\u064A\u0627\u0636\u060C \u0627\u0644\u0645\u0645\u0644\u0643\u0629 \u0627\u0644\u0639\u0631\u0628\u064A\u0629 \u0627\u0644\u0633\u0639\u0648\u062F\u064A\u0629",xs=process.env.ZATCA_CR_NUMBER||"",js=process.env.ZATCA_BUILDING_NUMBER||"",Ns=process.env.ZATCA_POSTAL_CODE||"",Ts=process.env.ZATCA_DISTRICT||"",Rs=process.env.ZATCA_CITY||"\u0627\u0644\u0631\u064A\u0627\u0636",xc=process.env.ZATCA_API_URL||"https://gw-fatoora.zatca.gov.sa/e-invoicing/developer-portal",jc=process.env.ZATCA_COMPLIANCE_CSID||"",Nc=process.env.ZATCA_PRODUCTION_CSID||"",Tc=process.env.ZATCA_SECRET||""});var Cn={};Et(Cn,{BADIAH_CENTER:()=>Fs,DEFAULT_DELIVERY_FEE:()=>_s,DELIVERY_RADIUS_METERS:()=>qs,calculateDistance:()=>ca,calculateDistanceMeters:()=>da,checkDeliveryAvailability:()=>ua,getDeliveryZoneForPoint:()=>ks,getNearestDeliveryBranch:()=>$s,isPointInPolygon:()=>ia});function ia(i,a){if(a.length<3)return!1;let s=!1,u=i.lng,p=i.lat;for(let y=0,h=a.length-1;y<a.length;h=y++){let v=a[y].lng,D=a[y].lat,O=a[h].lng,M=a[h].lat;D>p!=M>p&&u<(O-v)*(p-D)/(M-D)+v&&(s=!s)}return s}function ks(i,a){for(let s of a)if(ia(i,s.coordinates))return{zone:s.nameAr,zoneId:s._id.toString(),deliveryFee:s.deliveryFee,isInZone:!0};return null}function ca(i,a){let u=Gr(a.lat-i.lat),p=Gr(a.lng-i.lng),y=Math.sin(u/2)*Math.sin(u/2)+Math.cos(Gr(i.lat))*Math.cos(Gr(a.lat))*Math.sin(p/2)*Math.sin(p/2);return 6371*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))}function da(i,a){return ca(i,a)*1e3}function Gr(i){return i*(Math.PI/180)}function ua(i,a){if(!a||a.length===0)return{canDeliver:!1,nearestBranch:null,distanceMeters:0,message:"No branches available",messageAr:"\u0644\u0627 \u062A\u0648\u062C\u062F \u0641\u0631\u0648\u0639 \u0645\u062A\u0627\u062D\u0629",allBranchesWithDistance:[]};let s=a.filter(y=>y.location&&y.location.lat&&y.location.lng).map(y=>{let h={lat:y.location.lat,lng:y.location.lng},v=da(i,h);return{branch:y,distanceMeters:v,isInRange:v<=500}}).sort((y,h)=>y.distanceMeters-h.distanceMeters);if(s.length===0)return{canDeliver:!1,nearestBranch:null,distanceMeters:0,message:"No branches with location data available",messageAr:"\u0644\u0627 \u062A\u0648\u062C\u062F \u0641\u0631\u0648\u0639 \u0628\u0645\u0648\u0642\u0639 \u0645\u062D\u062F\u062F",allBranchesWithDistance:[]};let u=s[0],p=s.filter(y=>y.isInRange);return p.length>0?{canDeliver:!0,nearestBranch:p[0].branch,distanceMeters:Math.round(p[0].distanceMeters),message:`Delivery available from ${p[0].branch.nameEn||p[0].branch.nameAr}`,messageAr:`\u0627\u0644\u062A\u0648\u0635\u064A\u0644 \u0645\u062A\u0627\u062D \u0645\u0646 ${p[0].branch.nameAr}`,allBranchesWithDistance:s}:{canDeliver:!1,nearestBranch:u.branch,distanceMeters:Math.round(u.distanceMeters),message:`You are ${Math.round(u.distanceMeters)}m away from the nearest branch (${u.branch.nameEn||u.branch.nameAr}). Delivery is only available within 500m.`,messageAr:`\u0623\u0646\u062A \u0639\u0644\u0649 \u0628\u0639\u062F ${Math.round(u.distanceMeters)} \u0645\u062A\u0631 \u0645\u0646 \u0623\u0642\u0631\u0628 \u0641\u0631\u0639 (${u.branch.nameAr}). \u0627\u0644\u062A\u0648\u0635\u064A\u0644 \u0645\u062A\u0627\u062D \u0641\u0642\u0637 \u0636\u0645\u0646 \u0646\u0637\u0627\u0642 500 \u0645\u062A\u0631.`,allBranchesWithDistance:s}}function $s(i,a){let s=ua(i,a);return s.canDeliver?s.nearestBranch:null}var qs,Fs,_s,Pn=Ot(()=>{"use strict";qs=500;Fs={lat:26.3472,lng:43.975},_s=10});var lr={};Et(lr,{LeaveRequestModel:()=>Vs});import Ls,{Schema as Us}from"mongoose";var zs,Vs,mr=Ot(()=>{"use strict";zs=new Us({employeeId:{type:String,required:!0,index:!0},startDate:{type:Date,required:!0},endDate:{type:Date,required:!0},reason:{type:String,required:!0},status:{type:String,enum:["pending","approved","rejected"],default:"pending",index:!0},approvedBy:{type:String},approvalDate:{type:Date},rejectionReason:{type:String},numberOfDays:{type:Number,required:!0},createdAt:{type:Date,default:Date.now,index:!0},updatedAt:{type:Date,default:Date.now}}),Vs=Ls.model("LeaveRequest",zs)});import Wr from"express";import wa from"express-session";import pi from"memorystore";import Ia from"compression";import va from"path";import{fileURLToPath as yi}from"url";import Wt from"mongoose";import jt from"mongoose";import{createServer as Gs}from"http";T();import lt from"bcryptjs";import{nanoid as at}from"nanoid";import{nanoid as Ct}from"nanoid";import us from"qrcode";var ir={SELLER_NAME:1,VAT_NUMBER:2,TIMESTAMP:3,TOTAL_WITH_VAT:4,VAT_AMOUNT:5};function cr(i,a){let s=Buffer.from(a,"utf-8"),u=s.length;return Buffer.concat([Buffer.from([i]),Buffer.from([u]),s])}function Or(i){let a=i.invoiceDate.toISOString(),s=i.totalWithVat.toFixed(2),u=i.vatAmount.toFixed(2);return Buffer.concat([cr(ir.SELLER_NAME,i.sellerName),cr(ir.VAT_NUMBER,i.vatNumber),cr(ir.TIMESTAMP,a),cr(ir.TOTAL_WITH_VAT,s),cr(ir.VAT_AMOUNT,u)]).toString("base64")}async function fn(i){let a=Or(i);return await us.toDataURL(a,{errorCorrectionLevel:"M",margin:2,width:200,color:{dark:"#000000",light:"#FFFFFF"}})}T();var ls=[{accountNumber:"1000",nameAr:"\u0627\u0644\u0623\u0635\u0648\u0644",nameEn:"Assets",accountType:"asset",normalBalance:"debit",level:1},{accountNumber:"1100",nameAr:"\u0627\u0644\u0623\u0635\u0648\u0644 \u0627\u0644\u0645\u062A\u062F\u0627\u0648\u0644\u0629",nameEn:"Current Assets",accountType:"asset",normalBalance:"debit",level:2,parentAccountNumber:"1000"},{accountNumber:"1110",nameAr:"\u0627\u0644\u0646\u0642\u062F\u064A\u0629",nameEn:"Cash",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1100"},{accountNumber:"1111",nameAr:"\u0627\u0644\u0635\u0646\u062F\u0648\u0642",nameEn:"Petty Cash",accountType:"asset",normalBalance:"debit",level:4,parentAccountNumber:"1110",isSystemAccount:1},{accountNumber:"1112",nameAr:"\u0627\u0644\u0628\u0646\u0643",nameEn:"Bank",accountType:"asset",normalBalance:"debit",level:4,parentAccountNumber:"1110",isBankAccount:1},{accountNumber:"1120",nameAr:"\u0627\u0644\u0630\u0645\u0645 \u0627\u0644\u0645\u062F\u064A\u0646\u0629",nameEn:"Accounts Receivable",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1100",isSystemAccount:1},{accountNumber:"1130",nameAr:"\u0627\u0644\u0645\u062E\u0632\u0648\u0646",nameEn:"Inventory",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1100",isSystemAccount:1},{accountNumber:"1140",nameAr:"\u0645\u0635\u0631\u0648\u0641\u0627\u062A \u0645\u062F\u0641\u0648\u0639\u0629 \u0645\u0642\u062F\u0645\u0627\u064B",nameEn:"Prepaid Expenses",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1100"},{accountNumber:"1200",nameAr:"\u0627\u0644\u0623\u0635\u0648\u0644 \u0627\u0644\u062B\u0627\u0628\u062A\u0629",nameEn:"Fixed Assets",accountType:"asset",normalBalance:"debit",level:2,parentAccountNumber:"1000"},{accountNumber:"1210",nameAr:"\u0627\u0644\u0645\u0639\u062F\u0627\u062A",nameEn:"Equipment",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1200"},{accountNumber:"1220",nameAr:"\u0627\u0644\u0623\u062B\u0627\u062B",nameEn:"Furniture",accountType:"asset",normalBalance:"debit",level:3,parentAccountNumber:"1200"},{accountNumber:"2000",nameAr:"\u0627\u0644\u062E\u0635\u0648\u0645",nameEn:"Liabilities",accountType:"liability",normalBalance:"credit",level:1},{accountNumber:"2100",nameAr:"\u0627\u0644\u062E\u0635\u0648\u0645 \u0627\u0644\u0645\u062A\u062F\u0627\u0648\u0644\u0629",nameEn:"Current Liabilities",accountType:"liability",normalBalance:"credit",level:2,parentAccountNumber:"2000"},{accountNumber:"2110",nameAr:"\u0627\u0644\u0630\u0645\u0645 \u0627\u0644\u062F\u0627\u0626\u0646\u0629",nameEn:"Accounts Payable",accountType:"liability",normalBalance:"credit",level:3,parentAccountNumber:"2100",isSystemAccount:1},{accountNumber:"2120",nameAr:"\u0636\u0631\u064A\u0628\u0629 \u0627\u0644\u0642\u064A\u0645\u0629 \u0627\u0644\u0645\u0636\u0627\u0641\u0629 \u0627\u0644\u0645\u0633\u062A\u062D\u0642\u0629",nameEn:"VAT Payable",accountType:"liability",normalBalance:"credit",level:3,parentAccountNumber:"2100",isSystemAccount:1},{accountNumber:"2130",nameAr:"\u0627\u0644\u0631\u0648\u0627\u062A\u0628 \u0627\u0644\u0645\u0633\u062A\u062D\u0642\u0629",nameEn:"Salaries Payable",accountType:"liability",normalBalance:"credit",level:3,parentAccountNumber:"2100"},{accountNumber:"2200",nameAr:"\u0627\u0644\u062E\u0635\u0648\u0645 \u0637\u0648\u064A\u0644\u0629 \u0627\u0644\u0623\u062C\u0644",nameEn:"Long-term Liabilities",accountType:"liability",normalBalance:"credit",level:2,parentAccountNumber:"2000"},{accountNumber:"2210",nameAr:"\u0627\u0644\u0642\u0631\u0648\u0636",nameEn:"Loans",accountType:"liability",normalBalance:"credit",level:3,parentAccountNumber:"2200"},{accountNumber:"3000",nameAr:"\u062D\u0642\u0648\u0642 \u0627\u0644\u0645\u0644\u0643\u064A\u0629",nameEn:"Equity",accountType:"equity",normalBalance:"credit",level:1},{accountNumber:"3100",nameAr:"\u0631\u0623\u0633 \u0627\u0644\u0645\u0627\u0644",nameEn:"Capital",accountType:"equity",normalBalance:"credit",level:2,parentAccountNumber:"3000",isSystemAccount:1},{accountNumber:"3200",nameAr:"\u0627\u0644\u0623\u0631\u0628\u0627\u062D \u0627\u0644\u0645\u062D\u062A\u062C\u0632\u0629",nameEn:"Retained Earnings",accountType:"equity",normalBalance:"credit",level:2,parentAccountNumber:"3000",isSystemAccount:1},{accountNumber:"4000",nameAr:"\u0627\u0644\u0625\u064A\u0631\u0627\u062F\u0627\u062A",nameEn:"Revenue",accountType:"revenue",normalBalance:"credit",level:1},{accountNumber:"4100",nameAr:"\u0625\u064A\u0631\u0627\u062F\u0627\u062A \u0627\u0644\u0645\u0628\u064A\u0639\u0627\u062A",nameEn:"Sales Revenue",accountType:"revenue",normalBalance:"credit",level:2,parentAccountNumber:"4000",isSystemAccount:1},{accountNumber:"4110",nameAr:"\u0645\u0628\u064A\u0639\u0627\u062A \u0627\u0644\u0645\u0634\u0631\u0648\u0628\u0627\u062A",nameEn:"Beverage Sales",accountType:"revenue",normalBalance:"credit",level:3,parentAccountNumber:"4100"},{accountNumber:"4120",nameAr:"\u0645\u0628\u064A\u0639\u0627\u062A \u0627\u0644\u0623\u0637\u0639\u0645\u0629",nameEn:"Food Sales",accountType:"revenue",normalBalance:"credit",level:3,parentAccountNumber:"4100"},{accountNumber:"4200",nameAr:"\u0625\u064A\u0631\u0627\u062F\u0627\u062A \u0623\u062E\u0631\u0649",nameEn:"Other Revenue",accountType:"revenue",normalBalance:"credit",level:2,parentAccountNumber:"4000"},{accountNumber:"4210",nameAr:"\u0631\u0633\u0648\u0645 \u0627\u0644\u062A\u0648\u0635\u064A\u0644",nameEn:"Delivery Fees",accountType:"revenue",normalBalance:"credit",level:3,parentAccountNumber:"4200"},{accountNumber:"5000",nameAr:"\u0627\u0644\u0645\u0635\u0631\u0648\u0641\u0627\u062A",nameEn:"Expenses",accountType:"expense",normalBalance:"debit",level:1},{accountNumber:"5100",nameAr:"\u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0628\u0636\u0627\u0639\u0629 \u0627\u0644\u0645\u0628\u0627\u0639\u0629",nameEn:"Cost of Goods Sold",accountType:"expense",normalBalance:"debit",level:2,parentAccountNumber:"5000",isSystemAccount:1},{accountNumber:"5200",nameAr:"\u0645\u0635\u0631\u0648\u0641\u0627\u062A \u0627\u0644\u062A\u0634\u063A\u064A\u0644",nameEn:"Operating Expenses",accountType:"expense",normalBalance:"debit",level:2,parentAccountNumber:"5000"},{accountNumber:"5210",nameAr:"\u0627\u0644\u0631\u0648\u0627\u062A\u0628 \u0648\u0627\u0644\u0623\u062C\u0648\u0631",nameEn:"Salaries & Wages",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5220",nameAr:"\u0627\u0644\u0625\u064A\u062C\u0627\u0631",nameEn:"Rent",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5230",nameAr:"\u0627\u0644\u0645\u0631\u0627\u0641\u0642",nameEn:"Utilities",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5240",nameAr:"\u0627\u0644\u062A\u0633\u0648\u064A\u0642 \u0648\u0627\u0644\u0625\u0639\u0644\u0627\u0646",nameEn:"Marketing & Advertising",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5250",nameAr:"\u0627\u0644\u0635\u064A\u0627\u0646\u0629",nameEn:"Maintenance",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5260",nameAr:"\u0627\u0644\u0645\u0633\u062A\u0644\u0632\u0645\u0627\u062A",nameEn:"Supplies",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200"},{accountNumber:"5270",nameAr:"\u0627\u0644\u0647\u062F\u0631 \u0648\u0627\u0644\u062A\u0627\u0644\u0641",nameEn:"Waste & Spoilage",accountType:"expense",normalBalance:"debit",level:3,parentAccountNumber:"5200",isSystemAccount:1},{accountNumber:"5300",nameAr:"\u0645\u0635\u0631\u0648\u0641\u0627\u062A \u0623\u062E\u0631\u0649",nameEn:"Other Expenses",accountType:"expense",normalBalance:"debit",level:2,parentAccountNumber:"5000"}],ce=class{static async initializeChartOfAccounts(a){let s=await te.find({tenantId:a});if(s.length>0)return s;let u={},p=[];for(let y of ls){let h=Ct(),v=y.parentAccountNumber?u[y.parentAccountNumber]:void 0,D=await te.create({id:h,tenantId:a,accountNumber:y.accountNumber,nameAr:y.nameAr,nameEn:y.nameEn,accountType:y.accountType,normalBalance:y.normalBalance,parentAccountId:v,level:y.level,path:v?`${y.parentAccountNumber}/${y.accountNumber}`:y.accountNumber,isSystemAccount:y.isSystemAccount||0,isBankAccount:y.isBankAccount||0,currency:"SAR",isActive:1,openingBalance:0,currentBalance:0});u[y.accountNumber]=h,p.push(D)}return p}static async getAccounts(a,s){let u={tenantId:a};return s?.accountType&&(u.accountType=s.accountType),s?.isActive!==void 0&&(u.isActive=s.isActive),s?.parentAccountId&&(u.parentAccountId=s.parentAccountId),te.find(u).sort({accountNumber:1})}static async getAccountTree(a){let s=await te.find({tenantId:a,isActive:1}).sort({accountNumber:1}),u={},p=[];for(let y of s)u[y.id]={...y.toObject(),children:[]};for(let y of s){let h=u[y.id];y.parentAccountId&&u[y.parentAccountId]?u[y.parentAccountId].children.push(h):p.push(h)}return p}static async createAccount(a){if(await te.findOne({tenantId:a.tenantId,accountNumber:a.accountNumber}))throw new Error(`\u0631\u0642\u0645 \u0627\u0644\u062D\u0633\u0627\u0628 ${a.accountNumber} \u0645\u0648\u062C\u0648\u062F \u0628\u0627\u0644\u0641\u0639\u0644`);let u=1,p=a.accountNumber;if(a.parentAccountId){let y=await te.findOne({id:a.parentAccountId,tenantId:a.tenantId});y&&(u=y.level+1,p=`${y.path}/${a.accountNumber}`)}return te.create({id:Ct(),...a,level:u,path:p,isActive:1,isSystemAccount:0,isBankAccount:a.isBankAccount||0,currentBalance:a.openingBalance||0,openingBalance:a.openingBalance||0})}static async createJournalEntry(a){let s=a.lines.reduce((h,v)=>h+(v.debit||0),0),u=a.lines.reduce((h,v)=>h+(v.credit||0),0);if(Math.abs(s-u)>.01)throw new Error(`\u0627\u0644\u0642\u064A\u062F \u063A\u064A\u0631 \u0645\u062A\u0648\u0627\u0632\u0646: \u0627\u0644\u0645\u062F\u064A\u0646 ${s.toFixed(2)} \u0644\u0627 \u064A\u0633\u0627\u0648\u064A \u0627\u0644\u062F\u0627\u0626\u0646 ${u.toFixed(2)}`);let p=await this.generateEntryNumber(a.tenantId),y=await bt.create({id:Ct(),tenantId:a.tenantId,entryNumber:p,entryDate:a.entryDate,description:a.description,lines:a.lines,totalDebit:parseFloat(s.toFixed(2)),totalCredit:parseFloat(u.toFixed(2)),isBalanced:1,referenceType:a.referenceType,referenceId:a.referenceId,status:a.autoPost?"posted":"draft",isAutoPosted:a.autoPost?1:0,createdBy:a.createdBy,postedBy:a.autoPost?a.createdBy:void 0,postedAt:a.autoPost?new Date:void 0});return a.autoPost&&await this.updateAccountBalances(a.tenantId,a.lines),y}static async postJournalEntry(a,s,u){let p=await bt.findOne({id:s,tenantId:a});if(!p)throw new Error("\u0627\u0644\u0642\u064A\u062F \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F");if(p.status==="posted")throw new Error("\u062A\u0645 \u062A\u0631\u062D\u064A\u0644 \u0647\u0630\u0627 \u0627\u0644\u0642\u064A\u062F \u0645\u0633\u0628\u0642\u0627\u064B \u0648\u0644\u0627 \u064A\u0645\u0643\u0646 \u062A\u0631\u062D\u064A\u0644\u0647 \u0645\u0631\u0629 \u0623\u062E\u0631\u0649");if(p.status!=="draft")throw new Error("\u0644\u0627 \u064A\u0645\u0643\u0646 \u062A\u0631\u062D\u064A\u0644 \u0642\u064A\u062F \u063A\u064A\u0631 \u0645\u0633\u0648\u062F\u0629");let y=new Date(p.entryDate),h=await mn.findOne({tenantId:a,startDate:{$lte:y},endDate:{$gte:y}});if(h&&h.status==="locked")throw new Error("\u0627\u0644\u0641\u062A\u0631\u0629 \u0627\u0644\u0645\u062D\u0627\u0633\u0628\u064A\u0629 \u0645\u063A\u0644\u0642\u0629 \u0648\u0644\u0627 \u064A\u0645\u0643\u0646 \u0625\u0636\u0627\u0641\u0629 \u0642\u064A\u0648\u062F \u062C\u062F\u064A\u062F\u0629 \u0641\u064A\u0647\u0627");return p.status="posted",p.postedBy=u,p.postedAt=new Date,await p.save(),await this.updateAccountBalances(a,p.lines),p}static async updateAccountBalances(a,s){for(let u of s){let p=await te.findOne({id:u.accountId,tenantId:a});if(p){let y=0;p.normalBalance==="debit"?y=(u.debit||0)-(u.credit||0):y=(u.credit||0)-(u.debit||0),p.currentBalance=(p.currentBalance||0)+y,await p.save()}}}static async generateEntryNumber(a){let s=new Date().getFullYear(),u=await bt.countDocuments({tenantId:a,entryNumber:{$regex:`^JE-${s}-`}});return`JE-${s}-${String(u+1).padStart(6,"0")}`}static async postOrderJournal(a,s,u){let p=await Z.findOne({id:s});if(!p)return null;let y=await te.findOne({tenantId:a,accountNumber:"1111"}),h=await te.findOne({tenantId:a,accountNumber:"4100"}),v=await te.findOne({tenantId:a,accountNumber:"2120"}),D=await te.findOne({tenantId:a,accountNumber:"5100"}),O=await te.findOne({tenantId:a,accountNumber:"1130"});if(!y||!h||!v)return console.log("Missing required accounts for order journal posting"),null;let M=p.totalAmount||0,B=M*.15/1.15,F=M-B,z=p.costOfGoods||0,ne=[{accountId:y.id,accountNumber:y.accountNumber,accountName:y.nameAr,debit:M,credit:0,description:`\u0645\u0628\u064A\u0639\u0627\u062A - \u0637\u0644\u0628 ${p.orderNumber}`,branchId:p.branchId},{accountId:h.id,accountNumber:h.accountNumber,accountName:h.nameAr,debit:0,credit:F,description:`\u0625\u064A\u0631\u0627\u062F \u0645\u0628\u064A\u0639\u0627\u062A - \u0637\u0644\u0628 ${p.orderNumber}`,branchId:p.branchId},{accountId:v.id,accountNumber:v.accountNumber,accountName:v.nameAr,debit:0,credit:B,description:`\u0636\u0631\u064A\u0628\u0629 \u0627\u0644\u0642\u064A\u0645\u0629 \u0627\u0644\u0645\u0636\u0627\u0641\u0629 - \u0637\u0644\u0628 ${p.orderNumber}`,branchId:p.branchId}];return z>0&&D&&O&&(ne.push({accountId:D.id,accountNumber:D.accountNumber,accountName:D.nameAr,debit:z,credit:0,description:`\u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0628\u0636\u0627\u0639\u0629 \u0627\u0644\u0645\u0628\u0627\u0639\u0629 - \u0637\u0644\u0628 ${p.orderNumber}`,branchId:p.branchId}),ne.push({accountId:O.id,accountNumber:O.accountNumber,accountName:O.nameAr,debit:0,credit:z,description:`\u062E\u0635\u0645 \u0645\u062E\u0632\u0648\u0646 - \u0637\u0644\u0628 ${p.orderNumber}`,branchId:p.branchId})),this.createJournalEntry({tenantId:a,entryDate:p.createdAt||new Date,description:`\u0642\u064A\u062F \u0645\u0628\u064A\u0639\u0627\u062A - \u0637\u0644\u0628 \u0631\u0642\u0645 ${p.orderNumber}`,lines:ne,referenceType:"order",referenceId:s,createdBy:u,autoPost:!0})}static async createInvoiceFromOrder(a,s,u,p,y){let h=await Z.findOne({id:u});if(!h)throw new Error("\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F");let v=await this.generateInvoiceNumber(a,s),D=new Date,O=(h.items||[]).map(H=>({itemId:H.coffeeItemId||H.menuItemId,description:H.name||"\u0645\u0646\u062A\u062C",quantity:H.quantity||1,unitPrice:H.price||H.unitPrice||0,discountAmount:0,discountPercent:0,taxRate:15,taxAmount:(H.price||H.unitPrice||0)*(H.quantity||1)*.15,lineTotal:(H.price||H.unitPrice||0)*(H.quantity||1)*1.15})),M=O.reduce((H,Y)=>H+Y.unitPrice*Y.quantity,0),B=O.reduce((H,Y)=>H+Y.taxAmount,0),F=M+B,z,ne;if(y?.name&&y?.vatNumber){let H={sellerName:y.name,vatNumber:y.vatNumber,invoiceDate:D,totalWithVat:F,vatAmount:B};ne=Or(H),z=await fn(H)}return ut.create({id:Ct(),tenantId:a,branchId:s,invoiceNumber:v,invoiceDate:D,invoiceType:"sales",status:"issued",customerId:h.customerId,customerName:h.customerInfo?.name||"\u0639\u0645\u064A\u0644 \u0646\u0642\u062F\u064A",customerPhone:h.customerInfo?.phone,orderId:u,lines:O,subtotal:parseFloat(M.toFixed(2)),totalDiscount:0,totalTax:parseFloat(B.toFixed(2)),grandTotal:parseFloat(F.toFixed(2)),amountPaid:F,amountDue:0,currency:"SAR",exchangeRate:1,paymentMethod:h.paymentMethod,issuedBy:p,issuedAt:D,paidAt:D,zatcaQrCode:z,zatcaHash:ne})}static async createInvoice(a){let s=await this.generateInvoiceNumber(a.tenantId,a.branchId),u=new Date,p=a.lines.map(F=>{let z=F.discountPercent||0,ne=F.unitPrice*F.quantity,H=ne*(z/100),Y=ne-H,ue=Y*.15,Oe=Y+ue;return{description:F.description,quantity:F.quantity,unitPrice:F.unitPrice,discountAmount:parseFloat(H.toFixed(2)),discountPercent:z,taxRate:15,taxAmount:parseFloat(ue.toFixed(2)),lineTotal:parseFloat(Oe.toFixed(2))}}),y=p.reduce((F,z)=>F+z.unitPrice*z.quantity,0),h=p.reduce((F,z)=>F+z.discountAmount,0),v=p.reduce((F,z)=>F+z.taxAmount,0),D=p.reduce((F,z)=>F+z.lineTotal,0),O={sellerName:a.sellerName,vatNumber:a.sellerVatNumber,invoiceDate:u,totalWithVat:D,vatAmount:v},M=Or(O),B=await fn(O);return ut.create({id:Ct(),tenantId:a.tenantId,branchId:a.branchId,invoiceNumber:s,invoiceDate:u,invoiceType:"sales",status:"issued",customerName:a.customerName,customerPhone:a.customerPhone,customerEmail:a.customerEmail,customerTaxNumber:a.customerTaxNumber,customerAddress:a.customerAddress,lines:p,subtotal:parseFloat(y.toFixed(2)),totalDiscount:parseFloat(h.toFixed(2)),totalTax:parseFloat(v.toFixed(2)),grandTotal:parseFloat(D.toFixed(2)),amountPaid:0,amountDue:parseFloat(D.toFixed(2)),currency:"SAR",exchangeRate:1,notes:a.notes,issuedBy:a.issuedBy,issuedAt:u,zatcaQrCode:B,zatcaHash:M})}static async getInvoices(a,s){let u={tenantId:a};return s?.branchId&&(u.branchId=s.branchId),s?.status&&(u.status=s.status),(s?.startDate||s?.endDate)&&(u.invoiceDate={},s.startDate&&(u.invoiceDate.$gte=s.startDate),s.endDate&&(u.invoiceDate.$lte=s.endDate)),ut.find(u).sort({invoiceDate:-1}).limit(s?.limit||100)}static async getInvoiceById(a,s){return ut.findOne({id:s,tenantId:a})}static async updateInvoiceStatus(a,s,u,p){let y=await ut.findOne({id:s,tenantId:a});return y?(y.status=u,p!==void 0&&(y.amountPaid=p,y.amountDue=y.grandTotal-p,p>=y.grandTotal?(y.status="paid",y.paidAt=new Date):p>0&&(y.status="partially_paid")),await y.save(),y):null}static async generateInvoiceNumber(a,s){let u=new Date().getFullYear(),p=await ut.countDocuments({tenantId:a,branchId:s,invoiceNumber:{$regex:`^INV-${u}-`}});return`INV-${u}-${String(p+1).padStart(6,"0")}`}static async getTrialBalance(a,s){return(await te.find({tenantId:a,isActive:1}).sort({accountNumber:1})).map(p=>({accountNumber:p.accountNumber,accountName:p.nameAr,accountType:p.accountType,debitBalance:p.normalBalance==="debit"?p.currentBalance:0,creditBalance:p.normalBalance==="credit"?p.currentBalance:0}))}static async getIncomeStatement(a,s,u,p){let y={tenantId:a,entryDate:{$gte:s,$lte:u},status:"posted"},h=await bt.find(y),v={},D={},O=0;for(let Y of h)for(let ue of Y.lines){if(p&&ue.branchId!==p)continue;let Oe=await te.findOne({id:ue.accountId,tenantId:a});if(Oe){if(Oe.accountType==="revenue"){let ke=(ue.credit||0)-(ue.debit||0);v[Oe.nameAr]=(v[Oe.nameAr]||0)+ke}else if(Oe.accountType==="expense"){let ke=(ue.debit||0)-(ue.credit||0);Oe.accountNumber==="5100"?O+=ke:D[Oe.nameAr]=(D[Oe.nameAr]||0)+ke}}}let M=Object.entries(v).map(([Y,ue])=>({accountName:Y,amount:ue})),B=Object.entries(D).map(([Y,ue])=>({accountName:Y,amount:ue})),F=M.reduce((Y,ue)=>Y+ue.amount,0),z=B.reduce((Y,ue)=>Y+ue.amount,0),ne=F-O,H=ne-z;return{revenue:M,totalRevenue:parseFloat(F.toFixed(2)),expenses:B,totalExpenses:parseFloat(z.toFixed(2)),cogs:parseFloat(O.toFixed(2)),grossProfit:parseFloat(ne.toFixed(2)),netIncome:parseFloat(H.toFixed(2))}}static async getBalanceSheet(a,s){let u=await te.find({tenantId:a,isActive:1,level:{$gte:3}}),p=[],y=[],h=[];for(let M of u){let B=M.currentBalance||0;if(B===0)continue;let F={accountName:M.nameAr,balance:B};switch(M.accountType){case"asset":p.push(F);break;case"liability":y.push(F);break;case"equity":h.push(F);break}}let v=p.reduce((M,B)=>M+B.balance,0),D=y.reduce((M,B)=>M+B.balance,0),O=h.reduce((M,B)=>M+B.balance,0);return{assets:p,totalAssets:parseFloat(v.toFixed(2)),liabilities:y,totalLiabilities:parseFloat(D.toFixed(2)),equity:h,totalEquity:parseFloat(O.toFixed(2))}}static async createExpense(a){let s=await this.generateExpenseNumber(a.tenantId),u=a.amount+(a.taxAmount||0);return It.create({id:Ct(),tenantId:a.tenantId,branchId:a.branchId,expenseNumber:s,expenseDate:new Date,category:a.category,description:a.description,amount:a.amount,taxAmount:a.taxAmount||0,totalAmount:u,paymentMethod:a.paymentMethod,vendorName:a.vendorName,requestedBy:a.requestedBy,status:"pending_approval",notes:a.notes,isRecurring:0})}static async approveExpense(a,s,u){let p=await It.findOne({id:s,tenantId:a});if(!p)throw new Error("\u0627\u0644\u0645\u0635\u0631\u0648\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F");if(p.status!=="pending_approval")throw new Error("\u0644\u0627 \u064A\u0645\u0643\u0646 \u0627\u0639\u062A\u0645\u0627\u062F \u0647\u0630\u0627 \u0627\u0644\u0645\u0635\u0631\u0648\u0641");return p.status="approved",p.approvedBy=u,p.approvedAt=new Date,await p.save(),p}static async generateExpenseNumber(a){let s=new Date().getFullYear(),u=await It.countDocuments({tenantId:a,expenseNumber:{$regex:`^EXP-${s}-`}});return`EXP-${s}-${String(u+1).padStart(6,"0")}`}static async getVendors(a){return jr.find({tenantId:a,isActive:1}).sort({nameAr:1})}static async createVendor(a){return jr.create({id:Ct(),...a,country:"SA",currentBalance:0,isActive:1})}static async getDashboardSummary(a,s,u,p){let y=u||new Date(new Date().getFullYear(),0,1),h=p||new Date,v=await this.getIncomeStatement(a,y,h,s),D=await te.findOne({tenantId:a,accountNumber:"1111"}),O=await te.findOne({tenantId:a,accountNumber:"1120"}),M=await te.findOne({tenantId:a,accountNumber:"2110"}),B=await It.countDocuments({tenantId:a,status:"pending_approval"}),F={tenantId:a};s&&(F.branchId=s);let z=await ut.countDocuments(F);return{totalRevenue:v.totalRevenue,totalExpenses:v.totalExpenses+v.cogs,netIncome:v.netIncome,accountsReceivable:O?.currentBalance||0,accountsPayable:M?.currentBalance||0,cashBalance:D?.currentBalance||0,pendingExpenses:B,invoiceCount:z}}};function E(i){if(!i)return null;let a=i.toObject?i.toObject():i;return a._id&&!a.id&&(a.id=a._id.toString()),delete a._id,delete a.__v,a}var bn=class{orderCounter=1;constructor(){this.initializeDatabase()}async initializeDatabase(){try{await this.initializeDemoEmployee()}catch(a){console.error("Error initializing database:",a)}}async initializeCoffeeMenu(){}async initializeDemoEmployee(){if(await he.findOne({username:"manager"}))return;let s=lt.hashSync("2030",10);await he.create({id:"manager-demo",username:"manager",password:s,fullName:"\u0627\u0644\u0645\u062F\u064A\u0631",role:"manager",title:"\u0645\u062F\u064A\u0631 \u0627\u0644\u0645\u0642\u0647\u0649",phone:"500000000",jobTitle:"\u0645\u062F\u064A\u0631",isActivated:1,employmentNumber:"EMP-001",tenantId:"demo-tenant"})}async getBusinessConfig(a){let s=await _e.findOne({tenantId:a}).lean();return s||void 0}async updateBusinessConfig(a,s){return await _e.findOneAndUpdate({tenantId:a},{$set:{...s,updatedAt:new Date}},{upsert:!0,new:!0}).lean()}async getIngredientItems(a){return await Xt.find({tenantId:a}).lean()}async createIngredientItem(a){return(await Xt.create(a)).toObject()}async updateIngredientItem(a,s){let u=await Xt.findByIdAndUpdate(a,{$set:{...s,updatedAt:new Date}},{new:!0}).lean();return u||void 0}async getRecipeDefinition(a,s){let u=await er.findOne({tenantId:a,productId:s,isActive:!0}).lean();return u||void 0}async createRecipeDefinition(a){return(await er.create(a)).toObject()}async updateRecipeDefinition(a,s){let u=await er.findByIdAndUpdate(a,{$set:{...s,updatedAt:new Date}},{new:!0}).lean();return u||void 0}async getUser(a){return await ar.findById(a)||void 0}async getUserByUsername(a){return await ar.findOne({username:a})||void 0}async createUser(a){let s=await lt.hash(a.password,10);return await ar.create({...a,password:s})}async getCafe(a){let s=await ze.findOne({id:a}).lean();return s?E(s):void 0}async createCafe(a){let s=await ze.create(a);return E(s)}async updateCafe(a,s){let u=await ze.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async getEmployee(a){let s=await he.findById(a).lean();if(!s)return;let u={...s,id:s._id.toString()};return delete u._id,delete u.__v,u}async getEmployeeByUsername(a){let s=await he.findOne({username:a}).lean();if(!s)return;let u={...s,id:s._id.toString()};return delete u._id,delete u.__v,u}async getEmployeeByPhone(a){let s=await he.findOne({phone:a}).lean();if(!s)return;let u={...s,id:s._id.toString()};return delete u._id,delete u.__v,u}async createEmployee(a){let s=a.employmentNumber||at(10);if(a.password){let u=await lt.hash(a.password,10),p=await he.create({...a,employmentNumber:s,password:u}),y={...p.toObject(),id:p._id.toString()};return delete y._id,delete y.__v,y}else{let u=await he.create({...a,employmentNumber:s}),p={...u.toObject(),id:u._id.toString()};return delete p._id,delete p.__v,p}}async updateEmployee(a,s){s.password&&(s.password=await lt.hash(s.password,10)),s.updatedAt=new Date;let u=await he.findOneAndUpdate({id:a},s,{new:!0}).lean();if(!u&&a.match(/^[0-9a-fA-F]{24}$/)&&(u=await he.findByIdAndUpdate(a,s,{new:!0}).lean()),!u)return;let p={...u,id:u._id.toString()};return delete p._id,delete p.__v,p}async activateEmployee(a,s,u){let p=await he.findOne({phone:a,fullName:s,isActivated:0});if(!p)return;let y=await lt.hash(u,10);p.password=y,p.isActivated=1,p.updatedAt=new Date,await p.save();let v={...p.toObject(),id:p._id.toString()};return delete v._id,delete v.__v,v}async resetEmployeePasswordByUsername(a,s){if(!await this.getEmployeeByUsername(a))return!1;let p=await lt.hash(s,10);return await he.updateOne({username:a},{password:p}),!0}async getEmployees(a){let s=a?{tenantId:a}:{};return(await he.find(s).lean()).map(p=>({...p,id:p._id.toString(),_id:void 0,__v:void 0}))}async getActiveCashiers(a){let s={role:"cashier",isActivated:1};return a&&(s.tenantId=a),(await he.find(s).lean()).map(p=>({...p,id:p._id.toString(),_id:void 0,__v:void 0}))}async createDiscountCode(a){let s={...a,code:a.code.trim().toLowerCase()};return await St.create(s)}async getDiscountCode(a){let s=await St.findById(a).lean();return s||void 0}async getCoffeeItems(){return(await ae.find({}).lean()).map(E)}async getCoffeeItem(a){let s=await ae.findOne({id:a}).lean();return s?E(s):void 0}async getCoffeeItemsByCategory(a){return(await ae.find({category:a}).lean()).map(E)}async createCoffeeItem(a){let s=await ae.create(a);return E(s)}async getLoyaltyCardsByCustomerId(a){return(await qe.find({customerId:a}).lean()).map(E)}async setActiveCard(a,s){return await qe.updateMany({customerId:a},{isActive:0}),await qe.findByIdAndUpdate(s,{isActive:1}),!0}async transferPoints(a,s,u,p){let y=await ee.findOne({phone:a});if(!y)return{success:!1,message:"\u0627\u0644\u0645\u0631\u0633\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"};if(!await lt.compare(p,y.password||""))return{success:!1,message:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"};if((y.points||0)<u)return{success:!1,message:"\u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"};let v=await ee.findOne({phone:s});return v?(y.points=(y.points||0)-u,v.points=(v.points||0)+u,await y.save(),await v.save(),{success:!0,message:`\u062A\u0645 \u062A\u062D\u0648\u064A\u0644 ${u} \u0646\u0642\u0637\u0629 \u0625\u0644\u0649 ${v.name}`}):{success:!1,message:"\u0627\u0644\u0645\u0633\u062A\u0644\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"}}async convertPointsToWallet(a,s){let u=await ee.findById(a);if(!u)return{success:!1,message:"\u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"};if(s<100)return{success:!1,message:"\u0627\u0644\u062D\u062F \u0627\u0644\u0623\u062F\u0646\u0649 \u0644\u0644\u0627\u0633\u062A\u0628\u062F\u0627\u0644 100 \u0646\u0642\u0637\u0629"};if((u.points||0)<s)return{success:!1,message:"\u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"};let p=s/100*5;return u.points=(u.points||0)-s,u.walletBalance=(u.walletBalance||0)+p,await u.save(),{success:!0,message:`\u062A\u0645 \u0627\u0633\u062A\u0628\u062F\u0627\u0644 ${s} \u0646\u0642\u0637\u0629 \u0628\u0640 ${p} \u0631\u064A\u0627\u0644`}}async getDiscountCodeByCode(a){let s=a.trim().toLowerCase(),u=await St.findOne({code:s}).lean();if(u)return{...u,id:u._id.toString()}}async incrementDiscountCodeUsage(a){let s=a.trim().toLowerCase();await St.updateOne({code:s},{$inc:{usageCount:1}})}async updateDiscountCode(a,s){let u=await St.findByIdAndUpdate(a,{$set:s},{new:!0}).lean();return u||void 0}async getCustomers(){return(await ee.find({}).lean()).map(E)}async getOrdersByEmployee(a){return(await Z.find({employeeId:a}).sort({createdAt:-1}).lean()).map(E)}async getAllBranches(){return(await Be.find({}).lean()).map(E)}async getCategories(a){let s=a?{tenantId:a}:{};return(await kt.find(s).lean()).map(E)}async createCategory(a){let s=await kt.create(a);return E(s)}async updateCategory(a,s){let u=await kt.findByIdAndUpdate(a,{$set:s},{new:!0}).lean();return u?E(u):void 0}async deleteCategory(a){return!!await kt.findByIdAndDelete(a)}async getTables(a){let s=a?{branchId:a}:{};return(await fe.find(s).lean()).map(E)}async getTable(a){try{if(!a)return;let s=await fe.findOne({id:a}).lean();if(s)return E(s);if(a.match(/^[0-9a-fA-F]{24}$/)){let u=await fe.findById(a).lean();return u?E(u):void 0}return}catch(s){console.error(`[STORAGE] Error fetching table ${a}:`,s);return}}async getTableByQRToken(a){try{let s=await fe.findOne({qrToken:a}).lean();return s?E(s):void 0}catch{return}}async createTable(a){let s=await fe.create(a);return E(s)}async updateTable(a,s){try{if(!a)return;let u=await fe.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return!u&&a.match(/^[0-9a-fA-F]{24}$/)&&(u=await fe.findByIdAndUpdate(a,{$set:s},{new:!0}).lean()),u?E(u):void 0}catch(u){console.error(`[STORAGE] Error updating table ${a}:`,u);return}}async deleteTable(a){try{return a?!!await fe.findOneAndDelete({$or:[{id:a},{_id:a.match(/^[0-9a-fA-F]{24}$/)?a:null}].filter(u=>u._id!==null||u.id!==void 0)}):!1}catch{return!1}}async updateTableOccupancy(a,s,u){let p={isOccupied:s?1:0};return u?p.currentOrderId=u:p.currentOrderId=null,this.updateTable(a,p)}async getPendingTableOrders(a){let s={orderType:"table",status:"pending"};return a&&(s.branchId=a),(await Z.find(s).sort({createdAt:-1}).lean()).map(E)}async getTableOrders(a){return(await Z.find({tableId:a}).sort({createdAt:-1}).lean()).map(E)}async getDeliveryZones(a){let s=a?{tenantId:a}:{};return(await Ke.find(s).lean()).map(E)}async getDeliveryZone(a){let s=await Ke.findById(a).lean();return s?E(s):void 0}async createTaxInvoice(a){let s=await dt.create(a);return E(s)}async getAvailableDrivers(){return(await he.find({role:"driver",isActivated:1}).lean()).map(s=>({...s,id:s._id.toString()}))}async updateDriverAvailability(a,s){await he.findByIdAndUpdate(a,{$set:{isAvailable:s?1:0}})}async updateDriverLocation(a,s,u){await he.findByIdAndUpdate(a,{$set:{"location.lat":s,"location.lng":u}})}async assignDriverToOrder(a,s){await Z.findOneAndUpdate({id:a},{$set:{assignedDriverId:s,status:"assigned"}})}async startDelivery(a){await Z.findOneAndUpdate({id:a},{$set:{status:"shipped",shippedAt:new Date}})}async completeDelivery(a){await Z.findOneAndUpdate({id:a},{$set:{status:"delivered",deliveredAt:new Date}})}async getActiveDeliveryOrders(){return(await Z.find({orderType:"delivery",status:{$in:["pending","assigned","shipped"]}}).lean()).map(E)}async getDriverActiveOrders(a){return(await Z.find({assignedDriverId:a,status:{$in:["assigned","shipped"]}}).lean()).map(E)}async updateCoffeeItem(a,s){let u=await ae.findOneAndUpdate({id:a},{$set:s},{new:!0}).exec();return!u&&a.match(/^[0-9a-fA-F]{24}$/)&&(u=await ae.findByIdAndUpdate(a,{$set:s},{new:!0}).exec()),u?E(u):void 0}async getAddons(a){return(await Le.find({tenantId:a,isAvailable:1}).lean()).map(E)}async getCoffeeItemAddons(a){let u=(await Yt.find({coffeeItemId:a}).lean()).map(y=>y.addonId);return(await Le.find({id:{$in:u},isAvailable:1}).lean()).map(E)}async createOrder(a){try{let s=new Date;s.setHours(0,0,0,0);let u=new Date(s);u.setDate(s.getDate()+1);let y=await Z.countDocuments({tenantId:a.tenantId,createdAt:{$gte:s,$lt:u}})+1,h=y.toString().padStart(4,"0"),v=`ORD-${s.toISOString().split("T")[0].replace(/-/g,"")}-${h}`,D={...a,dailyNumber:y,orderNumber:v};if(!D.items)throw new Error("Order items are missing in storage");if(!D.totalAmount&&D.totalAmount!==0)throw new Error("Order total amount is missing in storage");console.log("[STORAGE] Creating order in DB:",JSON.stringify(D));let O=new Z(D);return await O.save(),E(O)}catch(s){throw console.error("[STORAGE] Database error creating order:",s),s}}async getOrder(a){let s=await Z.findOne({id:a}).lean();return!s&&a.match(/^[0-9a-fA-F]{24}$/)&&(s=await Z.findById(a).lean()),s?E(s):void 0}async getOrderByNumber(a){let s=await Z.findOne({orderNumber:a}).lean();return s?E(s):void 0}async updateOrderStatus(a,s,u,p){let y={status:s,updatedAt:new Date};u&&(y.cancellationReason=u),p!==void 0&&(y.estimatedPrepTimeInMinutes=p,y.prepTimeSetAt=new Date),s==="payment_confirmed"&&(y.paymentStatus="paid",y.status="in_progress");let h=await Z.findOneAndUpdate({id:a},{$set:y},{new:!0}).lean();return!h&&a.match(/^[0-9a-fA-F]{24}$/)&&(h=await Z.findByIdAndUpdate(a,{$set:y},{new:!0}).lean()),h?E(h):void 0}async updateOrderCarPickup(a,s){let u=await Z.findOneAndUpdate({id:a},{$set:{carType:s.carType,carColor:s.carColor,plateNumber:s.plateNumber,updatedAt:new Date}},{new:!0}).lean();return u?E(u):void 0}async getOrders(a=50,s=0){return(await Z.find({}).sort({createdAt:-1}).skip(s).limit(a).lean()).map(E)}async createOrderItem(a){let s=await br.create(a);return E(s)}async getOrderItems(a){return(await br.find({orderId:a}).lean()).map(E)}async getCartItems(a){return(await ve.find({sessionId:a}).lean()).map(E)}async addToCart(a){let s=await ve.create(a);return E(s)}async updateCartItemQuantity(a,s,u){let p=await ve.findOneAndUpdate({sessionId:a,coffeeItemId:s},{$set:{quantity:u}},{new:!0}).lean();return p?E(p):void 0}async removeFromCart(a,s){return(await ve.deleteOne({sessionId:a,coffeeItemId:s})).deletedCount>0}async clearCart(a){return(await ve.deleteMany({sessionId:a})).deletedCount>0}async createLoyaltyCard(a){let s=await qe.create(a);return E(s)}async getLoyaltyCard(a){let s=await qe.findOne({id:a}).lean();return s?E(s):void 0}async getLoyaltyCardByQRToken(a){let s=await qe.findOne({qrToken:a}).lean();return s?E(s):void 0}async getLoyaltyCardByCardNumber(a){let s=await qe.findOne({cardNumber:a}).lean();return s?E(s):void 0}async getLoyaltyCardByPhone(a){let s=await qe.findOne({phoneNumber:a}).lean();return s?E(s):void 0}async getLoyaltyCards(){return(await qe.find({}).lean()).map(E)}async updateLoyaltyCard(a,s){let u=await qe.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async generateCodesForOrder(a,s){let u=[];for(let p of s)for(let y=0;y<p.quantity;y++){let h=at(8).toUpperCase(),v=await Bt.create({code:h,orderId:a,isRedeemed:0});u.push(E(v))}return u}async redeemCode(a,s){let u=await Bt.findOne({code:a,isRedeemed:0});if(!u)return{success:!1,message:"\u0643\u0648\u062F \u063A\u064A\u0631 \u0635\u0627\u0644\u062D \u0623\u0648 \u062A\u0645 \u0627\u0633\u062A\u062E\u062F\u0627\u0645\u0647"};let p=await qe.findOne({id:s});return p?(p.stamps=(p.stamps||0)+1,await p.save(),u.isRedeemed=1,u.redeemedAt=new Date,u.cardId=s,await u.save(),{success:!0,message:"\u062A\u0645 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u062E\u062A\u0645 \u0628\u0646\u062C\u0627\u062D",card:E(p)}):{success:!1,message:"\u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"}}async getCodesByOrder(a){return(await Bt.find({orderId:a}).lean()).map(E)}async getCodeDetails(a){let s=await Bt.findOne({code:a}).lean();return s?E(s):void 0}async createLoyaltyTransaction(a){let s=await tr.create(a);if(a.pointsChange&&a.pointsChange!==0){let u=await qe.findById(a.cardId);if(u){let p=(u.points||0)+a.pointsChange;await qe.findByIdAndUpdate(a.cardId,{points:p})}}return E(s)}async getLoyaltyTransactions(a){return(await tr.find({cardId:a}).sort({createdAt:-1}).lean()).map(E)}async getAllLoyaltyTransactions(a=50){return(await tr.find({}).sort({createdAt:-1}).limit(a).lean()).map(E)}async createLoyaltyReward(a){let s=await rr.create(a);return E(s)}async getLoyaltyRewards(){return(await rr.find({isAvailable:1}).lean()).map(E)}async getLoyaltyReward(a){let s=await rr.findOne({id:a}).lean();return s?E(s):void 0}async getIngredients(){return(await nr.find({}).lean()).map(E)}async createIngredient(a){let s=await nr.create(a);return E(s)}async updateIngredientAvailability(a,s){let u=await nr.findOneAndUpdate({id:a},{$set:{isAvailable:s}},{new:!0}).lean();return u?E(u):void 0}async getCoffeeItemIngredients(a){return(await qt.find({coffeeItemId:a}).lean()).map(E)}async addCoffeeItemIngredient(a,s,u=0,p=""){let y=await qt.create({coffeeItemId:a,ingredientId:s,quantity:u,unit:p});return E(y)}async removeCoffeeItemIngredient(a,s){await qt.deleteOne({coffeeItemId:a,ingredientId:s})}async getCoffeeItemsByIngredient(a){let u=(await qt.find({ingredientId:a}).lean()).map(y=>y.coffeeItemId);return(await ae.find({id:{$in:u}}).lean()).map(E)}async deleteBranch(a){let s=await Be.deleteOne({id:a});if(s.deletedCount===0)try{s=await Be.deleteOne({_id:a})}catch{}return s.deletedCount>0}async getRawItems(){return(await oe.find({}).lean()).map(E)}async getRawItem(a){let s=await oe.findOne({id:a}).lean();return s?E(s):void 0}async getRawItemByCode(a){let s=await oe.findOne({sku:a}).lean();return s?E(s):void 0}async createRawItem(a){let s=await oe.create(a);return E(s)}async updateRawItem(a,s){let u=await oe.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async deleteRawItem(a){return(await oe.deleteOne({id:a})).deletedCount>0}async getSuppliers(){return(await yt.find({}).lean()).map(E)}async getSupplier(a){let s=await yt.findOne({id:a}).lean();return s?E(s):void 0}async getSupplierByCode(a){let s=await yt.findOne({code:a}).lean();return s?E(s):void 0}async createSupplier(a){let s=await yt.create(a);return E(s)}async updateSupplier(a,s){let u=await yt.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async deleteSupplier(a){return(await yt.deleteOne({id:a})).deletedCount>0}async getBranchStock(a){return(await be.find({branchId:a}).lean()).map(E)}async getBranchStockItem(a,s){let u=await be.findOne({branchId:a,rawItemId:s}).lean();return u?E(u):void 0}async updateBranchStock(a,s,u,p,y="adjustment",h=""){let v=await be.findOne({branchId:a,rawItemId:s}),D=v?v.quantity:0;return v?(v.quantity=u,v.updatedAt=new Date,await v.save()):v=await be.create({branchId:a,rawItemId:s,quantity:u,id:at()}),await Re.create({branchId:a,rawItemId:s,quantity:u-D,type:y,previousQuantity:D,newQuantity:u,createdBy:p,notes:h,id:at()}),E(v)}async getLowStockItems(a){let s={};a&&(s.branchId=a);let u=await be.find(s).lean(),p=await oe.find({}).lean(),y=[];for(let h of u){let v=p.find(D=>D.id===h.rawItemId);v&&h.quantity<=(v.minThreshold||0)&&y.push({...h,rawItemName:v.nameAr,minThreshold:v.minThreshold})}return y}async getAllBranchesStock(){return(await be.find({}).lean()).map(E)}async getStockTransfers(a){let s=a?{$or:[{fromBranchId:a},{toBranchId:a}]}:{};return(await Dt.find(s).sort({createdAt:-1}).lean()).map(E)}async getStockTransfer(a){let s=await Dt.findOne({id:a}).lean();return s?E(s):void 0}async createStockTransfer(a){let s=await Dt.create(a);return E(s)}async updateStockTransferStatus(a,s,u){let p={status:s};u&&(p.approvedBy=u);let y=await Dt.findOneAndUpdate({id:a},{$set:p},{new:!0}).lean();return y?E(y):void 0}async completeStockTransfer(a,s){let u=await Dt.findOne({id:a});if(!(!u||u.status!=="approved")){for(let p of u.items){let y=await be.findOne({branchId:u.fromBranchId,rawItemId:p.rawItemId});y&&(y.quantity-=p.quantity,await y.save());let h=await be.findOne({branchId:u.toBranchId,rawItemId:p.rawItemId});h?(h.quantity+=p.quantity,await h.save()):await be.create({branchId:u.toBranchId,rawItemId:p.rawItemId,quantity:p.quantity,id:at()})}return u.status="completed",u.completedBy=s,u.completedAt=new Date,await u.save(),E(u)}}async getPurchaseInvoices(a){let s=a?{branchId:a}:{};return(await gt.find(s).sort({createdAt:-1}).lean()).map(E)}async getPurchaseInvoice(a){let s=await gt.findOne({id:a}).lean();return s?E(s):void 0}async createPurchaseInvoice(a){let s=await gt.create(a);return E(s)}async updatePurchaseInvoice(a,s){let u=await gt.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async receivePurchaseInvoice(a,s){let u=await gt.findOne({id:a});if(!(!u||u.status==="received")){for(let p of u.items){let y=await be.findOne({branchId:u.branchId,rawItemId:p.rawItemId});y?(y.quantity+=p.quantity,await y.save()):await be.create({branchId:u.branchId,rawItemId:p.rawItemId,quantity:p.quantity,id:at()})}u.status="received",u.receivedBy=s,u.receivedDate=new Date,await u.save();try{let p=await Be.findOne({id:u.branchId});if(p){let y=p.tenantId,h=await te.findOne({tenantId:y,accountNumber:"1130"}),v=await te.findOne({tenantId:y,accountNumber:"2110"}),D=await te.findOne({tenantId:y,accountNumber:"1111"}),O=u.paymentStatus==="paid"?D:v;h&&O&&await ce.createJournalEntry({tenantId:y,entryDate:u.invoiceDate||new Date,description:`\u0627\u0633\u062A\u0644\u0627\u0645 \u0645\u0634\u062A\u0631\u064A\u0627\u062A - \u0641\u0627\u062A\u0648\u0631\u0629 \u0631\u0642\u0645 ${u.invoiceNumber}`,lines:[{accountId:h.id,accountNumber:h.accountNumber,accountName:h.nameAr||h.nameEn||"\u0627\u0644\u0645\u062E\u0632\u0648\u0646",debit:u.totalAmount,credit:0,branchId:u.branchId},{accountId:O.id,accountNumber:O.accountNumber,accountName:O.nameAr||O.nameEn||(u.paymentStatus==="paid"?"\u0627\u0644\u0635\u0646\u062F\u0648\u0642":"\u0627\u0644\u0645\u0648\u0631\u062F\u064A\u0646"),debit:0,credit:u.totalAmount,branchId:u.branchId}],referenceType:"purchase",referenceId:u.id,createdBy:s,autoPost:!0})}}catch(p){console.error("Failed to create journal entry for purchase invoice:",p)}return E(u)}}async updatePurchaseInvoicePayment(a,s){let u=await gt.findOne({id:a});if(u)return u.paidAmount=(u.paidAmount||0)+s,u.paymentStatus=u.paidAmount>=(u.totalAmount||0)?"paid":"partial",await u.save(),E(u)}async getAllRecipeItems(){return(await Ne.find({}).lean()).map(E)}async getRecipeItems(a){return(await Ne.find({coffeeItemId:a}).lean()).map(E)}async createRecipeItem(a){let s=await Ne.create(a);return E(s)}async updateRecipeItem(a,s){let u=await Ne.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();return u?E(u):void 0}async deleteRecipeItem(a){return(await Ne.deleteOne({id:a})).deletedCount>0}async calculateProductCost(a){let s=await Ne.find({coffeeItemId:a}).lean(),u=0;for(let p of s){let y=await oe.findOne({id:p.rawItemId}).lean();y&&y.lastCost&&(u+=Number(y.lastCost)*p.quantity)}return u}async getStockAlerts(a,s=!1){let u={resolved:s};return a&&(u.branchId=a),(await Ve.find(u).sort({createdAt:-1}).lean()).map(E)}async createStockAlert(a,s,u,p,y){let h=await Ve.create({branchId:a,rawItemId:s,alertType:u,currentQuantity:p,thresholdQuantity:y,id:at()});return E(h)}async resolveStockAlert(a,s){let u=await Ve.findOneAndUpdate({id:a},{$set:{resolved:!0,resolvedBy:s,resolvedAt:new Date}},{new:!0}).lean();return u?E(u):void 0}async markAlertAsRead(a){let s=await Ve.findOneAndUpdate({id:a},{$set:{isRead:1}},{new:!0}).lean();return s?E(s):void 0}async getStockMovements(a,s,u=100){let p={branchId:a};return s&&(p.rawItemId=s),(await Re.find(p).sort({createdAt:-1}).limit(u).lean()).map(E)}async createStockMovement(a){let s=await Re.create(a);return E(s)}async deductInventoryForOrder(a,s,u,p){let y=[],h=[],v=0;for(let D of u){let O=await Ne.find({coffeeItemId:D.coffeeItemId}).lean();for(let M of O){let B=await be.findOne({branchId:s,rawItemId:M.rawItemId}),F=await oe.findOne({id:M.rawItemId}).lean(),z=M.quantity*D.quantity;if(B&&B.currentQuantity>=z){let ne=B.currentQuantity;B.currentQuantity-=z,B.lastUpdated=new Date,await B.save();let H=Number(F?.lastCost||0),Y=H*z;v+=Y;let ue={rawItemId:M.rawItemId,rawItemName:F?.nameAr||"Unknown",quantity:z,unit:M.unit,unitCost:H,totalCost:Y,previousQuantity:ne,newQuantity:B.currentQuantity,status:"deducted",message:"Successfully deducted (Recipe)"};y.push(ue),await Re.create({id:at(),branchId:s,rawItemId:M.rawItemId,movementType:"sale",quantity:z,previousQuantity:ne,newQuantity:B.currentQuantity,referenceType:"order",referenceId:a,createdBy:p,notes:`Order #${a} - Recipe Item`})}else h.push({rawItemId:M.rawItemId,rawItemName:F?.nameAr||"Unknown",required:z,available:B?B.currentQuantity:0,unit:M.unit})}if(D.addons&&Array.isArray(D.addons))for(let M of D.addons){if(!M.rawItemId)continue;let B=await be.findOne({branchId:s,rawItemId:M.rawItemId}),F=await oe.findOne({id:M.rawItemId}).lean(),z=(M.quantity||1)*D.quantity;if(B&&B.currentQuantity>=z){let ne=B.currentQuantity;B.currentQuantity-=z,B.lastUpdated=new Date,await B.save();let H=Number(F?.lastCost||0),Y=H*z;v+=Y;let ue={rawItemId:M.rawItemId,rawItemName:F?.nameAr||"Unknown",quantity:z,unit:M.unit||F?.unit||"unit",unitCost:H,totalCost:Y,previousQuantity:ne,newQuantity:B.currentQuantity,status:"deducted",message:"Successfully deducted (Addon)"};y.push(ue),await Re.create({id:at(),branchId:s,rawItemId:M.rawItemId,movementType:"sale",quantity:z,previousQuantity:ne,newQuantity:B.currentQuantity,referenceType:"order",referenceId:a,createdBy:p,notes:`Order #${a} - Addon Item`})}else h.push({rawItemId:M.rawItemId,rawItemName:F?.nameAr||"Unknown",required:z,available:B?B.currentQuantity:0,unit:M.unit||"unit"})}}return await Z.findOneAndUpdate({id:a},{$set:{costOfGoods:v,inventoryDeducted:h.length===0?1:2,inventoryDeductionDetails:y,updatedAt:new Date}}),{success:h.length===0,costOfGoods:v,grossProfit:0,deductionDetails:y,shortages:h,warnings:[],errors:[]}}async calculateOrderCOGS(a,s){let u=0,p=[];for(let y of a){let h=await Ne.find({coffeeItemId:y.coffeeItemId}).lean(),v=[],D=0;for(let O of h){let M=await oe.findOne({id:O.rawItemId}).lean(),B=Number(M?.lastCost||0),F=O.quantity*y.quantity,z=B*F;D+=z,v.push({rawItemId:O.rawItemId,rawItemName:M?.nameAr||"Unknown",quantity:F,unit:O.unit,unitCost:B,totalCost:z})}u+=D,p.push({coffeeItemId:y.coffeeItemId,coffeeItemName:"Unknown",quantity:y.quantity,unitCost:D/y.quantity,totalCost:D,ingredients:v})}return{totalCost:u,itemBreakdown:p,shortages:[]}}async getBranches(a){return(await Be.find({cafeId:a}).lean()).map(E)}async getBranch(a){let s=await Be.findOne({id:a}).lean();if(!s)try{s=await Be.findById(a).lean()}catch{}return s?E(s):null}async createBranch(a){let s=await Be.create(a);return E(s)}async updateBranch(a,s){let u=await Be.findOneAndUpdate({id:a},{$set:s},{new:!0}).lean();if(!u)try{u=await Be.findByIdAndUpdate(a,{$set:s},{new:!0}).lean()}catch{}return u?E(u):null}async getCustomer(a){try{return!a||a==="null"||a==="undefined"?void 0:typeof a=="string"&&a.match(/^[0-9a-fA-F]{24}$/)?await ee.findById(a)||void 0:await ee.findOne({id:a})||void 0}catch(s){console.error(`[STORAGE] Error fetching customer ${a}:`,s);return}}async getCustomerByPhone(a){return await ee.findOne({phone:a})||void 0}async getCustomerByEmail(a){return await ee.findOne({email:a})||void 0}async createCustomer(a){return await ee.create(a)}async updateCustomer(a,s){return await ee.findByIdAndUpdate(a,{$set:s},{new:!0})||void 0}async getCustomerOrders(a){return(await Z.find({customerId:a}).sort({createdAt:-1}).lean()).map(E)}async verifyCustomerPassword(a,s){let u=await ee.findOne({phone:a});if(u&&u.password&&await lt.compare(s,u.password))return u}async resetCustomerPassword(a,s){let u=await lt.hash(s,10);return(await ee.updateOne({email:a},{password:u})).modifiedCount>0}async createPasswordResetToken(a){let s=at(32),u=new Date(Date.now()+36e5);return await Jt.create({email:a,token:s,expiresAt:u}),{token:s,expiresAt:u}}async verifyPasswordResetToken(a){let s=await Jt.findOne({token:a,used:0,expiresAt:{$gt:new Date}});return s?{valid:!0,email:s.email}:{valid:!1}}async usePasswordResetToken(a){return(await Jt.updateOne({token:a},{used:1})).modifiedCount>0}async createPasswordSetupOTP(a){let s=Math.floor(1e5+Math.random()*9e5).toString(),u=new Date(Date.now()+6e5);return await Kt.create({phone:a,otp:s,expiresAt:u}),{otp:s,expiresAt:u}}async verifyPasswordSetupOTP(a,s){return await Kt.findOne({phone:a,otp:s,used:0,expiresAt:{$gt:new Date}})?{valid:!0}:{valid:!1,message:"\u0643\u0648\u062F \u063A\u064A\u0631 \u0635\u0627\u0644\u062D \u0623\u0648 \u0645\u0646\u062A\u0647\u064A \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629"}}async invalidatePasswordSetupOTP(a,s){return(await Kt.updateOne({phone:a,otp:s},{used:1})).modifiedCount>0}},f=new bn;T();T();var Er=class{static async calculateRecipeCost(a){let s=[],u=0,p=[];for(let y of a){let h=await oe.findOne({_id:y.rawItemId});if(!h){s.push(`Raw item ${y.rawItemId} not found`);continue}if(!y.quantity||y.quantity<=0){s.push(`Ingredient ${h.nameAr} must have quantity > 0`);continue}if(!["g","ml","kg","l","pieces","pcs","box"].includes(y.unit.toLowerCase())){s.push(`Unit "${y.unit}" not supported`);continue}let D=h.unitCost||h.costPerUnit||0,M=this.convertUnits(y.quantity,y.unit,h.unit)*D;u+=M,p.push({rawItemId:y.rawItemId,quantity:y.quantity,unit:y.unit,rawItemName:h.nameAr,unitCost:D,totalCost:M})}return{success:s.length===0,totalCost:parseFloat(u.toFixed(2)),ingredients:p,errors:s.length>0?s:void 0}}static async createRecipe(a,s,u,p){try{if(!await ae.findOne({_id:a}))return{success:!1,error:`Coffee item ${a} not found`};let h=await this.calculateRecipeCost(p);if(!h.success)return{success:!1,error:`Recipe validation failed: ${h.errors?.join(", ")}`};let D=((await or.findOne({coffeeItemId:a}).sort({version:-1}).limit(1))?.version||0)+1,O=new or({coffeeItemId:a,nameAr:s,nameEn:u,version:D,isActive:!0,totalCost:h.totalCost,ingredients:h.ingredients});return await O.save(),{success:!0,recipe:O}}catch(y){return{success:!1,error:String(y)}}}static async getActiveRecipe(a){return or.findOne({coffeeItemId:a,isActive:!0}).sort({version:-1})}static async freezeRecipeSnapshot(a){let s=await this.getActiveRecipe(a);return s?{totalCost:s.totalCost,ingredients:s.ingredients}:null}static calculateProfit(a,s){let u=a-s,p=a>0?u/a*100:0;return{profitAmount:parseFloat(u.toFixed(2)),profitMargin:parseFloat(p.toFixed(2))}}static async calculateModifiersCost(a){let s=[],u=0,p=[];for(let y of a){let h=await Le.findOne({id:y.modifierId});if(h||(h=await Le.findById(y.modifierId)),!h)continue;let v=(h.price||0)*y.quantity,D=0;if(h.rawItemId&&h.quantityPerUnit){let M=await oe.findOne({_id:h.rawItemId});if(M){let B=M.unitCost||M.costPerUnit||0;D=h.quantityPerUnit*y.quantity*B}}let O=D;u+=O,p.push({modifierId:y.modifierId,modifierName:h.nameAr,quantity:y.quantity,priceImpact:v,recipeCost:D,totalCost:O})}return{success:s.length===0,totalCost:parseFloat(u.toFixed(2)),modifiers:p,errors:s.length>0?s:void 0}}static async createOrderItemCostSnapshot(a,s,u,p){let y=await this.getActiveRecipe(a),h=y?y.totalCost:0,v=y?y.ingredients:[],D=0,O=[];if(p&&p.length>0){let H=await this.calculateModifiersCost(p);D=H.totalCost,O=H.modifiers}let B=(h+D)*u,F=s*u,{profitAmount:z,profitMargin:ne}=this.calculateProfit(F,B);return{baseRecipeCost:h,modifiersCost:D,totalCost:B,sellingPrice:F,profitAmount:z,profitMargin:ne,ingredients:v,modifiers:O,snapshotTime:new Date}}static async calculateOrderCOGS(a){let s=[],u=0,p=0;for(let v of a){let O=(v.selectedAddons||v.addons||v.customization?.selectedAddons||[]).map(B=>({modifierId:B.id||B.addonId||B.modifierId||B._id,quantity:B.quantity||1})),M=await this.createOrderItemCostSnapshot(v.coffeeItemId,v.price,v.quantity,O);M&&(s.push(M),u+=M.totalCost,p+=M.sellingPrice)}let y=p-u,h=p>0?y/p*100:0;return{totalCOGS:parseFloat(u.toFixed(2)),totalRevenue:parseFloat(p.toFixed(2)),totalProfit:parseFloat(y.toFixed(2)),profitMargin:parseFloat(h.toFixed(2)),itemSnapshots:s}}static convertUnits(a,s,u){let p=s.toLowerCase().trim(),y=u.toLowerCase().trim();return p===y?a:(p==="ml"||p==="milliliter")&&(y==="l"||y==="liter")?a/1e3:(p==="l"||p==="liter")&&(y==="ml"||y==="milliliter")?a*1e3:(p==="g"||p==="gram")&&(y==="kg"||y==="kilogram")?a/1e3:(p==="kg"||p==="kilogram")&&(y==="g"||y==="gram")?a*1e3:a}};T();T();var zt={WEIGHT:["g","kg"],VOLUME:["ml","l"],PIECES:["pcs","piece","box"]},ms={"g-kg":1e3,"kg-g":.001,"ml-l":1e3,"l-ml":.001},dr=class{static normalize(a,s){switch(s.toLowerCase().trim()){case"kg":return a*1e3;case"l":return a*1e3;default:return a}}static format(a,s,u){let p=s.toLowerCase().trim(),y=u.toLowerCase().trim();return p===y?a:p==="g"&&y==="kg"||p==="ml"&&y==="l"?a/1e3:p==="kg"&&y==="g"||p==="l"&&y==="ml"?a*1e3:a}static getBaseUnit(a){let s=a.toLowerCase().trim();return s==="kg"?"g":s==="l"?"ml":s}static isValidUnit(a){let s=a.toLowerCase().trim();return zt.WEIGHT.includes(s)||zt.VOLUME.includes(s)||zt.PIECES.includes(s)}static getUnitType(a){let s=a.toLowerCase().trim();return zt.WEIGHT.includes(s)?"weight":zt.VOLUME.includes(s)?"volume":zt.PIECES.includes(s)?"pieces":null}static convert(a,s,u){let p=s.toLowerCase().trim(),y=u.toLowerCase().trim();if(p===y)return{success:!0,convertedQuantity:a};if(!this.isValidUnit(p))return{success:!1,convertedQuantity:a,error:`Unit "${p}" not supported`};if(!this.isValidUnit(y))return{success:!1,convertedQuantity:a,error:`Unit "${y}" not supported`};let h=this.getUnitType(p),v=this.getUnitType(y);if(h!==v)return{success:!1,convertedQuantity:a,error:`Cannot convert ${p} (${h}) to ${y} (${v})`};let D=`${p}-${y}`,O=ms[D];return O?{success:!0,convertedQuantity:parseFloat((a*O).toFixed(4))}:{success:!1,convertedQuantity:a,error:`No conversion rule for ${p} \u2192 ${y}`}}static normalizeToBase(a,s){let u=s.toLowerCase().trim();return u==="kg"?{quantity:a*1e3,baseUnit:"g"}:u==="l"?{quantity:a*1e3,baseUnit:"ml"}:{quantity:a,baseUnit:u}}static async getStorageUnit(a){return(await oe.findById(a))?.unit||null}static async convertToStorageUnit(a,s,u){let p=await this.getStorageUnit(a);if(!p)return{success:!1,quantity:s,storageUnit:"",error:`Ingredient ${a} not found`};let y=this.convert(s,u,p);return y.success?{success:!0,quantity:y.convertedQuantity,storageUnit:p}:{success:!1,quantity:s,storageUnit:p,error:y.error}}static async convertBulkToStorageUnits(a){let s=[],u=[];for(let p of a){let y=await this.convertToStorageUnit(p.rawItemId,p.quantity,p.unit);y.success?u.push({rawItemId:p.rawItemId,quantity:y.quantity,storageUnit:y.storageUnit}):s.push(`Item ${p.rawItemId}: ${y.error||"Unknown error"}`)}return{success:s.length===0,items:u,errors:s}}};var wt=class{static async getIngredient(a){return oe.findById(a)}static async getIngredientByName(a){return oe.findOne({nameAr:a})}static async recordStockIn(a){try{if(!await this.getIngredient(a.rawItemId))return{success:!1,error:"Ingredient not found"};let u=await dr.convertToStorageUnit(a.rawItemId,a.quantity,a.unit);if(!u.success)return{success:!1,error:u.error};let p=await be.findOne({branchId:a.branchId,rawItemId:a.rawItemId}),y=p?.currentQuantity||0,h=y+u.quantity;p?p.currentQuantity=h:p=new be({branchId:a.branchId,rawItemId:a.rawItemId,currentQuantity:h,reservedQuantity:0}),await p.save();let v=new Re({branchId:a.branchId,rawItemId:a.rawItemId,movementType:"purchase",quantity:u.quantity,previousQuantity:y,newQuantity:h,referenceType:"purchase_invoice",notes:a.notes,createdBy:a.createdBy});return await v.save(),{success:!0,newQuantity:h,movement:v}}catch(s){return{success:!1,error:String(s)}}}static async recordStockOut(a){try{if(!await this.getIngredient(a.rawItemId))return{success:!1,error:"Ingredient not found"};let u=await dr.convertToStorageUnit(a.rawItemId,a.quantity,a.unit);if(!u.success)return{success:!1,error:u.error};let p=await be.findOne({branchId:a.branchId,rawItemId:a.rawItemId});if(!p)return{success:!1,error:"No stock record for this item"};let y=p.currentQuantity;if(y-u.quantity<0)return{success:!1,error:`Insufficient stock. Available: ${y}${u.storageUnit}, Requested: ${u.quantity}${u.storageUnit}`};let h=y-u.quantity;p.currentQuantity=h,await p.save();let v=new Re({branchId:a.branchId,rawItemId:a.rawItemId,movementType:a.movementType,quantity:-u.quantity,previousQuantity:y,newQuantity:h,notes:a.notes,createdBy:a.createdBy});return await v.save(),await this.checkAndCreateAlerts(a.branchId,a.rawItemId),{success:!0,newQuantity:h,movement:v}}catch(s){return{success:!1,error:String(s)}}}static async deductFromOrder(a){let s=[],u=[];for(let p of a.items){let y=await this.recordStockOut({branchId:a.branchId,rawItemId:p.rawItemId,quantity:p.quantity,unit:p.unit,movementType:"adjustment",notes:`Order: ${a.orderId}`,createdBy:a.createdBy});y.success?s.push({rawItemId:p.rawItemId,previousQty:y.movement?.previousQuantity||0,deductedQty:p.quantity,newQty:y.newQuantity||0}):u.push(`${p.rawItemId}: ${y.error}`)}return{success:u.length===0,deductions:s,errors:u}}static async getStockLevel(a,s){let u=await be.findOne({branchId:a,rawItemId:s});if(!u)return null;let p=await this.getIngredient(s);if(!p)return null;let y="sufficient";return u.currentQuantity===0?y="out_of_stock":u.currentQuantity<=(p.minStockLevel||0)&&(y="low"),{currentQuantity:u.currentQuantity,unit:p.unit,minThreshold:p.minStockLevel||0,status:y}}static async checkAndCreateAlerts(a,s){let u=await be.findOne({branchId:a,rawItemId:s});if(!u)return;let p=await this.getIngredient(s);if(!p)return;await Ve.deleteMany({branchId:a,rawItemId:s,isResolved:0});let y=null;u.currentQuantity===0?y="out_of_stock":u.currentQuantity<=(p.minStockLevel||0)&&(y="low_stock"),y&&await new Ve({branchId:a,rawItemId:s,alertType:y,currentQuantity:u.currentQuantity,thresholdQuantity:p.minStockLevel||0}).save()}static async getActiveAlerts(a){return Ve.find({branchId:a,isResolved:0}).sort({createdAt:-1})}static async getLowStockItems(a){let s=await Ve.find({branchId:a,alertType:"low_stock",isResolved:0}),u=[];for(let p of s){let y=await this.getIngredient(p.rawItemId);y&&u.push({rawItemId:p.rawItemId,nameAr:y.nameAr,currentQuantity:p.currentQuantity,minThreshold:p.thresholdQuantity,unit:y.unit})}return u}static async resolveAlert(a,s){return!!await Ve.findByIdAndUpdate(a,{isResolved:1,resolvedBy:s,resolvedAt:new Date},{new:!0})}static async getMovementHistory(a,s,u=100){return Re.find({branchId:a,rawItemId:s}).sort({createdAt:-1}).limit(u)}};T();var ot=class{static async getDailySnapshot(a,s){let u=s||new Date,p=new Date(u);p.setHours(0,0,0,0);let y=new Date(u);y.setHours(23,59,59,999);let h=await Z.find({branchId:a,createdAt:{$gte:p,$lte:y},status:{$in:["completed","delivered"]}}),v=0,D=0,O=0;for(let H of h)v+=H.totalAmount||0,H.costOfGoods!==void 0&&H.costOfGoods>0&&(D+=H.costOfGoods,O++);let M=v-D,B=v>0?M/v*100:0,F=await Re.find({branchId:a,movementType:"waste",createdAt:{$gte:p,$lte:y}}),z=0;for(let H of F){let Y=await this.getRawItemCost(H.rawItemId);Y&&(z+=Math.abs(H.quantity)*Y.costPerUnit)}let ne=v>0?z/v*100:0;return{date:u.toISOString().split("T")[0],salesCount:h.length,totalRevenue:parseFloat(v.toFixed(2)),totalCOGS:parseFloat(D.toFixed(2)),grossProfit:parseFloat(M.toFixed(2)),profitMargin:parseFloat(B.toFixed(2)),wasteAmount:parseFloat(z.toFixed(2)),wastePercentage:parseFloat(ne.toFixed(2))}}static async getProfitPerDrink(a,s,u){let p=await Z.find({branchId:a,createdAt:{$gte:s,$lte:u},status:{$in:["completed","delivered"]}}),y={};for(let h of p)if(!(!h.items||!Array.isArray(h.items)))for(let v of h.items){let D=v.menuItemId||v.coffeeItemId||"unknown",O=v.name||"Unknown Item",M=v.category||"Uncategorized",B=v.quantity||1,F=v.price||v.unitPrice||0;y[D]||(y[D]={name:O,category:M,quantity:0,revenue:0,cogs:0}),y[D].quantity+=B,y[D].revenue+=F*B,h.costOfGoods&&h.items.length>0&&(y[D].cogs+=h.costOfGoods/h.items.length*B)}return Object.entries(y).map(([h,v])=>{let D=v.revenue-v.cogs,O=v.revenue>0?D/v.revenue*100:0,M=v.quantity>0?D/v.quantity:0;return{itemId:h,itemName:v.name,category:v.category,quantitySold:v.quantity,totalRevenue:parseFloat(v.revenue.toFixed(2)),totalCOGS:parseFloat(v.cogs.toFixed(2)),totalProfit:parseFloat(D.toFixed(2)),profitMargin:parseFloat(O.toFixed(2)),profitPerUnit:parseFloat(M.toFixed(2))}})}static async getProfitPerCategory(a,s,u){let p=await this.getProfitPerDrink(a,s,u),y={};for(let h of p){let v=h.category||"Other";y[v]||(y[v]={quantity:0,revenue:0,cogs:0}),y[v].quantity+=h.quantitySold,y[v].revenue+=h.totalRevenue,y[v].cogs+=h.totalCOGS}return Object.entries(y).map(([h,v])=>{let D=v.revenue-v.cogs,O=v.revenue>0?D/v.revenue*100:0;return{category:h,quantitySold:v.quantity,totalRevenue:parseFloat(v.revenue.toFixed(2)),totalCOGS:parseFloat(v.cogs.toFixed(2)),totalProfit:parseFloat(D.toFixed(2)),profitMargin:parseFloat(O.toFixed(2))}})}static async getTopProfitableItems(a,s,u,p=10){return(await this.getProfitPerDrink(a,s,u)).sort((h,v)=>v.totalProfit-h.totalProfit).slice(0,p).map(h=>({itemId:h.itemId,itemName:h.itemName,quantitySold:h.quantitySold,totalProfit:h.totalProfit,profitMargin:h.profitMargin}))}static async getWorstItems(a,s,u,p=10){return(await this.getProfitPerDrink(a,s,u)).map(v=>{let D="";return v.profitMargin<0?D="Loss - selling below cost":v.profitMargin<10?D="Very low margin (< 10%)":v.profitMargin<30?D="Low margin (10-30%)":v.quantitySold<5&&(D="Low sales volume"),{...v,reasonForLoss:D}}).filter(v=>v.reasonForLoss).sort((v,D)=>v.profitMargin-D.profitMargin).slice(0,p)}static async getWasteReport(a,s,u){let p=await Re.find({branchId:a,movementType:"waste",createdAt:{$gte:s,$lte:u}}),y=[];for(let h of p){let v=await this.getRawItemInfo(h.rawItemId);if(v){let D=Math.abs(h.quantity)*(v.costPerUnit||0);y.push({rawItemName:v.nameAr,quantity:Math.abs(h.quantity),unit:v.unit,wasteAmount:parseFloat(D.toFixed(2)),notes:h.notes||"No reason specified",createdAt:h.createdAt})}}return y.sort((h,v)=>v.wasteAmount-h.wasteAmount)}static async saveDailySnapshot(a,s,u,p){try{let y=p||new Date,h=await this.getDailySnapshot(s,y),D=(await this.getProfitPerDrink(s,new Date(y.setHours(0,0,0,0)),new Date(y.setHours(23,59,59,999)))).sort((M,B)=>B.totalRevenue-M.totalRevenue).slice(0,5).map(M=>({productId:M.itemId,productName:M.itemName,quantity:M.quantitySold,revenue:M.totalRevenue})),O=new Pr({tenantId:a,branchId:s,snapshotDate:y,snapshotType:"daily",periodStart:new Date(y),periodEnd:new Date(y),totalRevenue:h.totalRevenue,totalOrders:h.salesCount,averageOrderValue:h.salesCount>0?h.totalRevenue/h.salesCount:0,totalCostOfGoods:h.totalCOGS,wasteAmount:h.wasteAmount,wastePercentage:h.wastePercentage,grossProfit:h.grossProfit,grossProfitMargin:h.profitMargin,topProductsByRevenue:D,createdBy:u,isApproved:0});return await O.save(),O}catch(y){return console.error("Error saving daily snapshot:",y),null}}static async getSnapshots(a,s,u,p){return Pr.find({tenantId:a,branchId:s,snapshotDate:{$gte:u,$lte:p}}).sort({snapshotDate:-1})}static async getRawItemCost(a){try{let{RawItemModel:s}=await Promise.resolve().then(()=>(T(),R)),u=await s.findById(a);return u?{costPerUnit:u.unitCost||0}:null}catch{return null}}static async getRawItemInfo(a){try{let{RawItemModel:s}=await Promise.resolve().then(()=>(T(),R)),u=await s.findById(a);return u?{nameAr:u.nameAr||"Unknown",unit:u.unit||"piece",costPerUnit:u.unitCost||0}:null}catch{return null}}};T();import{nanoid as Mr}from"nanoid";import*as st from"@turf/turf";var Hn=2,ps=5,hn=class{async getAllIntegrations(a){return Je.find({tenantId:a}).sort({createdAt:-1})}async getIntegration(a){return Je.findOne({id:a})}async createIntegration(a){return new Je({...a,id:Mr(),createdAt:new Date,updatedAt:new Date}).save()}async updateIntegration(a,s){return Je.findOneAndUpdate({id:a},{...s,updatedAt:new Date},{new:!0})}async deleteIntegration(a){return(await Je.deleteOne({id:a})).deletedCount>0}async getAllZones(a,s){let u={tenantId:a};return s&&(u.branchId=s),Ke.find(u).sort({priority:-1})}async getZone(a){return Ke.findOne({id:a})}async createZone(a){return new Ke({...a,id:Mr(),createdAt:new Date,updatedAt:new Date}).save()}async updateZone(a,s){return Ke.findOneAndUpdate({id:a},{...s,updatedAt:new Date},{new:!0})}async deleteZone(a){return(await Ke.deleteOne({id:a})).deletedCount>0}async getAllDrivers(a,s){let u={tenantId:a};return s&&(u.branchId=s),Ue.find(u).sort({createdAt:-1})}async getAvailableDrivers(a,s){let u={tenantId:a,status:"available",isActive:1};return s&&(u.branchId=s),Ue.find(u)}async getDriver(a){return Ue.findOne({id:a})}async getDriverByPhone(a){return Ue.findOne({phone:a,isActive:1})}async createDriver(a){return new Ue({...a,id:Mr(),status:"offline",totalDeliveries:0,totalEarnings:0,rating:5,ratingCount:0,isActive:1,createdAt:new Date,updatedAt:new Date}).save()}async updateDriver(a,s){return Ue.findOneAndUpdate({id:a},{...s,updatedAt:new Date},{new:!0})}async updateDriverLocation(a,s,u){return Ue.findOneAndUpdate({id:a},{currentLat:s,currentLng:u,lastLocationUpdate:new Date,updatedAt:new Date},{new:!0})}async updateDriverStatus(a,s){return Ue.findOneAndUpdate({id:a},{status:s,updatedAt:new Date},{new:!0})}async deleteDriver(a){return(await Ue.deleteOne({id:a})).deletedCount>0}async getAllDeliveryOrders(a,s){let u={tenantId:a};return s?.branchId&&(u.branchId=s.branchId),s?.status&&(u.status=s.status),s?.driverId&&(u.driverId=s.driverId),(s?.fromDate||s?.toDate)&&(u.createdAt={},s.fromDate&&(u.createdAt.$gte=s.fromDate),s.toDate&&(u.createdAt.$lte=s.toDate)),Ge.find(u).sort({createdAt:-1})}async getDeliveryOrder(a){return Ge.findOne({id:a})}async getDeliveryOrderByOrderId(a){return Ge.findOne({orderId:a})}async getPendingOrdersForDriver(a,s){let u={tenantId:a,status:{$in:["pending","accepted"]},deliveryType:"internal"};return s&&(u.branchId=s),Ge.find(u).sort({createdAt:1})}async getDriverActiveOrders(a){return Ge.find({driverId:a,status:{$in:["assigned","picking_up","on_the_way","arrived"]}}).sort({createdAt:1})}async createDeliveryOrder(a){let s=a.distanceKm||this.calculateDistance(a.branchLat||0,a.branchLng||0,a.customerLat||0,a.customerLng||0),u=Math.ceil(s*Hn),p=a.preparationMinutes||0,y=u+p,h=new Date,v=new Date(h.getTime()+p*6e4),D=new Date(h.getTime()+y*6e4);return new Ge({...a,id:Mr(),distanceKm:s,travelMinutes:u,totalEstimatedMinutes:y,estimatedPickupTime:v,estimatedDeliveryTime:D,status:"pending",trackingHistory:[{lat:a.branchLat||0,lng:a.branchLng||0,timestamp:h,status:"pending"}],createdAt:h,updatedAt:h}).save()}async updateDeliveryOrder(a,s){return Ge.findOneAndUpdate({id:a},{...s,updatedAt:new Date},{new:!0})}async assignDriverToOrder(a,s){let u=await this.getDriver(s);if(!u)return null;let p=await Ge.findOneAndUpdate({id:a},{driverId:s,driverName:u.fullName,driverPhone:u.phone,status:"assigned",driverCurrentLat:u.currentLat,driverCurrentLng:u.currentLng,driverLastUpdate:new Date,updatedAt:new Date,$push:{trackingHistory:{lat:u.currentLat||0,lng:u.currentLng||0,timestamp:new Date,status:"assigned"}}},{new:!0});return p&&(await this.updateDriverStatus(s,"busy"),await Ue.findOneAndUpdate({id:s},{currentOrderId:a})),p}async updateOrderStatus(a,s,u){let p={status:s,updatedAt:new Date,...u};s==="picking_up"?p.actualPickupTime=new Date:s==="delivered"&&(p.actualDeliveryTime=new Date);let y=await Ge.findOneAndUpdate({id:a},{...p,$push:{trackingHistory:{lat:u?.driverCurrentLat||0,lng:u?.driverCurrentLng||0,timestamp:new Date,status:s}}},{new:!0});return y&&(s==="delivered"||s==="cancelled"||s==="returned")&&y.driverId&&(await this.updateDriverStatus(y.driverId,"available"),await Ue.findOneAndUpdate({id:y.driverId},{currentOrderId:null,$inc:s==="delivered"?{totalDeliveries:1}:{}})),y}async updateOrderDriverLocation(a,s,u){return Ge.findOneAndUpdate({id:a},{driverCurrentLat:s,driverCurrentLng:u,driverLastUpdate:new Date,updatedAt:new Date},{new:!0})}calculateDistance(a,s,u,p){let y=st.point([s,a]),h=st.point([p,u]);return st.distance(y,h,{units:"kilometers"})}calculateETA(a,s){let u=Math.ceil(a*Hn),p=s*ps,y=u+p,h=new Date(Date.now()+y*6e4);return{travelMinutes:u,preparationMinutes:p,totalMinutes:y,estimatedDeliveryTime:h}}async checkPointInZone(a,s,u,p){let h=(await this.getAllZones(u,p)).filter(v=>v.isActive===1);for(let v of h)if(v.zoneType==="polygon"&&v.boundary&&v.boundary.length>=3){let D=st.polygon([v.boundary.map(M=>[M.lng,M.lat]).concat([[v.boundary[0].lng,v.boundary[0].lat]])]),O=st.point([s,a]);if(st.booleanPointInPolygon(O,D))return v}else if(v.zoneType==="radius"&&v.centerLat&&v.centerLng&&v.radiusKm&&this.calculateDistance(v.centerLat,v.centerLng,a,s)<=v.radiusKm)return v;return null}async calculateDeliveryFee(a,s,u,p,y){let h=await this.checkPointInZone(a,s,u,p);if(!h)return{zone:null,deliveryFee:0,isFreeDelivery:!1,isDeliverable:!1,distanceKm:0,estimatedMinutes:{min:0,max:0}};let v=await Ke.findOne({id:h.id}),D=0;h.centerLat&&h.centerLng&&(D=this.calculateDistance(h.centerLat,h.centerLng,a,s));let O=h.baseFee+D*h.feePerKm,M=!1;return h.freeDeliveryThreshold&&y>=h.freeDeliveryThreshold&&(O=0,M=!0),h.minOrderAmount&&y<h.minOrderAmount?{zone:h,deliveryFee:0,isFreeDelivery:!1,isDeliverable:!1,distanceKm:D,estimatedMinutes:{min:h.estimatedMinMinutes,max:h.estimatedMaxMinutes}}:{zone:h,deliveryFee:Math.round(O*100)/100,isFreeDelivery:M,isDeliverable:!0,distanceKm:Math.round(D*100)/100,estimatedMinutes:{min:h.estimatedMinMinutes,max:h.estimatedMaxMinutes}}}},re=new hn;function w(i,a,s){if(!i.session.employee)return a.status(401).json({error:"Unauthorized - Please log in"});i.employee={...i.session.employee,tenantId:i.session.employee.tenantId||"default"},s()}function j(i,a,s){if(!i.employee)return a.status(401).json({error:"Unauthorized"});if(i.employee.role!=="manager"&&i.employee.role!=="admin"&&i.employee.role!=="owner")return a.status(403).json({error:"Forbidden - Manager access required"});s()}function me(i,a,s){if(!i.employee)return a.status(401).json({error:"Unauthorized"});if(i.employee.role!=="admin"&&i.employee.role!=="owner")return a.status(403).json({error:"Forbidden - Admin access required"});s()}function Br(i,a,s){if(!i.employee)return a.status(401).json({error:"Unauthorized"});if(!["barista","cook","waiter","manager","admin","owner"].includes(i.employee.role))return a.status(403).json({error:"Forbidden - Kitchen access required"});s()}function Vt(i,a,s){if(!i.employee)return a.status(401).json({error:"Unauthorized"});if(!["cashier","barista","waiter","manager","admin","owner"].includes(i.employee.role))return a.status(403).json({error:"Forbidden - Cashier access required"});s()}function Pt(i,a,s){if(!i.employee)return a.status(401).json({error:"Unauthorized"});if(!["driver","waiter","manager","admin","owner"].includes(i.employee.role))return a.status(403).json({error:"Forbidden - Delivery access required"});s()}function ur(i,a){return!a||a.role==="admin"||a.role==="owner"?i:a.branchId?i.filter(s=>s.branchId===a.branchId):a.role==="manager"?i:[]}function qr(i,a,s){if(!i.session.customer)return a.status(401).json({error:"\u064A\u0631\u062C\u0649 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"});i.customer=i.session.customer,s()}import ys,{Schema as Zn}from"mongoose";var gs=new Zn({id:{type:String,required:!0,unique:!0},nameAr:{type:String,required:!0},nameEn:{type:String,required:!0},type:{type:String,enum:["demo","client"],default:"demo"},status:{type:String,enum:["active","inactive","suspended"],default:"active"},subscriptionPlan:{type:String,default:"free"},features:{type:Zn.Types.Mixed,default:{}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),fs=ys.model("Tenant",gs);function k(i){return i.tenantId||i.params.tenantId||i.query.tenantId||i.body.tenantId||i.headers["x-tenant-id"]||null}import{WebSocket as Qe,WebSocketServer as bs}from"ws";var In=class{wss=null;clients=new Map;heartbeatInterval=null;setup(a){this.wss=new bs({server:a,path:"/ws/orders"}),this.wss.on("connection",(s,u)=>{console.log("[WS] New client connected");let p={ws:s,type:"display",lastPing:Date.now(),isAlive:!0};this.clients.set(s,p),s.on("message",y=>{try{let h=JSON.parse(y.toString());this.handleMessage(s,h)}catch(h){console.error("[WS] Error parsing message:",h)}}),s.on("close",(y,h)=>{console.log(`[WS] Client disconnected: ${y} ${h||""}`),this.clients.delete(s)}),s.on("error",y=>{console.error("[WS] Client error:",y.message),this.clients.delete(s);try{s.terminate()}catch{}}),s.on("pong",()=>{let y=this.clients.get(s);y&&(y.isAlive=!0,y.lastPing=Date.now())}),s.send(JSON.stringify({type:"welcome",timestamp:Date.now()}))}),this.startHeartbeat(),console.log("\u2705 WebSocket server initialized at /ws/orders")}startHeartbeat(){this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.heartbeatInterval=setInterval(()=>{let a=Date.now(),s=6e4;this.clients.forEach((u,p)=>{if(!u.isAlive||a-u.lastPing>s){console.log("[WS] Terminating stale client"),this.clients.delete(p);try{p.terminate()}catch{}return}u.isAlive=!1;try{p.readyState===Qe.OPEN&&p.ping()}catch{this.clients.delete(p)}})},3e4)}handleMessage(a,s){let u=this.clients.get(a);switch(u&&(u.lastPing=Date.now(),u.isAlive=!0),s.type){case"subscribe":u&&(u.type=s.clientType||"display",u.orderId=s.orderId,u.branchId=s.branchId,u.driverId=s.driverId,u.deliveryOrderId=s.deliveryOrderId,u.customerId=s.customerId),console.log(`[WS] Client subscribed as ${s.clientType}`),a.send(JSON.stringify({type:"subscribed",clientType:s.clientType}));break;case"ping":a.send(JSON.stringify({type:"pong",timestamp:Date.now()}));break;case"driver_location_update":u&&u.type==="delivery-driver"&&u.driverId&&this.broadcastDriverLocation(u.driverId,s.location,s.deliveryOrderId);break;default:break}}cleanupStaleClients(){this.clients.forEach((a,s)=>{s.readyState!==Qe.OPEN&&(console.log("[WS] Removing closed connection"),this.clients.delete(s))})}broadcastOrderUpdate(a){if(!this.wss)return;this.cleanupStaleClients();let s=JSON.stringify({type:"order_updated",order:a,timestamp:Date.now()});this.clients.forEach((u,p)=>{if(p.readyState===Qe.OPEN&&(u.type==="kitchen"||u.type==="display"||u.type==="pos"||u.type==="order-tracking"&&u.orderId===a.id))try{p.send(s)}catch{this.clients.delete(p)}})}broadcastNewOrder(a){if(!this.wss)return;this.cleanupStaleClients();let s=JSON.stringify({type:"new_order",order:a,timestamp:Date.now()});this.clients.forEach((u,p)=>{if(p.readyState===Qe.OPEN&&(u.type==="kitchen"||u.type==="display"||u.type==="pos"))try{p.send(s)}catch{this.clients.delete(p)}})}broadcastOrderReady(a){if(!this.wss)return;this.cleanupStaleClients();let s=JSON.stringify({type:"order_ready",order:a,timestamp:Date.now()});this.clients.forEach((u,p)=>{if(p.readyState===Qe.OPEN&&(u.type==="display"||u.type==="order-tracking"&&u.orderId===a.id))try{p.send(s)}catch{this.clients.delete(p)}})}broadcastStockAlert(a){if(!this.wss)return;this.cleanupStaleClients();let s=JSON.stringify({type:"stock_alert",alert:a,timestamp:Date.now()});this.clients.forEach((u,p)=>{if(p.readyState===Qe.OPEN&&(u.type==="inventory"||u.type==="display"))try{p.send(s)}catch{this.clients.delete(p)}})}broadcastAlertResolved(a,s){if(!this.wss)return;this.cleanupStaleClients();let u=JSON.stringify({type:"alert_resolved",alertId:a,branchId:s,timestamp:Date.now()});this.clients.forEach((p,y)=>{if(y.readyState===Qe.OPEN&&(p.type==="inventory"||p.type==="display"))try{y.send(u)}catch{this.clients.delete(y)}})}getConnectionCount(){return this.clients.size}broadcastDeliveryUpdate(a){if(!this.wss)return;this.cleanupStaleClients();let s=String(a.id||a._id||""),u=String(a.driverId||a.driver?._id||""),p=JSON.stringify({type:"delivery_updated",deliveryOrder:a,timestamp:Date.now()});this.clients.forEach((y,h)=>{if(h.readyState===Qe.OPEN){let v=y.type==="delivery-driver"&&y.driverId&&u&&y.driverId===u,D=y.type==="delivery-tracking"&&y.deliveryOrderId&&s&&y.deliveryOrderId===s;if(v||D)try{h.send(p)}catch{this.clients.delete(h)}}})}broadcastDriverLocation(a,s,u){if(!this.wss)return;this.cleanupStaleClients();let p=u?String(u):"",y=String(a),h=JSON.stringify({type:"driver_location",driverId:y,location:s,deliveryOrderId:p,timestamp:Date.now()});this.clients.forEach((v,D)=>{if(D.readyState===Qe.OPEN){let O=v.type==="delivery-tracking"&&v.deliveryOrderId&&p&&v.deliveryOrderId===p,M=v.type==="delivery-tracking"&&v.driverId&&y&&v.driverId===y;if(O||M)try{D.send(h)}catch{this.clients.delete(D)}}})}broadcastNewDeliveryOrder(a,s){if(!this.wss)return;this.cleanupStaleClients();let u=s?String(s):"",p=JSON.stringify({type:"new_delivery_order",deliveryOrder:a,timestamp:Date.now()});this.clients.forEach((y,h)=>{if(h.readyState===Qe.OPEN&&y.type==="delivery-driver"&&(!u||y.branchId&&y.branchId===u))try{h.send(p)}catch{this.clients.delete(h)}})}broadcastToBranch(a,s){if(!this.wss)return;this.cleanupStaleClients();let u=a&&a!=="all"?String(a):"",p=JSON.stringify({...s,timestamp:Date.now()});this.clients.forEach((y,h)=>{if(h.readyState===Qe.OPEN&&(!u||y.branchId&&y.branchId===u))try{h.send(p)}catch{this.clients.delete(h)}})}broadcastToCustomer(a,s){if(!this.wss)return;this.cleanupStaleClients();let u=String(a),p=JSON.stringify({...s,timestamp:Date.now()});this.clients.forEach((y,h)=>{if(h.readyState===Qe.OPEN&&y.type==="customer"&&y.customerId===u)try{h.send(p)}catch{this.clients.delete(h)}})}shutdown(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.clients.forEach((a,s)=>{try{s.close(1001,"Server shutting down")}catch{}}),this.clients.clear(),this.wss&&this.wss.close()}},ye=new In;He();import Gt from"bcryptjs";import Ze from"multer";import pe from"path";import{fileURLToPath as Qs}from"url";import Ht from"fs";import{Types as Hs}from"mongoose";import{nanoid as Pe}from"nanoid";var pr=i=>Hs.ObjectId.isValid(i),Zs=Qs(import.meta.url),mt=pe.dirname(Zs),Ws=[pe.resolve(mt,"..","attached_assets","drinks"),pe.resolve(mt,"..","attached_assets","sizes"),pe.resolve(mt,"..","attached_assets","addons"),pe.resolve(mt,"..","attached_assets","employees"),pe.resolve(mt,"..","attached_assets","attendance"),pe.resolve(mt,"..","attached_assets","receipts")];Ws.forEach(i=>{Ht.existsSync(i)||Ht.mkdirSync(i,{recursive:!0})});function P(i){if(!i)return null;let a=i.toObject?i.toObject():i;return a._id&&!a.id&&(a.id=a._id.toString()),delete a._id,delete a.__v,a}function Ys(i,a,s){let u=(a||"").toLowerCase().trim(),p=(s||"").toLowerCase().trim();return u===p?i:(u==="g"||u==="gram"||u==="grams")&&(p==="kg"||p==="kilogram"||p==="kilograms")||(u==="ml"||u==="milliliter"||u==="milliliters")&&(p==="liter"||p==="liters"||p==="l")?i/1e3:(u==="kg"||u==="kilogram"||u==="kilograms")&&(p==="g"||p==="gram"||p==="grams")||(p==="ml"||p==="milliliter"||p==="milliliters")&&(u==="liter"||u==="liters"||u==="l")?i*1e3:i}function Js(i,a){if(!i)return a;try{return JSON.parse(i)}catch(s){return console.error("Failed to parse JSON:",s),a}}async function Qr(i,a,s){try{if(!a||a==="undefined"||a==="null")return{success:!1,costOfGoods:0,deductionDetails:[],warnings:[],error:"No valid branchId"};let u=await Z.findOne({id:i})||await Z.findById(i).catch(()=>null);if(!u)return{success:!1,costOfGoods:0,deductionDetails:[],warnings:[],error:"Order not found"};if(u.inventoryDeducted&&u.inventoryDeducted>=1)return{success:!0,costOfGoods:u.costOfGoods||0,deductionDetails:(u.inventoryDeductionDetails||[]).map(D=>({rawItemId:D.rawItemId,rawItemName:D.rawItemName,quantity:D.quantity,unit:D.unit,unitCost:D.unitCost,totalCost:D.totalCost})),warnings:[]};let p=u.items||[];if(typeof p=="string"&&(p=Js(p,[])),p.length===0)return{success:!1,costOfGoods:0,deductionDetails:[],warnings:[],error:"Order has no items"};let y=p.map(D=>({coffeeItemId:D.coffeeItemId||D.id,quantity:D.quantity||1,addons:D.customization?.selectedAddons?.map(O=>({id:O.addonId||O.id,rawItemId:O.rawItemId,quantity:O.quantity||1,unit:O.unit}))||[]})),h=y.reduce((D,O)=>D+O.quantity*10,0);if(u.customerId){await ee.findByIdAndUpdate(u.customerId,{$inc:{points:h,pendingPoints:-h}});try{let D=await jt.model("LoyaltyCard").findOne({customerId:u.customerId});D&&(D.points=(D.points||0)+h,D.stamps=(D.stamps||0)+y.length,await D.save())}catch(D){console.error("[LOYALTY] Failed to update loyalty card:",D)}}let v=await f.deductInventoryForOrder(i,a,y,s);if(await Z.findOneAndUpdate({id:i},{inventoryDeducted:v.success?1:0,costOfGoods:v.costOfGoods,inventoryDeductionDetails:v.deductionDetails}),v.warnings.length>0&&console.warn(`[INVENTORY] Order ${u.orderNumber} warnings:`,v.warnings),v.success&&v.costOfGoods>0)try{let D=u.tenantId||"demo-tenant",{JournalEntryModel:O}=await Promise.resolve().then(()=>(T(),R));if(!await O.findOne({tenantId:D,referenceType:"order_cogs",referenceId:i})){let B=await te.findOne({tenantId:D,accountNumber:"5100"}),F=await te.findOne({tenantId:D,accountNumber:"1130"});B&&F&&(await ce.createJournalEntry({tenantId:D,entryDate:new Date,description:`\u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0628\u0636\u0627\u0639\u0629 \u0627\u0644\u0645\u0628\u0627\u0639\u0629 - \u0637\u0644\u0628 \u0631\u0642\u0645 ${u.orderNumber}`,lines:[{accountId:B.id,accountNumber:B.accountNumber,accountName:B.nameAr,debit:v.costOfGoods,credit:0,description:`\u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0628\u0636\u0627\u0639\u0629 \u0627\u0644\u0645\u0628\u0627\u0639\u0629 - \u0637\u0644\u0628 ${u.orderNumber}`,branchId:a},{accountId:F.id,accountNumber:F.accountNumber,accountName:F.nameAr,debit:0,credit:v.costOfGoods,description:`\u062E\u0635\u0645 \u0645\u062E\u0632\u0648\u0646 - \u0637\u0644\u0628 ${u.orderNumber}`,branchId:a}],referenceType:"order_cogs",referenceId:i,createdBy:s,autoPost:!0}),console.log(`[ACCOUNTING] COGS journal entry created for order ${u.orderNumber}: ${v.costOfGoods} SAR`))}}catch(D){console.error(`[ACCOUNTING] Failed to create COGS journal entry for order ${u.orderNumber}:`,D)}return{success:v.success,costOfGoods:v.costOfGoods,deductionDetails:v.deductionDetails.map(D=>({rawItemId:D.rawItemId,rawItemName:D.rawItemName,quantity:D.quantity,unit:D.unit,unitCost:D.unitCost,totalCost:D.totalCost})),warnings:v.warnings,error:v.errors.length>0?v.errors.join(", "):void 0}}catch(u){return{success:!1,costOfGoods:0,deductionDetails:[],warnings:[],error:String(u)}}}function Ks(i,a){return{pending:`\u23F3 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a} \u0641\u064A \u0627\u0644\u0627\u0646\u062A\u0638\u0627\u0631
\u0646\u062D\u0646 \u0646\u0633\u062A\u0639\u062F \u0644\u062A\u062C\u0647\u064A\u0632\u0647!`,payment_confirmed:`\u{1F4B0} \u062A\u0645 \u062A\u0623\u0643\u064A\u062F \u062F\u0641\u0639 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a}
\u062C\u0627\u0631\u064A \u062A\u062D\u0636\u064A\u0631\u0647 \u0627\u0644\u0622\u0646!`,in_progress:`\u2615 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a} \u0642\u064A\u062F \u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0627\u0644\u0622\u0646
\u0642\u0647\u0648\u062A\u0643 \u0641\u064A \u0627\u0644\u0637\u0631\u064A\u0642!`,ready:`\u{1F389} \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a} \u062C\u0627\u0647\u0632 \u0644\u0644\u0627\u0633\u062A\u0644\u0627\u0645!
\u0627\u0633\u062A\u0645\u062A\u0639 \u0628\u0642\u0647\u0648\u062A\u0643 \u2615`,completed:`\u2705 \u062A\u0645 \u0627\u0633\u062A\u0644\u0627\u0645 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a}
\u0646\u062A\u0645\u0646\u0649 \u0623\u0646 \u062A\u0633\u062A\u0645\u062A\u0639 \u0628\u0642\u0647\u0648\u062A\u0643!`,cancelled:`\u274C \u062A\u0645 \u0625\u0644\u063A\u0627\u0621 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a}
\u0646\u0623\u0633\u0641 \u0644\u0644\u0625\u0632\u0639\u0627\u062C`}[i]||`\u062A\u0645 \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0637\u0644\u0628\u0643 \u0631\u0642\u0645 ${a} \u0625\u0644\u0649: ${i}`}async function la(i,a,s){try{let{sendOrderNotificationEmail:u}=await Promise.resolve().then(()=>(He(),et));return await u(i,s.customerName||"\u0639\u0645\u064A\u0644",a,"completed",s.totalAmount||0,s)}catch(u){return console.error("\u274C Failed to send invoice email:",u),!1}}var Xs=pe.join(mt,"..","attached_assets","receipts"),ei=Ze.diskStorage({destination:function(i,a,s){s(null,Xs)},filename:function(i,a,s){let u=`${Date.now()}-${Pe(8)}`;s(null,`receipt-${u}${pe.extname(a.originalname)}`)}}),ti=Ze({storage:ei,limits:{fileSize:5*1024*1024},fileFilter:(i,a,s)=>{let u=/jpeg|jpg|png|webp|pdf/,p=u.test(pe.extname(a.originalname).toLowerCase()),y=u.test(a.mimetype);p&&y?s(null,!0):s(new Error("Invalid file type. Only images (JPG, PNG, WEBP) and PDF are allowed."))}}),Qt={connected:!1,lastCheck:Date.now()};async function ma(i){i.post("/api/admin/send-email",w,j,async(r,e)=>{try{let{customerId:t,subject:n,message:o}=r.body,d=await ee.findById(t);if(!d||!d.email)return e.status(404).json({error:"Customer not found or has no email"});let{sendPromotionEmail:m}=await Promise.resolve().then(()=>(He(),et));await m(d.email,d.name||"\u0639\u0645\u064A\u0644",n,o)?e.json({message:"Email sent successfully"}):e.status(500).json({error:"Failed to send email"})}catch(t){console.error("Error sending manual email:",t),e.status(500).json({error:"Internal server error"})}}),i.get("/api/admin/customers-list",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await ee.find({tenantId:t,email:{$exists:!0,$ne:""}});e.json(n.map(P))}catch(t){console.error("Error fetching customers list:",t),e.status(500).json({error:"Failed to fetch customers"})}}),i.get("/api/business-config",async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await _e.findOne({tenantId:t});n||(n=await _e.create({tenantId:t,tradeNameAr:"\u0643\u0644\u0627\u0648\u0646\u064A \u0643\u0627\u0641\u064A\u0647",tradeNameEn:"Cluny Cafe",activityType:"cafe",isFoodEnabled:!1,isDrinksEnabled:!0,vatPercentage:15,currency:"SAR",timezone:"Asia/Riyadh"})),e.json(P(n))}catch(t){console.error("Error fetching business config:",t),e.status(500).json({error:"Failed to fetch configuration"})}}),i.patch("/api/business-config",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.body,o=await _e.findOneAndUpdate({tenantId:t},{$set:{...n,updatedAt:new Date}},{new:!0,upsert:!0});e.json(P(o))}catch(t){console.error("Error updating business config:",t),e.status(500).json({error:"Failed to update configuration"})}}),i.patch("/api/orders/:id/status",w,async(r,e)=>{try{let{status:t,cancellationReason:n}=r.body,o=r.params.id,d=await Z.findOne({id:o})||await Z.findById(o).catch(()=>null);if(!d)return e.status(404).json({error:"Order not found"});let m=d.status;d.status=t,n&&(d.cancellationReason=n),r.body.paymentMethod&&(d.paymentMethod=r.body.paymentMethod),d.updatedAt=new Date,await d.save();let l=P(d);try{if(d.customerId){let g=await ee.findById(d.customerId);if(g&&g.email){let{sendOrderNotificationEmail:b}=await Promise.resolve().then(()=>(He(),et));await b(g.email,g.name||"\u0639\u0645\u064A\u0644",d.orderNumber||o,t,d.totalAmount||0,d)}}}catch(g){console.error("[EMAIL-AUTO] Failed to send status update email:",g)}if((t==="in_progress"||t==="completed"||t==="payment_confirmed")&&!["in_progress","completed","payment_confirmed"].includes(m)){let g=t,b=d.branchId||r.employee?.branchId;b&&Qr(o,b,r.employee?.id||"system").catch(I=>console.error(`[INVENTORY] Auto-deduction failed for order ${d.orderNumber}:`,I))}ye.broadcastOrderUpdate(l),(t==="payment_confirmed"||t==="confirmed"||t==="in_progress")&&ye.broadcastNewOrder(l),e.json(l)}catch(t){console.error("Error updating order status:",t),e.status(500).json({error:"Failed to update order status"})}}),i.post("/api/orders/cancel-all",w,async(r,e)=>{try{let t=k(r)||"default",n=r.employee?.branchId,o={tenantId:t,status:{$in:["pending","in_progress","ready"]}};n&&(o.branchId=n);let d=await Z.updateMany(o,{$set:{status:"cancelled",updatedAt:new Date}});ye.broadcastToBranch(n||"all",{type:"orders_updated",tenantId:t}),e.json({success:!0,count:d.modifiedCount})}catch(t){console.error("Error cancelling all orders:",t),e.status(500).json({error:"Failed to cancel orders"})}}),i.get("/api/tables",async(r,e)=>{try{let t=r.query.branchId,o={tenantId:k(r)||"demo-tenant"};t&&t!=="none"&&t!=="undefined"&&t!=="null"&&t!==""&&(o.branchId=t);let d=await fe.find(o).sort({tableNumber:1});console.log(`[GET /api/tables] Found ${d.length} tables for query:`,JSON.stringify(o)),e.json(d.map(P))}catch{e.status(500).json({error:"Failed to fetch tables"})}}),i.post("/api/tables",w,j,async(r,e)=>{try{let{tableNumber:t,branchId:n}=r.body,o=k(r)||"demo-tenant";if(await fe.findOne({tableNumber:t,branchId:n,tenantId:o}))return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u0648\u062C\u0648\u062F \u0645\u0633\u0628\u0642\u0627\u064B \u0641\u064A \u0647\u0630\u0627 \u0627\u0644\u0641\u0631\u0639"});let m=await fe.create({tableNumber:t,branchId:n,tenantId:o,qrToken:Pe(12),isActive:1,isOccupied:0});e.json(P(m))}catch(t){console.error("Error creating table:",t),e.status(500).json({error:"Failed to create table"})}}),i.post("/api/tables/bulk-create",w,j,async(r,e)=>{try{let{count:t,branchId:n}=r.body,o=k(r)||"demo-tenant",d=parseInt(t);if(isNaN(d)||d<1||d>100)return e.status(400).json({error:"\u0639\u062F\u062F \u063A\u064A\u0631 \u0635\u0627\u0644\u062D (1-100)"});if(!await f.getBranch(n))return e.status(404).json({error:"\u0627\u0644\u0641\u0631\u0639 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let l=await fe.find({branchId:n},{tableNumber:1}),g=new Set(l.map(N=>{let x=parseInt(N.tableNumber);return isNaN(x)?N.tableNumber:x})),b=await fe.findOne({branchId:n}).sort({tableNumber:-1}),I=1;b&&!isNaN(parseInt(b.tableNumber))&&(I=parseInt(b.tableNumber)+1);let A=[],S=I;for(let N=0;N<d;N++){for(;g.has(S)||g.has(String(S));)S++;let x=Pe(10);A.push({id:x,tableNumber:String(S),branchId:n,tenantId:o,qrToken:Pe(12),isActive:1,isOccupied:0}),g.add(S),S++}let C=await fe.insertMany(A);e.json({results:{created:C.map(P)}})}catch(t){console.error("Error bulk creating tables:",t),e.status(500).json({error:"Failed to bulk create tables"})}}),i.delete("/api/tables/branch/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=k(r)||"demo-tenant",o=await fe.deleteMany({branchId:t,tenantId:n});e.json({message:"\u062A\u0645 \u062D\u0630\u0641 \u062C\u0645\u064A\u0639 \u0627\u0644\u0637\u0627\u0648\u0644\u0627\u062A \u0628\u0646\u062C\u0627\u062D",count:o.deletedCount})}catch(t){console.error("Error deleting all tables:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0637\u0627\u0648\u0644\u0627\u062A"})}}),i.delete("/api/tables/:id",w,j,async(r,e)=>{try{let{id:t}=r.params;if(!await fe.findOneAndDelete({$or:[{id:t},{_id:pr(t)?t:null}].filter(o=>o._id!==null||o.id!==void 0)}))return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json({success:!0})}catch{e.status(500).json({error:"Failed to delete table"})}}),i.patch("/api/tables/:id/toggle-active",w,j,async(r,e)=>{try{let{id:t}=r.params,n=await fe.findOne({$or:[{id:t},{_id:pr(t)?t:null}].filter(o=>o._id!==null||o.id!==void 0)});if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});n.isActive=n.isActive===1?0:1,await n.save(),e.json(P(n))}catch{e.status(500).json({error:"Failed to toggle status"})}}),i.post("/api/tables/:id/empty",w,async(r,e)=>{try{let{id:t}=r.params,n=await fe.findOne({$or:[{id:t},{_id:pr(t)?t:null}].filter(o=>o._id!==null||o.id!==void 0)});if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});n.isOccupied=0,n.currentOrderId=void 0,await n.save(),e.json(P(n))}catch{e.status(500).json({error:"Failed to empty table"})}}),i.get("/api/warehouses/:id/stock",w,async(r,e)=>{let t=k(r)||"default",n=await tn.find({tenantId:t,warehouseId:r.params.id});e.json(n.map(P))}),i.get("/api/custom-banners",async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await Mt.find({tenantId:t,isActive:!0}).sort({orderIndex:1});e.json(n.map(P))}catch(t){console.error("Error fetching custom banners:",t),e.status(500).json({error:"Failed to fetch banners"})}}),i.post("/api/custom-banners",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant",n={...r.body,id:Pe(10),tenantId:t,createdAt:new Date,updatedAt:new Date},o=await Mt.create(n);e.json(P(o))}catch(t){console.error("Error creating banner:",t),e.status(500).json({error:"Failed to create banner"})}}),i.patch("/api/custom-banners/:id",w,me,async(r,e)=>{try{let{id:t}=r.params,n={...r.body,updatedAt:new Date},o=await Mt.findOneAndUpdate({id:t},n,{new:!0});if(!o)return e.status(404).json({error:"Banner not found"});e.json(P(o))}catch(t){console.error("Error updating banner:",t),e.status(500).json({error:"Failed to update banner"})}}),i.delete("/api/custom-banners/:id",w,me,async(r,e)=>{try{let{id:t}=r.params;if((await Mt.deleteOne({id:t})).deletedCount===0)return e.status(404).json({error:"Banner not found"});e.json({success:!0})}catch(t){console.error("Error deleting banner:",t),e.status(500).json({error:"Failed to delete banner"})}}),i.get("/api/integrations/delivery",w,me,async(r,e)=>{let t=k(r)||"default",n=await Je.find({tenantId:t});e.json(n.map(P))}),i.post("/api/integrations/delivery",w,me,async(r,e)=>{let t=k(r)||"default",n=await Je.create({...r.body,tenantId:t});e.json(P(n))}),i.post("/api/webhooks/delivery/:provider",async(r,e)=>{let{provider:t}=r.params;e.status(200).json({received:!0,provider:t})}),i.get("/api/verify-session",async(r,e)=>{try{if(!r.session.employee)return e.status(401).json({error:"Not authenticated"});let t=r.session.employee;e.json({success:!0,employee:t})}catch{e.status(500).json({error:"Internal error"})}}),i.delete("/api/admin/clear-all-data",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant";await Z.deleteMany({tenantId:t}),await ft.deleteMany({tenantId:t}),await ve.deleteMany({tenantId:t}),console.log(`[ADMIN] Data cleared for tenant ${t}`),e.json({message:"\u062A\u0645 \u062A\u0646\u0638\u064A\u0641 \u062C\u0645\u064A\u0639 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0628\u0646\u062C\u0627\u062D"})}catch(t){console.error("Error clearing data:",t),e.status(500).json({error:"Failed to clear data"})}}),i.get("/api/config",w,async(r,e)=>{let t=k(r)||"demo-tenant",n=await f.getBusinessConfig(t);e.json(n||{})}),i.patch("/api/config",w,me,async(r,e)=>{let t=k(r)||"demo-tenant",n=await f.updateBusinessConfig(t,r.body);e.json(n)});let a={};i.get("/api/settings/order-suspension",async(r,e)=>{try{let t=r.employee?.tenantId||"demo-tenant",n=r.query?.branchId||r.employee?.branchId,o=a[t]||{suspended:!1};if(!o.suspended&&n&&(await f.getBranch(n))?.isMaintenanceMode)return e.json({suspended:!0,reason:"\u0635\u064A\u0627\u0646\u0629 \u0627\u0644\u0641\u0631\u0639"});e.json(o)}catch{e.json({suspended:!1})}}),i.post("/api/settings/branch-maintenance",w,j,async(r,e)=>{try{let t=r.employee?.branchId;if(!t)return e.status(400).json({error:"Branch ID required"});let{suspended:n}=r.body,o=await f.updateBranchMaintenance(t,!!n);e.json(o)}catch{e.status(500).json({error:"Internal server error"})}}),i.post("/api/settings/order-suspension",w,j,async(r,e)=>{try{let t=r.employee?.tenantId||"demo-tenant",{suspended:n,reason:o}=r.body;a[t]={suspended:!!n,suspendedAt:n?new Date:void 0,suspendedBy:r.employee?.fullName||r.employee?.username,reason:o||void 0},console.log(`[ORDER SUSPENSION] ${n?"SUSPENDED":"RESUMED"} by ${r.employee?.fullName} for tenant ${t}`),e.json(a[t])}catch{e.status(500).json({error:"Internal server error"})}}),i.get("/api/ingredients",w,async(r,e)=>{let t=k(r)||"demo-tenant",n=await f.getIngredientItems(t);e.json(n)}),i.post("/api/ingredients",w,j,async(r,e)=>{let t=k(r)||"demo-tenant",n=await f.createIngredientItem({...r.body,tenantId:t});e.json(n)}),i.get("/api/recipes/product/:productId",w,async(r,e)=>{let t=k(r);if(!t)return e.status(400).json({error:"Tenant ID is required"});let n=await f.getRecipeDefinition(t,r.params.productId);e.json(n||null)}),i.post("/api/recipes",w,j,async(r,e)=>{let t=k(r);if(!t)return e.status(400).json({error:"Tenant ID is required"});let n=await f.createRecipeDefinition({...r.body,tenantId:t});e.json(n)}),i.get("/api/addons",w,async(r,e)=>{let t=k(r)||"demo-tenant",n=await Le.find({tenantId:t}).lean();e.json(n.map(P))}),i.post("/api/addons",w,j,async(r,e)=>{let t=k(r),n=await Le.create({...r.body,tenantId:t});e.json(n)}),i.patch("/api/addons/:id",w,j,async(r,e)=>{let t=await Le.findByIdAndUpdate(r.params.id,{$set:r.body},{new:!0});e.json(t)}),i.post("/api/inventory/movements",w,j,async(r,e)=>{let t=k(r)||"demo-tenant",{ingredientId:n,type:o,quantity:d,notes:m,branchId:l}=r.body,I=(await f.getIngredientItems(t)).find(N=>N._id.toString()===n)?.currentStock||0,A=o==="in"?{currentStock:I+d}:{currentStock:I-d},S=await f.updateIngredientItem(n,A),C=await Re.create({branchId:l||"default",rawItemId:n,movementType:o==="in"?"purchase":"adjustment",quantity:d,previousQuantity:I,newQuantity:S?.currentStock||0,referenceType:"manual",notes:m,createdBy:r.employee.id});e.json(C)}),i.get("/api/inventory/movements",w,async(r,e)=>{let t=r.query.branchId||"default",n=await Re.find({branchId:t}).sort({createdAt:-1}).limit(50);e.json(n)}),i.delete("/api/coffee-items/:id",w,j,async(r,e)=>{try{let{id:t}=r.params,n=k(r),o=await ae.findOne({id:t});if(!o)return e.status(404).json({error:"\u0627\u0644\u0645\u0634\u0631\u0648\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(n&&o.tenantId!==n)return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u062D\u0630\u0641 \u0647\u0630\u0627 \u0627\u0644\u0645\u0634\u0631\u0648\u0628"});if(await Ne.deleteMany({coffeeItemId:t}),!await ae.findOneAndDelete({id:t}))return e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0645\u0634\u0631\u0648\u0628 \u0645\u0646 \u0642\u0627\u0639\u062F\u0629 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0645\u0634\u0631\u0648\u0628 \u0648\u062C\u0645\u064A\u0639 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0631\u062A\u0628\u0637\u0629 \u0628\u0647 \u0628\u0646\u062C\u0627\u062D"})}catch(t){console.error("[DELETE_COFFEE_ITEM_ERROR]:",t),e.status(500).json({error:"\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u0645\u062D\u0627\u0648\u0644\u0629 \u0627\u0644\u062D\u0630\u0641",details:t.message})}}),i.put("/api/coffee-items/:id",w,j,async(r,e)=>{try{let t=await ae.findOneAndUpdate({id:r.params.id},{$set:r.body},{new:!0});e.json(P(t))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0627\u0644\u0645\u0646\u062A\u062C"})}}),i.get("/api/warehouses",w,async(r,e)=>{let t=k(r)||"demo-tenant",n=await fr.find({tenantId:t}).lean();e.json(n)}),i.post("/api/warehouses",w,me,async(r,e)=>{let t=k(r)||"demo-tenant",n=await fr.create({...r.body,tenantId:t});e.json(n)}),i.post("/api/warehouses/transfer",w,j,async(r,e)=>{let t=k(r)||"demo-tenant",n=await Jr.create({...r.body,tenantId:t,status:"pending",createdBy:r.employee.id});e.json(n)}),i.get("/api/integrations/delivery/mock-status",w,async(r,e)=>{e.json({hungerstation:{status:"connected",latency:"120ms",ordersToday:45},jahez:{status:"connected",latency:"95ms",ordersToday:32},toyou:{status:"disconnected",lastActive:"2025-12-29"}})}),i.get("/api/integrations/delivery/service-status",w,async(r,e)=>{try{let n=(await Je.find({}).lean()).map(o=>({provider:o.provider||"unknown",status:o.isActive?"connected":"disconnected",latency:Math.random()>.3?`${Math.floor(Math.random()*200+50)}ms`:void 0,ordersToday:Math.floor(Math.random()*100),lastActive:o.lastSyncAt?new Date(o.lastSyncAt).toLocaleDateString("ar-SA"):"\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u062A\u0632\u0627\u0645\u0646"}));e.json(n.length>0?n:[{provider:"hungerstation",status:"connected",latency:"120ms",ordersToday:45},{provider:"jahez",status:"connected",latency:"95ms",ordersToday:32},{provider:"toyou",status:"disconnected",lastActive:"2025-12-29"}])}catch{e.json([{provider:"hungerstation",status:"connected",latency:"120ms",ordersToday:45},{provider:"jahez",status:"connected",latency:"95ms",ordersToday:32},{provider:"toyou",status:"disconnected",lastActive:"2025-12-29"}])}}),i.get("/api/payment-methods",async(r,e)=>{try{let t=k(r)||"demo-tenant",o=(await _e.findOne({tenantId:t}))?.paymentGateway,d=[];(!o||o.cashEnabled!==!1)&&d.push({id:"cash",nameAr:"\u0643\u0627\u0634",nameEn:"Cash",details:"\u0627\u0644\u062F\u0641\u0639 \u0646\u0642\u062F\u0627\u064B \u0639\u0646\u062F \u0627\u0644\u0627\u0633\u062A\u0644\u0627\u0645",icon:"fas fa-money-bill-wave"}),(!o||o.qahwaCardEnabled!==!1)&&d.push({id:"qahwa-card",nameAr:"\u0628\u0637\u0627\u0642\u0629 \u0643\u0644\u0648\u0646\u064A \u0643\u0627\u0641\u064A\u0647",nameEn:"Cluny Card",details:"\u0627\u062F\u0641\u0639 \u0628\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621",icon:"fas fa-gift"}),o?.stcPayEnabled&&d.push({id:"stc-pay",nameAr:"STC Pay",nameEn:"STC Pay",details:"\u0627\u0644\u062F\u0641\u0639 \u0639\u0628\u0631 \u0645\u062D\u0641\u0638\u0629 STC",icon:"fas fa-mobile-alt"}),o?.bankTransferEnabled&&d.push({id:"mada",nameAr:"\u062A\u062D\u0648\u064A\u0644 \u0628\u0646\u0643\u064A",nameEn:"Bank Transfer",details:"\u062A\u062D\u0648\u064A\u0644 \u0645\u0628\u0627\u0634\u0631",icon:"fas fa-university"}),o?.provider==="neoleap"?o.neoleap?.clientId&&o.neoleap?.clientSecret&&(d.push({id:"neoleap",nameAr:"\u0628\u0637\u0627\u0642\u0629 \u0628\u0646\u0643\u064A\u0629",nameEn:"Card Payment",details:"\u0645\u062F\u0649\u060C \u0641\u064A\u0632\u0627\u060C \u0645\u0627\u0633\u062A\u0631 \u0643\u0627\u0631\u062F \u0639\u0628\u0631 NeoLeap",icon:"fas fa-credit-card",gateway:"neoleap"}),d.push({id:"neoleap-apple-pay",nameAr:"Apple Pay",nameEn:"Apple Pay",details:"\u0627\u0644\u062F\u0641\u0639 \u0627\u0644\u0633\u0631\u064A\u0639 \u0639\u0628\u0631 Apple Pay",icon:"fas fa-mobile-alt",gateway:"neoleap"})):o?.provider==="geidea"&&(o.geidea?.publicKey&&o.geidea?.apiPassword)&&(d.push({id:"geidea",nameAr:"\u0628\u0637\u0627\u0642\u0629 \u0628\u0646\u0643\u064A\u0629",nameEn:"Card Payment",details:"\u0645\u062F\u0649\u060C \u0641\u064A\u0632\u0627\u060C \u0645\u0627\u0633\u062A\u0631 \u0643\u0627\u0631\u062F \u0639\u0628\u0631 \u062C\u064A\u062F\u064A\u0627",icon:"fas fa-credit-card",gateway:"geidea"}),d.push({id:"apple_pay",nameAr:"Apple Pay",nameEn:"Apple Pay",details:"\u0627\u0644\u062F\u0641\u0639 \u0627\u0644\u0633\u0631\u064A\u0639 \u0639\u0628\u0631 Apple Pay",icon:"fas fa-mobile-alt",gateway:"geidea"})),d.push({id:"loyalty-card",nameAr:"\u0628\u0637\u0627\u0642\u0629 \u0643\u0648\u0628\u064A (\u0631\u0642\u0645 \u0627\u0644\u0639\u0645\u064A\u0644)",nameEn:"Loyalty Card",details:"\u062E\u0635\u0645 \u062A\u0644\u0642\u0627\u0626\u064A \u0648\u062F\u0641\u0639 \u0628\u0627\u0644\u0646\u0642\u0627\u0637",icon:"fas fa-gift"}),e.json(d)}catch{e.status(500).json({error:"Failed to fetch payment methods"})}}),i.get("/api/payment-gateway/config",w,async(r,e)=>{try{if(!r.employee||!["admin","owner","manager"].includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let t=k(r)||"demo-tenant",o=(await _e.findOne({tenantId:t}))?.paymentGateway;if(!o)return e.json({provider:"none",enabledMethods:["cash"],cashEnabled:!0,posEnabled:!0,qahwaCardEnabled:!0,bankTransferEnabled:!1,stcPayEnabled:!1,neoleap:{configured:!1},geidea:{configured:!1}});let d=m=>m?`****${m.slice(-4)}`:"";e.json({provider:o.provider,enabledMethods:o.enabledMethods,cashEnabled:o.cashEnabled,posEnabled:o.posEnabled,qahwaCardEnabled:o.qahwaCardEnabled,bankTransferEnabled:o.bankTransferEnabled,stcPayEnabled:o.stcPayEnabled,neoleap:{configured:!!(o.neoleap?.clientId&&o.neoleap?.clientSecret),clientId:d(o.neoleap?.clientId),merchantId:o.neoleap?.merchantId||"",baseUrl:o.neoleap?.baseUrl||"https://api.neoleap.com.sa",callbackUrl:o.neoleap?.callbackUrl||""},geidea:{configured:!!(o.geidea?.publicKey&&o.geidea?.apiPassword),publicKey:d(o.geidea?.publicKey),baseUrl:o.geidea?.baseUrl||"https://api.merchant.geidea.net",callbackUrl:o.geidea?.callbackUrl||""}})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0625\u0639\u062F\u0627\u062F\u0627\u062A \u0627\u0644\u062F\u0641\u0639"})}}),i.patch("/api/payment-gateway/config",w,async(r,e)=>{try{if(!r.employee||!["admin","owner","manager"].includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let t=k(r)||"demo-tenant",n={},o=r.body;o.provider!==void 0&&(n["paymentGateway.provider"]=o.provider),o.enabledMethods!==void 0&&(n["paymentGateway.enabledMethods"]=o.enabledMethods),o.cashEnabled!==void 0&&(n["paymentGateway.cashEnabled"]=o.cashEnabled),o.posEnabled!==void 0&&(n["paymentGateway.posEnabled"]=o.posEnabled),o.qahwaCardEnabled!==void 0&&(n["paymentGateway.qahwaCardEnabled"]=o.qahwaCardEnabled),o.bankTransferEnabled!==void 0&&(n["paymentGateway.bankTransferEnabled"]=o.bankTransferEnabled),o.stcPayEnabled!==void 0&&(n["paymentGateway.stcPayEnabled"]=o.stcPayEnabled),o.neoleapClientId&&(n["paymentGateway.neoleap.clientId"]=o.neoleapClientId),o.neoleapClientSecret&&(n["paymentGateway.neoleap.clientSecret"]=o.neoleapClientSecret),o.neoleapMerchantId&&(n["paymentGateway.neoleap.merchantId"]=o.neoleapMerchantId),o.neoleapBaseUrl&&(n["paymentGateway.neoleap.baseUrl"]=o.neoleapBaseUrl),o.neoleapCallbackUrl&&(n["paymentGateway.neoleap.callbackUrl"]=o.neoleapCallbackUrl),o.geideaPublicKey&&(n["paymentGateway.geidea.publicKey"]=o.geideaPublicKey),o.geideaApiPassword&&(n["paymentGateway.geidea.apiPassword"]=o.geideaApiPassword),o.geideaBaseUrl&&(n["paymentGateway.geidea.baseUrl"]=o.geideaBaseUrl),o.geideaCallbackUrl&&(n["paymentGateway.geidea.callbackUrl"]=o.geideaCallbackUrl),n.updatedAt=new Date;let d=await _e.findOneAndUpdate({tenantId:t},{$set:n},{new:!0,upsert:!0});e.json({success:!0,message:"\u062A\u0645 \u062D\u0641\u0638 \u0625\u0639\u062F\u0627\u062F\u0627\u062A \u0627\u0644\u062F\u0641\u0639 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0641\u0638 \u0625\u0639\u062F\u0627\u062F\u0627\u062A \u0627\u0644\u062F\u0641\u0639"})}}),i.post("/api/payments/init",async(r,e)=>{try{let{amount:t,orderId:n,currency:o="SAR",customerEmail:d,customerPhone:m,returnUrl:l}=r.body;if(!t||t<=0)return e.status(400).json({error:"\u0627\u0644\u0645\u0628\u0644\u063A \u0645\u0637\u0644\u0648\u0628"});let I=(await _e.findOne({tenantId:"demo-tenant"}))?.paymentGateway;if(!I||I.provider==="none")return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u062A\u0643\u0648\u064A\u0646 \u0628\u0648\u0627\u0628\u0629 \u062F\u0641\u0639 \u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A"});let A=Pe();if(I.provider==="geidea"){let S=I.geidea?.publicKey,C=I.geidea?.apiPassword,N=I.geidea?.baseUrl||"https://api.merchant.geidea.net";if(!S||!C)return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u062C\u064A\u062F\u064A\u0627 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});try{let x=Buffer.from(`${S}:${C}`).toString("base64"),L=await fetch(`${N}/payment-intent/api/v1/direct/eInvoice`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${x}`,Accept:"application/json"},body:JSON.stringify({amount:t,currency:o,customer:{email:d||void 0,phoneNumber:m||void 0},returnUrl:l||I.geidea?.callbackUrl})}),_=await L.json();return L.ok&&_.paymentUrl?e.json({success:!0,sessionId:A,redirectUrl:_.paymentUrl,paymentUrl:_.paymentUrl,provider:"geidea",externalId:_.eInvoiceId||_.orderId}):(console.error("[Geidea] Payment init failed:",_),e.status(400).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0631\u0627\u0628\u0637 \u0627\u0644\u062F\u0641\u0639 \u0639\u0628\u0631 \u062C\u064A\u062F\u064A\u0627",details:_.detailedResponseMessage||_.responseMessage||"\u062E\u0637\u0623 \u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641"}))}catch(x){return console.error("[Geidea] API error:",x.message),e.status(500).json({error:"\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u0627\u062A\u0635\u0627\u0644 \u0628\u062C\u064A\u062F\u064A\u0627",details:x.message})}}if(I.provider==="neoleap"){let S=I.neoleap?.clientId,C=I.neoleap?.clientSecret,N=I.neoleap?.baseUrl||"https://api.neoleap.com.sa";if(!S||!C)return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u0646\u064A\u0648 \u0644\u064A\u0628 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});try{let x=await fetch(`${N}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:S,client_secret:C}).toString()}),L=await x.json();if(!x.ok||!L.access_token)return console.error("[NeoLeap] Token error:",L),e.status(400).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u0645\u0635\u0627\u062F\u0642\u0629 \u0645\u0639 \u0646\u064A\u0648 \u0644\u064A\u0628",details:L.error_description||"\u062E\u0637\u0623 \u0641\u064A \u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0627\u0639\u062A\u0645\u0627\u062F"});let _=await fetch(`${N}/api/v1/payments/session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${L.access_token}`},body:JSON.stringify({amount:t,currency:o,merchantId:I.neoleap?.merchantId,orderId:n||A,callbackUrl:l||I.neoleap?.callbackUrl,customerEmail:d,customerPhone:m})}),V=await _.json();return _.ok&&(V.paymentUrl||V.redirectUrl)?e.json({success:!0,sessionId:A,redirectUrl:V.paymentUrl||V.redirectUrl,paymentUrl:V.paymentUrl||V.redirectUrl,provider:"neoleap",externalId:V.sessionId||V.paymentId}):(console.error("[NeoLeap] Payment init failed:",V),e.status(400).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u062C\u0644\u0633\u0629 \u0627\u0644\u062F\u0641\u0639 \u0639\u0628\u0631 \u0646\u064A\u0648 \u0644\u064A\u0628",details:V.message||"\u062E\u0637\u0623 \u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641"}))}catch(x){return console.error("[NeoLeap] API error:",x.message),e.status(500).json({error:"\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u0627\u062A\u0635\u0627\u0644 \u0628\u0646\u064A\u0648 \u0644\u064A\u0628",details:x.message})}}return e.status(400).json({error:"\u0645\u0632\u0648\u062F \u0627\u0644\u062F\u0641\u0639 \u063A\u064A\u0631 \u0645\u062F\u0639\u0648\u0645"})}catch(t){console.error("[Payments] Init error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0628\u062F\u0621 \u0639\u0645\u0644\u064A\u0629 \u0627\u0644\u062F\u0641\u0639"})}}),i.post("/api/payments/verify",async(r,e)=>{try{let{sessionId:t,transactionId:n,provider:o}=r.body;if(!t)return e.status(400).json({verified:!1,error:"\u0645\u0639\u0631\u0651\u0641 \u0627\u0644\u062C\u0644\u0633\u0629 \u0645\u0637\u0644\u0648\u0628"});let l=(await _e.findOne({tenantId:"demo-tenant"}))?.paymentGateway,g=o||l?.provider;if(!g||g==="none")return e.json({verified:!1,error:"\u0644\u0627 \u064A\u0648\u062C\u062F \u0645\u0632\u0648\u062F \u062F\u0641\u0639 \u0645\u0641\u0639\u0651\u0644"});if(g==="geidea")try{let b=l?.geidea?.publicKey,I=l?.geidea?.apiPassword,A=l?.geidea?.baseUrl||"https://api.merchant.geidea.net";if(!b||!I)return e.json({verified:!1,error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u062C\u064A\u062F\u064A\u0627 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});let S=Buffer.from(`${b}:${I}`).toString("base64"),N=await(await fetch(`${A}/payment-intent/api/v2/direct/session/${t}`,{method:"GET",headers:{Authorization:`Basic ${S}`,Accept:"application/json"}})).json(),x=N?.session?.status==="PaymentSuccess"||N?.status==="Success";return console.log(`[Payment Verify] Geidea session ${t}: ${x?"PAID":"NOT PAID"}`,N?.session?.status||N?.status),e.json({verified:x,transactionId:N?.session?.paymentIntentId||n,provider:"geidea"})}catch(b){return console.error("[Payment Verify] Geidea error:",b.message),e.json({verified:!1,error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u062C\u064A\u062F\u064A\u0627"})}if(g==="neoleap")try{let b=l?.neoleap?.clientId,I=l?.neoleap?.clientSecret,A=l?.neoleap?.baseUrl||"https://api.neoleap.com.sa";if(!b||!I)return e.json({verified:!1,error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u0646\u064A\u0648 \u0644\u064A\u0628 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});let C=await(await fetch(`${A}/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`grant_type=client_credentials&client_id=${encodeURIComponent(b)}&client_secret=${encodeURIComponent(I)}`})).json();if(!C.access_token)return e.json({verified:!1,error:"\u0641\u0634\u0644 \u0645\u0635\u0627\u062F\u0642\u0629 \u0646\u064A\u0648 \u0644\u064A\u0628"});let x=await(await fetch(`${A}/api/v1/sessions/${t}`,{method:"GET",headers:{Authorization:`Bearer ${C.access_token}`,Accept:"application/json"}})).json(),L=x?.status==="COMPLETED"||x?.status==="PAID";return console.log(`[Payment Verify] NeoLeap session ${t}: ${L?"PAID":"NOT PAID"}`,x?.status),e.json({verified:L,transactionId:x?.transactionId||n,provider:"neoleap"})}catch(b){return console.error("[Payment Verify] NeoLeap error:",b.message),e.json({verified:!1,error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0646\u064A\u0648 \u0644\u064A\u0628"})}return e.json({verified:!1,error:"\u0645\u0632\u0648\u062F \u063A\u064A\u0631 \u0645\u062F\u0639\u0648\u0645"})}catch(t){console.error("[Payment Verify] Error:",t),e.status(500).json({verified:!1,error:"\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u062F\u0641\u0639"})}}),i.post("/api/payments/callback",async(r,e)=>{try{let{orderId:t,status:n,provider:o,transactionId:d}=r.body;if(console.log(`[Payment Callback] Provider: ${o}, Order: ${t}, Status: ${n}, TxID: ${d}`),n==="success"||n==="paid"){let m=await f.getOrderByOrderNumber(t);m&&await f.updateOrderStatus(m.id||m._id,"payment_confirmed")}e.json({received:!0})}catch(t){console.error("[Payment Callback] Error:",t),e.status(500).json({error:"Failed to process callback"})}}),i.post("/api/payment-gateway/test",w,async(r,e)=>{try{if(!r.employee||!["admin","owner","manager"].includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let t=k(r)||"demo-tenant",o=(await _e.findOne({tenantId:t}))?.paymentGateway;if(!o||o.provider==="none")return e.json({success:!1,message:"\u0644\u0645 \u064A\u062A\u0645 \u0627\u062E\u062A\u064A\u0627\u0631 \u0645\u0632\u0648\u062F \u062F\u0641\u0639"});if(o.provider==="geidea"){let d=o.geidea?.publicKey,m=o.geidea?.apiPassword,l=o.geidea?.baseUrl||"https://api.merchant.geidea.net";if(!d||!m)return e.json({success:!1,message:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u062C\u064A\u062F\u064A\u0627 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});try{let g=Buffer.from(`${d}:${m}`).toString("base64"),b=await fetch(`${l}/pgw/api/v1/config`,{method:"GET",headers:{Authorization:`Basic ${g}`,Accept:"application/json"}});if(b.ok)return e.json({success:!0,message:"\u0627\u062A\u0635\u0627\u0644 \u062C\u064A\u062F\u064A\u0627 \u0646\u0627\u062C\u062D",provider:"geidea"});{let I=await b.json().catch(()=>({}));return e.json({success:!1,message:"\u0641\u0634\u0644 \u0627\u062A\u0635\u0627\u0644 \u062C\u064A\u062F\u064A\u0627 - \u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A",details:I?.responseMessage})}}catch(g){return e.json({success:!1,message:`\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u0627\u062A\u0635\u0627\u0644: ${g.message}`})}}if(o.provider==="neoleap"){let d=o.neoleap?.clientId,m=o.neoleap?.clientSecret,l=o.neoleap?.baseUrl||"https://api.neoleap.com.sa";if(!d||!m)return e.json({success:!1,message:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0639\u062A\u0645\u0627\u062F \u0646\u064A\u0648 \u0644\u064A\u0628 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});try{let g=await fetch(`${l}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:d,client_secret:m}).toString()});if(g.ok)return e.json({success:!0,message:"\u0627\u062A\u0635\u0627\u0644 \u0646\u064A\u0648 \u0644\u064A\u0628 \u0646\u0627\u062C\u062D",provider:"neoleap"});{let b=await g.json().catch(()=>({}));return e.json({success:!1,message:"\u0641\u0634\u0644 \u0645\u0635\u0627\u062F\u0642\u0629 \u0646\u064A\u0648 \u0644\u064A\u0628 - \u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A",details:b?.error_description})}}catch(g){return e.json({success:!1,message:`\u062E\u0637\u0623 \u0641\u064A \u0627\u0644\u0627\u062A\u0635\u0627\u0644: ${g.message}`})}}e.json({success:!1,message:"\u0645\u0632\u0648\u062F \u063A\u064A\u0631 \u0645\u062F\u0639\u0648\u0645"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u062E\u062A\u0628\u0627\u0631 \u0627\u0644\u0627\u062A\u0635\u0627\u0644"})}}),i.post("/api/pos/toggle",w,(r,e)=>{try{let t=["cashier","manager","admin","owner"];if(!r.employee||!t.includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u062A\u063A\u064A\u064A\u0631 \u062D\u0627\u0644\u0629 \u062C\u0647\u0627\u0632 POS"});Qt.connected=!Qt.connected,Qt.lastCheck=Date.now(),e.json({connected:Qt.connected,message:Qt.connected?"POS \u0645\u062A\u0635\u0644 \u0627\u0644\u0622\u0646":"POS \u063A\u064A\u0631 \u0645\u062A\u0635\u0644"})}catch{e.status(500).json({error:"Failed to toggle POS"})}}),i.post("/api/pos/cash-drawer/open",w,(r,e)=>{try{let t=["cashier","manager","admin","owner"];if(!r.employee||!t.includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u0641\u062A\u062D \u0627\u0644\u062E\u0632\u0627\u0646\u0629"});e.json({success:!0,message:"\u062A\u0645 \u0641\u062A\u062D \u0627\u0644\u062E\u0632\u0627\u0646\u0629 \u0628\u0646\u062C\u0627\u062D",openedBy:r.employee.username,timestamp:new Date().toISOString()})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u062A\u062D \u0627\u0644\u062E\u0632\u0627\u0646\u0629"})}}),i.post("/api/pos/print-receipt",w,async(r,e)=>{try{let t=["cashier","manager","admin","owner"];if(!r.employee||!t.includes(r.employee.role))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u0627\u0644\u0637\u0628\u0627\u0639\u0629"});let{orderNumber:n,receiptData:o}=r.body;e.json({success:!0,message:"\u062A\u0645\u062A \u0627\u0644\u0637\u0628\u0627\u0639\u0629 \u0628\u0646\u062C\u0627\u062D",orderNumber:n,printedBy:r.employee.username,timestamp:new Date().toISOString()})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u0637\u0628\u0627\u0639\u0629"})}}),i.get("/api/pos/hardware-status",w,(r,e)=>{try{e.json({pos:Qt,printer:{connected:!0,status:"ready"},cashDrawer:{connected:!0,status:"closed"},scanner:{connected:!0,status:"ready"}})}catch{e.status(500).json({error:"Failed to get hardware status"})}}),i.post("/api/upload-receipt",ti.single("file"),(r,e)=>{try{if(!r.file)return e.status(400).json({error:"No file uploaded"});let t=`/attached_assets/receipts/${r.file.filename}`;e.json({url:t,filename:r.file.filename})}catch{e.status(500).json({error:"Failed to upload file"})}}),i.post("/api/employees/login-qr",async(r,e)=>{try{let{employeeId:t}=r.body;console.log(`[AUTH-QR] Login attempt for: ${t}`);let n=await he.findOne({id:t});if(n||(n=await he.findOne({employmentNumber:t})),!n)return console.log(`[AUTH-QR] Employee not found: ${t}`),e.status(401).json({error:"Employee not found"});if(n.isActivated===0)return e.status(403).json({error:"\u0647\u0630\u0627 \u0627\u0644\u062D\u0633\u0627\u0628 \u063A\u064A\u0631 \u0645\u0641\u0639\u0644"});r.session.employee={id:n._id.toString(),username:n.username,role:n.role,branchId:n.branchId,fullName:n.fullName,tenantId:n.tenantId},r.session.save(o=>{if(o)return console.error("[AUTH-QR] Session save error:",o),e.status(500).json({error:"Failed to create session"});console.log(`[AUTH-QR] Login successful: ${n.username} (${n.role})`);let d=P(n);delete d.password,e.json(d)})}catch{e.status(500).json({error:"Login failed"})}}),i.post("/api/employees/login",async(r,e)=>{try{let{username:t,password:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0644\u0631\u062C\u0627\u0621 \u0625\u062F\u062E\u0627\u0644 \u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"});console.log(`[AUTH] Login attempt for: ${t}`);let o=await he.findOne({username:t});if(!o||!o.password)return console.log(`[AUTH] Employee not found or no password: ${t}`),e.status(401).json({error:"\u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0623\u0648 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(!await Gt.compare(n,o.password))return console.log(`[AUTH] Invalid password for: ${t}`),e.status(401).json({error:"\u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0623\u0648 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(o.isActivated===0)return e.status(403).json({error:"\u0647\u0630\u0627 \u0627\u0644\u062D\u0633\u0627\u0628 \u063A\u064A\u0631 \u0645\u0641\u0639\u0644"});r.session.employee={id:o._id.toString(),username:o.username,role:o.role,branchId:o.branchId,fullName:o.fullName,tenantId:o.tenantId},r.session.save(m=>{if(m)return console.error("[AUTH] Session save error:",m),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u062C\u0644\u0633\u0629"});console.log(`[AUTH] Login successful: ${t} (${o.role})`);let l=P(o);delete l.password,e.json(l)})}catch(t){console.error("[AUTH] Login failed:",t),e.status(500).json({error:"\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"})}}),i.get("/api/verify-session",(r,e)=>{try{if(!r.session.employee)return e.status(401).json({error:"No active session"});e.json({success:!0,employee:r.session.employee})}catch{e.status(500).json({error:"Session verification failed"})}}),i.get("/api/user",(r,e)=>{try{return r.session.employee?e.json({type:"employee",...r.session.employee}):r.session.customer?e.json({type:"customer",...r.session.customer}):e.status(401).json({error:"Not authenticated"})}catch{e.status(500).json({error:"Failed to get user"})}}),i.post("/api/employees/logout",(r,e)=>{try{r.session.destroy(t=>{if(t)return console.error("Logout session destroy error:",t),e.status(500).json({error:"Logout failed"});e.clearCookie("connect.sid",{path:"/"}),e.json({success:!0,redirect:"/employee/login"})})}catch(t){console.error("Logout catch error:",t),e.status(500).json({error:"Logout failed"})}}),i.post("/api/loyalty/convert",w,async(r,e)=>{try{let{points:t,customerId:n}=r.body;if(!t||t<100||t%100!==0)return e.status(400).json({error:"\u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0627\u0644\u0646\u0642\u0627\u0637 \u0645\u0646 \u0645\u0636\u0627\u0639\u0641\u0627\u062A 100"});let o=await ee.findById(n);if(!o||(o.points||0)<t)return e.status(400).json({error:"\u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let d=t/100*5;o.points=(o.points||0)-t,o.walletBalance=(o.walletBalance||0)+d,await o.save(),e.json({success:!0,newBalance:o.walletBalance,newPoints:o.points,convertedAmount:d})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0633\u062A\u0628\u062F\u0627\u0644 \u0627\u0644\u0646\u0642\u0627\u0637"})}}),i.post("/api/loyalty/transfer",w,async(r,e)=>{try{let{toPhone:t,points:n,pin:o}=r.body,d=k(r)||"demo-tenant",m=r.customer?.id||r.employee?.id;if(!m)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643"});let l=await ee.findById(m);if(!l)return e.status(404).json({error:"\u062D\u0633\u0627\u0628 \u0627\u0644\u0645\u0631\u0633\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(l.walletPin!==o)return e.status(401).json({error:"\u0627\u0644\u0631\u0642\u0645 \u0627\u0644\u0633\u0631\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D"});if((l.points||0)<n)return e.status(400).json({error:"\u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let g=await ee.findOne({phone:t,tenantId:d});if(!g)return e.status(404).json({error:"\u0627\u0644\u0645\u0633\u062A\u0644\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});l.points=(l.points||0)-n,g.points=(g.points||0)+n,await l.save(),await g.save(),await PointTransferModel.create({tenantId:d,fromCustomerId:l.id,toCustomerId:g.id,points:n,status:"completed"}),e.json({success:!0,fromName:l.name,toName:g.name,transferredPoints:n})}catch(t){console.error("Transfer error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u0648\u064A\u0644 \u0627\u0644\u0646\u0642\u0627\u0637"})}});let s=new Map;setInterval(()=>{let r=new Date;for(let[e,t]of s.entries())t.expiresAt<r&&s.delete(e)},6e4),i.post("/api/loyalty/points/request-code",async(r,e)=>{try{let{phone:t,points:n,requestedBy:o}=r.body;if(!t||!n||n<=0)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0639\u062F\u062F \u0627\u0644\u0646\u0642\u0627\u0637 \u0645\u0637\u0644\u0648\u0628"});let d=t.replace(/\D/g,""),l=(L=>L/100*5)(n),g=await f.getLoyaltyCardByPhone(d);if(!g)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});let b=Number(g.points)||0;if(b<n)return e.status(400).json({error:`\u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629. \u0627\u0644\u0631\u0635\u064A\u062F \u0627\u0644\u062D\u0627\u0644\u064A: ${b} \u0646\u0642\u0637\u0629`});let I=s.get(d);if(I&&I.expiresAt>new Date&&new Date().getTime()-(I.expiresAt.getTime()-10*60*1e3)<6e4)return e.status(429).json({error:"\u064A\u0631\u062C\u0649 \u0627\u0644\u0627\u0646\u062A\u0638\u0627\u0631 \u0642\u0628\u0644 \u0637\u0644\u0628 \u0631\u0645\u0632 \u062C\u062F\u064A\u062F"});let A=Math.floor(1e3+Math.random()*9e3).toString();s.set(d,{code:A,points:Number(n),valueSAR:l,cardId:g.id,customerId:g.customerId,expiresAt:new Date(Date.now()+10*60*1e3),verified:!1,requestedBy:o||"customer",attempts:0});let S=await ee.findById(g.customerId),C=S?.email,N=S?.name||g.customerName||"\u0639\u0645\u064A\u0644",x=!1;C&&(x=await Sn(C,N,A,n,l)),console.log(`[POINTS-VERIFY] Code generated for ${d}: ${A} (${n} pts = ${l} SAR)`),ye.broadcastToCustomer(g.customerId.toString(),{type:"points_verification_code",code:A,points:Number(n),valueSAR:l,expiresAt:new Date(Date.now()+10*60*1e3)}),e.json({success:!0,message:x?"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0631\u0645\u0632 \u0627\u0644\u062A\u0623\u0643\u064A\u062F \u0625\u0644\u0649 \u0628\u0631\u064A\u062F\u0643 \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A":"\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u0631\u0645\u0632 \u0627\u0644\u062A\u0623\u0643\u064A\u062F",expiresIn:600,emailSent:x,maskedEmail:C?C.replace(/(.{2})(.*)(@.*)/,"$1***$3"):null,points:Number(n),valueSAR:l,...x?{}:{devCode:A}})}catch(t){console.error("[POINTS-VERIFY] Error requesting code:",t),e.status(500).json({error:"\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u0625\u0646\u0634\u0627\u0621 \u0631\u0645\u0632 \u0627\u0644\u062A\u0623\u0643\u064A\u062F"})}}),i.post("/api/loyalty/points/verify-code",async(r,e)=>{try{let{phone:t,code:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0627\u0644\u0631\u0645\u0632 \u0645\u0637\u0644\u0648\u0628"});let o=t.replace(/\D/g,""),d=s.get(o);if(!d)return e.status(404).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u0639\u062B\u0648\u0631 \u0639\u0644\u0649 \u0631\u0645\u0632 \u062A\u0623\u0643\u064A\u062F. \u064A\u0631\u062C\u0649 \u0637\u0644\u0628 \u0631\u0645\u0632 \u062C\u062F\u064A\u062F"});if(d.expiresAt<new Date)return s.delete(o),e.status(400).json({error:"\u0627\u0646\u062A\u0647\u062A \u0635\u0644\u0627\u062D\u064A\u0629 \u0627\u0644\u0631\u0645\u0632. \u064A\u0631\u062C\u0649 \u0637\u0644\u0628 \u0631\u0645\u0632 \u062C\u062F\u064A\u062F"});if(d.attempts>=5)return s.delete(o),e.status(429).json({error:"\u062A\u0645 \u062A\u062C\u0627\u0648\u0632 \u0639\u062F\u062F \u0627\u0644\u0645\u062D\u0627\u0648\u0644\u0627\u062A. \u064A\u0631\u062C\u0649 \u0637\u0644\u0628 \u0631\u0645\u0632 \u062C\u062F\u064A\u062F"});if(d.attempts+=1,d.code!==n.toString().trim())return e.status(400).json({error:`\u0627\u0644\u0631\u0645\u0632 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D. \u0627\u0644\u0645\u062D\u0627\u0648\u0644\u0627\u062A \u0627\u0644\u0645\u062A\u0628\u0642\u064A\u0629: ${5-d.attempts}`});d.verified=!0;let m=`pv_${o}_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;s.set(o,{...d,code:m}),console.log(`[POINTS-VERIFY] Code verified for ${o}. Token: ${m}`),e.json({success:!0,verified:!0,verificationToken:m,points:d.points,valueSAR:d.valueSAR,message:"\u062A\u0645 \u0627\u0644\u062A\u062D\u0642\u0642 \u0628\u0646\u062C\u0627\u062D! \u064A\u0645\u0643\u0646 \u0627\u0644\u0622\u0646 \u062E\u0635\u0645 \u0627\u0644\u0646\u0642\u0627\u0637"})}catch(t){console.error("[POINTS-VERIFY] Error verifying code:",t),e.status(500).json({error:"\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0631\u0645\u0632"})}}),i.post("/api/wallet/pay",w,async(r,e)=>{try{let{customerId:t,amount:n}=r.body,o=await ee.findById(t);if(!o)return e.status(404).json({error:"\u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if((o.walletBalance||0)<n)return e.status(400).json({error:"\u0627\u0644\u0631\u0635\u064A\u062F \u063A\u064A\u0631 \u0643\u0627\u0641\u064D"});o.walletBalance=(o.walletBalance||0)-n,await o.save(),e.json({success:!0,balance:o.walletBalance})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0639\u0645\u0644\u064A\u0629 \u0627\u0644\u062F\u0641\u0639 \u0645\u0646 \u0627\u0644\u0645\u062D\u0641\u0638\u0629"})}}),i.get("/api/employees/me",w,async(r,e)=>{try{let t=await f.getEmployee(r.employee.id);if(!t)return e.status(404).json({error:"Employee not found"});let{password:n,...o}=t;e.json(o)}catch{e.status(500).json({error:"Failed to fetch employee"})}}),i.get("/api/employees/:id",w,j,async(r,e)=>{try{let{id:t}=r.params,n=await f.getEmployee(t);if(!n)return e.status(404).json({error:"Employee not found"});if(r.employee?.role!=="admin"&&n.branchId!==r.employee?.branchId)return e.status(403).json({error:"Access denied - different branch"});let{password:o,_id:d,...m}=n;e.json({...m,id:d||m.id})}catch{e.status(500).json({error:"Failed to fetch employee"})}}),i.post("/api/employees",w,j,async(r,e)=>{try{let{EmployeeModel:t}=await Promise.resolve().then(()=>(T(),R)),n=r.employee?.tenantId||"demo-tenant",o=r.body;if(r.employee?.role!=="admin")if(r.employee?.branchId){if(o.branchId&&o.branchId!==r.employee.branchId)return e.status(403).json({error:"Cannot create employee in different branch"});o.branchId=r.employee.branchId}else return e.status(403).json({error:"Manager must have a branch assigned"});if(await f.getEmployeeByUsername(o.username))return e.status(400).json({error:"Username already exists"});let m=await t.create({...o,permissions:o.permissions||[],allowedPages:o.allowedPages||[],tenantId:n,id:Pe(),isActivated:o.password?1:0,createdAt:new Date,updatedAt:new Date}),l=P(m),{password:g,...b}=l;e.status(201).json(b)}catch(t){console.error("Error creating employee:",t),e.status(500).json({error:"Failed to create employee"})}}),i.get("/api/employees",w,j,async(r,e)=>{try{let t=await f.getEmployees(),n=ur(t,r.employee);r.employee?.role!=="admin"&&r.employee?.role!=="owner"&&(n=n.filter(d=>d.role!=="admin"&&d.role!=="owner"&&d.role!=="manager"));let o=n.map(d=>{let{password:m,_id:l,...g}=d;return{...g,id:l||g.id}});e.json(o)}catch{e.status(500).json({error:"Failed to fetch employees"})}}),i.get("/api/employees/active-cashiers",w,j,async(r,e)=>{try{let t=await f.getActiveCashiers(),o=ur(t,r.employee).map(d=>{let{password:m,_id:l,...g}=d;return{...g,id:l||g.id}});e.json(o)}catch{e.status(500).json({error:"Failed to fetch active cashiers"})}}),i.put("/api/employees/:id",w,j,async(r,e)=>{try{let{id:t}=r.params,n=r.body,o=await f.getEmployee(t);if(!o)return e.status(404).json({error:"Employee not found"});if(r.employee?.role!=="admin"&&o.branchId!==r.employee?.branchId)return e.status(403).json({error:"Access denied - different branch"});let d=await f.updateEmployee(t,n);if(!d)return e.status(404).json({error:"Employee not found"});let{password:m,_id:l,...g}=d;e.json({...g,id:l||g.id})}catch{e.status(500).json({error:"Failed to update employee"})}}),i.post("/api/employees/activate",async(r,e)=>{try{let{EmployeeModel:t}=await Promise.resolve().then(()=>(T(),R)),{phone:n,fullName:o,password:d}=r.body;if(!n||!o||!d)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0627\u0644\u0627\u0633\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let m=await t.findOne({phone:n.trim(),fullName:{$regex:new RegExp(`^${o.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}$`,"i")},isActivated:0});if(!m)return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0638\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F \u0623\u0648 \u062A\u0645 \u062A\u0641\u0639\u064A\u0644\u0647 \u0645\u0633\u0628\u0642\u0627\u064B"});let g=await(await import("bcryptjs")).hash(d,10),b=await t.findByIdAndUpdate(m._id,{password:g,isActivated:1,updatedAt:new Date},{new:!0});if(!b)return e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0648\u0638\u0641"});let I=P(b),{password:A,...S}=I;e.json(S)}catch(t){console.error("Error activating employee:",t),e.status(500).json({error:"Failed to activate employee"})}}),i.post("/api/employees/reset-password-by-username",async(r,e)=>{try{let{username:t,newPassword:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0627\u0644\u062C\u062F\u064A\u062F\u0629 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});if(n.length<4)return e.status(400).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 4 \u0623\u062D\u0631\u0641"});if(!await f.resetEmployeePasswordByUsername(t,n))return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0638\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({message:"\u062A\u0645 \u062A\u063A\u064A\u064A\u0631 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u063A\u064A\u064A\u0631 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}}),i.post("/api/discount-codes",async(r,e)=>{try{let{insertDiscountCodeSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body);if(await f.getDiscountCodeByCode(n.code))return e.status(400).json({error:"Code already exists"});let d=await f.createDiscountCode(n);e.status(201).json(d)}catch(t){if(t instanceof Error&&"issues"in t)return e.status(400).json({error:"Validation error",details:t});e.status(500).json({error:"Failed to create discount code"})}}),i.get("/api/discount-codes/by-code/:code",async(r,e)=>{try{let{code:t}=r.params,n=await f.getDiscountCodeByCode(t);if(!n)return e.status(404).json({error:"Discount code not found"});if(n.isActive===0)return e.status(400).json({error:"Discount code is inactive"});e.json(n)}catch{e.status(500).json({error:"Failed to fetch discount code"})}}),i.get("/api/discount-codes/employee/:employeeId",async(r,e)=>{try{let{employeeId:t}=r.params,{DiscountCodeModel:n}=await Promise.resolve().then(()=>(T(),R)),o=await n.find({employeeId:t}).lean();e.json(o)}catch{e.status(500).json({error:"Failed to fetch discount codes"})}}),i.patch("/api/discount-codes/:id",async(r,e)=>{try{let{id:t}=r.params,{isActive:n,employeeId:o}=r.body;if(!o)return e.status(401).json({error:"Employee authentication required"});let d=await f.getDiscountCode(t);if(!d)return e.status(404).json({error:"Discount code not found"});if(d.employeeId!==o)return e.status(403).json({error:"Unauthorized: You can only update your own discount codes"});if(typeof n!="number"||n!==0&&n!==1)return e.status(400).json({error:"Only isActive field can be updated (0 or 1)"});let m=await f.updateDiscountCode(t,{isActive:n});e.json(m)}catch{e.status(500).json({error:"Failed to update discount code"})}}),i.post("/api/discount-codes/:id/use",async(r,e)=>{try{let{id:t}=r.params,n=await f.getDiscountCode(t);if(!n)return e.status(404).json({error:"Discount code not found"});if(n.isActive===0)return e.status(400).json({error:"Discount code is inactive"});let o=await f.incrementDiscountCodeUsage(t);e.json(o)}catch{e.status(500).json({error:"Failed to use discount code"})}}),i.post("/api/discount-codes/validate",async(r,e)=>{try{let{code:t,customerId:n}=r.body;if(!t)return e.status(400).json({error:"Discount code is required"});let o=await f.getDiscountCodeByCode(t.trim());if(!o)return console.log(`[DISCOUNT] Code not found: ${t.trim()}`),e.status(404).json({valid:!1,error:"\u0643\u0648\u062F \u0627\u0644\u062E\u0635\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(o.code==="qahwa-card"){if(!n)return e.status(400).json({valid:!1,error:"\u064A\u062C\u0628 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644 \u0644\u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u062E\u0635\u0645 \u0628\u0637\u0627\u0642\u0629 \u0643\u0644\u0648\u0646\u064A"});if(!await f.getCustomer(n))return e.status(404).json({valid:!1,error:"\u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"})}if(console.log("[DISCOUNT] Found code:",JSON.stringify(o)),Number(o.isActive)===0)return console.log(`[DISCOUNT] Code inactive: ${o.code}`),e.status(400).json({valid:!1,error:"\u0643\u0648\u062F \u0627\u0644\u062E\u0635\u0645 \u063A\u064A\u0631 \u0641\u0639\u0627\u0644"});if(o.discountPercentage>=100)return e.status(400).json({valid:!1,error:"\u0643\u0648\u062F \u0627\u0644\u062E\u0635\u0645 100% \u064A\u062A\u0637\u0644\u0628 \u0645\u0648\u0627\u0641\u0642\u0629 \u0627\u0644\u0645\u062F\u064A\u0631. \u064A\u0631\u062C\u0649 \u0627\u0644\u062A\u0648\u0627\u0635\u0644 \u0645\u0639 \u0627\u0644\u0645\u0648\u0638\u0641 \u0627\u0644\u0645\u0633\u0624\u0648\u0644.",requiresApproval:!0});e.json({valid:!0,code:o.code,discountPercentage:o.discountPercentage,reason:o.reason,id:o._id})}catch{e.status(500).json({error:"Failed to validate discount code"})}}),i.get("/api/reports/sales",async(r,e)=>{try{let{period:t,startDate:n,endDate:o,branchId:d}=r.query,m=new Date,l,g=new Date(m.getTime()+24*60*60*1e3);n&&o?(l=new Date(n),g=new Date(o)):t==="daily"?l=new Date(m.setHours(0,0,0,0)):t==="weekly"?l=new Date(m.getTime()-7*24*60*60*1e3):t==="monthly"?l=new Date(m.getFullYear(),m.getMonth(),1):l=new Date(m.setHours(0,0,0,0));let{OrderModel:b}=await Promise.resolve().then(()=>(T(),R)),I={createdAt:{$gte:l,$lte:g},status:{$in:["completed","payment_confirmed"]}};d&&(I.branchId=d);let S=(await b.aggregate([{$match:I},{$group:{_id:null,totalOrders:{$sum:1},totalRevenue:{$sum:"$totalAmount"},orders:{$push:"$$ROOT"}}}]))[0]||{totalOrders:0,totalRevenue:0,orders:[]};e.json({period:t||"custom",startDate:l,endDate:g,totalOrders:S.totalOrders,totalRevenue:S.totalRevenue,orders:S.orders})}catch{e.status(500).json({error:"Failed to generate sales report"})}}),i.post("/api/customers/register",async(r,e)=>{try{let{phone:t,email:n,name:o,password:d,referralCode:m}=r.body;if(!t||!n||!o||!d)return e.status(400).json({error:"\u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0648\u0627\u0644\u0627\u0633\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let l=t.trim().replace(/\s/g,"");if(l.length!==9)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 9 \u0623\u0631\u0642\u0627\u0645"});if(!l.startsWith("5"))return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0628\u062F\u0623 \u0628\u0640 5"});if(!/^5\d{8}$/.test(l))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(o.trim().length<2)return e.status(400).json({error:"\u0627\u0644\u0627\u0633\u0645 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 \u062D\u0631\u0641\u064A\u0646"});if(d.length<4)return e.status(400).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 4 \u0623\u062D\u0631\u0641"});if(await f.getCustomerByPhone(l))return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0645\u0633\u062C\u0644 \u0645\u0633\u0628\u0642\u0627\u064B"});if(await f.getCustomerByEmail(n))return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0633\u062C\u0644 \u0645\u0633\u0628\u0642\u0627\u064B"});let A=await Gt.hash(d,10),S=await f.createCustomer({phone:l,email:n.trim().toLowerCase(),name:o.trim(),password:A});S.email&&_r(S.email,S.name).catch(_=>console.error("Welcome Email Error:",_));let C=null;try{C=await f.createLoyaltyCard({customerName:o.trim(),phoneNumber:l})}catch{}if(m&&m.trim())try{let _=await f.getLoyaltyCardByPhone(m.trim());if(_&&_.phoneNumber!==l){let V=Number(_.points)||0;await f.updateLoyaltyCard(_.id,{points:V+50}),await f.createLoyaltyTransaction({cardId:_.id,type:"referral_bonus",pointsChange:50,discountAmount:0,orderAmount:0,description:`\u0645\u0643\u0627\u0641\u0623\u0629 \u0625\u062D\u0627\u0644\u0629 \u0635\u062F\u064A\u0642 \u062C\u062F\u064A\u062F: ${o.trim()}`}),C&&(await f.updateLoyaltyCard(C.id,{points:50}),await f.createLoyaltyTransaction({cardId:C.id,type:"referral_bonus",pointsChange:50,discountAmount:0,orderAmount:0,description:"\u0645\u0643\u0627\u0641\u0623\u0629 \u0627\u0644\u062A\u0633\u062C\u064A\u0644 \u0628\u0643\u0648\u062F \u0625\u062D\u0627\u0644\u0629"})),console.log(`[REFERRAL] Bonus applied: Referrer ${m} and new customer ${l} each got 50 points`)}}catch(_){console.error("[REFERRAL] Error processing referral code:",_)}let N=P(S),{password:x,...L}=N;r.session.customer=L,e.status(201).json(L)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u062D\u0633\u0627\u0628"})}}),i.post("/api/customers/login",async(r,e)=>{try{let{identifier:t,password:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0623\u0648 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let o=t.trim().replace(/\s/g,""),d,m=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,l;if(m.test(o)){if(l=await f.getCustomerByEmail(o),l){if(!l.password)return e.status(403).json({error:"\u0647\u0630\u0627 \u0627\u0644\u062D\u0633\u0627\u0628 \u062A\u0645 \u062A\u0633\u062C\u064A\u0644\u0647 \u0645\u0646 \u0642\u0628\u0644 \u0627\u0644\u0643\u0627\u0634\u064A\u0631 \u0648\u0644\u0627 \u064A\u062D\u062A\u0648\u064A \u0639\u0644\u0649 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631. \u064A\u0631\u062C\u0649 \u0625\u0646\u0634\u0627\u0621 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631 \u0623\u0648\u0644\u0627\u064B",message:"This account was registered by cashier and has no password. Please set up a password first",requiresPasswordSetup:!0});await Gt.compare(n,l.password)&&(d=l)}}else{if(!/^5\d{8}$/.test(o))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0623\u0648 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(l=await f.getCustomerByPhone(o),l){if(!l.password)return e.status(403).json({error:"\u0647\u0630\u0627 \u0627\u0644\u062D\u0633\u0627\u0628 \u062A\u0645 \u062A\u0633\u062C\u064A\u0644\u0647 \u0645\u0646 \u0642\u0628\u0644 \u0627\u0644\u0643\u0627\u0634\u064A\u0631 \u0648\u0644\u0627 \u064A\u062D\u062A\u0648\u064A \u0639\u0644\u0649 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631. \u064A\u0631\u062C\u0649 \u0625\u0646\u0634\u0627\u0621 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631 \u0623\u0648\u0644\u0627\u064B",message:"This account was registered by cashier and has no password. Please set up a password first",requiresPasswordSetup:!0});d=await f.verifyCustomerPassword(o,n)}}if(!d)return e.status(401).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641/\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0623\u0648 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});let g=P(d),{password:b,...I}=g;r.session.customer=I,e.json(I)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"})}}),i.post("/api/customers/forgot-password",async(r,e)=>{try{let{email:t}=r.body;if(!t)return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0637\u0644\u0648\u0628"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(await f.getCustomerByEmail(t)){let{token:d,expiresAt:m}=await f.createPasswordResetToken(t)}e.json({message:"\u0625\u0630\u0627 \u0643\u0627\u0646 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0648\u062C\u0648\u062F\u0627\u064B\u060C \u0633\u064A\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0631\u0627\u0628\u0637 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0637\u0644\u0628 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}}),i.post("/api/customers/verify-reset-token",async(r,e)=>{try{let{token:t}=r.body;if(!t)return e.status(400).json({error:"\u0627\u0644\u0631\u0645\u0632 \u0645\u0637\u0644\u0648\u0628"});let n=await f.verifyPasswordResetToken(t);if(!n.valid)return e.status(400).json({error:"\u0627\u0644\u0631\u0645\u0632 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D \u0623\u0648 \u0645\u0646\u062A\u0647\u064A \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629"});e.json({valid:!0,email:n.email})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0631\u0645\u0632"})}}),i.post("/api/customers/reset-password",async(r,e)=>{try{let{token:t,newPassword:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0644\u0631\u0645\u0632 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0627\u0644\u062C\u062F\u064A\u062F\u0629 \u0645\u0637\u0644\u0648\u0628\u0629"});if(n.length<4)return e.status(400).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 4 \u0623\u062D\u0631\u0641"});let o=await f.verifyPasswordResetToken(t);if(!o.valid||!o.email)return e.status(400).json({error:"\u0627\u0644\u0631\u0645\u0632 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D \u0623\u0648 \u0645\u0646\u062A\u0647\u064A \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629"});if(!await f.resetCustomerPassword(o.email,n))return e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"});await f.usePasswordResetToken(t),e.json({message:"\u062A\u0645 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0628\u0646\u062C\u0627\u062D. \u062A\u0645 \u062A\u062D\u062F\u064A\u062B \u0631\u0645\u0632 \u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}}),i.post("/api/customers/check-email",async(r,e)=>{try{let{email:t}=r.body;if(!t)return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0637\u0644\u0648\u0628"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});let o=await f.getCustomerByEmail(t);e.json({exists:!!o})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A"})}}),i.post("/api/customers/verify-phone-email",async(r,e)=>{try{let{email:t,phone:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0648\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});let o=n.trim().replace(/\s/g,""),d=await f.getCustomerByEmail(t);if(!d)return e.json({valid:!1});let m=d.phone===o;e.json({valid:m})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"})}}),i.post("/api/customers/reset-password-direct",async(r,e)=>{try{let{email:t,phone:n,newPassword:o}=r.body;if(!t||!n||!o)return e.status(400).json({error:"\u062C\u0645\u064A\u0639 \u0627\u0644\u062D\u0642\u0648\u0644 \u0645\u0637\u0644\u0648\u0628\u0629"});if(o.length<4)return e.status(400).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 4 \u0623\u062D\u0631\u0641"});let d=n.trim().replace(/\s/g,""),m=await f.getCustomerByEmail(t);if(!m||m.phone!==d)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(!await f.resetCustomerPassword(t,o))return e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"});e.json({message:"\u062A\u0645 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0628\u0646\u062C\u0627\u062D. \u062A\u0645 \u062A\u062D\u062F\u064A\u062B \u0631\u0645\u0632 \u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}}),i.post("/api/customers/auth",async(r,e)=>{try{let{phone:t,name:n,password:o}=r.body;if(!t)return e.status(400).json({error:"Phone number required"});let d=t.trim().replace(/\s/g,"");if(!/^5\d{8}$/.test(d))return e.status(400).json({error:"Invalid phone number format"});if(o){let l=await f.verifyCustomerPassword(d,o);if(l){let{password:g,...b}=l,I=P(b);return r.session.customer=I,e.json(I)}return e.status(401).json({error:"Invalid credentials"})}let m=await f.getCustomerByPhone(d);if(m){let{password:l,...g}=m,b=P(g);return r.session.customer=b,e.json(b)}return e.status(400).json({error:"Please use /api/customers/register for new accounts"})}catch{e.status(500).json({error:"Authentication failed"})}}),i.get("/api/customers",async(r,e)=>{try{let n=(await f.getCustomers()).map(o=>{let{password:d,...m}=o.toObject?o.toObject():o;return P(m)});e.json(n)}catch{e.status(500).json({error:"Failed to fetch customers"})}}),i.post("/api/customers/lookup-by-phone",async(r,e)=>{try{let{phone:t}=r.body;if(!t)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0645\u0637\u0644\u0648\u0628"});let n=t.trim().replace(/\s/g,""),o=await f.getCustomerByPhone(n);if(!o)return e.json({found:!1});let d=await f.getLoyaltyCardByPhone(n),{password:m,...l}=o.toObject?o.toObject():o,g=P(l);e.json({found:!0,customer:g,loyaltyCard:d?P(d):null})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u0639\u0645\u064A\u0644"})}}),i.get("/api/customers/by-phone/:phone",async(r,e)=>{try{let t=r.params.phone;if(!t)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0645\u0637\u0644\u0648\u0628"});let n=t.trim().replace(/\s/g,"");if(!/^5\d{8}$/.test(n))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});let o=await f.getCustomerByPhone(n);if(!o)return e.json({});let{password:d,...m}=o.toObject?o.toObject():o,l=P(m),g=null;try{let I=(await f.getPendingTableOrders()).find(A=>A.customerInfo?.customerPhone===n||o._id&&A.customerId?.toString()===o._id.toString());I&&(g=P(I))}catch{}e.json({...l,pendingTableOrder:g})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u0639\u0645\u064A\u0644"})}}),i.get("/api/orders/customer/:identifier",async(r,e)=>{try{let{identifier:t}=r.params,{OrderModel:n,mongoose:o}=await Promise.resolve().then(()=>(T(),R)),d=t.trim().replace(/\s/g,"").replace(/^\+966/,"").replace(/^00966/,""),m=o?.Types?.ObjectId?.isValid?.(t)||/^[a-f\d]{24}$/i.test(t),l=null;try{let A=await f.getCustomerByPhone(d);A&&(l=A._id?.toString()||A.id)}catch{}m&&(l=t);let g=[{"customerInfo.customerPhone":t},{"customerInfo.customerPhone":d},{"customerInfo.phone":t},{"customerInfo.phone":d},{"customerInfo.phoneNumber":t},{"customerInfo.phoneNumber":d},{phone:t},{phone:d}];l&&(g.push({customerId:l}),g.push({customerId:l})),(t.includes("-")||m)&&g.push({customerId:t});let I=(await n.find({$or:g}).sort({createdAt:-1})).map(A=>P(A));console.log(`[GET /api/orders/customer/:identifier] Found ${I.length} orders for identifier ${t}`),e.json(I)}catch(t){console.error("[GET /api/orders/customer/:identifier] Error:",t),e.status(500).json({error:"Failed to fetch customer orders"})}}),i.post("/api/customers/register-by-cashier",async(r,e)=>{try{let{phone:t,name:n,email:o}=r.body;if(!t||!n)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0648\u0627\u0644\u0627\u0633\u0645 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});let d=t.trim().replace(/\s/g,""),m=n.trim(),l=o?o.trim():void 0;if(m.length<2)return e.status(400).json({error:"\u0627\u0644\u0627\u0633\u0645 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644 \u062D\u0631\u0641\u064A\u0646"});if(!/^5\d{8}$/.test(d))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(l&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(await f.getCustomerByPhone(d))return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0645\u0633\u062C\u0644 \u0645\u0633\u0628\u0642\u0627\u064B"});if(l&&await f.getCustomerByEmail(l))return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0633\u062C\u0644 \u0645\u0633\u0628\u0642\u0627\u064B"});let b=await f.createCustomer({phone:d,name:m,email:l,registeredBy:"cashier"});b.email&&_r(b.email,b.name).catch(C=>console.error("Welcome Email Error:",C));try{await f.createLoyaltyCard({customerName:m,phoneNumber:d})}catch{}let{password:I,...A}=b,S=P(A);r.session.customer=S,e.status(201).json(S)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u0639\u0645\u064A\u0644"})}}),i.post("/api/customers/request-password-setup-otp",async(r,e)=>{try{let{phone:t}=r.body;if(!t)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0645\u0637\u0644\u0648\u0628"});let n=t.trim().replace(/\s/g,"");if(!/^5\d{8}$/.test(n))return e.status(400).json({error:"\u0635\u064A\u063A\u0629 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});let o=await f.getCustomerByPhone(n);if(o&&!o.password)try{let{otp:d,expiresAt:m}=await f.createPasswordSetupOTP(n)}catch(d){if(d.message.includes("\u062A\u062C\u0627\u0648\u0632 \u0627\u0644\u062D\u062F"))return e.status(429).json({error:d.message});throw d}e.json({success:!0,message:"\u0625\u0630\u0627 \u0643\u0627\u0646 \u0627\u0644\u0631\u0642\u0645 \u0645\u0633\u062C\u0644\u0627\u064B\u060C \u0633\u064A\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642 \u062E\u0644\u0627\u0644 \u062F\u0642\u0627\u0626\u0642",message_en:"If the number is registered, verification code will be sent within minutes"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0631\u0633\u0627\u0644 \u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642"})}}),i.post("/api/customers/set-password",async(r,e)=>{try{let{phone:t,otp:n,password:o}=r.body;if(!t||!n||!o)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644\u060C \u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let d=t.trim().replace(/\s/g,"");if(o.length<8)return e.status(400).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 8 \u0623\u062D\u0631\u0641 \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644"});if(!/^\d{6}$/.test(n))return e.status(400).json({error:"\u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D"});let m=await f.getCustomerByPhone(d);if(!m)return e.status(404).json({error:"\u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D \u0623\u0648 \u0645\u0646\u062A\u0647\u064A \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629"});if(m.password)return e.status(400).json({error:"\u0647\u0630\u0627 \u0627\u0644\u062D\u0633\u0627\u0628 \u0644\u062F\u064A\u0647 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631 \u0628\u0627\u0644\u0641\u0639\u0644. \u064A\u0631\u062C\u0649 \u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0645\u064A\u0632\u0629 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631",message:"Account already has a password. Use password reset instead"});let l=await f.verifyPasswordSetupOTP(d,n);if(!l.valid)return e.status(400).json({error:l.message||"\u0631\u0645\u0632 \u0627\u0644\u062A\u062D\u0642\u0642 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D"});let g=await Gt.hash(o,10),b=await f.updateCustomer(m._id.toString(),{password:g});if(!b)return e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"});await f.invalidatePasswordSetupOTP(d,n);let{password:I,...A}=b;e.json({success:!0,message:"\u062A\u0645 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0628\u0646\u062C\u0627\u062D. \u064A\u0645\u0643\u0646\u0643 \u0627\u0644\u0622\u0646 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644",customer:P(A)})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631"})}}),i.get("/api/customers/:id",async(r,e)=>{try{let{id:t}=r.params,n=await f.getCustomer(t);if(!n)return e.status(404).json({error:"Customer not found"});e.json(n)}catch{e.status(500).json({error:"Failed to fetch customer"})}}),i.patch("/api/customers/:id",async(r,e)=>{try{let{id:t}=r.params,{name:n,carType:o,carColor:d,saveCarInfo:m}=r.body,l={};n!==void 0&&(l.name=n),o!==void 0&&(l.carType=o),d!==void 0&&(l.carColor=d),m!==void 0&&(l.saveCarInfo=m);let g=await f.updateCustomer(t,l);if(!g)return e.status(404).json({error:"Customer not found"});e.json(P(g))}catch{e.status(500).json({error:"Failed to update customer"})}}),i.get("/api/customers/:id/orders",async(r,e)=>{try{let{id:t}=r.params,o=(await f.getCustomerOrders(t)).map(d=>{let m=P(d),l=m.items;if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}return Array.isArray(l)||(l=[]),{...m,items:l}});e.json(o)}catch{e.status(500).json({error:"Failed to fetch orders"})}}),i.get("/api/coffee-items",async(r,e)=>{try{e.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),e.setHeader("Pragma","no-cache"),e.setHeader("Expires","0");let t=r.query.branchId,n=!!r.session?.employee,o=k(r)||"demo-tenant",d={tenantId:o};t&&t!=="all"&&t!=="undefined"&&t!=="null"&&(d.$or=[{publishedBranches:t},{createdByBranchId:t},{branchId:t}]);let m=await ae.find(d).lean().exec();if(m.length===0&&(m=await ae.find({$or:[{tenantId:o},{tenantId:"demo-tenant"},{tenantId:"default"},{tenantId:"default-branch"},{tenantId:{$exists:!1}},{tenantId:null}]}).lean().exec()),m=m.map(P),m.length>0&&o!=="demo-tenant"){let x=m.filter(L=>L.tenantId===o);x.length>0&&(m=x)}m.length===0&&(console.log(`[GET /api/coffee-items] No items found for tenant ${o}, trying ALL items...`),m=await ae.find({}).lean().exec(),console.log(`[GET /api/coffee-items] Found ${m.length} items total in database`)),console.log(`[GET /api/coffee-items] Found ${m.length} items for tenant ${o}`),m.length>0&&console.log("[GET /api/coffee-items] Item details:",m.slice(0,2).map(x=>({id:x.id,nameAr:x.nameAr,tenantId:x.tenantId,publishedBranches:x.publishedBranches,createdByBranchId:x.createdByBranchId})));let l=m.map(x=>x.id),g=l.length>0?await Ne.find({coffeeItemId:{$in:l}}).lean().exec():[],b=g.map(x=>x.rawItemId),I=b.length>0?await oe.find({_id:{$in:b}}).lean().exec():[],A=new Map(I.map(x=>[x._id?.toString(),x])),S=new Map;g.forEach(x=>{let L=x.coffeeItemId;S.has(L)||S.set(L,[]),S.get(L).push(x)});let C=m.map(x=>{let L=S.get(x.id)||[],_=L.length===0?!1:L.every(ge=>A.has(ge.rawItemId?.toString())),V=x.publishedBranches||[];V.length===0&&!x.createdByBranchId&&(V=["*"]);let K=x.branchAvailability||[],J={},je=V.includes("*")?t?[t]:[]:V.length>0?V:n&&r.employee?.branchId?[r.employee.branchId]:[];for(let ge of je){let Se=K.find($e=>$e.branchId===ge),De=!Se||Se.isAvailable===1||Se.isAvailable===!0?1:0,Ee=De?"available":"out_of_stock";J[ge]={isAvailable:De,status:Ee}}if(!n&&t)x.availabilityByBranch=J,x.isAvailable=J[t]?.isAvailable||0,x.availabilityStatus=J[t]?.status||"out_of_stock";else if(n&&r.employee?.branchId){x.availabilityByBranch=J;let ge=J[r.employee.branchId];x.isAvailable=ge?ge.isAvailable:V.length===0?1:0,x.availabilityStatus=ge?ge.status:V.length===0?"available":"out_of_stock"}else x.availabilityByBranch=J,x.isAvailable=1,x.availabilityStatus="available";return x}),N=C;n&&t&&(N=C.filter(x=>{let L=x.publishedBranches||[];return L.includes("*")||L.length===0||L.includes(t)})),e.json(N)}catch(t){console.error("Error fetching coffee items:",t),e.status(500).json({error:"Failed to fetch coffee items"})}}),i.get("/api/coffee-items/unpublished",w,j,async(r,e)=>{try{if(!r.employee?.branchId)return e.status(403).json({error:"Branch assignment required"});let t=r.employee.tenantId;if(!t){let d=await f.getBranch(r.employee.branchId);d&&d.tenantId&&(t=d.tenantId)}let o=(await ae.find({$or:[{tenantId:t},{tenantId:{$exists:!1}},{tenantId:null}]}).lean().exec()).filter(d=>{let m=d.publishedBranches||[];return!m.includes(r.employee.branchId)&&m.length>0});e.json(o)}catch{e.status(500).json({error:"Failed to fetch unpublished items"})}}),i.post("/api/coffee-items",w,j,async(r,e)=>{try{let{insertCoffeeItemSchema:t}=await Promise.resolve().then(()=>(T(),R)),{adoptFromItemId:n,...o}=r.body,d=k(r)||"demo-tenant",m=r.employee?.branchId||"default-branch";o.tenantId=d;let l=t.parse(o);if(l.tenantId=d,n){let A=await f.getCoffeeItem(n);if(!A||A.tenantId!==d)return e.status(404).json({error:"Original item not found"});l.nameAr||(l.nameAr=A.nameAr),l.description||(l.description=A.description),l.price===void 0&&(l.price=A.price),l.category||(l.category=A.category),l.imageUrl||(l.imageUrl=A.imageUrl),l.coffeeStrength===void 0&&(l.coffeeStrength=A.coffeeStrength),l.id=`${n}-${r.employee?.branchId}`}r.employee?.role==="manager"?l.publishedBranches=[m]:r.employee?.role==="admin"||r.employee?.role==="owner"?(!l.publishedBranches||l.publishedBranches.length===0)&&(l.publishedBranches=l.publishedBranches||[m]):l.publishedBranches=[m],l.isAvailable===void 0&&(l.isAvailable=1),l.availabilityStatus||(l.availabilityStatus="available"),l.createdByEmployeeId=r.employee?.id||"demo-employee",l.createdByBranchId=m,l.id||(l.id=Pe());let b=await new ae({id:l.id,tenantId:d,nameAr:l.nameAr,nameEn:l.nameEn,description:l.description,price:l.price,oldPrice:l.oldPrice,category:l.category,imageUrl:l.imageUrl,isAvailable:l.isAvailable??1,availabilityStatus:l.availabilityStatus||"available",coffeeStrength:l.coffeeStrength,isNewProduct:l.isNewProduct,publishedBranches:l.publishedBranches||[m],createdByEmployeeId:l.createdByEmployeeId,createdByBranchId:l.createdByBranchId,availableSizes:l.availableSizes||[],isGiftable:l.isGiftable||!1,branchAvailability:(l.publishedBranches||[m]).map(A=>({branchId:A,isAvailable:1})),requiresRecipe:l.requiresRecipe!==void 0?l.requiresRecipe:1,hasRecipe:l.hasRecipe!==void 0?l.hasRecipe:0,costOfGoods:0,profitMargin:0,updatedAt:new Date,createdAt:new Date}).save(),I=P(b);if(l.addons&&Array.isArray(l.addons)&&l.addons.length>0)for(let A of l.addons){A.nameAr&&!A.id&&(A.id=Pe());try{await Le.findOneAndUpdate({id:A.id},{$set:{id:A.id,...A,category:A.category||"other",createdAt:new Date}},{upsert:!0,new:!0}),await Yt.findOneAndUpdate({coffeeItemId:I.id,addonId:A.id},{$set:{coffeeItemId:I.id,addonId:A.id,isDefault:0,minQuantity:0,maxQuantity:10,createdAt:new Date}},{upsert:!0})}catch(S){console.error("Error saving addon:",S)}}console.log("[CREATE COFFEE ITEM] Created item:",{id:I.id,nameAr:I.nameAr,tenantId:I.tenantId,imageUrl:I.imageUrl,availableSizes:I.availableSizes?.length||0,branchId:m,publishedBranches:I.publishedBranches}),e.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),e.status(201).json(I)}catch(t){if(console.error("[CREATE COFFEE ITEM] Error:",t),t instanceof Error&&"issues"in t)return e.status(400).json({error:"Validation error",details:t.issues});e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u0645\u0634\u0631\u0648\u0628",details:String(t)})}}),i.patch("/api/coffee-items/:id",w,j,async(r,e)=>{try{let t=await f.updateCoffeeItem(r.params.id,r.body);if(!t)return e.status(404).json({error:"\u0627\u0644\u0645\u0646\u062A\u062C \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch(t){console.error("[PATCH /api/coffee-items/:id] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0645\u0646\u062A\u062C"})}}),i.get("/api/coffee-items/category/:category",async(r,e)=>{try{e.set("Cache-Control","public, max-age=120");let{category:t}=r.params,n=k(r)||"demo-tenant",o=await ae.find({tenantId:n,category:t}).lean().exec();if(!o||o.length===0)return e.json([]);e.json(o.map(P))}catch{e.status(500).json({error:"Failed to fetch coffee items by category"})}}),i.get("/api/coffee-items/:id",async(r,e)=>{try{e.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),e.setHeader("Pragma","no-cache"),e.setHeader("Expires","0");let{id:t}=r.params;console.log(`[GET /api/coffee-items/:id] Searching for ID: "${t}"`);let n=await ae.findOne({id:t}).lean().exec();if(!n)try{n=await ae.findById(t).lean().exec()}catch{}if(!n)return console.warn(`[GET /api/coffee-items/:id] Item not found for ID: "${t}"`),e.status(404).json({error:"\u0627\u0644\u0645\u0646\u062A\u062C \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(P(n))}catch(t){console.error("[GET_COFFEE_ITEM_ERROR]:",t),e.status(500).json({error:"\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u062C\u0644\u0628 \u062A\u0641\u0627\u0635\u064A\u0644 \u0627\u0644\u0645\u0646\u062A\u062C"})}}),i.patch("/api/coffee-items/:id/availability",w,async(r,e)=>{try{let{id:t}=r.params,{branchId:n,isAvailable:o,availabilityStatus:d}=r.body,m=k(r)||"demo-tenant";console.log(`[AVAILABILITY] Updating item ${t} for tenant ${m}, branch ${n}`);let l=await ae.findOne({id:t,tenantId:m}).exec();if(!l&&jt.Types.ObjectId.isValid(t)&&(l=await ae.findOne({_id:t,tenantId:m}).exec()),!l){let I=await ae.findOne({id:t}).exec();I&&(console.warn(`[AVAILABILITY] Item ${t} found globally but NOT for tenant ${m}. Item tenant: ${I.tenantId}`),l=I)}if(!l)return console.error(`[AVAILABILITY] Item not found: id=${t}, tenantId=${m}`),e.status(404).json({error:"Coffee item not found"});let g={};if(o!==void 0&&(g.isAvailable=o?1:0),d!==void 0&&(g.availabilityStatus=d),n){let I=l.branchAvailability||[],A=I.findIndex(C=>C.branchId===n),S=o!==void 0?o?1:0:l.isAvailable??1;A>=0?I[A].isAvailable=S:I.push({branchId:n,isAvailable:S}),g.branchAvailability=I,o!==void 0&&(g.isAvailable=o?1:0)}else o!==void 0&&(g.isAvailable=o?1:0);console.log(`[AVAILABILITY] Applying updates to ${l._id} (ID: ${l.id}):`,JSON.stringify(g));let b=await ae.findOneAndUpdate({_id:l._id},{$set:g},{new:!0}).exec();b&&(console.log("[AVAILABILITY] Update successful. New branchAvailability:",JSON.stringify(b.branchAvailability)),console.log("[AVAILABILITY] Global isAvailable:",b.isAvailable)),e.json(P(b))}catch(t){console.error("Availability Update Error:",t),e.status(500).json({error:"Failed to update coffee item availability"})}}),i.post("/api/coffee-items/:id/branches",async(r,e)=>{try{let{id:t}=r.params,{branchIds:n}=r.body;if(!Array.isArray(n)||n.length===0)return e.status(400).json({error:"branchIds array is required"});let o=await f.getCoffeeItem(t);if(!o)return e.status(404).json({error:"Coffee item not found"});let d=o.branchAvailability||[];n.forEach(l=>{d.findIndex(b=>b.branchId===l)<0&&d.push({branchId:l,isAvailable:1})});let m=await f.updateCoffeeItem(t,{branchAvailability:d});e.json(P(m))}catch{e.status(500).json({error:"Failed to update coffee item branches"})}}),i.get("/api/cart/:sessionId",async(r,e)=>{try{let{sessionId:t}=r.params,n=await ve.find({sessionId:t}).lean();if(!n||n.length===0)return e.json([]);let o=await Promise.all(n.map(async d=>{try{let m=await ae.findOne({id:d.coffeeItemId}).lean(),l=P(d),g=await Promise.all((d.selectedAddons||[]).map(I=>Le.findById(I).lean())),b=d.id||d.coffeeItemId;return console.log(`[CART] Enriching item ${d.coffeeItemId}: Found coffee=${!!m}, addons=${g.length}`),{...l,id:b,coffeeItem:m?P(m):null,enrichedAddons:g.filter(Boolean).map(P)}}catch(m){return console.error("Error enriching cart item:",m),{...P(d),id:d.id||d.coffeeItemId,coffeeItem:null,enrichedAddons:[]}}}));e.json(o)}catch(t){console.error("Fetch cart error:",t),e.status(500).json({error:"Failed to fetch cart items"})}}),i.post("/api/cart",async(r,e)=>{try{let{sessionId:t,coffeeItemId:n,quantity:o,selectedSize:d,selectedAddons:m}=r.body;if(console.log(`[CART] POST: item=${n}, size=${d}, qty=${o}`),!t||!n)return e.status(400).json({error:"Session ID and Coffee Item ID are required"});let l=typeof d=="object"?d?.nameAr:d,g=Array.isArray(m)?m:[],b=l||"default",I=Array.isArray(g)?g.sort().join(","):"",A=`${n}-${b}-${I}`,S=await ve.findOne({sessionId:t,id:A});S?(S.quantity+=o||1,await S.save()):S=await ve.create({id:A,sessionId:t,coffeeItemId:n,quantity:o||1,selectedSize:b,selectedAddons:g,createdAt:new Date});let C=P(S);C.id=A,e.status(201).json(C)}catch(t){console.error("[CART] Post error:",t),e.status(500).json({error:"Failed to add item to cart"})}}),i.put("/api/cart/:sessionId/:cartItemId",async(r,e)=>{try{let{sessionId:t,cartItemId:n}=r.params,{quantity:o}=r.body;if(console.log(`[CART] PUT: session=${t}, id=${n}, qty=${o}`),typeof o!="number"||o<0)return e.status(400).json({error:"Invalid quantity"});if(o===0){console.log(`[CART] Quantity is 0, deleting item: ${n}`);let l=await ve.deleteOne({sessionId:t,id:n});return l.deletedCount===0&&(l=await ve.deleteOne({sessionId:t,coffeeItemId:n,selectedSize:"default"})),l.deletedCount===0&&jt.Types.ObjectId.isValid(n)&&(l=await ve.deleteOne({sessionId:t,_id:n})),e.json({message:"Item removed"})}let d=await ve.findOneAndUpdate({sessionId:t,id:n},{$set:{quantity:o}},{new:!0});if(d||(d=await ve.findOneAndUpdate({sessionId:t,coffeeItemId:n,selectedSize:"default"},{$set:{quantity:o}},{new:!0})),!d&&jt.Types.ObjectId.isValid(n)&&(d=await ve.findOneAndUpdate({sessionId:t,_id:n},{$set:{quantity:o}},{new:!0})),!d)return e.status(404).json({error:"Cart item not found"});let m=P(d);m.id=d.id||d.coffeeItemId,e.json(m)}catch(t){console.error("[CART] Update error:",t),e.status(500).json({error:"Failed to update cart"})}}),i.delete("/api/cart/:sessionId/:cartItemId",async(r,e)=>{try{let{sessionId:t,cartItemId:n}=r.params;console.log(`[CART] DELETE: session=${t}, id=${n}`);let o=await ve.deleteOne({sessionId:t,id:n});if(o.deletedCount===0&&(o=await ve.deleteOne({sessionId:t,coffeeItemId:n,selectedSize:"default"})),o.deletedCount===0&&jt.Types.ObjectId.isValid(n)&&(o=await ve.deleteOne({sessionId:t,_id:n})),o.deletedCount===0)return e.status(404).json({error:"Cart item not found"});e.json({message:"Item removed"})}catch(t){console.error("[CART] Delete error:",t),e.status(500).json({error:"Failed to remove item"})}}),i.delete("/api/cart/:sessionId",async(r,e)=>{try{let{sessionId:t}=r.params;await f.clearCart(t),e.json({message:"Cart cleared"})}catch{e.status(500).json({error:"Failed to clear cart"})}}),i.post("/api/orders",async(r,e)=>{try{console.log("Creating order with body:",JSON.stringify(r.body,null,2));let{items:t,totalAmount:n,paymentMethod:o,paymentDetails:d,paymentReceiptUrl:m,customerInfo:l,customerId:g,customerNotes:b,freeItemsDiscount:I,usedFreeDrinks:A,discountCode:S,discountPercentage:C,deliveryType:N,deliveryAddress:x,deliveryFee:L,branchId:_,tableNumber:V,tableId:K,orderType:J,carType:je,carColor:ge,plateNumber:Se,arrivalTime:De,pointsRedeemed:Ee,pointsValue:$e,pointsVerificationToken:se}=r.body;if(!t||!Array.isArray(t)||t.length===0)return e.status(400).json({error:"Items are required"});if(n==null||isNaN(parseFloat(n)))return e.status(400).json({error:"Valid total amount is required"});if(!o)return e.status(400).json({error:"Payment method is required"});let ie=r.body.customerName||l?.customerName||r.body.customerPhone||"\u0639\u0645\u064A\u0644",it=_||r.employee?.branchId;if(!ie)return console.error("Missing customer name in request. customerInfo:",JSON.stringify(l),"req.body:",JSON.stringify(r.body)),e.status(400).json({error:"Customer name is required"});let We=t;if(typeof t=="string")try{We=JSON.parse(t)}catch{We=[]}if(["alinma","ur","barq","rajhi"].includes(o)&&!m)return e.status(400).json({error:"Payment receipt is required for electronic payment methods"});if(N==="delivery"){if(!x||!x.lat||!x.lng)return e.status(400).json({error:"Delivery address with coordinates is required for delivery orders"});if(L==null)return e.status(400).json({error:"Delivery fee is required for delivery orders"})}let At=g,pt=l?.phoneNumber||r.body.customerPhone;if(pt&&!g)try{let U=await f.getCustomerByPhone(pt);U&&(At=U.id)}catch{}let W=["pos","apple_pay","pos-network","alinma","rajhi","ur","barq","cash","mada","stc-pay","online","neoleap","neoleap-apple-pay"].includes(o)?"payment_confirmed":"pending",Q=k(r)||"demo-tenant";console.log(`[ORDER] Payment method: ${o}, Initial status: ${W}`);let G;if(K&&(J==="table"||J==="dine-in")){let U=await Z.findOne({tableId:K,status:{$in:["open","pending","payment_confirmed"]},branchId:it});if(U){U.items=[...U.items||[],...We],U.totalAmount+=Number(n),U.updatedAt=new Date,U.status==="open"&&W==="payment_confirmed"&&(U.status="payment_confirmed"),G=await U.save();let X=P(G);ye.broadcastOrderUpdate(X),(G.status==="payment_confirmed"||G.status==="confirmed")&&ye.broadcastNewOrder(X)}else{let X=r.body.isOpenTab===!0,Ye=X?"open":W,Ie={orderNumber:`T-${Pe(6).toUpperCase()}`,items:We,totalAmount:Number(n),paymentMethod:X?"cash":o||"cash",status:Ye,tableStatus:X?"open":"pending",orderType:"table",tableId:K,tableNumber:V,branchId:it,tenantId:Q,employeeId:r.employee?.id||null,customerInfo:l||{customerName:ie,phoneNumber:r.body.customerPhone||"",customerEmail:r.body.customerEmail||""},createdAt:new Date,updatedAt:new Date};if(G=await f.createOrder(Ie),G){let we=P(G);X||ye.broadcastNewOrder(we),ye.broadcastOrderUpdate(we)}await f.updateTableOccupancy(K,!0,G.id)}}else{let U={customerId:At||null,totalAmount:Number(n),paymentMethod:o,paymentDetails:d||"",paymentReceiptUrl:m||null,customerInfo:l||{customerName:ie,phoneNumber:r.body.customerPhone||"",customerEmail:r.body.customerEmail||""},customerNotes:b||r.body.notes||"",discountCode:S||null,discountPercentage:C?Number(C):0,deliveryType:N||null,deliveryAddress:x||null,deliveryFee:L?Number(L):0,carType:je||null,carColor:ge||null,plateNumber:Se||null,arrivalTime:De||null,branchId:it,tenantId:Q,status:W,employeeId:r.employee?.id||null,createdBy:r.employee?.username||"system",tableNumber:V||null,tableId:K||null,orderType:J||(V||K?"dine-in":"regular"),items:We,createdAt:new Date,updatedAt:new Date};if(G=await f.createOrder(U),G){let X=P(G);ye.broadcastNewOrder(X),ye.broadcastOrderUpdate(X)}}if(Ee&&Number(Ee)>0)try{let U=Number(Ee),X=Number($e)||U/100*5,Ie=(r.body.customerPhone||l?.phoneNumber)?.replace(/\D/g,"");if(Ie){let we=s.get(Ie);if(!we||!we.verified)console.warn(`[POINTS] Verification not completed for ${Ie}. Points NOT deducted.`);else{let Fe=await f.getLoyaltyCardByPhone(Ie);if(Fe){let Rt=Number(Fe.points)||0;Rt>=U?(await f.updateLoyaltyCard(Fe.id,{points:Rt-U,lastUsedAt:new Date}),await jt.model("LoyaltyTransaction").create({cardId:Fe.id,type:"points_redeemed",pointsChange:-U,description:`\u0627\u0633\u062A\u062E\u062F\u0627\u0645 ${U} \u0646\u0642\u0637\u0629 (${X.toFixed(2)} \u0631\u064A\u0627\u0644) - \u0637\u0644\u0628 #${G.orderNumber}`,orderId:G.id,createdAt:new Date}),await Z.findByIdAndUpdate(G.id,{pointsRedeemed:U,pointsValue:X}),s.delete(Ie),console.log(`[POINTS] Deducted ${U} points (${X} SAR) from ${Ie} for order ${G.orderNumber}`)):console.warn(`[POINTS] Insufficient points for ${Ie}: has ${Rt}, needs ${U}`)}}}}catch(U){console.error("[POINTS] Error deducting points:",U)}let tt=typeof G.customerInfo=="string"?JSON.parse(G.customerInfo):G.customerInfo,rt=tt?.email,ct=tt?.name;rt&&setImmediate(async()=>{try{console.log(`\u{1F4E7} Triggering INITIAL email for order ${G.orderNumber} to ${rt}`);let{sendOrderNotificationEmail:U}=await Promise.resolve().then(()=>(He(),et)),X=await U(rt,ct||"\u0639\u0645\u064A\u0644 CLUNY CAFE",G.orderNumber,"pending",parseFloat(G.totalAmount.toString()));console.log(`\u{1F4E7} INITIAL Email sent result for ${G.orderNumber}: ${X}`)}catch(U){console.error("\u274C Error in initial order email trigger:",U)}});try{let{appendOrderToSheet:U}=await Promise.resolve().then(()=>(Ur(),Lr));await U(G,"NEW_ORDER"),await U(G,"ADMIN_ALERT")}catch(U){console.error("Sheets Error:",U)}let Ce=null;if(it&&t&&t.length>0)try{let U=t.map(X=>{let Ye={coffeeItemId:X.id||X.coffeeItemId,quantity:X.quantity||1};if(X.customization?.selectedAddons&&Array.isArray(X.customization.selectedAddons)){let Ie=X.quantity||1;Ye.addons=X.customization.selectedAddons.filter(we=>we.rawItemId&&we.quantity>0).map(we=>({rawItemId:we.rawItemId,quantity:(we.quantity||1)*(we.quantityPerUnit||1)*Ie,unit:we.unit||"g"}))}return Ye});Ce=await f.deductInventoryForOrder(G.id,it,U,r.employee?.username||"system"),Ce.success||(Ce.warnings.length>0&&console.warn(`[ORDER ${G.orderNumber}] Inventory warnings:`,Ce.warnings),Ce.errors.length>0)}catch{}if(K)try{await f.updateTableOccupancy(K,!0,G.id)}catch{}let Me=l?.phoneNumber||r.body.customerPhone;if(Me&&(Me=Me.toString().trim()),At)try{Me=(await f.getCustomer(At))?.phone||Me}catch{}if(console.log(`[LOYALTY] Attempting to add points for phone: ${Me}`),Me)try{let U=await f.getLoyaltyCardByPhone(Me);U||(console.log(`[LOYALTY] Creating new card for ${Me}`),U=await f.createLoyaltyCard({customerName:ie||l?.customerName||"\u0639\u0645\u064A\u0644",phoneNumber:Me,isActive:1,stamps:0,freeCupsEarned:0,totalSpent:0,points:0,pendingPoints:0}));let Ye=(Array.isArray(We)?We:Array.isArray(t)?t:[]).reduce((we,Fe)=>we+(Number(Fe.quantity)||0),0),Ie=Ye*10;if(console.log(`[LOYALTY] Points to add: ${Ie}, Drinks: ${Ye}, Current points: ${U.points||0}`),Ie>0){let we=Number(U.points)||0,Fe=Number(U.pendingPoints)||0,Rt=parseFloat(U.totalSpent?.toString()||"0");await f.updateLoyaltyCard(U.id,{pendingPoints:Fe+Ie,totalSpent:Rt+parseFloat(n.toString()),lastUsedAt:new Date}),console.log(`[LOYALTY] Updated card ${U.id}: Pending Points ${Fe+Ie}`),await f.createLoyaltyTransaction({cardId:U.id,type:"points_pending",pointsChange:Ie,discountAmount:0,orderAmount:Number(n),orderId:G.id,description:`\u0646\u0642\u0627\u0637 \u0645\u0639\u0644\u0642\u0629: ${Ie} \u0646\u0642\u0637\u0629 \u0645\u0646 \u0627\u0644\u0637\u0644\u0628 \u0631\u0642\u0645 ${G.orderNumber} (\u0633\u062A\u0636\u0627\u0641 \u0639\u0646\u062F \u0627\u0643\u062A\u0645\u0627\u0644 \u0627\u0644\u0637\u0644\u0628)`})}}catch(U){console.error("[LOYALTY] Error processing points:",U)}let de=P(G);if(de.items&&typeof de.items=="string")try{de.items=JSON.parse(de.items)}catch{}if(ye.broadcastNewOrder(de),l&&l.customerEmail)try{let X=parseFloat(n.toString())/1.15,Ye=X*.15,Ie=`INV-${Date.now()}-${Pe(6)}`,we={customerName:l.customerName,customerPhone:l.phoneNumber,items:Array.isArray(t)?t:JSON.parse(t),subtotal:X-parseFloat(C?.toString()||"0")/100*X,discountAmount:parseFloat(C?.toString()||"0")/100*X,taxAmount:Ye,totalAmount:parseFloat(n.toString()),paymentMethod:o,invoiceDate:new Date},Fe=l.customerEmail;Fe&&Fe.includes("@")&&await la(Fe,Ie,we);try{await f.createTaxInvoice({orderId:G.id,customerName:l.customerName,customerPhone:l.phoneNumber,customerEmail:Fe,items:we.items,subtotal:we.subtotal,discountAmount:we.discountAmount,taxAmount:Ye,totalAmount:parseFloat(n.toString()),paymentMethod:o},Ie)}catch{}}catch{}let le={...de,deductionReport:Ce?{success:Ce.success,costOfGoods:Ce.costOfGoods,grossProfit:Ce.grossProfit,deductionDetails:Ce.deductionDetails,shortages:Ce.shortages,warnings:Ce.warnings,errors:Ce.errors}:null};e.status(201).json(le)}catch(t){console.error("[ORDERS] Error creating order:",t),e.status(500).json({error:"Failed to create order",details:t instanceof Error?t.message:String(t)})}}),i.post("/api/orders/:id/finalize",w,async(r,e)=>{try{let{paymentMethod:t,paymentDetails:n}=r.body,o=await Z.findOne({id:r.params.id})||await Z.findById(r.params.id).catch(()=>null);if(!o)return e.status(404).json({error:"Order not found"});if(o.status!=="open")return e.status(400).json({error:"Order is not open"});o.status="payment_confirmed",o.tableStatus="payment_confirmed",o.paymentMethod=t,o.paymentDetails=n,o.updatedAt=new Date,await o.save();let d=P(o);ye.broadcastNewOrder(d),ye.broadcastOrderUpdate(d),o.tableId&&await f.updateTableOccupancy(o.tableId,!1,null),e.json(d)}catch{e.status(500).json({error:"Failed to finalize order"})}}),i.get("/api/orders/table/pending",async(r,e)=>{try{let t=await f.getPendingTableOrders(),n=await f.getCoffeeItems(),o=t.map(d=>{let m=P(d),l=m.items;if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}Array.isArray(l)||(l=[]);let g=l.map(b=>{let I=n.find(A=>A.id===b.coffeeItemId);return{...b,coffeeItem:I?{nameAr:I.nameAr,nameEn:I.nameEn,price:I.price,imageUrl:I.imageUrl}:null}});return{...m,items:g}});e.json(o)}catch{e.status(500).json({error:"Failed to fetch pending table orders"})}}),i.get("/api/orders/table",w,async(r,e)=>{try{let{status:t}=r.query,n=await f.getTableOrders(t),o=ur(n,r.employee),d=await f.getCoffeeItems(),m=o.map(l=>{let g=P(l),b=g.items;if(typeof b=="string")try{b=JSON.parse(b)}catch{b=[]}Array.isArray(b)||(b=[]);let I=b.map(A=>{let S=d.find(C=>C.id===A.coffeeItemId);return{...A,coffeeItem:S?{nameAr:S.nameAr,nameEn:S.nameEn,price:S.price,imageUrl:S.imageUrl}:null}});return{...g,items:I}});e.json(m)}catch{e.status(500).json({error:"Failed to fetch table orders"})}}),i.post("/api/orders/:orderNumber/send-invoice",w,async(r,e)=>{try{let{orderNumber:t}=r.params,{email:n}=r.body;if(!n||!n.includes("@"))return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D"});let o=r.employee;if(!o||!["cashier","manager","admin","owner"].includes(o.role||""))return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0641\u0648\u0627\u062A\u064A\u0631"});let d=await f.getOrderByNumber(t);if(!d)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let m=P(d);if((o.role==="cashier"||o.role==="manager")&&m.branchId&&o.branchId&&m.branchId!==o.branchId)return e.status(403).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D \u0644\u0643 \u0628\u0627\u0644\u0648\u0635\u0648\u0644 \u0644\u0647\u0630\u0627 \u0627\u0644\u0637\u0644\u0628"});let l=m.items;if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}let g=await f.getCoffeeItems(),b=Array.isArray(l)?l.map(J=>{let je=g.find(ge=>ge.id===J.coffeeItemId);return{...J,coffeeItem:je?{nameAr:je.nameAr,price:je.price}:{nameAr:"\u0645\u0646\u062A\u062C",price:J.price||"0"}}}):[],I=parseFloat(m.totalAmount||"0"),S=I/(1+.15),C=I-S,N=parseFloat(m.discountPercentage||"0"),x=N>0?S/(1-N/100)*(N/100):0,L=new Date(m.createdAt||Date.now()),_=`INV-${t}`,V={customerName:m.customerInfo?.customerName||"\u0639\u0645\u064A\u0644",customerPhone:m.customerInfo?.phoneNumber||"",items:b,subtotal:S,discountAmount:x,taxAmount:C,totalAmount:I,paymentMethod:m.paymentMethod||"cash",invoiceDate:L};await la(n,_,V)?e.json({success:!0,message:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629 \u0628\u0646\u062C\u0627\u062D",invoiceNumber:_}):e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629. \u062A\u0623\u0643\u062F \u0645\u0646 \u0625\u0639\u062F\u0627\u062F \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629"})}}),i.get("/api/orders/number/:orderNumber",async(r,e)=>{try{let{orderNumber:t}=r.params,n=await f.getOrderByNumber(t);if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let o=P(n);if(o.items&&typeof o.items=="string")try{o.items=JSON.parse(o.items)}catch{o.items=[]}e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0639\u0644\u0648\u0645\u0627\u062A \u0627\u0644\u0637\u0644\u0628"})}}),i.get("/api/orders/active-display",async(r,e)=>{try{let{OrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n}=r.query,o={status:{$in:["in_progress","preparing","ready"]},createdAt:{$gte:new Date(Date.now()-4*60*60*1e3)}};n&&(o.branchId=n);let m=(await t.find(o).sort({createdAt:1}).limit(50)).map(l=>{let g=P(l),b=0;try{let I=typeof g.items=="string"?JSON.parse(g.items):g.items;b=Array.isArray(I)?I.length:0}catch{b=0}return{id:g.id,orderNumber:g.orderNumber,status:g.status,orderType:g.orderType||g.deliveryType,deliveryType:g.deliveryType,createdAt:g.createdAt,itemCount:b}});e.json(m)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0637\u0644\u0628\u0627\u062A"})}}),i.get("/api/orders/kitchen",w,async(r,e)=>{try{let t=["cashier","manager","admin","owner"];if(!r.employee?.role||!t.includes(r.employee.role))return e.status(403).json({error:"Access denied - insufficient permissions"});let{OrderModel:n}=await Promise.resolve().then(()=>(T(),R)),o={status:{$in:["pending","confirmed","payment_confirmed","in_progress","ready"]}};if(r.employee.role!=="admin"&&r.employee.role!=="owner"){if(r.employee.branchId)o.branchId=r.employee.branchId;else if(r.employee.role==="manager"){let{BranchModel:g}=await Promise.resolve().then(()=>(T(),R)),b=await g.findOne({tenantId:r.employee.tenantId});b&&(o.branchId=b._id.toString())}}let d=await n.find(o).sort({createdAt:1}),m=await f.getCoffeeItems(),l=d.map(g=>{let b=P(g),I=b.items;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=[]}Array.isArray(I)||(I=[]);let A=I.map(S=>{let C=m.find(N=>N.id===S.coffeeItemId);return{...S,coffeeItem:C?{nameAr:C.nameAr,nameEn:C.nameEn,price:C.price,imageUrl:C.imageUrl,category:C.category}:null}});return{...b,items:A}});e.json(l)}catch{e.status(500).json({error:"Failed to fetch kitchen orders"})}}),i.get("/api/orders",w,async(r,e)=>{try{let{limit:t,offset:n}=r.query,o=t?parseInt(t):void 0,d=n?parseInt(n):void 0,m=await f.getOrders(o,d),l=ur(m,r.employee),g=await f.getCoffeeItems(),b=l.map(I=>{let A=P(I),S=A.items;if(typeof S=="string")try{S=JSON.parse(S)}catch{S=[]}Array.isArray(S)||(S=[]);let C=S.map(N=>{let x=g.find(L=>L.id===N.coffeeItemId);return{...N,coffeeItem:x?{nameAr:x.nameAr,nameEn:x.nameEn,price:x.price,imageUrl:x.imageUrl}:null}});return{...A,items:C}});return e.json(b)}catch{return e.status(500).json({error:"Failed to fetch orders"})}}),i.get("/api/orders/:id",async(r,e)=>{try{let{id:t}=r.params,n=await f.getOrder(t);if(!n)return e.status(404).json({error:"Order not found"});if((n.orderType==="dine-in"||n.orderType==="table")&&n.tableNumber){let{TableModel:m}=await Promise.resolve().then(()=>(T(),R)),l=new Date(Date.now()+10*60*1e3);await m.findOneAndUpdate({tableNumber:n.tableNumber,branchId:n.branchId},{isOccupied:1,currentOrderId:n.id,"reservedFor.autoExpiryTime":l,updatedAt:new Date})}let o=P(n),d=await f.getOrderItems(t);e.json({...o,orderItems:d})}catch{e.status(500).json({error:"Failed to fetch order"})}}),setInterval(async()=>{try{let{TableModel:r}=await Promise.resolve().then(()=>(T(),R)),e=new Date,t=await r.find({isOccupied:1,"reservedFor.autoExpiryTime":{$lte:e}});for(let n of t)await r.findOneAndUpdate({_id:n._id},{isOccupied:0,currentOrderId:null,"reservedFor.autoExpiryTime":null,updatedAt:new Date}),typeof ye<"u"&&ye.broadcast({type:"TABLE_AUTO_CLEARED",tableNumber:n.tableNumber,branchId:n.branchId})}catch(r){console.error("Auto-clear tables error:",r)}},6e4),i.post("/api/orders/:id/car-pickup",async(r,e)=>{try{let{id:t}=r.params,{carType:n,carColor:o}=r.body;if(!n||!o)return e.status(400).json({error:"Car type and color are required"});if(!await f.getOrder(t))return e.status(404).json({error:"Order not found"});let m={carType:n,carColor:o},l=await f.updateOrderCarPickup(t,m);if(!l)return e.status(404).json({error:"Failed to update order"});e.json(P(l))}catch{e.status(500).json({error:"Failed to update car pickup info"})}}),i.put("/api/orders/:id/status",w,async(r,e)=>{try{let{id:t}=r.params,{status:n,cancellationReason:o,estimatedPrepTimeInMinutes:d}=r.body;if(!["pending","payment_confirmed","in_progress","ready","completed","cancelled"].includes(n))return e.status(400).json({error:"Invalid status"});let l=await f.getOrder(t);if(!l)return e.status(404).json({error:"Order not found"});let g={status:n,cancellationReason:o,updatedAt:new Date};d!==void 0&&(g.estimatedPrepTimeInMinutes=d,g.prepTimeSetAt=new Date);let b=await f.updateOrderStatus(t,n,o,d);if(!b)return e.status(404).json({error:"Order not found"});if(n==="completed"||n==="ready")try{if(!await TaxInvoiceModel.findOne({orderId:b.id})){let{createZATCAInvoice:S}=await Promise.resolve().then(()=>(Vr(),zr)),C=b.items||[];typeof C=="string"&&(C=JSON.parse(C));let N=C.map(x=>({itemId:x.coffeeItemId||x.id,nameAr:x.coffeeItem?.nameAr||x.nameAr||"\u0645\u0646\u062A\u062C",quantity:x.quantity||1,unitPrice:x.coffeeItem?.price||x.unitPrice||0,taxRate:.15,discountAmount:x.discountAmount||0}));await S({orderId:b.id,orderNumber:b.orderNumber,customerName:b.customerInfo?.customerName||"\u0639\u0645\u064A\u0644 \u0646\u0642\u062F\u064A",customerPhone:b.customerInfo?.customerPhone||"",items:N,paymentMethod:b.paymentMethod||"cash",branchId:b.branchId,createdBy:r.employee?.id,invoiceType:"simplified"}),console.log(`[ZATCA] Auto-generated invoice for order ${b.orderNumber} on status ${n}`)}}catch(A){console.error("[ZATCA] Failed to auto-generate invoice:",A)}if(n==="in_progress"&&l.branchId)try{let A=r.employee?.id||"system";await Qr(t,l.branchId,A)}catch(A){console.error(`[INVENTORY] Auto-deduction failed for order ${l.orderNumber}:`,A)}let I=P(b);if(console.log(`[ORDER] Status updated to ${n} for order #${I.orderNumber}. Broadcasting...`),ye.broadcastOrderUpdate(I),n==="ready"?ye.broadcastOrderReady(I):(n==="payment_confirmed"||n==="confirmed")&&ye.broadcastNewOrder(I),b){let A=typeof b.customerInfo=="string"?JSON.parse(b.customerInfo):b.customerInfo,S=A?.email,C=A?.name;S&&setImmediate(async()=>{try{console.log(`\u{1F4E7} Triggering status change email for order ${b.orderNumber} status: ${n} to ${S}`);let{sendOrderNotificationEmail:N}=await Promise.resolve().then(()=>(He(),et)),x=await N(S,C||"\u0639\u0645\u064A\u0644 CLUNY CAFE",b.orderNumber,n,parseFloat(b.totalAmount.toString()),b);console.log(`\u{1F4E7} Status change email sent result for ${b.orderNumber}: ${x}`)}catch(N){console.error("\u274C Failed to send order status email:",N)}})}ye.broadcastOrderUpdate(I),n==="ready"&&ye.broadcastOrderReady(I);try{let{appendOrderToSheet:A}=await Promise.resolve().then(()=>(Ur(),Lr));await A(I,"ORDER_UPDATE"),await A(I,"ADMIN_ALERT")}catch(A){console.error("Sheets Status Update Error:",A)}try{let S=(typeof I.customerInfo=="string"?JSON.parse(I.customerInfo):I.customerInfo)?.phoneNumber;if(S&&n!=="pending"){let C=Ks(n,I.orderNumber),N=`https://wa.me/${S.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(C)}`;return e.json({...I,whatsappNotification:{url:N,message:C,phone:S}})}}catch{}e.json(I)}catch{e.status(500).json({error:"Failed to update order status"})}}),i.get("/api/cashier/payment-methods",async(r,e)=>{try{let t=[{id:"qahwa-card",nameAr:"\u0628\u0637\u0627\u0642\u0629 \u0643\u0648\u0628\u064A",nameEn:"Qahwa Card",details:"\u0627\u0633\u062A\u062E\u062F\u0645 \u0627\u0644\u0645\u0634\u0631\u0648\u0628\u0627\u062A \u0627\u0644\u0645\u062C\u0627\u0646\u064A\u0629 \u0645\u0646 \u0628\u0637\u0627\u0642\u062A\u0643",icon:"fas fa-gift",requiresReceipt:!1},{id:"cash",nameAr:"\u0627\u0644\u062F\u0641\u0639 \u0646\u0642\u062F\u0627\u064B",nameEn:"Cash Payment",details:"\u0627\u062F\u0641\u0639 \u0639\u0646\u062F \u0627\u0644\u0627\u0633\u062A\u0644\u0627\u0645",icon:"fas fa-money-bill-wave",requiresReceipt:!1},{id:"pos-network",nameAr:"\u0634\u0628\u0643\u0629 (POS)",nameEn:"Network (POS)",details:"\u0627\u0644\u062F\u0641\u0639 \u0639\u0628\u0631 \u062C\u0647\u0627\u0632 \u0646\u0642\u0627\u0637 \u0627\u0644\u0628\u064A\u0639",icon:"fas fa-credit-card",requiresReceipt:!1},{id:"alinma",nameAr:"Alinma Pay",nameEn:"Alinma Pay",details:"0532441566",icon:"fas fa-credit-card",requiresReceipt:!0},{id:"ur",nameAr:"Ur Pay",nameEn:"Ur Pay",details:"0532441566",icon:"fas fa-university",requiresReceipt:!0},{id:"barq",nameAr:"Barq",nameEn:"Barq",details:"0532441566",icon:"fas fa-bolt",requiresReceipt:!0},{id:"rajhi",nameAr:"\u0628\u0646\u0643 \u0627\u0644\u0631\u0627\u062C\u062D\u064A",nameEn:"Al Rajhi Bank",details:"SA78 8000 0539 6080 1942 4738",icon:"fas fa-building-columns",requiresReceipt:!0}];e.json(t)}catch{e.status(500).json({error:"Failed to fetch payment methods"})}}),i.get("/api/loyalty/cards/customer/:customerId",w,async(r,e)=>{try{let{customerId:t}=r.params,n=await f.getCustomer(t);if(!n)return e.status(404).json({error:"\u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let o=await f.getLoyaltyCardByPhone(n.phone);if(!o)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json([o])}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.get("/api/loyalty/transactions/customer/:customerId",w,async(r,e)=>{try{let{customerId:t}=r.params,o=await jt.model("LoyaltyTransaction").find({customerId:t}).sort({createdAt:-1});e.json(o.map(P))}catch(t){console.error("Error fetching loyalty transactions:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0633\u062C\u0644 \u0627\u0644\u0639\u0645\u0644\u064A\u0627\u062A"})}}),i.get("/api/loyalty/cards/phone/:phone",async(r,e)=>{try{let{phone:t}=r.params,n=t.replace(/\D/g,"").slice(-9),o=await f.getLoyaltyCardByPhone(n);if(!o){let d=await f.getCustomerByPhone(n);if(d){let m=await f.createLoyaltyCard({customerName:d.name,phoneNumber:n});return e.json(m)}return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"})}e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.post("/api/admin/fix-loyalty-cards-data",w,async(r,e)=>{try{if(r.employee?.role!=="owner"&&r.employee?.role!=="admin")return e.status(403).json({error:"\u0635\u0644\u0627\u062D\u064A\u0627\u062A \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let t=await f.getLoyaltyCards(),n={totalCards:t.length,cardsFixed:0,cardsUpdated:[],errors:[]};for(let o of t)try{let d=o.stamps||0,m=o.freeCupsEarned||0,l=Math.floor(d/6);if(l>0){let g=d%6,b=m+l;await f.updateLoyaltyCard(o.id||o._id?.toString(),{stamps:g,freeCupsEarned:b}),n.cardsUpdated.push({cardId:o.id||o._id?.toString(),customerName:o.customerName,phoneNumber:o.phoneNumber,stampsConverted:d,freeCupsAdded:l,newFreeCupsEarned:b,remainingStamps:g}),n.cardsFixed++}}catch(d){n.errors.push(`\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0628\u0637\u0627\u0642\u0629: ${o.phoneNumber} - ${d}`)}e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0635\u0644\u0627\u062D \u0628\u064A\u0627\u0646\u0627\u062A \u0628\u0637\u0627\u0642\u0627\u062A \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.post("/api/loyalty/cards",async(r,e)=>{try{let{customerName:t,phoneNumber:n,cardPin:o,cardDesign:d}=r.body;if(!n)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0645\u0637\u0644\u0648\u0628"});if((await f.getLoyaltyCardsByCustomerId("")).find(I=>I.isActive&&I.status!=="cancelled"))return e.status(400).json({error:"\u0644\u062F\u064A\u0643 \u0628\u0637\u0627\u0642\u0629 \u0646\u0634\u0637\u0629 \u0628\u0627\u0644\u0641\u0639\u0644"});let g=await f.getCustomerByPhone(n);if(!g)return e.status(404).json({error:"\u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let b=await f.createLoyaltyCard({customerName:t||g.name,phoneNumber:n});e.status(201).json(b)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.post("/api/loyalty/cards/:cardId/reissue",async(r,e)=>{try{let{cardId:t}=r.params,{newPin:n,cardDesign:o}=r.body,d=await f.getLoyaltyCard(t);if(!d)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});if(d.reissuanceCount>=2)return e.status(400).json({error:"\u0644\u0642\u062F \u0648\u0635\u0644\u062A \u0625\u0644\u0649 \u0627\u0644\u062D\u062F \u0627\u0644\u0623\u0642\u0635\u0649 \u0644\u0625\u0635\u062F\u0627\u0631 \u0628\u0637\u0627\u0642\u0629 \u062C\u062F\u064A\u062F\u0629 (\u0645\u0631\u062A\u064A\u0646 \u0641\u0642\u0637)"});let m=await f.createLoyaltyCard({customerName:d.customerName,phoneNumber:d.phoneNumber});await f.updateLoyaltyCard(t,{isActive:!1,status:"replaced"}),await f.setActiveCard(m.id||m._id?.toString(),d.customerId),e.json({success:!0,message:"\u062A\u0645 \u0625\u0635\u062F\u0627\u0631 \u0628\u0637\u0627\u0642\u0629 \u062C\u062F\u064A\u062F\u0629 \u0628\u0646\u062C\u0627\u062D",card:m})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0635\u062F\u0627\u0631 \u0628\u0637\u0627\u0642\u0629 \u062C\u062F\u064A\u062F\u0629"})}}),i.post("/api/loyalty/cards/:cardId/cancel",async(r,e)=>{try{let{cardId:t}=r.params,{phone:n,email:o,password:d}=r.body;if(!n||!o||!d)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0627\u0644\u0628\u0631\u064A\u062F \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});if(!await f.getLoyaltyCard(t))return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});let l=await f.getCustomerByEmail(o),g=n.trim().replace(/\s/g,"").replace(/^\+966/,"").replace(/^0/,""),b=l?.phone?.trim().replace(/\s/g,"").replace(/^\+966/,"").replace(/^0/,"");if(!l||b!==g)return e.status(401).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});if(!await Gt.compare(d,l.password||""))return e.status(401).json({error:"\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});await f.updateLoyaltyCard(t,{status:"cancelled",isActive:!1}),e.json({success:!0,message:"\u062A\u0645 \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u0628\u0637\u0627\u0642\u0629"})}}),i.post("/api/loyalty/scan",async(r,e)=>{try{let{qrToken:t,orderAmount:n,employeeId:o}=r.body;if(!t||!n)return e.status(400).json({error:"\u0631\u0645\u0632 QR \u0648\u0645\u0628\u0644\u063A \u0627\u0644\u0637\u0644\u0628 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});let d=await f.getLoyaltyCardByQRToken(t);if(!d)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});let m=10,l=parseFloat(n)*m/100,g=parseFloat(n)-l;await f.updateLoyaltyCard(d.id,{discountCount:d.discountCount+1,totalSpent:parseFloat(d.totalSpent.toString())+g,lastUsedAt:new Date}),await f.createLoyaltyTransaction({cardId:d.id,type:"discount_applied",pointsChange:0,discountAmount:l,orderAmount:parseFloat(n.toString()),description:`\u062E\u0635\u0645 ${m}% \u0639\u0644\u0649 \u0627\u0644\u0637\u0644\u0628`,employeeId:o||void 0}),e.json({success:!0,card:{...d,discountCount:d.discountCount+1},discount:{percentage:m,amount:l.toFixed(2),originalAmount:n,finalAmount:g.toFixed(2)}})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0645\u0633\u062D \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.get("/api/loyalty/cards/:cardId/transactions",async(r,e)=>{try{let{cardId:t}=r.params,n=await f.getLoyaltyTransactions(t);e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0639\u0627\u0645\u0644\u0627\u062A \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.get("/api/loyalty/tiers",async(r,e)=>{try{let t=[{id:"bronze",nameAr:"\u0628\u0631\u0648\u0646\u0632\u064A",nameEn:"Bronze",pointsRequired:0,benefits:["\u062E\u0635\u0645 10% \u0639\u0644\u0649 \u0643\u0644 \u0637\u0644\u0628","\u0628\u0637\u0627\u0642\u0629 \u0631\u0642\u0645\u064A\u0629 \u0645\u062C\u0627\u0646\u064A\u0629"],color:"#CD7F32",icon:"\u{1F949}"},{id:"silver",nameAr:"\u0641\u0636\u064A",nameEn:"Silver",pointsRequired:100,benefits:["\u062E\u0635\u0645 15% \u0639\u0644\u0649 \u0643\u0644 \u0637\u0644\u0628","\u0642\u0647\u0648\u0629 \u0645\u062C\u0627\u0646\u064A\u0629 \u0634\u0647\u0631\u064A\u0627\u064B","\u0623\u0648\u0644\u0648\u064A\u0629 \u0641\u064A \u0627\u0644\u0637\u0644\u0628\u0627\u062A"],color:"#C0C0C0",icon:"\u{1F948}"},{id:"gold",nameAr:"\u0630\u0647\u0628\u064A",nameEn:"Gold",pointsRequired:500,benefits:["\u062E\u0635\u0645 20% \u0639\u0644\u0649 \u0643\u0644 \u0637\u0644\u0628","\u0642\u0647\u0648\u062A\u064A\u0646 \u0645\u062C\u0627\u0646\u064A\u062A\u064A\u0646 \u0634\u0647\u0631\u064A\u0627\u064B","\u062F\u0639\u0648\u0627\u062A \u062E\u0627\u0635\u0629 \u0644\u0644\u0641\u0639\u0627\u0644\u064A\u0627\u062A"],color:"#FFD700",icon:"\u{1F947}"},{id:"platinum",nameAr:"\u0628\u0644\u0627\u062A\u064A\u0646\u064A",nameEn:"Platinum",pointsRequired:1e3,benefits:["\u062E\u0635\u0645 25% \u0639\u0644\u0649 \u0643\u0644 \u0637\u0644\u0628","\u0642\u0647\u0648\u0629 \u064A\u0648\u0645\u064A\u0629 \u0645\u062C\u0627\u0646\u064A\u0629","\u062E\u062F\u0645\u0629 VIP","\u0628\u0637\u0627\u0642\u0629 \u0641\u064A\u0632\u064A\u0627\u0626\u064A\u0629 \u0645\u0637\u0628\u0648\u0639\u0629"],color:"#E5E4E2",icon:"platinum"}];e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0633\u062A\u0648\u064A\u0627\u062A \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.get("/api/customer/loyalty-cards",qr,async(r,e)=>{try{let t=r.customer?.id,n=r.customer?.phone;if(!n)return e.status(401).json({error:"\u064A\u0631\u062C\u0649 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"});let o=n.replace(/\D/g,"").slice(-9),d=await f.getLoyaltyCardByPhone(o);if(!d){let m=`CLUNY-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2,6).toUpperCase()}`,l=`QR-${t||o}-${Date.now()}`;d=await f.createLoyaltyCard({customerId:t||o,customerName:r.customer?.name||"\u0639\u0645\u064A\u0644",phoneNumber:o,cardNumber:m,qrToken:l,isActive:1,stamps:0,freeCupsEarned:0,totalSpent:0,points:0,pendingPoints:0})}e.json([d])}catch(t){console.error("[CUSTOMER LOYALTY] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.get("/api/customer/loyalty-transactions",qr,async(r,e)=>{try{let t=r.customer?.phone;if(!t)return e.status(401).json({error:"\u064A\u0631\u062C\u0649 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"});let n=t.replace(/\D/g,"").slice(-9),o=await f.getLoyaltyCardByPhone(n);if(!o)return e.json([]);let m=(await f.getLoyaltyTransactions(o.id)).map(l=>({id:l.id||l._id,type:l.type==="stamps_earned"||l.type==="points_earned"?"earn":"redeem",points:l.pointsChange||0,descriptionAr:l.description,createdAt:l.createdAt}));e.json(m)}catch(t){console.error("[CUSTOMER TRANSACTIONS] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0639\u0627\u0645\u0644\u0627\u062A \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.post("/api/customer/transfer-points",qr,async(r,e)=>{try{let{recipientPhone:t,points:n,pin:o}=r.body,d=r.customer?.phone;if(!d||!t||!n||n<=0)return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});let m=d.replace(/\D/g,"").slice(-9),l=t.replace(/\D/g,"").slice(-9),g=await f.getLoyaltyCardByPhone(m);if(!g)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u062A\u0643 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});let b=await f.getCustomerByPhone(m);if(b?.cardPassword&&b.cardPassword!==o)return e.status(401).json({error:"\u0627\u0644\u0631\u0642\u0645 \u0627\u0644\u0633\u0631\u064A \u063A\u064A\u0631 \u0635\u062D\u064A\u062D"});let I=g.points||0;if(I<n)return e.status(400).json({error:"\u0631\u0635\u064A\u062F \u0627\u0644\u0646\u0642\u0627\u0637 \u063A\u064A\u0631 \u0643\u0627\u0641\u064A"});await f.updateLoyaltyCard(g.id,{points:I-n});let A=await f.getLoyaltyCardByPhone(l),S=await f.getCustomerByPhone(l);if(!A&&S){let C=S._id?.toString()||S.id,N=`CLUNY-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2,6).toUpperCase()}`,x=`QR-${C}-${Date.now()}`;A=await f.createLoyaltyCard({customerId:C,customerName:S.name,phoneNumber:l,cardNumber:N,qrToken:x,isActive:1,stamps:0,freeCupsEarned:0,totalSpent:0,points:0,pendingPoints:0})}if(!A)return e.status(404).json({error:"\u0627\u0644\u0645\u0633\u062A\u0644\u0645 \u063A\u064A\u0631 \u0645\u0633\u062C\u0644 \u0641\u064A \u0627\u0644\u0646\u0638\u0627\u0645"});await f.updateLoyaltyCard(A.id,{points:(A.points||0)+n}),await f.createLoyaltyTransaction({cardId:g.id,customerId:g.customerId,type:"transfer_out",pointsChange:-n,points:-n,description:`\u062A\u062D\u0648\u064A\u0644 \u0646\u0642\u0627\u0637 \u0625\u0644\u0649 ${S?.name||t}`}),await f.createLoyaltyTransaction({cardId:A.id,customerId:A.customerId,type:"transfer_in",pointsChange:n,points:n,description:`\u0627\u0633\u062A\u0644\u0627\u0645 \u0646\u0642\u0627\u0637 \u0645\u0646 ${r.customer?.name||d}`}),e.json({success:!0,message:"\u062A\u0645 \u062A\u062D\u0648\u064A\u0644 \u0627\u0644\u0646\u0642\u0627\u0637 \u0628\u0646\u062C\u0627\u062D",recipientName:S?.name||t})}catch(t){console.error("[TRANSFER POINTS] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u0648\u064A\u0644 \u0627\u0644\u0646\u0642\u0627\u0637"})}}),i.get("/api/loyalty/card/:cardNumber",async(r,e)=>{try{let{cardNumber:t}=r.params,n=await f.getLoyaltyCardByCardNumber(t);if(!n)return e.status(404).json({error:"\u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0648\u0644\u0627\u0621"})}}),i.post("/api/orders/:orderId/generate-codes",async(r,e)=>{try{let{orderId:t}=r.params,n=await f.getOrder(t);if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let d=(Array.isArray(n.items)?n.items:[]).map(l=>({name:l.nameAr||l.name||"\u0645\u0634\u0631\u0648\u0628",quantity:l.quantity||1})),m=await f.generateCodesForOrder(t,d);e.status(201).json(m)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0623\u0643\u0648\u0627\u062F"})}}),i.get("/api/orders/:orderId/codes",async(r,e)=>{try{let{orderId:t}=r.params,n=await f.getCodesByOrder(t);e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0623\u0643\u0648\u0627\u062F"})}}),i.post("/api/loyalty/redeem-code",async(r,e)=>{try{let{code:t,cardId:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0644\u0643\u0648\u062F \u0648\u0645\u0639\u0631\u0641 \u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});let o=await f.redeemCode(t,n);if(!o.success)return e.status(400).json({error:o.message});e.json({success:!0,message:o.message,card:o.card})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0627\u0644\u0643\u0648\u062F"})}}),i.get("/api/ingredients",async(r,e)=>{try{console.warn("\u26A0\uFE0F DEPRECATED: /api/ingredients is deprecated. Use /api/raw-items/by-category/ingredient instead.");let n=(await f.getIngredients()).map(P);e.json(n)}catch{e.status(500).json({error:"Failed to fetch ingredients"})}}),i.post("/api/ingredients",async(r,e)=>{try{console.warn("\u26A0\uFE0F DEPRECATED: POST /api/ingredients is deprecated. Use /api/inventory/raw-items with category='ingredient' instead.");let{insertIngredientSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body),o=await f.createIngredient(n);e.status(201).json(o)}catch{e.status(500).json({error:"Failed to create ingredient"})}}),i.patch("/api/ingredients/:id/availability",async(r,e)=>{try{console.warn("\u26A0\uFE0F DEPRECATED: PATCH /api/ingredients/:id/availability is deprecated. Use PUT /api/inventory/raw-items/:id with isActive field instead.");let{id:t}=r.params,{isAvailable:n}=r.body,o=await f.updateIngredientAvailability(t,n);if(!o)return e.status(404).json({error:"Ingredient not found"});let d=await f.getCoffeeItemsByIngredient(t);for(let m of d)n===0?await f.updateCoffeeItem(m.id,{isAvailable:0,availabilityStatus:`\u0646\u0641\u0630 ${o.nameAr}`}):(await f.getCoffeeItemIngredients(m.id)).every(b=>b.isAvailable===1)&&await f.updateCoffeeItem(m.id,{isAvailable:1,availabilityStatus:"\u0645\u062A\u0648\u0641\u0631"});e.json({ingredient:o,affectedItems:d.length})}catch{e.status(500).json({error:"Failed to update ingredient"})}}),i.get("/api/coffee-items/:id/ingredients",async(r,e)=>{try{let{id:t}=r.params,n=await f.getCoffeeItemIngredients(t);e.json(n)}catch{e.status(500).json({error:"Failed to fetch ingredients"})}}),i.post("/api/coffee-items/:id/ingredients",async(r,e)=>{try{let{id:t}=r.params,{ingredientId:n,quantity:o,unit:d}=r.body,m=await f.addCoffeeItemIngredient(t,n,o,d);e.status(201).json(m)}catch{e.status(500).json({error:"Failed to add ingredient"})}}),i.delete("/api/coffee-items/:id/ingredients/:ingredientId",async(r,e)=>{try{let{id:t,ingredientId:n}=r.params;await f.removeCoffeeItemIngredient(t,n),e.status(204).send()}catch{e.status(500).json({error:"Failed to remove ingredient"})}}),i.get("/api/ingredients/:id/coffee-items",async(r,e)=>{try{let{id:t}=r.params,n=await f.getCoffeeItemsByIngredient(t);e.json(n)}catch{e.status(500).json({error:"Failed to fetch coffee items"})}}),i.get("/api/branches",async(r,e)=>{try{let{BranchModel:t}=await Promise.resolve().then(()=>(T(),R)),n=r.employee?.tenantId||"demo-tenant",o=r.employee?.role,d=r.employee?.branchId,m={};o==="manager"&&d?m={$or:[{id:d},{_id:d}]}:m={isActive:{$in:[1,!0]}};let g=(await t.find(m).lean()).map(b=>({...b,id:b.id||b._id?.toString(),_id:b._id?.toString()}));e.json(g)}catch(t){console.error("Error fetching branches:",t),e.status(500).json({error:"Failed to fetch branches"})}}),i.get("/api/branches/:id",async(r,e)=>{try{let{BranchModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await t.findOne({$or:[{id:r.params.id},{_id:r.params.id}]}).lean();if(!n)return e.status(404).json({error:"Branch not found"});e.json({...n,id:n.id||n._id?.toString(),_id:n._id?.toString()})}catch{e.status(500).json({error:"Failed to fetch branch"})}}),i.get("/api/admin/branches/all",w,j,async(r,e)=>{try{let t=await f.getAllBranches();e.json(t)}catch{e.status(500).json({error:"Failed to fetch branches"})}}),i.post("/api/branches/:id/check-location",async(r,e)=>{try{let{id:t}=r.params,{latitude:n,longitude:o}=r.body;if(typeof n!="number"||typeof o!="number")return e.status(400).json({error:"\u064A\u0631\u062C\u0649 \u0627\u0644\u0633\u0645\u0627\u062D \u0628\u0627\u0644\u0648\u0635\u0648\u0644 \u0644\u0644\u0645\u0648\u0642\u0639",withinRange:!1});let d=await f.getBranch(t);if(!d)return e.status(404).json({error:"\u0627\u0644\u0641\u0631\u0639 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F",withinRange:!1});if(!d.location||!d.location.lat||!d.location.lng)return e.json({withinRange:!0,distance:0,message:"\u0627\u0644\u0641\u0631\u0639 \u0644\u0627 \u064A\u062D\u062A\u0648\u064A \u0639\u0644\u0649 \u0628\u064A\u0627\u0646\u0627\u062A \u0645\u0648\u0642\u0639"});let m=6371e3,l=n*Math.PI/180,g=d.location.lat*Math.PI/180,b=(d.location.lat-n)*Math.PI/180,I=(d.location.lng-o)*Math.PI/180,A=Math.sin(b/2)*Math.sin(b/2)+Math.cos(l)*Math.cos(g)*Math.sin(I/2)*Math.sin(I/2),S=2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A)),C=m*S,N=500,x=C<=N;e.json({withinRange:x,distance:Math.round(C),maxDistance:N,branchName:d.nameAr,message:x?"\u0623\u0646\u062A \u0636\u0645\u0646 \u0646\u0637\u0627\u0642 \u0627\u0644\u0641\u0631\u0639":`\u0623\u0646\u062A \u0628\u0639\u064A\u062F \u0639\u0646 \u0627\u0644\u0641\u0631\u0639 \u0628\u0645\u0633\u0627\u0641\u0629 ${Math.round(C)} \u0645\u062A\u0631. \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 \u0639\u0644\u0649 \u0628\u0639\u062F ${N} \u0645\u062A\u0631 \u0643\u062D\u062F \u0623\u0642\u0635\u0649`})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0645\u0648\u0642\u0639",withinRange:!1})}}),i.post("/api/branches",w,j,async(r,e)=>{try{let{insertBranchSchema:t,BranchModel:n}=await Promise.resolve().then(()=>(T(),R)),o=r.body,{managerAssignment:d,...m}=o,l=r.employee?.tenantId||"demo-tenant",g=m.cafeId||l,b=m.id||Pe(),I=await n.create({...m,id:b,tenantId:l,cafeId:g,isActive:1,createdAt:new Date,updatedAt:new Date}),A=P(I),S=A.id,C=null;if(d)try{if(d.type==="existing"&&d.managerId){let N=await f.getEmployee(d.managerId);N&&(await f.updateEmployee(d.managerId,{branchId:S}),await f.updateBranch(S,{managerName:N.fullName}),C={id:d.managerId,fullName:N.fullName,message:"\u062A\u0645 \u062A\u0639\u064A\u064A\u0646 \u0627\u0644\u0645\u062F\u064A\u0631 \u0627\u0644\u0645\u0648\u062C\u0648\u062F \u0644\u0644\u0641\u0631\u0639 \u0628\u0646\u062C\u0627\u062D."})}else if(d.type==="new"&&d.newManager){let N=d.newManager;if(await f.getEmployeeByUsername(N.username))return e.status(400).json({error:"\u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0645\u0648\u062C\u0648\u062F \u0628\u0627\u0644\u0641\u0639\u0644",field:"username"});let L=await f.createEmployee({username:N.username,password:void 0,fullName:N.fullName,role:"manager",phone:N.phone,jobTitle:"\u0645\u062F\u064A\u0631 \u0627\u0644\u0641\u0631\u0639",isActivated:0,branchId:S,tenantId:l});await f.updateBranch(S,{managerName:N.fullName}),C={id:L._id.toString(),username:N.username,fullName:N.fullName,message:"\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u062D\u0633\u0627\u0628 \u0627\u0644\u0645\u062F\u064A\u0631. \u064A\u062D\u062A\u0627\u062C \u0627\u0644\u0645\u062F\u064A\u0631 \u0644\u062A\u0641\u0639\u064A\u0644 \u062D\u0633\u0627\u0628\u0647 \u0639\u0628\u0631 \u0625\u0646\u0634\u0627\u0621 \u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631."}}}catch{C={error:"\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0641\u0631\u0639 \u0648\u0644\u0643\u0646 \u062D\u062F\u062B \u062E\u0637\u0623 \u0641\u064A \u062A\u0639\u064A\u064A\u0646 \u0627\u0644\u0645\u062F\u064A\u0631"}}else{let N=o.nameAr||"\u0641\u0631\u0639 \u062C\u062F\u064A\u062F",L=`manager_${N.replace(/\s+/g,"_").toLowerCase()}_${Pe(4)}`,_=`manager${Math.random().toString(36).slice(-8)}`;try{let V=await f.createEmployee({username:L,password:_,fullName:`\u0645\u062F\u064A\u0631 ${N}`,role:"manager",phone:o.phone||`05${Math.floor(Math.random()*1e8)}`,jobTitle:"\u0645\u062F\u064A\u0631 \u0627\u0644\u0641\u0631\u0639",isActivated:1,branchId:S,tenantId:l});await f.updateBranch(S,{managerName:`\u0645\u062F\u064A\u0631 ${N}`}),C={id:V.id||V._id?.toString(),username:L,temporaryPassword:_,fullName:`\u0645\u062F\u064A\u0631 ${N}`,message:"\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u062D\u0633\u0627\u0628 \u0627\u0644\u0645\u062F\u064A\u0631 \u062A\u0644\u0642\u0627\u0626\u064A\u0627\u064B. \u064A\u0631\u062C\u0649 \u062D\u0641\u0638 \u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0627\u0644\u0645\u0624\u0642\u062A\u0629."}}catch(V){console.error("Auto-create manager error:",V),C={error:"\u062A\u0645 \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0641\u0631\u0639 \u0648\u0644\u0643\u0646 \u0641\u0634\u0644 \u0625\u0646\u0634\u0627\u0621 \u062D\u0633\u0627\u0628 \u0627\u0644\u0645\u062F\u064A\u0631 \u0627\u0644\u062A\u0644\u0642\u0627\u0626\u064A"}}}e.status(201).json({branch:A,manager:C})}catch(t){if(console.error("Error creating branch:",t),t instanceof Error&&"issues"in t)return e.status(400).json({error:"Validation error",details:t.issues});e.status(500).json({error:"Failed to create branch",details:t instanceof Error?t.message:String(t)})}}),i.put("/api/branches/:id",w,j,async(r,e)=>{try{let{id:t}=r.params,n=await f.updateBranch(t,r.body);if(!n)return e.status(404).json({error:"Branch not found"});e.json(n)}catch{e.status(500).json({error:"Failed to update branch"})}}),i.delete("/api/branches/:id",w,j,async(r,e)=>{try{let{id:t}=r.params;if(!await f.deleteBranch(t))return e.status(404).json({error:"Branch not found"});e.status(204).send()}catch(t){console.error("Error deleting branch:",t),e.status(500).json({error:"Failed to delete branch"})}}),i.get("/api/categories",async(r,e)=>{try{let t=await f.getCategories();e.json(t)}catch{e.status(500).json({error:"Failed to fetch categories"})}}),i.post("/api/categories",async(r,e)=>{try{let{insertCategorySchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body),o=await f.createCategory(n);e.status(201).json(o)}catch(t){if(t instanceof Error&&"issues"in t)return e.status(400).json({error:"Validation error",details:t.issues});e.status(500).json({error:"Failed to create category"})}}),i.put("/api/categories/:id",async(r,e)=>{try{let{id:t}=r.params,n=await f.updateCategory(t,r.body);if(!n)return e.status(404).json({error:"Category not found"});e.json(n)}catch{e.status(500).json({error:"Failed to update category"})}}),i.delete("/api/categories/:id",async(r,e)=>{try{let{id:t}=r.params;if(!await f.deleteCategory(t))return e.status(404).json({error:"Category not found"});e.status(204).send()}catch{e.status(500).json({error:"Failed to delete category"})}}),i.get("/api/admin/customers",async(r,e)=>{try{let n=(await f.getCustomers()).map(({password:o,...d})=>d);e.json(n)}catch{e.status(500).json({error:"Failed to fetch customers"})}}),i.get("/api/admin/orders/employee/:employeeId",async(r,e)=>{try{let{employeeId:t}=r.params,n=await f.getOrdersByEmployee(t);e.json(n)}catch{e.status(500).json({error:"Failed to fetch employee orders"})}}),i.post("/api/reset-manager",async(r,e)=>{try{let t=await f.getEmployeeByUsername("manager");if(t&&t._id){let n=await Gt.hash("2030",10);await f.updateEmployee(t._id.toString(),{password:n}),e.json({message:"Manager password reset successfully"})}else e.status(404).json({error:"Manager not found"})}catch{e.status(500).json({error:"Failed to reset password"})}}),i.get("/api/delivery-zones",async(r,e)=>{try{let t=await f.getDeliveryZones();e.json(t)}catch{e.status(500).json({error:"Failed to fetch delivery zones"})}}),i.get("/api/delivery-zones/:id",async(r,e)=>{try{let t=await f.getDeliveryZone(r.params.id);if(!t)return e.status(404).json({error:"Delivery zone not found"});e.json(t)}catch{e.status(500).json({error:"Failed to fetch delivery zone"})}}),i.post("/api/delivery-zones/validate",async(r,e)=>{try{let{lat:t,lng:n}=r.body;if(!t||!n)return e.status(400).json({error:"Latitude and longitude required"});let o=await f.getDeliveryZones(),{getDeliveryZoneForPoint:d}=await Promise.resolve().then(()=>(Pn(),Cn)),m=o.map(g=>({coordinates:g.boundary||[],nameAr:g.nameAr,deliveryFee:g.baseFee||10,_id:g._id?.toString()||g.id||""})),l=d({lat:t,lng:n},m);if(!l)return e.json({isInZone:!1,message:"\u0639\u0630\u0631\u0627\u064B\u060C \u0647\u0630\u0627 \u0627\u0644\u0645\u0648\u0642\u0639 \u062E\u0627\u0631\u062C \u0646\u0637\u0627\u0642 \u0627\u0644\u062A\u0648\u0635\u064A\u0644. \u0646\u0648\u0635\u0644 \u0641\u0642\u0637 \u0625\u0644\u0649 \u0627\u0644\u0628\u062F\u064A\u0639\u0629 \u0648\u0638\u0647\u0631\u0629 \u0627\u0644\u0628\u062F\u064A\u0639\u0629"});e.json(l)}catch{e.status(500).json({error:"Failed to validate delivery zone"})}}),i.get("/api/tables",w,async(r,e)=>{try{let t=r.employee,n=r.query.branchId;if(t?.role==="admin"){if(n){let l=await f.getTables(n);return e.json(l)}let m=await f.getTables();return e.json(m)}if(t?.role==="manager"){let m=t?.branchId;if(n&&n!==m)return e.status(403).json({error:"Unauthorized: Cannot access other branches"});let l=await f.getTables(m);return e.json(l)}let o=n||t?.branchId;if(!o)return e.status(400).json({error:"Employee branch not assigned"});if(o!==t?.branchId)return e.status(403).json({error:"Unauthorized: Cannot access other branches"});let d=await f.getTables(o);e.json(d)}catch{e.status(500).json({error:"Failed to fetch tables"})}}),i.post("/api/tables/cleanup-reservations",async(r,e)=>{try{let t=await f.getTables(),n=0;for(let o of t)o.reservedFor&&(await f.updateTable(o._id?.toString()||o.id,{reservedFor:void 0}),n++);e.json({message:`Cleaned ${n} tables`,cleaned:n})}catch{e.status(500).json({error:"Failed to clean tables"})}}),i.get("/api/tables/status",async(r,e)=>{try{let{branchId:t}=r.query;if(!t)return e.status(400).json({error:"Branch ID required"});let n=await f.getTables(t),o=new Date,d=n.filter(m=>m.isActive===1||m.isActive===!0||m.isActive==="1").map(m=>{let l=m.toObject?m.toObject():JSON.parse(JSON.stringify(m)),g=l.id||l._id;g&&(l.id=g.toString(),l._id=g.toString());let b=!!l.currentOrderId,I=!1,A=null;if(l.reservedFor&&l.reservedFor.status&&(l.reservedFor.status==="pending"||l.reservedFor.status==="confirmed")){let C=new Date(l.reservedFor.reservationDate),N=l.reservedFor.reservationTime||"12:00",[x,L]=N.split(":").map(Number),_=new Date(C);_.setHours(x||12,L||0,0,0);let V=new Date(_.getTime()-30*60*1e3),K=new Date(_.getTime()+5*60*1e3);o>=V&&o<=K&&(I=!0,A={...l.reservedFor,reservationDateTime:_.toISOString(),activationTime:V.toISOString(),expiryTime:K.toISOString(),isWithinWindow:!0})}let S=b||I;return{...l,isAvailable:!S,isOccupied:S?1:0,reservationInfo:A}});console.log(`[GET /api/tables/status] Fetched ${d.length} tables for branch ${t}`),e.json(d)}catch(t){console.error("[GET /api/tables/status] Error:",t),e.status(500).json({error:"Failed to fetch table status"})}}),i.get("/api/tables/available",async(r,e)=>{try{let{branchId:t}=r.query;if(!t)return e.status(400).json({error:"Branch ID required"});let o=(await f.getTables(t)).filter(d=>{let m=d.isActive===1||d.isActive===!0||d.isActive==="1",l=!d.reservedFor||d.reservedFor&&d.reservedFor.status!=="pending"&&d.reservedFor.status!=="confirmed";return m&&l});e.json(o)}catch{e.status(500).json({error:"Failed to fetch available tables"})}}),i.post("/api/tables/book",async(r,e)=>{try{let{tableId:t,arrivalTime:n}=r.body;if(console.log(`[TABLES] Booking request: tableId=${t}, arrivalTime=${n}`),!t||!n)return e.status(400).json({error:"Table ID and arrival time required"});let o=await f.getTable(t);if(console.log("[TABLES] Found table:",o?{id:o.id,tableNumber:o.tableNumber}:"NOT FOUND"),!o)return e.status(404).json({error:"Table not found"});if(o.reservedFor&&(o.reservedFor.status==="pending"||o.reservedFor.status==="confirmed")){let g=new Date,b=new Date(o.reservedFor.reservationDate),I=o.reservedFor.reservationTime||"12:00",[A,S]=I.split(":").map(Number),C=new Date(b);C.setHours(A||12,S||0,0,0);let N=new Date(C.getTime()+5*60*1e3);if(g<N)return e.status(400).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u062D\u062C\u0648\u0632\u0629 \u0628\u0627\u0644\u0641\u0639\u0644"});console.log(`[TABLES] Auto-clearing expired reservation for table ${o.tableNumber}`)}let d=Pe(),m=new Date;if(!await f.updateTable(t,{reservedFor:{customerName:"Online Dine-In Customer",customerPhone:"N/A",customerId:"customer",reservationDate:m,reservationTime:n,numberOfGuests:o.capacity||2,reservedAt:m,reservedBy:"customer",status:"pending"}}))return e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u062C\u0632 \u0627\u0644\u0637\u0627\u0648\u0644\u0629"});e.json({success:!0,bookingId:d,tableNumber:o.tableNumber,arrivalTime:n,message:`\u062A\u0645 \u062D\u062C\u0632 \u0627\u0644\u0637\u0627\u0648\u0644\u0629 ${o.tableNumber} \u0628\u0646\u062C\u0627\u062D`})}catch(t){console.error("[TABLES] Booking error:",t?.message||t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u062C\u0632 \u0627\u0644\u0637\u0627\u0648\u0644\u0629"})}}),i.get("/api/tables/:id",async(r,e)=>{try{let t=await f.getTable(r.params.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0637\u0627\u0648\u0644\u0629"})}}),i.get("/api/tables/qr/:qrToken",async(r,e)=>{try{let t=await f.getTableByQRToken(r.params.qrToken);if(!t)return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0637\u0627\u0648\u0644\u0629"})}}),i.put("/api/tables/:id",async(r,e)=>{try{let{insertTableSchema:t}=await Promise.resolve().then(()=>(T(),R)),o=t.partial().parse(r.body),d=await f.updateTable(r.params.id,o);if(!d)return e.status(404).json({error:"Table not found"});e.json(d)}catch(t){if(t instanceof Error&&"issues"in t)return e.status(400).json({error:"Validation error",details:t.issues});e.status(500).json({error:"Failed to update table"})}}),i.patch("/api/tables/:id/occupancy",async(r,e)=>{try{let{isOccupied:t,currentOrderId:n}=r.body,o=await f.updateTableOccupancy(r.params.id,!!t,n);if(!o)return e.status(404).json({error:"Table not found"});e.json(o)}catch{e.status(500).json({error:"Failed to update table occupancy"})}}),i.patch("/api/tables/:id/toggle-active",async(r,e)=>{try{let t=await f.getTable(r.params.id);if(!t)return e.status(404).json({error:"Table not found"});let n=await f.updateTable(r.params.id,{isActive:t.isActive?0:1});e.json(n)}catch{e.status(500).json({error:"Failed to toggle table status"})}}),i.delete("/api/tables/:id",async(r,e)=>{try{if(!await f.deleteTable(r.params.id))return e.status(404).json({error:"Table not found"});e.status(204).send()}catch{e.status(500).json({error:"Failed to delete table"})}}),i.post("/api/tables/:id/empty",w,j,async(r,e)=>{try{let{id:t}=r.params,{TableModel:n}=await Promise.resolve().then(()=>(T(),R)),o=await n.findOneAndUpdate({$or:[{id:t},{_id:pr(t)?t:null}].filter(d=>d._id!==null||d.id!==void 0)},{isOccupied:0,currentOrderId:null,reservedFor:null,updatedAt:new Date},{new:!0});if(!o)return e.status(404).json({error:"Table not found"});e.json(P(o))}catch{e.status(500).json({error:"Failed to empty table"})}}),i.patch("/api/tables/:id",w,j,async(r,e)=>{try{let{tableNumber:t,capacity:n,branchId:o}=r.body,d={updatedAt:new Date};t!==void 0&&(d.tableNumber=t),n!==void 0&&(d.capacity=n),o!==void 0&&(d.branchId=o);let{TableModel:m}=await Promise.resolve().then(()=>(T(),R)),l=await m.findOneAndUpdate({$or:[{id:r.params.id},{_id:pr(r.params.id)?r.params.id:null}].filter(g=>g._id!==null||g.id!==void 0)},{$set:d},{new:!0});if(!l)return e.status(404).json({error:"Table not found"});e.json(P(l))}catch(t){console.error("Error updating table:",t),e.status(500).json({error:"Failed to update table"})}}),i.post("/api/tables/:id/reserve",async(r,e)=>{try{let{customerName:t,customerPhone:n,employeeId:o,numberOfGuests:d,reservationDate:m,reservationTime:l}=r.body;if(!t||!n||!o)return e.status(400).json({error:"Customer name, phone, and employee ID required"});let g=await f.getEmployee(o);if(!g)return e.status(404).json({error:"Employee not found"});let b=await f.getTable(r.params.id);if(!b)return e.status(404).json({error:"Table not found"});if(b.branchId&&g.branchId&&b.branchId!==g.branchId)return e.status(403).json({error:"Cannot reserve tables in other branches"});let I=d?parseInt(d):2,A=m?new Date(m):new Date,S=l||new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),C=await f.updateTable(r.params.id,{reservedFor:{customerName:t,customerPhone:n,reservationDate:A,reservationTime:S,numberOfGuests:I,reservedAt:new Date,reservedBy:o,status:"pending"}});if(!C)return e.status(404).json({error:"Table not found"});e.json(C)}catch{e.status(500).json({error:"Failed to reserve table"})}}),i.post("/api/tables/:id/release",async(r,e)=>{try{let{id:t}=r.params,{employeeId:n}=r.body;console.log(`[TABLE] Releasing table ${t}, requested by employee: ${n||"none"}`);let o=await f.updateTable(t,{isOccupied:0,reservedFor:null,currentOrderId:null});if(!o)return e.status(404).json({error:"Table not found"});e.json(o)}catch(t){console.error("[TABLE] Failed to release table:",t),e.status(500).json({error:"Failed to release table"})}}),i.post("/api/tables/:id/approve-reservation",async(r,e)=>{try{let t=await f.getTable(r.params.id);if(!t)return e.status(404).json({error:"Table not found"});if(!t.reservedFor||t.reservedFor.status!=="pending")return e.status(400).json({error:"No pending reservation to approve"});let n=await f.updateTable(r.params.id,{reservedFor:{...t.reservedFor,status:"confirmed"}});if(!n)return e.status(404).json({error:"Table not found"});e.json(n)}catch{e.status(500).json({error:"Failed to approve reservation"})}}),i.post("/api/tables/:id/cancel-reservation",async(r,e)=>{try{let t=await f.getTable(r.params.id);if(!t)return e.status(404).json({error:"Table not found"});if(!t.reservedFor||t.reservedFor.status!=="pending")return e.status(400).json({error:"No pending reservation to cancel"});let n=await f.updateTable(r.params.id,{reservedFor:{...t.reservedFor,status:"cancelled"}});if(!n)return e.status(404).json({error:"Table not found"});e.json(n)}catch{e.status(500).json({error:"Failed to cancel reservation"})}}),i.post("/api/tables/customer-reserve",async(r,e)=>{try{let{tableId:t,customerName:n,customerPhone:o,customerId:d,reservationDate:m,reservationTime:l,numberOfGuests:g,branchId:b}=r.body;if(!t||!n||!o||!m||!l||!g)return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0646\u0627\u0642\u0635\u0629"});let I=await f.getTable(t);if(!I)return e.status(404).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});if(I.isOccupied===1)return e.status(400).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u0634\u063A\u0648\u0644\u0629 \u062D\u0627\u0644\u064A\u0627\u064B"});if(I.reservedFor&&(I.reservedFor.status==="pending"||I.reservedFor.status==="confirmed"))return e.status(400).json({error:"\u0627\u0644\u0637\u0627\u0648\u0644\u0629 \u0645\u062D\u062C\u0648\u0632\u0629 \u0628\u0627\u0644\u0641\u0639\u0644"});let S=typeof g=="string"?parseInt(g):g,C=new Date(m),[N,x]=l.split(":");C.setHours(parseInt(N),parseInt(x),0,0);let L=new Date(C.getTime()-5*60*1e3),_=new Date(C.getTime()+60*60*1e3),V=await f.updateTable(t,{reservedFor:{customerName:n.trim(),customerPhone:o.trim(),customerId:d||"customer",reservationDate:C,reservationTime:l,numberOfGuests:S,reservedAt:new Date,reservedBy:d||"customer",status:"pending",autoBookStartTime:L,autoExpiryTime:_,extensionCount:0}});if(!V)return e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u062C\u0632 \u0627\u0644\u0637\u0627\u0648\u0644\u0629"});try{let{sendReservationConfirmationEmail:K}=await Promise.resolve().then(()=>(He(),et)),J=await ee.findOne({phone:o.trim()});J&&J.email&&await K(J.email,n.trim(),I.tableNumber,m,l,S,_.toString())}catch(K){console.error("Failed to send confirmation email:",K)}e.json({success:!0,table:V,message:`\u062A\u0645 \u062D\u062C\u0632 \u0627\u0644\u0637\u0627\u0648\u0644\u0629 ${I.tableNumber} \u0628\u0646\u062C\u0627\u062D`})}catch(t){e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u062D\u062C\u0632",details:String(t)})}}),i.get("/api/tables/reservations/customer/:phone",async(r,e)=>{try{let t=r.params.phone,o=(await fe.find({"reservedFor.customerPhone":t,"reservedFor.status":{$in:["pending","confirmed"]}})).map(d=>({tableId:d._id,tableNumber:d.tableNumber,branchId:d.branchId,reservation:d.reservedFor}));e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u062D\u062C\u0648\u0632\u0627\u062A"})}}),i.post("/api/tables/:tableId/extend-reservation",async(r,e)=>{try{let t=await f.getTable(r.params.tableId);if(!t||!t.reservedFor)return e.status(404).json({error:"\u0627\u0644\u062D\u062C\u0632 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let n=t.reservedFor.extensionCount||0;if(n>0)return e.status(400).json({error:"\u062A\u0645 \u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u062E\u064A\u0627\u0631 \u0627\u0644\u062A\u0645\u062F\u064A\u062F \u0645\u0633\u0628\u0642\u0627\u064B"});let o=new Date((t.reservedFor.autoExpiryTime||new Date).getTime()+60*60*1e3),d=await f.updateTable(r.params.tableId,{reservedFor:{...t.reservedFor,autoExpiryTime:o,extensionCount:n+1,lastExtendedAt:new Date}});e.json({success:!0,message:"\u062A\u0645 \u062A\u0645\u062F\u064A\u062F \u0627\u0644\u062D\u062C\u0632 \u0644\u0645\u062F\u0629 \u0633\u0627\u0639\u0629 \u0625\u0636\u0627\u0641\u064A\u0629",table:d})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u0645\u062F\u064A\u062F \u0627\u0644\u062D\u062C\u0632"})}}),i.post("/api/tables/check-expirations",async(r,e)=>{try{let t=new Date,n=await fe.find({"reservedFor.status":{$in:["pending","confirmed"]}}),o=0;for(let d of n)if(d.reservedFor&&d.reservedFor.reservationDate&&d.reservedFor.reservationTime){let m;if(d.reservedFor.autoExpiryTime)m=new Date(d.reservedFor.autoExpiryTime);else{let l=new Date(d.reservedFor.reservationDate),g=d.reservedFor.reservationTime||"12:00",[b,I]=g.split(":").map(Number),A=new Date(l);A.setHours(b||12,I||0,0,0),m=new Date(A.getTime()+5*60*1e3)}t>m&&!d.currentOrderId&&(d.reservedFor.status="expired",d.isOccupied=0,await d.save(),o++,console.log(`[check-expirations] Expired reservation for table ${d.tableNumber}`))}e.json({message:`\u062A\u0645 \u062A\u062D\u062F\u064A\u062B ${o} \u062D\u062C\u0632 \u0645\u0646\u062A\u0647\u064A \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629`,count:o})}catch(t){console.error("[check-expirations] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0641\u062D\u0635 \u0627\u0644\u062D\u062C\u0648\u0632\u0627\u062A"})}}),i.post("/api/tables/:tableId/approve-reservation",async(r,e)=>{try{let t=await f.getTable(r.params.tableId);if(!t||!t.reservedFor)return e.status(404).json({error:"\u0627\u0644\u062D\u062C\u0632 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let n=await f.updateTable(r.params.tableId,{reservedFor:{...t.reservedFor,status:"confirmed"}});e.json({success:!0,table:n})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u0623\u0643\u064A\u062F \u0627\u0644\u062D\u062C\u0632"})}}),i.post("/api/tables/:tableId/cancel-reservation",async(r,e)=>{try{let t=await f.getTable(r.params.tableId);if(!t||!t.reservedFor)return e.status(404).json({error:"\u0627\u0644\u062D\u062C\u0632 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let n=await f.updateTable(r.params.tableId,{reservedFor:{...t.reservedFor,status:"cancelled"}});e.json({success:!0,message:"\u062A\u0645 \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u062D\u062C\u0632",table:n})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u062D\u062C\u0632"})}}),i.get("/api/drivers",async(r,e)=>{try{let n=(await f.getAvailableDrivers()).map(({password:o,...d})=>d);e.json(n)}catch{e.status(500).json({error:"Failed to fetch drivers"})}}),i.patch("/api/drivers/:id/availability",async(r,e)=>{try{let{isAvailable:t}=r.body,n=await f.updateDriverAvailability(r.params.id,t);if(!n)return e.status(404).json({error:"Driver not found"});let{password:o,...d}=n;e.json(d)}catch{e.status(500).json({error:"Failed to update driver availability"})}}),i.patch("/api/drivers/:id/location",async(r,e)=>{try{let{lat:t,lng:n}=r.body;if(!t||!n)return e.status(400).json({error:"Latitude and longitude required"});let o=await f.updateDriverLocation(r.params.id,{lat:t,lng:n});if(!o)return e.status(404).json({error:"Driver not found"});let{password:d,...m}=o;e.json(m)}catch{e.status(500).json({error:"Failed to update driver location"})}}),i.patch("/api/orders/:id/assign-driver",async(r,e)=>{try{let{driverId:t}=r.body;if(!t)return e.status(400).json({error:"Driver ID required"});let n=await f.assignDriverToOrder(r.params.id,t);if(!n)return e.status(404).json({error:"Order not found"});e.json(n)}catch{e.status(500).json({error:"Failed to assign driver"})}}),i.patch("/api/orders/:id/start-delivery",async(r,e)=>{try{let t=await f.startDelivery(r.params.id);if(!t)return e.status(404).json({error:"Order not found"});e.json(t)}catch{e.status(500).json({error:"Failed to start delivery"})}}),i.patch("/api/orders/:id/complete-delivery",async(r,e)=>{try{let t=await f.completeDelivery(r.params.id);if(!t)return e.status(404).json({error:"Order not found"});e.json(t)}catch{e.status(500).json({error:"Failed to complete delivery"})}}),i.get("/api/delivery/active-orders",async(r,e)=>{try{let t=await f.getActiveDeliveryOrders();e.json(t)}catch{e.status(500).json({error:"Failed to fetch active delivery orders"})}}),i.get("/api/drivers/:id/orders",async(r,e)=>{try{let t=await f.getDriverActiveOrders(r.params.id);e.json(t)}catch{e.status(500).json({error:"Failed to fetch driver orders"})}}),i.get("/api/cashier/customers/search",async(r,e)=>{try{let{phone:t}=r.query;if(!t||typeof t!="string")return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0645\u0637\u0644\u0648\u0628"});let n=t.trim().replace(/\s/g,""),o=await f.getCustomerByPhone(n);o?e.json({exists:!0,customer:{id:o._id,phone:o.phone,name:o.name,email:o.email,points:o.points||0,registeredBy:o.registeredBy,isPasswordSet:o.isPasswordSet||0}}):e.json({exists:!1,phone:n})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u0639\u0645\u064A\u0644"})}}),i.post("/api/cashier/customers/register",async(r,e)=>{try{let{phone:t,name:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u0648\u0627\u0644\u0627\u0633\u0645 \u0645\u0637\u0644\u0648\u0628\u0627\u0646"});let o=t.trim().replace(/\s/g,"");if(o.length!==9||!o.startsWith("5"))return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062A\u0641 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 9 \u0623\u0631\u0642\u0627\u0645 \u0648\u064A\u0628\u062F\u0623 \u0628\u0640 5"});if(await f.getCustomerByPhone(o))return e.status(400).json({error:"\u0627\u0644\u0639\u0645\u064A\u0644 \u0645\u0633\u062C\u0644 \u0628\u0627\u0644\u0641\u0639\u0644"});let m=await f.createCustomer({phone:o,name:n.trim(),registeredBy:"cashier",isPasswordSet:0,points:0});e.status(201).json({id:m._id,phone:m.phone,name:m.name,points:m.points,registeredBy:m.registeredBy,isPasswordSet:m.isPasswordSet})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u0639\u0645\u064A\u0644"})}}),i.patch("/api/orders/:id/cancel-by-customer",async(r,e)=>{try{let{cancellationReason:t}=r.body,{OrderModel:n}=await Promise.resolve().then(()=>(T(),R)),o=await n.findOne({id:r.params.id})||await n.findById(r.params.id).catch(()=>null);if(!o)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(o.tableStatus&&o.tableStatus!=="pending")return e.status(400).json({error:"\u0644\u0627 \u064A\u0645\u0643\u0646 \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u0637\u0644\u0628 \u0628\u0639\u062F \u062A\u0623\u0643\u064A\u062F \u0627\u0644\u062F\u0641\u0639"});if(o.customerId)try{let d=await f.getCustomer(o.customerId);if(d?.phone){let m=await f.getLoyaltyCardByPhone(d.phone);if(m){let l=o.items||[];if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}let g=Array.isArray(l)?l.reduce((S,C)=>S+(C.quantity||0),0):0,b=m.stamps||0,I=m.freeCupsRedeemed||0,A={};if(g>0){let S=Math.max(0,b-g),C=b-S;A.stamps=S,await f.createLoyaltyTransaction({cardId:m.id,type:"stamps_refunded",pointsChange:-C,discountAmount:0,orderAmount:o.totalAmount,description:`\u0627\u0633\u062A\u0631\u062C\u0627\u0639 ${C} \u062E\u062A\u0645 \u0645\u0646 \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u0637\u0644\u0628 #${o.orderNumber}`})}Object.keys(A).length>0&&await f.updateLoyaltyCard(m.id,A)}}}catch{}o.status="cancelled",o.tableStatus="cancelled",o.cancelledBy="customer",o.cancellationReason=t||"\u0625\u0644\u063A\u0627\u0621 \u0645\u0646 \u0627\u0644\u0639\u0645\u064A\u0644",o.updatedAt=new Date,await o.save(),o.tableId&&await f.updateTableOccupancy(o.tableId,!1),e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u0637\u0644\u0628"})}}),i.patch("/api/orders/:id/assign-cashier",async(r,e)=>{try{let{cashierId:t}=r.body,{OrderModel:n}=await Promise.resolve().then(()=>(T(),R));if(!t)return e.status(400).json({error:"\u0645\u0639\u0631\u0641 \u0627\u0644\u0643\u0627\u0634\u064A\u0631 \u0645\u0637\u0644\u0648\u0628"});let o=await n.findOne({id:r.params.id})||await n.findById(r.params.id).catch(()=>null);if(!o)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(o.assignedCashierId)return e.status(400).json({error:"\u0627\u0644\u0637\u0644\u0628 \u0645\u0633\u062A\u0644\u0645 \u0628\u0627\u0644\u0641\u0639\u0644 \u0645\u0646 \u0643\u0627\u0634\u064A\u0631 \u0622\u062E\u0631"});o.assignedCashierId=t,o.updatedAt=new Date,await o.save(),e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0633\u062A\u0644\u0627\u0645 \u0627\u0644\u0637\u0644\u0628"})}}),i.patch("/api/orders/:id/table-status",w,async(r,e)=>{try{let{tableStatus:t}=r.body,{OrderModel:n}=await Promise.resolve().then(()=>(T(),R));if(!t||!["pending","payment_confirmed","preparing","ready","delivered","cancelled"].includes(t))return e.status(400).json({error:"\u062D\u0627\u0644\u0629 \u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});let d=await n.findOne({id:r.params.id})||await n.findById(r.params.id).catch(()=>null);if(!d)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});d.tableStatus=t,d.updatedAt=new Date,t==="payment_confirmed"?d.status="payment_confirmed":t==="delivered"?(d.status="completed",d.tableId&&await f.updateTableOccupancy(d.tableId,!1)):t==="cancelled"&&(d.status="cancelled",d.cancelledBy="cashier",d.tableId&&await f.updateTableOccupancy(d.tableId,!1)),await d.save();let m=P(d);e.json(m)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0627\u0644\u0637\u0644\u0628"})}}),i.get("/api/cashier/:cashierId/orders",async(r,e)=>{try{let{OrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{status:n}=r.query,o=await f.getCoffeeItems(),d={assignedCashierId:r.params.cashierId,orderType:"table"};n&&(d.tableStatus=n);let l=(await t.find(d).sort({createdAt:-1})).map(g=>{let b=P(g),I=b.items;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=[]}Array.isArray(I)||(I=[]);let A=I.map(S=>{let C=o.find(N=>N.id===S.coffeeItemId);return{...S,coffeeItem:C?{nameAr:C.nameAr,nameEn:C.nameEn,price:C.price,imageUrl:C.imageUrl}:null}});return{...b,items:A}});e.json(l)}catch{e.status(500).json({error:"Failed to fetch cashier orders"})}}),i.patch("/api/orders/:id/status",w,async(r,e)=>{try{let{id:t}=r.params,{status:n,cancellationReason:o}=r.body,d=await Z.findOne({id:t})||await Z.findById(t).catch(()=>null);if(!d)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(n==="in_progress"||n==="preparing"||n==="completed"){let l=await Qr(t,d.branchId||"",r.employee.id);l.success||console.error(`[INVENTORY] Deduction failed for order ${t}:`,l.error)}if(n==="completed"&&d.status!=="completed"){try{let{createZATCAInvoice:b}=await Promise.resolve().then(()=>(Vr(),zr)),I=Array.isArray(d.items)?d.items:JSON.parse(d.items||"[]");await b({orderId:d.id,orderNumber:d.orderNumber,customerName:d.customerInfo?.customerName||"\u0639\u0645\u064A\u0644",customerPhone:d.customerInfo?.phone||"",items:I.map(A=>({itemId:A.coffeeItemId,nameAr:A.nameAr||"\u0645\u0646\u062A\u062C",quantity:A.quantity,unitPrice:A.unitPrice||0})),paymentMethod:d.paymentMethod||"cash",branchId:d.branchId,createdBy:r.employee?.id}),console.log(`[ZATCA] Auto-generated invoice for order ${d.orderNumber}`)}catch(b){console.error("[ZATCA] Auto-generation failed:",b)}let l=typeof d.customerInfo=="string"?JSON.parse(d.customerInfo):d.customerInfo,g=l?.phone||l?.phoneNumber;if(g)try{let b=g.replace(/\D/g,"").slice(-9),I=await f.getLoyaltyCardByPhone(b);if(I){let S=(Array.isArray(d.items)?d.items:typeof d.items=="string"?JSON.parse(d.items):[]).reduce((x,L)=>x+(L.quantity||1)*10,0),C=Number(I.points)||0,N=Number(I.pendingPoints)||0;await f.updateLoyaltyCard(I.id,{points:C+S,pendingPoints:Math.max(0,N-S)}),await f.createLoyaltyTransaction({cardId:I.id,type:"points_earned",pointsChange:S,discountAmount:0,orderAmount:Number(d.totalAmount),orderId:d.id,description:`\u062A\u0645 \u0625\u0636\u0627\u0641\u0629 ${S} \u0646\u0642\u0637\u0629 \u0645\u0646 \u0627\u0644\u0637\u0644\u0628 \u0631\u0642\u0645 ${d.orderNumber}`}),console.log(`[LOYALTY] Confirmed ${S} points for ${b} on order completion`)}}catch(b){console.error("[LOYALTY] Error confirming points:",b)}if(d.customerId){let b=d.items.reduce((I,A)=>I+(A.quantity||1)*10,0);await ee.findByIdAndUpdate(d.customerId,{$inc:{points:b,pendingPoints:-b}})}}let m=await Z.findByIdAndUpdate(t,{$set:{status:n,cancellationReason:o,updatedAt:new Date}},{new:!0});if(m){ye.broadcastToBranch(m.branchId,{type:"ORDER_UPDATED",order:P(m)});let l=typeof m.customerInfo=="string"?JSON.parse(m.customerInfo):m.customerInfo,g=l?.email;g&&setImmediate(async()=>{try{let{sendOrderNotificationEmail:b}=await Promise.resolve().then(()=>(He(),et));await b(g,l?.name||"\u0639\u0645\u064A\u0644 CLUNY CAFE",m.orderNumber,n,parseFloat(m.totalAmount.toString()),m)}catch{}})}e.json(P(m))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0627\u0644\u0637\u0644\u0628"})}}),i.post("/api/orders/mark-all-completed",w,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.employee?.branchId,o={tenantId:t,status:{$ne:"completed"}};n&&(o.branchId=n);let d=await Z.updateMany(o,{$set:{status:"completed",updatedAt:new Date}});console.log(`[ORDERS] Marked ${d.modifiedCount} orders as completed for branch ${n}`),e.json({message:"\u062A\u0645 \u062A\u062D\u062F\u064A\u062B \u062C\u0645\u064A\u0639 \u0627\u0644\u0637\u0644\u0628\u0627\u062A \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"Failed to mark all completed"})}}),i.patch("/api/orders/:id/payment-status",w,async(r,e)=>{try{let{id:t}=r.params,{paymentStatus:n,paymentDetails:o}=r.body,d={paymentStatus:n};o&&(d.paymentDetails=o);let m=await Z.findOneAndUpdate({id:t},{$set:d},{new:!0});if(!m&&t.match(/^[0-9a-fA-F]{24}$/)&&(m=await Z.findByIdAndUpdate(t,{$set:d},{new:!0})),!m)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(P(m))}catch(t){console.error("[PAYMENT-STATUS] Error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0627\u0644\u062F\u0641\u0639"})}}),i.patch("/api/orders/complete-all",w,async(r,e)=>{try{let{OrderModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await t.updateMany({$nor:[{status:"completed"},{status:"cancelled"}]},{$set:{status:"completed",tableStatus:"delivered"}});e.json({success:!0,message:`\u062A\u0645 \u062A\u062D\u062F\u064A\u062B ${n.modifiedCount} \u0637\u0644\u0628 \u0625\u0644\u0649 \u062D\u0627\u0644\u0629 \u0645\u0643\u062A\u0645\u0644`,modifiedCount:n.modifiedCount})}catch{e.status(500).json({error:"Failed to complete all orders"})}}),i.post("/api/admin/test-email",w,async(r,e)=>{try{if(r.employee?.role!=="admin"&&r.employee?.role!=="owner")return e.status(403).json({error:"Only admins can test email"});let{testEmailConnection:t}=await Promise.resolve().then(()=>(He(),et)),n=await t();e.json({success:n,message:n?"Email connection successful":"Email connection failed"})}catch{e.status(500).json({error:"Failed to test email connection"})}}),i.delete("/api/admin/cashiers",async(r,e)=>{try{let n=(await f.getEmployees()).filter(m=>m.role==="cashier"),o=0,{EmployeeModel:d}=await Promise.resolve().then(()=>(T(),R));for(let m of n)try{let l=m.id||m._id?.toString();await d.deleteOne({_id:l}),o++}catch{}e.json({message:`\u062A\u0645 \u062D\u0630\u0641 ${o} \u0645\u0648\u0638\u0641\u064A \u0643\u0627\u0634\u064A\u0631 \u0628\u0646\u062C\u0627\u062D`,deletedCount:o})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0645\u0648\u0638\u0641\u064A\u0646"})}}),i.delete("/api/admin/clear-all-data",w,async(r,e)=>{try{if(r.employee?.role!=="admin"&&r.employee?.role!=="owner")return e.status(403).json({error:"Only admins can clear all data"});let{OrderModel:t,CustomerModel:n,CoffeeItemModel:o}=await Promise.resolve().then(()=>(T(),R)),d=await t.deleteMany({}),m=await n.deleteMany({});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u062C\u0645\u064A\u0639 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0628\u0646\u062C\u0627\u062D",deletedOrders:d.deletedCount,deletedCustomers:m.deletedCount})}catch{e.status(500).json({error:"Failed to clear all data"})}});let u=pe.join(import.meta.dirname,"..","attached_assets","employees"),p=Ze.diskStorage({destination:function(r,e,t){t(null,u)},filename:function(r,e,t){let n=`${Date.now()}-${Pe(8)}`;t(null,`employee-${n}${pe.extname(e.originalname)}`)}}),y=Ze({storage:p,limits:{fileSize:5*1024*1024},fileFilter:(r,e,t)=>{let n=/jpeg|jpg|png|webp/,o=n.test(pe.extname(e.originalname).toLowerCase()),d=n.test(e.mimetype);o&&d?t(null,!0):t(new Error("\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D. \u0641\u0642\u0637 \u0635\u0648\u0631 (JPG, PNG, WEBP)"))}});i.post("/api/upload-employee-image",w,j,y.single("image"),(r,e)=>{try{if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let t=`/attached_assets/employees/${r.file.filename}`;e.json({url:t,filename:r.file.filename})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"})}});let h=pe.resolve(mt,"..","attached_assets","drinks"),v=Ze.diskStorage({destination:function(r,e,t){Ht.existsSync(h)||Ht.mkdirSync(h,{recursive:!0}),t(null,h)},filename:function(r,e,t){let n=`${Date.now()}-${Pe(8)}`;t(null,`drink-${n}${pe.extname(e.originalname)}`)}}),D=Ze({storage:v,limits:{fileSize:10*1024*1024},fileFilter:(r,e,t)=>{let n=/jpeg|jpg|png|webp/,o=n.test(pe.extname(e.originalname).toLowerCase()),d=n.test(e.mimetype);o&&d?t(null,!0):t(new Error("\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D. \u0641\u0642\u0637 \u0635\u0648\u0631 (JPG, PNG, WEBP)"))}});i.post("/api/upload-drink-image",w,j,D.single("image"),(r,e)=>{try{if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let t=`/attached_assets/drinks/${r.file.filename}`;console.log(`[UPLOAD] Drink image uploaded successfully: ${t}`),e.json({url:t,filename:r.file.filename})}catch(t){console.error("Upload error:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"})}});let O=pe.resolve(mt,"..","attached_assets","sizes"),M=Ze.diskStorage({destination:function(r,e,t){Ht.existsSync(O)||Ht.mkdirSync(O,{recursive:!0}),t(null,O)},filename:function(r,e,t){let n=`${Date.now()}-${Pe(8)}`;t(null,`size-${n}${pe.extname(e.originalname)}`)}}),B=Ze({storage:M,limits:{fileSize:10*1024*1024},fileFilter:(r,e,t)=>{let n=/jpeg|jpg|png|webp/,o=n.test(pe.extname(e.originalname).toLowerCase()),d=n.test(e.mimetype);o&&d?t(null,!0):t(new Error("\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D"))}});i.post("/api/upload-size-image",w,j,(r,e)=>{B.single("image")(r,e,t=>{if(t)return console.error("Upload error:",t),e.status(400).json({error:t.message||"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"});if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let n=`/attached_assets/sizes/${r.file.filename}`;e.json({url:n,filename:r.file.filename})})});let F=pe.join(import.meta.dirname,"..","attached_assets","addons"),z=Ze.diskStorage({destination:function(r,e,t){t(null,F)},filename:function(r,e,t){let n=`${Date.now()}-${Pe(8)}`;t(null,`addon-${n}${pe.extname(e.originalname)}`)}}),ne=Ze({storage:z,limits:{fileSize:10*1024*1024},fileFilter:(r,e,t)=>{let n=/jpeg|jpg|png|webp/,o=n.test(pe.extname(e.originalname).toLowerCase()),d=n.test(e.mimetype);o&&d?t(null,!0):t(new Error("\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D"))}});i.post("/api/upload-addon-image",w,j,(r,e)=>{ne.single("image")(r,e,t=>{if(t)return console.error("Upload error:",t),e.status(400).json({error:t.message||"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"});if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let n=`/attached_assets/addons/${r.file.filename}`;e.json({url:n,filename:r.file.filename})})}),i.post("/old-upload-addon-image",w,j,ne.single("image"),(r,e)=>{try{if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let t=`/attached_assets/addons/${r.file.filename}`;e.json({url:t,filename:r.file.filename})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"})}});let H=pe.join(import.meta.dirname,"..","attached_assets","attendance"),Y=Ze.diskStorage({destination:function(r,e,t){t(null,H)},filename:function(r,e,t){let n=`${Date.now()}-${Pe(8)}`;t(null,`attendance-${n}${pe.extname(e.originalname)}`)}}),ue=Ze({storage:Y,limits:{fileSize:5*1024*1024},fileFilter:(r,e,t)=>{let n=/jpeg|jpg|png|webp/,o=n.test(pe.extname(e.originalname).toLowerCase()),d=n.test(e.mimetype);o&&d?t(null,!0):t(new Error("\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D. \u0641\u0642\u0637 \u0635\u0648\u0631 (JPG, PNG, WEBP)"))}});i.post("/api/upload-attendance-photo",ue.single("photo"),(r,e)=>{try{if(!r.file)return e.status(400).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0631\u0641\u0639 \u0635\u0648\u0631\u0629"});let t=`/attached_assets/attendance/${r.file.filename}`;e.json({url:t,filename:r.file.filename})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0631\u0641\u0639 \u0627\u0644\u0635\u0648\u0631\u0629"})}}),i.post("/api/attendance/check-in",w,async(r,e)=>{try{let{AttendanceModel:t,BranchModel:n,EmployeeModel:o}=await Promise.resolve().then(()=>(T(),R)),{location:d,photoUrl:m}=r.body,l=r.employee?.id;if(!l)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});if(!d||!d.lat||!d.lng)return e.status(400).json({error:"\u0627\u0644\u0645\u0648\u0642\u0639 \u0645\u0637\u0644\u0648\u0628 \u0644\u0644\u062A\u062D\u0636\u064A\u0631"});if(!m)return e.status(400).json({error:"\u0635\u0648\u0631\u0629 \u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let g=await o.findOne({$or:[{id:l},{_id:l}]});if(!g)return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0638\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let b=await n.findOne({$or:[{id:g.branchId},{_id:g.branchId}]});if(!b||!b.location)return e.status(400).json({error:"\u0644\u0627 \u064A\u0648\u062C\u062F \u0645\u0648\u0642\u0639 \u0644\u0644\u0641\u0631\u0639"});let I=b.location.lat,A=b.location.lng,S=!1,C=0;if(b.geofenceBoundary&&Array.isArray(b.geofenceBoundary)&&b.geofenceBoundary.length>=3){let De=await import("@turf/turf"),Ee=De.point([d.lng,d.lat]),$e=b.geofenceBoundary.map(ie=>[ie.lng,ie.lat]);$e.push($e[0]);let se=De.polygon([$e]);if(S=De.booleanPointInPolygon(Ee,se),C=Oe(d.lat,d.lng,I,A),!S){let ie=`https://www.google.com/maps/dir/${d.lat},${d.lng}/${I},${A}`;return e.status(400).json({error:"\u0623\u0646\u062A \u062E\u0627\u0631\u062C \u062D\u062F\u0648\u062F \u0627\u0644\u0641\u0631\u0639 \u0627\u0644\u0645\u062D\u062F\u062F\u0629. \u064A\u0631\u062C\u0649 \u0627\u0644\u062A\u0648\u062C\u0647 \u0644\u0644\u0641\u0631\u0639 \u0644\u0644\u062A\u062D\u0636\u064A\u0631.",distance:Math.round(C),userLocation:{lat:d.lat,lng:d.lng},branchLocation:{lat:I,lng:A},mapsUrl:ie,showMap:!0,boundaryType:"polygon"})}}else{let De=b.geofenceRadius||500;if(C=Oe(d.lat,d.lng,I,A),S=C<=De,!S){let Ee=`https://www.google.com/maps/dir/${d.lat},${d.lng}/${I},${A}`;return e.status(400).json({error:`\u0623\u0646\u062A \u0628\u0639\u064A\u062F \u062C\u062F\u0627\u064B \u0639\u0646 \u0627\u0644\u0641\u0631\u0639 (${Math.round(C)} \u0645\u062A\u0631). \u064A\u0631\u062C\u0649 \u0627\u0644\u062A\u0648\u062C\u0647 \u0644\u0644\u0641\u0631\u0639 \u0644\u0644\u062A\u062D\u0636\u064A\u0631.`,distance:Math.round(C),userLocation:{lat:d.lat,lng:d.lng},branchLocation:{lat:I,lng:A},mapsUrl:Ee,showMap:!0,boundaryType:"radius"})}}let N=new Date;N.setHours(0,0,0,0);let x=new Date(N);if(x.setDate(x.getDate()+1),await t.findOne({employeeId:l,shiftDate:{$gte:N,$lt:x},status:"checked_in"}))return e.status(400).json({error:"\u062A\u0645 \u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0645\u0633\u0628\u0642\u0627\u064B \u0627\u0644\u064A\u0648\u0645"});let _=new Date,V=g.shiftTime?parseInt(g.shiftTime.split("-")[0]):8,K=new Date(N);K.setHours(V,0,0,0);let J=_>K,je=J?Math.floor((_.getTime()-K.getTime())/6e4):0,ge=S?1:0,Se=new t({employeeId:l,branchId:g.branchId,checkInTime:_,checkInLocation:{lat:d.lat,lng:d.lng},checkInPhoto:m,status:"checked_in",shiftDate:N,isLate:J?1:0,lateMinutes:je,isAtBranch:ge,distanceFromBranch:Math.round(C)});await Se.save(),e.json({success:!0,message:J?`\u062A\u0645 \u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0628\u0646\u062C\u0627\u062D (\u0645\u062A\u0623\u062E\u0631 ${je} \u062F\u0642\u064A\u0642\u0629)`:"\u062A\u0645 \u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0628\u0646\u062C\u0627\u062D",attendance:P(Se),isLate:J,lateMinutes:je})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u062A\u062D\u0636\u064A\u0631"})}}),i.post("/api/attendance/check-out",w,async(r,e)=>{try{let{AttendanceModel:t,BranchModel:n,EmployeeModel:o}=await Promise.resolve().then(()=>(T(),R)),{location:d,photoUrl:m}=r.body,l=r.employee?.id;if(!l)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});if(!d||!d.lat||!d.lng)return e.status(400).json({error:"\u0627\u0644\u0645\u0648\u0642\u0639 \u0645\u0637\u0644\u0648\u0628 \u0644\u0644\u0627\u0646\u0635\u0631\u0627\u0641"});if(!m)return e.status(400).json({error:"\u0635\u0648\u0631\u0629 \u0627\u0644\u0627\u0646\u0635\u0631\u0627\u0641 \u0645\u0637\u0644\u0648\u0628\u0629"});let g=await o.findOne({$or:[{id:l},{_id:l}]});if(!g)return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0638\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let b=await n.findOne({$or:[{id:g.branchId},{_id:g.branchId}]});if(!b||!b.location)return e.status(400).json({error:"\u0644\u0627 \u064A\u0648\u062C\u062F \u0645\u0648\u0642\u0639 \u0644\u0644\u0641\u0631\u0639"});let I=b.location.lat,A=b.location.lng,S=Oe(d.lat,d.lng,I,A);if(S>500){let _=`https://www.google.com/maps/dir/${d.lat},${d.lng}/${I},${A}`;return e.status(400).json({error:`\u0623\u0646\u062A \u0628\u0639\u064A\u062F \u062C\u062F\u0627\u064B \u0639\u0646 \u0627\u0644\u0641\u0631\u0639 (${Math.round(S)} \u0645\u062A\u0631). \u064A\u0631\u062C\u0649 \u0627\u0644\u062A\u0648\u062C\u0647 \u0644\u0644\u0641\u0631\u0639 \u0644\u0644\u0627\u0646\u0635\u0631\u0627\u0641.`,distance:Math.round(S),userLocation:{lat:d.lat,lng:d.lng},branchLocation:{lat:I,lng:A},mapsUrl:_,showMap:!0})}let C=new Date;C.setHours(0,0,0,0);let N=new Date(C);N.setDate(N.getDate()+1);let x=await t.findOne({employeeId:l,shiftDate:{$gte:C,$lt:N},status:"checked_in"});if(!x)return e.status(400).json({error:"\u0644\u0645 \u062A\u0642\u0645 \u0628\u0627\u0644\u062A\u062D\u0636\u064A\u0631 \u0627\u0644\u064A\u0648\u0645"});let L=S<=500?1:0;x.checkOutTime=new Date,x.checkOutLocation={lat:d.lat,lng:d.lng},x.checkOutPhoto=m,x.status="checked_out",x.checkOutIsAtBranch=L,x.checkOutDistanceFromBranch=Math.round(S),x.updatedAt=new Date,await x.save(),e.json({success:!0,message:"\u062A\u0645 \u0627\u0644\u0627\u0646\u0635\u0631\u0627\u0641 \u0628\u0646\u062C\u0627\u062D",attendance:P(x)})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u0627\u0646\u0635\u0631\u0627\u0641"})}}),i.get("/api/attendance",w,j,async(r,e)=>{try{let{AttendanceModel:t,EmployeeModel:n,BranchModel:o}=await Promise.resolve().then(()=>(T(),R)),{date:d,branchId:m,employeeId:l}=r.query,g={};if(r.employee?.role==="manager"&&r.employee?.branchId?g.branchId=r.employee.branchId:(r.employee?.role==="admin"||r.employee?.role,m&&(g.branchId=m)),d){let A=new Date(d);A.setHours(0,0,0,0);let S=new Date(A);S.setDate(S.getDate()+1),g.shiftDate={$gte:A,$lt:S}}l&&(g.employeeId=l);let b=await t.find(g).sort({shiftDate:-1,checkInTime:-1}),I=await Promise.all(b.map(async A=>{let S=await n.findOne({$or:[{id:A.employeeId},{_id:A.employeeId}]}),C=await o.findOne({$or:[{id:A.branchId},{_id:A.branchId}]});return{...P(A),employee:S?{fullName:S.fullName,phone:S.phone,jobTitle:S.jobTitle,shiftTime:S.shiftTime,role:S.role,imageUrl:S.imageUrl}:null,branch:C?{name:C.nameAr}:null}}));e.json(I)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062C\u0644\u0628 \u0633\u062C\u0644\u0627\u062A \u0627\u0644\u062D\u0636\u0648\u0631"})}}),i.get("/api/attendance/my-status",w,async(r,e)=>{try{let{AttendanceModel:t}=await Promise.resolve().then(()=>(T(),R)),n=r.employee?.id;if(!n)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let o=new Date;o.setHours(0,0,0,0);let d=new Date(o);d.setDate(d.getDate()+1);let m=await t.findOne({employeeId:n,shiftDate:{$gte:o,$lt:d}}),l=21,b=l-0;e.json({hasCheckedIn:!!m,hasCheckedOut:m?.status==="checked_out",attendance:m?P(m):null,todayCheckIn:m?.checkInTime||null,todayCheckOut:m?.checkOutTime||null,leaveBalance:b,totalLeaves:l})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062C\u0644\u0628 \u062D\u0627\u0644\u0629 \u0627\u0644\u062D\u0636\u0648\u0631"})}}),i.post("/api/leave-requests",w,async(r,e)=>{try{let{LeaveRequestModel:t}=await Promise.resolve().then(()=>(mr(),lr)),n=r.employee?.id;if(!n)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let{startDate:o,endDate:d,reason:m}=r.body;if(!o||!d||!m)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u0646\u0627\u0642\u0635\u0629"});let l=new Date(o),g=new Date(d);if(g<l)return e.status(400).json({error:"\u062A\u0627\u0631\u064A\u062E \u0627\u0644\u0627\u0646\u062A\u0647\u0627\u0621 \u064A\u062C\u0628 \u0623\u0646 \u064A\u0643\u0648\u0646 \u0628\u0639\u062F \u062A\u0627\u0631\u064A\u062E \u0627\u0644\u0628\u062F\u0627\u064A\u0629"});let b=Math.ceil((g.getTime()-l.getTime())/(1e3*60*60*24))+1,I=new t({employeeId:n,startDate:l,endDate:g,reason:m,numberOfDays:b,status:"pending"});await I.save(),e.status(201).json(P(I))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062A\u0642\u062F\u064A\u0645 \u0637\u0644\u0628 \u0627\u0644\u0627\u062C\u0627\u0632\u0629"})}}),i.get("/api/leave-requests",w,async(r,e)=>{try{let{LeaveRequestModel:t}=await Promise.resolve().then(()=>(mr(),lr)),n=r.employee?.id;if(!n)return e.status(401).json({error:"\u063A\u064A\u0631 \u0645\u0635\u0631\u062D"});let o=await t.find({employeeId:n}).sort({createdAt:-1});e.json(o.map(P))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062C\u0644\u0628 \u0637\u0644\u0628\u0627\u062A \u0627\u0644\u0627\u062C\u0627\u0632\u0629"})}}),i.patch("/api/leave-requests/:id/approve",w,async(r,e)=>{try{let{LeaveRequestModel:t}=await Promise.resolve().then(()=>(mr(),lr));if(r.employee?.role!=="manager"&&r.employee?.role!=="admin"&&r.employee?.role!=="owner")return e.status(403).json({error:"\u0635\u0644\u0627\u062D\u064A\u0627\u062A \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let n=await t.findByIdAndUpdate(r.params.id,{status:"approved",approvedBy:r.employee.id,approvalDate:new Date},{new:!0});if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(P(n))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0627\u0644\u0645\u0648\u0627\u0641\u0642\u0629 \u0639\u0644\u0649 \u0627\u0644\u0637\u0644\u0628"})}}),i.patch("/api/leave-requests/:id/reject",w,async(r,e)=>{try{let{LeaveRequestModel:t}=await Promise.resolve().then(()=>(mr(),lr));if(r.employee?.role!=="manager"&&r.employee?.role!=="admin"&&r.employee?.role!=="owner")return e.status(403).json({error:"\u0635\u0644\u0627\u062D\u064A\u0627\u062A \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let{rejectionReason:n}=r.body,o=await t.findByIdAndUpdate(r.params.id,{status:"rejected",approvedBy:r.employee.id,approvalDate:new Date,rejectionReason:n},{new:!0});if(!o)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(P(o))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0631\u0641\u0636 \u0627\u0644\u0637\u0644\u0628"})}});function Oe(r,e,t,n){let d=r*Math.PI/180,m=t*Math.PI/180,l=(t-r)*Math.PI/180,g=(n-e)*Math.PI/180,b=Math.sin(l/2)*Math.sin(l/2)+Math.cos(d)*Math.cos(m)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b)))}i.get("/api/owner/database-stats",w,async(r,e)=>{try{if(r.employee?.role!=="owner"&&r.employee?.role!=="admin")return e.status(403).json({error:"\u0635\u0644\u0627\u062D\u064A\u0627\u062A \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let{OrderModel:t,CustomerModel:n,EmployeeModel:o,CoffeeItemModel:d,BranchModel:m,DiscountCodeModel:l,LoyaltyCardModel:g,TableModel:b,AttendanceModel:I,IngredientModel:A,CategoryModel:S,DeliveryZoneModel:C}=await Promise.resolve().then(()=>(T(),R)),[N,x,L,_,V,K,J,je,ge,Se,De,Ee,$e,se]=await Promise.all([t.countDocuments(),n.countDocuments(),o.countDocuments(),d.countDocuments(),m.countDocuments(),l.countDocuments(),g.countDocuments(),b.countDocuments(),I.countDocuments(),A.countDocuments(),S.countDocuments(),C.countDocuments(),t.countDocuments({createdAt:{$gte:new Date(new Date().setHours(0,0,0,0))}}),t.aggregate([{$match:{status:{$ne:"cancelled"}}},{$group:{_id:null,total:{$sum:"$totalAmount"}}}])]);e.json({collections:{orders:{count:N,nameAr:"\u0627\u0644\u0637\u0644\u0628\u0627\u062A"},customers:{count:x,nameAr:"\u0627\u0644\u0639\u0645\u0644\u0627\u0621"},employees:{count:L,nameAr:"\u0627\u0644\u0645\u0648\u0638\u0641\u064A\u0646"},coffeeItems:{count:_,nameAr:"\u0627\u0644\u0645\u0634\u0631\u0648\u0628\u0627\u062A"},branches:{count:V,nameAr:"\u0627\u0644\u0641\u0631\u0648\u0639"},discountCodes:{count:K,nameAr:"\u0623\u0643\u0648\u0627\u062F \u0627\u0644\u062E\u0635\u0645"},loyaltyCards:{count:J,nameAr:"\u0628\u0637\u0627\u0642\u0627\u062A \u0627\u0644\u0648\u0644\u0627\u0621"},tables:{count:je,nameAr:"\u0627\u0644\u0637\u0627\u0648\u0644\u0627\u062A"},attendance:{count:ge,nameAr:"\u0633\u062C\u0644\u0627\u062A \u0627\u0644\u062D\u0636\u0648\u0631"},ingredients:{count:Se,nameAr:"\u0627\u0644\u0645\u0643\u0648\u0646\u0627\u062A"},categories:{count:De,nameAr:"\u0627\u0644\u0641\u0626\u0627\u062A"},deliveryZones:{count:Ee,nameAr:"\u0645\u0646\u0627\u0637\u0642 \u0627\u0644\u062A\u0648\u0635\u064A\u0644"}},summary:{todayOrders:$e,totalRevenue:se[0]?.total||0}})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062C\u0644\u0628 \u0625\u062D\u0635\u0627\u0626\u064A\u0627\u062A \u0642\u0627\u0639\u062F\u0629 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"})}}),i.get("/api/owner/collection/:collectionName",w,async(r,e)=>{try{if(r.employee?.role!=="owner"&&r.employee?.role!=="admin")return e.status(403).json({error:"\u0635\u0644\u0627\u062D\u064A\u0627\u062A \u063A\u064A\u0631 \u0643\u0627\u0641\u064A\u0629"});let{collectionName:t}=r.params,{page:n="1",limit:o="50"}=r.query,d=parseInt(n),m=parseInt(o),l=(d-1)*m,b={orders:(await Promise.resolve().then(()=>(T(),R))).OrderModel,customers:(await Promise.resolve().then(()=>(T(),R))).CustomerModel,employees:(await Promise.resolve().then(()=>(T(),R))).EmployeeModel,coffeeItems:(await Promise.resolve().then(()=>(T(),R))).CoffeeItemModel,branches:(await Promise.resolve().then(()=>(T(),R))).BranchModel,discountCodes:(await Promise.resolve().then(()=>(T(),R))).DiscountCodeModel,loyaltyCards:(await Promise.resolve().then(()=>(T(),R))).LoyaltyCardModel,tables:(await Promise.resolve().then(()=>(T(),R))).TableModel,attendance:(await Promise.resolve().then(()=>(T(),R))).AttendanceModel,ingredients:(await Promise.resolve().then(()=>(T(),R))).IngredientModel,categories:(await Promise.resolve().then(()=>(T(),R))).CategoryModel,deliveryZones:(await Promise.resolve().then(()=>(T(),R))).DeliveryZoneModel}[t];if(!b)return e.status(400).json({error:"\u0645\u062C\u0645\u0648\u0639\u0629 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});let[I,A]=await Promise.all([b.find().sort({createdAt:-1}).skip(l).limit(m),b.countDocuments()]);e.json({data:I.map(S=>{let C=P(S);return t==="employees"&&delete C.password,C}),pagination:{page:d,limit:m,total:A,pages:Math.ceil(A/m)}})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062C\u0644\u0628 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"})}}),i.delete("/api/owner/collection/:collectionName",w,async(r,e)=>{try{if(r.employee?.role!=="owner")return e.status(403).json({error:"\u0641\u0642\u0637 \u0627\u0644\u0645\u0627\u0644\u0643 \u064A\u0645\u0643\u0646\u0647 \u062D\u0630\u0641 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"});let{collectionName:t}=r.params,{ids:n}=r.body,d={orders:(await Promise.resolve().then(()=>(T(),R))).OrderModel,customers:(await Promise.resolve().then(()=>(T(),R))).CustomerModel,discountCodes:(await Promise.resolve().then(()=>(T(),R))).DiscountCodeModel,loyaltyCards:(await Promise.resolve().then(()=>(T(),R))).LoyaltyCardModel,attendance:(await Promise.resolve().then(()=>(T(),R))).AttendanceModel}[t];if(!d)return e.status(400).json({error:"\u0645\u062C\u0645\u0648\u0639\u0629 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629 \u0623\u0648 \u0645\u062D\u0645\u064A\u0629"});let m;n&&Array.isArray(n)&&n.length>0?m=await d.deleteMany({_id:{$in:n}}):m=await d.deleteMany({}),e.json({success:!0,message:`\u062A\u0645 \u062D\u0630\u0641 ${m.deletedCount} \u0633\u062C\u0644`,deletedCount:m.deletedCount})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062D\u0630\u0641 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"})}}),i.delete("/api/owner/record/:collectionName/:id",w,async(r,e)=>{try{if(r.employee?.role!=="owner")return e.status(403).json({error:"\u0641\u0642\u0637 \u0627\u0644\u0645\u0627\u0644\u0643 \u064A\u0645\u0643\u0646\u0647 \u062D\u0630\u0641 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"});let{collectionName:t,id:n}=r.params,d={orders:(await Promise.resolve().then(()=>(T(),R))).OrderModel,customers:(await Promise.resolve().then(()=>(T(),R))).CustomerModel,employees:(await Promise.resolve().then(()=>(T(),R))).EmployeeModel,coffeeItems:(await Promise.resolve().then(()=>(T(),R))).CoffeeItemModel,branches:(await Promise.resolve().then(()=>(T(),R))).BranchModel,discountCodes:(await Promise.resolve().then(()=>(T(),R))).DiscountCodeModel,loyaltyCards:(await Promise.resolve().then(()=>(T(),R))).LoyaltyCardModel,tables:(await Promise.resolve().then(()=>(T(),R))).TableModel,attendance:(await Promise.resolve().then(()=>(T(),R))).AttendanceModel,ingredients:(await Promise.resolve().then(()=>(T(),R))).IngredientModel,categories:(await Promise.resolve().then(()=>(T(),R))).CategoryModel,deliveryZones:(await Promise.resolve().then(()=>(T(),R))).DeliveryZoneModel}[t];if(!d)return e.status(400).json({error:"\u0645\u062C\u0645\u0648\u0639\u0629 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});if((await d.deleteOne({_id:n})).deletedCount===0)return e.status(404).json({error:"\u0627\u0644\u0633\u062C\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0633\u062C\u0644 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u062D\u0630\u0641 \u0627\u0644\u0633\u062C\u0644"})}}),i.post("/api/owner/reset-database",w,async(r,e)=>{try{if(r.employee?.role!=="owner")return e.status(403).json({error:"\u0641\u0642\u0637 \u0627\u0644\u0645\u0627\u0644\u0643 \u064A\u0645\u0643\u0646\u0647 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0642\u0627\u0639\u062F\u0629 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"});let{confirmPhrase:t}=r.body;if(t!=="\u0627\u062D\u0630\u0641 \u062C\u0645\u064A\u0639 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A")return e.status(400).json({error:"\u0639\u0628\u0627\u0631\u0629 \u0627\u0644\u062A\u0623\u0643\u064A\u062F \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"});let{OrderModel:n,CustomerModel:o,DiscountCodeModel:d,LoyaltyCardModel:m,LoyaltyTransactionModel:l,AttendanceModel:g,CardCodeModel:b}=await Promise.resolve().then(()=>(T(),R)),I=await Promise.all([n.deleteMany({}),o.deleteMany({}),d.deleteMany({}),m.deleteMany({}),l.deleteMany({}),g.deleteMany({}),b.deleteMany({})]);e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u062C\u0645\u064A\u0639 \u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0639\u0645\u0644\u064A\u0627\u062A \u0628\u0646\u062C\u0627\u062D",deleted:{orders:I[0].deletedCount,customers:I[1].deletedCount,discountCodes:I[2].deletedCount,loyaltyCards:I[3].deletedCount,loyaltyTransactions:I[4].deletedCount,attendance:I[5].deletedCount,cardCodes:I[6].deletedCount}})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0625\u0639\u0627\u062F\u0629 \u062A\u0639\u064A\u064A\u0646 \u0642\u0627\u0639\u062F\u0629 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A"})}}),i.get("/api/employee/raw-items/by-category/:category",w,async(r,e)=>{try{let{category:t}=r.params,n=["ingredient","packaging","equipment","consumable","other"];if(!n.includes(t))return e.status(400).json({error:"\u062A\u0635\u0646\u064A\u0641 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D",validCategories:n});let d=(await f.getRawItems()).filter(m=>m.category===t);e.json(d)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0627\u062F \u0627\u0644\u062E\u0627\u0645"})}}),i.patch("/api/employee/raw-items/:id/availability",w,async(r,e)=>{try{let{id:t}=r.params,{isActive:n}=r.body;if(typeof n!="number"||n!==0&&n!==1)return e.status(400).json({error:"\u0642\u064A\u0645\u0629 isActive \u064A\u062C\u0628 \u0623\u0646 \u062A\u0643\u0648\u0646 0 \u0623\u0648 1"});let o=await f.updateRawItem(t,{isActive:n});if(!o)return e.status(404).json({error:"\u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});if(o.category==="ingredient"){let{RecipeItemModel:d,CoffeeItemModel:m}=await Promise.resolve().then(()=>(T(),R)),l=await d.find({rawItemId:t});for(let g of l)if(await m.findById(g.coffeeItemId))if(n===0)await m.findByIdAndUpdate(g.coffeeItemId,{isAvailable:0,availabilityStatus:`\u0646\u0641\u0630 ${o.nameAr}`});else{let I=await d.find({coffeeItemId:g.coffeeItemId}),A=!0;for(let S of I){let C=await f.getRawItem(S.rawItemId);if(C&&C.isActive===0){A=!1;break}}A&&await m.findByIdAndUpdate(g.coffeeItemId,{isAvailable:1,availabilityStatus:"\u0645\u062A\u0648\u0641\u0631"})}}e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u062D\u0627\u0644\u0629 \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645"})}}),i.get("/api/inventory/raw-items",w,j,async(r,e)=>{try{let{category:t}=r.query,n=await f.getRawItems();t&&typeof t=="string"&&(n=n.filter(o=>o.category===t)),e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0627\u062F \u0627\u0644\u062E\u0627\u0645"})}}),i.get("/api/raw-items/by-category/:category",w,j,async(r,e)=>{try{let{category:t}=r.params,n=["ingredient","packaging","equipment","consumable","other"];if(!n.includes(t))return e.status(400).json({error:"\u062A\u0635\u0646\u064A\u0641 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D",validCategories:n});let d=(await f.getRawItems()).filter(m=>m.category===t);e.json(d)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0627\u062F \u0627\u0644\u062E\u0627\u0645"})}}),i.get("/api/raw-items/for-recipes",w,j,async(r,e)=>{try{let n=(await f.getRawItems()).filter(o=>["ingredient","packaging","consumable"].includes(o.category));e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0627\u062F \u0627\u0644\u062E\u0627\u0645 \u0644\u0644\u0648\u0635\u0641\u0627\u062A"})}}),i.get("/api/inventory/raw-items/:id",w,j,async(r,e)=>{try{let t=await f.getRawItem(r.params.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645"})}}),i.post("/api/inventory/raw-items",w,j,async(r,e)=>{try{let{insertRawItemSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body);if(await f.getRawItemByCode(n.code))return e.status(400).json({error:"\u0643\u0648\u062F \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u0645\u0648\u062C\u0648\u062F \u0645\u0633\u0628\u0642\u0627\u064B"});let d=await f.createRawItem(n);e.status(201).json(d)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645"})}}),i.put("/api/inventory/raw-items/:id",w,j,async(r,e)=>{try{let{insertRawItemSchema:t}=await Promise.resolve().then(()=>(T(),R)),o=t.partial().parse(r.body),d=await f.updateRawItem(r.params.id,o);if(!d)return e.status(404).json({error:"\u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(d)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645"})}}),i.delete("/api/inventory/raw-items/:id",w,j,async(r,e)=>{try{if(!await f.deleteRawItem(r.params.id))return e.status(404).json({error:"\u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0645\u0627\u062F\u0629 \u0627\u0644\u062E\u0627\u0645"})}}),i.get("/api/recipes",w,j,async(r,e)=>{try{let n=(await Ne.find().lean()).map(o=>({...o,id:o._id.toString(),_id:void 0}));e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0648\u0635\u0641\u0627\u062A"})}}),i.get("/api/recipes/coffee-item/:coffeeItemId",w,j,async(r,e)=>{try{let{coffeeItemId:t}=r.params,n=await Ne.find({coffeeItemId:t}).lean(),o=await Promise.all(n.map(async d=>{let m=await oe.findOne({$or:[{_id:d.rawItemId},{code:d.rawItemId}]}).lean();return{...d,id:d._id.toString(),_id:void 0,rawItem:m?{id:m._id.toString(),code:m.code,nameAr:m.nameAr,nameEn:m.nameEn,unit:m.unit,unitCost:m.unitCost}:null}}));e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0648\u0635\u0641\u0627\u062A \u0627\u0644\u0645\u0634\u0631\u0648\u0628"})}}),i.delete("/api/recipes/:id",w,j,async(r,e)=>{try{if(!await Ne.findByIdAndDelete(r.params.id))return e.status(404).json({error:"\u0627\u0644\u0648\u0635\u0641\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0639\u0646\u0635\u0631 \u0627\u0644\u0648\u0635\u0641\u0629"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.delete("/api/recipes/coffee-item/:coffeeItemId",w,j,async(r,e)=>{try{let{coffeeItemId:t}=r.params,n=await Ne.deleteMany({coffeeItemId:t});e.json({success:!0,deleted:n.deletedCount})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0648\u0635\u0641\u0627\u062A \u0627\u0644\u0645\u0634\u0631\u0648\u0628"})}}),i.get("/api/recipes/coffee-item/:coffeeItemId/cost",w,j,async(r,e)=>{try{let{coffeeItemId:t}=r.params,n=await Ne.find({coffeeItemId:t}),o=0,d=[];for(let m of n){let l=await oe.findOne({$or:[{_id:m.rawItemId},{code:m.rawItemId}]});if(l){let b=Ys(m.quantity,m.unit,l.unit)*(l.unitCost||0);o+=b,d.push({rawItemName:l.nameAr,quantity:m.quantity,unit:m.unit,unitCost:l.unitCost,totalCost:b})}}e.json({totalCost:o,breakdown:d})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0633\u0627\u0628 \u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.get("/api/inventory/suppliers",w,j,async(r,e)=>{try{let t=await f.getSuppliers();e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0631\u062F\u064A\u0646"})}}),i.get("/api/inventory/suppliers/:id",w,j,async(r,e)=>{try{let t=await f.getSupplier(r.params.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0631\u062F \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0631\u062F"})}}),i.post("/api/inventory/suppliers",w,j,async(r,e)=>{try{let{insertSupplierSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body);if(await f.getSupplierByCode(n.code))return e.status(400).json({error:"\u0643\u0648\u062F \u0627\u0644\u0645\u0648\u0631\u062F \u0645\u0648\u062C\u0648\u062F \u0645\u0633\u0628\u0642\u0627\u064B"});let d=await f.createSupplier(n);e.status(201).json(d)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0645\u0648\u0631\u062F"})}}),i.put("/api/inventory/suppliers/:id",w,j,async(r,e)=>{try{let{insertSupplierSchema:t}=await Promise.resolve().then(()=>(T(),R)),o=t.partial().parse(r.body),d=await f.updateSupplier(r.params.id,o);if(!d)return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0631\u062F \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(d)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0645\u0648\u0631\u062F"})}}),i.delete("/api/inventory/suppliers/:id",w,j,async(r,e)=>{try{if(!await f.deleteSupplier(r.params.id))return e.status(404).json({error:"\u0627\u0644\u0645\u0648\u0631\u062F \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0645\u0648\u0631\u062F \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0645\u0648\u0631\u062F"})}}),i.get("/api/inventory/stock",w,j,async(r,e)=>{try{let{branchId:t}=r.query;if(t){let n=await f.getBranchStock(t);e.json(n)}else{let n=await f.getAllBranchesStock();e.json(n)}}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.get("/api/inventory/stock/low",w,j,async(r,e)=>{try{let{branchId:t}=r.query,n=await f.getLowStockItems(t);e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0648\u0627\u062F \u0645\u0646\u062E\u0641\u0636\u0629 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.post("/api/inventory/stock/adjust",w,j,async(r,e)=>{try{let{branchId:t,rawItemId:n,quantity:o,notes:d,movementType:m,unitCost:l}=r.body,g=k(r)||"demo-tenant",b=r.employee?.id||"system";if(!t||!n||o===void 0)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});let I=await oe.findById(n);if(!I)return e.status(404).json({error:"\u0627\u0644\u0645\u0627\u062F\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});let A=await f.updateBranchStock(t,n,o,b,m||"adjustment",d);if(o>0&&(m==="purchase"||m==="adjustment"))try{let S=await te.findOne({tenantId:g,accountNumber:"1130"}),C=await te.findOne({tenantId:g,accountNumber:"5100"});if(S&&C){let N=(l||I.unitCost||0)*Math.abs(o);N>0&&await ce.createJournalEntry({tenantId:g,entryDate:new Date,description:`\u0625\u0636\u0627\u0641\u0629 \u0645\u062E\u0632\u0648\u0646: ${I.nameAr}`,lines:[{accountId:S.id,accountNumber:S.accountNumber,accountName:S.nameAr,debit:N,credit:0,description:`\u0632\u064A\u0627\u062F\u0629 \u0642\u064A\u0645\u0629 \u0627\u0644\u0645\u062E\u0632\u0648\u0646 - ${I.nameAr}`,branchId:t},{accountId:C.id,accountNumber:C.accountNumber,accountName:C.nameAr,debit:0,credit:N,description:`\u062A\u0643\u0644\u0641\u0629 \u0634\u0631\u0627\u0621/\u0625\u0636\u0627\u0641\u0629 \u0645\u062E\u0632\u0648\u0646 - ${I.nameAr}`,branchId:t}],referenceType:"inventory_adjustment",referenceId:A.id||A._id?.toString(),createdBy:b,autoPost:!0})}}catch(S){console.error("[ACCOUNTING] Failed to create adjustment entry:",S)}e.json(A)}catch(t){console.error("Error adjusting stock:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u0639\u062F\u064A\u0644 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.post("/api/inventory/stock-adjustment",w,async(r,e)=>{try{let{rawItemId:t,branchId:n,quantity:o,type:d,notes:m}=r.body;if(!t||!n||o===void 0||!d)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});let l=d==="subtract"?-Math.abs(o):Math.abs(o),g=await f.updateBranchStock(n,t,l,r.employee?.id||"system","adjustment",m||(d==="add"?"\u0625\u0636\u0627\u0641\u0629 \u0643\u0645\u064A\u0629":"\u062E\u0635\u0645 \u0643\u0645\u064A\u0629"));e.json(g)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u0639\u062F\u064A\u0644 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.post("/api/inventory/stock-batch",w,async(r,e)=>{try{let{rawItemId:t,branchId:n,quantity:o,unitCost:d,notes:m}=r.body;if(!t||!n||!o||o<=0)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});d&&d>0&&await oe.findByIdAndUpdate(t,{unitCost:d});let l=await f.updateBranchStock(n,t,Math.abs(o),r.employee?.id||"system","purchase",m||"\u062F\u0641\u0639\u0629 \u062C\u062F\u064A\u062F\u0629");e.json(l)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u062F\u0641\u0639\u0629"})}}),i.get("/api/inventory/branch-stocks",w,async(r,e)=>{try{let{branchId:t}=r.query;if(t&&t!=="all"){let n=await f.getBranchStock(t);e.json(n)}else{let n=await Be.find({isActive:1}).lean(),o=[];for(let d of n){let m=d._id.toString(),l=await f.getBranchStock(m);o=o.concat(l)}e.json(o)}}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.get("/api/inventory/transfers",w,j,async(r,e)=>{try{let{branchId:t}=r.query,n=await f.getStockTransfers(t);e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u062A\u062D\u0648\u064A\u0644\u0627\u062A"})}}),i.get("/api/inventory/transfers/:id",w,j,async(r,e)=>{try{let t=await f.getStockTransfer(r.params.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u062D\u0648\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u062A\u062D\u0648\u064A\u0644"})}}),i.post("/api/inventory/transfers",w,j,async(r,e)=>{try{let{insertStockTransferSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse({...r.body,requestedBy:r.employee?.id||"system"}),o=await f.createStockTransfer(n);e.status(201).json(o)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u062A\u062D\u0648\u064A\u0644"})}}),i.put("/api/inventory/transfers/:id/approve",w,j,async(r,e)=>{try{let t=await f.updateStockTransferStatus(r.params.id,"approved",r.employee?.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u062D\u0648\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u0645\u0648\u0627\u0641\u0642\u0629 \u0639\u0644\u0649 \u0627\u0644\u062A\u062D\u0648\u064A\u0644"})}}),i.put("/api/inventory/transfers/:id/complete",w,j,async(r,e)=>{try{let t=await f.completeStockTransfer(r.params.id,r.employee?.id||"system");if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u062D\u0648\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F \u0623\u0648 \u0644\u0645 \u062A\u062A\u0645 \u0627\u0644\u0645\u0648\u0627\u0641\u0642\u0629 \u0639\u0644\u064A\u0647"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u062A\u0645\u0627\u0645 \u0627\u0644\u062A\u062D\u0648\u064A\u0644"})}}),i.put("/api/inventory/transfers/:id/cancel",w,j,async(r,e)=>{try{let t=await f.updateStockTransferStatus(r.params.id,"cancelled");if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u062D\u0648\u064A\u0644 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0644\u063A\u0627\u0621 \u0627\u0644\u062A\u062D\u0648\u064A\u0644"})}}),i.get("/api/inventory/organization-stats",w,j,async(r,e)=>{try{let t=await Be.find({isActive:1}).lean(),n=await oe.find().lean(),o=0,d=0,m=[];for(let l of t){let g=l._id.toString(),b=await be.find({branchId:g}).populate("rawItemId").lean(),I=0,A=0,S=await f.getStockTransfers(g);b.forEach(C=>{let N=C.rawItemId;if(N){let x=(C.currentQuantity||0)*(N.unitCost||0);I+=x,(C.currentQuantity||0)<(N.minStockLevel||0)&&(A++,d++)}}),o+=I,m.push({branchId:g,branchName:l.nameAr||"\u0641\u0631\u0639 \u0628\u062F\u0648\u0646 \u0627\u0633\u0645",totalItems:b.length,lowStockItems:A,totalValue:I,recentTransfers:S?.filter(C=>C.status!=="completed").length||0})}e.json({totalBranches:t.length,totalSKUs:n.length,totalInventoryValue:o,lowStockItems:d,pendingTransfers:0,branches:m})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0625\u062D\u0635\u0627\u0626\u064A\u0627\u062A \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.get("/api/inventory/purchases",w,j,async(r,e)=>{try{let{branchId:t}=r.query,n=await f.getPurchaseInvoices(t);e.json(n)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0641\u0648\u0627\u062A\u064A\u0631 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.get("/api/inventory/purchases/:id",w,j,async(r,e)=>{try{let t=await f.getPurchaseInvoice(r.params.id);if(!t)return e.status(404).json({error:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.post("/api/inventory/purchases",w,j,async(r,e)=>{try{let{insertPurchaseInvoiceSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse({...r.body,createdBy:r.employee?.id||"system"}),o=await f.createPurchaseInvoice(n);e.status(201).json(o)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.put("/api/inventory/purchases/:id",w,j,async(r,e)=>{try{let{insertPurchaseInvoiceSchema:t}=await Promise.resolve().then(()=>(T(),R)),o=t.partial().parse(r.body),d=await f.updatePurchaseInvoice(r.params.id,o);if(!d)return e.status(404).json({error:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(d)}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.put("/api/inventory/purchases/:id/approve",w,j,async(r,e)=>{try{let t=await f.updatePurchaseInvoice(r.params.id,{status:"approved"});if(!t)return e.status(404).json({error:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0639\u062A\u0645\u0627\u062F \u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.put("/api/inventory/purchases/:id/receive",w,j,async(r,e)=>{try{let t=await f.receivePurchaseInvoice(r.params.id,r.employee?.id||"system");if(!t)return e.status(404).json({error:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629 \u0623\u0648 \u062A\u0645 \u0627\u0633\u062A\u0644\u0627\u0645\u0647\u0627 \u0645\u0633\u0628\u0642\u0627\u064B"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0633\u062A\u0644\u0627\u0645 \u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621"})}}),i.put("/api/inventory/purchases/:id/payment",w,j,async(r,e)=>{try{let{amount:t}=r.body;if(!t||t<=0)return e.status(400).json({error:"\u0645\u0628\u0644\u063A \u0627\u0644\u062F\u0641\u0639\u0629 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D"});let n=await f.getPurchaseInvoice(r.params.id);if(!n)return e.status(404).json({error:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0634\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});let o=n.paidAmount+t;if(o>n.totalAmount)return e.status(400).json({error:"\u0645\u0628\u0644\u063A \u0627\u0644\u062F\u0641\u0639\u0629 \u064A\u062A\u062C\u0627\u0648\u0632 \u0627\u0644\u0645\u0628\u0644\u063A \u0627\u0644\u0645\u062A\u0628\u0642\u064A"});let d=await f.updatePurchaseInvoicePayment(r.params.id,o);e.json(d)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u062F\u0641\u0639"})}}),i.get("/api/inventory/all-recipes",w,j,async(r,e)=>{try{let t=await f.getAllRecipeItems();e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u062C\u0645\u064A\u0639 \u0627\u0644\u0648\u0635\u0641\u0627\u062A"})}}),i.get("/api/inventory/recipes/:coffeeItemId",w,j,async(r,e)=>{try{let t=await f.getRecipeItems(r.params.coffeeItemId),n=await f.calculateProductCost(r.params.coffeeItemId);e.json({items:t,totalCost:n})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0643\u0648\u0646\u0627\u062A \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.post("/api/inventory/recipes",w,j,async(r,e)=>{try{let{insertRecipeItemSchema:t}=await Promise.resolve().then(()=>(T(),R)),n=t.parse(r.body),o=await f.createRecipeItem(n);e.status(201).json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0636\u0627\u0641\u0629 \u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.put("/api/inventory/recipes/:id",w,j,async(r,e)=>{try{let t=await f.updateRecipeItem(r.params.id,r.body);if(!t)return e.status(404).json({error:"\u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.delete("/api/inventory/recipes/:id",w,j,async(r,e)=>{try{if(!await f.deleteRecipeItem(r.params.id))return e.status(404).json({error:"\u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0645\u0643\u0648\u0646 \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.post("/api/inventory/recipes/bulk",w,j,async(r,e)=>{try{let{coffeeItemId:t,items:n,clearExisting:o}=r.body;if(!t)return e.status(400).json({error:"\u0645\u0639\u0631\u0641 \u0627\u0644\u0645\u0646\u062A\u062C \u0645\u0637\u0644\u0648\u0628"});if(!n||!Array.isArray(n)||n.length===0)return e.status(400).json({error:"\u064A\u062C\u0628 \u0625\u0636\u0627\u0641\u0629 \u0645\u0643\u0648\u0646 \u0648\u0627\u062D\u062F \u0639\u0644\u0649 \u0627\u0644\u0623\u0642\u0644"});if(o){let l=await f.getRecipeItems(t);for(let g of l)await f.deleteRecipeItem(g.id)}let d=[],m=0;for(let l of n){if(!l.rawItemId||!l.quantity||!l.unit)continue;let b=(await f.getRecipeItems(t)).find(I=>I.rawItemId===l.rawItemId);if(b){let I=await f.updateRecipeItem(b.id,{quantity:l.quantity,unit:l.unit,notes:l.notes});I&&d.push(I)}else{let I=await f.createRecipeItem({coffeeItemId:t,rawItemId:l.rawItemId,quantity:l.quantity,unit:l.unit,notes:l.notes});d.push(I)}}m=await f.calculateProductCost(t),e.status(201).json({success:!0,items:d,totalCost:m,message:`\u062A\u0645 \u0625\u0636\u0627\u0641\u0629 ${d.length} \u0645\u0643\u0648\u0646 \u0644\u0644\u0648\u0635\u0641\u0629 \u0628\u0646\u062C\u0627\u062D`})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0636\u0627\u0641\u0629 \u0645\u0643\u0648\u0646\u0627\u062A \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.delete("/api/inventory/recipes/product/:coffeeItemId",w,j,async(r,e)=>{try{let{coffeeItemId:t}=r.params,n=await f.getRecipeItems(t);for(let o of n)await f.deleteRecipeItem(o.id);e.json({success:!0,deletedCount:n.length,message:`\u062A\u0645 \u062D\u0630\u0641 ${n.length} \u0645\u0643\u0648\u0646 \u0645\u0646 \u0627\u0644\u0648\u0635\u0641\u0629`})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0645\u0643\u0648\u0646\u0627\u062A \u0627\u0644\u0648\u0635\u0641\u0629"})}}),i.get("/api/inventory/alerts",w,j,async(r,e)=>{try{let{branchId:t,resolved:n}=r.query,o=await f.getStockAlerts(t,n==="true"?!0:n==="false"?!1:void 0);e.json(o)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u062A\u0646\u0628\u064A\u0647\u0627\u062A"})}}),i.put("/api/inventory/alerts/:id/resolve",w,j,async(r,e)=>{try{let t=await f.resolveStockAlert(r.params.id,r.employee?.id||"system");if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u0646\u0628\u064A\u0647 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});ye.broadcastAlertResolved(t.id,t.branchId),e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0644 \u0627\u0644\u062A\u0646\u0628\u064A\u0647"})}}),i.put("/api/inventory/alerts/:id/read",w,j,async(r,e)=>{try{let t=await f.markAlertAsRead(r.params.id);if(!t)return e.status(404).json({error:"\u0627\u0644\u062A\u0646\u0628\u064A\u0647 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(t)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u062A\u0646\u0628\u064A\u0647"})}}),i.get("/api/inventory/movements",w,j,async(r,e)=>{try{let{branchId:t,rawItemId:n,limit:o}=r.query;if(!t)return e.status(400).json({error:"\u0645\u0639\u0631\u0641 \u0627\u0644\u0641\u0631\u0639 \u0645\u0637\u0644\u0648\u0628"});let d=await f.getStockMovements(t,n,o?parseInt(o):100);e.json(d)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u062D\u0631\u0643\u0627\u062A \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}}),i.post("/api/inventory/calculate-cogs",w,async(r,e)=>{try{let{items:t,branchId:n}=r.body;if(!t||!Array.isArray(t)||t.length===0)return e.status(400).json({error:"\u0627\u0644\u0639\u0646\u0627\u0635\u0631 \u0645\u0637\u0644\u0648\u0628\u0629"});let o=t.map(l=>({coffeeItemId:l.id||l.coffeeItemId,quantity:l.quantity||1})),d=n||r.employee?.branchId,m=await f.calculateOrderCOGS(o,d);e.json(m)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0633\u0627\u0628 \u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0628\u0636\u0627\u0639\u0629 \u0627\u0644\u0645\u0628\u0627\u0639\u0629"})}}),i.get("/api/orders/:id/cogs",w,async(r,e)=>{try{let{id:t}=r.params,n=await f.getOrder(t);if(!n)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({orderId:t,orderNumber:n.orderNumber,totalAmount:n.totalAmount,costOfGoods:n.costOfGoods||0,grossProfit:n.grossProfit||0,profitMargin:n.totalAmount>0?((n.grossProfit||0)/n.totalAmount*100).toFixed(2):0,inventoryDeducted:n.inventoryDeducted===1,deductionDetails:n.inventoryDeductionDetails||[]})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u062A\u0643\u0644\u0641\u0629 \u0627\u0644\u0637\u0644\u0628"})}}),i.get("/api/inventory/dashboard",w,j,async(r,e)=>{try{let{branchId:t}=r.query,[n,o,d,m,l,g]=await Promise.all([f.getRawItems(),f.getSuppliers(),f.getLowStockItems(t),f.getStockAlerts(t,!1),f.getStockTransfers(t),f.getPurchaseInvoices(t)]),b=l.filter(S=>S.status==="pending"||S.status==="approved"),I=g.filter(S=>S.status==="pending"||S.status==="approved"),A=g.filter(S=>S.paymentStatus==="unpaid"||S.paymentStatus==="partial");e.json({summary:{totalRawItems:n.length,totalSuppliers:o.length,lowStockCount:d.length,alertsCount:m.length,pendingTransfersCount:b.length,pendingPurchasesCount:I.length,unpaidPurchasesCount:A.length},lowStock:d.slice(0,5),recentAlerts:m.slice(0,5),pendingTransfers:b.slice(0,5),pendingPurchases:I.slice(0,5)})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0644\u062E\u0635 \u0627\u0644\u0645\u062E\u0632\u0648\u0646"})}});let ke=await Promise.resolve().then(()=>(Vr(),zr));i.post("/api/zatca/invoices",w,async(r,e)=>{try{let{orderId:t,customerName:n,customerPhone:o,customerEmail:d,customerVatNumber:m,customerAddress:l,items:g,paymentMethod:b,branchId:I,invoiceType:A,transactionType:S}=r.body;if(!t||!n||!o||!g||!b)return e.status(400).json({error:"\u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u0646\u0627\u0642\u0635\u0629"});let C=await ke.getInvoiceByOrderId(t);if(C)return e.json(P(C));let N=await f.getOrder(t);if(!N)return e.status(404).json({error:"\u0627\u0644\u0637\u0644\u0628 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let x=await ke.createZATCAInvoice({orderId:t,orderNumber:N.orderNumber,customerName:n,customerPhone:o,customerEmail:d,customerVatNumber:m,customerAddress:l,items:g,paymentMethod:b,branchId:I||r.employee?.branchId,createdBy:r.employee?.id,invoiceType:A,transactionType:S});e.json(P(x))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629 \u0627\u0644\u0636\u0631\u064A\u0628\u064A\u0629"})}}),i.get("/api/zatca/invoices/order/:orderId",w,async(r,e)=>{try{let{orderId:t}=r.params,n=await ke.getInvoiceByOrderId(t);if(!n)return e.status(404).json({error:"\u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json(P(n))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629"})}}),i.get("/api/zatca/invoices/:id/xml",w,async(r,e)=>{try{let{id:t}=r.params,{TaxInvoiceModel:n}=await Promise.resolve().then(()=>(T(),R)),o=await n.findOne({id:t})||await n.findById(t).catch(()=>null);if(!o)return e.status(404).json({error:"\u0627\u0644\u0641\u0627\u062A\u0648\u0631\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.set("Content-Type","application/xml"),e.send(o.xmlContent)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0645\u0644\u0641 XML"})}}),i.get("/api/zatca/invoices",w,async(r,e)=>{try{let{branchId:t,startDate:n,endDate:o,page:d="1",limit:m="20"}=r.query,{TaxInvoiceModel:l}=await Promise.resolve().then(()=>(T(),R)),g={},b=t||r.employee?.branchId;b&&r.employee?.role!=="admin"&&r.employee?.role!=="owner"?g.branchId=b:t&&(g.branchId=t),(n||o)&&(g.invoiceDate={},n&&(g.invoiceDate.$gte=new Date(n)),o&&(g.invoiceDate.$lte=new Date(o)));let I=(parseInt(d)-1)*parseInt(m),[A,S]=await Promise.all([l.find(g).sort({invoiceDate:-1}).skip(I).limit(parseInt(m)),l.countDocuments(g)]);e.json({invoices:A.map(P),total:S,page:parseInt(d),pages:Math.ceil(S/parseInt(m))})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0641\u0648\u0627\u062A\u064A\u0631"})}}),i.get("/api/zatca/stats",w,j,async(r,e)=>{try{let{branchId:t,startDate:n,endDate:o}=r.query,d=t||r.employee?.branchId,m=await ke.getInvoiceStats(d,n?new Date(n):void 0,o?new Date(o):void 0);e.json(m)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0625\u062D\u0635\u0627\u0626\u064A\u0627\u062A \u0627\u0644\u0641\u0648\u0627\u062A\u064A\u0631"})}}),i.post("/api/accounting/expenses",w,j,async(r,e)=>{try{let{ExpenseModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n,date:o,category:d,subcategory:m,description:l,amount:g,vatAmount:b,paymentMethod:I,vendorName:A,vendorVatNumber:S,invoiceNumber:C,receiptUrl:N,notes:x}=r.body,L=g+(b||0),_=new t({branchId:n||r.employee?.branchId,date:new Date(o),category:d,subcategory:m,description:l,amount:g,vatAmount:b||0,totalAmount:L,paymentMethod:I,vendorName:A,vendorVatNumber:S,invoiceNumber:C,receiptUrl:N,createdBy:r.employee?.id,status:"pending",notes:x});await _.save(),e.json(P(_))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0645\u0635\u0631\u0648\u0641"})}}),i.get("/api/accounting/expenses",w,async(r,e)=>{try{let{ExpenseModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n,startDate:o,endDate:d,category:m,status:l,page:g="1",limit:b="20"}=r.query,I={},A=r.employee?.role==="admin"||r.employee?.role==="owner",S=n||(A?void 0:r.employee?.branchId);S&&(I.branchId=S),(o||d)&&(I.date={},o&&(I.date.$gte=new Date(o)),d&&(I.date.$lte=new Date(d))),m&&(I.category=m),l&&(I.status=l);let C=(parseInt(g)-1)*parseInt(b),[N,x]=await Promise.all([t.find(I).sort({date:-1}).skip(C).limit(parseInt(b)),t.countDocuments(I)]);e.json({expenses:N.map(P),total:x,page:parseInt(g),pages:Math.ceil(x/parseInt(b))})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0635\u0631\u0648\u0641\u0627\u062A"})}}),i.patch("/api/accounting/expenses/:id/approve",w,me,async(r,e)=>{try{let{ExpenseModel:t}=await Promise.resolve().then(()=>(T(),R)),{id:n}=r.params,o=await t.findByIdAndUpdate(n,{status:"approved",approvedBy:r.employee?.id,updatedAt:new Date},{new:!0});if(!o)return e.status(404).json({error:"\u0627\u0644\u0645\u0635\u0631\u0648\u0641 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json(P(o))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0639\u062A\u0645\u0627\u062F \u0627\u0644\u0645\u0635\u0631\u0648\u0641"})}}),i.post("/api/accounting/revenue",w,async(r,e)=>{try{let{RevenueModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n,date:o,orderId:d,invoiceId:m,category:l,description:g,grossAmount:b,vatAmount:I,netAmount:A,paymentMethod:S,notes:C}=r.body,N=new t({branchId:n||r.employee?.branchId,date:new Date(o),orderId:d,invoiceId:m,category:l||"sales",description:g,grossAmount:b,vatAmount:I,netAmount:A,paymentMethod:S,employeeId:r.employee?.id,notes:C});await N.save(),e.json(P(N))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u0625\u064A\u0631\u0627\u062F"})}}),i.get("/api/accounting/revenue",w,async(r,e)=>{try{let{RevenueModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n,startDate:o,endDate:d,category:m,page:l="1",limit:g="20"}=r.query,b={},I=r.employee?.role==="admin"||r.employee?.role==="owner",A=n||(I?void 0:r.employee?.branchId);A&&(b.branchId=A),(o||d)&&(b.date={},o&&(b.date.$gte=new Date(o)),d&&(b.date.$lte=new Date(d))),m&&(b.category=m);let S=(parseInt(l)-1)*parseInt(g),[C,N]=await Promise.all([t.find(b).sort({date:-1}).skip(S).limit(parseInt(g)),t.countDocuments(b)]);e.json({revenues:C.map(P),total:N,page:parseInt(l),pages:Math.ceil(N/parseInt(g))})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0625\u064A\u0631\u0627\u062F\u0627\u062A"})}}),i.get("/api/accounting/daily-summary",w,j,async(r,e)=>{try{let{branchId:t,date:n}=r.query,{DailySummaryModel:o,OrderModel:d,RevenueModel:m,ExpenseModel:l}=await Promise.resolve().then(()=>(T(),R)),g=n?new Date(n):new Date;g.setHours(0,0,0,0);let b=new Date(g);b.setDate(b.getDate()+1);let I=t||r.employee?.branchId,A=await o.findOne({branchId:I,date:{$gte:g,$lt:b}}),S=A;if(!A){let C={createdAt:{$gte:g,$lt:b},status:{$ne:"cancelled"}};I&&(C.branchId=I);let N=await d.find(C),x={date:{$gte:g,$lt:b},status:{$in:["approved","paid"]}};I&&(x.branchId=I);let L=await l.find(x),_=N.reduce((se,ie)=>se+(ie.totalAmount||0),0),V=_*.15/1.15,K=N.filter(se=>se.paymentMethod==="cash").reduce((se,ie)=>se+(ie.totalAmount||0),0),J=N.filter(se=>["pos","stc","alinma","ur","barq","rajhi"].includes(se.paymentMethod)).reduce((se,ie)=>se+(ie.totalAmount||0),0),je=_-K-J,ge=N.filter(se=>se.deliveryFee).reduce((se,ie)=>se+(ie.deliveryFee||0),0),Se=N.reduce((se,ie)=>se+(ie.costOfGoods||0),0),De=L.reduce((se,ie)=>se+ie.totalAmount,0),Ee=N.reduce((se,ie)=>{let it=ie.items?.reduce((We,Tt)=>We+Number(Tt.coffeeItem?.price||0)*Tt.quantity,0)||0;return se+(it-ie.totalAmount/1.15)},0),$e=await d.countDocuments({...C,status:"cancelled"});S={branchId:I||null,date:g,totalOrders:N.length,totalRevenue:Math.round(_*100)/100,totalVatCollected:Math.round(V*100)/100,cashRevenue:Math.round(K*100)/100,cardRevenue:Math.round(J*100)/100,otherRevenue:Math.round(je*100)/100,salesRevenue:Math.round((_-ge)*100)/100,deliveryRevenue:Math.round(ge*100)/100,totalCogs:Math.round(Se*100)/100,totalExpenses:Math.round(De*100)/100,grossProfit:Math.round((_-V-Se)*100)/100,netProfit:Math.round((_-V-Se-De)*100)/100,profitMargin:_>0?Math.round((_-V-Se-De)/_*100*100)/100:0,totalDiscounts:Math.round(Math.abs(Ee)*100)/100,cancelledOrders:$e,cancelledAmount:0}}e.json(P(S)||S)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0645\u0644\u062E\u0635 \u0627\u0644\u064A\u0648\u0645\u064A"})}}),i.get("/api/accounting/dashboard",w,j,async(r,e)=>{try{let{branchId:t,period:n="today"}=r.query,{OrderModel:o,ExpenseModel:d,TaxInvoiceModel:m}=await Promise.resolve().then(()=>(T(),R)),l=r.employee?.role==="admin"||r.employee?.role==="owner",g=t||(l?void 0:r.employee?.branchId),b=new Date,I=new Date,A=new Date;switch(n){case"today":I.setHours(0,0,0,0),A.setHours(23,59,59,999);break;case"week":I.setDate(b.getDate()-7);break;case"month":I.setDate(1);break;case"year":I=new Date(b.getFullYear(),0,1);break}let S={createdAt:{$gte:I,$lte:A},status:{$ne:"cancelled"}};g&&(S.branchId=g);let C={date:{$gte:I,$lte:A},status:{$in:["approved","paid"]}};g&&(C.branchId=g);let N={invoiceDate:{$gte:I,$lte:A}};g&&(N.branchId=g);let x=new Date;x.setDate(x.getDate()-30),x.setHours(0,0,0,0);let L={createdAt:{$gte:x},status:{$ne:"cancelled"}};g&&(L.branchId=g);let _={date:{$gte:x},status:{$in:["approved","paid"]}};g&&(_.branchId=g);let[V,K,J,je,ge]=await Promise.all([o.find(S),d.find(C),m.find(N),o.find(L),d.find(_)]),Se=V.reduce((W,Q)=>W+(Q.totalAmount||0),0),De=J.reduce((W,Q)=>W+(Q.taxAmount||0),0),Ee=K.reduce((W,Q)=>W+Q.totalAmount,0),$e=V.reduce((W,Q)=>W+(Q.costOfGoods||0),0),se=Se-De-$e,ie=se-Ee,it=K.reduce((W,Q)=>(W[Q.category]=(W[Q.category]||0)+Q.totalAmount,W),{}),We=V.reduce((W,Q)=>(W[Q.paymentMethod]=(W[Q.paymentMethod]||0)+(Q.totalAmount||0),W),{}),Tt=[];for(let W=6;W>=0;W--){let Q=new Date;Q.setDate(Q.getDate()-W),Q.setHours(0,0,0,0);let G=new Date(Q);G.setDate(G.getDate()+1);let tt=je.filter(de=>{let le=new Date(de.createdAt);return le>=Q&&le<G}),rt=ge.filter(de=>{let le=new Date(de.date);return le>=Q&&le<G}),ct=tt.reduce((de,le)=>de+(le.totalAmount||0),0),Ce=tt.reduce((de,le)=>de+(le.costOfGoods||0),0),Me=rt.reduce((de,le)=>de+le.totalAmount,0);Tt.push({date:Q.toISOString().split("T")[0],revenue:Math.round(ct*100)/100,expenses:Math.round(Me*100)/100,cogs:Math.round(Ce*100)/100,netProfit:Math.round((ct-Ce-Me)*100)/100})}let At=[];for(let W=3;W>=0;W--){let Q=new Date;Q.setDate(Q.getDate()-W*7),Q.setHours(23,59,59,999);let G=new Date(Q);G.setDate(G.getDate()-6),G.setHours(0,0,0,0);let tt=je.filter(de=>{let le=new Date(de.createdAt);return le>=G&&le<=Q}),rt=ge.filter(de=>{let le=new Date(de.date);return le>=G&&le<=Q}),ct=tt.reduce((de,le)=>de+(le.totalAmount||0),0),Ce=tt.reduce((de,le)=>de+(le.costOfGoods||0),0),Me=rt.reduce((de,le)=>de+le.totalAmount,0);At.push({week:`${G.getDate()}/${G.getMonth()+1} - ${Q.getDate()}/${Q.getMonth()+1}`,revenue:Math.round(ct*100)/100,expenses:Math.round(Me*100)/100,cogs:Math.round(Ce*100)/100,netProfit:Math.round((ct-Ce-Me)*100)/100})}let pt={};V.forEach(W=>{W.items&&Array.isArray(W.items)&&W.items.forEach(Q=>{if(!Q)return;let G=Q.coffeeItemId||Q.id||"unknown";if(!G||G==="unknown")return;let tt=Q.coffeeItem?.nameAr||Q.nameAr||"\u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641",rt=Number(Q.quantity)||1,ct=Number(Q.price)||0;pt[G]||(pt[G]={name:tt,quantity:0,revenue:0}),pt[G].quantity+=rt,pt[G].revenue+=ct*rt})});let Tn=Object.entries(pt).filter(([W])=>W&&W!=="unknown").map(([W,Q])=>({id:W,...Q})).sort((W,Q)=>Q.revenue-W.revenue).slice(0,10);e.json({period:n,summary:{totalRevenue:Math.round(Se*100)/100,totalVatCollected:Math.round(De*100)/100,totalExpenses:Math.round(Ee*100)/100,totalCogs:Math.round($e*100)/100,grossProfit:Math.round(se*100)/100,netProfit:Math.round(ie*100)/100,profitMargin:Se>0?Math.round(ie/Se*100*100)/100:0,orderCount:V.length,invoiceCount:J.length},expensesByCategory:it,revenueByPayment:We,dailyTrend:Tt,weeklyTrend:At,topSellingItems:Tn})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0644\u0648\u062D\u0629 \u0627\u0644\u0645\u062D\u0627\u0633\u0628\u0629"})}}),i.get("/api/kitchen/orders",w,Br,async(r,e)=>{try{let{KitchenOrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{branchId:n,status:o}=r.query,d={},m=n||r.employee?.branchId;m&&(d.branchId=m),o?d.status=o:d.status={$in:["pending","in_progress"]};let l=await t.find(d).sort({priority:-1,createdAt:1});e.json(l.map(P))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0637\u0644\u0628\u0627\u062A \u0627\u0644\u0645\u0637\u0628\u062E"})}}),i.post("/api/kitchen/orders",w,Vt,async(r,e)=>{try{let{KitchenOrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{orderId:n,orderNumber:o,items:d,orderType:m,tableNumber:l,customerName:g,priority:b,notes:I}=r.body,A=await t.findOne({orderId:n});if(A)return e.json(P(A));let S=new t({orderId:n,orderNumber:o,branchId:r.employee?.branchId,items:d.map(C=>({itemId:C.itemId||C.coffeeItemId,nameAr:C.nameAr||C.coffeeItem?.nameAr,quantity:C.quantity,notes:C.notes,status:"pending"})),priority:b||"normal",orderType:m||"takeaway",tableNumber:l,customerName:g,status:"pending",notes:I});await S.save(),e.json(P(S))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0637\u0644\u0628 \u0627\u0644\u0645\u0637\u0628\u062E"})}}),i.patch("/api/kitchen/orders/:id",w,Br,async(r,e)=>{try{let{KitchenOrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{id:n}=r.params,{status:o,assignedTo:d}=r.body,m={updatedAt:new Date};o&&(m.status=o,o==="in_progress"?(m.startedAt=new Date,m.assignedTo=r.employee?.id):(o==="ready"||o==="completed")&&(m.completedAt=new Date)),d&&(m.assignedTo=d);let l=await t.findByIdAndUpdate(n,m,{new:!0});if(!l)return e.status(404).json({error:"\u0637\u0644\u0628 \u0627\u0644\u0645\u0637\u0628\u062E \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(o==="in_progress"&&l.orderId&&l.branchId){let g=r.employee?.id||"system";(await Qr(l.orderId,l.branchId,g)).success}e.json(P(l))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0637\u0644\u0628 \u0627\u0644\u0645\u0637\u0628\u062E"})}}),i.patch("/api/kitchen/orders/:id/items/:itemId",w,Br,async(r,e)=>{try{let{KitchenOrderModel:t}=await Promise.resolve().then(()=>(T(),R)),{id:n,itemId:o}=r.params,{status:d}=r.body,m=await t.findOne({id:n})||await t.findById(n).catch(()=>null);if(!m)return e.status(404).json({error:"\u0637\u0644\u0628 \u0627\u0644\u0645\u0637\u0628\u062E \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});let l=m.items.find(b=>b.itemId===o);if(!l)return e.status(404).json({error:"\u0627\u0644\u0639\u0646\u0635\u0631 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});l.status=d,d==="ready"&&(l.preparedBy=r.employee?.id,l.preparedAt=new Date),m.items.every(b=>b.status==="ready")?(m.status="ready",m.completedAt=new Date):m.items.some(b=>b.status==="preparing")&&(m.status="in_progress"),m.updatedAt=new Date,await m.save(),e.json(P(m))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0639\u0646\u0635\u0631 \u0627\u0644\u0645\u0637\u0628\u062E"})}}),i.post("/api/delivery/check-availability",async(r,e)=>{try{let{latitude:t,longitude:n}=r.body;if(!t||!n)return e.status(400).json({error:"\u0627\u0644\u0645\u0648\u0642\u0639 \u0645\u0637\u0644\u0648\u0628"});let o={lat:Number(t),lng:Number(n)},d=await f.getBranches(),{checkDeliveryAvailability:m}=await Promise.resolve().then(()=>(Pn(),Cn)),l=m(o,d);e.json({canDeliver:l.canDeliver,nearestBranch:l.nearestBranch?{id:l.nearestBranch._id?.toString()||l.nearestBranch.id,nameAr:l.nearestBranch.nameAr,nameEn:l.nearestBranch.nameEn}:null,distanceMeters:l.distanceMeters,message:l.message,messageAr:l.messageAr,deliveryRadiusMeters:500,allBranches:l.allBranchesWithDistance.map(g=>({id:g.branch._id?.toString()||g.branch.id,nameAr:g.branch.nameAr,nameEn:g.branch.nameEn,distanceMeters:Math.round(g.distanceMeters),isInRange:g.isInRange}))})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u062A\u0648\u0635\u064A\u0644"})}}),i.get("/api/product-addons",async(r,e)=>{try{let{ProductAddonModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await t.find({isAvailable:1}).sort({orderIndex:1,category:1,nameAr:1});e.json(n.map(o=>({...o.toObject(),id:o.id})))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0625\u0636\u0627\u0641\u0627\u062A"})}}),i.get("/api/coffee-items/:coffeeItemId/addons",async(r,e)=>{try{let{CoffeeItemAddonModel:t,ProductAddonModel:n}=await Promise.resolve().then(()=>(T(),R)),o=await t.find({coffeeItemId:r.params.coffeeItemId}),d=o.map(g=>g.addonId),m=await n.find({id:{$in:d},isAvailable:1}),l=o.map(g=>{let b=m.find(I=>I.id===g.addonId);return b?{...b.toObject(),id:b.id,isDefault:g.isDefault,defaultValue:g.defaultValue,minQuantity:g.minQuantity,maxQuantity:g.maxQuantity}:null}).filter(Boolean);e.json(l)}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0625\u0636\u0627\u0641\u0627\u062A \u0627\u0644\u0645\u0634\u0631\u0648\u0628"})}}),i.post("/api/product-addons",w,j,async(r,e)=>{try{let{ProductAddonModel:t,insertProductAddonSchema:n}=await Promise.resolve().then(()=>(T(),R)),o=n.parse(r.body),d=new t(o);await d.save(),e.status(201).json({...d.toObject(),id:d.id})}catch(t){if(t?.name==="ZodError")return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",details:t.errors});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0625\u0636\u0627\u0641\u0629"})}}),i.put("/api/product-addons/:id",w,j,async(r,e)=>{try{let{ProductAddonModel:t,insertProductAddonSchema:n}=await Promise.resolve().then(()=>(T(),R)),d=n.partial().parse(r.body),m=await t.findOneAndUpdate({id:r.params.id},{$set:d},{new:!0});if(!m)return e.status(404).json({error:"\u0627\u0644\u0625\u0636\u0627\u0641\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629"});e.json({...m.toObject(),id:m.id})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0625\u0636\u0627\u0641\u0629"})}}),i.delete("/api/product-addons/:id",w,j,async(r,e)=>{try{let{ProductAddonModel:t,CoffeeItemAddonModel:n}=await Promise.resolve().then(()=>(T(),R));await t.deleteOne({id:r.params.id}),await n.deleteMany({addonId:r.params.id}),e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0625\u0636\u0627\u0641\u0629 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0625\u0636\u0627\u0641\u0629"})}}),i.post("/api/coffee-items/:coffeeItemId/addons",w,j,async(r,e)=>{try{let{CoffeeItemAddonModel:t,insertCoffeeItemAddonSchema:n}=await Promise.resolve().then(()=>(T(),R)),o=n.parse({coffeeItemId:r.params.coffeeItemId,...r.body});await t.findOneAndUpdate({coffeeItemId:o.coffeeItemId,addonId:o.addonId},{$set:o},{upsert:!0,new:!0}),e.status(201).json({success:!0})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0631\u0628\u0637 \u0627\u0644\u0625\u0636\u0627\u0641\u0629 \u0628\u0627\u0644\u0645\u0634\u0631\u0648\u0628"})}}),i.delete("/api/coffee-items/:coffeeItemId/addons/:addonId",w,j,async(r,e)=>{try{let{CoffeeItemAddonModel:t}=await Promise.resolve().then(()=>(T(),R));await t.deleteOne({coffeeItemId:r.params.coffeeItemId,addonId:r.params.addonId}),e.json({success:!0})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0632\u0627\u0644\u0629 \u0627\u0644\u0625\u0636\u0627\u0641\u0629 \u0645\u0646 \u0627\u0644\u0645\u0634\u0631\u0648\u0628"})}}),i.get("/api/promo-offers",async(r,e)=>{try{let{PromoOfferModel:t}=await Promise.resolve().then(()=>(T(),R)),n=new Date,o=await t.find({isActive:1,$or:[{startDate:null,endDate:null},{startDate:{$lte:n},endDate:null},{startDate:null,endDate:{$gte:n}},{startDate:{$lte:n},endDate:{$gte:n}}]}).sort({sortOrder:1,createdAt:-1});e.json(o.map(d=>({...d.toObject(),id:d.id})))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0639\u0631\u0648\u0636"})}}),i.get("/api/admin/promo-offers",w,j,async(r,e)=>{try{let{PromoOfferModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await t.find({}).sort({sortOrder:1,createdAt:-1});e.json(n.map(o=>({...o.toObject(),id:o.id})))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0639\u0631\u0648\u0636"})}}),i.post("/api/promo-offers",w,j,async(r,e)=>{try{let{PromoOfferModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await import("crypto"),o={...r.body,id:r.body.id||n.randomUUID(),tenantId:r.body.tenantId||"default",createdAt:new Date,updatedAt:new Date},d=new t(o);await d.save(),e.status(201).json({...d.toObject(),id:d.id})}catch(t){console.error("Error creating promo offer:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0639\u0631\u0636"})}}),i.put("/api/promo-offers/:id",w,j,async(r,e)=>{try{let{PromoOfferModel:t}=await Promise.resolve().then(()=>(T(),R)),n=await t.findOneAndUpdate({id:r.params.id},{$set:{...r.body,updatedAt:new Date}},{new:!0});if(!n)return e.status(404).json({error:"\u0627\u0644\u0639\u0631\u0636 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({...n.toObject(),id:n.id})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0639\u0631\u0636"})}}),i.delete("/api/promo-offers/:id",w,j,async(r,e)=>{try{let{PromoOfferModel:t}=await Promise.resolve().then(()=>(T(),R));await t.deleteOne({id:r.params.id}),e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0639\u0631\u0636 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0639\u0631\u0636"})}}),i.get("/api/menu-categories",async(r,e)=>{try{let{MenuCategoryModel:t}=await Promise.resolve().then(()=>(T(),R)),n=k(r)||"demo-tenant",o=r.query.branchId,d={isActive:1,tenantId:n};o&&o!=="all"&&o!=="undefined"&&o!=="null"&&(d.$or=[{branchId:o},{publishedBranches:o},{createdByBranchId:o}]);let m=await t.find(d).sort({orderIndex:1,createdAt:1});e.json(m.map(l=>({...l.toObject(),id:l.id})))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0623\u0642\u0633\u0627\u0645"})}}),i.post("/api/menu-categories",w,j,async(r,e)=>{try{let{MenuCategoryModel:t}=await Promise.resolve().then(()=>(T(),R)),{z:n}=await import("zod"),o=await import("crypto"),m=n.object({nameAr:n.string().min(1,"\u0627\u0633\u0645 \u0627\u0644\u0642\u0633\u0645 \u0645\u0637\u0644\u0648\u0628"),nameEn:n.string().optional(),icon:n.string().optional(),department:n.enum(["drinks","food"]).default("drinks")}).parse(r.body),l=k(r)||"demo-tenant",b=((await t.findOne({tenantId:l}).sort({orderIndex:-1}))?.orderIndex||0)+1,I={id:o.randomUUID(),tenantId:l,nameAr:m.nameAr,nameEn:m.nameEn,icon:m.icon||"Coffee",department:m.department,orderIndex:b,isSystem:!1,isActive:1,createdAt:new Date,updatedAt:new Date},A=new t(I);await A.save(),e.status(201).json({...A.toObject(),id:A.id})}catch(t){if(t.name==="ZodError")return e.status(400).json({error:t.errors[0]?.message||"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});console.error("Error creating menu category:",t),e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0646\u0634\u0627\u0621 \u0627\u0644\u0642\u0633\u0645"})}}),i.put("/api/menu-categories/:id",w,j,async(r,e)=>{try{let{MenuCategoryModel:t}=await Promise.resolve().then(()=>(T(),R)),{z:n}=await import("zod"),d=n.object({nameAr:n.string().min(1).optional(),nameEn:n.string().optional(),icon:n.string().optional(),department:n.enum(["drinks","food"]).optional(),orderIndex:n.number().optional()}).parse(r.body),m=k(r)||"demo-tenant",l=await t.findOneAndUpdate({id:r.params.id,tenantId:m},{$set:{...d,updatedAt:new Date}},{new:!0});if(!l)return e.status(404).json({error:"\u0627\u0644\u0642\u0633\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});e.json({...l.toObject(),id:l.id})}catch(t){if(t.name==="ZodError")return e.status(400).json({error:t.errors[0]?.message||"\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629"});e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0642\u0633\u0645"})}}),i.delete("/api/menu-categories/:id",w,j,async(r,e)=>{try{let{MenuCategoryModel:t}=await Promise.resolve().then(()=>(T(),R)),n=k(r)||"demo-tenant",o=await t.findOne({id:r.params.id,tenantId:n});if(!o)return e.status(404).json({error:"\u0627\u0644\u0642\u0633\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"});if(o.isSystem)return e.status(400).json({error:"\u0644\u0627 \u064A\u0645\u0643\u0646 \u062D\u0630\u0641 \u0642\u0633\u0645 \u0623\u0633\u0627\u0633\u064A"});await t.findOneAndUpdate({id:r.params.id,tenantId:n},{$set:{isActive:0,updatedAt:new Date}}),e.json({success:!0,message:"\u062A\u0645 \u062D\u0630\u0641 \u0627\u0644\u0642\u0633\u0645 \u0628\u0646\u062C\u0627\u062D"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0642\u0633\u0645"})}}),i.get("/api/loyalty/cards/lookup/:token",async(r,e)=>{try{let{LoyaltyCardModel:t,CustomerModel:n}=await Promise.resolve().then(()=>(T(),R)),o=r.params.token,d=await t.findOne({$or:[{qrToken:o},{cardNumber:o},{phoneNumber:o}]});if(!d)return e.status(404).json({error:"\u0627\u0644\u0628\u0637\u0627\u0642\u0629 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\u0629",found:!1});let m=await n.findOne({phone:d.phoneNumber});e.json({found:!0,card:{...d.toObject(),id:d._id?.toString()||d.id},customer:m?{id:m._id?.toString(),name:m.name,phone:m.phone,email:m.email,points:m.points}:null})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u0628\u0637\u0627\u0642\u0629"})}}),i.get("/api/reviews",async(r,e)=>{try{let{productId:t}=r.query,n=await Ar.find({productId:t});e.json(n.map(P))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u062A\u0642\u064A\u064A\u0645\u0627\u062A"})}}),i.post("/api/reviews",w,async(r,e)=>{try{let{productId:t,rating:n,comment:o}=r.body,d=r.user?.id,m=new Ar({productId:t,customerId:d,rating:n,comment:o,isVerifiedPurchase:1});await m.save(),e.json(P(m))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0641\u0638 \u0627\u0644\u062A\u0642\u064A\u064A\u0645"})}}),i.get("/api/referrals",w,async(r,e)=>{try{let t=r.user?.id,n=await Dr.find({referrerId:t}),o=n.filter(l=>l.status==="completed").length,d=`REFER${t?.substring(0,8).toUpperCase()}`,m=o*50;e.json({code:d,completed:o,points:m,list:n.map(P)})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0625\u062D\u0627\u0644\u0627\u062A"})}}),i.post("/api/referrals/invite",w,async(r,e)=>{try{let t=r.user?.id,{referredPhone:n,referredEmail:o}=r.body,d=`REFER${t?.substring(0,8).toUpperCase()}`,m=new Dr({referrerId:t,referrerCode:d,referredPhone:n,referredEmail:o,status:"pending"});await m.save(),await new ft({customerId:t,title:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u062F\u0639\u0648\u0629",message:`\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0631\u0645\u0632 \u0627\u0644\u0625\u062D\u0627\u0644\u0629 \u0627\u0644\u062E\u0627\u0635 \u0628\u0643 \u0625\u0644\u0649 ${n}`,type:"referral"}).save(),e.json(P(m))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u062F\u0639\u0648\u0629"})}}),i.get("/api/notifications",async(r,e)=>{try{let t=r.user?.id||r.query.customerId,n=await ft.find({customerId:t}).sort({createdAt:-1});e.json(n.map(P))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0625\u0634\u0639\u0627\u0631\u0627\u062A"})}}),i.post("/api/admin/broadcast-email",w,async(r,e)=>{try{let{subject:t,message:n,customerEmails:o}=r.body;if(!t||!n||!o||!Array.isArray(o))return e.status(400).json({error:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u062D\u0645\u0644\u0629 \u063A\u064A\u0631 \u0645\u0643\u062A\u0645\u0644\u0629"});let{appendOrderToSheet:d}=await Promise.resolve().then(()=>(Ur(),Lr));for(let m of o)await d({id:`MKT-${Date.now()}`,customerEmail:m,status:t,customerNotes:n},"MARKETING");e.json({success:!0,message:"\u062A\u0645\u062A \u062C\u062F\u0648\u0644\u0629 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u062D\u0645\u0644\u0629 \u0627\u0644\u0628\u0631\u064A\u062F\u064A\u0629 \u0639\u0628\u0631 \u062C\u0648\u062C\u0644 \u0634\u064A\u062A"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062C\u062F\u0648\u0644\u0629 \u0627\u0644\u062D\u0645\u0644\u0629 \u0627\u0644\u0628\u0631\u064A\u062F\u064A\u0629"})}}),i.patch("/api/notifications/:id/read",async(r,e)=>{try{let t=await ft.findByIdAndUpdate(r.params.id,{isRead:1},{new:!0});e.json(P(t))}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0625\u0634\u0639\u0627\u0631"})}}),i.delete("/api/notifications/:id",async(r,e)=>{try{await ft.findByIdAndDelete(r.params.id),e.json({success:!0})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062D\u0630\u0641 \u0627\u0644\u0625\u0634\u0639\u0627\u0631"})}}),i.post("/api/notifications/mark-all-read",w,async(r,e)=>{try{let t=r.user?.id;await ft.updateMany({customerId:t,isRead:0},{isRead:1}),e.json({success:!0})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0625\u0634\u0639\u0627\u0631\u0627\u062A"})}}),i.post("/api/send-order-email",w,async(r,e)=>{try{let{orderId:t,orderStatus:n,orderTotal:o}=r.body,d=r.user?.id,m=await ee.findById(d);if(!m||!m.email)return e.status(400).json({error:"\u0628\u0631\u064A\u062F \u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u062A\u0648\u0641\u0631"});await Fr(m.email,m.name,t,n,o)||console.log("Email service not configured, but notification created"),e.json({success:!0,message:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0625\u0634\u0639\u0627\u0631"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0625\u0634\u0639\u0627\u0631"})}}),i.post("/api/send-referral-email",w,async(r,e)=>{try{let t=r.user?.id,n=await ee.findById(t);if(!n||!n.email)return e.status(400).json({error:"\u0628\u0631\u064A\u062F \u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u062A\u0648\u0641\u0631"});let o=`REFER${t?.substring(0,8).toUpperCase()}`;await wn(n.email,n.name,o)||console.log("Email service not configured, but referral tracked"),e.json({success:!0,message:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0628\u0631\u064A\u062F \u0627\u0644\u0625\u062D\u0627\u0644\u0629"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0628\u0631\u064A\u062F \u0627\u0644\u0625\u062D\u0627\u0644\u0629"})}}),i.post("/api/send-loyalty-email",w,async(r,e)=>{try{let{pointsEarned:t}=r.body,n=r.user?.id,o=await ee.findById(n);if(!o||!o.email)return e.status(400).json({error:"\u0628\u0631\u064A\u062F \u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u062A\u0648\u0641\u0631"});await vn(o.email,o.name,t,o.points||0)||console.log("Email service not configured, but points tracked"),e.json({success:!0,message:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0628\u0631\u064A\u062F \u0627\u0644\u0646\u0642\u0627\u0637"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0628\u0631\u064A\u062F \u0627\u0644\u0646\u0642\u0627\u0637"})}}),i.post("/api/send-promotion-email",me,async(r,e)=>{try{let{customerId:t,promotionTitle:n,promotionDescription:o,discountCode:d}=r.body,m=await ee.findById(t);if(!m||!m.email)return e.status(400).json({error:"\u0628\u0631\u064A\u062F \u0627\u0644\u0639\u0645\u064A\u0644 \u063A\u064A\u0631 \u0645\u062A\u0648\u0641\u0631"});await An(m.email,m.name,n,o,d)||console.log("Email service not configured, but promotion tracked"),e.json({success:!0,message:"\u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0639\u0631\u0636 \u0627\u0644\u062A\u0631\u0648\u064A\u062C\u064A"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0639\u0631\u0636 \u0627\u0644\u062A\u0631\u0648\u064A\u062C\u064A"})}}),i.get("/api/email-status",async(r,e)=>{try{let t=await Dn();e.json({connected:t,message:t?"\u062E\u062F\u0645\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u062A\u0635\u0644\u0629":"\u062E\u062F\u0645\u0629 \u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u063A\u064A\u0631 \u0645\u062A\u0635\u0644\u0629. \u0627\u0644\u0631\u062C\u0627\u0621 \u062A\u0643\u0648\u064A\u0646 \u0628\u064A\u0627\u0646\u0627\u062A Gmail"})}catch{e.status(500).json({error:"\u0641\u0634\u0644 \u0641\u064A \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u062D\u0627\u0644\u0629 \u0627\u0644\u0628\u0631\u064A\u062F"})}}),i.post("/api/test-email",async(r,e)=>{try{let{email:t="youssefdarwish20009@gmail.com",customerName:n="\u0627\u0644\u0639\u0645\u064A\u0644",orderId:o="TEST001",status:d="in_progress",total:m=45.5}=r.body;if(!t)return e.status(400).json({error:"\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0645\u0637\u0644\u0648\u0628"});await Fr(t,n,o,d,m)?e.json({success:!0,message:"\u2705 \u062A\u0645 \u0625\u0631\u0633\u0627\u0644 \u0631\u0633\u0627\u0644\u0629 \u062A\u0623\u0643\u064A\u062F \u0627\u0644\u0637\u0644\u0628 \u0628\u0646\u062C\u0627\u062D!",details:{email:t,customerName:n,orderId:o,status:d,total:m}}):e.status(500).json({error:"\u274C \u0641\u0634\u0644 \u0641\u064A \u0625\u0631\u0633\u0627\u0644 \u0631\u0633\u0627\u0644\u0629 \u062A\u0623\u0643\u064A\u062F \u0627\u0644\u0637\u0644\u0628"})}catch(t){e.status(500).json({error:"\u274C \u062E\u0637\u0623: "+t.message})}}),i.get("/api/admin/tenants",me,async(r,e)=>{try{let t=await ze.find().lean();e.json(t)}catch{e.status(500).json({error:"Failed to fetch tenants"})}}),i.get("/api/admin/tenants/:tenantId",me,async(r,e)=>{try{let t=await ze.findOne({id:r.params.tenantId}).lean();if(!t)return e.status(404).json({error:"Tenant not found"});e.json(t)}catch{e.status(500).json({error:"Failed to fetch tenant"})}}),i.post("/api/admin/tenants",me,async(r,e)=>{try{let{id:t,nameAr:n,nameEn:o,type:d,businessName:m,businessPhone:l,businessEmail:g,billingContact:b,adminContact:I}=r.body;if(!t||!n||!o||!m)return e.status(400).json({error:"Missing required fields"});let A=new ze({id:t,nameAr:n,nameEn:o,type:d||"demo",businessName:m,businessPhone:l,businessEmail:g,billingContact:b,adminContact:I,status:"active"});await A.save(),e.json({success:!0,tenant:A})}catch(t){e.status(500).json({error:t.message||"Failed to create tenant"})}}),i.patch("/api/admin/tenants/:tenantId",me,async(r,e)=>{try{let t=await ze.findOneAndUpdate({id:r.params.tenantId},{$set:{...r.body,updatedAt:new Date}},{new:!0});if(!t)return e.status(404).json({error:"Tenant not found"});e.json({success:!0,tenant:t})}catch{e.status(500).json({error:"Failed to update tenant"})}}),i.delete("/api/admin/tenants/:tenantId",me,async(r,e)=>{try{await ze.updateOne({id:r.params.tenantId},{status:"inactive"}),e.json({success:!0,message:"Tenant deactivated"})}catch{e.status(500).json({error:"Failed to deactivate tenant"})}}),i.get("/api/tenant/info",w,async(r,e)=>{try{let t=r.employee?.tenantId;if(!t)return e.status(400).json({error:"No tenant context"});let n=await ze.findOne({id:t}).lean();if(!n)return e.status(404).json({error:"Tenant not found"});e.json(n)}catch{e.status(500).json({error:"Failed to fetch tenant info"})}}),i.get("/api/recipes/:coffeeItemId",w,async(r,e)=>{try{let{coffeeItemId:t}=r.params,n=await Er.getActiveRecipe(t);if(!n)return e.status(404).json({error:"Recipe not found"});e.json({success:!0,recipe:n})}catch{e.status(500).json({error:"Failed to fetch recipe"})}}),i.get("/api/inventory/stock-level/:branchId/:rawItemId",w,async(r,e)=>{try{let{branchId:t,rawItemId:n}=r.params,o=await wt.getStockLevel(t,n);if(!o)return e.status(404).json({error:"Stock record not found"});e.json({success:!0,stockLevel:o})}catch{e.status(500).json({error:"Failed to fetch stock level"})}}),i.post("/api/inventory/stock-in",w,j,async(r,e)=>{try{let{branchId:t,rawItemId:n,quantity:o,unit:d,supplierId:m,notes:l}=r.body,g=r.employee?.id||"system";if(!t||!n||!o||!d)return e.status(400).json({error:"Missing required fields"});let b=await wt.recordStockIn({branchId:t,rawItemId:n,quantity:o,unit:d,supplierId:m,notes:l,createdBy:g});if(!b.success)return e.status(400).json({error:b.error});e.json({success:!0,newQuantity:b.newQuantity,movement:b.movement})}catch{e.status(500).json({error:"Failed to record stock in"})}}),i.get("/api/inventory/alerts/:branchId",w,async(r,e)=>{try{let{branchId:t}=r.params,n=await wt.getActiveAlerts(t);e.json({success:!0,alerts:n})}catch{e.status(500).json({error:"Failed to fetch alerts"})}}),i.get("/api/inventory/low-stock/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=await wt.getLowStockItems(t);e.json({success:!0,items:n})}catch{e.status(500).json({error:"Failed to fetch low stock items"})}}),i.get("/api/inventory/movements/:branchId/:rawItemId",w,async(r,e)=>{try{let{branchId:t,rawItemId:n}=r.params,o=r.query.limit?parseInt(r.query.limit):50,d=await wt.getMovementHistory(t,n,o);e.json({success:!0,movements:d})}catch{e.status(500).json({error:"Failed to fetch movement history"})}}),i.get("/api/accounting/daily-snapshot/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.date?new Date(r.query.date):void 0,o=await ot.getDailySnapshot(t,n);e.json({success:!0,snapshot:o})}catch{e.status(500).json({error:"Failed to fetch daily snapshot"})}}),i.get("/api/accounting/profit-by-item/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().setDate(new Date().getDate()-30)),o=r.query.endDate?new Date(r.query.endDate):new Date,d=await ot.getProfitPerDrink(t,n,o);e.json({success:!0,report:d})}catch{e.status(500).json({error:"Failed to fetch profit report"})}}),i.get("/api/accounting/profit-by-category/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().setDate(new Date().getDate()-30)),o=r.query.endDate?new Date(r.query.endDate):new Date,d=await ot.getProfitPerCategory(t,n,o);e.json({success:!0,report:d})}catch{e.status(500).json({error:"Failed to fetch category report"})}}),i.get("/api/accounting/top-items/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().setDate(new Date().getDate()-30)),o=r.query.endDate?new Date(r.query.endDate):new Date,d=r.query.limit?parseInt(r.query.limit):10,m=await ot.getTopProfitableItems(t,n,o,d);e.json({success:!0,items:m})}catch{e.status(500).json({error:"Failed to fetch top items"})}}),i.get("/api/accounting/worst-items/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().setDate(new Date().getDate()-30)),o=r.query.endDate?new Date(r.query.endDate):new Date,d=r.query.limit?parseInt(r.query.limit):10,m=await ot.getWorstItems(t,n,o,d);e.json({success:!0,items:m})}catch{e.status(500).json({error:"Failed to fetch worst items"})}}),i.get("/api/accounting/waste-report/:branchId",w,j,async(r,e)=>{try{let{branchId:t}=r.params,n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().setDate(new Date().getDate()-30)),o=r.query.endDate?new Date(r.query.endDate):new Date,d=await ot.getWasteReport(t,n,o);e.json({success:!0,report:d})}catch{e.status(500).json({error:"Failed to fetch waste report"})}}),i.post("/api/accounting/snapshot",w,j,async(r,e)=>{try{let{tenantId:t,branchId:n}=r.body,o=r.employee?.id||"system";if(!t||!n)return e.status(400).json({error:"Missing required fields: tenantId, branchId"});let d=await ot.saveDailySnapshot(t,n,o);if(!d)return e.status(400).json({error:"Failed to save snapshot"});e.json({success:!0,snapshot:d})}catch{e.status(500).json({error:"Failed to save snapshot"})}}),i.post("/api/erp/accounts/initialize",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=await ce.initializeChartOfAccounts(t);e.json({success:!0,accounts:n.map(P),count:n.length})}catch(t){console.error("Error initializing chart of accounts:",t),e.status(500).json({error:t.message||"Failed to initialize chart of accounts"})}}),i.get("/api/erp/accounts",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=await ce.getAccounts(t,{accountType:r.query.accountType,isActive:r.query.isActive?parseInt(r.query.isActive):void 0,parentAccountId:r.query.parentAccountId});e.json({success:!0,accounts:n.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch accounts"})}}),i.get("/api/erp/accounts/tree",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=await ce.getAccountTree(t);e.json({success:!0,tree:n})}catch(t){e.status(500).json({error:t.message||"Failed to fetch account tree"})}}),i.post("/api/erp/accounts",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=await ce.createAccount({tenantId:t,...r.body});e.json({success:!0,account:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create account"})}}),i.get("/api/erp/journal-entries",w,j,async(r,e)=>{try{let n={tenantId:k(r)||r.query.tenantId||"demo-tenant"};r.query.status&&(n.status=r.query.status),r.query.referenceType&&(n.referenceType=r.query.referenceType);let o=await bt.find(n).sort({entryDate:-1,createdAt:-1}).limit(100);e.json({success:!0,entries:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch journal entries"})}}),i.get("/api/erp/expenses",w,j,async(r,e)=>{try{let n={tenantId:k(r)||r.query.tenantId||"demo-tenant"};r.query.status&&(n.status=r.query.status);let o=await It.find(n).sort({createdAt:-1}).limit(100);e.json({success:!0,expenses:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch expenses"})}}),i.post("/api/erp/journal-entries",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.id||"system",o=await ce.createJournalEntry({tenantId:t,...r.body,createdBy:n});e.json({success:!0,entry:P(o)})}catch(t){e.status(400).json({error:t.message||"Failed to create journal entry"})}}),i.patch("/api/erp/journal-entries/:id/post",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.id||"system",o=await ce.postJournalEntry(t,r.params.id,n);e.json({success:!0,entry:P(o)})}catch(t){e.status(400).json({error:t.message||"Failed to post journal entry"})}}),i.post("/api/erp/invoices/from-order/:orderId",w,Vt,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.branchId||r.body.branchId||"default-branch",o=r.employee?.id||"system",d=r.body.sellerInfo,m=await ce.createInvoiceFromOrder(t,n,r.params.orderId,o,d);e.json({success:!0,invoice:P(m)})}catch(t){e.status(400).json({error:t.message||"Failed to create invoice"})}}),i.get("/api/erp/invoices",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=r.query.branchId,o=r.query.status,d=r.query.startDate?new Date(r.query.startDate):void 0,m=r.query.endDate?new Date(r.query.endDate):void 0,l=r.query.limit?parseInt(r.query.limit):100,g=await ce.getInvoices(t,{branchId:n,status:o,startDate:d,endDate:m,limit:l});e.json({success:!0,invoices:g.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch invoices"})}}),i.get("/api/erp/invoices/:id",w,Vt,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=await ce.getInvoiceById(t,r.params.id);if(!n)return e.status(404).json({error:"Invoice not found"});e.json({success:!0,invoice:P(n)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch invoice"})}}),i.post("/api/erp/invoices",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.branchId||r.body.branchId||"default-branch",o=r.employee?.id||"system",d=await ce.createInvoice({tenantId:t,branchId:n,customerName:r.body.customerName,customerPhone:r.body.customerPhone,customerEmail:r.body.customerEmail,customerTaxNumber:r.body.customerTaxNumber,customerAddress:r.body.customerAddress,lines:r.body.lines,notes:r.body.notes,issuedBy:o,sellerName:r.body.sellerName||"CLUNY CAFE",sellerVatNumber:r.body.sellerVatNumber||"311234567890003"});e.json({success:!0,invoice:P(d)})}catch(t){e.status(400).json({error:t.message||"Failed to create invoice"})}}),i.patch("/api/erp/invoices/:id/status",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=await ce.updateInvoiceStatus(t,r.params.id,r.body.status,r.body.amountPaid);if(!n)return e.status(404).json({error:"Invoice not found"});e.json({success:!0,invoice:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to update invoice status"})}}),i.get("/api/erp/reports/trial-balance",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=r.query.endDate?new Date(r.query.endDate):new Date,o=await ce.getTrialBalance(t,n);e.json({success:!0,trialBalance:o})}catch(t){e.status(500).json({error:t.message||"Failed to fetch trial balance"})}}),i.get("/api/erp/reports/income-statement",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=r.query.startDate?new Date(r.query.startDate):new Date(new Date().getFullYear(),0,1),o=r.query.endDate?new Date(r.query.endDate):new Date,d=r.query.branchId,m=await ce.getIncomeStatement(t,n,o,d);e.json({success:!0,incomeStatement:m})}catch(t){e.status(500).json({error:t.message||"Failed to fetch income statement"})}}),i.get("/api/erp/reports/balance-sheet",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=r.query.asOfDate?new Date(r.query.asOfDate):new Date,o=await ce.getBalanceSheet(t,n);e.json({success:!0,balanceSheet:o})}catch(t){e.status(500).json({error:t.message||"Failed to fetch balance sheet"})}}),i.post("/api/erp/expenses",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.branchId||r.body.branchId||"default-branch",o=r.employee?.id||"system",d=await ce.createExpense({tenantId:t,branchId:n,requestedBy:o,...r.body});e.json({success:!0,expense:P(d)})}catch(t){e.status(400).json({error:t.message||"Failed to create expense"})}}),i.patch("/api/erp/expenses/:id/approve",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.id||"system",o=await ce.approveExpense(t,r.params.id,n);e.json({success:!0,expense:P(o)})}catch(t){e.status(400).json({error:t.message||"Failed to approve expense"})}}),i.get("/api/erp/vendors",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=await ce.getVendors(t);e.json({success:!0,vendors:n.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch vendors"})}}),i.post("/api/erp/vendors",w,j,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=await ce.createVendor({tenantId:t,...r.body});e.json({success:!0,vendor:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create vendor"})}}),i.get("/api/erp/dashboard",w,j,async(r,e)=>{try{let t=k(r)||r.query.tenantId||"demo-tenant",n=r.query.branchId,o=r.query.startDate?new Date(r.query.startDate):void 0,d=r.query.endDate?new Date(r.query.endDate):void 0,m=await ce.getDashboardSummary(t,n,o,d);e.json({success:!0,summary:m})}catch(t){e.status(500).json({error:t.message||"Failed to fetch dashboard summary"})}}),i.post("/api/erp/orders/:orderId/post-journal",w,Vt,async(r,e)=>{try{let t=k(r)||r.body.tenantId||"demo-tenant",n=r.employee?.id||"system",o=await ce.postOrderJournal(t,r.params.orderId,n);o?e.json({success:!0,entry:P(o)}):e.status(404).json({error:"Order not found or missing accounts"})}catch(t){e.status(400).json({error:t.message||"Failed to post order journal"})}}),i.get("/api/delivery/integrations",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await re.getAllIntegrations(t);e.json({success:!0,integrations:n.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch integrations"})}}),i.post("/api/delivery/integrations",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await re.createIntegration({...r.body,tenantId:t});e.json({success:!0,integration:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create integration"})}}),i.patch("/api/delivery/integrations/:id",w,me,async(r,e)=>{try{let t=await re.updateIntegration(r.params.id,r.body);t?e.json({success:!0,integration:P(t)}):e.status(404).json({error:"Integration not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update integration"})}}),i.delete("/api/delivery/integrations/:id",w,me,async(r,e)=>{try{let t=await re.deleteIntegration(r.params.id);e.json({success:t})}catch(t){e.status(400).json({error:t.message||"Failed to delete integration"})}}),i.get("/api/delivery/zones",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.query.branchId,o=await re.getAllZones(t,n);e.json({success:!0,zones:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch zones"})}}),i.post("/api/delivery/zones",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await re.createZone({...r.body,tenantId:t});e.json({success:!0,zone:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create zone"})}}),i.patch("/api/delivery/zones/:id",w,me,async(r,e)=>{try{let t=await re.updateZone(r.params.id,r.body);t?e.json({success:!0,zone:P(t)}):e.status(404).json({error:"Zone not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update zone"})}}),i.delete("/api/delivery/zones/:id",w,me,async(r,e)=>{try{let t=await re.deleteZone(r.params.id);e.json({success:t})}catch(t){e.status(400).json({error:t.message||"Failed to delete zone"})}}),i.get("/api/delivery/drivers",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.query.branchId,o=await re.getAllDrivers(t,n);e.json({success:!0,drivers:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch drivers"})}}),i.get("/api/delivery/drivers/available",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.query.branchId,o=await re.getAvailableDrivers(t,n);e.json({success:!0,drivers:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch available drivers"})}}),i.post("/api/delivery/drivers",w,me,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await re.createDriver({...r.body,tenantId:t});e.json({success:!0,driver:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create driver"})}}),i.patch("/api/delivery/drivers/:id",w,j,async(r,e)=>{try{let t=await re.updateDriver(r.params.id,r.body);t?e.json({success:!0,driver:P(t)}):e.status(404).json({error:"Driver not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update driver"})}}),i.patch("/api/delivery/drivers/:id/location",w,Pt,async(r,e)=>{try{let{lat:t,lng:n}=r.body,o=await re.updateDriverLocation(r.params.id,t,n);o?e.json({success:!0,driver:P(o)}):e.status(404).json({error:"Driver not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update location"})}}),i.patch("/api/delivery/drivers/:id/status",w,Pt,async(r,e)=>{try{let{status:t}=r.body,n=await re.updateDriverStatus(r.params.id,t);n?e.json({success:!0,driver:P(n)}):e.status(404).json({error:"Driver not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update status"})}}),i.delete("/api/delivery/drivers/:id",w,me,async(r,e)=>{try{let t=await re.deleteDriver(r.params.id);e.json({success:t})}catch(t){e.status(400).json({error:t.message||"Failed to delete driver"})}});let vt=new Map,Ae=5,Te=15*60*1e3;i.post("/api/delivery/drivers/login",async(r,e)=>{try{let{phone:t}=r.body,n=r.ip||r.socket.remoteAddress||"unknown";if(!t)return e.status(400).json({error:"\u0631\u0642\u0645 \u0627\u0644\u062C\u0648\u0627\u0644 \u0645\u0637\u0644\u0648\u0628"});let o=`${n}:${t}`,d=vt.get(o),m=Date.now();if(d){if(m-d.lastAttempt<Te&&d.count>=Ae)return e.status(429).json({error:"\u062A\u0645 \u062A\u062C\u0627\u0648\u0632 \u0639\u062F\u062F \u0627\u0644\u0645\u062D\u0627\u0648\u0644\u0627\u062A \u0627\u0644\u0645\u0633\u0645\u0648\u062D\u0629. \u064A\u0631\u062C\u0649 \u0627\u0644\u0627\u0646\u062A\u0638\u0627\u0631 15 \u062F\u0642\u064A\u0642\u0629."});m-d.lastAttempt>=Te&&vt.delete(o)}let l=await re.getDriverByPhone(t);if(!l){let g=vt.get(o)||{count:0,lastAttempt:m};return vt.set(o,{count:g.count+1,lastAttempt:m}),e.status(404).json({error:"\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u0639\u062B\u0648\u0631 \u0639\u0644\u0649 \u0627\u0644\u0645\u0646\u062F\u0648\u0628"})}vt.delete(o),await re.updateDriverStatus(l._id?.toString()||l.id,"available"),r.session.driverId=l._id?.toString()||l.id,e.json({success:!0,driver:P(l),message:"\u062A\u0645 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644 \u0628\u0646\u062C\u0627\u062D"})}catch(t){e.status(500).json({error:t.message||"\u0641\u0634\u0644 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"})}}),i.get("/api/delivery/orders",w,j,async(r,e)=>{try{let t=k(r)||"demo-tenant",n={branchId:r.query.branchId,status:r.query.status,driverId:r.query.driverId,fromDate:r.query.fromDate?new Date(r.query.fromDate):void 0,toDate:r.query.toDate?new Date(r.query.toDate):void 0},o=await re.getAllDeliveryOrders(t,n);e.json({success:!0,orders:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch delivery orders"})}}),i.get("/api/delivery/orders/pending",w,Pt,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=r.query.branchId,o=await re.getPendingOrdersForDriver(t,n);e.json({success:!0,orders:o.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch pending orders"})}}),i.get("/api/delivery/orders/driver/:driverId",w,Pt,async(r,e)=>{try{let t=await re.getDriverActiveOrders(r.params.driverId);e.json({success:!0,orders:t.map(P)})}catch(t){e.status(500).json({error:t.message||"Failed to fetch driver orders"})}}),i.get("/api/delivery/orders/:id",w,async(r,e)=>{try{let t=await re.getDeliveryOrder(r.params.id);t?e.json({success:!0,order:P(t)}):e.status(404).json({error:"Order not found"})}catch(t){e.status(500).json({error:t.message||"Failed to fetch order"})}}),i.get("/api/delivery/orders/by-order/:orderId",async(r,e)=>{try{let t=await re.getDeliveryOrderByOrderId(r.params.orderId);t?e.json({success:!0,order:P(t)}):e.status(404).json({error:"Delivery order not found"})}catch(t){e.status(500).json({error:t.message||"Failed to fetch delivery order"})}}),i.post("/api/delivery/orders",w,Vt,async(r,e)=>{try{let t=k(r)||"demo-tenant",n=await re.createDeliveryOrder({...r.body,tenantId:t});e.json({success:!0,order:P(n)})}catch(t){e.status(400).json({error:t.message||"Failed to create delivery order"})}}),i.patch("/api/delivery/orders/:id/assign",w,j,async(r,e)=>{try{let{driverId:t}=r.body,n=await re.assignDriverToOrder(r.params.id,t);n?e.json({success:!0,order:P(n)}):e.status(404).json({error:"Order or driver not found"})}catch(t){e.status(400).json({error:t.message||"Failed to assign driver"})}}),i.patch("/api/delivery/orders/:id/status",w,Pt,async(r,e)=>{try{let{status:t,...n}=r.body,o=await re.updateOrderStatus(r.params.id,t,n);o?e.json({success:!0,order:P(o)}):e.status(404).json({error:"Order not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update order status"})}}),i.patch("/api/delivery/orders/:id/location",w,Pt,async(r,e)=>{try{let{lat:t,lng:n}=r.body,o=await re.updateOrderDriverLocation(r.params.id,t,n);o?e.json({success:!0,order:P(o)}):e.status(404).json({error:"Order not found"})}catch(t){e.status(400).json({error:t.message||"Failed to update order location"})}}),i.post("/api/delivery/calculate-fee",async(r,e)=>{try{let{lat:t,lng:n,tenantId:o,branchId:d,orderAmount:m}=r.body,l=await re.calculateDeliveryFee(t,n,o||"demo-tenant",d,m||0);e.json({success:!0,...l,zone:l.zone?P(l.zone):null})}catch(t){e.status(400).json({error:t.message||"Failed to calculate delivery fee"})}}),i.post("/api/delivery/calculate-eta",async(r,e)=>{try{let{distanceKm:t,drinkCount:n}=r.body,o=re.calculateETA(t||0,n||1);e.json({success:!0,...o})}catch(t){e.status(400).json({error:t.message||"Failed to calculate ETA"})}});let Nn=Gs(i);return ye.setup(Nn),Nn}import ii from"express";import ga from"fs";import Hr from"path";import{fileURLToPath as ci}from"url";import{createServer as di,createLogger as ui}from"vite";import{defineConfig as ri}from"vite";import ni from"@vitejs/plugin-react";import Zt from"path";import{fileURLToPath as ai}from"url";import oi from"@replit/vite-plugin-runtime-error-modal";var si=ai(import.meta.url),yr=Zt.dirname(si),pa=ri({plugins:[ni(),oi(),...process.env.NODE_ENV!=="production"&&process.env.REPL_ID!==void 0?[await import("@replit/vite-plugin-cartographer").then(i=>i.cartographer())]:[]],resolve:{alias:{"@":Zt.resolve(yr,"client","src"),"@shared":Zt.resolve(yr,"shared"),"@assets":Zt.resolve(yr,"attached_assets")}},root:Zt.resolve(yr,"client"),build:{outDir:Zt.resolve(yr,"dist/public"),emptyOutDir:!0,chunkSizeWarningLimit:1e3,minify:process.env.NODE_ENV==="production"?"esbuild":!1,target:"es2020",cssMinify:process.env.NODE_ENV==="production",rollupOptions:{output:{manualChunks:{"vendor-react":["react","react-dom"],"vendor-ui":["@radix-ui/react-dialog","@radix-ui/react-dropdown-menu","@radix-ui/react-tabs","@radix-ui/react-select"],"vendor-query":["@tanstack/react-query"],"vendor-utils":["date-fns","clsx","tailwind-merge"]}}}},server:{allowedHosts:!0,fs:{strict:!0,deny:["**/.*"]}},optimizeDeps:{include:["react","react-dom","@tanstack/react-query","wouter","lucide-react"]}});import{nanoid as li}from"nanoid";var mi=ci(import.meta.url),fa=Hr.dirname(mi),ya=ui();function xn(i,a="express"){let s=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${s} [${a}] ${i}`)}async function ba(i,a){let s={middlewareMode:!0,hmr:{protocol:"ws",host:void 0,port:void 0},allowedHosts:!0},u=await di({...pa,configFile:!1,customLogger:{...ya,error:(p,y)=>{ya.error(p,y),process.exit(1)}},server:s,appType:"custom"});i.use(u.middlewares),i.use("*",async(p,y,h)=>{let v=p.originalUrl;try{let D=Hr.resolve(fa,"..","client","index.html"),O=await ga.promises.readFile(D,"utf-8");O=O.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${li()}"`);let M=await u.transformIndexHtml(v,O);y.status(200).set({"Content-Type":"text/html","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}).end(M)}catch(D){u.ssrFixStacktrace(D),h(D)}})}function ha(i){let a=Hr.resolve(fa,"public");if(!ga.existsSync(a))throw new Error(`Could not find the build directory: ${a}, make sure to build the client first`);let s=60*60*24*365;i.use(ii.static(a,{setHeaders:(u,p)=>{let y=p.replace(/\\/g,"/");if(y.endsWith(".html")){u.setHeader("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),u.setHeader("Pragma","no-cache"),u.setHeader("Expires","0");return}if(y.includes("/assets/")){u.setHeader("Cache-Control",`public, max-age=${s}, immutable`);return}u.setHeader("Cache-Control","public, max-age=0, must-revalidate")}})),i.use("*",(u,p)=>{p.set({"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0","Surrogate-Control":"no-store"}),p.sendFile(Hr.resolve(a,"index.html"))})}var gi=yi(import.meta.url),fi=va.dirname(gi),bi=pi(wa),Aa=process.env.MONGODB_URI;Aa||(console.error("\u274C ERROR: MONGODB_URI environment variable is not set"),process.exit(1));var Nt=!1,Zr=!1,gr=0,hi=5;async function Yr(){if(Zr)return;Zr=!0;let i={serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,heartbeatFrequencyMS:1e4};try{console.log(`\u{1F50C} Attempting MongoDB connection (Attempt ${gr+1})...`),await Wt.connect(Aa,i),Nt=!0,gr=0,console.log("\u2705 MongoDB connected successfully")}catch(a){if(Nt=!1,console.error("\u274C MongoDB connection error:",a),gr<hi){gr++;let s=Math.min(1e3*Math.pow(2,gr),3e4);console.log(`\u{1F504} Retrying in ${s/1e3}s...`),setTimeout(()=>{Zr=!1,Yr()},s)}else console.error("\u274C Max retries reached. Database functionality will be unavailable.")}finally{Zr=!1}}Wt.connection.on("disconnected",()=>{console.log("\u{1F4E1} MongoDB disconnected. Attempting to reconnect..."),Nt=!1,Yr()});Wt.connection.on("error",i=>{console.error("\u{1F4E1} MongoDB error:",i),Nt=!1});Yr();var jn=!1;setInterval(async()=>{if(!(jn||!Nt)){jn=!0;try{let{TableModel:i,CustomerModel:a}=await Promise.resolve().then(()=>(T(),R)),{sendReservationExpiryWarningEmail:s}=await Promise.resolve().then(()=>(He(),et)),u=new Date,p=new Date(u.getTime()+15*6e4),y=await i.find({"reservedFor.status":{$in:["pending","confirmed"]},"reservedFor.autoExpiryTime":{$lt:u}}),h=0;for(let D of y)D.reservedFor&&(D.reservedFor.status="expired",await D.save(),h++);h>0&&console.log(`\u{1F504} Cleaned ${h} expired reservations`);let v=await i.find({"reservedFor.status":{$in:["pending","confirmed"]},"reservedFor.autoExpiryTime":{$gte:u,$lte:p},"reservedFor.emailNotificationSent":{$ne:!0}});for(let D of v)if(D.reservedFor&&D.reservedFor.autoExpiryTime)try{let O=await a.findOne({phone:D.reservedFor.customerPhone});O&&O.email&&await s(O.email,D.reservedFor.customerName,D.tableNumber,D.reservedFor.autoExpiryTime.toString())&&(D.reservedFor.emailNotificationSent=!0,await D.save(),console.log(`\u{1F4E7} Expiry warning sent to ${O.email}`))}catch(O){console.error(`Failed to send expiry warning for table ${D.tableNumber}:`,O)}}catch(i){console.error("Maintenance task error:",i)}finally{jn=!1}}},6e4);var xe=Wr();xe.use(Ia({level:6,threshold:1024,filter:(i,a)=>i.headers["x-no-compression"]?!1:Ia.filter(i,a)}));xe.use(Wr.json({limit:"50mb"}));xe.use(Wr.urlencoded({extended:!1,limit:"50mb"}));xe.set("trust proxy",1);xe.use((i,a,s)=>{a.header("Access-Control-Allow-Origin","*"),a.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS"),a.header("Access-Control-Allow-Headers","Content-Type, Authorization, Content-Length, X-Requested-With"),s()});xe.disable("x-powered-by");xe.use(wa({secret:process.env.SESSION_SECRET||"dev-secret",resave:!1,saveUninitialized:!1,name:"cluny.sid",store:new bi({checkPeriod:864e5}),cookie:{secure:process.env.NODE_ENV==="production",httpOnly:!0,maxAge:7*24*60*60*1e3,sameSite:process.env.NODE_ENV==="production"?"none":"lax",path:"/"}}));xe.use((i,a,s)=>{(i.path.startsWith("/api/orders")||i.path.startsWith("/api/employees/login"))&&(console.log("  - Session ID:",i.sessionID),console.log("  - Employee:",i.session?.employee?"EXISTS":"MISSING"),console.log("  - Cookie:",i.headers.cookie?"PRESENT":"MISSING")),s()});xe.get("/healthz",(i,a)=>{a.status(200).send("OK")});xe.get("/health",(i,a)=>{a.status(200).json({status:"ok",timestamp:new Date().toISOString(),database:Nt?"connected":"disconnected",readyState:Wt.connection.readyState})});xe.use("/api",(i,a,s)=>{if(!Nt&&Wt.connection.readyState!==1)return console.error(`\u{1F6A8} API Request failed: Database not connected (State: ${Wt.connection.readyState})`),Yr(),a.status(503).json({message:"\u062E\u062F\u0645\u0629 \u0642\u0627\u0639\u062F\u0629 \u0627\u0644\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0645\u062A\u0648\u0641\u0631\u0629 \u062D\u0627\u0644\u064A\u0627\u064B\u060C \u064A\u0631\u062C\u0649 \u0627\u0644\u0645\u062D\u0627\u0648\u0644\u0629 \u0645\u0631\u0629 \u0623\u062E\u0631\u0649 \u062E\u0644\u0627\u0644 \u062B\u0648\u0627\u0646\u064D.",retryAfter:5});s()});xe.use((i,a,s)=>{if(i.path.startsWith("/api")||i.path.startsWith("/attached_assets")||i.path==="/healthz"||i.path==="/health")return s();s()});xe.use("/attached_assets",Wr.static(va.resolve(fi,"..","attached_assets"),{setHeaders:(i,a)=>{i.set("Cache-Control","public, max-age=3600"),a.endsWith(".png")&&i.set("Content-Type","image/png"),(a.endsWith(".jpg")||a.endsWith(".jpeg"))&&i.set("Content-Type","image/jpeg")}}));xe.use((i,a,s)=>{let u=Date.now(),p=i.path,y,h=a.json;a.json=function(v,...D){return y=v,h.apply(a,[v,...D])},a.on("finish",()=>{let v=Date.now()-u;if(p.startsWith("/api")){let D=`${i.method} ${p} ${a.statusCode} in ${v}ms`;y&&(D+=` :: ${JSON.stringify(y)}`),D.length>80&&(D=D.slice(0,79)+"\u2026"),xn(D)}}),s()});(async()=>{let i=await ma(xe);xe.use((s,u,p,y)=>{let h=s.status||s.statusCode||500,v=s.message||"Internal Server Error";console.error("Error:",s),p.status(h).json({message:v})}),xe.get("env")==="development"?await ba(xe,i):ha(xe);let a=Number(process.env.PORT)||5e3;i.listen(a,"0.0.0.0",async()=>{xn(`serving on port ${a}`);try{let{testEmailConnection:s}=await Promise.resolve().then(()=>(He(),et));console.log("\u{1F4E7} Performing startup email connection test..."),await s()?console.log("\u2705 Mail service verified and ready on startup"):console.error("\u274C Mail service failed verification on startup. Check credentials and connectivity.")}catch(s){console.error("\u274C Error during mail service startup test:",s)}})})();
