import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as m}from"./vendor-react-Bzsngnqy.js";import{c as B,e as H,B as l,ab as L,ac as J,ad as S,aj as C,C as u,x as E,y as I,f as h,o as z,U as q,L as R,j as i,r as A,O as U,N as x}from"./index-61RjstaY.js";import{a as O,b as T}from"./vendor-query-CX8ZYlKb.js";import{S as X,a as D,b as G,c as W,d as p}from"./select-BgcBxbEj.js";import{p as b,V as Y,a as Z}from"./notification-sounds-BWhnKTrD.js";import{C as f}from"./circle-check-big-v7jPXABl.js";import{C as F}from"./circle-x-D9GYVDcC.js";import{C as ee}from"./chef-hat-D6Gkp1MI.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-BsuQiE4E.js";function ue(){const[,j]=B(),[r,P]=m.useState(null),[c,_]=m.useState(!0),y=m.useRef(new Set),{toast:n}=H();m.useEffect(()=>{const s=localStorage.getItem("currentEmployee");if(s){const t=JSON.parse(s);P(t)}else j("/employee/gateway")},[j]);const{data:d}=O({queryKey:["/api/orders/table/unassigned"],refetchInterval:3e3,enabled:!!r});m.useEffect(()=>{if(d&&d.length>0){const s=new Set(d.map(a=>a.id)),t=[...s].filter(a=>!y.current.has(a));t.length>0&&y.current.size>0&&(c&&b("newOrder",.6),n({title:"طلب جديد من الطاولة",description:`لديك ${t.length} ${t.length===1?"طلب جديد":"طلبات جديدة"}`,duration:6e3,className:"bg-green-600 text-white border-green-700"})),y.current=s}},[d,n]);const{data:K=[]}=O({queryKey:["/api/branches"],queryFn:async()=>{const s=await fetch("/api/branches");if(!s.ok)throw new Error("Failed to fetch branches");return s.json()}}),{data:M}=O({queryKey:["/api/cashier",r?.id,"orders"],enabled:!!r?.id,queryFn:async()=>{const s=await fetch(`/api/cashier/${r?.id}/orders`);if(!s.ok)throw new Error("Failed to fetch orders");return s.json()},refetchInterval:3e3}),N=T({mutationFn:async s=>{if(!r?.id)throw new Error("معرف الكاشير غير متاح. يرجى تسجيل الدخول مجدداً");const t=await fetch(`/api/orders/${s}/assign-cashier`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({cashierId:r.id})});if(!t.ok){const a=await t.json();throw new Error(a.error)}return t.json()},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/orders/table/unassigned"]}),x.invalidateQueries({queryKey:["/api/cashier",r?.id,"orders"]}),c&&b("success",.5),n({title:"تم استلام الطلب",description:"تم استلام الطلب بنجاح"})},onError:s=>{n({title:"خطأ",description:s.message,variant:"destructive"})}}),o=T({mutationFn:async s=>{const t=await fetch(`/api/orders/${s}/table-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({tableStatus:"cancelled"})});if(!t.ok)throw new Error("Failed to reject order");return t.json()},onSuccess:()=>{x.invalidateQueries({queryKey:["/api/orders/table/unassigned"]}),x.invalidateQueries({queryKey:["/api/cashier",r?.id,"orders"]}),n({title:"تم رفض الطلب",description:"تم إلغاء الطلب بنجاح"})},onError:s=>{n({title:"خطأ",description:s.message||"فشل رفض الطلب",variant:"destructive"})}}),Q=T({mutationFn:async({orderId:s,status:t})=>{if(!r?.id)throw new Error("معرف الكاشير غير متاح. يرجى تسجيل الدخول مجدداً");const a=await fetch(`/api/orders/${s}/table-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({tableStatus:t})});if(!a.ok)throw new Error("Failed to update status");return a.json()},onSuccess:(s,t)=>{x.invalidateQueries({queryKey:["/api/cashier",r?.id,"orders"]}),c&&(t.status==="delivered"?b("success",.5):b("statusChange",.4)),n({title:"تم تحديث حالة الطلب",description:V(t.status)})},onError:()=>{n({title:"خطأ",description:"فشل تحديث حالة الطلب",variant:"destructive"})}}),V=s=>{switch(s){case"payment_confirmed":return"تم تأكيد الدفع";case"preparing":return"الطلب قيد التحضير";case"ready":return"الطلب جاهز للتقديم";case"delivered":return"تم تقديم الطلب للعميل";case"cancelled":return"تم إلغاء الطلب";default:return"تم تحديث الحالة"}},$=s=>{switch(s){case"pending":return e.jsx(i,{className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"طلب جديد"});case"payment_confirmed":return e.jsx(i,{className:"bg-green-500 hover:bg-green-600 text-white",children:"تم الدفع"});case"preparing":return e.jsx(i,{className:"bg-blue-500 hover:bg-blue-600 text-white",children:"قيد التحضير"});case"ready":return e.jsx(i,{className:"bg-purple-500 hover:bg-purple-600 text-white",children:"جاهز للتقديم"});case"delivering_to_table":return e.jsx(i,{className:"bg-purple-500 hover:bg-purple-600 text-white",children:"جاري التوصيل"});case"delivered":return e.jsx(i,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تم التقديم"});case"cancelled":return e.jsx(i,{className:"bg-red-600 hover:bg-red-700 text-white",children:"ملغي"});default:return e.jsx(i,{variant:"secondary",children:"غير معروف"})}},k=s=>{switch(s){case"pending":return A;case"payment_confirmed":return f;case"preparing":return ee;case"ready":return f;case"delivering_to_table":return U;case"delivered":return f;case"cancelled":return F;default:return A}},v=d||[],w=M||[];return e.jsx("div",{className:"min-h-screen p-4 bg-[#e3e1c5] text-[#111112]",dir:"rtl",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-accent",children:"إدارة طلبات الطاولات"}),e.jsxs("p",{className:"text-gray-400",children:["مرحباً ",r?.fullName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{variant:"outline",size:"icon",onClick:()=>_(!c),className:c?"border-green-500 text-green-500":"border-muted text-muted-foreground","data-testid":"button-toggle-sound","aria-label":c?"كتم الصوت":"تفعيل الصوت",children:c?e.jsx(Y,{className:"h-4 w-4"}):e.jsx(Z,{className:"h-4 w-4"})}),e.jsx(l,{variant:"outline",className:"bg-[#944219]",onClick:()=>j("/employee/dashboard"),children:"العودة للوحة التحكم"})]})]}),e.jsxs(L,{defaultValue:"pending",className:"space-y-4",children:[e.jsxs(J,{className:"grid w-full grid-cols-3",children:[e.jsxs(S,{value:"pending",children:["طلبات جديدة (",v.length,")"]}),e.jsxs(S,{value:"my-orders",children:["طلباتي (",w.filter(s=>s.tableStatus!=="delivered"&&s.tableStatus!=="cancelled").length,")"]}),e.jsx(S,{value:"tables",children:"إدارة الطاولات"})]}),e.jsx(C,{value:"pending",children:e.jsxs(u,{className:"border-primary/20 bg-[#54513f]",children:[e.jsx(E,{children:e.jsx(I,{className:"text-accent text-right",children:"الطلبات الجديدة"})}),e.jsx(h,{children:v.length===0?e.jsx("div",{className:"text-center py-8 text-gray-400",children:"لا توجد طلبات جديدة"}):e.jsx("div",{className:"space-y-4",children:v.map(s=>{const t=k(s.tableStatus),a=K.find(g=>g.id===s.branchId);return e.jsx(u,{className:"bg-[#1a1410] border-primary/10",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[a&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(z,{className:"w-4 h-4 text-accent"}),e.jsx("span",{className:"text-xs bg-gradient-to-r from-amber-600 to-amber-700 text-white px-2 py-1 rounded",children:a.nameAr})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"w-5 h-5"}),e.jsxs("h3",{className:"font-bold text-lg",children:["طاولة ",s.tableNumber]}),$(s.tableStatus)]}),s.customerInfo&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:s.customerInfo.customerName||s.customerInfo.name})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"العناصر:"})," ",Array.isArray(s.items)?s.items.map(g=>`${g.nameAr} (${g.quantity})`).join(", "):"لا توجد عناصر"]}),e.jsxs("div",{className:"font-bold text-lg",children:[s.totalAmount.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(l,{onClick:()=>N.mutate(s.id),disabled:N.isPending||o.isPending,className:"bg-green-600 hover:bg-green-700","data-testid":`button-accept-${s.id}`,children:[e.jsx(f,{className:"w-4 h-4 ml-1"}),"قبول"]}),e.jsxs(l,{variant:"destructive",onClick:()=>{confirm(`هل أنت متأكد من رفض طلب الطاولة ${s.tableNumber}؟`)&&o.mutate(s.id)},disabled:N.isPending||o.isPending,"data-testid":`button-reject-${s.id}`,children:[e.jsx(F,{className:"w-4 h-4 ml-1"}),"رفض"]})]})]})})},s.id)})})})]})}),e.jsx(C,{value:"my-orders",children:e.jsxs(u,{className:"border-primary/20 bg-[#54513f]",children:[e.jsx(E,{children:e.jsx(I,{className:"text-accent text-right",children:"طلباتي"})}),e.jsx(h,{children:w.length===0?e.jsx("div",{className:"text-center py-8 text-gray-400",children:"لا توجد طلبات مستلمة"}):e.jsx("div",{className:"space-y-4",children:w.map(s=>{const t=k(s.tableStatus);return e.jsx(u,{className:"bg-[#1a1410] border-primary/10",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-wrap items-center justify-between gap-4",children:e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"w-5 h-5"}),e.jsxs("h3",{className:"font-bold text-lg",children:["طاولة ",s.tableNumber]}),$(s.tableStatus)]}),s.customerInfo&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:s.customerInfo.customerName||s.customerInfo.name})]}),e.jsxs("div",{className:"text-sm text-white",children:[e.jsx("span",{className:"font-medium",children:"العناصر:"})," ",Array.isArray(s.items)?s.items.map(a=>`${a.nameAr} (${a.quantity})`).join(", "):"لا توجد عناصر"]}),e.jsxs("div",{className:"font-bold text-lg text-accent",children:[s.totalAmount.toFixed(2)," ر.س"]})]})}),s.tableStatus!=="delivered"&&s.tableStatus!=="cancelled"&&e.jsxs("div",{className:"border-t border-primary/20 pt-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx(R,{className:"text-accent text-sm mb-2 block",children:"تحديث حالة الطلب:"}),e.jsxs(X,{value:s.tableStatus,onValueChange:a=>Q.mutate({orderId:s.id,status:a}),children:[e.jsx(D,{"data-testid":`select-status-${s.id}`,children:e.jsx(G,{})}),e.jsxs(W,{children:[e.jsx(p,{value:"payment_confirmed",children:"تم تأكيد الدفع"}),e.jsx(p,{value:"preparing",children:"قيد التحضير"}),e.jsx(p,{value:"ready",children:"جاهز للتقديم"}),e.jsx(p,{value:"delivered",children:"تم التقديم"}),e.jsx(p,{value:"cancelled",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(l,{variant:"destructive",size:"sm",onClick:()=>{confirm(`هل أنت متأكد من رفض طلب الطاولة ${s.tableNumber}؟`)&&o.mutate(s.id)},disabled:o.isPending,"data-testid":`button-reject-order-${s.id}`,children:"رفض الطلب"})})]})]})})},s.id)})})})]})}),e.jsx(C,{value:"tables",children:e.jsxs(u,{className:"border-primary/20 bg-[#54513f]",children:[e.jsx(E,{children:e.jsx(I,{className:"text-accent text-right",children:"إدارة الطاولات"})}),e.jsx(h,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-400 mb-4",children:"لإدارة الطاولات، يرجى الذهاب إلى لوحة تحكم المدير"}),e.jsx(l,{onClick:()=>j("/manager/tables"),children:"الذهاب إلى إدارة الطاولات"})]})})]})})]})]})})}export{ue as default};
