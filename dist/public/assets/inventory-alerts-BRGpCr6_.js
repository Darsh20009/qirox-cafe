import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as j}from"./vendor-react-Bzsngnqy.js";import{a as $,b as N}from"./vendor-query-CX8ZYlKb.js";import{e as X,N as o,q as Y,B as b,C as x,x as m,y as p,T as q,f as h,r as H,j as w,v as T}from"./index-61RjstaY.js";import{S as k,a as C,b as S,c as R,d as c}from"./select-BgcBxbEj.js";import{T as Z,a as ee,b as Q,c as l,d as se,e as a}from"./table-B7L5kFC6.js";import{B as _}from"./bell-m_o6DJ54.js";import{R as te}from"./refresh-cw-DWvJTizr.js";import{T as M}from"./trending-down-3gb6g0y8.js";import{E as ae}from"./eye-A6WRE6cq.js";import{C as K}from"./circle-check-big-v7jPXABl.js";import{f as re}from"./vendor-utils-BKCsaWdX.js";import{a as le}from"./ar-CeWsqWSX.js";import"./chevron-down-BsuQiE4E.js";const A={low_stock:{label:"مخزون منخفض",icon:M,color:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"},out_of_stock:{label:"نفاد المخزون",icon:q,color:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"},expiring_soon:{label:"قارب على الانتهاء",icon:H,color:"bg-accent text-accent dark:bg-accent dark:text-accent"},expired:{label:"منتهي الصلاحية",icon:q,color:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}},ie={kg:"كيلوجرام",g:"جرام",liter:"لتر",ml:"ملليلتر",piece:"قطعة",box:"صندوق",bag:"كيس"};function Ne(){const{toast:n}=X(),[f,O]=j.useState("all"),[g,U]=j.useState("all"),[y,V]=j.useState("unresolved");j.useEffect(()=>{const s=window.location.protocol==="https:"?"wss:":"ws:",t=window.location.host,i=`${s}//${t}/ws/orders`,r=new WebSocket(i);return r.onopen=()=>{r.send(JSON.stringify({type:"subscribe",clientType:"inventory"}))},r.onmessage=G=>{try{const u=JSON.parse(G.data);(u.type==="stock_alert"||u.type==="alert_resolved")&&(o.invalidateQueries({queryKey:["/api/inventory/alerts"]}),u.type==="stock_alert"&&n({title:"تنبيه مخزون جديد",description:"تم استلام تنبيه مخزون جديد"}))}catch{}},()=>{r.readyState===WebSocket.OPEN&&r.close()}},[n]);const{data:d=[],isLoading:D}=$({queryKey:["/api/inventory/alerts"]}),{data:B=[]}=$({queryKey:["/api/branches"]}),E=N({mutationFn:s=>T("PUT",`/api/inventory/alerts/${s}/resolve`),onSuccess:()=>{o.invalidateQueries({queryKey:["/api/inventory/alerts"]}),n({title:"تم حل التنبيه بنجاح"})},onError:s=>{n({title:s.message||"فشل في حل التنبيه",variant:"destructive"})}});N({mutationFn:s=>T("PUT",`/api/inventory/alerts/${s}/read`),onSuccess:()=>{o.invalidateQueries({queryKey:["/api/inventory/alerts"]})},onError:s=>{n({title:s.message||"فشل في تحديث التنبيه",variant:"destructive"})}});const L=s=>B.find(t=>t.id===s)?.nameAr||s,v=d.filter(s=>{const t=f==="all"||s.branchId===f,i=g==="all"||s.alertType===g;let r=!0;return y==="unresolved"?r=s.isResolved===0:y==="resolved"&&(r=s.isResolved===1),t&&i&&r});d.filter(s=>s.isResolved===0).length;const F=d.filter(s=>s.isRead===0&&s.isResolved===0).length,z=d.filter(s=>s.alertType==="low_stock"&&s.isResolved===0).length,J=d.filter(s=>s.alertType==="out_of_stock"&&s.isResolved===0).length,W=d.filter(s=>(s.alertType==="expiring_soon"||s.alertType==="expired")&&s.isResolved===0).length,I=N({mutationFn:()=>Promise.all(v.filter(s=>s.isRead===0).map(s=>T("PUT",`/api/inventory/alerts/${s.id}/read`))),onSuccess:()=>{o.invalidateQueries({queryKey:["/api/inventory/alerts"]}),n({title:"تم تحديد جميع التنبيهات كمقروءة"})},onError:s=>{n({title:"فشل في تحديد التنبيهات كمقروءة",description:s.message||"حدث خطأ أثناء تحديث التنبيهات",variant:"destructive"})}}),P=(s,t)=>{const i=t-s;return i>0?i:0};return D?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(Y,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"تنبيهات المخزون"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"متابعة تنبيهات نفاد وانخفاض المخزون"})]})]}),e.jsxs(b,{variant:"outline",onClick:()=>o.invalidateQueries({queryKey:["/api/inventory/alerts"]}),"data-testid":"button-refresh",children:[e.jsx(te,{className:"h-4 w-4 ml-2"}),"تحديث"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(x,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"نفاد المخزون"}),e.jsx(q,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:J}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"تنبيه عاجل"})]})]}),e.jsxs(x,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"مخزون منخفض"}),e.jsx(M,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:z}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يحتاج إعادة طلب"})]})]}),e.jsxs(x,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"صلاحية منتهية"}),e.jsx(H,{className:"h-4 w-4 text-accent"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold text-accent",children:W}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"تنبيه صلاحية"})]})]}),e.jsxs(x,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between gap-2 space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"غير مقروءة"}),e.jsx(_,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold",children:F}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"تنبيه جديد"})]})]})]}),e.jsxs(x,{children:[e.jsx(m,{children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs(k,{value:f,onValueChange:O,children:[e.jsx(C,{className:"w-[180px]","data-testid":"select-branch-filter",children:e.jsx(S,{placeholder:"الفرع"})}),e.jsxs(R,{children:[e.jsx(c,{value:"all",children:"جميع الفروع"}),B.map(s=>e.jsx(c,{value:s.id,children:s.nameAr},s.id))]})]}),e.jsxs(k,{value:g,onValueChange:U,children:[e.jsx(C,{className:"w-[180px]","data-testid":"select-type-filter",children:e.jsx(S,{placeholder:"نوع التنبيه"})}),e.jsxs(R,{children:[e.jsx(c,{value:"all",children:"جميع الأنواع"}),Object.entries(A).map(([s,{label:t}])=>e.jsx(c,{value:s,children:t},s))]})]}),e.jsxs(k,{value:y,onValueChange:V,children:[e.jsx(C,{className:"w-[180px]","data-testid":"select-status-filter",children:e.jsx(S,{placeholder:"الحالة"})}),e.jsxs(R,{children:[e.jsx(c,{value:"all",children:"جميع الحالات"}),e.jsx(c,{value:"unresolved",children:"غير محلولة"}),e.jsx(c,{value:"resolved",children:"محلولة"})]})]}),F>0&&e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>I.mutate(),disabled:I.isPending,"data-testid":"button-mark-all-read",children:[e.jsx(ae,{className:"h-4 w-4 ml-2"}),"تحديد الكل كمقروء"]})]})}),e.jsx(h,{children:e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(Q,{className:"bg-muted/50",children:[e.jsx(l,{className:"text-right",children:"النوع"}),e.jsx(l,{className:"text-right",children:"المادة"}),e.jsx(l,{className:"text-right",children:"الفرع"}),e.jsx(l,{className:"text-right",children:"الكمية الحالية"}),e.jsx(l,{className:"text-right",children:"الحد الأدنى"}),e.jsx(l,{className:"text-right",children:"النقص"}),e.jsx(l,{className:"text-right",children:"التاريخ"}),e.jsx(l,{className:"text-right",children:"الحالة"}),e.jsx(l,{className:"text-right",children:"الإجراءات"})]})}),e.jsx(se,{children:v.length===0?e.jsx(Q,{children:e.jsxs(a,{colSpan:9,className:"text-center py-8 text-muted-foreground",children:[e.jsx(_,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"لا توجد تنبيهات"})]})}):v.map(s=>{const t=A[s.alertType]||A.low_stock,i=t.icon;return e.jsxs(Q,{className:s.isRead===0?"bg-muted/30":"","data-testid":`row-alert-${s.id}`,children:[e.jsx(a,{children:e.jsxs(w,{className:`${t.color} flex items-center gap-1 w-fit`,children:[e.jsx(i,{className:"h-3 w-3"}),t.label]})}),e.jsx(a,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.rawItem?.nameAr}),e.jsx("div",{className:"text-sm text-muted-foreground font-mono",children:s.rawItem?.code})]})}),e.jsx(a,{children:s.branch?.nameAr||L(s.branchId)}),e.jsxs(a,{children:[e.jsx("span",{className:"font-medium",children:s.currentQuantity}),e.jsx("span",{className:"text-muted-foreground mr-1",children:ie[s.rawItem?.unit||""]||s.rawItem?.unit})]}),e.jsx(a,{children:s.thresholdQuantity}),e.jsx(a,{children:P(s.currentQuantity,s.thresholdQuantity)>0?e.jsxs("span",{className:"text-red-600 font-medium",children:["-",P(s.currentQuantity,s.thresholdQuantity)]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(a,{className:"text-muted-foreground",children:re(new Date(s.createdAt),"dd/MM/yyyy HH:mm",{locale:le})}),e.jsx(a,{children:s.isResolved===1?e.jsxs(w,{variant:"default",className:"flex items-center gap-1 w-fit",children:[e.jsx(K,{className:"h-3 w-3"}),"محلول"]}):e.jsx(w,{variant:"secondary",children:"قيد الانتظار"})}),e.jsx(a,{children:s.isResolved===0&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>E.mutate(s.id),disabled:E.isPending,"data-testid":`button-resolve-${s.id}`,children:[e.jsx(K,{className:"h-4 w-4 ml-1"}),"حل"]})})})]},s.id)})})]})})})]})]})}export{Ne as default};
