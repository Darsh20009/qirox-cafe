import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as l}from"./vendor-react-Bzsngnqy.js";import{al as ze,Q as Fe,B as n,am as Oe,an as Ue,c as _e,t as Me,w as qe,a4 as ue,g as $e,af as we,i as Y,j as v,v as y,U as Be,ao as Ve,D as J,E as H,F as K,H as W,J as G,L as u,I as k,K as X,C as je,a1 as Qe,V as Ye,$ as Je}from"./index-61RjstaY.js";import{a as Ne}from"./vendor-query-CX8ZYlKb.js";import{J as He}from"./JsBarcode-71-VwQ93.js";import{P as Ke}from"./palette-C7Jo7bUI.js";import{A as We}from"./award-DlCxYbR1.js";import"./vendor-utils-BKCsaWdX.js";function Ge({cards:i,activeCard:a,onSelectCard:w}){const[j,m]=l.useState(0);if(i.length<=1)return null;const d=i.findIndex(c=>c.id===a.id),Z=(d+1)%i.length,T=(d-1+i.length)%i.length,ee={enter:c=>({x:c>0?1e3:-1e3,opacity:0}),center:{zIndex:1,x:0,opacity:1},exit:c=>({zIndex:0,x:c<0?1e3:-1e3,opacity:0})},o=(c=>{const h={classic:{bg:"from-amber-600 to-amber-700",text:"text-amber-100",label:"كلاسيكي"},modern:{bg:"from-blue-600 to-blue-700",text:"text-blue-100",label:"عصري"},dark:{bg:"from-slate-700 to-slate-800",text:"text-slate-100",label:"داكن"},gold:{bg:"from-yellow-500 to-yellow-600",text:"text-yellow-100",label:"ذهبي"}};return h[c||"classic"]||h.classic})(a.cardDesign);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-bold text-amber-100",children:"بطاقاتك"}),e.jsxs("span",{className:"text-sm text-amber-400/70",children:[d+1," من ",i.length]})]}),e.jsxs("div",{className:"relative h-64 md:h-72",children:[e.jsx(ze,{initial:!1,custom:j,mode:"wait",children:e.jsx(Fe.div,{custom:j,variants:ee,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},className:"absolute inset-0",children:e.jsxs("div",{className:`w-full h-full bg-gradient-to-br ${o.bg} rounded-3xl p-6 text-white shadow-2xl border border-white/10 flex flex-col justify-between overflow-hidden relative`,children:[e.jsxs("div",{className:"absolute inset-0 opacity-10",children:[e.jsx("div",{className:"absolute -top-20 -right-20 w-40 h-40 rounded-full bg-white"}),e.jsx("div",{className:"absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-white"})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h4",{className:"text-2xl font-black mb-2",children:"CLUNY CAFE"}),e.jsx("p",{className:"text-sm opacity-90",children:o.label})]}),e.jsxs("div",{className:"relative z-10 space-y-2",children:[e.jsx("p",{className:"text-sm opacity-75",children:"رقم البطاقة"}),e.jsx("p",{className:"font-mono text-lg tracking-wider font-bold",children:a.cardNumber.replace(/(.{4})/g,"$1 ").trim()}),e.jsx("p",{className:"text-xs opacity-60 mt-4",children:a.customerName||"عميل مميز"})]}),e.jsxs("div",{className:"relative z-10 grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{className:"bg-white/10 rounded-lg p-2 backdrop-blur",children:[e.jsx("p",{className:"text-xs opacity-70",children:"اختام"}),e.jsx("p",{className:"font-bold text-lg",children:a.stamps%6})]}),e.jsxs("div",{className:"bg-white/10 rounded-lg p-2 backdrop-blur",children:[e.jsx("p",{className:"text-xs opacity-70",children:"مجاني"}),e.jsx("p",{className:"font-bold text-lg",children:Math.max(0,a.freeCupsEarned-a.freeCupsRedeemed)})]}),e.jsxs("div",{className:"bg-white/10 rounded-lg p-2 backdrop-blur",children:[e.jsx("p",{className:"text-xs opacity-70",children:"نقاط"}),e.jsx("p",{className:"font-bold text-lg",children:a.points})]})]})]})},String(a.id))}),i.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(n,{size:"icon",variant:"ghost",className:"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-12 z-20",onClick:()=>{m(-1),w(i[T])},children:e.jsx(Oe,{className:"w-5 h-5 text-amber-400"})}),e.jsx(n,{size:"icon",variant:"ghost",className:"absolute right-0 top-1/2 -translate-y-1/2 translate-x-12 z-20",onClick:()=>{m(1),w(i[Z])},children:e.jsx(Ue,{className:"w-5 h-5 text-amber-400"})})]})]}),i.length>1&&e.jsx("div",{className:"flex gap-2 justify-center",children:i.map((c,h)=>e.jsx("button",{onClick:()=>{m(h>d?1:-1),w(c)},className:`h-2 rounded-full transition-all ${c.id===a.id?"bg-amber-500 w-8":"bg-white/20 w-2 hover:bg-white/30"}`,"aria-label":`بطاقة ${h+1}`},String(c.id)))})]})}function ct(){const[,i]=_e(),{customer:a,logout:w,isAuthenticated:j}=Me(),m=l.useRef(null),d=l.useRef(null),[Z,T]=l.useState(""),[ee,te]=l.useState(null);l.useEffect(()=>{j||i("/auth");const s=qe.getCardDesign();s&&te(s)},[j,i]);const{data:o=[],refetch:c}=Ne({queryKey:["/api/loyalty/cards/phone",a?.phone],queryFn:async()=>{if(!a?.phone)return[];try{const s=await fetch(`/api/loyalty/cards/phone/${a.phone}`);if(!s.ok)return console.error("Failed to fetch loyalty card:",s.status),[];const t=await s.json();return Array.isArray(t)?t:[t]}catch(s){return console.error("Error fetching loyalty card:",s),[]}},enabled:!!a?.phone,staleTime:0,refetchOnWindowFocus:!0,refetchInterval:5e3}),[h,se]=l.useState(null);l.useEffect(()=>{if(o.length>0){const s=o.find(t=>t.isActive)||o[0];se(s)}},[o]);const r=h||(o.length>0?o[0]:null),{data:C=[],refetch:Xe}=Ne({queryKey:["/api/customers",a?.id,"orders"],enabled:!!a?.id,staleTime:0,refetchOnWindowFocus:!0,refetchInterval:5e3});l.useEffect(()=>{const s=r?.cardNumber||r?.qrToken||a?.phone;if(d.current&&s)try{He(d.current,s,{format:"CODE128",width:2,height:50,displayValue:!0,fontSize:14,margin:10,background:"#ffffff",lineColor:"#1a1410"})}catch(t){console.error("Barcode generation error:",t)}},[r?.cardNumber,r?.qrToken,a?.phone]),l.useEffect(()=>{const s=r?.qrToken||r?.cardNumber||a?.phone;m.current&&s&&(ue.toCanvas(m.current,s,{width:140,margin:1,color:{dark:"#1a1410",light:"#ffffff"},errorCorrectionLevel:"H"},t=>{t&&console.error("QR Code generation error:",t)}),ue.toDataURL(s,{width:400,margin:2,errorCorrectionLevel:"H"}).then(t=>{T(t)}).catch(console.error))},[r?.qrToken,r?.cardNumber,a?.phone]);const[ve,S]=l.useState(!1),[ye,L]=l.useState(!1),[A,ae]=l.useState(""),[re,le]=l.useState(!1),[D,ie]=l.useState(0),[ke,P]=l.useState(!1),[I,ne]=l.useState(""),[z,ce]=l.useState("classic"),[oe,de]=l.useState(!1),[Ce,R]=l.useState(!1),[F,E]=l.useState(""),[O,U]=l.useState(""),[_,M]=l.useState(""),[xe,me]=l.useState(!1);l.useEffect(()=>{let s;return D>0?s=setInterval(()=>{ie(t=>t-1)},1e3):S(!1),()=>clearInterval(s)},[D]);const he=async()=>{if(A){le(!0);try{(await y("POST","/api/customers/verify-password",{password:A})).ok?(S(!0),L(!1),ie(60)):alert("كلمة المرور غير صحيحة")}catch(s){console.error("Verification error:",s),alert("حدث خطأ أثناء التحقق")}finally{le(!1),ae("")}}};if(!a)return null;const pe=C.length,x=C.filter(s=>s.status!=="cancelled").reduce((s,t)=>{const f=(Array.isArray(t.items)?t.items:typeof t.items=="string"?JSON.parse(t.items):[]).reduce((N,b)=>N+(b.quantity||0),0);return s+f},0),Se=Math.floor(x/6),Ae=r?.freeCupsRedeemed||0,q=Math.max(0,Se-Ae),p=r?.tier||"bronze",$=r?.points||a.points||0,B={bronze:"برونزي",silver:"فضي",gold:"ذهبي",platinum:"بلاتيني"},be=C.filter(s=>s.status!=="cancelled"),De=be.reduce((s,t)=>s+parseFloat(t.totalAmount?.toString()||"0"),0),ge=be.reduce((s,t)=>{const f=(Array.isArray(t.items)?t.items:typeof t.items=="string"?JSON.parse(t.items):[]).reduce((N,b)=>N+(b.quantity||0),0);return s+f},0),Pe=ge>0?Math.round(De/ge*10)/10:20,Ie=q*Pe,Re=Math.round(Ie*100)/100,Ee=async()=>{const s=document.createElement("canvas"),t=s.getContext("2d");if(!t)return;s.width=900,s.height=1e3;const g=t.createLinearGradient(0,0,s.width,s.height);g.addColorStop(0,"#d4a574"),g.addColorStop(.5,"#c8956c"),g.addColorStop(1,"#a67c52"),t.fillStyle=g,t.fillRect(0,0,s.width,s.height),t.fillStyle="rgba(0,0,0,0.1)",t.beginPath(),t.arc(-50,-50,300,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(s.width+50,s.height+50,250,0,Math.PI*2),t.fill(),t.fillStyle="#4a3728",t.font="bold 48px Cairo, Arial",t.textAlign="right",t.fillText("CLUNY CAFE",s.width-50,70),t.font="24px Georgia, serif",t.fillStyle="#6b4f3c",t.fillText("CLUNY CAFE Loyalty",s.width-50,105);const f={bronze:"#cd7f32",silver:"#c0c0c0",gold:"#ffd700",platinum:"#e5e4e2"};if(t.fillStyle=f[p]||f.bronze,t.beginPath(),t.roundRect(s.width-150,120,100,35,17),t.fill(),t.fillStyle="#4a3728",t.font="bold 16px Cairo, Arial",t.textAlign="center",t.fillText(B[p]||"برونزي",s.width-100,145),t.fillStyle="#4a3728",t.font="bold 32px Cairo, Arial",t.textAlign="right",t.fillText(a.name||"عميل مميز",s.width-50,200),t.font="20px Arial",t.fillStyle="#6b4f3c",t.fillText(a.phone,s.width-50,235),t.fillStyle="rgba(255,255,255,0.95)",t.beginPath(),t.roundRect(50,280,800,280,15),t.fill(),t.textAlign="right",t.fillStyle="#4a3728",t.font="bold 18px Cairo, Arial",t.fillText("الاختام",400,330),t.font="24px Arial",t.fillText(x+"/6",400,360),t.font="bold 18px Cairo, Arial",t.fillText("المشروبات المجانية",600,330),t.font="24px Arial",t.fillText(String(q),600,360),t.font="bold 18px Cairo, Arial",t.fillText("النقاط",800,330),t.font="24px Arial",t.fillText(String($),800,360),t.fillStyle="white",t.beginPath(),t.roundRect(50,600,800,320,15),t.fill(),t.textAlign="center",t.fillStyle="#4a3728",t.font="bold 20px Cairo, Arial",t.fillText("استخدم البطاقة",s.width/2,640),m.current){const N=m.current.toDataURL("image/png"),b=new Image;b.onload=()=>{if(t.drawImage(b,s.width/2-70,660,140,140),d.current){const Te=new XMLSerializer().serializeToString(d.current),Le=new Blob([Te],{type:"image/svg+xml"}),fe=URL.createObjectURL(Le),V=new Image;V.onload=()=>{t.drawImage(V,50,820,800,140),t.font="14px Cairo, Arial",t.fillStyle="#6b4f3c",t.fillText("اعرض الباركود أو QR كود على الكاشير للحصول على نقاطك",s.width/2,980);const Q=document.createElement("a");Q.download="cluny-loyalty-"+(a?.phone||"card")+".png",Q.href=s.toDataURL("image/png"),Q.click(),URL.revokeObjectURL(fe)},V.src=fe}},b.src=N}};return e.jsxs("div",{className:"min-h-screen p-3 pb-24 md:p-6",style:{background:"linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 md:mb-8",children:[e.jsxs(n,{variant:"ghost",size:"sm",onClick:()=>i("/menu"),className:"text-accent hover:text-accent hover:bg-primary/20 px-2 h-9","data-testid":"button-back",children:[e.jsx($e,{className:"w-4 h-4 ml-1.5"}),e.jsx("span",{className:"text-sm",children:"القائمة"})]}),e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-accent text-center flex-1",children:"حسابك"}),e.jsxs("div",{className:"flex gap-1 md:gap-2",children:[e.jsxs(n,{variant:"ghost",size:"sm",onClick:()=>i("/card-customization"),className:"text-accent hover:text-accent hover:bg-primary/20 px-2 h-9","data-testid":"button-customize-card",children:[e.jsx(Ke,{className:"w-4 h-4 ml-1.5"}),e.jsx("span",{className:"hidden sm:inline text-sm",children:"تخصيص"})]}),e.jsxs(n,{variant:"ghost",size:"sm",onClick:w,className:"text-red-400 hover:text-red-300 hover:bg-red-900/20 px-2 h-9","data-testid":"button-logout",children:[e.jsx(we,{className:"w-4 h-4 ml-1.5"}),e.jsx("span",{className:"hidden sm:inline text-sm",children:"خروج"})]})]})]}),e.jsxs("div",{className:"max-w-md mx-auto space-y-5 md:space-y-6",children:[e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-full aspect-[1.586/1] max-w-[340px] perspective group","data-testid":"loyalty-card-container",children:[e.jsx("div",{className:"absolute -inset-1.5 bg-gradient-to-r from-blue-600 via-cyan-400 to-blue-500 rounded-[22px] blur-xl opacity-20 group-hover:opacity-40 transition-opacity duration-500"}),e.jsxs("div",{className:"relative w-full h-full rounded-xl shadow-2xl overflow-hidden transform transition-all duration-500 hover:rotate-y-12 hover:scale-[1.02] border border-white/10",style:{background:"linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)",boxShadow:"0 20px 40px rgba(0,0,0,0.6), inset 0 0 80px rgba(59,130,246,0.15)"},children:[e.jsx("div",{className:"absolute inset-0 opacity-30 mix-blend-overlay pointer-events-none",style:{backgroundImage:'url("https://www.transparenttextures.com/patterns/carbon-fibre.png")'}}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-tr from-blue-500/10 via-transparent to-white/10 pointer-events-none z-10"}),e.jsxs("svg",{className:"absolute inset-0 w-full h-full opacity-10 pointer-events-none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"40",height:"40",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 40 0 L 0 0 0 40",fill:"none",stroke:"currentColor",strokeWidth:"0.5"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"})]}),e.jsxs("div",{className:"relative h-full p-4 md:p-5 flex flex-col justify-between text-white z-20",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"flex flex-col gap-0.5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg shadow-lg border border-white/20",children:e.jsx(Y,{className:"w-4 h-4 md:w-5 md:h-5 text-white"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-base md:text-lg font-black tracking-tighter text-blue-100 leading-none",children:"CLUNY CAFE"}),e.jsx("span",{className:"text-[6px] md:text-[7px] uppercase tracking-[0.3em] text-blue-300/90 font-bold",children:"LOYALTY PREMIUM"})]})]})}),e.jsxs("div",{className:"flex flex-col items-end gap-1 md:gap-1.5",children:[e.jsxs("div",{className:"w-8 h-6 md:w-10 md:h-7 bg-gradient-to-br from-blue-300 via-blue-500 to-blue-700 rounded shadow-[inset_0_1px_1px_rgba(255,255,255,0.5),0_2px_4px_rgba(0,0,0,0.3)] relative overflow-hidden border border-black/10",children:[e.jsxs("div",{className:"absolute inset-0 opacity-40",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-[1px] bg-black/40 mt-1.5"}),e.jsx("div",{className:"absolute top-0 left-0 w-full h-[1px] bg-black/40 mt-3.5"}),e.jsx("div",{className:"absolute top-0 left-0 w-full h-[1px] bg-black/40 mt-5.5"}),e.jsx("div",{className:"absolute top-0 left-0 w-[1px] h-full bg-black/40 ml-3"}),e.jsx("div",{className:"absolute top-0 left-0 w-[1px] h-full bg-black/40 ml-6.5"})]}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-tr from-transparent via-white/30 to-transparent animate-[shimmer_2s_infinite]"})]}),e.jsx(v,{className:`text-[7px] md:text-[8px] px-1.5 py-0 border border-white/10 font-black tracking-widest uppercase shadow-sm h-4 ${p==="platinum"?"bg-indigo-600 text-white":p==="gold"?"bg-blue-400 text-white":p==="silver"?"bg-slate-400 text-white":"bg-blue-600 text-white"}`,children:B[p]})]})]}),e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5 opacity-30",children:[e.jsx("span",{className:"text-[5px] md:text-[6px] uppercase tracking-[0.4em] font-bold text-blue-100",children:"MEMBER ID"}),e.jsx("div",{className:"h-[0.5px] flex-1 bg-blue-100/20"})]}),e.jsx("p",{className:"text-lg md:text-xl font-mono tracking-[0.2em] font-bold text-blue-50 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]",children:r?.cardNumber?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:r.cardNumber.substring(0,4)}),e.jsx("span",{className:"mx-1 opacity-20",children:"••••"}),e.jsx("span",{className:"mx-1 opacity-20",children:"••••"}),e.jsx("span",{children:r.cardNumber.slice(-4)})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-20",children:"••••"}),e.jsx("span",{className:"mx-1 opacity-20",children:"••••"}),e.jsx("span",{className:"mx-1 opacity-20",children:"••••"}),e.jsx("span",{children:a.phone?.slice(-4)||"0000"})]})})]}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-[6px] md:text-[7px] text-blue-300/40 uppercase tracking-[0.2em] font-bold mb-0.5",children:"CARD MEMBER"}),e.jsx("p",{className:"text-sm md:text-base font-bold tracking-widest uppercase text-white drop-shadow-sm leading-tight",children:a.name||"VALUED CUSTOMER"})]}),e.jsxs("div",{className:"flex items-center gap-2 md:gap-3 text-right",children:[e.jsxs("div",{className:"hidden sm:block",children:[e.jsx("p",{className:"text-[5px] md:text-[6px] text-blue-300/40 uppercase tracking-[0.1em]",children:"EXPIRY"}),e.jsx("p",{className:"text-[8px] md:text-[10px] font-black text-blue-200",children:"PERPETUAL"})]}),e.jsxs("div",{className:"relative w-8 h-8 md:w-10 md:h-10",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-400/30 via-cyan-400/30 to-indigo-400/30 rounded-full animate-[pulse_3s_infinite] mix-blend-screen"}),e.jsx("div",{className:"absolute inset-0 border border-white/20 rounded-full flex items-center justify-center backdrop-blur-md shadow-inner",children:e.jsx(Y,{className:"w-4 h-4 md:w-5 md:h-5 text-blue-100 drop-shadow-lg"})})]})]})]})]})]})]})}),o.length>0&&h&&e.jsx(Ge,{cards:o,activeCard:h,onSelectCard:s=>{se(s),s.id&&a?.id&&y("POST",`/api/loyalty/cards/${s.id}/activate`,{customerId:a.id})}}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3 mb-6",children:[e.jsxs(n,{variant:"outline",className:"h-14 md:h-16 flex flex-col items-center justify-center gap-1 border-primary/20 bg-stone-900/40 text-accent hover:bg-primary/30 active:scale-95 transition-transform",onClick:()=>{D>0?S(!0):L(!0)},"data-testid":"button-show-card-info",children:[e.jsx(Be,{className:"w-4 h-4 md:w-5 md:h-5 text-accent"}),e.jsx("span",{className:"text-[10px] md:text-xs font-bold",children:"معلومات البطاقة"})]}),e.jsxs(n,{variant:"outline",className:"h-14 md:h-16 flex flex-col items-center justify-center gap-1 border-primary/20 bg-stone-900/40 text-accent hover:bg-primary/30 active:scale-95 transition-transform",onClick:()=>i("/reset-password"),"data-testid":"button-change-password",children:[e.jsx(Ve,{className:"w-4 h-4 md:w-5 md:h-5 text-blue-400"}),e.jsx("span",{className:"text-[10px] md:text-xs font-bold",children:"تغيير كلمة المرور"})]}),e.jsxs(n,{variant:"outline",className:"h-14 md:h-16 flex flex-col items-center justify-center gap-1 border-red-600/20 bg-red-950/10 text-red-200 hover:bg-red-900/20 active:scale-95 transition-transform disabled:opacity-50",disabled:!r,onClick:()=>{r&&r.reissuanceCount<2?alert("لا يمكنك إلغاء البطاقة إلا إذا كان لديك فرصة لإنشاء بطاقة جديدة"):(R(!0),E(a?.phone||""))},"data-testid":"button-cancel-card",children:[e.jsx(we,{className:"w-4 h-4 md:w-5 md:h-5 text-red-500"}),e.jsx("span",{className:"text-[10px] md:text-xs font-bold text-red-400",children:"إلغاء البطاقة"})]}),e.jsxs(n,{variant:"outline",className:"h-14 md:h-16 flex flex-col items-center justify-center gap-1 border-green-600/20 bg-green-950/10 text-green-200 hover:bg-green-900/20 active:scale-95 transition-transform",onClick:()=>{r&&r.reissuanceCount>=2?alert("لقد وصلت إلى الحد الأقصى لإصدار بطاقة جديدة (مرتين فقط)"):P(!0)},"data-testid":"button-issue-new-card",children:[e.jsx(We,{className:"w-4 h-4 md:w-5 md:h-5 text-green-500"}),e.jsx("span",{className:"text-[10px] md:text-xs font-bold text-green-400",children:"إصدار بطاقة جديدة"})]})]}),e.jsx(J,{open:Ce,onOpenChange:R,children:e.jsxs(H,{className:"w-[90%] max-w-[425px] bg-stone-950 border-red-500/30 text-white rounded-2xl",children:[e.jsxs(K,{children:[e.jsx(W,{className:"text-lg md:text-xl font-black text-red-400",children:"إلغاء البطاقة"}),e.jsx(G,{className:"text-white/60 text-sm",children:"أدخل بيانات حسابك للتحقق من الهوية قبل إلغاء البطاقة"})]}),e.jsxs("div",{className:"grid gap-4 py-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"cancel-phone",className:"text-white/70 text-sm",children:"رقم الهاتف"}),e.jsx(k,{id:"cancel-phone",type:"tel",value:F,onChange:s=>E(s.target.value),className:"bg-white/5 border-white/10 text-white focus-visible:ring-red-500 h-11",placeholder:"رقم الهاتف","data-testid":"input-cancel-phone"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"cancel-email",className:"text-white/70 text-sm",children:"البريد الإلكتروني"}),e.jsx(k,{id:"cancel-email",type:"email",value:O,onChange:s=>U(s.target.value),className:"bg-white/5 border-white/10 text-white focus-visible:ring-red-500 h-11",placeholder:"البريد الإلكتروني","data-testid":"input-cancel-email"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"cancel-password",className:"text-white/70 text-sm",children:"كلمة المرور"}),e.jsx(k,{id:"cancel-password",type:"password",value:_,onChange:s=>M(s.target.value),className:"bg-white/5 border-white/10 text-white focus-visible:ring-red-500 h-11",placeholder:"••••••••","data-testid":"input-cancel-password"})]})]}),e.jsxs(X,{className:"flex-row gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>{R(!1),E(""),U(""),M("")},className:"flex-1",children:"إلغاء"}),e.jsx(n,{disabled:xe||!F||!O||!_,onClick:async()=>{const s=r?.id||r?._id;if(!s){alert("لا توجد بطاقة لإلغائها");return}me(!0);try{(await y("POST",`/api/loyalty/cards/${s}/cancel`,{phone:F,email:O,password:_})).ok&&(alert("تم إلغاء البطاقة بنجاح!"),R(!1),E(""),U(""),M(""),window.location.reload())}catch(t){console.error("Error canceling card:",t),alert("فشل في إلغاء البطاقة. تأكد من صحة البيانات")}finally{me(!1)}},className:"flex-1 bg-red-600 hover:bg-red-700",children:xe?"جاري الإلغاء...":"تأكيد الإلغاء"})]})]})}),e.jsx(J,{open:ke,onOpenChange:P,children:e.jsxs(H,{className:"w-[90%] max-w-[425px] bg-stone-950 border-primary/30 text-white rounded-2xl",children:[e.jsxs(K,{children:[e.jsx(W,{className:"text-lg md:text-xl font-black text-accent",children:"إصدار بطاقة جديدة"}),e.jsxs(G,{className:"text-white/60 text-sm",children:["اختر تصميماً جديداً وحدد رمز PIN للبطاقة الجديدة (متبقي: ",r?.reissuanceCount?2-r.reissuanceCount:2,"/2)"]})]}),e.jsxs("div",{className:"grid gap-4 py-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{className:"text-white/70 text-sm",children:"اختر التصميم"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:[{id:"classic",label:"كلاسيكي",color:"bg-primary"},{id:"modern",label:"عصري",color:"bg-blue-700"},{id:"dark",label:"داكن",color:"bg-slate-800"},{id:"gold",label:"ذهبي",color:"bg-yellow-600"}].map(s=>e.jsx("button",{onClick:()=>ce(s.id),className:`p-3 rounded-lg border-2 transition-all ${z===s.id?"border-primary ring-2 ring-amber-400":"border-white/20"} ${s.color}`,children:e.jsx("span",{className:"text-sm font-bold text-white",children:s.label})},s.id))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"new-pin",className:"text-white/70 text-sm",children:"رمز PIN الجديد"}),e.jsx(k,{id:"new-pin",type:"password",value:I,onChange:s=>ne(s.target.value),className:"bg-white/5 border-white/10 text-white focus-visible:ring-amber-500 h-11",placeholder:"أدخل رمز PIN (4 أرقام على الأقل)","data-testid":"input-new-card-pin"})]})]}),e.jsxs(X,{className:"flex-row gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>P(!1),className:"flex-1",children:"إلغاء"}),e.jsx(n,{disabled:oe||I.length<4,onClick:async()=>{de(!0);try{const s=r?.id||r?._id;s?await y("POST",`/api/loyalty/cards/${s}/reissue`,{newPin:I,cardDesign:z}):await y("POST","/api/loyalty/cards",{customerName:a.name||"عميل",phoneNumber:a.phone,cardPin:I,cardDesign:z}),alert(r?"تم إصدار بطاقة جديدة بنجاح!":"تم إنشاء بطاقة ولاء جديدة بنجاح!"),P(!1),ne(""),ce("classic"),window.location.reload()}catch(s){console.error("Error issuing card:",s),alert("فشل في إصدار البطاقة")}finally{de(!1)}},className:"flex-1 bg-green-600 hover:bg-green-700",children:oe?"جاري الإصدار...":r?"إعادة إصدار":"إصدار الآن"})]})]})}),e.jsx(J,{open:ye,onOpenChange:L,children:e.jsxs(H,{className:"w-[90%] max-w-[425px] bg-stone-950 border-primary/30 text-white rounded-2xl",children:[e.jsxs(K,{children:[e.jsx(W,{className:"text-lg md:text-xl font-black text-accent",children:"تحقق من الهوية"}),e.jsx(G,{className:"text-white/60 text-sm",children:"الرجاء إدخال كلمة مرور حسابك لعرض بيانات البطاقة الحساسة."})]}),e.jsx("div",{className:"grid gap-4 py-3",children:e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"password",title:"كلمة المرور",className:"text-white/70 text-sm",children:"كلمة المرور"}),e.jsx(k,{id:"password",type:"password",value:A,onChange:s=>ae(s.target.value),className:"bg-white/5 border-white/10 text-white focus-visible:ring-amber-500 h-11",placeholder:"••••••••",autoFocus:!0,onKeyDown:s=>s.key==="Enter"&&he()})]})}),e.jsx(X,{className:"flex-row gap-2",children:e.jsx(n,{disabled:re||!A,onClick:he,className:"w-full bg-primary hover:bg-primary text-white font-black h-11",children:re?"جاري التحقق...":"تأكيد"})})]})}),ve&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300",children:e.jsx(je,{className:"w-full max-w-sm bg-stone-950 border-primary/30 text-white overflow-hidden shadow-2xl ring-1 ring-white/10 rounded-2xl",children:e.jsxs("div",{className:"p-6 space-y-5",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"w-5 h-5 text-accent"}),e.jsx("h3",{className:"text-lg font-black tracking-tight text-accent",children:"بيانات البطاقة"})]}),e.jsxs(v,{variant:"outline",className:"text-accent border-primary animate-pulse",children:[D," ثانية"]})]}),e.jsxs("div",{className:"space-y-4 bg-white/5 rounded-xl p-4 border border-white/5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[10px] text-white/40 uppercase tracking-[0.2em] font-bold",children:"Card Number"}),e.jsx("p",{className:"text-xl font-mono tracking-wider text-accent font-bold select-all",children:r?.cardNumber?r.cardNumber.replace(/(.{4})/g,"$1 ").trim():a?.phone?`QC-${a.phone}`:"لا يوجد بطاقة"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[10px] text-white/40 uppercase tracking-[0.2em] font-bold",children:"Tier"}),e.jsx("p",{className:"text-sm font-black text-accent uppercase",children:B[p]})]}),e.jsxs("div",{className:"space-y-1 text-right",children:[e.jsx("p",{className:"text-[10px] text-white/40 uppercase tracking-[0.2em] font-bold",children:"Points"}),e.jsx("p",{className:"text-sm font-black text-yellow-400",children:$})]})]})]}),e.jsx(n,{className:"w-full bg-primary hover:bg-primary text-white font-black h-11 shadow-lg shadow-amber-900/20",onClick:()=>S(!1),children:"إغلاق آمن"})]})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-950/40 dark:to-amber-900/30 rounded-2xl p-3 md:p-4 text-center border border-primary/50 dark:border-primary/50",children:[e.jsx("p",{className:"text-xl md:text-2xl font-bold text-accent dark:text-accent mb-0.5",children:x}),e.jsx("p",{className:"text-[10px] md:text-xs text-accent dark:text-accent font-semibold uppercase tracking-wider",children:"اختام"}),e.jsx("p",{className:"text-[9px] md:text-[10px] text-accent dark:text-accent opacity-60",children:"إجمالي"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950/40 dark:to-green-900/30 rounded-2xl p-3 md:p-4 text-center border border-green-200/50 dark:border-green-700/50",children:[e.jsx("p",{className:"text-xl md:text-2xl font-bold text-green-900 dark:text-green-300 mb-0.5",children:q}),e.jsx("p",{className:"text-[10px] md:text-xs text-green-700 dark:text-green-400 font-semibold uppercase tracking-wider",children:"مجاني"}),e.jsx("p",{className:"text-[9px] md:text-[10px] text-green-600 dark:text-green-500 opacity-60",children:"مشروب"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-950/40 dark:to-yellow-900/30 rounded-2xl p-3 md:p-4 text-center border border-yellow-200/50 dark:border-yellow-700/50",children:[e.jsx("p",{className:"text-xl md:text-2xl font-bold text-yellow-900 dark:text-yellow-300 mb-0.5",children:$}),e.jsx("p",{className:"text-[10px] md:text-xs text-yellow-700 dark:text-yellow-400 font-semibold uppercase tracking-wider",children:"نقاط"}),e.jsx("p",{className:"text-[9px] md:text-[10px] text-yellow-600 dark:text-yellow-500 opacity-60",children:"رصيد"})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-rose-50 to-rose-100 dark:from-rose-950/40 dark:to-rose-900/30 rounded-2xl p-4 md:p-5 text-center border border-rose-200/50 dark:border-rose-700/50",children:[e.jsx("p",{className:"text-xs text-rose-700 dark:text-rose-400 font-semibold uppercase tracking-wider mb-1",children:"إجمالي التوفير"}),e.jsxs("p",{className:"text-2xl md:text-3xl font-bold text-rose-900 dark:text-rose-300",children:[Re.toLocaleString("ar-SA")," ",e.jsx("span",{className:"text-sm",children:"ر.س"})]}),e.jsx("p",{className:"text-[9px] md:text-[10px] text-rose-600 dark:text-rose-500 opacity-60 mt-1",children:"من المشروبات المجانية"})]})]}),e.jsxs("div",{className:"bg-white/5 backdrop-blur-sm rounded-2xl p-4 md:p-5 border border-primary/10",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("p",{className:"text-sm font-bold text-accent tracking-wide",children:"تقدم الاختام (من 6 لمشروب مجاني)"}),e.jsxs(v,{variant:"outline",className:"text-[10px] font-black border-primary/30 text-accent",children:[x%6||(x>0?6:0),"/6"]})]}),e.jsx("div",{className:"flex gap-1.5 md:gap-2",children:[...Array(6)].map((s,t)=>e.jsx("div",{className:`h-2 md:h-2.5 flex-1 rounded-full transition-all duration-700 ${t<(x%6||(x>0?6:0))?"bg-gradient-to-r from-amber-400 to-amber-600 shadow-[0_0_12px_rgba(251,191,36,0.4)]":"bg-white/10"}`},t))}),x>=6&&e.jsxs("p",{className:"text-xs text-accent mt-3 text-center",children:["أكملت ",Math.floor(x/6)," مشروب مجاني و ",x%6," ختم إضافي"]})]}),e.jsxs("div",{className:"bg-white dark:bg-stone-900/40 backdrop-blur-md rounded-2xl p-5 md:p-6 border border-primary/10 text-center",children:[e.jsx("h3",{className:"font-bold text-accent mb-5 text-sm md:text-base",children:"استخدم البطاقة"}),e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx("div",{className:"bg-white p-3 md:p-4 rounded-xl shadow-xl ring-4 ring-amber-500/10",children:e.jsx("canvas",{ref:m,className:"rounded-lg w-32 h-32 md:w-36 md:h-36","data-testid":"qr-code"})}),e.jsx("div",{className:"w-full bg-white p-3 rounded-xl flex justify-center overflow-hidden shadow-lg ring-1 ring-black/5",children:e.jsx("svg",{ref:d,className:"h-12 md:h-14 w-full","data-testid":"barcode"})})]}),e.jsx("p",{className:"text-[10px] md:text-xs text-accent/60 mt-5 font-medium leading-relaxed",children:"اعرض الباركود أو QR كود على الكاشير لجمع النقاط والاختام"})]}),e.jsx("div",{className:"space-y-3",children:e.jsxs(n,{onClick:Ee,className:"w-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-black h-12 md:h-13 rounded-xl shadow-lg shadow-amber-900/20 active:scale-[0.98] transition-all text-sm md:text-base","data-testid":"button-download-card",children:[e.jsx(Ye,{className:"w-4 h-4 ml-2"}),"تحميل البطاقة الرقمية"]})}),pe>0&&e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg md:text-xl font-bold text-accent",children:"طلباتك الأخيرة"}),e.jsxs(v,{variant:"secondary",className:"bg-primary/40 text-accent border-primary/20 px-2.5",children:[pe," طلب"]})]}),e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto scrollbar-hide",children:C.slice(0,5).map((s,t)=>e.jsx(je,{className:"bg-stone-900/30 border border-white/5 rounded-xl overflow-hidden cursor-pointer",onClick:()=>i("/my-orders"),children:e.jsxs("div",{className:"p-3 md:p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("p",{className:"text-sm font-bold text-accent",children:["الطلب #",s.orderNumber||t+1]}),e.jsx(v,{variant:"outline",className:"text-[9px] font-black h-5",children:s.status==="completed"?"مكتمل":s.status==="cancelled"?"ملغى":"قيد التنفيذ"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-accent/70",children:[Array.isArray(s.items)?s.items.length:0," أصناف"]}),e.jsxs("span",{className:"text-accent font-black",children:[s.totalAmount||0," ر.س"]})]})]})},s.id||t))}),e.jsxs(n,{onClick:()=>i("/my-orders"),className:"w-full h-11 bg-white/5 text-accent font-bold rounded-xl text-sm",children:[e.jsx(Je,{className:"w-4 h-4 ml-2"}),"عرض جميع الطلبات"]})]}),e.jsxs(n,{onClick:()=>i("/menu"),variant:"outline",className:"w-full h-12 md:h-13 border-primary/20 bg-background0/5 text-accent font-bold rounded-xl text-sm md:text-base mt-4 mb-8",children:[e.jsx(Y,{className:"w-4 h-4 ml-2"}),"تصفح القائمة والطلب الآن"]})]})]})}export{ct as default};
