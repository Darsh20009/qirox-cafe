import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as n}from"./vendor-react-Bzsngnqy.js";import{a as Ve,b as Ee}from"./vendor-query-CX8ZYlKb.js";import{u as Ae,c as Le,d as $e,e as Ue,s as Ke,t as Be,v as k,w as V,B as p,C as te,x as Je,y as ze,f as se,U as He,I as w,L as I,z as Qe,S as ae,G as Ge,q as ne,D as re,E as ie,F as oe,H as ce,J as We,K as le,N as de}from"./index-CLvpp2UE.js";import{C as Xe}from"./checkbox-pP3s8YPe.js";import{C as Ye}from"./circle-check-big-DlXUvwLH.js";import{S as ue}from"./shield-BnyrfBf-.js";import{K as Ze}from"./key-round-BfPQAVEt.js";import"./vendor-utils-BKCsaWdX.js";function mt(){const{t,i18n:pe}=Ae(),[,me]=Le(),{cartItems:E,clearCart:xe,getFinalTotal:A,deliveryInfo:u}=$e(),{toast:r}=Ue(),j=pe.language==="ar",[f,he]=n.useState(null),[fe,P]=n.useState(!1),[D,ge]=n.useState(null),[ye,ve]=n.useState(!1),[b,L]=n.useState(""),[g,$]=n.useState(""),[O,je]=n.useState(""),[be,et]=n.useState(""),[U,Ne]=n.useState(!1),[ke,tt]=n.useState(""),[C,we]=n.useState(""),[st,K]=n.useState(!1),[c,S]=n.useState(null),[i,B]=n.useState(0),[y,J]=n.useState(!1),[h,z]=n.useState(!1),[Ce,H]=n.useState(""),[Se,_]=n.useState(!1),[N,T]=n.useState(""),[Q,G]=n.useState(!1),[W,X]=n.useState(!1),[Y,q]=n.useState(null),{card:v,refetch:_e}=Ke(),m=s=>s/100*5,R=()=>{let s=A();return c&&(s=s*(1-c.percentage/100)),y&&h&&(s=Math.max(0,s-m(i))),s},[at,Z]=n.useState(!1),{customer:l,setCustomer:Ie}=Be();n.useEffect(()=>{l&&(L(l.name),$(l.phone),l.email&&je(l.email))},[l]),n.useEffect(()=>{if(new URLSearchParams(window.location.search).get("payment")==="callback"){const a=sessionStorage.getItem("pendingOrderData"),o=sessionStorage.getItem("paymentSessionId"),d=sessionStorage.getItem("paymentProvider");a&&o&&(async()=>{try{const F=await(await k("POST","/api/payments/verify",{sessionId:o,provider:d})).json();if(F.verified){const M=JSON.parse(a);M.paymentStatus="paid",M.transactionId=F.transactionId,sessionStorage.removeItem("pendingOrderData"),sessionStorage.removeItem("paymentSessionId"),sessionStorage.removeItem("paymentProvider"),ee.mutate(M)}else sessionStorage.removeItem("pendingOrderData"),sessionStorage.removeItem("paymentSessionId"),sessionStorage.removeItem("paymentProvider"),r({variant:"destructive",title:"فشل الدفع",description:F.error||"لم يتم التحقق من الدفع"})}catch{r({variant:"destructive",title:"خطأ",description:"فشل التحقق من حالة الدفع"})}})(),window.history.replaceState({},"","/checkout")}},[]),n.useEffect(()=>{const s=V.getActiveOffer();if(s&&s.discount>0&&!c){const a=s.type==="loyalty"?0:s.discount;a>0&&(S({code:s.title,percentage:a,isOffer:!0}),r({title:t("points.offer_applied"),description:`${s.title} - ${t("points.discount")} ${a}%`}))}},[]);const{data:Pe=[]}=Ve({queryKey:["/api/payment-methods"],queryFn:async()=>(await fetch("/api/payment-methods")).json()}),ee=Ee({mutationFn:async s=>{const a=await k("POST","/api/orders",s);if(!a.ok){const o=await a.json();throw new Error(o.error||"Order failed")}return a.json()},onSuccess:s=>{ge(s),xe(),V.clearActiveOffer(),ve(!0),de.invalidateQueries({queryKey:["/api/orders"]}),de.invalidateQueries({queryKey:["/api/loyalty/cards/phone"]}),_e();const a=s.orderNumber.includes("-")?s.orderNumber.split("-").pop():s.orderNumber;r({title:t("checkout.order_success"),description:`${t("tracking.order_number")}: ${a}`})},onError:s=>r({variant:"destructive",title:t("checkout.order_error"),description:s.message})}),De=async()=>{if(C.trim()){K(!0);try{const s=await fetch("/api/discount-codes/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:C.trim(),customerId:l?.id})}),a=await s.json();s.ok&&a.valid?S({code:C.trim(),percentage:a.discountPercentage}):(S(null),r({variant:"destructive",title:t("checkout.invalid_discount")}))}finally{K(!1)}}},Oe=async()=>{if(!i||i<=0){r({variant:"destructive",title:t("points.enter_points_amount")});return}const s=l?.phone||g;if(!s){r({variant:"destructive",title:t("points.phone_required")});return}G(!0);try{const a=await k("POST","/api/loyalty/points/request-code",{phone:s,points:i,requestedBy:"customer"}),o=await a.json();a.ok&&o.success?(_(!0),o.devCode&&q(o.devCode),r({title:t("points.code_sent"),description:o.maskedEmail?t("points.code_sent_to_email",{email:o.maskedEmail}):t("points.code_generated")})):r({variant:"destructive",title:o.error||t("points.code_error")})}catch{r({variant:"destructive",title:t("points.code_error")})}finally{G(!1)}},Te=async()=>{if(!N.trim()||N.length<4){r({variant:"destructive",title:t("points.enter_valid_code")});return}const s=l?.phone||g;X(!0);try{const a=await k("POST","/api/loyalty/points/verify-code",{phone:s,code:N.trim()}),o=await a.json();a.ok&&o.verified?(z(!0),J(!0),H(o.verificationToken),_(!1),T(""),q(null),r({title:t("points.verified_success"),description:t("points.points_will_be_deducted",{amount:m(i).toFixed(2)})})):r({variant:"destructive",title:o.error||t("points.invalid_code")})}catch{r({variant:"destructive",title:t("points.verification_error")})}finally{X(!1)}},qe=()=>{J(!1),z(!1),H(""),B(0),T(""),q(null)},Re=()=>{if(!f){r({variant:"destructive",title:t("checkout.select_payment")});return}if(!b.trim()){r({variant:"destructive",title:t("checkout.enter_customer_name")});return}P(!0)},Fe=s=>s?["neoleap","geidea","apple_pay","neoleap-apple-pay","bank_card"].includes(s):!1,Me=async()=>{let s=R();if(f==="wallet"&&(l?.walletBalance||0)<s){r({variant:"destructive",title:t("points.insufficient_wallet")});return}let a=l?.id;if(!a&&U){Z(!0);const d=await fetch("/api/customers/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,phone:g,email:O,password:be})});if(d.ok){const x=await d.json();a=x.id,Ie(x)}Z(!1)}const o={customerId:a,customerName:b,customerPhone:g,customerEmail:O,items:E.map(d=>({coffeeItemId:d.coffeeItemId,quantity:d.quantity,price:d.coffeeItem?.price||0,nameAr:d.coffeeItem?.nameAr||""})),totalAmount:s,paymentMethod:f,status:"pending",branchId:u?.branchId||"default",orderType:u?.type==="car-pickup"?"car_pickup":u?.type==="pickup"&&u?.dineIn?"dine-in":"regular",deliveryType:u?.type==="car-pickup"?"car_pickup":u?.type||"pickup",customerNotes:ke,discountCode:c?.code,pointsRedeemed:y&&h?i:0,pointsValue:y&&h?m(i):0,pointsVerificationToken:y&&h?Ce:void 0,...u?.type==="car-pickup"&&u?.carInfo?{carType:u.carInfo.carType,carColor:u.carInfo.carColor,plateNumber:u.carInfo.plateNumber}:{}};if(Fe(f))try{const x=await(await k("POST","/api/payments/init",{amount:s,currency:"SAR",orderId:`temp-${Date.now()}`,customerName:b,customerEmail:O||void 0,customerPhone:g||void 0,paymentMethod:f,returnUrl:`${window.location.origin}/checkout?payment=callback`})).json();if(x.redirectUrl){sessionStorage.setItem("pendingOrderData",JSON.stringify(o)),sessionStorage.setItem("paymentSessionId",x.sessionId||""),sessionStorage.setItem("paymentProvider",x.provider||""),window.location.href=x.redirectUrl;return}else{r({variant:"destructive",title:"خطأ",description:x.error||"فشل بدء عملية الدفع"});return}}catch(d){r({variant:"destructive",title:"خطأ في الدفع",description:d.message||"فشل الاتصال ببوابة الدفع"});return}ee.mutate(o)};return ye?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-8 bg-[#533d2d]",dir:j?"rtl":"ltr",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-3xl p-8 shadow-2xl text-center space-y-6",children:[e.jsx(Ye,{className:"w-16 h-16 text-green-600 mx-auto"}),e.jsx("h2",{className:"text-3xl font-bold text-accent",children:t("nav.thank_you")}),e.jsxs("p",{children:[t("checkout.order_desc")," ",e.jsxs("span",{className:"font-bold text-primary",children:["#",D?.orderNumber?.includes("-")?D.orderNumber.split("-").pop():D?.orderNumber]})]}),e.jsx(p,{onClick:()=>me("/menu"),className:"w-full h-12 bg-primary","data-testid":"button-back-to-menu",children:t("cart.continue_shopping")})]})}):e.jsxs("div",{className:"min-h-screen py-12 bg-[#21302f]",dir:j?"rtl":"ltr",children:[e.jsxs("div",{className:"max-w-6xl mx-auto px-4",children:[e.jsx("h1",{className:"text-3xl font-bold text-white text-center mb-8",children:t("nav.checkout")}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-1 space-y-6",children:e.jsxs(te,{children:[e.jsx(Je,{children:e.jsx(ze,{children:t("checkout.order_summary")})}),e.jsxs(se,{className:"space-y-4",children:[E.map((s,a)=>e.jsxs("div",{className:"flex justify-between items-center gap-2 text-sm","data-testid":`cart-item-${a}`,children:[e.jsxs("span",{children:[j?s.coffeeItem?.nameAr:s.coffeeItem?.nameEn," × ",s.quantity]}),e.jsxs("span",{className:"font-bold",children:[((s.coffeeItem?.price||0)*s.quantity).toFixed(2)," ",t("currency")]})]},a)),c&&e.jsxs("div",{className:"flex justify-between items-center gap-2 text-sm text-green-600 bg-green-50 dark:bg-green-950/30 p-2 rounded",children:[e.jsxs("span",{children:[t("points.discount")," (",c.percentage,"%)"]}),e.jsxs("span",{children:["-",(A()*c.percentage/100).toFixed(2)," ",t("currency")]})]}),y&&h&&e.jsxs("div",{className:"flex justify-between items-center gap-2 text-sm text-blue-600 bg-blue-50 dark:bg-blue-950/30 p-2 rounded",children:[e.jsx("span",{children:t("points.points_discount")}),e.jsxs("span",{children:["-",m(i).toFixed(2)," ",t("currency")]})]}),e.jsxs("div",{className:"pt-4 border-t font-bold text-xl flex justify-between gap-2",children:[e.jsxs("span",{children:[t("cart.total"),":"]}),e.jsxs("span",{className:"text-primary",children:[R().toFixed(2)," ",t("currency")]})]})]})]})}),e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(te,{children:e.jsxs(se,{className:"pt-6 space-y-4",children:[l?e.jsx("div",{className:"bg-muted/30 p-4 rounded-lg flex items-center justify-between gap-2 flex-wrap",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(He,{className:"w-5 h-5 text-accent"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:l.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.phone})]})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(w,{value:b,onChange:s=>L(s.target.value),placeholder:t("checkout.full_name"),"data-testid":"input-customer-name"}),e.jsx(w,{value:g,onChange:s=>$(s.target.value),placeholder:t("checkout.phone"),"data-testid":"input-customer-phone"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{id:"register",checked:U,onCheckedChange:s=>Ne(!!s),"data-testid":"checkbox-register"}),e.jsx(I,{htmlFor:"register",children:t("checkout.want_to_register")})]})]}),e.jsx(Qe,{paymentMethods:Pe,selectedMethod:f,onSelectMethod:he}),c?.isOffer&&e.jsx("div",{className:"border rounded-lg p-4 bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-green-800 dark:text-green-300",children:c.code}),e.jsxs("p",{className:"text-sm text-green-600",children:[t("points.discount")," ",c.percentage,"% ",t("points.applied")]})]})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{S(null),V.clearActiveOffer()},className:"text-red-500","data-testid":"button-remove-offer",children:t("points.remove")})]})}),e.jsxs("div",{className:"border rounded-lg p-4 bg-orange-50 dark:bg-orange-950/30",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ge,{className:"w-5 h-5 text-orange-600"}),e.jsx(I,{className:"font-semibold",children:t("checkout.have_discount")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{value:C,onChange:s=>we(s.target.value),placeholder:t("checkout.enter_discount"),disabled:!!c,"data-testid":"input-discount-code"}),e.jsx(p,{onClick:De,disabled:!!c,"data-testid":"button-apply-discount",children:t("checkout.apply")})]}),c&&!c.isOffer&&e.jsxs("p",{className:"text-sm text-green-600 mt-2",children:[t("points.applied"),": ",c.code," (",c.percentage,"%)"]})]}),l&&v&&(v.points||0)>0&&e.jsxs("div",{className:"border rounded-lg p-4 bg-blue-50 dark:bg-blue-950/30 border-blue-100 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ae,{className:"w-5 h-5 text-blue-600"}),e.jsx(I,{className:"font-semibold text-blue-800 dark:text-blue-300",children:t("points.cluny_points")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm text-blue-700 dark:text-blue-400",children:[t("points.your_balance"),": ",v.points," ",t("points.points_unit")]}),e.jsxs("span",{className:"text-sm font-bold text-blue-800 dark:text-blue-300",children:["≈ ",m(v.points||0).toFixed(2)," ",t("currency")]})]}),h?e.jsxs("div",{className:"bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700 dark:text-green-400",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:t("points.verified_and_active")})]}),e.jsxs("div",{className:"flex justify-between items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm",children:[i," ",t("points.points_unit")," = ",m(i).toFixed(2)," ",t("currency")]}),e.jsx(p,{variant:"destructive",size:"sm",onClick:qe,"data-testid":"button-cancel-points",children:t("points.cancel_use")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(w,{type:"number",min:0,max:v.points,value:i||"",onChange:s=>{const a=Math.min(Math.max(0,Number(s.target.value)),v.points||0);B(a)},placeholder:t("points.enter_points"),className:"bg-white dark:bg-background","data-testid":"input-points-redeem"}),e.jsxs(p,{onClick:Oe,disabled:Q||!i||i<=0,"data-testid":"button-request-points-code",children:[Q?e.jsx(ne,{className:"w-4 h-4 animate-spin"}):e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{className:"mr-1",children:t("points.send_code")})]})]}),i>0&&e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:t("points.will_deduct",{amount:m(i).toFixed(2)})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("points.verification_required")})]})]})]}),e.jsx(p,{onClick:Re,className:"w-full h-14 text-lg","data-testid":"button-proceed-payment",children:t("checkout.confirm_order")})]})})})]})]}),e.jsx(re,{open:Se,onOpenChange:_,children:e.jsxs(ie,{dir:j?"rtl":"ltr",className:"max-w-sm",children:[e.jsxs(oe,{children:[e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5 text-blue-600"}),t("points.verify_title")]}),e.jsx(We,{children:t("points.verify_desc")})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"text-center bg-blue-50 dark:bg-blue-950/30 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("points.redeeming")}),e.jsxs("p",{className:"text-2xl font-bold text-blue-700 dark:text-blue-300",children:[i," ",t("points.points_unit")]}),e.jsxs("p",{className:"text-sm text-blue-600",children:["=  ",m(i).toFixed(2)," ",t("currency")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:t("points.enter_code")}),e.jsx(w,{type:"text",maxLength:4,value:N,onChange:s=>T(s.target.value.replace(/\D/g,"")),placeholder:"1234",className:"text-center text-2xl tracking-widest font-bold",dir:"ltr","data-testid":"input-verification-code"})]}),Y&&e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-2 text-center",children:e.jsxs("p",{className:"text-xs text-yellow-700 dark:text-yellow-400",children:[t("points.dev_code"),": ",e.jsx("span",{className:"font-bold text-lg",children:Y})]})})]}),e.jsxs(le,{className:"gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>_(!1),className:"flex-1","data-testid":"button-cancel-verify",children:t("points.cancel")}),e.jsxs(p,{onClick:Te,disabled:W||N.length<4,className:"flex-1","data-testid":"button-confirm-verify",children:[W?e.jsx(ne,{className:"w-4 h-4 animate-spin"}):null,t("points.verify")]})]})]})}),e.jsx(re,{open:fe,onOpenChange:P,children:e.jsxs(ie,{dir:j?"rtl":"ltr",children:[e.jsx(oe,{children:e.jsx(ce,{children:t("checkout.confirm_title")})}),e.jsxs("div",{className:"py-4 text-center",children:[e.jsx("p",{className:"text-lg",children:t("checkout.confirm_question")}),e.jsxs("p",{className:"text-2xl font-bold text-primary mt-2",children:[R().toFixed(2)," ",t("currency")]}),y&&h&&e.jsx("p",{className:"text-sm text-blue-600 mt-1",children:t("points.includes_points_discount",{points:i,amount:m(i).toFixed(2)})})]}),e.jsxs(le,{className:"gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>P(!1),className:"flex-1","data-testid":"button-cancel-order",children:t("points.cancel")}),e.jsx(p,{onClick:Me,className:"flex-1 bg-green-600","data-testid":"button-confirm-order",children:t("checkout.confirm_pay")})]})]})})]})}export{mt as default};
