import{j as e}from"./vendor-ui-DJm-zmnP.js";import{l as ie,e as ce,c as de,i as E,B as n,A as oe,L,q as f,C as M,f as B,Y as me,I as R,r as ue,j as g,o as xe,U as pe,p as he,a3 as fe,a1 as ge,D as je,E as be,F as Ne,H as ye,J as ve,K as we,v as _,N as j}from"./index-61RjstaY.js";import{a as z,b}from"./vendor-query-CX8ZYlKb.js";import{S as K,a as Q,b as H,c as U,d as c}from"./select-BgcBxbEj.js";import{r as d}from"./vendor-react-Bzsngnqy.js";import{S as V}from"./separator-B9VVwhVq.js";import{R as Ce}from"./refresh-cw-DWvJTizr.js";import{C as $}from"./circle-check-big-v7jPXABl.js";import{C as J}from"./circle-x-D9GYVDcC.js";import{C as W}from"./circle-play-5Q5eXhTS.js";import{D as X}from"./dollar-sign-B-fnJpJ6.js";import{U as ke}from"./undo-2-lfbDAoLA.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-BsuQiE4E.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=ie("BellRing",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}]]);function Re(){const{toast:r}=ce(),[,N]=de(),[O,Y]=d.useState(null),[y,G]=d.useState(""),[v,Z]=d.useState("all"),[w,ee]=d.useState(null),[se,p]=d.useState(!1),[l,q]=d.useState(null),[o,C]=d.useState(""),[k,S]=d.useState(0);d.useEffect(()=>{const s=localStorage.getItem("currentEmployee");s?Y(JSON.parse(s)):N("/employee/login")},[N]);const{data:h=[],refetch:D,isLoading:I}=z({queryKey:["/api/orders"],refetchInterval:3e3,refetchOnWindowFocus:!0}),{data:te=[]}=z({queryKey:["/api/branches"]}),P=b({mutationFn:async()=>(await _("PATCH","/api/orders/complete-all")).json(),onSuccess:s=>{j.invalidateQueries({queryKey:["/api/orders"]}),r({title:`تم إكمال ${s.modifiedCount||s.count||0} طلب بنجاح`})},onError:()=>{r({title:"خطأ",description:"فشل إكمال الطلبات",variant:"destructive"})}}),T=b({mutationFn:async()=>{const s=await fetch("/api/orders/cancel-all",{method:"POST",headers:{"Content-Type":"application/json"}});if(!s.ok){const t=await s.json().catch(()=>({}));throw new Error(t.error||"Failed")}return s.json()},onSuccess:s=>{j.invalidateQueries({queryKey:["/api/orders"]}),r({title:`تم إلغاء ${s.count||0} طلب مفتوح بنجاح`})},onError:s=>{r({title:"خطأ",description:s.message||"فشل إلغاء الطلبات",variant:"destructive"})}}),i=b({mutationFn:async({id:s,status:t})=>(await _("PATCH",`/api/orders/${s}/status`,{status:t})).json(),onSuccess:(s,t)=>{j.invalidateQueries({queryKey:["/api/orders"]}),r({title:`تم تحديث حالة الطلب إلى: ${{pending:"جديد",payment_confirmed:"تم الدفع",confirmed:"مؤكد",in_progress:"قيد التحضير",ready:"جاهز للتسليم",completed:"مكتمل",cancelled:"ملغي"}[t.status]||t.status}`})},onError:()=>{r({title:"خطأ",description:"فشل تحديث حالة الطلب",variant:"destructive"})}}),u=b({mutationFn:async({id:s,paymentStatus:t,paymentDetails:a})=>(await _("PATCH",`/api/orders/${s}/payment-status`,{paymentStatus:t,paymentDetails:a})).json(),onSuccess:()=>{j.invalidateQueries({queryKey:["/api/orders"]}),D(),p(!1),C(""),q(null),r({title:"تم التأكيد",description:"تم تحديث حالة الدفع بنجاح",variant:"default"})},onError:()=>{r({title:"خطأ",description:"فشل تحديث حالة الدفع",variant:"destructive"})}});d.useEffect(()=>{if(l&&o){const s=parseFloat(o),t=parseFloat(l.totalAmount);isNaN(s)||S(Math.max(0,s-t))}else S(0)},[o,l]);const ae=s=>{q(s),C(""),S(0),p(!0)},ne=()=>{if(!l)return;const s=parseFloat(o);if(isNaN(s)||s<parseFloat(l.totalAmount)){r({title:"خطأ",description:"المبلغ المدفوع أقل من إجمالي الطلب",variant:"destructive"});return}u.mutate({id:l.id,paymentStatus:"paid",paymentDetails:`نقدي - المستلم: ${s} ر.س - المرتجع: ${k.toFixed(2)} ر.س`})};if(!O)return null;const m=h.filter(s=>{if(w&&s.branchId!==w||v!=="all"&&s.status!==v)return!1;if(y.trim()){const t=y.toLowerCase(),a=(s.orderNumber||"").toLowerCase().includes(t),x=(s.customerInfo?.customerName||"").toLowerCase().includes(t),A=(s.customerInfo?.phoneNumber||"").includes(t);return a||x||A}return!0}),F=h.filter(s=>s.status==="pending").length,re=s=>{const a={pending:{label:"جديد",variant:"destructive"},payment_confirmed:{label:"تم الدفع",variant:"default"},confirmed:{label:"مؤكد",variant:"default"},in_progress:{label:"قيد التحضير",variant:"secondary"},ready:{label:"جاهز",variant:"success"},completed:{label:"مكتمل",variant:"outline"},cancelled:{label:"ملغي",variant:"outline"}}[s]||{label:s,variant:"outline"};return e.jsx(g,{variant:a.variant,children:a.label})};return e.jsxs("div",{className:"min-h-screen bg-background p-4",dir:"rtl",children:[e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center relative",children:[e.jsx(E,{className:"w-6 h-6 text-primary"}),F>0&&e.jsx("div",{className:"absolute -top-1 -right-1 w-6 h-6 bg-destructive rounded-full flex items-center justify-center animate-bounce",children:e.jsx("span",{className:"text-destructive-foreground text-xs font-bold",children:F})})]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-primary flex items-center gap-2","data-testid":"text-page-title",children:["إدارة الطلبات",F>0&&e.jsx(Se,{className:"w-5 h-5 text-destructive animate-pulse"})]}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["الموظف: ",O.fullName]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{variant:"outline",onClick:()=>D(),"data-testid":"button-refresh",children:[e.jsx(Ce,{className:`w-4 h-4 ml-2 ${I?"animate-spin":""}`}),"تحديث"]}),e.jsxs(n,{variant:"outline",onClick:()=>N("/employee/dashboard"),"data-testid":"button-back",children:[e.jsx(oe,{className:"w-4 h-4 ml-2"}),"العودة"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(L,{className:"font-semibold",children:"تصفية حسب الفرع:"}),e.jsxs(K,{value:w||"all",onValueChange:s=>ee(s==="all"?null:s),children:[e.jsx(Q,{className:"w-56","data-testid":"select-branch",children:e.jsx(H,{placeholder:"اختر فرع"})}),e.jsxs(U,{children:[e.jsx(c,{value:"all",children:"جميع الفروع"}),te.map(s=>e.jsx(c,{value:s.id,children:s.nameAr},s.id))]})]}),e.jsxs(n,{onClick:()=>{if(h.filter(t=>t.status==="ready").length===0){r({title:"لا توجد طلبات جاهزة"});return}confirm("هل تريد حقاً إكمال جميع الطلبات الجاهزة؟")&&P.mutate()},disabled:P.isPending,"data-testid":"button-complete-all",children:[P.isPending?e.jsx(f,{className:"w-4 h-4 ml-2 animate-spin"}):e.jsx($,{className:"w-4 h-4 ml-2"}),"إكمال الطلبات الجاهزة"]}),e.jsxs(n,{onClick:()=>{if(h.filter(t=>["pending","in_progress","ready"].includes(t.status)).length===0){r({title:"لا توجد طلبات لإلغائها"});return}confirm("هل تريد حقاً إلغاء جميع الطلبات المفتوحة؟")&&T.mutate()},variant:"destructive",disabled:T.isPending,"data-testid":"button-cancel-all",children:[T.isPending?e.jsx(f,{className:"w-4 h-4 ml-2 animate-spin"}):e.jsx(J,{className:"w-4 h-4 ml-2"}),"إلغاء كل الطلبات"]})]}),e.jsx(M,{children:e.jsxs(B,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground w-5 h-5"}),e.jsx(R,{placeholder:"بحث بالرقم أو اسم العميل أو الجوال...",value:y,onChange:s=>G(s.target.value),className:"pr-10 text-right","data-testid":"input-search"})]}),e.jsxs(K,{value:v,onValueChange:Z,children:[e.jsx(Q,{"data-testid":"select-status",children:e.jsx(H,{placeholder:"الحالة"})}),e.jsxs(U,{children:[e.jsx(c,{value:"all",children:"الكل"}),e.jsx(c,{value:"pending",children:"جديد"}),e.jsx(c,{value:"payment_confirmed",children:"تم الدفع"}),e.jsx(c,{value:"confirmed",children:"مؤكد"}),e.jsx(c,{value:"in_progress",children:"قيد التحضير"}),e.jsx(c,{value:"ready",children:"جاهز"}),e.jsx(c,{value:"completed",children:"مكتمل"}),e.jsx(c,{value:"cancelled",children:"ملغي"})]})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-5 gap-2 text-center",children:[e.jsxs("div",{className:"p-2 border rounded-md bg-background",children:[e.jsx("p",{className:"text-primary font-bold text-lg",children:m.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"إجمالي"})]}),e.jsxs("div",{className:"p-2 border rounded-md bg-background",children:[e.jsx("p",{className:"text-destructive font-bold text-lg",children:m.filter(s=>s.status==="pending"||s.status==="payment_confirmed").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"جديد"})]}),e.jsxs("div",{className:"p-2 border rounded-md bg-background",children:[e.jsx("p",{className:"text-primary font-bold text-lg",children:m.filter(s=>s.status==="in_progress").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"تحضير"})]}),e.jsxs("div",{className:"p-2 border rounded-md bg-background",children:[e.jsx("p",{className:"text-foreground font-bold text-lg",children:m.filter(s=>s.status==="ready").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"جاهز"})]}),e.jsxs("div",{className:"p-2 border rounded-md bg-background",children:[e.jsx("p",{className:"text-muted-foreground font-bold text-lg",children:m.filter(s=>s.status==="completed").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"مكتمل"})]})]})]})}),I&&e.jsxs("div",{className:"flex items-center justify-center py-10",children:[e.jsx(f,{className:"w-8 h-8 animate-spin text-primary"}),e.jsx("span",{className:"mr-3 text-muted-foreground",children:"جاري تحميل الطلبات..."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:!I&&m.length===0?e.jsxs("div",{className:"col-span-full text-center py-10 bg-card rounded-lg border border-dashed border-border",children:[e.jsx(E,{className:"w-12 h-12 text-muted-foreground/30 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد طلبات لعرضها حالياً"})]}):m.map(s=>{const t=s.id;return e.jsx(M,{className:"hover-elevate overflow-hidden","data-testid":`card-order-${t}`,children:e.jsxs(B,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-lg",children:["طلب #",s.orderNumber]}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground mt-1",children:[e.jsx(ue,{className:"w-3 h-3"}),s.createdAt?new Date(s.createdAt).toLocaleString("ar-SA"):"تاريخ غير معروف"]})]}),re(s.status)]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[s.tableNumber&&e.jsxs(g,{variant:"outline",className:"text-[10px]",children:[e.jsx(xe,{className:"w-3 h-3 ml-0.5"}),"طاولة ",s.tableNumber]}),s.orderType&&s.orderType!=="regular"&&e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(g,{variant:"secondary",className:"text-[10px] w-fit",children:s.orderType==="table"||s.orderType==="dine-in"?"محلي":s.orderType==="delivery"?"توصيل":s.orderType==="car_pickup"||s.orderType==="car-pickup"||s.orderType==="curbside"?"سيارة":s.orderType==="takeaway"?"سفري":s.orderType}),(s.orderType==="car_pickup"||s.orderType==="car-pickup"||s.orderType==="curbside")&&(s.carInfo?.carType||s.carInfo?.carColor||s.carInfo?.plateNumber||s.carType||s.carColor||s.plateNumber||s.carPlate)&&e.jsxs("div",{className:"flex flex-wrap gap-2 text-[10px] text-muted-foreground bg-muted/30 p-1.5 rounded-sm border border-border/50",children:[(s.carInfo?.carType||s.carType)&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"النوع:"})," ",s.carInfo?.carType||s.carType]}),(s.carInfo?.carColor||s.carColor)&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"اللون:"})," ",s.carInfo?.carColor||s.carColor]}),(s.carInfo?.plateNumber||s.plateNumber||s.carPlate)&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"اللوحة:"})," ",e.jsx("span",{className:"font-mono tracking-wider",children:s.carInfo?.plateNumber||s.plateNumber||s.carPlate})]})]})]}),s.customerInfo?.customerName&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-3 h-3"}),s.customerInfo.customerName]}),s.customerInfo?.phoneNumber&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"w-3 h-3"}),s.customerInfo.phoneNumber]})]}),e.jsx(V,{}),e.jsx("div",{className:"space-y-1",children:s.items?.map((a,x)=>{const A=a.unitPrice||a.price||a.coffeeItem?.price||0,le=a.nameAr||a.name||a.coffeeItem?.nameAr||a.coffeeItem?.name||"منتج";return e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:[le," x",a.quantity]}),e.jsxs("span",{className:"font-semibold",children:[(a.totalPrice||A*a.quantity).toFixed(2)," ر.س"]})]},x)})}),e.jsx(V,{}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-bold text-primary text-lg",children:["الإجمالي: ",Number(s.totalAmount).toFixed(2)," ر.س"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:s.paymentStatus==="paid"?"success":"outline",className:"text-[10px]",children:s.paymentStatus==="paid"?"مدفوع":"غير مدفوع"}),e.jsx("span",{className:"text-[10px] text-muted-foreground flex items-center gap-0.5",children:s.paymentMethod==="cash"?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"w-3 h-3"})," نقدي"]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-3 h-3"})," شبكة"]})})]})]}),e.jsxs("div",{className:"flex gap-1.5 flex-wrap pt-1",children:[s.status==="pending"&&e.jsxs(n,{size:"sm",onClick:()=>i.mutate({id:t,status:"in_progress"}),disabled:i.isPending,"data-testid":`button-start-${t}`,children:[e.jsx(W,{className:"w-3.5 h-3.5 ml-1"}),"بدء التحضير"]}),(s.status==="payment_confirmed"||s.status==="confirmed")&&e.jsxs(n,{size:"sm",onClick:()=>i.mutate({id:t,status:"in_progress"}),disabled:i.isPending,"data-testid":`button-start-confirmed-${t}`,children:[e.jsx(W,{className:"w-3.5 h-3.5 ml-1"}),"بدء التحضير"]}),s.status==="in_progress"&&e.jsxs(n,{size:"sm",onClick:()=>i.mutate({id:t,status:"ready"}),disabled:i.isPending,"data-testid":`button-ready-${t}`,children:[e.jsx($,{className:"w-3.5 h-3.5 ml-1"}),"جاهز للتسليم"]}),s.status==="ready"&&e.jsxs(n,{size:"sm",onClick:()=>i.mutate({id:t,status:"completed"}),disabled:i.isPending,"data-testid":`button-complete-${t}`,children:[e.jsx($,{className:"w-3.5 h-3.5 ml-1"}),"إكمال"]}),s.paymentStatus!=="paid"&&!["completed","cancelled"].includes(s.status)&&e.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{s.paymentMethod==="cash"?ae(s):u.mutate({id:t,paymentStatus:"paid"})},disabled:u.isPending,"data-testid":`button-confirm-payment-${t}`,children:[e.jsx(X,{className:"w-3.5 h-3.5 ml-1"}),"تأكيد الدفع"]}),["in_progress","ready","completed"].includes(s.status)&&e.jsx(n,{size:"icon",variant:"ghost",title:"رجوع للخطوة السابقة",onClick:()=>{const a=s.status==="in_progress"?"pending":s.status==="ready"?"in_progress":s.status==="completed"?"ready":"pending";confirm(`هل تريد العودة بحالة الطلب إلى "${{pending:"جديد",in_progress:"تحضير",ready:"جاهز"}[a]||a}"؟`)&&i.mutate({id:t,status:a})},"data-testid":`button-rollback-${t}`,children:e.jsx(ke,{className:"w-4 h-4"})}),["pending","in_progress","ready"].includes(s.status)&&e.jsx(n,{size:"icon",variant:"ghost",className:"text-destructive",title:"إلغاء الطلب",onClick:()=>{confirm("هل تريد حقاً إلغاء هذا الطلب؟")&&i.mutate({id:t,status:"cancelled"})},"data-testid":`button-cancel-${t}`,children:e.jsx(J,{className:"w-4 h-4"})})]})]})},t)})})]})}),e.jsx(je,{open:se,onOpenChange:p,children:e.jsxs(be,{className:"max-w-md",dir:"rtl",children:[e.jsxs(Ne,{className:"space-y-3 pb-4 border-b",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto",children:e.jsx(X,{className:"w-6 h-6 text-primary"})}),e.jsx(ye,{className:"text-2xl font-bold text-center",children:"تحصيل مبلغ نقدي"}),e.jsxs(ve,{className:"text-center",children:["طلب رقم #",l?.orderNumber]})]}),e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-primary/5 rounded-md border border-primary/10",children:[e.jsx("span",{className:"text-lg font-semibold",children:"المبلغ المطلوب:"}),e.jsxs("span",{className:"text-2xl font-black text-primary",children:[l?Number(l.totalAmount).toFixed(2):"0.00"," ر.س"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(L,{className:"text-lg font-bold",children:"المبلغ المستلم من العميل:"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{type:"number",placeholder:"0.00",value:o,onChange:s=>C(s.target.value),className:"text-2xl h-14 text-center font-bold border-2 border-primary/30 focus:border-primary transition-all rounded-md",autoFocus:!0,"data-testid":"input-received-amount"}),e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground font-bold",children:"ر.س"})]})]}),k>0&&e.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-md border-2 border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-bold text-green-800 dark:text-green-300",children:"المبلغ المتبقي للعميل:"}),e.jsxs("span",{className:"text-2xl font-black text-green-700 dark:text-green-400",children:[k.toFixed(2)," ر.س"]})]})})]}),e.jsxs(we,{className:"flex gap-3 mt-4",children:[e.jsx(n,{variant:"outline",onClick:()=>p(!1),className:"flex-1","data-testid":"button-cancel-cash",children:"إلغاء"}),e.jsx(n,{onClick:ne,disabled:u.isPending||!o||parseFloat(o)<(l?.totalAmount||0),className:"flex-1","data-testid":"button-confirm-cash",children:u.isPending?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4 ml-2 animate-spin"})," جاري الحفظ..."]}):"تأكيد واستلام"})]})]})})]})}export{Re as default};
