import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as x}from"./vendor-react-Bzsngnqy.js";import{c as q,B as P,V as M,C as n,x as i,y as h,f as c}from"./index-61RjstaY.js";import{a as v}from"./vendor-query-CX8ZYlKb.js";import{S as B,a as $,b as V,c as W,d as y}from"./select-BgcBxbEj.js";import{R as j,C as N,X as k,Y as w,T as f,L as A,B as I,N as R,a as X}from"./BarChart-C-BXurcz.js";import{L as Y,a as G}from"./LineChart-BOzbQhgh.js";import{P as H,a as Q}from"./PieChart-CcImm4lT.js";import{A as U}from"./arrow-up-DN6yfCj7.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-BsuQiE4E.js";const L=["#f97316","#fbbf24","#34d399","#60a5fa","#a78bfa","#f472b6"];function le(){q();const[p,F]=x.useState("month");x.useState("revenue");const{data:o=[]}=v({queryKey:["/api/orders"],queryFn:async()=>{const s=await fetch("/api/orders");if(!s.ok)throw new Error("Failed to fetch orders");return s.json()}}),{data:m=[]}=v({queryKey:["/api/employees"],queryFn:async()=>{const s=await fetch("/api/employees");if(!s.ok)throw new Error("Failed to fetch employees");return s.json()}}),{data:S=[]}=v({queryKey:["/api/coffee-items"],queryFn:async()=>{const s=await fetch("/api/coffee-items");if(!s.ok)throw new Error("Failed to fetch items");return s.json()}}),K=s=>{const r=new Date,d=[];if(s==="week")for(let t=6;t>=0;t--){const a=new Date(r);a.setDate(a.getDate()-t),d.push({date:a.toLocaleDateString("ar-SA",{weekday:"short"}),fullDate:a.toISOString().split("T")[0],revenue:0,orders:0})}else if(s==="month")for(let t=29;t>=0;t--){const a=new Date(r);a.setDate(a.getDate()-t);const l=a.getDate();(l<=7||l%7===0)&&d.push({date:`${l}`,fullDate:a.toISOString().split("T")[0],revenue:0,orders:0})}else for(let t=11;t>=0;t--){const a=new Date(r);a.setMonth(a.getMonth()-t),d.push({date:a.toLocaleDateString("ar-SA",{month:"short"}),fullDate:a.toISOString().split("T")[0],revenue:0,orders:0})}return d},D=x.useMemo(()=>{const s=K(p);return o.forEach(r=>{const d=new Date(r.createdAt).toISOString().split("T")[0],t=s.find(a=>a.fullDate===d||a.fullDate.startsWith(d.substring(0,7)));t&&(t.revenue=(t.revenue||0)+(r.totalAmount||0),t.orders=(t.orders||0)+1)}),s.slice(-10)},[o,p]),g=x.useMemo(()=>{const s={};return o.forEach(r=>{(Array.isArray(r.items)?r.items:[]).forEach(t=>{const a=t.coffeeItemId||t.id,l=S.find(T=>T.id===a);l&&(s[a]={name:l.nameAr,sold:(s[a]?.sold||0)+(t.quantity||1),revenue:(s[a]?.revenue||0)+(t.totalPrice||t.quantity*l.price||0)})})}),Object.values(s).sort((r,d)=>d.sold-r.sold).slice(0,6)},[o,S]),O=x.useMemo(()=>{const s={};return o.forEach(r=>{const d=r.employeeId||"unknown",t=m.find(a=>a.id===d);d!=="unknown"&&t&&(s[d]={name:t.fullName,orders:(s[d]?.orders||0)+1,revenue:(s[d]?.revenue||0)+(r.totalAmount||0)})}),Object.values(s).sort((r,d)=>d.revenue-r.revenue).slice(0,8)},[o,m]),C=o.reduce((s,r)=>s+(r.totalAmount||0),0),b=o.length,E=b>0?C/b:0,u=({label:s,value:r,trend:d,icon:t})=>e.jsx(n,{className:"border-0 bg-gradient-to-br from-card to-background dark:from-card dark:to-slate-800",children:e.jsxs(c,{className:"pt-6",children:[e.jsx("p",{className:"text-sm text-muted-foreground font-medium",children:s}),e.jsx("p",{className:"text-3xl font-bold mt-2",children:r}),d&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-emerald-600 dark:text-emerald-400 text-sm",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsxs("span",{children:[d,"% من الشهر الماضي"]})]})]})});return e.jsxs("div",{className:"p-6 space-y-8 bg-white dark:bg-background min-h-screen",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold",children:"التقارير والتحليلات"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"تحليل شامل لأداء المبيعات والعمليات"})]}),e.jsx("div",{className:"flex gap-3",children:e.jsxs(P,{variant:"outline","data-testid":"button-export-report",children:[e.jsx(M,{className:"w-4 h-4 ml-2"}),"تصدير"]})})]}),e.jsx("div",{className:"flex gap-3 flex-wrap",children:e.jsxs(B,{value:p,onValueChange:F,children:[e.jsx($,{className:"w-40","data-testid":"select-time-period",children:e.jsx(V,{})}),e.jsxs(W,{children:[e.jsx(y,{value:"week",children:"هذا الأسبوع"}),e.jsx(y,{value:"month",children:"هذا الشهر"}),e.jsx(y,{value:"year",children:"هذا العام"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(u,{label:"إجمالي الإيرادات",value:`${C.toFixed(0)} ر.س`,trend:"12"}),e.jsx(u,{label:"عدد الطلبات",value:b,trend:"8"}),e.jsx(u,{label:"متوسط الطلب",value:`${E.toFixed(2)} ر.س`,trend:"5"}),e.jsx(u,{label:"عدد الموظفين النشطين",value:m.filter(s=>s.isActivated===1).length})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"اتجاه الإيرادات"})}),e.jsx(c,{children:e.jsx(j,{width:"100%",height:300,children:e.jsxs(Y,{data:D,children:[e.jsx(N,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(k,{dataKey:"date",stroke:"hsl(var(--muted-foreground))"}),e.jsx(w,{stroke:"hsl(var(--muted-foreground))"}),e.jsx(f,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(A,{}),e.jsx(G,{type:"monotone",dataKey:"revenue",stroke:"#f97316",strokeWidth:2,dot:{fill:"#f97316",r:4},name:"الإيرادات (ر.س)"})]})})})]}),e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"عدد الطلبات اليومية"})}),e.jsx(c,{children:e.jsx(j,{width:"100%",height:300,children:e.jsxs(I,{data:D,children:[e.jsx(N,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(k,{dataKey:"date",stroke:"hsl(var(--muted-foreground))"}),e.jsx(w,{stroke:"hsl(var(--muted-foreground))"}),e.jsx(f,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(A,{}),e.jsx(R,{dataKey:"orders",fill:"#f97316",name:"الطلبات",radius:[8,8,0,0]})]})})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"أفضل المنتجات مبيعاً"})}),e.jsx(c,{children:e.jsx(j,{width:"100%",height:300,children:e.jsxs(I,{data:g,layout:"vertical",children:[e.jsx(N,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(k,{type:"number",stroke:"hsl(var(--muted-foreground))"}),e.jsx(w,{dataKey:"name",type:"category",width:80,stroke:"hsl(var(--muted-foreground))"}),e.jsx(f,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(R,{dataKey:"sold",fill:"#f97316",name:"المبيعات"})]})})})]}),e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"أداء الموظفين"})}),e.jsx(c,{children:e.jsx("div",{className:"space-y-4",children:O.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.orders," طلب"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-accent dark:text-accent",children:[s.revenue.toFixed(0)," ر.س"]})})]},r))})})]})]}),e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"توزيع المبيعات حسب الفئة"})}),e.jsx(c,{children:e.jsx(j,{width:"100%",height:400,children:e.jsxs(H,{children:[e.jsx(Q,{data:g,cx:"50%",cy:"50%",labelLine:!0,label:({name:s,sold:r})=>`${s}: ${r}`,outerRadius:120,fill:"#8884d8",dataKey:"sold",children:g.map((s,r)=>e.jsx(X,{fill:L[r%L.length]},`cell-${r}`))}),e.jsx(f,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}})]})})})]}),e.jsxs(n,{className:"border-0 bg-white dark:bg-card",children:[e.jsx(i,{className:"pb-4",children:e.jsx(h,{children:"تفاصيل الطلبات الأخيرة"})}),e.jsx(c,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-accent dark:border-accent/30",children:[e.jsx("th",{className:"text-right p-4 font-semibold",children:"رقم الطلب"}),e.jsx("th",{className:"text-right p-4 font-semibold",children:"العميل"}),e.jsx("th",{className:"text-right p-4 font-semibold",children:"الموظف"}),e.jsx("th",{className:"text-right p-4 font-semibold",children:"المبلغ"}),e.jsx("th",{className:"text-right p-4 font-semibold",children:"التاريخ"})]})}),e.jsx("tbody",{children:o.slice(-10).reverse().map(s=>{const r=m.find(d=>d.id===s.employeeId);return e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx("td",{className:"p-4",children:s.orderNumber}),e.jsx("td",{className:"p-4 text-muted-foreground",children:s.customerInfo?.name||"زائر"}),e.jsx("td",{className:"p-4",children:r?.fullName||"-"}),e.jsxs("td",{className:"p-4 font-bold text-accent dark:text-accent",children:[s.totalAmount?.toFixed(2)," ر.س"]}),e.jsx("td",{className:"p-4 text-muted-foreground",children:new Date(s.createdAt).toLocaleDateString("ar-SA")})]},s.id)})})]})})})]})]})}export{le as default};
