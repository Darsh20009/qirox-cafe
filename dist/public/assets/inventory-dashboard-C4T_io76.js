import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as l}from"./vendor-react-Bzsngnqy.js";import{a as Q,b as M}from"./vendor-query-CX8ZYlKb.js";import{e as ve,a5 as Ne,B as c,C as u,f as m,T as P,x as ye,X as we,I as f,aa as ke,ab as Ce,ac as z,a6 as Se,j as Ie,M as F,P as A,D as H,E as V,F as R,H as G,L as v,K as W,q as U,i as Le,v as X,N as C}from"./index-CLvpp2UE.js";import{P as qe}from"./progress-DVPXITZU.js";import{S as J,a as Y,b as Z,c as _,d as T}from"./select-BzAjeBJu.js";import{L as Qe}from"./layers-C7KZUnhu.js";import{P as ee}from"./package-plus-mC8EAJyD.js";import{P as te}from"./package-B_dGuXgn.js";import{B as Pe}from"./bell-BKcM2vGh.js";import{T as Fe}from"./trending-down-By0t33Hr.js";import{D as Ae}from"./dollar-sign-CFWcU9O3.js";import{B as Te}from"./box-BLG49O_d.js";import{W as De}from"./wrench-C4Y35z7Q.js";import{D as Oe}from"./droplet-DmibwVCE.js";import{C as Be}from"./circle-help-DJDmt5XW.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-CqdH-ack.js";const D={ingredient:{label:"مكون",icon:Le,color:"text-primary",bgColor:"bg-muted"},packaging:{label:"تغليف",icon:Te,color:"text-primary",bgColor:"bg-muted"},equipment:{label:"معدات",icon:De,color:"text-muted-foreground",bgColor:"bg-muted"},consumable:{label:"مستهلكات",icon:Oe,color:"text-primary",bgColor:"bg-muted"},other:{label:"أخرى",icon:Be,color:"text-muted-foreground",bgColor:"bg-muted"}},se={kg:"كيلو",g:"جرام",liter:"لتر",ml:"مل",piece:"قطعة",box:"صندوق",bag:"كيس"};function st(){const{toast:o}=ve(),[N,ae]=l.useState(""),[S,re]=l.useState("all"),[a,ne]=l.useState("all"),[le,y]=l.useState(!1),[ce,w]=l.useState(!1),[h,de]=l.useState(null),[g,j]=l.useState(0),[p,ie]=l.useState("add"),[n,b]=l.useState({rawItemId:"",quantity:0,unitCost:0,notes:""}),{data:x=[],isLoading:oe}=Q({queryKey:["/api/inventory/raw-items"]}),{data:xe=[],isLoading:ue}=Q({queryKey:["/api/inventory/branch-stocks",a],queryFn:async()=>{const t=new URLSearchParams;a!=="all"&&t.append("branchId",a);const s=`/api/inventory/branch-stocks${t.toString()?`?${t}`:""}`,r=await fetch(s,{credentials:"include"});if(!r.ok)throw new Error("Failed to fetch branch stocks");return r.json()}}),{data:me=[]}=Q({queryKey:["/api/branches"]}),I=M({mutationFn:async t=>X("POST","/api/inventory/stock-adjustment",t),onSuccess:()=>{C.invalidateQueries({queryKey:["/api/inventory/branch-stocks",a]}),C.invalidateQueries({queryKey:["/api/inventory/dashboard"]}),w(!1),j(0),o({title:"تم تعديل المخزون بنجاح"})},onError:t=>{o({title:t.message||"فشل في تعديل المخزون",variant:"destructive"})}}),L=M({mutationFn:async t=>X("POST","/api/inventory/stock-batch",t),onSuccess:()=>{C.invalidateQueries({queryKey:["/api/inventory/branch-stocks",a]}),C.invalidateQueries({queryKey:["/api/inventory/dashboard"]}),y(!1),b({rawItemId:"",quantity:0,unitCost:0,notes:""}),o({title:"تمت إضافة الدفعة بنجاح"})},onError:t=>{o({title:t.message||"فشل في إضافة الدفعة",variant:"destructive"})}}),k=t=>xe.find(s=>s.rawItemId===t),he=(t,s)=>{const r=s?.currentQuantity||0,d=t.minStockLevel||0,i=t.maxStockLevel||d*3;return r<=0?{status:"out",label:"نفد",color:"bg-destructive",textColor:"text-destructive"}:r<=d?{status:"low",label:"منخفض",color:"bg-background0",textColor:"text-accent dark:text-accent"}:r>=i*.8?{status:"high",label:"مرتفع",color:"bg-green-500",textColor:"text-green-600 dark:text-green-400"}:{status:"normal",label:"طبيعي",color:"bg-primary",textColor:"text-primary"}},ge=(t,s)=>{const r=s?.currentQuantity||0,d=t.maxStockLevel||t.minStockLevel*3||100;return Math.min(100,r/d*100)},O=x.filter(t=>{const s=t.nameAr.toLowerCase().includes(N.toLowerCase())||t.code.toLowerCase().includes(N.toLowerCase())||(t.nameEn?.toLowerCase().includes(N.toLowerCase())??!1),r=S==="all"||t.category===S;return s&&r}),je=x.length,B=x.filter(t=>{const s=k(t.id);return(s?.currentQuantity||0)<=t.minStockLevel&&(s?.currentQuantity||0)>0}).length,$=x.filter(t=>(k(t.id)?.currentQuantity||0)<=0).length,pe=x.reduce((t,s)=>{const r=k(s.id);return t+(r?.currentQuantity||0)*s.unitCost},0),E=(t,s)=>{de(t),ie(s),j(1),w(!0)},be=()=>{if(!h||!a||a==="all"){o({title:"يرجى اختيار الفرع أولاً",variant:"destructive"});return}I.mutate({rawItemId:h.id,branchId:a,quantity:g,type:p})},fe=()=>{if(!n.rawItemId||!a||a==="all"){o({title:"يرجى اختيار الفرع والمادة أولاً",variant:"destructive"});return}L.mutate({...n,branchId:a})};return oe||ue?e.jsx("div",{dir:"rtl",children:e.jsx(Ne,{message:"جاري تحميل المخزون..."})}):e.jsxs("div",{className:"p-6 space-y-6 bg-background",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-4 rounded-2xl bg-primary/10 shadow-lg",children:e.jsx(Qe,{className:"h-10 w-10 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold font-playfair text-foreground",children:"لوحة تحكم المخزون"}),e.jsx("p",{className:"text-muted-foreground",children:"إدارة ذكية ومبسطة للمخزون"})]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(J,{value:a,onValueChange:ne,children:[e.jsx(Y,{className:"w-[180px]","data-testid":"select-branch",children:e.jsx(Z,{placeholder:"اختر الفرع"})}),e.jsxs(_,{children:[e.jsx(T,{value:"all",children:"جميع الفروع"}),me.map(t=>e.jsx(T,{value:t.id||"",children:t.nameAr},t.id))]})]}),e.jsxs(c,{onClick:()=>y(!0),"data-testid":"button-add-stock-batch",children:[e.jsx(ee,{className:"h-4 w-4 ml-2"}),"دفعة جديدة"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(u,{className:"border-0 shadow-lg bg-card",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"إجمالي المواد"}),e.jsx("p",{className:"text-4xl font-bold font-playfair text-foreground","data-testid":"text-total-items",children:je})]}),e.jsx("div",{className:"p-3 rounded-full bg-primary/10",children:e.jsx(te,{className:"h-8 w-8 text-primary"})})]})})}),e.jsx(u,{className:"border-0 shadow-lg bg-card",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"مخزون منخفض"}),e.jsx("p",{className:"text-4xl font-bold text-accent dark:text-accent","data-testid":"text-low-stock",children:B}),B>0&&e.jsxs("p",{className:"text-xs text-accent dark:text-accent mt-1 flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3 w-3"}),"يحتاج إعادة طلب"]})]}),e.jsx("div",{className:"p-3 rounded-full bg-accent dark:bg-accent/30",children:e.jsx(Fe,{className:"h-8 w-8 text-accent dark:text-accent"})})]})})}),e.jsx(u,{className:"border-0 shadow-lg bg-card",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"نفد المخزون"}),e.jsx("p",{className:"text-4xl font-bold text-destructive","data-testid":"text-out-stock",children:$}),$>0&&e.jsxs("p",{className:"text-xs text-destructive mt-1 flex items-center gap-1",children:[e.jsx(P,{className:"h-3 w-3"}),"عاجل - أضف مخزون"]})]}),e.jsx("div",{className:"p-3 rounded-full bg-destructive/10",children:e.jsx(P,{className:"h-8 w-8 text-destructive"})})]})})}),e.jsx(u,{className:"border-0 shadow-lg bg-card",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"قيمة المخزون (COGS)"}),e.jsxs("p",{className:"text-3xl font-bold text-green-600 dark:text-green-400","data-testid":"text-cogs",children:[pe.toFixed(0),e.jsx("span",{className:"text-lg mr-1",children:"ر.س"})]})]}),e.jsx("div",{className:"p-3 rounded-full bg-green-100 dark:bg-green-900/30",children:e.jsx(Ae,{className:"h-8 w-8 text-green-600 dark:text-green-400"})})]})})})]}),e.jsxs(u,{className:"border-0 shadow-lg bg-card",children:[e.jsx(ye,{className:"bg-muted/50 border-b",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(we,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground"}),e.jsx(f,{placeholder:"بحث بالاسم أو الكود...",value:N,onChange:t=>ae(t.target.value),className:"pr-12 h-12 text-lg rounded-xl","data-testid":"input-search"})]}),e.jsx(ke,{value:S,onValueChange:re,className:"w-auto",children:e.jsxs(Ce,{className:"bg-muted/50 p-1 rounded-xl",children:[e.jsx(z,{value:"all",className:"rounded-lg px-4",children:"الكل"}),Object.entries(D).map(([t,{label:s}])=>e.jsx(z,{value:t,className:"rounded-lg px-3",children:s},t))]})})]})}),e.jsx(m,{className:"p-6",children:O.length===0?e.jsx(Se,{title:"لا توجد مواد",description:"أضف مواد خام جديدة للبدء",icon:e.jsx(te,{className:"h-10 w-10 text-muted-foreground"})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:O.map(t=>{const s=D[t.category]||D.other,r=s.icon,d=k(t.id),i=he(t,d),K=ge(t,d),q=d?.currentQuantity||0;return e.jsx(u,{className:"border-0 shadow-md transition-all duration-300 overflow-visible bg-card","data-testid":`card-item-${t.id}`,children:e.jsxs(m,{className:"p-0",children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2.5 rounded-xl bg-muted ${s.color}`,children:e.jsx(r,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg leading-tight text-foreground",children:t.nameAr}),e.jsx("code",{className:"text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:t.code})]})]}),e.jsx(Ie,{variant:"outline",className:`${i.textColor} border-current shrink-0`,children:i.label})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-3xl font-bold font-playfair text-foreground","data-testid":`text-qty-${t.id}`,children:q.toFixed(q<1?3:1)}),e.jsx("span",{className:"text-muted-foreground text-lg",children:se[t.unit]||t.unit})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsxs("span",{children:["الحد الأدنى: ",t.minStockLevel]}),e.jsxs("span",{children:[K.toFixed(0),"%"]})]}),e.jsx(qe,{value:K,className:"h-2"})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"التكلفة: "}),e.jsxs("span",{className:"font-semibold text-foreground",children:[t.unitCost.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{size:"icon",variant:"outline",onClick:()=>E(t,"subtract"),disabled:q<=0,"data-testid":`button-minus-${t.id}`,children:e.jsx(F,{className:"h-4 w-4"})}),e.jsx(c,{size:"icon",variant:"outline",onClick:()=>E(t,"add"),"data-testid":`button-plus-${t.id}`,children:e.jsx(A,{className:"h-4 w-4"})})]})]})]})]}),(i.status==="low"||i.status==="out")&&e.jsxs("div",{className:`px-4 py-2 flex items-center gap-2 text-sm ${i.status==="out"?"bg-destructive/10 text-destructive":"bg-accent dark:bg-accent/20 text-accent dark:text-accent"}`,children:[e.jsx(P,{className:"h-4 w-4"}),i.status==="out"?"نفد المخزون - يرجى إعادة التعبئة":"المخزون منخفض - يرجى الطلب"]})]})},t.id)})})})]}),e.jsx(H,{open:ce,onOpenChange:w,children:e.jsxs(V,{className:"max-w-md",dir:"rtl",children:[e.jsx(R,{children:e.jsxs(G,{className:"flex items-center gap-2",children:[p==="add"?e.jsx(A,{className:"h-5 w-5 text-green-600"}):e.jsx(F,{className:"h-5 w-5 text-destructive"}),p==="add"?"إضافة كمية":"خصم كمية"," - ",h?.nameAr]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"الكمية"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(c,{size:"icon",variant:"outline",onClick:()=>j(Math.max(0,g-1)),"data-testid":"button-qty-decrease",children:e.jsx(F,{className:"h-4 w-4"})}),e.jsx(f,{type:"number",value:g,onChange:t=>j(parseFloat(t.target.value)||0),className:"text-center text-2xl font-bold h-14",min:0,step:.1,"data-testid":"input-adjust-qty"}),e.jsx(c,{size:"icon",variant:"outline",onClick:()=>j(g+1),"data-testid":"button-qty-increase",children:e.jsx(A,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-center text-muted-foreground",children:se[h?.unit||""]||h?.unit})]}),a==="all"&&e.jsx("div",{className:"p-3 rounded-lg bg-muted border border-border",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"يرجى اختيار فرع محدد لتعديل المخزون"})})]}),e.jsxs(W,{className:"gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>w(!1),children:"إلغاء"}),e.jsxs(c,{onClick:be,disabled:I.isPending||a==="all"||g<=0,variant:p==="add"?"default":"destructive","data-testid":"button-confirm-adjust",children:[I.isPending&&e.jsx(U,{className:"h-4 w-4 animate-spin ml-2"}),p==="add"?"إضافة":"خصم"]})]})]})}),e.jsx(H,{open:le,onOpenChange:y,children:e.jsxs(V,{className:"max-w-lg",dir:"rtl",children:[e.jsx(R,{children:e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5 text-primary"}),"إضافة دفعة مخزون جديدة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"المادة الخام"}),e.jsxs(J,{value:n.rawItemId,onValueChange:t=>b(s=>({...s,rawItemId:t})),children:[e.jsx(Y,{"data-testid":"select-raw-item",children:e.jsx(Z,{placeholder:"اختر المادة"})}),e.jsx(_,{children:x.map(t=>e.jsxs(T,{value:t.id,children:[t.nameAr," (",t.code,")"]},t.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"الكمية"}),e.jsx(f,{type:"number",value:n.quantity||"",onChange:t=>b(s=>({...s,quantity:parseFloat(t.target.value)||0})),placeholder:"0",min:0,step:.1,"data-testid":"input-batch-qty"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"تكلفة الوحدة (ر.س)"}),e.jsx(f,{type:"number",value:n.unitCost||"",onChange:t=>b(s=>({...s,unitCost:parseFloat(t.target.value)||0})),placeholder:"0.00",min:0,step:.01,"data-testid":"input-batch-cost"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"ملاحظات (اختياري)"}),e.jsx(f,{value:n.notes,onChange:t=>b(s=>({...s,notes:t.target.value})),placeholder:"ملاحظات إضافية...","data-testid":"input-batch-notes"})]}),a==="all"&&e.jsx("div",{className:"p-3 rounded-lg bg-muted border border-border",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"يرجى اختيار فرع محدد لإضافة دفعة المخزون"})}),n.quantity>0&&n.unitCost>0&&e.jsx("div",{className:"p-4 rounded-lg bg-green-100 dark:bg-green-900/20 border border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-green-700 dark:text-green-300",children:"إجمالي التكلفة:"}),e.jsxs("span",{className:"text-xl font-bold text-green-700 dark:text-green-300",children:[(n.quantity*n.unitCost).toFixed(2)," ر.س"]})]})})]}),e.jsxs(W,{className:"gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>y(!1),children:"إلغاء"}),e.jsxs(c,{onClick:fe,disabled:L.isPending||a==="all"||!n.rawItemId||n.quantity<=0,"data-testid":"button-confirm-batch",children:[L.isPending&&e.jsx(U,{className:"h-4 w-4 animate-spin ml-2"}),"إضافة الدفعة"]})]})]})})]})}export{st as default};
