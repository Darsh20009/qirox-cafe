import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as f}from"./vendor-react-Bzsngnqy.js";import{a as B,b as S}from"./vendor-query-CX8ZYlKb.js";import{c as M,e as R,O as w,C as h,x as q,y as F,W as H,f as g,B as d,L as U,af as z,r as P,ab as V,ac as J,ad as k,aj as _,a6 as K,a7 as T,j as Q,U as Y,p as W,o as X,i as G,A as Z,v as L,N as ee}from"./index-61RjstaY.js";import{S as se}from"./switch-BuAF3IBh.js";import{P as te}from"./package-equujGSd.js";import{C as ae}from"./circle-check-big-v7jPXABl.js";import{R as le}from"./refresh-cw-DWvJTizr.js";import{B as O}from"./bike-C158SMck.js";import{C as ie}from"./car-CvS9-SS_.js";import{N as ne}from"./navigation-DLyCnKEJ.js";import{C as re}from"./circle-x-D9GYVDcC.js";import"./vendor-utils-BKCsaWdX.js";const ce={pending:{label:"في الانتظار",color:"bg-yellow-500"},assigned:{label:"تم التعيين",color:"bg-blue-500"},accepted:{label:"تم القبول",color:"bg-indigo-500"},picked_up:{label:"تم الاستلام",color:"bg-purple-500"},on_the_way:{label:"في الطريق",color:"bg-orange-500"},delivered:{label:"تم التوصيل",color:"bg-green-500"},cancelled:{label:"ملغي",color:"bg-red-500"}},de={motorcycle:O,car:ie,bicycle:O};function ye(){const[,t]=M(),[a,o]=f.useState(null),[c,n]=f.useState(!1),[m,b]=f.useState("active"),{toast:x}=R();f.useEffect(()=>{document.title="بوابة المندوب - CLUNY SYSTEMS";const s=localStorage.getItem("currentDriver");if(s){const l=JSON.parse(s);o(l),n(l.status==="available")}},[]);const{data:u,isLoading:i,refetch:r}=B({queryKey:["/api/delivery/orders/driver",a?.id],enabled:!!a}),N=S({mutationFn:async({orderId:s,status:l})=>L("PATCH",`/api/delivery/orders/${s}/status`,{status:l}),onSuccess:()=>{ee.invalidateQueries({queryKey:["/api/delivery/orders/driver"]}),r(),x({title:"تم التحديث",description:"تم تحديث حالة الطلب"})},onError:()=>{x({title:"خطأ",description:"فشل في تحديث الحالة",variant:"destructive"})}}),A=S({mutationFn:async s=>{const l=a?.id;return L("PATCH",`/api/delivery/drivers/${l}/status`,{status:s})},onSuccess:(s,l)=>{if(n(l==="available"),a){const C={...a,status:l};o(C),localStorage.setItem("currentDriver",JSON.stringify(C))}x({title:l==="available"?"أنت متصل الآن":"أنت غير متصل",description:l==="available"?"يمكنك استلام طلبات جديدة":"لن تستلم طلبات جديدة"})}}),y=(s,l)=>{N.mutate({orderId:s,status:l})},$=s=>{A.mutate(s?"available":"offline")},E=()=>{localStorage.removeItem("currentDriver"),t("/driver/login")},v=u?.orders||[],p=v.filter(s=>!["delivered","cancelled"].includes(s.status)),j=v.filter(s=>["delivered","cancelled"].includes(s.status)),I=a?.vehicleType?de[a.vehicleType]||w:w;return a?e.jsxs("div",{className:"min-h-screen bg-background",dir:"rtl",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-card border-b border-border shadow-sm",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(I,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-foreground",children:a.fullName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.phone})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{id:"online-status",checked:c,onCheckedChange:$,"data-testid":"switch-online-status"}),e.jsx(U,{htmlFor:"online-status",className:"text-sm",children:c?e.jsx("span",{className:"text-green-600 font-medium",children:"متصل"}):e.jsx("span",{className:"text-muted-foreground",children:"غير متصل"})})]}),e.jsx(d,{variant:"ghost",size:"icon",onClick:E,"data-testid":"button-logout",children:e.jsx(z,{className:"w-5 h-5"})})]})]})})}),e.jsxs("main",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsx(h,{className:"bg-blue-50 dark:bg-blue-950/20",children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx(te,{className:"w-8 h-8 mx-auto text-blue-600 mb-2"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:p.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"طلبات نشطة"})]})}),e.jsx(h,{className:"bg-green-50 dark:bg-green-950/20",children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx(ae,{className:"w-8 h-8 mx-auto text-green-600 mb-2"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:j.filter(s=>s.status==="delivered").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"تم التوصيل"})]})}),e.jsx(h,{className:"bg-orange-50 dark:bg-orange-950/20",children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx(P,{className:"w-8 h-8 mx-auto text-orange-600 mb-2"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:v.filter(s=>s.status==="on_the_way").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"في الطريق"})]})})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"الطلبات"}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>r(),"data-testid":"button-refresh",children:[e.jsx(le,{className:"w-4 h-4 ml-2"}),"تحديث"]})]}),e.jsxs(V,{value:m,onValueChange:b,children:[e.jsxs(J,{className:"grid w-full grid-cols-2 mb-4",children:[e.jsxs(k,{value:"active",children:["نشطة (",p.length,")"]}),e.jsxs(k,{value:"completed",children:["مكتملة (",j.length,")"]})]}),e.jsx(_,{value:"active",className:"space-y-4",children:i?e.jsx(K,{}):p.length===0?e.jsx(T,{title:"لا توجد طلبات نشطة",description:c?"انتظر طلبات جديدة":"قم بتفعيل حالة الاتصال لاستلام الطلبات"}):p.map(s=>e.jsx(D,{order:s,onStatusChange:y,isPending:N.isPending},s.id))}),e.jsx(_,{value:"completed",className:"space-y-4",children:j.length===0?e.jsx(T,{title:"لا توجد طلبات مكتملة",description:"ستظهر هنا الطلبات المكتملة"}):j.slice(0,20).map(s=>e.jsx(D,{order:s,onStatusChange:y,isPending:N.isPending,isCompleted:!0},s.id))})]})]})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",dir:"rtl",children:e.jsxs(h,{className:"w-full max-w-md",children:[e.jsxs(q,{className:"text-center",children:[e.jsx(w,{className:"w-16 h-16 mx-auto text-primary mb-4"}),e.jsx(F,{children:"بوابة المندوب"}),e.jsx(H,{children:"يرجى تسجيل الدخول للمتابعة"})]}),e.jsx(g,{children:e.jsx(d,{className:"w-full",onClick:()=>t("/driver/login"),"data-testid":"button-driver-login",children:"تسجيل الدخول"})})]})})}function D({order:t,onStatusChange:a,isPending:o,isCompleted:c=!1}){const n=t.id||"",m=ce[t.status]||{label:t.status,color:"bg-gray-500"},b=i=>({assigned:"accepted",accepted:"picked_up",picked_up:"on_the_way",on_the_way:"delivered"})[i]||null,x=i=>({accepted:"قبول الطلب",picked_up:"تم الاستلام",on_the_way:"بدء التوصيل",delivered:"تم التوصيل"})[i]||i,u=b(t.status);return e.jsxs(h,{className:`overflow-hidden ${c?"opacity-75":""}`,children:[e.jsx("div",{className:`h-1 ${m.color}`}),e.jsxs(g,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-bold text-lg",children:["طلب #",t.orderNumber||n.slice(-6)]}),e.jsx(Q,{className:`${m.color} text-white`,children:m.label})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:new Date(t.createdAt).toLocaleString("ar-SA")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-primary text-lg",children:[t.totalAmount?.toFixed(2)," ر.س"]}),t.estimatedMinutes&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(P,{className:"w-3 h-3"}),t.estimatedMinutes," دقيقة"]})]})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Y,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:t.customerName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(W,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("a",{href:`tel:${t.customerPhone}`,className:"text-primary hover:underline",children:t.customerPhone})]}),e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx(X,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsx("span",{className:"flex-1",children:t.customerAddress})]})]}),t.items&&t.items.length>0&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 mb-4",children:[e.jsxs("p",{className:"text-sm font-medium mb-2 flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"}),"المنتجات"]}),e.jsx("div",{className:"space-y-1",children:t.items.map((i,r)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:i.name}),e.jsxs("span",{className:"text-muted-foreground",children:["×",i.quantity]})]},r))})]}),!c&&e.jsxs("div",{className:"flex gap-2",children:[t.customerLocation&&e.jsxs(d,{variant:"outline",className:"flex-1",onClick:()=>{const{lat:i,lng:r}=t.customerLocation;window.open(`https://www.google.com/maps/dir/?api=1&destination=${i},${r}`,"_blank")},"data-testid":`button-navigate-${n}`,children:[e.jsx(ne,{className:"w-4 h-4 ml-2"}),"الملاحة"]}),u&&e.jsxs(d,{className:"flex-1",onClick:()=>a(n,u),disabled:o,"data-testid":`button-next-status-${n}`,children:[x(u),e.jsx(Z,{className:"w-4 h-4 mr-2"})]}),t.status==="assigned"&&e.jsx(d,{variant:"destructive",onClick:()=>a(n,"cancelled"),disabled:o,"data-testid":`button-cancel-${n}`,children:e.jsx(re,{className:"w-4 h-4"})})]})]})]})}export{ye as default};
