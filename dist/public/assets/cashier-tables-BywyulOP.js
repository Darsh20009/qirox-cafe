import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as l}from"./vendor-react-Bzsngnqy.js";import{a as m,b as g}from"./vendor-query-CX8ZYlKb.js";import{c as ne,e as ie,C as u,x as z,y as M,f as h,B as o,A as ce,j as d,r as le,k as Q,U as oe,p as de,a1 as me,D as ue,E as he,F as xe,H as pe,J as ge,L as v,I as j,N as f}from"./index-CLvpp2UE.js";import{S as ve,a as je,b as fe,c as be,d as Ne}from"./select-BzAjeBJu.js";import{C as ye}from"./circle-x-B1Jm2Zh7.js";import{C as we}from"./circle-check-CNDbPLNF.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-CqdH-ack.js";function $e(){const[,O]=ne(),{toast:a}=ie(),[b,T]=l.useState(null),[H,x]=l.useState(!1),[N,y]=l.useState(""),[p,w]=l.useState(""),[E,S]=l.useState("2"),[k,D]=l.useState(""),[n,$]=l.useState(""),[i,P]=l.useState("");l.useEffect(()=>{const s=localStorage.getItem("currentEmployee");if(s){const t=JSON.parse(s);t.branchId?$(t.branchId):t.id&&fetch(`/api/employees/${t.id}`,{credentials:"include"}).then(r=>r.json()).then(r=>{if(r.branchId){$(r.branchId);const c={...t,branchId:r.branchId};localStorage.setItem("currentEmployee",JSON.stringify(c))}}).catch(r=>console.error("Failed to fetch employee:",r))}},[]),m({queryKey:["/api/branches"]});const{data:C=[],isLoading:U}=m({queryKey:["/api/tables",i||n],queryFn:async()=>{const s=i||n,t=await fetch(`/api/tables?branchId=${s}`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch tables");const r=await t.json();return Array.isArray(r)?r.filter(c=>c.branchId===s):[]},enabled:!!(i||n),refetchInterval:5e3}),{data:V=[]}=m({queryKey:["/api/orders/table/pending"],queryFn:async()=>{const s=await fetch("/api/orders/table/pending");if(!s.ok)throw new Error("Failed to fetch orders");const t=await s.json();return Array.isArray(t)?t:[]},refetchInterval:5e3}),{data:X}=m({queryKey:["/api/branches",i||n],queryFn:async()=>{const t=await fetch(`/api/branches/${i||n}`);if(!t.ok)throw new Error("Failed to fetch branch");return t.json()},enabled:!!(i||n)}),q=g({mutationFn:async({tableId:s,customerName:t,customerPhone:r,numberOfGuests:c,reservationDateTime:I})=>{const G=localStorage.getItem("currentEmployee"),se=G?JSON.parse(G):null,L=new Date(I),te=L.toISOString(),re=L.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),F=await fetch(`/api/tables/${s}/reserve`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerName:t,customerPhone:r,numberOfGuests:c,reservationDate:te,reservationTime:re,employeeId:se?.id})});if(!F.ok){const ae=await F.json();throw new Error(ae.error||"Failed to reserve table")}return F.json()},onSuccess:()=>{f.refetchQueries({queryKey:["/api/tables",n]}),a({title:"تم حجز الطاولة",description:"تم حجز الطاولة بنجاح"}),x(!1),y(""),w(""),S("2"),D(""),T(null)},onError:s=>{a({title:"خطأ",description:s.message||"فشل حجز الطاولة",variant:"destructive"})}}),W=g({mutationFn:async s=>{const t=localStorage.getItem("currentEmployee"),r=t?JSON.parse(t):null,c=await fetch(`/api/tables/${s}/release`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employeeId:r?.id})});if(!c.ok){const I=await c.json();throw new Error(I.error||"Failed to release table")}return c.json()},onSuccess:()=>{f.refetchQueries({queryKey:["/api/tables"]}),a({title:"تم تحرير الطاولة",description:"الطاولة متاحة الآن"})},onError:s=>{a({title:"خطأ",description:s.message||"فشل تحرير الطاولة",variant:"destructive"})}}),A=g({mutationFn:async s=>{const t=await fetch(`/api/tables/${s}/approve-reservation`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){const r=await t.json();throw new Error(r.error||"Failed to approve reservation")}return t.json()},onSuccess:()=>{f.refetchQueries({queryKey:["/api/tables",n]}),a({title:"تم تفعيل الحجز",description:"تم تفعيل الحجز بنجاح"})},onError:s=>{a({title:"خطأ",description:s.message||"فشل تفعيل الحجز",variant:"destructive"})}}),K=g({mutationFn:async s=>{const t=await fetch(`/api/tables/${s}/cancel-reservation`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){const r=await t.json();throw new Error(r.error||"Failed to cancel reservation")}return t.json()},onSuccess:()=>{f.refetchQueries({queryKey:["/api/tables",n]}),a({title:"تم إلغاء الحجز",description:"تم إلغاء الحجز بنجاح"})},onError:s=>{a({title:"خطأ",description:s.message||"فشل إلغاء الحجز",variant:"destructive"})}}),Y=s=>{T(s),x(!0)},Z=s=>{window.confirm(`هل أنت متأكد من تحرير الطاولة ${s.tableNumber}؟`)&&W.mutate(s.id)},_=()=>{if(!b)return;if(!N.trim()){a({title:"خطأ",description:"الرجاء إدخال اسم العميل",variant:"destructive"});return}if(!p.trim()||p.length<9){a({title:"خطأ",description:"الرجاء إدخال رقم جوال صحيح",variant:"destructive"});return}const s=parseInt(E);if(isNaN(s)||s<1||s>20){a({title:"عدد غير صحيح",description:"الرجاء إدخال عدد صحيح من الضيوف (1-20)",variant:"destructive"});return}if(!k){a({title:"خطأ",description:"الرجاء اختيار الميعاد",variant:"destructive"});return}q.mutate({tableId:b.id,customerName:N.trim(),customerPhone:p.trim(),numberOfGuests:s,reservationDateTime:k})},{data:ee=[]}=m({queryKey:["/api/branches"]}),R=localStorage.getItem("currentEmployee"),J=R?JSON.parse(R):null,B=J?.role==="admin"||J?.role==="owner";return!n&&!B?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",dir:"rtl",children:e.jsxs(u,{className:"max-w-md",children:[e.jsx(z,{children:e.jsx(M,{children:"خطأ"})}),e.jsx(h,{children:e.jsx("p",{children:"لم يتم تعيينك لفرع معين. يرجى التواصل مع المدير."})})]})}):B&&!i?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-amber-50 via-primary/5 to-amber-100 flex items-center justify-center p-4",dir:"rtl",children:e.jsxs(u,{className:"max-w-md",children:[e.jsx(z,{children:e.jsx(M,{children:"اختر الفرع"})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs(ve,{value:i,onValueChange:P,children:[e.jsx(je,{className:"w-full",children:e.jsx(fe,{placeholder:"اختر الفرع"})}),e.jsx(be,{children:ee.map(s=>e.jsx(Ne,{value:s.id,children:s.nameAr},s.id))})]}),e.jsx(o,{onClick:()=>P(i),className:"w-full",disabled:!i,children:"متابعة"})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-amber-50 via-primary/5 to-amber-100",dir:"rtl",children:e.jsxs("div",{className:"max-w-7xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-accent",children:"إدارة الطاولات"}),e.jsxs("p",{className:"text-accent",children:[X?.nameAr||"تحميل..."," • ",C.length," طاولة"]})]}),e.jsxs(o,{variant:"ghost",onClick:()=>O("/employee/dashboard"),"data-testid":"button-back",children:[e.jsx(ce,{className:"ml-2 h-5 w-5"}),"العودة"]})]}),e.jsx(u,{className:"bg-white/80 backdrop-blur",children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-wrap gap-6 justify-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-emerald-500"}),e.jsx(d,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"متاحة"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"جاهزة للحجز"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsx(d,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",children:"محجوزة"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"بها عميل حالياً"})]})]})})}),U?e.jsx("div",{className:"text-center py-12",children:e.jsx("div",{className:"text-lg text-accent",children:"جاري التحميل..."})}):C.length===0?e.jsx(u,{className:"bg-white/80 backdrop-blur",children:e.jsx(h,{className:"py-12 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"لا توجد طاولات في هذا الفرع. يرجى التواصل مع المدير."})})}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:C.map(s=>e.jsx(u,{className:`hover-elevate cursor-pointer transition-all duration-300 transform hover:scale-105 ${s.isOccupied?"bg-gradient-to-br from-red-100 via-red-50 to-orange-100 border-2 border-red-400 shadow-lg shadow-red-200/50 dark:from-red-900 dark:via-red-950 dark:to-orange-900":"bg-gradient-to-br from-emerald-100 via-green-50 to-teal-100 border-2 border-emerald-400 shadow-lg shadow-emerald-200/50 dark:from-emerald-900 dark:via-green-950 dark:to-teal-900"}`,"data-testid":`card-table-${s.tableNumber}`,children:e.jsxs(h,{className:"p-4 sm:p-6 text-center space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`text-4xl sm:text-5xl font-bold ${s.isOccupied?"text-red-700 dark:text-red-300":"text-emerald-700 dark:text-emerald-300"}`,children:s.tableNumber}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"الطاولة"})]}),s.reservedFor?.customerName?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center gap-2 flex-wrap",children:[s.reservedFor.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{className:"bg-yellow-600 hover:bg-yellow-700 text-white animate-pulse px-3 py-1 flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3"}),"معلقة"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["الميعاد: ",s.reservedFor.reservationTime]})]}),s.reservedFor.status==="confirmed"&&e.jsxs(d,{className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1",children:[e.jsx(Q,{className:"w-3 h-3 ml-1"}),"مفعلة"]}),s.reservedFor.status==="cancelled"&&e.jsx(d,{className:"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1",children:"ملغاة"})]}),e.jsxs("div",{className:"bg-white/70 dark:bg-card/70 rounded-lg p-3 space-y-2 backdrop-blur",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(oe,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"font-semibold text-slate-900 dark:text-slate-100",children:s.reservedFor?.customerName||"N/A"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:[e.jsx(de,{className:"w-3 h-3 text-red-600"}),e.jsx("span",{className:"font-mono",dir:"ltr",children:s.reservedFor?.customerPhone||"N/A"})]}),s.reservedFor?.numberOfGuests&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:[e.jsx("span",{className:"font-semibold",children:"ضيوف:"}),e.jsx("span",{children:s.reservedFor.numberOfGuests})]})]}),s.reservedFor.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{size:"sm",onClick:()=>A.mutate(s.id),disabled:A.isPending,className:"flex-1 bg-green-600 hover:bg-green-700 text-white","data-testid":`button-approve-${s.tableNumber}`,children:[e.jsx(Q,{className:"w-3 h-3 ml-1"}),"تفعيل"]}),e.jsxs(o,{size:"sm",variant:"destructive",onClick:()=>K.mutate(s.id),disabled:K.isPending,className:"flex-1","data-testid":`button-cancel-reserve-${s.tableNumber}`,children:[e.jsx(me,{className:"w-3 h-3 ml-1"}),"إلغاء"]})]}),s.currentOrderId&&V.find(t=>t.id===s.currentOrderId)&&e.jsx(o,{size:"sm",variant:"outline",onClick:()=>O(`/table-order-tracking/${s.currentOrderId}`),className:"w-full border-blue-300 text-blue-600 hover:bg-blue-50","data-testid":`button-order-${s.tableNumber}`,children:"عرض طلب الطاولة"}),e.jsxs(o,{size:"sm",variant:"destructive",onClick:()=>Z(s),className:"w-full bg-red-600 hover:bg-red-700 text-white transition-all","data-testid":`button-release-${s.tableNumber}`,children:[e.jsx(ye,{className:"w-3 h-3 ml-1"}),"تحرير الطاولة"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(d,{className:"bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1",children:"متاحة الآن"})}),e.jsx("div",{className:"text-xs text-muted-foreground py-2",children:"جاهزة للحجز"}),e.jsxs(o,{size:"sm",onClick:()=>Y(s),className:"w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white transition-all shadow-md hover:shadow-lg","data-testid":`button-reserve-${s.tableNumber}`,children:[e.jsx(we,{className:"w-4 h-4 ml-1"}),"حجز الطاولة"]})]})]})},s.id))}),e.jsx(ue,{open:H,onOpenChange:x,children:e.jsxs(he,{className:"sm:max-w-md bg-[#11936c]",dir:"rtl",children:[e.jsxs(xe,{children:[e.jsxs(pe,{children:["حجز طاولة ",b?.tableNumber]}),e.jsx(ge,{children:"أدخل معلومات العميل لحجز الطاولة"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"customer-name",children:"اسم العميل *"}),e.jsx(j,{id:"customer-name",placeholder:"محمد أحمد",value:N,onChange:s=>y(s.target.value),"data-testid":"input-customer-name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"customer-phone",children:"رقم الجوال *"}),e.jsx(j,{id:"customer-phone",placeholder:"5xxxxxxxx",value:p,onChange:s=>w(s.target.value),maxLength:9,"data-testid":"input-customer-phone"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"number-of-guests",children:"عدد الضيوف *"}),e.jsx(j,{id:"number-of-guests",type:"number",placeholder:"2",value:E,onChange:s=>S(s.target.value),min:"1",max:"20","data-testid":"input-number-of-guests"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"reservation-datetime",children:"الميعاد *"}),e.jsx(j,{id:"reservation-datetime",type:"datetime-local",value:k,onChange:s=>D(s.target.value),"data-testid":"input-reservation-datetime"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يتم تفعيل الحجز عند قدوم الميعاد قبله بـ 5 دقايق، والإلغاء تلقائياً بعد 5 دقايق من الميعاد"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{onClick:_,disabled:q.isPending,className:"flex-1","data-testid":"button-confirm-reserve",children:"تأكيد الحجز"}),e.jsx(o,{variant:"outline",onClick:()=>{x(!1),y(""),w(""),S("2")},className:"flex-1","data-testid":"button-cancel-reserve",children:"إلغاء"})]})]})]})})]})})}export{$e as default};
