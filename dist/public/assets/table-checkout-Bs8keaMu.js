import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as l}from"./vendor-react-Bzsngnqy.js";import{c as q,a as _,e as B,C as b,f as g,i as k,B as p,x as T,y as P,L,U as R,I as O,p as J,A as U}from"./index-CLvpp2UE.js";import{C as D}from"./circle-check-big-DlXUvwLH.js";import{L as H}from"./loader-DGpp_IFR.js";import"./vendor-query-CX8ZYlKb.js";import"./vendor-utils-BKCsaWdX.js";function Z(){const[,x]=q(),[M,f]=_("/table-checkout/:tableId/:tableNumber"),{toast:n}=B(),[c,u]=l.useState(""),[i,j]=l.useState(""),[N,w]=l.useState(!1),[v,y]=l.useState(!1),[d,$]=l.useState(!1),[C,I]=l.useState(null),o=f?.tableId,h=f?.tableNumber;l.useEffect(()=>{const t=localStorage.getItem("customer-phone"),s=localStorage.getItem("customer-name"),a=localStorage.getItem("customer-id");t&&s&&a&&(j(t),u(s),$(!0))},[]);const m=JSON.parse(sessionStorage.getItem(`cart_${o}`)||"[]").map(t=>t.item?t:t.coffeeItem?{...t,item:t.coffeeItem}:t).filter(t=>t.item),A=sessionStorage.getItem(`branchId_${o}`)||"",S=()=>m.reduce((t,s)=>t+s.item.price*s.quantity,0),E=async t=>{if(j(t),I(null),t.trim().length===9){y(!0);try{const s=await fetch(`/api/customers/by-phone/${t.trim()}`);if(s.ok){const a=await s.json();if(a){const r=a.name||a.fullName;r&&(u(r),n({title:"تم العثور على العميل",description:`مرحباً ${r}`})),a.pendingTableOrder&&(I(a.pendingTableOrder),n({title:"لديك طلب معلق!",description:"يمكنك متابعة طلبك السابق أو إنشاء طلب جديد"}))}}}catch(s){console.error("Error searching customer:",s)}finally{y(!1)}}},F=async()=>{if(!c||c.trim()===""){n({title:"خطأ",description:"الرجاء إدخال الاسم",variant:"destructive"});return}if(!i||i.trim()===""){n({title:"خطأ",description:"رقم الجوال مطلوب",variant:"destructive"});return}if(i.trim().length!==9){n({title:"خطأ",description:"رقم الجوال يجب أن يكون 9 أرقام",variant:"destructive"});return}w(!0);try{const t={items:m.map(r=>({id:r.item.id,nameAr:r.item.nameAr,price:r.item.price,quantity:r.quantity})),totalAmount:S(),paymentMethod:"cash",status:"pending",orderType:"dine-in",tableNumber:h,tableId:o,branchId:A,tableStatus:"pending",customerInfo:{customerName:c.trim(),customerPhone:i.trim()}},s=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const r=await s.json();throw new Error(r.error||"فشل في إنشاء الطلب")}const a=await s.json();sessionStorage.removeItem(`cart_${o}`),sessionStorage.removeItem(`branchId_${o}`),n({title:"تم إرسال الطلب بنجاح",description:"طلبك قيد المراجعة من قبل الكاشير. سيتم إعلامك بالتحديثات",duration:7e3,className:"bg-green-600 text-white border-green-700"}),setTimeout(()=>{x(`/table-order-tracking/${a.id}`)},500)}catch(t){console.error("Error submitting order:",t),n({title:"خطأ في إرسال الطلب",description:"حدث خطأ أثناء إرسال طلبك. يرجى المحاولة مرة أخرى أو التواصل مع الموظفين",variant:"destructive",duration:8e3})}finally{w(!1)}};return!o||!h||m.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",dir:"rtl",children:e.jsx(b,{className:"w-full max-w-md",children:e.jsxs(g,{className:"pt-6 text-center",children:[e.jsx(k,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"لا توجد عناصر في السلة"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"الرجاء إضافة عناصر للسلة أولاً"}),e.jsx(p,{onClick:()=>x("/"),children:"العودة للصفحة الرئيسية"})]})})}):e.jsx("div",{className:"min-h-screen bg-white",dir:"rtl",children:e.jsxs("div",{className:"max-w-2xl mx-auto p-4 sm:p-6 lg:p-8 min-h-screen flex flex-col justify-center",children:[e.jsxs("div",{className:"mb-8 text-center bg-gradient-to-br from-amber-50 to-orange-100 p-8 rounded-2xl shadow-lg",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 bg-white rounded-full mb-4 shadow-md",children:e.jsx(k,{className:"w-10 h-10 text-accent"})}),e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-800 mb-2",children:"إتمام الطلب"}),e.jsxs("p",{className:"text-slate-700 font-semibold text-lg",children:["طاولة رقم ",h]})]}),e.jsxs(b,{className:"mb-6 shadow-lg",children:[e.jsx(T,{children:e.jsx(P,{className:"text-xl",children:"ملخص الطلب"})}),e.jsx(g,{children:e.jsxs("div",{className:"space-y-3",children:[m.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center py-2 border-b last:border-0",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-foreground",children:t.item.nameAr}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["الكمية: ",t.quantity]})]}),e.jsxs("p",{className:"font-bold text-lg text-foreground",children:[(t.item.price*t.quantity).toFixed(2)," ر.س"]})]},s)),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t-2 border-primary/20",children:[e.jsx("span",{className:"text-xl font-bold text-foreground",children:"الإجمالي"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:[S().toFixed(2)," ر.س"]})]})]})})]}),e.jsxs(b,{className:"shadow-lg bg-white border-2",children:[e.jsx(T,{className:"bg-gradient-to-r from-slate-50 to-slate-100",children:e.jsx(P,{className:"text-2xl text-slate-800",children:"معلوماتك"})}),e.jsxs(g,{className:"space-y-6 pt-6",children:[d&&e.jsxs("div",{className:"bg-green-50 border-2 border-green-300 rounded-lg p-4 flex items-center gap-3",children:[e.jsx(D,{className:"w-5 h-5 text-green-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-green-800",children:"عميل مسجل"}),e.jsx("p",{className:"text-sm text-green-700",children:"تم ملء بيانات حسابك تلقائياً"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(L,{htmlFor:"name",className:"text-base flex items-center gap-2 font-semibold text-slate-700",children:[e.jsx(R,{className:"w-5 h-5 text-accent"}),"الاسم *"]}),e.jsx(O,{id:"name",placeholder:"أدخل اسمك",value:c,onChange:t=>u(t.target.value),disabled:d,className:"text-lg h-14 bg-white border-2 border-slate-300 focus:border-primary text-slate-900 placeholder:text-slate-400 disabled:bg-slate-100 disabled:cursor-not-allowed","data-testid":"input-name",autoFocus:!d})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(L,{htmlFor:"phone",className:"text-base flex items-center gap-2 font-semibold text-slate-700",children:[e.jsx(J,{className:"w-5 h-5 text-accent"}),"رقم الجوال *"]}),e.jsxs("div",{className:"relative",children:[e.jsx(O,{id:"phone",placeholder:"5xxxxxxxx",value:i,onChange:t=>E(t.target.value),maxLength:9,disabled:v||d,className:"text-lg h-14 bg-white border-2 border-slate-300 focus:border-primary text-slate-900 placeholder:text-slate-400 disabled:bg-slate-100 disabled:cursor-not-allowed","data-testid":"input-phone"}),v&&e.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2",children:e.jsx(H,{className:"w-5 h-5 text-accent animate-spin"})})]})]}),C&&e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-300 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 font-semibold mb-2",children:"لديك طلب معلق:"}),e.jsx(p,{variant:"outline",onClick:()=>x(`/table-order-tracking/${C.id}`),className:"w-full mb-2 text-blue-600 border-blue-300","data-testid":"button-track-pending-order",children:"متابعة الطلب السابق"}),e.jsx("p",{className:"text-xs text-blue-700",children:"أو استمر بإنشاء طلب جديد أدناه"})]}),e.jsx("div",{className:"bg-background border-2 border-primary p-5 rounded-lg",children:e.jsx("p",{className:"text-base text-slate-800 text-center font-semibold",children:"سيتم الدفع عند الكاشير"})}),e.jsx(p,{onClick:F,disabled:N,className:"w-full h-14 text-lg font-bold shadow-lg","data-testid":"button-submit-order",children:N?"جاري الإرسال...":e.jsxs(e.Fragment,{children:["إرسال الطلب الجديد",e.jsx(U,{className:"mr-2 w-5 h-5"})]})})]})]})]})})}export{Z as default};
