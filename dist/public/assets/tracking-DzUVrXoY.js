import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as c}from"./vendor-react-Bzsngnqy.js";import{a as E}from"./vendor-query-CX8ZYlKb.js";import{C as j,f,T as I,x as T,y as S,o as _,j as C,B as N,q as R,r as M,u as q,c as F,e as U,L as B,I as W,k as H,O as K,i as z}from"./index-61RjstaY.js";import{P as Q}from"./progress-C-g-xWdk.js";import{C as $}from"./circle-check-big-v7jPXABl.js";import{R as D}from"./refresh-cw-DWvJTizr.js";import{E as O}from"./external-link-JZzpsg7W.js";import{N as V}from"./navigation-DLyCnKEJ.js";import{S as G}from"./store-CdbJ-YqS.js";import{P as J}from"./package-equujGSd.js";import"./vendor-utils-BKCsaWdX.js";function X(s,l,m,n){const d=(m-s)*Math.PI/180,u=(n-l)*Math.PI/180,r=Math.sin(d/2)*Math.sin(d/2)+Math.cos(s*Math.PI/180)*Math.cos(m*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function Y({branch:s,onPreparationReady:l,preparationRadius:m=1e5}){const[n,x]=c.useState({status:"idle"}),[d,u]=c.useState(null),[r,g]=c.useState(!1),[t,b]=c.useState(null),i=c.useCallback(o=>{const{latitude:k,longitude:w}=o.coords;if(x({status:"success",latitude:k,longitude:w}),s.location){const A=X(k,w,s.location.latitude,s.location.longitude);u(Math.round(A));const P=A<=m;g(P),P&&l&&l()}},[s.location,m,l]),v=c.useCallback(o=>{let k="حدث خطأ في تحديد الموقع",w="error";switch(o.code){case o.PERMISSION_DENIED:k="تم رفض صلاحية الوصول للموقع. الرجاء تفعيل خدمة الموقع من إعدادات الجهاز.",w="denied";break;case o.POSITION_UNAVAILABLE:k="معلومات الموقع غير متاحة حالياً";break;case o.TIMEOUT:k="انتهت مهلة تحديد الموقع";break}x({status:w,error:k})},[]),p=c.useCallback(()=>{if(!navigator.geolocation){x({status:"error",error:"المتصفح لا يدعم خدمة تحديد الموقع"});return}x({status:"loading"}),navigator.geolocation.getCurrentPosition(i,v,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0});const o=navigator.geolocation.watchPosition(i,v,{enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3});b(o)},[i,v]),y=c.useCallback(()=>{t!==null&&(navigator.geolocation.clearWatch(t),b(null))},[t]);c.useEffect(()=>()=>{y()},[y]);const a=()=>{if(s.location){const o=`https://www.google.com/maps/dir/?api=1&destination=${s.location.latitude},${s.location.longitude}&travelmode=driving`;window.open(o,"_blank")}},h=()=>{if(s.location){const o=`https://www.google.com/maps?q=${s.location.latitude},${s.location.longitude}`;window.open(o,"_blank")}},L=()=>d===null?"":d<1e3?`${d} متر`:`${(d/1e3).toFixed(1)} كم`;return s.location?e.jsxs(j,{className:"overflow-hidden","data-testid":"card-location-preparation",children:[e.jsx(T,{className:"pb-3",children:e.jsxs(S,{className:"flex items-center justify-between gap-2",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"text-lg",children:"التحقق من الموقع للتحضير"})]}),r?e.jsxs(C,{variant:"default",className:"bg-green-600",children:[e.jsx($,{className:"w-3 h-3 ml-1"}),"جاهز للتحضير"]}):e.jsxs(C,{variant:"outline",className:"border-amber-500 text-amber-600",children:[e.jsx(I,{className:"w-3 h-3 ml-1"}),"بعيد عن الفرع"]})]})}),e.jsxs(f,{className:"space-y-4",children:[e.jsx("div",{className:"bg-muted/50 rounded-lg p-4",dir:"rtl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(_,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:s.nameAr}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:s.address})]})]})}),n.status==="idle"&&e.jsxs("div",{className:"text-center py-6",dir:"rtl",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"اضغط على الزر لتحديد موقعك والتحقق من قربك من الفرع (اختياري)"}),e.jsxs(N,{onClick:p,className:"gap-2","data-testid":"button-check-location",children:[e.jsx(_,{className:"w-4 h-4"}),"تحديد موقعي"]})]}),n.status==="loading"&&e.jsxs("div",{className:"text-center py-6",dir:"rtl",children:[e.jsx(R,{className:"w-8 h-8 animate-spin mx-auto text-primary mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحديد موقعك..."})]}),(n.status==="error"||n.status==="denied")&&e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(I,{className:"w-5 h-5 text-destructive shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"تعذر تحديد الموقع"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:n.error})]})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{onClick:p,variant:"outline",className:"flex-1 gap-2","data-testid":"button-retry-location",children:[e.jsx(D,{className:"w-4 h-4"}),"إعادة المحاولة"]}),e.jsxs(N,{onClick:h,variant:"outline",className:"flex-1 gap-2","data-testid":"button-view-branch-location",children:[e.jsx(O,{className:"w-4 h-4"}),"موقع الفرع"]})]})]}),n.status==="success"&&e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsxs("div",{className:`rounded-lg p-4 ${r?"bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-900":"bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-900"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r?e.jsx($,{className:"w-5 h-5 text-green-600"}):e.jsx(M,{className:"w-5 h-5 text-amber-600"}),e.jsx("span",{className:`font-semibold ${r?"text-green-700 dark:text-green-400":"text-amber-700 dark:text-amber-400"}`,children:r?"أنت قريب من الفرع!":"أنت بعيد عن الفرع"})]}),e.jsx(C,{variant:r?"default":"secondary",className:r?"bg-green-600":"",children:L()})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r?`أنت ضمن نطاق ${m} متر من الفرع. يمكننا البدء بتحضير طلبك الآن!`:`المسافة الحالية: ${L()}. يمكنك البدء بالتحضير عندما تقترب.`})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsx("p",{className:"text-muted-foreground text-xs mb-1",children:"موقعك الحالي"}),e.jsxs("p",{className:"font-mono text-xs",children:[n.latitude?.toFixed(6),", ",n.longitude?.toFixed(6)]})]}),e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsx("p",{className:"text-muted-foreground text-xs mb-1",children:"موقع الفرع"}),e.jsxs("p",{className:"font-mono text-xs",children:[s.location.latitude.toFixed(6),", ",s.location.longitude.toFixed(6)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[!r&&e.jsxs(N,{onClick:a,className:"flex-1 gap-2","data-testid":"button-get-directions",children:[e.jsx(V,{className:"w-4 h-4"}),"الاتجاهات للفرع"]}),e.jsxs(N,{onClick:p,variant:r?"default":"outline",className:"flex-1 gap-2","data-testid":"button-refresh-location",children:[e.jsx(D,{className:"w-4 h-4"}),"تحديث الموقع"]})]}),t!==null&&e.jsx(N,{onClick:y,variant:"ghost",size:"sm",className:"w-full text-muted-foreground","data-testid":"button-stop-tracking",children:"إيقاف التتبع التلقائي"})]})]})]}):e.jsx(j,{className:"border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-900",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",dir:"rtl",children:[e.jsx(I,{className:"w-5 h-5 text-amber-600"}),e.jsx("p",{className:"text-sm text-amber-700 dark:text-amber-400",children:"موقع الفرع غير محدد. الرجاء التواصل مع خدمة العملاء."})]})})})}function Z({estimatedMinutes:s,startTime:l,t:m}){const[n,x]=c.useState(0),[d,u]=c.useState(100);c.useEffect(()=>{const t=()=>{const i=new Date(l).getTime(),v=i+s*60*1e3,p=Date.now(),y=Math.max(0,Math.floor((v-p)/1e3)),a=s*60,h=(p-i)/1e3;x(y),u(Math.max(0,Math.min(100,100-h/a*100)))};t();const b=setInterval(t,1e3);return()=>clearInterval(b)},[s,l]);const r=Math.floor(n/60),g=n%60;return e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:m("tracking.prep_remaining")}),e.jsxs("span",{className:"text-2xl font-bold text-primary font-mono",dir:"ltr",children:[String(r).padStart(2,"0"),":",String(g).padStart(2,"0")]})]}),e.jsx(Q,{value:d,className:"h-2"}),e.jsx("p",{className:"text-center text-xs text-muted-foreground",children:m("tracking.est_time",{minutes:s})})]})}function xe(){const{t:s,i18n:l}=q(),[m]=F(),[n,x]=c.useState(""),[d,u]=c.useState(""),r=c.useRef(""),{toast:g}=U();c.useEffect(()=>{const h=new URLSearchParams(window.location.search).get("order");h&&(x(h),u(h))},[m]);const{data:t,isLoading:b}=E({queryKey:["/api/orders/number",d],queryFn:async()=>{if(!d)return null;const a=await fetch(`/api/orders/number/${d}`);if(!a.ok)throw new Error("Order not found");return a.json()},enabled:!!d,refetchInterval:5e3}),{data:i}=E({queryKey:["/api/branches",t?.branchId],queryFn:async()=>{if(!t?.branchId)return null;const a=await fetch(`/api/branches/${t.branchId}`);return a.ok?a.json():null},enabled:!!t?.branchId});c.useEffect(()=>{t&&t.status==="ready"&&r.current&&r.current!=="ready"&&g({title:s("tracking.ready_toast_title"),description:s("tracking.ready_toast_desc"),className:"bg-green-600 text-white border-green-700",duration:1e4}),t&&(r.current=t.status)},[t,g,s]);const v=()=>{n&&u(n)},p=a=>{switch(a){case"pending":case"payment_confirmed":return e.jsx(M,{className:"w-8 h-8 text-yellow-500"});case"in_progress":return e.jsx(J,{className:"w-8 h-8 text-blue-500"});case"ready":return e.jsx(z,{className:"w-8 h-8 text-green-500"});case"out_for_delivery":return e.jsx(K,{className:"w-8 h-8 text-purple-500"});case"completed":return e.jsx(H,{className:"w-8 h-8 text-green-600"});default:return e.jsx(M,{className:"w-8 h-8 text-gray-500"})}},y=a=>s(`status.${a}`)||a;return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 py-12 px-4",dir:l.language==="ar"?"rtl":"ltr",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"font-amiri text-4xl font-bold text-primary mb-2",children:s("tracking.title")}),e.jsx("p",{className:"text-muted-foreground",children:s("tracking.subtitle")})]}),e.jsx(j,{className:"mb-8",children:e.jsx(f,{className:"p-6",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(B,{htmlFor:"order-number",children:s("tracking.order_number")}),e.jsx(W,{id:"order-number",value:n,onChange:a=>x(a.target.value),placeholder:"ORD-...",className:l.language==="ar"?"text-right":"text-left",dir:"ltr"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(N,{onClick:v,disabled:!n||b,className:"bg-primary text-primary-foreground",children:s(b?"tracking.searching":"tracking.track_btn")})})]})})}),t&&e.jsxs("div",{className:"space-y-6 animate-in fade-in-0 slide-in-from-bottom-10 duration-500",children:[e.jsxs(j,{className:"overflow-hidden border-2 border-primary/20",children:[e.jsx(T,{className:"bg-primary/5 pb-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"p-4 bg-background rounded-full shadow-lg border-2 border-primary/10",children:p(t.status)}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{className:"text-2xl font-bold text-primary",children:y(t.status)}),e.jsx("p",{className:"text-muted-foreground text-sm",children:s("tracking.status_updated")})]})]})}),e.jsxs(f,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/50 rounded-lg",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.order_number"),":"]}),e.jsx("span",{className:"font-bold text-primary",dir:"ltr",children:t.orderNumber.includes("-")?t.orderNumber.split("-").pop():t.orderNumber})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/50 rounded-lg",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.total_amount"),":"]}),e.jsxs("span",{className:"font-bold",children:[t.totalAmount," ",s("currency")]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/50 rounded-lg",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.drink_status"),":"]}),e.jsx(C,{variant:t.status==="ready"?"default":"secondary",className:"text-sm px-3 py-1",children:t.status==="ready"?`✨ ${s("tracking.ready_badge")}`:t.status==="in_progress"?`☕ ${s("tracking.preparing_badge")}`:`⏳ ${s("tracking.pending_badge")}`})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/50 rounded-lg",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.order_confirmed"),":"]}),e.jsxs(C,{variant:"outline",className:"text-sm px-3 py-1 border-green-500 text-green-600",children:[s("tracking.confirmed_badge")," ✅"]})]})]})]}),t.status==="in_progress"&&t.estimatedPrepTimeInMinutes&&e.jsx(Z,{estimatedMinutes:t.estimatedPrepTimeInMinutes,startTime:t.prepTimeSetAt||t.updatedAt||t.createdAt,t:s})]})]}),t.deliveryType&&e.jsx(j,{children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.delivery_type"),":"]}),e.jsx("span",{className:"font-bold",children:t.deliveryType==="delivery"?s("tracking.delivery"):s("tracking.pickup")})]})})}),i&&e.jsx(j,{children:e.jsxs(f,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary font-semibold",children:[e.jsx(G,{className:"w-5 h-5"}),e.jsx("span",{children:s("tracking.branch_info")})]}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("tracking.branch_name"),":"]}),e.jsx("span",{className:"font-bold",children:l.language==="ar"?i.nameAr:i.nameEn||i.nameAr})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("delivery.address"),":"]}),e.jsx("span",{className:"font-bold",children:i.address})]}),i.phone&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:[s("delivery.phone"),":"]}),e.jsx("span",{className:"font-bold",dir:"ltr",children:i.phone})]}),i.mapsUrl&&e.jsxs(N,{variant:"outline",className:"w-full",onClick:()=>window.open(i.mapsUrl,"_blank"),"data-testid":"button-view-branch-location",children:[e.jsx(_,{className:"w-4 h-4 mx-2"}),s("tracking.view_map"),e.jsx(O,{className:"w-4 h-4 mx-2"})]})]})]})}),i&&t.deliveryType==="pickup"&&["in_progress","ready"].includes(t.status)&&e.jsx(Y,{branch:i,preparationRadius:300,onPreparationReady:()=>{g({title:s("tracking.proximity_toast_title"),description:s("tracking.proximity_toast_desc")})}}),t.deliveryType==="delivery"&&t.status==="out_for_delivery"&&t.driverLocation&&e.jsxs(j,{children:[e.jsx(T,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-6 h-6 text-primary"}),s("tracking.driver_location")]})}),e.jsxs(f,{children:[e.jsx("div",{className:"h-64 bg-gray-200 rounded-lg flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:s("tracking.map_placeholder")})}),t.estimatedDeliveryTime&&e.jsxs("p",{className:"mt-4 text-center text-muted-foreground",children:[s("tracking.est_arrival")," ",new Date(t.estimatedDeliveryTime).toLocaleTimeString(l.language==="ar"?"ar-SA":"en-US")]})]})]}),e.jsxs(j,{children:[e.jsx(T,{children:e.jsx(S,{children:s("tracking.order_details")})}),e.jsx(f,{children:e.jsx("div",{className:"space-y-3",children:Array.isArray(t.items)&&t.items.map((a,h)=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted rounded-lg",children:[e.jsx("span",{children:l.language==="ar"?a.nameAr||a.name:a.nameEn||a.name}),e.jsxs("span",{className:"text-muted-foreground",children:["× ",a.quantity]})]},h))})})]})]})]})})}export{xe as default};
