import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as n}from"./vendor-react-Bzsngnqy.js";import{u as J,a as L,b as V}from"./vendor-query-CX8ZYlKb.js";import{C as y}from"./CustomerLayout-3skT6THQ.js";import{u as Z,t as X,c as Y,e as ee,a3 as ae,B as i,A as se,g as te,W as T,C as d,x as re,y as ie,Z as ne,f as m,j as ce,G as le,r as oe,D as A,E as F,F as R,H as Q,J as E,L as v,I as w,K as $,v as de}from"./index-CLvpp2UE.js";import{S as z}from"./send-tv7GiiF9.js";import{H as O}from"./history-CRTRvOXU.js";import{A as me,a as xe}from"./arrow-up-right-3GAflgIx.js";import"./customer-footer-DFb6iF4V.js";import"./clipboard-list-C6fMKNlJ.js";import"./vendor-utils-BKCsaWdX.js";const H=20;function _e(){const{t:a,i18n:c}=Z(),{customer:l}=X(),[,h]=Y(),{toast:x}=ee(),_=J(),[K,p]=n.useState(!1),[f,C]=n.useState(""),[t,k]=n.useState(""),[q,D]=n.useState(""),[u,U]=n.useState(""),[B,b]=n.useState(!1),{data:M,isLoading:S}=L({queryKey:["/api/customer/loyalty-cards"],enabled:!!l}),{data:j,isLoading:P}=L({queryKey:["/api/customer/loyalty-transactions"],enabled:!!l}),g=V({mutationFn:async s=>(await de("POST","/api/customer/transfer-points",s)).json(),onSuccess:s=>{x({title:a("card.transfer_success")||"تم التحويل بنجاح",description:a("card.transfer_success_desc",{points:t,name:s.recipientName})||`تم تحويل ${t} نقطة إلى ${s.recipientName}`}),p(!1),C(""),k(""),D(""),_.invalidateQueries({queryKey:["/api/customer/loyalty-cards"]}),_.invalidateQueries({queryKey:["/api/customer/loyalty-transactions"]})},onError:s=>{x({variant:"destructive",title:a("card.transfer_failed")||"فشل التحويل",description:s.message||a("card.transfer_error")||"حدث خطأ أثناء التحويل"})}}),r=M?.[0],o=r?.points??l?.points??0,I=r?.pendingPoints??l?.pendingPoints??0,G=(o/H).toFixed(2);if(n.useEffect(()=>{if(r?.qrToken||r?.cardNumber){const s=r.qrToken||r.cardNumber;ae.toDataURL(s,{width:200,margin:2,color:{dark:"#2D9B6E",light:"#FFFFFF"}}).then(U).catch(console.error)}},[r]),!l&&!S&&!P)return e.jsx(y,{children:e.jsxs("div",{className:"container max-w-lg mx-auto p-4 flex flex-col items-center justify-center min-h-[50vh] space-y-4",children:[e.jsx("p",{className:"font-ibm-arabic text-muted-foreground",children:a("card.login_required")||"يجب تسجيل الدخول لعرض البطاقة"}),e.jsx(i,{onClick:()=>h("/auth"),"data-testid":"button-login",children:a("auth.login")||"تسجيل الدخول"})]})});if(S||P)return e.jsx(y,{children:e.jsx("div",{className:"container max-w-lg mx-auto p-4 flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"font-ibm-arabic",children:a("common.loading")||"جاري التحميل..."})})});const W=()=>{if(!f||!t||Number(t)<=0){x({variant:"destructive",title:a("card.fill_all_fields")||"يرجى ملء جميع الحقول"});return}if(Number(t)>o){x({variant:"destructive",title:a("card.insufficient_points")||"رصيد النقاط غير كافي"});return}g.mutate({recipientPhone:f,points:Number(t),pin:q})};return e.jsxs(y,{children:[e.jsxs("div",{className:"container max-w-lg mx-auto p-4 space-y-6 pb-24",dir:c.language==="ar"?"rtl":"ltr",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>h("/"),"data-testid":"button-back",children:c.language==="ar"?e.jsx(se,{className:"w-5 h-5"}):e.jsx(te,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-2xl font-bold font-amiri text-primary","data-testid":"text-page-title",children:a("card.title")||"محفظتي"})]}),u&&e.jsx(i,{variant:"outline",size:"icon",onClick:()=>b(!0),"data-testid":"button-show-qr",children:e.jsx(T,{className:"w-5 h-5"})})]}),e.jsxs(d,{className:"bg-gradient-to-br from-primary to-primary/80 text-primary-foreground border-none shadow-xl overflow-hidden relative","data-testid":"card-wallet",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-12 -mb-12 blur-xl"}),e.jsx(re,{className:"relative z-10",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ie,{className:"text-xl opacity-90 font-amiri",children:a("card.card_title")||"بطاقة كلووني"}),e.jsx("p",{className:"text-sm opacity-75 font-ibm-arabic",children:l?.name||a("card.default_customer_name")||"عميل كلووني"})]}),e.jsx(ne,{className:"w-8 h-8 opacity-50"})]})}),e.jsxs(m,{className:"space-y-6 relative z-10",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs opacity-75 font-medium font-ibm-arabic",children:a("card.points_balance")||"رصيد النقاط"}),e.jsx("h2",{className:"text-3xl font-bold font-ibm-arabic","data-testid":"text-points-balance",children:o}),e.jsxs("p",{className:"text-sm opacity-75 font-ibm-arabic",children:["= ",G," ",a("currency")||"ريال"]})]}),e.jsxs("div",{className:"space-y-1 text-left",children:[e.jsx("p",{className:"text-xs opacity-75 font-medium font-ibm-arabic",children:a("card.pending_points")||"نقاط معلقة"}),e.jsx("h2",{className:"text-2xl font-bold font-ibm-arabic text-yellow-200","data-testid":"text-pending-points",children:I}),e.jsx("p",{className:"text-xs opacity-60 font-ibm-arabic",children:a("card.pending_desc")||"تضاف عند اكتمال الطلب"})]})]}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[10px] opacity-75 uppercase tracking-wider font-ibm-arabic",children:a("card.card_number")||"رقم البطاقة"}),e.jsx("p",{className:"font-mono text-lg tracking-widest","data-testid":"text-card-number",children:r?.cardNumber?.replace(/(.{4})/g,"$1 ")||"**** **** ****"})]}),e.jsx(ce,{variant:"secondary",className:"bg-white/20 text-white border-none text-[10px] font-ibm-arabic",children:a("card.active")||"نشطة"})]})]})]}),e.jsx(d,{className:"bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 border-amber-200 dark:border-amber-800","data-testid":"card-points-info",children:e.jsx(m,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(le,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold font-ibm-arabic text-amber-800 dark:text-amber-200",children:a("card.loyalty_system")||"نظام النقاط"}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 font-ibm-arabic",children:a("card.loyalty_desc")||"10 نقاط لكل مشروب • 100 نقطة = 5 ريال"})]})]})})})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(d,{children:e.jsx(m,{className:"p-3",children:e.jsxs(i,{variant:"ghost",size:"lg",className:"w-full flex flex-col gap-1",onClick:()=>p(!0),"data-testid":"button-transfer-points",children:[e.jsx(z,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"text-sm font-ibm-arabic",children:a("card.transfer_points")||"تحويل نقاط"})]})})}),e.jsx(d,{children:e.jsx(m,{className:"p-3",children:e.jsxs(i,{variant:"ghost",size:"lg",className:"w-full flex flex-col gap-1",onClick:()=>h("/my-orders"),"data-testid":"button-my-orders",children:[e.jsx(O,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"text-sm font-ibm-arabic",children:a("nav.my_orders")||"طلباتي"})]})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-between items-center px-1",children:e.jsx("h3",{className:"font-bold text-lg font-amiri",children:a("card.recent_transactions")||"آخر العمليات"})}),e.jsx("div",{className:"space-y-3",children:j&&j.length>0?j.slice(0,5).map((s,N)=>e.jsx(d,{className:"bg-card/30 border-none shadow-sm hover:bg-card/50 transition-colors","data-testid":`card-transaction-${N}`,children:e.jsxs(m,{className:"p-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${s.type==="earn"||s.type==="transfer_in"?"bg-green-500/10 text-green-600":s.type==="pending"?"bg-yellow-500/10 text-yellow-600":"bg-primary/10 text-primary"}`,children:s.type==="earn"||s.type==="transfer_in"?e.jsx(me,{className:"w-4 h-4"}):s.type==="pending"?e.jsx(oe,{className:"w-4 h-4"}):e.jsx(xe,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold font-ibm-arabic",children:c.language==="ar"?s.descriptionAr||(s.type==="earn"?"كسب نقاط":s.type==="transfer_in"?"استلام نقاط":s.type==="transfer_out"?"تحويل نقاط":"استبدال نقاط"):s.descriptionEn||s.descriptionAr||s.type}),e.jsx("p",{className:"text-[10px] text-muted-foreground font-ibm-arabic",children:new Date(s.createdAt).toLocaleDateString(c.language==="ar"?"ar-SA":"en-US")})]})]}),e.jsxs("div",{className:`font-bold font-ibm-arabic ${s.type==="earn"||s.type==="transfer_in"?"text-green-600":s.type==="pending"?"text-yellow-600":"text-primary"}`,children:[s.type==="earn"||s.type==="transfer_in"?"+":"-",Math.abs(s.points)]})]})},s.id||N)):e.jsxs("div",{className:"text-center py-10 opacity-50",children:[e.jsx(O,{className:"w-12 h-12 mx-auto mb-2 opacity-20"}),e.jsx("p",{className:"text-sm font-ibm-arabic",children:a("card.no_transactions")||"لا توجد عمليات سابقة"})]})})]})]}),e.jsx(A,{open:K,onOpenChange:p,children:e.jsxs(F,{className:"max-w-md",dir:c.language==="ar"?"rtl":"ltr","data-testid":"dialog-transfer-points",children:[e.jsxs(R,{children:[e.jsxs(Q,{className:"font-amiri text-xl flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),a("card.transfer_points")||"تحويل نقاط"]}),e.jsx(E,{className:"font-ibm-arabic",children:a("card.transfer_desc")||"أدخل رقم جوال المستلم وعدد النقاط المراد تحويلها"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"font-ibm-arabic",children:a("card.recipient_phone")||"رقم جوال المستلم"}),e.jsx(w,{type:"tel",placeholder:"05xxxxxxxx",value:f,onChange:s=>C(s.target.value),dir:"ltr","data-testid":"input-recipient-phone"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"font-ibm-arabic",children:a("card.points_amount")||"عدد النقاط"}),e.jsx(w,{type:"number",placeholder:"100",value:t,onChange:s=>k(s.target.value),min:"1",max:o,"data-testid":"input-transfer-points"}),e.jsx("p",{className:"text-xs text-muted-foreground font-ibm-arabic",children:a("card.available_balance",{points:o})||`الرصيد المتاح: ${o} نقطة`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"font-ibm-arabic",children:a("card.pin")||"الرقم السري (اختياري)"}),e.jsx(w,{type:"password",placeholder:"****",value:q,onChange:s=>D(s.target.value),"data-testid":"input-pin"})]}),t&&Number(t)>0&&e.jsx(d,{className:"bg-muted/50",children:e.jsxs(m,{className:"p-3 text-center",children:[e.jsx("p",{className:"text-sm font-ibm-arabic text-muted-foreground",children:a("card.will_transfer")||"سيتم تحويل"}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[t," ",a("card.points")||"نقطة"]}),e.jsxs("p",{className:"text-xs text-muted-foreground font-ibm-arabic",children:["= ",(Number(t)/H).toFixed(2)," ",a("currency")||"ريال"]})]})})]}),e.jsxs($,{className:"gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>p(!1),"data-testid":"button-cancel-transfer",children:a("common.cancel")||"إلغاء"}),e.jsx(i,{onClick:W,disabled:g.isPending,"data-testid":"button-confirm-transfer",children:g.isPending?a("card.transferring")||"جاري التحويل...":a("card.confirm_transfer")||"تأكيد التحويل"})]})]})}),e.jsx(A,{open:B,onOpenChange:b,children:e.jsxs(F,{className:"max-w-sm",dir:c.language==="ar"?"rtl":"ltr","data-testid":"dialog-qr-code",children:[e.jsxs(R,{children:[e.jsxs(Q,{className:"font-amiri text-xl flex items-center gap-2 justify-center",children:[e.jsx(T,{className:"w-5 h-5"}),a("card.qr_title")||"رمز البطاقة"]}),e.jsx(E,{className:"font-ibm-arabic text-center",children:a("card.qr_desc")||"اعرض هذا الرمز للكاشير لكسب النقاط"})]}),e.jsxs("div",{className:"flex flex-col items-center py-6",children:[u&&e.jsx("div",{className:"bg-white p-4 rounded-xl shadow-lg",children:e.jsx("img",{src:u,alt:"QR Code",className:"w-48 h-48","data-testid":"img-qr-code"})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4 font-mono","data-testid":"text-card-number-qr",children:r?.cardNumber||""})]}),e.jsx($,{children:e.jsx(i,{variant:"outline",onClick:()=>b(!1),className:"w-full","data-testid":"button-close-qr",children:a("common.close")||"إغلاق"})})]})})]})}export{_e as default};
