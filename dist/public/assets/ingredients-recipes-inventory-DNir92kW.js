import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as o}from"./vendor-react-Bzsngnqy.js";import{a as D,b as E}from"./vendor-query-CX8ZYlKb.js";import{e as Pe,q as T,B as c,g as Le,P as le,C as b,f as y,T as ue,X as Me,I as g,aa as Qe,ab as Oe,ac as me,i as re,ai as xe,j as he,$ as pe,af as Ke,D as V,E as B,F as z,H as U,J as ce,L as u,K as H,v as w,N as P}from"./index-CLvpp2UE.js";import{P as Ve}from"./progress-DVPXITZU.js";import{S as I,a as C,b as S,c as k,d as i}from"./select-BzAjeBJu.js";import{A as Be,a as ze,b as Ue,c as He,d as We,e as Je,f as Xe,g as _e}from"./alert-dialog-B2SJEjUD.js";import{P as W}from"./package-B_dGuXgn.js";import{C as Ge}from"./circle-check-big-DlXUvwLH.js";import{C as je}from"./calculator-Czd8XuWZ.js";import{S as ge}from"./square-pen-C2M2occ2.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-CqdH-ack.js";const L={kg:"كجم",g:"جرام",liter:"لتر",ml:"مل",piece:"قطعة",box:"صندوق",bag:"كيس"},ve={kg:"كيلوجرام",g:"جرام",liter:"لتر",ml:"ملليلتر",piece:"قطعة",box:"صندوق",bag:"كيس"},fe=(r,h)=>h==="kg"?r>=1?`${r.toFixed(1)} كجم`:`${(r*1e3).toFixed(0)} جرام`:h==="liter"?r>=1?`${r.toFixed(1)} لتر`:`${(r*1e3).toFixed(0)} مل`:h==="g"||h==="ml"?`${r.toFixed(0)} ${L[h]}`:`${r.toFixed(r%1===0?0:1)} ${L[h]||h}`,Ye={coffee:"قهوة",dairy:"ألبان",syrups:"شراب",cups:"أكواب",chocolate:"شوكولاتة",tea:"شاي",other:"أخرى"};function ms(){const{toast:r}=Pe(),[h,Ne]=o.useState("stock"),[$,be]=o.useState(""),[v,ye]=o.useState("all"),[we,q]=o.useState(!1),[m,p]=o.useState(null),[J,X]=o.useState(null),[f,M]=o.useState(null),[Q,_]=o.useState(""),[Ie,O]=o.useState(!1),[G,Y]=o.useState(null),[Z,j]=o.useState([]),[x,A]=o.useState({nameAr:"",unit:"kg",unitCost:"",category:"ingredient",minimumStock:"10"}),{data:Ce=[]}=D({queryKey:["/api/branches"]}),{data:N=[],isLoading:Se}=D({queryKey:["/api/inventory/raw-items"]}),{data:de=[]}=D({queryKey:["/api/branch-stock",v],queryFn:async()=>{const s=v!=="all"?`?branchId=${v}`:"",t=await fetch(`/api/branch-stock${s}`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch branch stock");return t.json()}}),{data:ee=[]}=D({queryKey:["/api/coffee-items"]}),{data:K=[]}=D({queryKey:["/api/inventory/all-recipes"]}),se=E({mutationFn:async s=>w("POST","/api/inventory/raw-items",s),onSuccess:()=>{P.invalidateQueries({queryKey:["/api/inventory/raw-items"]}),q(!1),A({nameAr:"",unit:"kg",unitCost:"",category:"ingredient",minimumStock:"10"}),r({title:"تم إضافة المكون بنجاح"})},onError:()=>{r({title:"فشل في إضافة المكون",variant:"destructive"})}}),te=E({mutationFn:async s=>w("PUT",`/api/inventory/raw-items/${s.id}`,s.updates),onSuccess:()=>{P.invalidateQueries({queryKey:["/api/inventory/raw-items"]}),p(null),r({title:"تم تحديث المكون بنجاح"})},onError:()=>{r({title:"فشل في تحديث المكون",variant:"destructive"})}}),ke=E({mutationFn:async s=>w("DELETE",`/api/inventory/raw-items/${s}`),onSuccess:()=>{P.invalidateQueries({queryKey:["/api/inventory/raw-items"]}),X(null),r({title:"تم حذف المكون بنجاح"})},onError:()=>{r({title:"فشل في حذف المكون",variant:"destructive"})}}),ae=E({mutationFn:async s=>{if(v==="all")throw new Error("اختر فرع محدد أولاً");return w("POST","/api/stock-movements",{branchId:v,rawItemId:s.rawItemId,movementType:"purchase",quantity:s.quantity,notes:"إضافة مخزون"})},onSuccess:()=>{P.invalidateQueries({queryKey:["/api/branch-stock"]}),M(null),_(""),r({title:"تم إضافة المخزون بنجاح"})},onError:s=>{r({title:s.message||"فشل في إضافة المخزون",variant:"destructive"})}}),ne=E({mutationFn:async s=>{const t=K.filter(n=>n.coffeeItemId===s.coffeeItemId),a=[];try{for(const n of s.ingredients){const l=await w("POST","/api/inventory/recipes",{coffeeItemId:s.coffeeItemId,rawItemId:n.rawItemId,quantity:n.quantity,unit:n.unit});l&&l.id&&a.push(l.id)}for(const n of t)await w("DELETE",`/api/inventory/recipes/${n.id}`);return!0}catch(n){for(const l of a)try{await w("DELETE",`/api/inventory/recipes/${l}`)}catch{}throw n}},onSuccess:()=>{P.invalidateQueries({queryKey:["/api/inventory/all-recipes"]}),O(!1),Y(null),j([]),r({title:"تم حفظ الوصفة بنجاح"})},onError:()=>{r({title:"فشل في حفظ الوصفة",variant:"destructive"})}}),ie=o.useMemo(()=>N.map(s=>{const t=de.find(R=>R.rawItemId===s.id),a=t?.currentQuantity||0,n=t?.minimumStock||s.minimumStock||10,l=n>0?Math.min(a/n*100,100):100;let d="ok";return a<=n*.2?d="critical":a<=n&&(d="low"),{...s,currentQuantity:a,minimumStock:n,percentage:l,status:d}}).filter(s=>s.nameAr.toLowerCase().includes($.toLowerCase())),[N,de,$]),F=o.useMemo(()=>ee.map(s=>{const t=K.filter(n=>n.coffeeItemId===s.id),a=t.reduce((n,l)=>{const d=N.find(Te=>Te.id===l.rawItemId);if(!d)return n;let R=d.unitCost;return d.unit==="kg"&&l.unit==="g"&&(R=d.unitCost/1e3),d.unit==="liter"&&l.unit==="ml"&&(R=d.unitCost/1e3),n+R*l.quantity},0);return{...s,recipes:t,hasRecipe:t.length>0,recipeCost:a,profit:s.price-a,profitMargin:s.price>0?(s.price-a)/s.price*100:0}}).filter(s=>s.nameAr.toLowerCase().includes($.toLowerCase())),[ee,K,N,$]),Ae=ie.filter(s=>s.status!=="ok").length,oe=F.filter(s=>s.hasRecipe).length,$e=s=>{s.preventDefault();const t=`RAW-${Date.now().toString(36).toUpperCase()}`;se.mutate({code:t,nameAr:x.nameAr,unit:x.unit,unitCost:parseFloat(x.unitCost)||0,category:x.category,minStockLevel:parseFloat(x.minimumStock)||10,isActive:1})},qe=()=>{if(!f||!Q)return;const s=parseFloat(Q);if(s<=0){r({title:"أدخل كمية صحيحة",variant:"destructive"});return}ae.mutate({rawItemId:f.id,quantity:s})},Fe=s=>{Y(s);const t=K.filter(a=>a.coffeeItemId===s.id);t.length>0?j(t.map(a=>({rawItemId:a.rawItemId,quantity:a.quantity.toString(),unit:a.unit}))):j([{rawItemId:"",quantity:"",unit:"g"}]),O(!0)},Re=()=>{if(!G)return;const s=Z.filter(t=>t.rawItemId&&t.quantity&&parseFloat(t.quantity)>0);if(s.length===0){r({title:"أضف مكون واحد على الأقل",variant:"destructive"});return}ne.mutate({coffeeItemId:G.id,ingredients:s.map(t=>({rawItemId:t.rawItemId,quantity:parseFloat(t.quantity),unit:t.unit}))})},De=s=>{switch(s){case"critical":return"bg-red-500";case"low":return"bg-background0";default:return"bg-green-500"}},Ee=s=>{switch(s){case"critical":return"bg-red-500/10 border-red-500/30";case"low":return"bg-background0/10 border-amber-500/30";default:return"bg-green-500/10 border-green-500/30"}};return Se?e.jsx("div",{className:"min-h-screen flex items-center justify-center",dir:"rtl",children:e.jsx(T,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-background",dir:"rtl",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-background border-b p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>window.history.back(),"data-testid":"button-back",children:e.jsx(Le,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl font-bold",children:"المخزون والوصفات"})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(I,{value:v,onValueChange:ye,children:[e.jsx(C,{className:"w-40","data-testid":"select-branch",children:e.jsx(S,{placeholder:"الفرع"})}),e.jsxs(k,{children:[e.jsx(i,{value:"all",children:"جميع الفروع"}),Ce.map(s=>e.jsx(i,{value:s.id,children:s.nameAr},s.id))]})]}),e.jsxs(c,{onClick:()=>q(!0),"data-testid":"button-add-item",children:[e.jsx(le,{className:"h-4 w-4 ml-2"}),"إضافة مكون"]})]})]})}),e.jsxs("main",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(b,{className:"border-2",children:e.jsxs(y,{className:"p-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/10",children:e.jsx(W,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"المكونات"}),e.jsx("p",{className:"text-xl font-bold",children:N.length})]})]})}),e.jsx(b,{className:"border-2",children:e.jsxs(y,{className:"p-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-background0/10",children:e.jsx(ue,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"مخزون منخفض"}),e.jsx("p",{className:"text-xl font-bold text-accent",children:Ae})]})]})}),e.jsx(b,{className:"border-2",children:e.jsxs(y,{className:"p-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-500/10",children:e.jsx(Ge,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"بوصفات"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:[oe,"/",ee.length]})]})]})}),e.jsx(b,{className:"border-2",children:e.jsxs(y,{className:"p-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-purple-500/10",children:e.jsx(je,{className:"h-5 w-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"متوسط الربح"}),e.jsx("p",{className:"text-xl font-bold",children:F.length>0?`${(F.reduce((s,t)=>s+(t.hasRecipe?t.profitMargin:0),0)/Math.max(oe,1)).toFixed(0)}%`:"-"})]})]})})]}),e.jsx(b,{className:"bg-gradient-to-l from-blue-500/10 to-transparent border-blue-500/30",children:e.jsx(y,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/20 shrink-0",children:e.jsx(W,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h3",{className:"font-bold text-blue-600 dark:text-blue-400",children:"نصائح سريعة"}),e.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500"}),e.jsxs("span",{children:[e.jsx("strong",{children:"الأخضر:"})," المخزون كافي - لا يحتاج إضافة"]})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-background0"}),e.jsxs("span",{children:[e.jsx("strong",{children:"البرتقالي:"})," مخزون منخفض - يفضل الطلب قريباً"]})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-red-500"}),e.jsxs("span",{children:[e.jsx("strong",{children:"الأحمر:"})," مخزون حرج - يجب الطلب فوراً"]})]}),e.jsxs("li",{className:"flex items-center gap-2 mt-2",children:[e.jsx(je,{className:"w-3 h-3 text-purple-500"}),e.jsx("span",{children:"تكلفة الوصفة تُحسب تلقائياً من المكونات لحساب الربح"})]})]})]})]})})}),e.jsxs("div",{className:"relative",children:[e.jsx(Me,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(g,{placeholder:"بحث...",value:$,onChange:s=>be(s.target.value),className:"pr-10","data-testid":"input-search"})]}),e.jsxs(Qe,{value:h,onValueChange:Ne,children:[e.jsxs(Oe,{className:"grid w-full grid-cols-2",children:[e.jsxs(me,{value:"stock",className:"text-base py-3","data-testid":"tab-stock",children:[e.jsx(W,{className:"h-5 w-5 ml-2"}),"المخزون"]}),e.jsxs(me,{value:"recipes",className:"text-base py-3","data-testid":"tab-recipes",children:[e.jsx(re,{className:"h-5 w-5 ml-2"}),"الوصفات"]})]}),e.jsxs(xe,{value:"stock",className:"mt-4",children:[v==="all"&&e.jsxs("div",{className:"mb-4 p-4 bg-background0/10 rounded-lg border border-amber-500/30 flex items-center gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-accent shrink-0"}),e.jsx("p",{className:"text-sm",children:"اختر فرع محدد لإضافة أو تعديل المخزون"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[ie.map(s=>e.jsx(b,{className:`border-2 transition-all ${Ee(s.status)}`,"data-testid":`card-stock-${s.id}`,children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-lg truncate",children:s.nameAr}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(he,{variant:"secondary",className:"text-xs",children:Ye[s.category||"other"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.unitCost.toFixed(2)," ر.س/",L[s.unit]]})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>p(s),"data-testid":`button-edit-item-${s.id}`,children:e.jsx(ge,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>X(s.id),"data-testid":`button-delete-item-${s.id}`,children:e.jsx(pe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-2xl font-bold",children:fe(s.currentQuantity,s.unit)}),e.jsx("div",{className:`w-3 h-3 rounded-full ${De(s.status)}`})]}),e.jsx(Ve,{value:s.percentage,className:"h-2"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["الحد الأدنى: ",fe(s.minimumStock,s.unit)]})]}),e.jsxs(c,{className:"w-full",variant:s.status==="critical"?"default":"outline",onClick:()=>{if(v==="all"){r({title:"اختر فرع محدد أولاً",variant:"destructive"});return}M(s),_("")},"data-testid":`button-add-stock-${s.id}`,children:[e.jsx(Ke,{className:"h-4 w-4 ml-2"}),"إضافة للمخزون"]})]})},s.id)),ie.length===0&&e.jsxs("div",{className:"col-span-full text-center py-12 text-muted-foreground",children:[e.jsx(W,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد مكونات بعد"}),e.jsxs(c,{variant:"outline",className:"mt-4",onClick:()=>q(!0),children:[e.jsx(le,{className:"h-4 w-4 ml-2"}),"إضافة أول مكون"]})]})]})]}),e.jsx(xe,{value:"recipes",className:"mt-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[F.map(s=>e.jsx(b,{className:`border-2 transition-all ${s.hasRecipe?"border-green-500/30 bg-green-500/5":"border-amber-500/30 bg-background0/5"}`,"data-testid":`card-recipe-${s.id}`,children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:s.nameAr,className:"w-14 h-14 rounded-lg object-cover shrink-0"}):e.jsx("div",{className:"w-14 h-14 rounded-lg bg-muted flex items-center justify-center shrink-0",children:e.jsx(re,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-lg truncate",children:s.nameAr}),e.jsxs("p",{className:"text-lg font-semibold text-muted-foreground",children:[s.price.toFixed(2)," ر.س"]})]}),e.jsx(he,{variant:s.hasRecipe?"default":"secondary",children:s.hasRecipe?"مكتملة":"بدون وصفة"})]}),s.hasRecipe&&e.jsxs("div",{className:"grid grid-cols-3 gap-2 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"التكلفة"}),e.jsx("p",{className:"font-bold",children:s.recipeCost.toFixed(2)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"الربح"}),e.jsx("p",{className:`font-bold ${s.profit>0?"text-green-600":"text-red-600"}`,children:s.profit.toFixed(2)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"النسبة"}),e.jsxs("p",{className:`font-bold ${s.profitMargin>=50?"text-green-600":s.profitMargin>=30?"text-accent":"text-red-600"}`,children:[s.profitMargin.toFixed(0),"%"]})]})]}),s.hasRecipe&&s.recipes.length>0&&e.jsx("div",{className:"text-xs text-muted-foreground space-y-1 max-h-32 overflow-y-auto",children:s.recipes.map((t,a)=>{const n=N.find(l=>l.id===t.rawItemId);return e.jsxs("p",{children:[n?.nameAr,": ",t.quantity," ",L[t.unit]]},a)})}),e.jsxs(c,{className:"w-full",variant:"outline",onClick:()=>Fe(s),"data-testid":`button-edit-recipe-${s.id}`,children:[e.jsx(ge,{className:"h-4 w-4 ml-2"}),s.hasRecipe?"تعديل الوصفة":"إضافة وصفة"]})]})},s.id)),F.length===0&&e.jsxs("div",{className:"col-span-full text-center py-12 text-muted-foreground",children:[e.jsx(re,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد مشروبات لإضافة وصفات لها"})]})]})})]})]}),e.jsx(V,{open:we,onOpenChange:q,children:e.jsxs(B,{className:"max-w-md",children:[e.jsxs(z,{children:[e.jsx(U,{children:"إضافة مكون جديد"}),e.jsx(ce,{children:"أضف مكون لاستخدامه في وصفات المشروبات"})]}),e.jsxs("form",{onSubmit:$e,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"اسم المكون *"}),e.jsx(g,{value:x.nameAr,onChange:s=>A(t=>({...t,nameAr:s.target.value})),placeholder:"مثال: بن عربي",required:!0,"data-testid":"input-new-item-name"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الوحدة"}),e.jsxs(I,{value:x.unit,onValueChange:s=>A(t=>({...t,unit:s})),children:[e.jsx(C,{"data-testid":"select-new-item-unit",children:e.jsx(S,{})}),e.jsxs(k,{children:[e.jsx(i,{value:"kg",children:"كيلوجرام"}),e.jsx(i,{value:"g",children:"جرام"}),e.jsx(i,{value:"liter",children:"لتر"}),e.jsx(i,{value:"ml",children:"ملليلتر"}),e.jsx(i,{value:"piece",children:"قطعة"}),e.jsx(i,{value:"box",children:"صندوق"}),e.jsx(i,{value:"bag",children:"كيس"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الفئة"}),e.jsxs(I,{value:x.category,onValueChange:s=>A(t=>({...t,category:s})),children:[e.jsx(C,{"data-testid":"select-new-item-category",children:e.jsx(S,{})}),e.jsxs(k,{children:[e.jsx(i,{value:"ingredient",children:"مكون"}),e.jsx(i,{value:"packaging",children:"تغليف"}),e.jsx(i,{value:"equipment",children:"معدات"}),e.jsx(i,{value:"consumable",children:"مستهلكات"}),e.jsx(i,{value:"other",children:"أخرى"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{children:["التكلفة لكل ",ve[x.unit]," *"]}),e.jsx(g,{type:"number",step:"0.01",value:x.unitCost,onChange:s=>A(t=>({...t,unitCost:s.target.value})),placeholder:"0.00",required:!0,"data-testid":"input-new-item-cost"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الحد الأدنى"}),e.jsx(g,{type:"number",step:"0.1",value:x.minimumStock,onChange:s=>A(t=>({...t,minimumStock:s.target.value})),"data-testid":"input-new-item-min"})]})]}),e.jsxs(H,{children:[e.jsx(c,{type:"button",variant:"outline",onClick:()=>q(!1),children:"إلغاء"}),e.jsxs(c,{type:"submit",disabled:se.isPending,"data-testid":"button-submit-new-item",children:[se.isPending&&e.jsx(T,{className:"h-4 w-4 ml-2 animate-spin"}),"إضافة"]})]})]})]})}),e.jsx(V,{open:!!m,onOpenChange:()=>p(null),children:e.jsxs(B,{className:"max-w-md",children:[e.jsx(z,{children:e.jsx(U,{children:"تعديل المكون"})}),m&&e.jsxs("form",{onSubmit:s=>{s.preventDefault(),te.mutate({id:m.id,updates:{nameAr:m.nameAr,unit:m.unit,unitCost:m.unitCost,category:m.category,minStockLevel:m.minimumStock}})},className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"اسم المكون"}),e.jsx(g,{value:m.nameAr,onChange:s=>p(t=>t?{...t,nameAr:s.target.value}:null),"data-testid":"input-edit-item-name"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الوحدة"}),e.jsxs(I,{value:m.unit,onValueChange:s=>p(t=>t?{...t,unit:s}:null),children:[e.jsx(C,{children:e.jsx(S,{})}),e.jsxs(k,{children:[e.jsx(i,{value:"kg",children:"كيلوجرام"}),e.jsx(i,{value:"g",children:"جرام"}),e.jsx(i,{value:"liter",children:"لتر"}),e.jsx(i,{value:"ml",children:"ملليلتر"}),e.jsx(i,{value:"piece",children:"قطعة"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الفئة"}),e.jsxs(I,{value:m.category||"ingredient",onValueChange:s=>p(t=>t?{...t,category:s}:null),children:[e.jsx(C,{children:e.jsx(S,{})}),e.jsxs(k,{children:[e.jsx(i,{value:"ingredient",children:"مكون"}),e.jsx(i,{value:"packaging",children:"تغليف"}),e.jsx(i,{value:"equipment",children:"معدات"}),e.jsx(i,{value:"consumable",children:"مستهلكات"}),e.jsx(i,{value:"other",children:"أخرى"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"التكلفة"}),e.jsx(g,{type:"number",step:"0.01",value:m.unitCost,onChange:s=>p(t=>t?{...t,unitCost:parseFloat(s.target.value)||0}:null)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الحد الأدنى"}),e.jsx(g,{type:"number",step:"0.1",value:m.minimumStock||10,onChange:s=>p(t=>t?{...t,minimumStock:parseFloat(s.target.value)||10}:null)})]})]}),e.jsxs(H,{children:[e.jsx(c,{type:"button",variant:"outline",onClick:()=>p(null),children:"إلغاء"}),e.jsxs(c,{type:"submit",disabled:te.isPending,children:[te.isPending&&e.jsx(T,{className:"h-4 w-4 ml-2 animate-spin"}),"حفظ"]})]})]})]})}),e.jsx(V,{open:!!f,onOpenChange:()=>M(null),children:e.jsxs(B,{className:"max-w-sm",children:[e.jsxs(z,{children:[e.jsxs(U,{children:["إضافة مخزون - ",f?.nameAr]}),e.jsxs(ce,{children:["أدخل الكمية بـ",f?ve[f.unit]:""]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"الكمية المضافة"}),e.jsx(g,{type:"number",step:"0.01",value:Q,onChange:s=>_(s.target.value),placeholder:`مثال: 2 ${f?L[f.unit]:""}`,autoFocus:!0,"data-testid":"input-add-stock-quantity"})]}),e.jsxs(H,{children:[e.jsx(c,{type:"button",variant:"outline",onClick:()=>M(null),children:"إلغاء"}),e.jsxs(c,{onClick:qe,disabled:ae.isPending||!Q,"data-testid":"button-confirm-add-stock",children:[ae.isPending&&e.jsx(T,{className:"h-4 w-4 ml-2 animate-spin"}),"إضافة"]})]})]})]})}),e.jsx(Be,{open:!!J,onOpenChange:()=>X(null),children:e.jsxs(ze,{children:[e.jsxs(Ue,{children:[e.jsx(He,{children:"تأكيد الحذف"}),e.jsx(We,{children:"هل أنت متأكد من حذف هذا المكون؟ لا يمكن التراجع عن هذا."})]}),e.jsxs(Je,{children:[e.jsx(Xe,{children:"إلغاء"}),e.jsx(_e,{onClick:()=>J&&ke.mutate(J),className:"bg-destructive text-destructive-foreground",children:"حذف"})]})]})}),e.jsx(V,{open:Ie,onOpenChange:O,children:e.jsxs(B,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsxs(z,{children:[e.jsxs(U,{children:["وصفة ",G?.nameAr]}),e.jsx(ce,{children:"حدد المكونات لكوب 250 مل"})]}),e.jsxs("div",{className:"space-y-3",children:[Z.map((s,t)=>e.jsxs("div",{className:"flex items-end gap-2 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx(u,{className:"text-xs",children:"المكون"}),e.jsxs(I,{value:s.rawItemId,onValueChange:a=>{j(n=>n.map((l,d)=>d===t?{...l,rawItemId:a}:l))},children:[e.jsx(C,{"data-testid":`select-recipe-ingredient-${t}`,children:e.jsx(S,{placeholder:"اختر"})}),e.jsx(k,{children:N.map(a=>e.jsx(i,{value:a.id,children:a.nameAr},a.id))})]})]}),e.jsxs("div",{className:"w-20 space-y-1",children:[e.jsx(u,{className:"text-xs",children:"الكمية"}),e.jsx(g,{type:"number",step:"0.01",value:s.quantity,onChange:a=>{j(n=>n.map((l,d)=>d===t?{...l,quantity:a.target.value}:l))},"data-testid":`input-recipe-quantity-${t}`})]}),e.jsxs("div",{className:"w-24 space-y-1",children:[e.jsx(u,{className:"text-xs",children:"الوحدة"}),e.jsxs(I,{value:s.unit,onValueChange:a=>{j(n=>n.map((l,d)=>d===t?{...l,unit:a}:l))},children:[e.jsx(C,{"data-testid":`select-recipe-unit-${t}`,children:e.jsx(S,{})}),e.jsxs(k,{children:[e.jsx(i,{value:"g",children:"جرام"}),e.jsx(i,{value:"ml",children:"مل"}),e.jsx(i,{value:"piece",children:"قطعة"})]})]})]}),e.jsx(c,{type:"button",variant:"ghost",size:"icon",onClick:()=>{j(a=>a.filter((n,l)=>l!==t))},disabled:Z.length===1,"data-testid":`button-remove-ingredient-${t}`,children:e.jsx(pe,{className:"h-4 w-4"})})]},t)),e.jsxs(c,{type:"button",variant:"outline",onClick:()=>j(s=>[...s,{rawItemId:"",quantity:"",unit:"g"}]),className:"w-full","data-testid":"button-add-recipe-ingredient",children:[e.jsx(le,{className:"h-4 w-4 ml-2"}),"إضافة مكون"]})]}),e.jsxs(H,{children:[e.jsx(c,{type:"button",variant:"outline",onClick:()=>{O(!1),Y(null),j([])},children:"إلغاء"}),e.jsxs(c,{type:"button",onClick:Re,disabled:ne.isPending,"data-testid":"button-save-recipe",children:[ne.isPending&&e.jsx(T,{className:"h-4 w-4 ml-2 animate-spin"}),"حفظ الوصفة"]})]})]})})]})}export{ms as default};
