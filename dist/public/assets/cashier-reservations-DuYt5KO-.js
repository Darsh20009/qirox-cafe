import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as o}from"./vendor-react-Bzsngnqy.js";import{a as E,b}from"./vendor-query-CX8ZYlKb.js";import{e as I,C as d,x as F,y as P,Y as N,f as x,I as B,B as l,p as O,r as R,j as m,N as f}from"./index-61RjstaY.js";import{U as q}from"./users-Btf_-tK9.js";import{C as $}from"./calendar-Cex3TfGh.js";import{C as z}from"./clock-3-ImZ6UTtV.js";import{C as G}from"./circle-check-C68tr6Vl.js";import{C as K}from"./circle-x-D9GYVDcC.js";import"./vendor-utils-BKCsaWdX.js";function W(){const{toast:c}=I(),[h,y]=o.useState(""),[g,u]=o.useState([]),[r,p]=o.useState("time"),{data:n=[],isLoading:w}=E({queryKey:["/api/tables"],queryFn:async()=>{const s=await fetch("/api/tables");if(!s.ok)throw new Error("Failed to fetch tables");return(await s.json()).filter(a=>a.reservedFor&&["pending","confirmed"].includes(a.reservedFor.status)).map(a=>({tableId:a.id,tableNumber:a.tableNumber,branchId:a.branchId,reservation:a.reservedFor}))}}),C=async()=>{if(!h.trim()){u(n);return}try{const s=await fetch(`/api/tables/reservations/customer/${h}`);if(s.ok){const t=await s.json();u(t)}}catch{c({title:"خطأ",description:"فشل البحث عن الحجوزات",variant:"destructive"})}},v=b({mutationFn:async s=>{const t=await fetch(`/api/tables/${s}/approve-reservation`,{method:"POST"});if(!t.ok)throw new Error("فشل في تأكيد الحجز");return t.json()},onSuccess:()=>{c({title:"تم",description:"تم تأكيد الحجز بنجاح",className:"bg-green-600 text-white border-green-700"}),f.invalidateQueries({queryKey:["/api/tables"]})},onError:s=>{c({title:"خطأ",description:s.message,variant:"destructive"})}}),j=b({mutationFn:async s=>{const t=await fetch(`/api/tables/${s}/cancel-reservation`,{method:"POST"});if(!t.ok)throw new Error("فشل في إلغاء الحجز");return t.json()},onSuccess:()=>{c({title:"تم",description:"تم إلغاء الحجز",className:"bg-red-600 text-white border-red-700"}),f.invalidateQueries({queryKey:["/api/tables"]})},onError:s=>{c({title:"خطأ",description:s.message,variant:"destructive"})}});o.useEffect(()=>{let s=[...n];if(r==="time")s.sort((t,i)=>{const a=new Date(t.reservation.reservationDate).getTime(),D=new Date(i.reservation.reservationDate).getTime();return a-D});else if(r==="guests")s.sort((t,i)=>i.reservation.numberOfGuests-t.reservation.numberOfGuests);else if(r==="status"){const t={pending:0,confirmed:1,cancelled:2,expired:3,completed:4};s.sort((i,a)=>(t[i.reservation.status]||5)-(t[a.reservation.status]||5))}u(s)},[n,r]);const k=s=>{switch(s){case"pending":return e.jsx(m,{variant:"outline",className:"bg-yellow-50 text-yellow-800 border-yellow-300",children:"قيد الانتظار"});case"confirmed":return e.jsx(m,{className:"bg-green-600 text-white",children:"مؤكد"});case"cancelled":return e.jsx(m,{variant:"outline",className:"bg-red-50 text-red-800 border-red-300",children:"ملغى"});case"expired":return e.jsx(m,{variant:"outline",className:"bg-gray-50 text-gray-800 border-gray-300",children:"منتهي"});default:return null}},S=s=>{try{return new Date(s).toLocaleTimeString("ar",{hour:"2-digit",minute:"2-digit",hour12:!0})}catch{return s}},T=s=>{try{return new Date(s).toLocaleDateString("ar")}catch{return s}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-4",dir:"rtl",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:"إدارة الحجوزات"}),e.jsx("p",{className:"text-gray-600",children:"عرض وإدارة جميع حجوزات الطاولات"})]}),e.jsxs(d,{className:"mb-8 shadow-lg",children:[e.jsx(F,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5"}),"البحث والتصفية"]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{placeholder:"رقم الجوال (مثال: 501234567)",value:h,onChange:s=>y(s.target.value),className:"flex-1","data-testid":"input-search-phone"}),e.jsxs(l,{onClick:C,className:"bg-blue-600 hover:bg-blue-700","data-testid":"button-search",children:[e.jsx(N,{className:"w-4 h-4 ml-2"}),"بحث"]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(l,{variant:r==="time"?"default":"outline",size:"sm",onClick:()=>p("time"),className:"text-xs","data-testid":"button-sort-time",children:"الترتيب حسب الوقت"}),e.jsx(l,{variant:r==="guests"?"default":"outline",size:"sm",onClick:()=>p("guests"),className:"text-xs","data-testid":"button-sort-guests",children:"الترتيب حسب عدد الضيوف"}),e.jsx(l,{variant:r==="status"?"default":"outline",size:"sm",onClick:()=>p("status"),className:"text-xs","data-testid":"button-sort-status",children:"الترتيب حسب الحالة"})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2 pt-4 border-t",children:[e.jsxs("div",{className:"text-center p-2 bg-blue-50 rounded",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:n.length}),e.jsx("p",{className:"text-xs text-gray-600",children:"إجمالي"})]}),e.jsxs("div",{className:"text-center p-2 bg-yellow-50 rounded",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:n.filter(s=>s.reservation.status==="pending").length}),e.jsx("p",{className:"text-xs text-gray-600",children:"قيد الانتظار"})]}),e.jsxs("div",{className:"text-center p-2 bg-green-50 rounded",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:n.filter(s=>s.reservation.status==="confirmed").length}),e.jsx("p",{className:"text-xs text-gray-600",children:"مؤكدة"})]}),e.jsxs("div",{className:"text-center p-2 bg-gray-50 rounded",children:[e.jsx("p",{className:"text-2xl font-bold text-gray-600",children:n.filter(s=>s.reservation.status==="expired").length}),e.jsx("p",{className:"text-xs text-gray-600",children:"منتهية"})]})]})]})]}),e.jsx("div",{className:"grid gap-4",children:w?e.jsx(d,{children:e.jsx(x,{className:"pt-8 text-center text-gray-500",children:"جاري تحميل الحجوزات..."})}):g.length===0?e.jsx(d,{children:e.jsx(x,{className:"pt-8 text-center text-gray-500",children:"لا توجد حجوزات"})}):g.map(s=>e.jsx(d,{className:"shadow-md hover:shadow-lg transition-shadow",children:e.jsxs(x,{className:"pt-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:["طاولة ",s.tableNumber]}),e.jsx("div",{children:k(s.reservation.status)})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(q,{className:"w-5 h-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:s.reservation.customerName}),e.jsxs("p",{className:"text-sm text-gray-600",children:["عدد الضيوف: ",s.reservation.numberOfGuests]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(O,{className:"w-5 h-5 text-blue-500"}),e.jsxs("span",{children:["+966",s.reservation.customerPhone]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx($,{className:"w-5 h-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:T(s.reservation.reservationDate)}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reservation.reservationTime})]})]}),s.reservation.autoExpiryTime&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(z,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ينتهي في:"}),e.jsx("p",{className:"font-semibold text-orange-600",children:S(s.reservation.autoExpiryTime)})]})]}),s.reservation.extensionCount?e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx(R,{className:"w-5 h-5"}),e.jsx("p",{className:"text-sm",children:"تم تمديد الحجز"})]}):null]})]}),s.reservation.status==="pending"&&e.jsxs("div",{className:"mt-6 flex gap-3 pt-4 border-t",children:[e.jsxs(l,{onClick:()=>v.mutate(s.tableId),disabled:v.isPending,className:"flex-1 bg-green-600 hover:bg-green-700 text-white","data-testid":`button-confirm-${s.tableId}`,children:[e.jsx(G,{className:"w-4 h-4 ml-2"}),"تأكيد الحجز"]}),e.jsxs(l,{onClick:()=>j.mutate(s.tableId),disabled:j.isPending,variant:"destructive",className:"flex-1","data-testid":`button-cancel-${s.tableId}`,children:[e.jsx(K,{className:"w-4 h-4 ml-2"}),"إلغاء الحجز"]})]})]})},s.tableId))})]})})}export{W as default};
