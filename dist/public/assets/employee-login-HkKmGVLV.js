import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as a}from"./vendor-react-Bzsngnqy.js";import{c as q,C as N,x as w,y as v,V as S,f as C,B as c,U as I,I as E,q as M,W as T,R as D}from"./index-CLvpp2UE.js";import{b as U}from"./vendor-query-CX8ZYlKb.js";import{H as Y}from"./html5-qrcode-scanner-BAmOd9U4.js";import{c as O}from"./cluny-logo-staff-CmYJfeKH.js";import{L as B}from"./lock-Dvxo6ahY.js";import{E as F}from"./eye-off-AEXWPIZp.js";import{E as H}from"./eye-cZNGFzyE.js";import"./vendor-utils-BKCsaWdX.js";function ee(){const[J,d]=q(),[m,k]=a.useState(""),[u,f]=a.useState(""),[p,L]=a.useState(!1),[l,o]=a.useState(""),[i,b]=a.useState(!1),x=a.useRef(null),[R,P]=a.useState(!0),[h,g]=a.useState(null);a.useEffect(()=>{document.title="تسجيل دخول الموظفين - CLUNY SYSTEMS";const t=r=>{r.preventDefault(),g(r)};window.addEventListener("beforeinstallprompt",t);const s=localStorage.getItem("currentEmployee");if(s)try{const r=JSON.parse(s);if(r&&r.id){window.location.href="/employee/dashboard";return}}catch{}return()=>{window.removeEventListener("beforeinstallprompt",t)}},[]);const n=U({mutationFn:async t=>{const r=!!t.employeeId&&!t.username?"/api/employees/login-qr":"/api/employees/login",j=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!j.ok)throw new Error("Login failed");return j.json()},onSuccess:t=>{localStorage.setItem("currentEmployee",JSON.stringify(t)),window.location.href="/employee/dashboard"},onError:()=>{o("بيانات تسجيل الدخول غير صحيحة"),f("")}}),Q=t=>{if(t.preventDefault(),o(""),!m||!u){o("الرجاء إدخال اسم المستخدم وكلمة المرور");return}n.mutate({username:m,password:u})};a.useEffect(()=>{if(!i)return;const t=new Y("qr-reader",{fps:10,qrbox:{width:250,height:250}},!1);return t.render(s=>{try{const r=s.trim();r?(o(""),t.clear(),b(!1),n.mutate({employeeId:r})):o("صيغة QR غير صحيحة")}catch{o("خطأ في قراءة QR الكود")}},s=>{console.debug("QR scan error:",s)}),x.current=t,()=>{x.current&&x.current.clear().catch(()=>{})}},[i,n]);const y=()=>{o(""),b(!i)};return e.jsx("div",{dir:"rtl",className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-40 h-28 mb-4",children:e.jsx("img",{src:O,alt:"CLUNY SYSTEMS",className:"w-full h-full object-contain"})}),e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-2 font-playfair",children:"CLUNY SYSTEMS"}),e.jsx("p",{className:"text-muted-foreground font-cairo",children:"تسجيل دخول الموظف"})]}),i?e.jsxs(N,{className:"bg-card border-border/50 shadow-lg",children:[e.jsxs(w,{children:[e.jsx(v,{className:"text-2xl text-center font-playfair text-accent",children:"مسح بطاقة الموظف"}),e.jsx(S,{className:"text-center text-muted-foreground",children:"وجه الكاميرا نحو QR الكود الموجود على بطاقتك"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsx("div",{id:"qr-reader",className:"w-full overflow-hidden rounded-md border border-border"}),l&&e.jsx("p",{className:"text-destructive text-sm text-center","data-testid":"text-qr-error",children:l}),e.jsx(c,{type:"button",variant:"outline",onClick:y,className:"w-full border-primary/20 text-primary","data-testid":"button-cancel-qr",children:"إلغاء"})]})]}):e.jsxs(N,{className:"bg-card border-border/50 shadow-lg",children:[e.jsxs(w,{children:[e.jsx(v,{className:"text-2xl text-center font-playfair text-foreground",children:"تسجيل الدخول"}),e.jsx(S,{className:"text-center text-muted-foreground",children:"أدخل بيانات حسابك للوصول"})]}),e.jsx(C,{children:e.jsxs("form",{onSubmit:Q,className:"space-y-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(I,{className:"absolute right-3 top-3 h-5 w-5 text-primary"}),e.jsx(E,{type:"text",placeholder:"اسم المستخدم",value:m,onChange:t=>k(t.target.value),className:"pr-10 bg-background border-border","data-testid":"input-username",autoFocus:!0,disabled:n.isPending})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"absolute right-3 top-3 h-5 w-5 text-primary"}),e.jsx(E,{type:p?"text":"password",placeholder:"كلمة المرور",value:u,onChange:t=>f(t.target.value),className:"pr-10 pl-10 bg-background border-border","data-testid":"input-password",disabled:n.isPending}),e.jsx("button",{type:"button",onClick:()=>L(!p),className:"absolute left-3 top-3 text-primary hover:text-primary/80","data-testid":"button-toggle-password",children:p?e.jsx(F,{className:"h-5 w-5"}):e.jsx(H,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>d("/employee/forgot-password"),className:"text-xs text-accent hover:text-accent/80 underline","data-testid":"link-forgot-password",children:"نسيت كلمة المرور؟"})}),l&&e.jsx("p",{className:"text-destructive text-sm text-right","data-testid":"text-error",children:l})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse mb-4",children:[e.jsx("input",{type:"checkbox",id:"remember-me",checked:R,onChange:t=>P(t.target.checked),className:"w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"}),e.jsx("label",{htmlFor:"remember-me",className:"text-sm text-muted-foreground mr-2",children:"تذكرني"})]}),e.jsx(c,{type:"submit",disabled:n.isPending,className:"w-full bg-gradient-to-r from-accent to-accent/90 hover:from-accent/95 hover:to-accent/85 text-accent-foreground font-bold","data-testid":"button-login",children:n.isPending?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"ml-2 h-4 w-4 animate-spin"}),"جاري تسجيل الدخول..."]}):"دخول"}),e.jsxs("div",{className:"pt-4 border-t border-border space-y-2",children:[e.jsxs(c,{type:"button",variant:"secondary",onClick:y,className:"w-full bg-secondary hover:bg-secondary/90 text-secondary-foreground","data-testid":"button-scan-qr",children:[e.jsx(T,{className:"w-4 h-4 ml-2"}),"مسح بطاقة الموظف"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"موظف جديد؟"}),e.jsx(c,{type:"button",variant:"outline",onClick:()=>d("/employee/activate"),className:"w-full border-primary/20 text-primary","data-testid":"button-activate",children:"تفعيل حساب جديد"}),e.jsx("div",{className:"py-2",children:e.jsxs(c,{type:"button",variant:"ghost",onClick:async()=>{const t=document.getElementById("main-manifest");t&&(t.href="/employee-manifest.json");const s=t.cloneNode(!0);if(s.href="/employee-manifest.json?v="+Date.now(),t.parentNode?.replaceChild(s,t),h){h.prompt();const{outcome:r}=await h.userChoice;r==="accepted"&&g(null)}else{const r=navigator.userAgent.toLowerCase();/iphone|ipad|ipod/.test(r)?alert("لتثبيت النظام على iPhone: اضغط على زر 'مشاركة' ثم 'إضافة إلى الشاشة الرئيسية'"):alert("لتثبيت النظام: اضغط على القائمة (⋮) ثم 'تثبيت التطبيق'")}},className:"w-full text-primary font-bold hover:bg-primary/5",children:[e.jsx(D,{className:"ml-2 h-4 w-4"}),"تحميل نظام الموظفين"]})})]})]})})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx(c,{variant:"ghost",onClick:()=>d("/employee/gateway"),className:"text-primary hover:text-primary/80","data-testid":"link-back",children:"رجوع"})})]})})}export{ee as default};
