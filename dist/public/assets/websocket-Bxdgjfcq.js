import{r as t}from"./vendor-react-Bzsngnqy.js";function v({clientType:W,orderId:g,branchId:y,customerId:m,onNewOrder:p,onOrderUpdated:C,onOrderReady:w,onPointsVerificationCode:R,enabled:f=!0}){const e=t.useRef(null),a=t.useRef(null),S=t.useRef(null),n=t.useRef(!1),s=t.useRef(!0),[E,d]=t.useState(!1),[O,h]=t.useState(null),[N,L]=t.useState(null),o=t.useCallback(()=>{S.current&&(clearInterval(S.current),S.current=null),a.current&&(clearTimeout(a.current),a.current=null)},[]),b=t.useCallback(i=>{i.readyState===WebSocket.OPEN&&i.send(JSON.stringify({type:"subscribe",clientType:W,orderId:g,branchId:y,customerId:m}))},[W,g,y]),l=t.useCallback(()=>{if(!f||!s.current||n.current||e.current&&e.current.readyState===WebSocket.OPEN)return;if(o(),n.current=!0,e.current){try{e.current.readyState!==WebSocket.CLOSED&&e.current.readyState!==WebSocket.CLOSING&&e.current.close(1e3,"Reconnecting")}catch{}e.current=null}const i=window.location.protocol==="https:"?"wss:":"ws:",_=window.location.host,I=`${i}//${_}/ws/orders`;try{const r=new WebSocket(I);e.current=r,r.onopen=()=>{if(!s.current){r.close();return}console.log("[WS] Connected to orders WebSocket"),n.current=!1,d(!0),b(r),S.current=setInterval(()=>{r.readyState===WebSocket.OPEN?r.send(JSON.stringify({type:"ping"})):o()},3e4)},r.onmessage=u=>{if(s.current)try{const c=JSON.parse(u.data);switch(h(c),c.type){case"new_order":p?.(c.order);break;case"order_updated":C?.(c.order);break;case"order_ready":w?.(c.order);break;case"points_verification_code":R?.(c);break;case"welcome":b(r);break}}catch(c){console.error("[WS] Error parsing message:",c)}},r.onclose=u=>{console.log("[WS] Connection closed:",u.code,u.reason),n.current=!1,d(!1),o(),s.current&&f&&(a.current=setTimeout(()=>{l()},3e3))},r.onerror=u=>{console.error("[WS] WebSocket error:",u),L("خطأ في الاتصال - جاري إعادة المحاولة"),d(!1),n.current=!1}}catch(r){console.error("[WS] Failed to create WebSocket:",r),n.current=!1,s.current&&f&&(a.current=setTimeout(()=>{l()},5e3))}},[f,o,b,p,C,w]),k=t.useCallback(()=>{if(o(),n.current=!1,e.current){try{e.current.readyState!==WebSocket.CLOSED&&e.current.readyState!==WebSocket.CLOSING&&e.current.close(1e3,"Disconnecting")}catch{}e.current=null}d(!1)},[o]);return t.useEffect(()=>(s.current=!0,l(),()=>{s.current=!1,k()}),[l,k]),{isConnected:E,lastMessage:O,error:N,reconnect:l,disconnect:k}}export{v as u};
