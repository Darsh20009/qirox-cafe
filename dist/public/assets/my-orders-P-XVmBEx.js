import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as d}from"./vendor-react-Bzsngnqy.js";import{B as u,R as F,a3 as T,e as S,C as h,f as v,Q as y,x as D,y as I,L as N,I as w,ao as P,v as C,N as L,c as O,t as R,w as E,A as $,i as j}from"./index-CLvpp2UE.js";import{b as k,a as q}from"./vendor-query-CX8ZYlKb.js";import{c as M,O as Q}from"./cluny-logo-8QEDrvoN.js";import{E as U}from"./jspdf.es.min-DC5GMwbl.js";import z from"./html2canvas.esm-BfxBtG_O.js";import{P as H}from"./printer-CMPCONS0.js";import{C as Y}from"./checkbox-pP3s8YPe.js";import{C as A}from"./car-0OJdyCDc.js";import{C as W}from"./circle-alert-CfteRpPO.js";import{C as B}from"./CustomerLayout-3skT6THQ.js";import"./vendor-utils-BKCsaWdX.js";import"./circle-check-CNDbPLNF.js";import"./customer-footer-DFb6iF4V.js";import"./clipboard-list-C6fMKNlJ.js";function K({order:s,variant:i="button"}){const n=d.useRef(null),[l,p]=d.useState(""),m=(()=>{try{if(!s||!s.items)return[];const t=s.items;if(Array.isArray(t))return t;if(typeof t=="string")try{const r=JSON.parse(t);return Array.isArray(r)?r:[]}catch{return[]}return typeof t=="object"&&t!==null?Object.values(t):[]}catch(t){return console.error("Error parsing order items:",t,s?.items),[]}})();if(d.useEffect(()=>{(async()=>{if(!(!s||!s.orderNumber))try{const r=`https://www.cluny.cafe/tracking?order=${s.orderNumber}`,o=await T.toDataURL(r,{width:150,margin:1,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"M"});p(o)}catch(r){console.error("Error generating tracking QR code:",r)}})()},[s?.orderNumber]),!s||!s.orderNumber)return null;const g=async()=>{if(n.current)try{const t=await z(n.current,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff"}),r=t.toDataURL("image/png"),o=new U({orientation:"portrait",unit:"mm",format:"a4"}),c=o.internal.pageSize.getWidth(),f=t.height*c/t.width;o.addImage(r,"PNG",0,0,c,f),o.save(`فاتورة-${s.orderNumber}.pdf`)}catch(t){console.error("Error generating PDF:",t)}},x=()=>{if(n.current){const t=window.open("","_blank");if(t){const r=`
          <style>
            @media print {
              body { margin: 0; padding: 0; }
              .no-print { display: none !important; }
              .receipt-container { width: 100%; max-width: 80mm; margin: 0 auto; font-family: sans-serif; }
              @page { size: 80mm auto; margin: 0; }
            }
          </style>
        `,o=`
          <div class="receipt-container" style="direction: rtl; padding: 10px; border-bottom: 2px dashed #000; margin-bottom: 20px;">
            <h2 style="text-align: center; margin: 5px 0;">طلب تحضير</h2>
            <div style="font-size: 24px; font-weight: bold; text-align: center; margin: 10px 0;">
              #${s.orderNumber.includes("-")?s.orderNumber.split("-").pop():s.orderNumber}
            </div>
            <div style="border-top: 1px solid #000; padding-top: 10px;">
              ${m.map(c=>`
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 16px; font-weight: bold;">
                  <span>${c.nameAr||c.name}</span>
                  <span>x${c.quantity}</span>
                </div>
              `).join("")}
            </div>
            ${s.customerNotes?`
              <div style="margin-top: 10px; border: 1px solid #000; padding: 5px; font-size: 14px;">
                <strong>ملاحظات:</strong> ${s.customerNotes}
              </div>
            `:""}
            <div style="text-align: center; font-size: 12px; margin-top: 10px;">
              ${new Date(s.createdAt).toLocaleTimeString("ar-SA")}
            </div>
          </div>
        `;t.document.write(`
          <html>
            <head>${r}</head>
            <body>
              <div class="receipt-container">
                ${n.current.innerHTML}
                ${o}
              </div>
            </body>
          </html>
        `),t.document.close(),setTimeout(()=>{t.print(),t.close()},500)}}};d.useEffect(()=>{if(i==="auto"&&s&&s.id){const t=setTimeout(()=>{x()},1e3);return()=>clearTimeout(t)}},[i,s?.id]);const a=t=>({cash:"نقداً",pos:"جهاز نقاط البيع",delivery:"الدفع عند التوصيل",stc:"STC Pay",alinma:"الإنماء باي",ur:"يور باي",barq:"برق",rajhi:"الراجحي","qahwa-card":"بطاقة قهوة"})[t]||t;return!s||!s.orderNumber?null:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{ref:n,style:{direction:"rtl"},className:"bg-white rounded-lg p-8 border border-primary/20 shadow-lg","data-testid":"invoice-preview",children:[e.jsxs("div",{className:"text-center mb-8 pb-6 border-b-2 border-primary/20",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("img",{src:M,alt:"Logo",className:"h-20 w-20"})}),e.jsx("h1",{className:"text-3xl font-bold text-primary mb-2",children:"فاتورة استلام"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"متجر CLUNY CAFE"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-8 pb-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"رقم الطلب"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:s.orderNumber.includes("-")?s.orderNumber.split("-").pop():s.orderNumber})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"التاريخ والوقت"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:new Date(s.createdAt).toLocaleDateString("ar-SA",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),s.customerInfo?.name&&e.jsx("div",{className:"mb-8 pb-6 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"اسم العميل"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:s.customerInfo.name})]}),s.customerInfo.phone&&e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"رقم الهاتف"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:s.customerInfo.phone})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-lg font-bold text-primary mb-4 pb-2 border-b-2 border-primary/20",children:"تفاصيل الطلب"}),e.jsx("div",{className:"space-y-3",children:m.map((t,r)=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-800",children:t.nameAr||t.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["الكمية: ",t.quantity]})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["السعر: ",parseFloat(t.price||0).toFixed(2)," ريال"]}),e.jsxs("p",{className:"font-bold text-primary text-lg",children:[(parseFloat(t.price||0)*(t.quantity||1)).toFixed(2)," ريال"]})]})]},r))})]}),e.jsxs("div",{className:"mb-8 pb-6 border-b border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"طريقة الدفع"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:a(s.paymentMethod)})]}),e.jsx("div",{className:"bg-gradient-to-r from-primary/10 to-primary/5 rounded-lg p-6 mb-8",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xl font-bold text-gray-800",children:"المجموع الكلي:"}),e.jsxs("span",{className:"text-3xl font-bold text-primary",children:[Number(s.totalAmount).toFixed(2)," ريال"]})]})}),e.jsx("div",{className:"mb-8 pt-6 border-t-2 border-dashed border-gray-300 text-center",children:e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 inline-block min-w-[200px]",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"رقم الطلب (اختصار)"}),e.jsxs("p",{className:"text-4xl font-black text-primary mb-3",children:["#",s.orderNumber.includes("-")?s.orderNumber.split("-").pop():s.orderNumber]}),e.jsx("div",{className:"text-right space-y-1",children:m.map((t,r)=>e.jsxs("p",{className:"text-sm font-bold text-gray-700",children:[t.quantity," x ",t.nameAr||t.name]},r))})]})}),s.customerNotes&&e.jsxs("div",{className:"mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:[e.jsx("p",{className:"text-sm font-semibold text-yellow-800 mb-2",children:"ملاحظات:"}),e.jsx("p",{className:"text-gray-700",children:s.customerNotes})]}),l&&e.jsxs("div",{className:"text-center mb-8 pb-6 border-b border-gray-200",children:[e.jsx("p",{className:"text-sm font-semibold text-primary mb-2",children:"امسح لتتبع طلبك"}),e.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"Scan to Track Your Order"}),e.jsx("div",{className:"inline-block p-3 bg-white border-2 border-primary/20 rounded-lg",children:e.jsx("img",{src:l,alt:"Order Tracking QR",className:"w-28 h-28 mx-auto"})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"امسح الرمز للاطلاع على حالة طلبك"})]}),e.jsxs("div",{className:"text-center pt-6 border-t border-gray-200",children:[e.jsx("p",{className:"text-lg font-semibold text-primary mb-2",children:"شكراً لزيارتكم"}),e.jsx("p",{className:"text-gray-600",children:"نتطلع لخدمتكم مرة أخرى"})]})]}),i==="button"&&e.jsxs("div",{className:"flex gap-2 w-full no-print",children:[e.jsxs(u,{onClick:x,className:"flex-1 bg-primary hover:bg-primary/90","data-testid":"button-print-invoice",children:[e.jsx(H,{className:"ml-2 h-4 w-4"}),"طباعة الفاتورة"]}),e.jsxs(u,{onClick:g,variant:"outline",className:"flex-1 bg-amber-50 hover:bg-amber-100 text-amber-800 border-amber-300","data-testid":"button-download-invoice",children:[e.jsx(F,{className:"ml-2 h-4 w-4"}),"تحميل PDF"]})]})]})}function G({order:s,customer:i}){const{toast:n}=S(),l=i?.id,[p,b]=d.useState(i?.carType||""),[m,g]=d.useState(i?.carColor||""),[x,a]=d.useState(i?.saveCarInfo===1),t=k({mutationFn:async c=>await C("POST",`/api/orders/${s.id}/car-pickup`,c),onSuccess:()=>{L.invalidateQueries({queryKey:["/api/customers",l,"orders"]}),n({title:"تم حفظ معلومات السيارة",description:"سيتم توصيل طلبك إلى سيارتك"})},onError:()=>{n({variant:"destructive",title:"خطأ",description:"حدث خطأ أثناء حفظ معلومات السيارة"})}}),r=k({mutationFn:async()=>{if(l)return await C("PATCH",`/api/customers/${l}`,{carType:p,carColor:m,saveCarInfo:x?1:0})}}),o=async c=>{if(c.preventDefault(),!p.trim()||!m.trim()){n({variant:"destructive",title:"خطأ",description:"يرجى إدخال نوع السيارة ولونها"});return}try{await t.mutateAsync({carType:p,carColor:m}),x&&l&&await r.mutateAsync()}catch(f){console.error("Error updating car pickup:",f)}};return s.carPickup?e.jsx(h,{className:"bg-gradient-to-br from-purple-900/20 to-purple-800/20 border-purple-500/30",children:e.jsx(v,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-3 rounded-full bg-purple-500/20",children:e.jsx(A,{className:"w-6 h-6 text-purple-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-purple-400 mb-2",children:"معلومات السيارة"}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-300",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-purple-400",children:"النوع:"})," ",s.carPickup.carType]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-purple-400",children:"اللون:"})," ",s.carPickup.carColor]})]}),e.jsx("div",{className:"mt-4 p-3 bg-purple-900/30 rounded-lg border border-purple-500/20",children:e.jsxs("p",{className:"text-xs text-purple-300",children:[e.jsx(W,{className:"w-4 h-4 inline ml-1"}),"سيقوم الموظف بتوصيل طلبك إلى سيارتك"]})})]})]})})}):e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4},children:e.jsxs(h,{className:"bg-gradient-to-br from-purple-900/20 to-purple-800/20 border-purple-500/30",children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2 text-purple-400",children:[e.jsx(A,{className:"w-5 h-5"}),"استلام من السيارة"]}),e.jsx("p",{className:"text-sm text-gray-400",children:"أدخل معلومات سيارتك لتوصيل الطلب إليك"})]}),e.jsx(v,{children:e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"carType",className:"text-gray-300",children:"نوع السيارة"}),e.jsx(w,{id:"carType",value:p,onChange:c=>b(c.target.value),placeholder:"مثال: كامري، سوناتا، اكورد",className:"bg-gray-800/50 border-gray-700 text-white","data-testid":"input-car-type"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"carColor",className:"text-gray-300",children:"لون السيارة"}),e.jsx(w,{id:"carColor",value:m,onChange:c=>g(c.target.value),placeholder:"مثال: أبيض، أسود، فضي",className:"bg-gray-800/50 border-gray-700 text-white","data-testid":"input-car-color"})]}),l&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{id:"saveCarInfo",checked:x,onCheckedChange:c=>a(c),className:"border-gray-600","data-testid":"checkbox-save-car-info"}),e.jsx(N,{htmlFor:"saveCarInfo",className:"text-sm text-gray-300 cursor-pointer",children:"حفظ معلومات السيارةللطلبات المستقبلية"})]}),e.jsx(u,{type:"submit",className:"w-full bg-purple-600 hover:bg-purple-700 text-white",disabled:t.isPending,"data-testid":"button-submit-car-info",children:t.isPending?e.jsx(e.Fragment,{children:"جاري الحفظ..."}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"ml-2 h-4 w-4"}),"حفظ معلومات السيارة"]})})]})})]})})}function de(){const[,s]=O(),{customer:i}=R();d.useEffect(()=>{document.title="طلباتي - CLUNY CAFE | متابعة الطلبات والحالة";const a=document.querySelector('meta[name="description"]');a&&a.setAttribute("content","متابع طلباتك السابقة والحالية في CLUNY CAFE - تتبع آني للحالة والتوصيل")},[]);const n=i?.phone||i?.phoneNumber||i?.phoneNumberAr,l=i?.id,p=!!i&&(!!n||!!l);d.useEffect(()=>{console.log("[MyOrders] Customer:",i),console.log("[MyOrders] Phone:",n,"ID:",l)},[i,n,l]);const{data:b=[],isLoading:m,refetch:g}=q({queryKey:["/api/orders/customer",n||l],enabled:!!(n||l),refetchInterval:5e3,queryFn:async()=>{const a=n||l;if(!a)return[];console.log("[MyOrders] Fetching orders for:",a);const t=await fetch(`/api/orders/customer/${a}`);if(!t.ok)return console.error("[MyOrders] Failed to fetch orders:",t.statusText),[];const r=await t.json();return console.log("[MyOrders] Fetched orders:",r?.length||0),r}}),x=d.useMemo(()=>{const a=E.getOrders(),t=[...b];return a.forEach(r=>{t.find(o=>o.orderNumber===r.orderNumber)||t.push(r)}),t.sort((r,o)=>new Date(o.createdAt).getTime()-new Date(r.createdAt).getTime()),t},[b]);return e.jsx(B,{showNav:!0,showHeader:!1,children:e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-amber-50 via-primary/5 to-amber-100 overflow-hidden relative","data-testid":"page-my-orders",children:[e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute top-20 left-20 w-40 h-40 bg-primary/20 rounded-full blur-3xl animate-pulse"}),e.jsx("div",{className:"absolute bottom-32 right-16 w-32 h-32 bg-accent/15 rounded-full blur-2xl animate-pulse",style:{animationDelay:"1.5s"}}),e.jsx("div",{className:"absolute top-1/2 left-10 w-28 h-28 bg-primary/10 rounded-full blur-xl animate-pulse",style:{animationDelay:"3s"}})]}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 relative z-10",children:[e.jsx(y.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex items-center justify-between mb-6",children:e.jsxs(u,{variant:"ghost",onClick:()=>s("/menu"),className:"text-accent hover:text-accent hover:bg-primary/50 backdrop-blur-sm","data-testid":"button-back",children:[e.jsx($,{className:"ml-2 h-5 w-5"}),"العودةللقائمة"]})}),e.jsxs(y.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-amiri font-bold bg-gradient-to-r from-amber-800 to-orange-700 bg-clip-text text-transparent mb-2",children:"طلباتي"}),e.jsx("p",{className:"text-accent font-cairo",children:"تتبع طلباتك السابقةوالحالية"})]}),p?m?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full animate-bounce",style:{animationDelay:"0s"}}),e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})}):x.length===0?e.jsxs(h,{className:"p-8 bg-white/90 backdrop-blur-lg shadow-2xl border-2 border-primary/50 text-center",children:[e.jsx(j,{className:"h-16 w-16 text-accent mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-amiri font-bold text-accent mb-3",children:"لا توجد طلبات بعد"}),e.jsx("p",{className:"text-accent font-cairo mb-6",children:"ابدأ طلبك الأول واستمتع بأفضل القهوة !"}),e.jsx(u,{onClick:()=>s("/menu"),className:"bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-cairo",children:"تصفح القائمة"})]}):e.jsx("div",{className:"space-y-6",children:x.map((a,t)=>e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:t*.1},children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(h,{className:"p-6 bg-white/90 backdrop-blur-lg shadow-lg border-2 border-primary/50",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(j,{className:"h-5 w-5 text-accent"}),e.jsxs("h3",{className:"text-lg font-cairo font-bold text-accent",children:["طلب #",a.orderNumber.includes("-")?a.orderNumber.split("-").pop():a.orderNumber]})]}),e.jsx("p",{className:"text-sm text-accent font-cairo",children:new Date(a.createdAt).toLocaleDateString("ar-SA",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("div",{className:"text-left",children:e.jsxs("span",{className:"text-2xl font-bold text-accent font-cairo",children:[Number(a.totalAmount).toFixed(2)," ريال"]})})]}),e.jsx("div",{className:"space-y-2",children:Array.isArray(a.items)?a.items.map((r,o)=>e.jsxs("div",{className:"flex justify-between text-sm bg-background p-2 rounded-lg",children:[e.jsxs("span",{className:"text-accent font-cairo",children:[r.nameAr||r.name," × ",r.quantity]}),e.jsxs("span",{className:"text-accent font-bold",children:[(parseFloat(r.price||"0")*(r.quantity||1)).toFixed(2)," ريال"]})]},o)):null})]}),e.jsx(Q,{order:a}),a.status==="ready"&&e.jsx(G,{order:a,customer:i}),(a.status==="ready"||a.status==="completed")&&e.jsx(K,{order:a}),a.customerNotes&&e.jsxs("div",{className:"bg-primary/20 rounded-lg p-3 mb-4 border border-primary/20",children:[e.jsx("p",{className:"text-accent text-sm font-semibold mb-1",children:"ملاحظات العميل:"}),e.jsx("p",{className:"text-white text-sm","data-testid":`text-customer-notes-${a.id}`,children:a.customerNotes})]}),a.status==="cancelled"&&a.cancellationReason&&e.jsxs("div",{className:"bg-red-900/20 rounded-lg p-3 mb-4 border border-red-500/20",children:[e.jsx("p",{className:"text-red-400 text-sm font-semibold mb-1",children:"سبب الإلغاء:"}),e.jsx("p",{className:"text-white text-sm",children:a.cancellationReason})]})]})},a.id))}):e.jsxs(h,{className:"p-8 bg-white/90 backdrop-blur-lg shadow-2xl border-2 border-primary/50 text-center",children:[e.jsx(j,{className:"h-16 w-16 text-accent mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-amiri font-bold text-accent mb-3",children:"لا توجد طلبات بعد"}),e.jsx("p",{className:"text-accent font-cairo mb-6",children:"قم بتسجيل الدخول أو إنشاء طلب جديد لعرض طلباتك"}),e.jsx(u,{onClick:()=>s("/menu"),className:"bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-cairo",children:"تصفح القائمة"})]})]})]})})}export{de as default};
