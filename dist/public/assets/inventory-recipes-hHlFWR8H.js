import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as o}from"./vendor-react-Bzsngnqy.js";import{a as Q,b as te}from"./vendor-query-CX8ZYlKb.js";import{l as Je,e as Xe,q as w,j as C,i as Z,T as Ye,C as z,x as _e,X as et,I as Ce,f as E,az as ke,aA as qe,B as u,aB as Ie,au as A,D as ae,E as se,F as re,H as ne,J as ie,P as Re,$ as tt,K as de,aa as at,ab as st,ac as Ae,ai as We,L as le,v as ce,N as k}from"./index-CLvpp2UE.js";import{P as rt}from"./progress-DVPXITZU.js";import{S as oe,a as me,b as xe,c as ue,d as $}from"./select-BzAjeBJu.js";import{T as Se,a as Te,b as W,c as x,d as Fe,e as m}from"./table-DVDQb40v.js";import{B}from"./book-open-DSeJOfJp.js";import{C as Pe}from"./circle-check-big-DlXUvwLH.js";import{C as he}from"./calculator-Czd8XuWZ.js";import{T as pe}from"./trending-up-BzxeYQ4e.js";import{T as Le}from"./trending-down-By0t33Hr.js";import{E as nt}from"./eye-cZNGFzyE.js";import{C as it}from"./circle-dollar-sign-KgV0RRJC.js";import{B as ge}from"./beaker-D6g7YQNi.js";import{S as dt}from"./square-pen-C2M2occ2.js";import{D as je}from"./droplet-DmibwVCE.js";import{F as K}from"./flask-conical-CoUXkGOU.js";import{P as fe}from"./package-B_dGuXgn.js";import"./vendor-utils-BKCsaWdX.js";import"./chevron-down-CqdH-ack.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=Je("Wheat",[["path",{d:"M2 22 16 8",key:"60hf96"}],["path",{d:"M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"1rdhi6"}],["path",{d:"M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"1sdzmb"}],["path",{d:"M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z",key:"eoatbi"}],["path",{d:"M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z",key:"19rau1"}],["path",{d:"M11.47 17.47 13 19l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L5 19l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"tc8ph9"}],["path",{d:"M15.47 13.47 17 15l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L9 15l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"2m8kc5"}],["path",{d:"M19.47 9.47 21 11l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L13 11l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z",key:"vex3ng"}]]),q={kg:"كيلوجرام",g:"جرام",liter:"لتر",ml:"ملليلتر",piece:"قطعة",box:"صندوق",bag:"كيس"},Oe={kg:"كجم",g:"غ",liter:"ل",ml:"مل",piece:"قطعة",box:"صندوق",bag:"كيس"},Ne={kg:"mass",g:"mass",liter:"volume",ml:"volume",piece:"count",box:"count",bag:"count"},De={mass:{kg:1e3,g:1},volume:{liter:1e3,ml:1},count:{piece:1,box:1,bag:1}},N={"espresso-single":{name:"إسبريسو (شوت واحد)",ingredients:[{rawCode:"RAW-001",quantity:9,unit:"g",description:"حبوب قهوة أرابيكا"},{rawCode:"RAW-013",quantity:1,unit:"piece",description:"كوب صغير"}]},"espresso-double":{name:"إسبريسو (دبل شوت)",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة أرابيكا"},{rawCode:"RAW-013",quantity:1,unit:"piece",description:"كوب صغير"}]},cappuccino:{name:"كابتشينو",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:120,unit:"ml",description:"حليب طازج"},{rawCode:"RAW-014",quantity:1,unit:"piece",description:"كوب متوسط"}]},"cafe-latte":{name:"كافيه لاتيه",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:180,unit:"ml",description:"حليب طازج"},{rawCode:"RAW-014",quantity:1,unit:"piece",description:"كوب متوسط"}]},"vanilla-latte":{name:"فانيلا لاتيه",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:180,unit:"ml",description:"حليب طازج"},{rawCode:"RAW-006",quantity:30,unit:"ml",description:"سيرب فانيلا"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},mocha:{name:"موكا",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:150,unit:"ml",description:"حليب طازج"},{rawCode:"RAW-008",quantity:30,unit:"ml",description:"شوكولاتة سائلة"},{rawCode:"RAW-010",quantity:30,unit:"ml",description:"كريمة مخفوقة"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},"iced-latte":{name:"آيس لاتيه",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:200,unit:"ml",description:"حليب طازج بارد"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},"iced-mocha":{name:"آيس موكا",ingredients:[{rawCode:"RAW-001",quantity:18,unit:"g",description:"حبوب قهوة (دبل شوت)"},{rawCode:"RAW-003",quantity:180,unit:"ml",description:"حليب طازج بارد"},{rawCode:"RAW-008",quantity:30,unit:"ml",description:"شوكولاتة سائلة"},{rawCode:"RAW-010",quantity:30,unit:"ml",description:"كريمة مخفوقة"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},"iced-matcha-latte":{name:"آيس ماتشا لاتيه",ingredients:[{rawCode:"RAW-009",quantity:3,unit:"g",description:"بودرة ماتشا"},{rawCode:"RAW-003",quantity:200,unit:"ml",description:"حليب طازج بارد"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},"cold-brew":{name:"كولد برو",ingredients:[{rawCode:"RAW-019",quantity:200,unit:"ml",description:"قهوة كولد برو مركزة"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]},"vanilla-cold-brew":{name:"فانيلا كولد برو",ingredients:[{rawCode:"RAW-019",quantity:200,unit:"ml",description:"قهوة كولد برو مركزة"},{rawCode:"RAW-006",quantity:30,unit:"ml",description:"سيرب فانيلا"},{rawCode:"RAW-015",quantity:1,unit:"piece",description:"كوب كبير"}]}},ct=[{name:"شوت إسبريسو (9غ)",rawCode:"RAW-001",quantity:9,unit:"g",icon:Z},{name:"دبل شوت (18غ)",rawCode:"RAW-001",quantity:18,unit:"g",icon:Z},{name:"حليب كابتشينو (120مل)",rawCode:"RAW-003",quantity:120,unit:"ml",icon:je},{name:"حليب لاتيه (180مل)",rawCode:"RAW-003",quantity:180,unit:"ml",icon:je},{name:"حليب آيس (200مل)",rawCode:"RAW-003",quantity:200,unit:"ml",icon:je},{name:"سيرب فانيلا (30مل)",rawCode:"RAW-006",quantity:30,unit:"ml",icon:K},{name:"سيرب كراميل (30مل)",rawCode:"RAW-007",quantity:30,unit:"ml",icon:K},{name:"شوكولاتة (30مل)",rawCode:"RAW-008",quantity:30,unit:"ml",icon:K},{name:"ماتشا (3غ)",rawCode:"RAW-009",quantity:3,unit:"g",icon:lt},{name:"كريمة مخفوقة (30مل)",rawCode:"RAW-010",quantity:30,unit:"ml",icon:K},{name:"كوب صغير",rawCode:"RAW-013",quantity:1,unit:"piece",icon:fe},{name:"كوب وسط",rawCode:"RAW-014",quantity:1,unit:"piece",icon:fe},{name:"كوب كبير",rawCode:"RAW-015",quantity:1,unit:"piece",icon:fe}],Me={basic:"أساسية",hot:"ساخنة",cold:"باردة",special:"خاصة"},ot=l=>{const g=Ne[l];return g?Object.keys(De[g]||{}):[l]},S=(l,g,T)=>{const b=Ne[g],G=Ne[T];if(b!==G)return null;const s=De[b];if(!s)return l;const F=s[g]||1,V=s[T]||1;return l*F/V};function Tt(){const{toast:l}=Xe(),[g,T]=o.useState(""),[b,G]=o.useState("all"),[s,F]=o.useState(null),[V,H]=o.useState(!1),[Qe,P]=o.useState(!1),[ze,L]=o.useState(!1),[y,O]=o.useState(null),[n,I]=o.useState({rawItemId:"",quantity:1,unit:"g"}),{data:j=[],isLoading:Ee}=Q({queryKey:["/api/menu"]}),{data:h=[]}=Q({queryKey:["/api/inventory/raw-items"]}),{data:R=[],isLoading:U,isFetched:$e}=Q({queryKey:s?.id?["/api/inventory/recipes",s.id]:["/api/inventory/recipes"],enabled:!!s?.id}),{data:J=[]}=Q({queryKey:["/api/inventory/all-recipes"]}),X=te({mutationFn:t=>!t.coffeeItemId||!t.rawItemId?Promise.reject(new Error("يرجى تحديد المنتج والمادة الخام")):ce("POST","/api/inventory/recipes",t),onSuccess:()=>{s?.id&&k.invalidateQueries({queryKey:["/api/inventory/recipes",s.id]}),k.invalidateQueries({queryKey:["/api/inventory/all-recipes"]}),P(!1),I({rawItemId:"",quantity:1,unit:"g"}),l({title:"تم إضافة المكون بنجاح"})},onError:t=>{l({title:t.message||"فشل في إضافة المكون",variant:"destructive"})}}),be=te({mutationFn:t=>ce("DELETE",`/api/inventory/recipes/${t}`),onSuccess:()=>{s?.id&&k.invalidateQueries({queryKey:["/api/inventory/recipes",s.id]}),k.invalidateQueries({queryKey:["/api/inventory/all-recipes"]}),l({title:"تم حذف المكون بنجاح"})},onError:t=>{l({title:t.message||"فشل في حذف المكون",variant:"destructive"})}}),f=te({mutationFn:async t=>{const a=[];for(const r of t.ingredients)try{const i=await ce("POST","/api/inventory/recipes",{coffeeItemId:t.coffeeItemId,...r});a.push(i)}catch(i){console.error("Failed to add ingredient:",i)}return a},onSuccess:()=>{s?.id&&k.invalidateQueries({queryKey:["/api/inventory/recipes",s.id]}),k.invalidateQueries({queryKey:["/api/inventory/all-recipes"]}),L(!1),O(null),l({title:"تم إضافة الوصفة بنجاح"})},onError:t=>{l({title:t.message||"فشل في إضافة الوصفة",variant:"destructive"})}}),Be=t=>h.find(a=>a.id===t)?.nameAr||t,Y=t=>h.find(a=>a.code===t),c=o.useMemo(()=>h.find(t=>t.id===n.rawItemId),[h,n.rawItemId]),Ke=o.useMemo(()=>c?ot(c.unit):Object.keys(q),[c]),M=o.useMemo(()=>{if(!c||n.quantity<=0)return null;const t=S(n.quantity,n.unit,c.unit);return t===null?null:c.unitCost*t},[c,n.quantity,n.unit]),v=o.useMemo(()=>U||h.length===0?null:R.reduce((t,a)=>{const r=h.find(p=>p.id===a.rawItemId);if(!r)return t;const i=S(a.quantity,a.unit,r.unit);return i===null?t:t+r.unitCost*i},0),[R,h,U]),d=o.useMemo(()=>{if(v===null||!s)return null;const t=s.price-v,a=s.price>0?(1-v/s.price)*100:0;return{margin:t,percentage:a}},[v,s]),ye=t=>J.filter(a=>a.coffeeItemId===t).length,ve=t=>J.filter(r=>r.coffeeItemId===t).reduce((r,i)=>{const p=h.find(Ue=>Ue.id===i.rawItemId);if(!p)return r;const D=S(i.quantity,i.unit,p.unit);return D===null?r:r+p.unitCost*D},0),Ze=t=>{F(t),H(!0)},Ge=t=>{F(t),O(t.id),L(!0)},_=()=>{if(!s||!y)return;const t=N[y];if(!t){l({title:"لا يوجد قالب لهذا المنتج",variant:"destructive"});return}const a=t.ingredients.map(r=>{const i=Y(r.rawCode);return i?{rawItemId:i.id,quantity:r.quantity,unit:r.unit}:null}).filter(Boolean);if(a.length===0){l({title:"لم يتم العثور على المواد الخام المطلوبة",variant:"destructive"});return}f.mutate({coffeeItemId:s.id,ingredients:a})},Ve=()=>{if(!s?.id){l({title:"يرجى تحديد المنتج أولاً",variant:"destructive"});return}if(!$e){l({title:"جاري تحميل البيانات، يرجى الانتظار",variant:"destructive"});return}if(!n.rawItemId||!c){l({title:"يرجى تحديد المادة الخام",variant:"destructive"});return}if(n.quantity<=0){l({title:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}if(S(n.quantity,n.unit,c.unit)===null){l({title:"وحدة القياس غير متوافقة مع المادة الخام",variant:"destructive"});return}X.mutate({coffeeItemId:s.id,rawItemId:n.rawItemId,quantity:n.quantity,unit:n.unit})},we=j.filter(t=>{const a=t.nameAr.toLowerCase().includes(g.toLowerCase())||(t.nameEn?.toLowerCase().includes(g.toLowerCase())??!1),r=b==="all"||t.category===b;return a&&r}),He=[...new Set(j.map(t=>t.category))],ee=o.useMemo(()=>{const t=j.filter(i=>ye(i.id)>0).length,a=j.length-t,r=j.length>0?j.reduce((i,p)=>i+ve(p.id),0)/j.length:0;return{withRecipes:t,withoutRecipes:a,avgCOGS:r}},[j,J,h]);return Ee?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"h-12 w-12 text-primary animate-pulse mx-auto"}),e.jsx(w,{className:"h-6 w-6 animate-spin text-primary absolute -bottom-1 -right-1"})]}),e.jsx("p",{className:"text-muted-foreground mt-3",children:"جاري تحميل وصفات المنتجات..."})]})}):e.jsxs("div",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/50 dark:to-teal-900/50",children:e.jsx(B,{className:"h-7 w-7 text-emerald-700 dark:text-emerald-400"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:["وصفات المنتجات",e.jsx(C,{variant:"secondary",className:"font-normal bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-300",children:"COGS"})]}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"ربط المنتجات بالمواد الخام وحساب تكلفة الصنف تلقائياً"})]})]})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"rounded-xl border p-4 bg-gradient-to-br from-stone-50 to-stone-100 dark:from-stone-900/50 dark:to-stone-800/50 border-stone-200 dark:border-stone-700",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"إجمالي المنتجات"}),e.jsx(Z,{className:"h-4 w-4 text-stone-600 dark:text-stone-400"})]}),e.jsx("div",{className:"text-3xl font-bold text-stone-700 dark:text-stone-300",children:j.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"منتج في القائمة"})]}),e.jsxs("div",{className:"rounded-xl border p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/30 dark:to-emerald-800/30 border-emerald-200 dark:border-emerald-700",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"منتجات بوصفات"}),e.jsx(Pe,{className:"h-4 w-4 text-emerald-600 dark:text-emerald-400"})]}),e.jsx("div",{className:"text-3xl font-bold text-emerald-700 dark:text-emerald-300",children:ee.withRecipes}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"وصفة مكتملة"})]}),e.jsxs("div",{className:"rounded-xl border p-4 bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/30 border-primary dark:border-primary",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"تحتاج وصفات"}),e.jsx(Ye,{className:"h-4 w-4 text-accent dark:text-accent"})]}),e.jsx("div",{className:"text-3xl font-bold text-accent dark:text-accent",children:ee.withoutRecipes}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"منتج بدون وصفة"})]}),e.jsxs("div",{className:"rounded-xl border p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 border-blue-200 dark:border-blue-700",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"متوسط التكلفة"}),e.jsx(he,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})]}),e.jsx("div",{className:"text-3xl font-bold text-blue-700 dark:text-blue-300",children:ee.avgCOGS.toFixed(2)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"ر.س / منتج"})]})]}),e.jsxs(z,{children:[e.jsx(_e,{className:"border-b bg-gradient-to-r from-stone-50/50 to-transparent dark:from-stone-900/20 dark:to-transparent",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(et,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ce,{placeholder:"بحث بالاسم...",value:g,onChange:t=>T(t.target.value),className:"pr-10","data-testid":"input-search-recipes"})]}),e.jsxs(oe,{value:b,onValueChange:G,children:[e.jsx(me,{className:"w-[180px]","data-testid":"select-category-filter",children:e.jsx(xe,{placeholder:"الفئة"})}),e.jsxs(ue,{children:[e.jsx($,{value:"all",children:"جميع الفئات"}),He.map(t=>e.jsx($,{value:t,children:Me[t]||t},t))]})]})]})}),e.jsx(E,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Se,{children:[e.jsx(Te,{children:e.jsxs(W,{className:"bg-muted/50",children:[e.jsx(x,{className:"text-right",children:"المنتج"}),e.jsx(x,{className:"text-right",children:"الفئة"}),e.jsx(x,{className:"text-right",children:"سعر البيع"}),e.jsx(x,{className:"text-right",children:"التكلفة (COGS)"}),e.jsx(x,{className:"text-right",children:"هامش الربح"}),e.jsx(x,{className:"text-right",children:"المكونات"}),e.jsx(x,{className:"text-right",children:"الإجراءات"})]})}),e.jsx(Fe,{children:we.length===0?e.jsx(W,{children:e.jsxs(m,{colSpan:7,className:"text-center py-12 text-muted-foreground",children:[e.jsx(Z,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"font-medium",children:"لا توجد منتجات"}),e.jsx("p",{className:"text-sm",children:"لم يتم العثور على منتجات مطابقة"})]})}):we.map(t=>{const a=ye(t.id),r=ve(t.id);t.price-r;const i=t.price>0?(1-r/t.price)*100:0,p=N[t.id];return e.jsxs(W,{className:"hover-elevate transition-all","data-testid":`row-recipe-${t.id}`,children:[e.jsx(m,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[t.imageUrl&&e.jsx("img",{src:t.imageUrl,alt:t.nameAr,className:"w-10 h-10 rounded-lg object-cover"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.nameAr}),t.nameEn&&e.jsx("div",{className:"text-sm text-muted-foreground",children:t.nameEn})]})]})}),e.jsx(m,{children:e.jsx(C,{variant:"outline",className:"bg-muted/50",children:Me[t.category]||t.category})}),e.jsxs(m,{children:[e.jsx("span",{className:"font-medium",children:t.price.toFixed(2)}),e.jsx("span",{className:"text-muted-foreground mr-1",children:"ر.س"})]}),e.jsx(m,{children:a>0?e.jsxs("span",{className:"font-medium text-accent dark:text-accent",children:[r.toFixed(2)," ر.س"]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(m,{children:a>0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`font-medium ${i>=50?"text-emerald-600 dark:text-emerald-400":i>=30?"text-accent dark:text-accent":"text-red-600 dark:text-red-400"}`,children:[i.toFixed(0),"%"]}),i>=50?e.jsx(pe,{className:"h-4 w-4 text-emerald-600 dark:text-emerald-400"}):i>=30?e.jsx(pe,{className:"h-4 w-4 text-accent dark:text-accent"}):e.jsx(Le,{className:"h-4 w-4 text-red-600 dark:text-red-400"})]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(m,{children:a>0?e.jsxs(C,{className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-300",children:[a," مكون"]}):e.jsx(C,{variant:"outline",className:"text-muted-foreground",children:"لا توجد"})}),e.jsx(m,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(ke,{children:[e.jsx(qe,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>Ze(t),"data-testid":`button-view-recipe-${t.id}`,children:e.jsx(nt,{className:"h-4 w-4"})})}),e.jsx(Ie,{children:"عرض الوصفة"})]}),p&&a===0&&e.jsxs(ke,{children:[e.jsx(qe,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>Ge(t),className:"text-emerald-600 hover:text-emerald-700","data-testid":`button-quick-setup-${t.id}`,children:e.jsx(A,{className:"h-4 w-4"})})}),e.jsx(Ie,{children:"إعداد سريع"})]})]})})]},t.id)})})]})})})]}),e.jsx(ae,{open:V,onOpenChange:H,children:e.jsxs(se,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs(re,{children:[e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-emerald-600"}),"وصفة ",s?.nameAr]}),e.jsx(ie,{children:"إدارة مكونات وتكلفة هذا المنتج"})]}),s&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(z,{className:"border-2 border-primary/20 bg-gradient-to-br from-primary/5 to-transparent",children:e.jsx(E,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(it,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"سعر البيع"}),e.jsxs("p",{className:"text-xl font-bold",children:[s.price.toFixed(2)," ر.س"]})]})]})})}),e.jsx(z,{className:"border-2 border-primary/20 dark:border-primary/20 bg-gradient-to-br from-amber-50 to-transparent dark:from-amber-900/10 dark:to-transparent",children:e.jsx(E,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary dark:bg-primary/30",children:e.jsx(ge,{className:"h-5 w-5 text-accent dark:text-accent"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"تكلفة الصنف (COGS)"}),v===null?e.jsx("p",{className:"text-xl font-bold text-muted-foreground",children:"جاري الحساب..."}):e.jsxs("p",{className:"text-xl font-bold text-accent dark:text-accent",children:[v.toFixed(2)," ر.س"]})]})]})})}),e.jsx(z,{className:`border-2 ${d&&d.percentage>=50?"border-emerald-500/20 dark:border-emerald-400/20 bg-gradient-to-br from-emerald-50 to-transparent dark:from-emerald-900/10 dark:to-transparent":d&&d.percentage>=30?"border-primary/20 dark:border-primary/20 bg-gradient-to-br from-amber-50 to-transparent dark:from-amber-900/10 dark:to-transparent":"border-red-500/20 dark:border-red-400/20 bg-gradient-to-br from-red-50 to-transparent dark:from-red-900/10 dark:to-transparent"}`,children:e.jsxs(E,{className:"pt-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${d&&d.percentage>=50?"bg-emerald-100 dark:bg-emerald-900/30":d&&d.percentage>=30?"bg-primary dark:bg-primary/30":"bg-red-100 dark:bg-red-900/30"}`,children:d&&d.percentage>=30?e.jsx(pe,{className:`h-5 w-5 ${d.percentage>=50?"text-emerald-600 dark:text-emerald-400":"text-accent dark:text-accent"}`}):e.jsx(Le,{className:"h-5 w-5 text-red-600 dark:text-red-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"هامش الربح"}),d===null?e.jsx("p",{className:"text-xl font-bold text-muted-foreground",children:"جاري الحساب..."}):s.price===0?e.jsx("p",{className:"text-xl font-bold text-muted-foreground",children:"غير متاح"}):e.jsx("div",{children:e.jsxs("p",{className:`text-xl font-bold ${d.percentage>=50?"text-emerald-600 dark:text-emerald-400":d.percentage>=30?"text-accent dark:text-accent":"text-red-600 dark:text-red-400"}`,children:[d.margin.toFixed(2)," ر.س",e.jsxs("span",{className:"text-sm font-normal mr-1",children:["(",d.percentage.toFixed(1),"%)"]})]})})]})]}),d&&s.price>0&&e.jsx("div",{className:"mt-3",children:e.jsx(rt,{value:Math.min(d.percentage,100),className:`h-2 ${d.percentage>=50?"[&>div]:bg-emerald-500":d.percentage>=30?"[&>div]:bg-background0":"[&>div]:bg-red-500"}`})})]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"المكونات"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[N[s.id]&&R.length===0&&e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>{O(s.id),_()},disabled:f.isPending,className:"text-emerald-600 border-emerald-200 hover:bg-emerald-50 dark:border-emerald-700 dark:hover:bg-emerald-900/20","data-testid":"button-apply-template",children:[f.isPending?e.jsx(w,{className:"h-4 w-4 ml-1 animate-spin"}):e.jsx(A,{className:"h-4 w-4 ml-1"}),"إعداد سريع"]}),e.jsxs(u,{size:"sm",onClick:()=>P(!0),"data-testid":"button-add-ingredient",children:[e.jsx(Re,{className:"h-4 w-4 ml-1"}),"إضافة مكون"]})]})]}),U?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(w,{className:"h-6 w-6 animate-spin"})}):R.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground border rounded-lg bg-muted/20",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"font-medium",children:"لا توجد مكونات مضافة لهذا المنتج"}),e.jsx("p",{className:"text-sm",children:"أضف المكونات لحساب تكلفة الصنف"}),N[s.id]&&e.jsx("div",{className:"mt-4",children:e.jsxs(u,{size:"sm",onClick:()=>{O(s.id),_()},disabled:f.isPending,className:"bg-emerald-600 hover:bg-emerald-700","data-testid":"button-quick-setup-empty",children:[f.isPending?e.jsx(w,{className:"h-4 w-4 ml-1 animate-spin"}):e.jsx(A,{className:"h-4 w-4 ml-1"}),"استخدام القالب الجاهز"]})})]}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(Se,{children:[e.jsx(Te,{children:e.jsxs(W,{className:"bg-muted/50",children:[e.jsx(x,{className:"text-right",children:"المكون"}),e.jsx(x,{className:"text-right",children:"الكمية"}),e.jsx(x,{className:"text-right",children:"الوحدة"}),e.jsx(x,{className:"text-right",children:"تكلفة الوحدة"}),e.jsx(x,{className:"text-right",children:"الإجمالي"}),e.jsx(x,{className:"text-right",children:"الإجراءات"})]})}),e.jsx(Fe,{children:R.map(t=>{const a=h.find(D=>D.id===t.rawItemId),r=a?S(t.quantity,t.unit,a.unit):null,i=r!==null&&a?a.unitCost*r:0,p=a&&r!==null&&t.quantity>0?i/t.quantity:0;return e.jsxs(W,{children:[e.jsx(m,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 rounded bg-muted",children:e.jsx(ge,{className:"h-3.5 w-3.5 text-muted-foreground"})}),e.jsx("span",{className:"font-medium",children:Be(t.rawItemId)})]})}),e.jsx(m,{children:e.jsx("span",{className:"font-mono",children:t.quantity})}),e.jsx(m,{children:e.jsx(C,{variant:"outline",className:"font-normal",children:q[t.unit]||t.unit})}),e.jsx(m,{children:e.jsxs("span",{className:"text-muted-foreground",children:[p.toFixed(4)," ر.س"]})}),e.jsx(m,{children:e.jsxs("span",{className:"font-medium text-accent dark:text-accent",children:[i.toFixed(2)," ر.س"]})}),e.jsx(m,{children:e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>be.mutate(t.id),disabled:be.isPending,"data-testid":`button-delete-ingredient-${t.id}`,children:e.jsx(tt,{className:"h-4 w-4 text-destructive"})})})]},t.id)})})]})})]}),e.jsx(de,{children:e.jsx(u,{variant:"outline",onClick:()=>H(!1),children:"إغلاق"})})]})}),e.jsx(ae,{open:Qe,onOpenChange:P,children:e.jsxs(se,{className:"max-w-2xl",dir:"rtl",children:[e.jsxs(re,{children:[e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5 text-emerald-600"}),"إضافة مكون جديد"]}),e.jsxs(ie,{children:["أضف مكون جديد لوصفة ",s?.nameAr]})]}),e.jsxs(at,{defaultValue:"quick",className:"mt-4",children:[e.jsxs(st,{className:"grid w-full grid-cols-2",children:[e.jsxs(Ae,{value:"quick",className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4"}),"قوالب سريعة"]}),e.jsxs(Ae,{value:"manual",className:"flex items-center gap-2",children:[e.jsx(dt,{className:"h-4 w-4"}),"إدخال يدوي"]})]}),e.jsxs(We,{value:"quick",className:"space-y-4 mt-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:ct.map(t=>{const a=Y(t.rawCode);if(!a)return null;const r=t.icon;return e.jsxs(u,{type:"button",variant:"outline",size:"sm",className:"justify-start h-auto py-3 text-right hover-elevate",onClick:()=>{I({rawItemId:a.id,quantity:t.quantity,unit:t.unit})},"data-testid":`quick-template-${t.rawCode}`,children:[e.jsx(r,{className:"h-4 w-4 ml-2 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:a.nameAr})]})]},t.name)})}),n.rawItemId&&e.jsxs("div",{className:"p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"font-medium text-emerald-800 dark:text-emerald-200",children:"تم اختيار المكون"})]}),M!==null&&e.jsxs(C,{className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-800 dark:text-emerald-100",children:[M.toFixed(4)," ر.س"]})]}),e.jsxs("p",{className:"text-sm text-emerald-700 dark:text-emerald-300",children:[c?.nameAr," - ",n.quantity," ",Oe[n.unit]]})]})]}),e.jsxs(We,{value:"manual",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{children:"المادة الخام *"}),e.jsxs(oe,{value:n.rawItemId,onValueChange:t=>I({...n,rawItemId:t}),children:[e.jsx(me,{"data-testid":"select-raw-item",children:e.jsx(xe,{placeholder:"اختر المادة الخام"})}),e.jsx(ue,{children:h.map(t=>e.jsx($,{value:t.id,children:e.jsxs("div",{className:"flex items-center justify-between w-full gap-4",children:[e.jsx("span",{children:t.nameAr}),e.jsxs("span",{className:"text-muted-foreground text-sm",children:[t.unitCost.toFixed(2)," ر.س / ",q[t.unit]]})]})},t.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{children:"الكمية *"}),e.jsx(Ce,{type:"number",step:"0.01",min:"0.01",value:n.quantity,onChange:t=>I({...n,quantity:parseFloat(t.target.value)||1}),"data-testid":"input-quantity"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{children:"الوحدة *"}),e.jsxs(oe,{value:n.unit,onValueChange:t=>I({...n,unit:t}),children:[e.jsx(me,{"data-testid":"select-unit",children:e.jsx(xe,{})}),e.jsx(ue,{children:Ke.map(t=>e.jsx($,{value:t,children:q[t]||t},t))})]}),c&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["وحدة المادة الخام: ",q[c.unit]||c.unit]})]})]})]})]}),M!==null&&e.jsxs("div",{className:"p-4 rounded-lg bg-primary/5 border border-primary/20 mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"التكلفة المتوقعة"})]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:[M.toFixed(4)," ر.س"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[n.quantity," ",q[n.unit]," من ",c?.nameAr]})]}),e.jsxs(de,{className:"mt-6",children:[e.jsx(u,{variant:"outline",onClick:()=>P(!1),children:"إلغاء"}),e.jsxs(u,{onClick:Ve,disabled:X.isPending||!n.rawItemId,"data-testid":"button-submit-ingredient",children:[X.isPending&&e.jsx(w,{className:"h-4 w-4 ml-2 animate-spin"}),"إضافة المكون"]})]})]})}),e.jsx(ae,{open:ze,onOpenChange:L,children:e.jsxs(se,{className:"max-w-lg",dir:"rtl",children:[e.jsxs(re,{children:[e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-emerald-600"}),"إعداد سريع للوصفة"]}),e.jsxs(ie,{children:["استخدم القالب الجاهز لإضافة جميع مكونات ",s?.nameAr," بنقرة واحدة"]})]}),y&&N[y]&&e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-700",children:[e.jsx("h4",{className:"font-medium text-emerald-800 dark:text-emerald-200 mb-3",children:N[y].name}),e.jsx("div",{className:"space-y-2",children:N[y].ingredients.map((t,a)=>(Y(t.rawCode),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-3.5 w-3.5 text-emerald-600"}),e.jsx("span",{className:"text-emerald-700 dark:text-emerald-300",children:t.description})]}),e.jsxs("span",{className:"text-muted-foreground",children:[t.quantity," ",Oe[t.unit]]})]},a)))})]})}),e.jsxs(de,{children:[e.jsx(u,{variant:"outline",onClick:()=>L(!1),children:"إلغاء"}),e.jsxs(u,{onClick:_,disabled:f.isPending,className:"bg-emerald-600 hover:bg-emerald-700","data-testid":"button-confirm-template",children:[f.isPending&&e.jsx(w,{className:"h-4 w-4 ml-2 animate-spin"}),"تطبيق القالب"]})]})]})})]})}export{Tt as default};
