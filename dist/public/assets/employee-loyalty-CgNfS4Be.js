import{j as e}from"./vendor-ui-DJm-zmnP.js";import{r as x}from"./vendor-react-Bzsngnqy.js";import{a as H,b as G}from"./vendor-query-CX8ZYlKb.js";import{a4 as q,C as w,i as P,j as E,a5 as R,G as C,a1 as Q,S as Y,B as j,V,_ as W,c as _,e as J,A as K,x as U,y as $,f as z,D as X,Z,E as ee,F as te,H as se,L as I,I as M,Y as ae,a6 as le,a7 as ie,v as re,N as ne}from"./index-61RjstaY.js";import{J as oe}from"./JsBarcode-71-VwQ93.js";import{P as ce}from"./progress-C-g-xWdk.js";import{A as de}from"./award-DlCxYbR1.js";import{T as xe}from"./trending-up-CK4Nk2TF.js";import{C as F}from"./crown-Cu-Bh_2u.js";import{U as B}from"./user-plus-DT8XHvyG.js";import"./vendor-utils-BKCsaWdX.js";const A={bronze:{min:0,max:499,next:"silver"},silver:{min:500,max:1499,next:"gold"},gold:{min:1500,max:4999,next:"platinum"},platinum:{min:5e3,max:1/0,next:null}};function me(s,m){const h=A[s]||A.bronze,d=h.next;if(!d)return{percentage:100,toNext:0,nextTier:null};const r=A[d]?.min||0,o=h.min,f=r-o,i=m-o,g=Math.min(100,Math.max(0,i/f*100)),u=Math.max(0,r-m);return{percentage:g,toNext:u,nextTier:d}}function he({card:s,showActions:m=!0,compact:h=!1,showTierProgress:d=!0}){const r=x.useRef(null),o=x.useRef(null),f=!!(s.tier&&s.totalSpent!==void 0),i=me(s.tier||"bronze",s.totalSpent||0),[g,u]=x.useState(""),[b,S]=x.useState(""),l=Math.max(0,(s.freeCupsEarned||0)-(s.freeCupsRedeemed||0)),N=(s.stamps||0)%6;x.useEffect(()=>{if(r.current&&s.qrToken){const a=h?100:160,t=`https://cluny.ma3k.online/loyalty-verify?token=${s.qrToken}`;q.toCanvas(r.current,t,{width:a,margin:1,color:{dark:"#1a1410",light:"#ffffff"},errorCorrectionLevel:"H"},n=>{n&&console.error("QR Code generation error:",n)}),q.toDataURL(t,{width:400,margin:2,errorCorrectionLevel:"H"}).then(n=>{u(n)}).catch(console.error)}},[s.qrToken,h]),x.useEffect(()=>{const a=s.cardNumber||s.qrToken;if(o.current&&a)try{oe(o.current,a,{format:"CODE128",width:2,height:40,displayValue:!0,fontSize:12,margin:5,background:"#ffffff",lineColor:"#1a1410"});const t=o.current,n=new XMLSerializer().serializeToString(t),y=new Blob([n],{type:"image/svg+xml;charset=utf-8"}),T=URL.createObjectURL(y);S(T)}catch(t){console.error("Barcode generation error:",t)}},[s.cardNumber,s.qrToken]);const O=async()=>{const a=document.createElement("canvas"),t=a.getContext("2d");if(!t)return;a.width=900,a.height=550;const n=t.createLinearGradient(0,0,a.width,a.height);n.addColorStop(0,"#d4a574"),n.addColorStop(.5,"#c8956c"),n.addColorStop(1,"#a67c52"),t.fillStyle=n,t.fillRect(0,0,a.width,a.height),t.fillStyle="rgba(0,0,0,0.1)",t.beginPath(),t.arc(-50,-50,300,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a.width+50,a.height+50,250,0,Math.PI*2),t.fill(),t.fillStyle="#4a3728",t.font="bold 48px Cairo, Arial",t.textAlign="right",t.fillText("CLUNY CAFE",a.width-50,70),t.font="24px Georgia, serif",t.fillStyle="#6b4f3c",t.fillText("CLUNY CAFE Loyalty",a.width-50,105);const y={bronze:"#cd7f32",silver:"#c0c0c0",gold:"#ffd700",platinum:"#e5e4e2"},T={bronze:"برونزي",silver:"فضي",gold:"ذهبي",platinum:"بلاتيني"};if(t.fillStyle=y[s.tier]||y.bronze,t.beginPath(),t.roundRect(a.width-150,120,100,35,17),t.fill(),t.fillStyle="#4a3728",t.font="bold 16px Cairo, Arial",t.textAlign="center",t.fillText(T[s.tier]||"برونزي",a.width-100,145),t.fillStyle="#4a3728",t.font="bold 32px Cairo, Arial",t.textAlign="right",t.fillText(s.customerName||"عميل مميز",a.width-50,200),t.font="20px Arial",t.fillStyle="#6b4f3c",t.fillText(s.phoneNumber,a.width-50,235),t.fillStyle="rgba(255,255,255,0.95)",t.beginPath(),t.roundRect(50,280,800,220,15),t.fill(),g){const c=new Image;c.crossOrigin="anonymous",c.onload=()=>{t.drawImage(c,80,310,150,150),t.fillStyle="#4a3728",t.font="12px monospace",t.textAlign="center",t.fillText(s.qrToken,155,475),L(),D()},c.src=g}else L(),D();function L(){if(!t)return;t.textAlign="right",t.fillStyle="#4a3728",t.font="bold 18px Cairo, Arial",t.fillText("الأختام",400,320),t.font="14px Cairo, Arial",t.fillStyle="#6b4f3c",t.fillText(`${s.stamps||0} / 6`,400,345);const c=280;for(let v=0;v<6;v++)t.beginPath(),t.arc(c+v*25,375,10,0,Math.PI*2),v<(s.stamps||0)?(t.fillStyle="#d4a574",t.fill()):(t.strokeStyle="#d4a574",t.lineWidth=2,t.stroke());t.textAlign="right",t.fillStyle="#4a3728",t.font="bold 18px Cairo, Arial",t.fillText("مشروبات مجانية متاحة",600,320),t.font="bold 36px Cairo, Arial",t.fillStyle=l>0?"#22c55e":"#6b4f3c",t.fillText(String(l),600,370),t.font="bold 18px Cairo, Arial",t.fillStyle="#4a3728",t.fillText("إجمالي المشتريات",800,320),t.font="bold 24px Cairo, Arial",t.fillText(`${s.totalSpent||0} ر.س`,800,355),t.font="bold 18px Cairo, Arial",t.fillText("مرات الاستخدام",800,410),t.font="bold 24px Cairo, Arial",t.fillText(String(s.discountCount||0),800,445)}function D(){const c=document.createElement("a");c.download=`بطاقة-كوبي-${s.customerName||"loyalty"}.png`,c.href=a.toDataURL("image/png"),c.click()}},k={bronze:{nameAr:"برونزي",color:"from-amber-600 via-amber-700 to-amber-800",badgeColor:"bg-amber-600"},silver:{nameAr:"فضي",color:"from-slate-400 via-slate-500 to-slate-600",badgeColor:"bg-slate-500"},gold:{nameAr:"ذهبي",color:"from-yellow-500 via-amber-500 to-yellow-600",badgeColor:"bg-yellow-500"},platinum:{nameAr:"بلاتيني",color:"from-gray-400 via-gray-300 to-gray-400",badgeColor:"bg-gray-400"}},p=k[s.tier]||k.bronze;return h?e.jsxs(w,{className:`relative overflow-hidden bg-gradient-to-br ${p.color} text-white shadow-xl`,"data-testid":"loyalty-card-compact",children:[e.jsx("div",{className:"absolute inset-0 bg-black/10"}),e.jsxs("div",{className:"relative p-4 flex items-center gap-4",children:[e.jsx("div",{className:"bg-white p-2 rounded-lg shadow-md",children:e.jsx("canvas",{ref:r,className:"w-16 h-16","data-testid":"canvas-qr-compact"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsx("span",{className:"font-bold text-lg",children:"بطاقة كوبي"}),e.jsx(E,{className:`${p.badgeColor} text-white text-xs`,children:p.nameAr})]}),e.jsx("p",{className:"text-sm opacity-90 truncate","data-testid":"text-customer-name-compact",children:s.customerName}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-4 h-4"}),N,"/6 أختام"]}),l>0&&e.jsxs("span",{className:"flex items-center gap-1 text-green-300 font-bold",children:[e.jsx(C,{className:"w-4 h-4"}),l," مجاني"]})]})]})]})]}):e.jsxs("div",{className:"space-y-4","data-testid":"loyalty-card",children:[e.jsxs(w,{className:`relative overflow-hidden bg-gradient-to-br ${p.color} text-white shadow-2xl`,children:[e.jsx("div",{className:"absolute inset-0 bg-black/15"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-64 h-64 bg-white/5 rounded-full -translate-x-1/2 translate-y-1/2"}),e.jsx("div",{className:"absolute top-0 right-0 w-48 h-48 bg-white/5 rounded-full translate-x-1/2 -translate-y-1/2"}),e.jsxs("div",{className:"relative p-6 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-full flex items-center justify-center",children:e.jsx(P,{className:"w-7 h-7"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold","data-testid":"text-brand",children:"CLUNY CAFE"}),e.jsx("p",{className:"text-sm opacity-80",children:"بطاقة الولاء الذكية"})]})]}),e.jsxs(E,{className:`${p.badgeColor} text-white px-3 py-1 text-sm`,children:[e.jsx(de,{className:"w-4 h-4 ml-1"}),e.jsx("span",{"data-testid":"text-tier",children:p.nameAr})]})]}),e.jsx("div",{className:"flex items-start justify-between gap-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-2xl font-bold","data-testid":"text-customer-name",children:s.customerName||"عميل مميز"}),e.jsxs("p",{className:"text-sm opacity-80 flex items-center gap-2","data-testid":"text-phone",children:[e.jsx(Q,{className:"w-4 h-4"}),s.phoneNumber]}),e.jsxs("p",{className:"text-xs opacity-60 font-mono","data-testid":"text-card-number",children:["رقم البطاقة: ",s.cardNumber]})]})}),e.jsxs("div",{className:"flex items-center justify-between gap-6 bg-white/10 rounded-xl p-4",children:[e.jsxs("div",{className:"bg-white p-2 rounded-lg shadow-lg",children:[e.jsx("canvas",{ref:r,className:"w-28 h-28","data-testid":"canvas-qr"}),e.jsx("p",{className:"text-xs text-center text-gray-600 mt-1 font-mono bg-white rounded px-1",children:s.qrToken})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white/10 rounded-lg p-3",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 mb-1",children:e.jsx(R,{className:"w-5 h-5 text-yellow-300"})}),e.jsxs("div",{className:"text-2xl font-bold",children:[N,"/6"]}),e.jsx("div",{className:"text-xs opacity-80",children:"أختام"}),e.jsx("div",{className:"flex justify-center gap-1 mt-2",children:Array.from({length:6}).map((a,t)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${t<N?"bg-yellow-300":"bg-white/30"}`},t))})]}),e.jsxs("div",{className:`rounded-lg p-3 ${l>0?"bg-green-500/30":"bg-white/10"}`,children:[e.jsx("div",{className:"flex items-center justify-center gap-1 mb-1",children:e.jsx(C,{className:"w-5 h-5 text-green-300"})}),e.jsx("div",{className:`text-2xl font-bold ${l>0?"text-green-300":""}`,"data-testid":"text-free-drinks",children:l}),e.jsx("div",{className:"text-xs opacity-80",children:"مشروب مجاني"})]}),e.jsxs("div",{className:"bg-white/10 rounded-lg p-3",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 mb-1",children:e.jsx(Y,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-xl font-bold","data-testid":"text-discount-count",children:s.discountCount||0}),e.jsx("div",{className:"text-xs opacity-80",children:"مرة استخدام"})]}),e.jsxs("div",{className:"bg-white/10 rounded-lg p-3",children:[e.jsx("div",{className:"text-xl font-bold","data-testid":"text-total-spent",children:s.totalSpent||0}),e.jsx("div",{className:"text-xs opacity-80",children:"ر.س إجمالي"})]})]})]}),e.jsx("div",{className:"bg-white rounded-lg p-2 overflow-hidden flex justify-center",children:e.jsx("svg",{ref:o,"data-testid":"svg-barcode"})}),d&&f&&i.nextTier&&e.jsxs("div",{className:"bg-white/10 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"تقدم المستوى"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(F,{className:"w-3 h-3"}),e.jsxs("span",{children:["المستوى التالي: ",i.nextTier==="silver"?"فضي":i.nextTier==="gold"?"ذهبي":"بلاتيني"]})]})]}),e.jsx(ce,{value:i.percentage,className:"h-2"}),e.jsxs("div",{className:"flex justify-between text-xs opacity-80",children:[e.jsxs("span",{children:[i.percentage.toFixed(0),"% مكتمل"]}),e.jsxs("span",{children:["متبقي ",i.toNext," ر.س للترقية"]})]})]}),d&&f&&!i.nextTier&&e.jsxs("div",{className:"bg-gradient-to-r from-amber-500/20 to-yellow-500/20 rounded-xl p-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-1",children:[e.jsx(F,{className:"w-5 h-5 text-yellow-300"}),e.jsx("span",{className:"font-bold text-yellow-200",children:"أعلى مستوى!"})]}),e.jsx("p",{className:"text-xs opacity-80",children:"أنت في المستوى البلاتيني - استمتع بجميع المزايا الحصرية"})]})]})]}),m&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(j,{onClick:O,variant:"outline",className:"gap-2","data-testid":"button-download-card",children:[e.jsx(V,{className:"w-4 h-4"}),"تحميل البطاقة"]}),e.jsxs(j,{variant:"outline",className:"gap-2","data-testid":"button-apple-wallet",onClick:()=>{const a=`https://cluny.ma3k.online/api/loyalty/cards/${s.id}/apple-wallet-pass`;window.open(a,"_blank")},children:[e.jsx(W,{className:"w-4 h-4"}),"Apple Wallet"]})]})]})}function Se(){const[,s]=_(),{toast:m}=J(),[h,d]=x.useState(!1),[r,o]=x.useState(""),[f,i]=x.useState(""),{data:g=[],isLoading:u}=H({queryKey:["/api/loyalty/cards"]}),b=G({mutationFn:async l=>(await re("POST","/api/loyalty/cards",l)).json(),onSuccess:()=>{ne.invalidateQueries({queryKey:["/api/loyalty/cards"]}),m({title:"تم إنشاء بطاقة الولاء!",description:`تم إصدار بطاقة جديدة للعميل ${r}`}),d(!1),o(""),i("")},onError:l=>{m({variant:"destructive",title:"خطأ",description:l.message||"فشل في إنشاء بطاقة الولاء"})}}),S=()=>{if(!f.trim()){m({variant:"destructive",title:"خطأ",description:"الرجاء إدخال رقم الهاتف"});return}b.mutate({customerName:r.trim(),phoneNumber:f.trim()})};return e.jsxs("div",{dir:"rtl",className:"min-h-screen bg-background p-4",children:[e.jsx("div",{className:"max-w-7xl mx-auto mb-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs(j,{variant:"ghost",onClick:()=>s("/employee/dashboard"),"data-testid":"button-back",children:[e.jsx(K,{className:"w-5 h-5 ml-2"}),"العودة للوحة التحكم"]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg shadow-lg",children:[e.jsx(C,{className:"w-5 h-5"}),e.jsx("span",{className:"font-bold",children:"إدارة بطاقات الولاء"})]})})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs(w,{children:[e.jsx(U,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"إصدار بطاقة ولاء جديدة"]})}),e.jsx(z,{children:e.jsxs(X,{open:h,onOpenChange:d,children:[e.jsx(Z,{asChild:!0,children:e.jsxs(j,{className:"w-full","data-testid":"button-create-card",children:[e.jsx(B,{className:"w-4 h-4 ml-2"}),"إنشاء بطاقة ولاء جديدة"]})}),e.jsxs(ee,{children:[e.jsx(te,{children:e.jsx(se,{children:"بيانات العميل"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"customer-name",children:"اسم العميل"}),e.jsx(M,{id:"customer-name",value:r,onChange:l=>o(l.target.value),placeholder:"محمد أحمد","data-testid":"input-customer-name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"phone-number",children:"رقم الهاتف (9 أرقام تبدأ بـ 5)"}),e.jsx(M,{id:"phone-number",value:f,onChange:l=>i(l.target.value),placeholder:"5xxxxxxxx","data-testid":"input-phone-number"})]}),e.jsx(j,{onClick:S,disabled:b.isPending,className:"w-full","data-testid":"button-submit-card",children:b.isPending?"جاري الإنشاء...":"إصدار البطاقة"})]})]})]})})]}),e.jsxs(w,{children:[e.jsx(U,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5"}),"بطاقات الولاء المُصدرة (",g.length,")"]})}),e.jsx(z,{children:u?e.jsx(le,{message:"جاري تحميل بطاقات الولاء..."}):g.length===0?e.jsx(ie,{title:"لا توجد بطاقات ولاء",description:"لم يتم إصدار أي بطاقات ولاء حتى الآن. قم بإنشاء أول بطاقة للبدء!",icon:e.jsx(C,{className:"h-10 w-10 text-muted-foreground"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:g.map(l=>e.jsx("div",{"data-testid":`loyalty-card-${l.id}`,children:e.jsx(he,{card:l})},l.id))})})]})]})]})}export{Se as default};
