import{j as e}from"./vendor-ui-DJm-zmnP.js";import{a as f}from"./vendor-query-CX8ZYlKb.js";import{r as g}from"./vendor-react-Bzsngnqy.js";import{q as S,C as o,x as c,y as d,f as x,L as N,I as v,W as O,B as I,V as P}from"./index-61RjstaY.js";import{D as j}from"./dollar-sign-B-fnJpJ6.js";import{T as R}from"./trending-down-3gb6g0y8.js";import{T}from"./trending-up-CK4Nk2TF.js";import{R as A,B as G,C as B,X as K,Y as L,T as k,L as q,N as u}from"./BarChart-C-BXurcz.js";import"./vendor-utils-BKCsaWdX.js";function W(){const[h,y]=g.useState(new Date(new Date().setDate(new Date().getDate()-30)).toISOString().split("T")[0]),[p,b]=g.useState(new Date().toISOString().split("T")[0]),{data:i=[],isLoading:w}=f({queryKey:["/api/orders",h,p]});f({queryKey:["/api/accounting/daily-snapshot/:branchId",h]});const F=()=>{if(!i||i.length===0)return{totalRevenue:0,totalCOGS:0,totalProfit:0,profitMargin:0,orderCount:0,avgOrderValue:0};const s=i.reduce((l,m)=>l+(m.totalAmount||0),0),r=i.reduce((l,m)=>l+(m.costOfGoods||0),0),t=s-r,n=s>0?t/s*100:0;return{totalRevenue:parseFloat(s.toFixed(2)),totalCOGS:parseFloat(r.toFixed(2)),totalProfit:parseFloat(t.toFixed(2)),profitMargin:parseFloat(n.toFixed(2)),orderCount:i.length,avgOrderValue:parseFloat((s/i.length).toFixed(2))}},C=()=>{const s={};return i.forEach(r=>{const t=typeof r.items=="string"?JSON.parse(r.items):r.items;Array.isArray(t)&&t.forEach(n=>{const l=n.coffeeItemId||n.id;s[l]||(s[l]={revenue:0,cogs:0,count:0,name:n.nameAr||n.name||"Unknown"}),s[l].revenue+=n.totalPrice||0,s[l].cogs+=(n.costPerItem||0)*(n.quantity||1),s[l].count+=n.quantity||1})}),Object.entries(s).map(([r,t])=>({id:r,name:t.name,revenue:parseFloat(t.revenue.toFixed(2)),cogs:parseFloat(t.cogs.toFixed(2)),profit:parseFloat((t.revenue-t.cogs).toFixed(2)),margin:t.revenue>0?parseFloat(((t.revenue-t.cogs)/t.revenue*100).toFixed(1)):0,count:t.count})).sort((r,t)=>t.profit-r.profit)},a=F(),D=C();return w?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(S,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"p-6 space-y-6 bg-background min-h-screen text-right",dir:"rtl",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"لوحة المحاسبة التشغيلية (Operating System Accounting)"}),e.jsx(j,{className:"w-8 h-8 text-primary"})]}),e.jsxs(o,{children:[e.jsx(c,{children:e.jsx(d,{children:"فلتر التقارير"})}),e.jsx(x,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"من التاريخ"}),e.jsx(v,{type:"date",value:h,onChange:s=>y(s.target.value)})]}),e.jsxs("div",{children:[e.jsx(N,{children:"إلى التاريخ"}),e.jsx(v,{type:"date",value:p,onChange:s=>b(s.target.value)})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(o,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"إجمالي المبيعات"}),e.jsx(j,{className:"w-4 h-4 text-green-600"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.totalRevenue.toFixed(2)," ريال"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.orderCount," طلب"]})]})]}),e.jsxs(o,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"تكلفة البضائع المباعة"}),e.jsx(R,{className:"w-4 h-4 text-orange-600"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.totalCOGS.toFixed(2)," ريال"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(a.totalCOGS/a.totalRevenue*100||0).toFixed(1),"% من المبيعات"]})]})]}),e.jsxs(o,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"إجمالي الربح"}),e.jsx(T,{className:"w-4 h-4 text-blue-600"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[a.totalProfit.toFixed(2)," ريال"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["هامش: ",a.profitMargin.toFixed(1),"%"]})]})]}),e.jsxs(o,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"متوسط قيمة الطلب"}),e.jsx(j,{className:"w-4 h-4 text-purple-600"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.avgOrderValue.toFixed(2)," ريال"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"لكل طلب"})]})]})]}),e.jsxs(o,{children:[e.jsxs(c,{children:[e.jsx(d,{children:"أكثر المشروبات ربحية"}),e.jsx(O,{children:"ترتيب المشروبات حسب الربح الإجمالي"})]}),e.jsx(x,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-right p-2",children:"المشروب"}),e.jsx("th",{className:"text-right p-2",children:"المبيعات"}),e.jsx("th",{className:"text-right p-2",children:"التكلفة"}),e.jsx("th",{className:"text-right p-2",children:"الربح"}),e.jsx("th",{className:"text-right p-2",children:"الهامش"}),e.jsx("th",{className:"text-right p-2",children:"العدد"})]})}),e.jsx("tbody",{children:D.slice(0,10).map((s,r)=>e.jsxs("tr",{className:"border-b hover:bg-muted",children:[e.jsx("td",{className:"p-2 font-medium",children:s.name}),e.jsx("td",{className:"p-2",children:s.revenue.toFixed(2)}),e.jsx("td",{className:"p-2",children:s.cogs.toFixed(2)}),e.jsx("td",{className:"p-2 font-bold text-green-600",children:s.profit.toFixed(2)}),e.jsxs("td",{className:"p-2",children:[s.margin,"%"]}),e.jsx("td",{className:"p-2",children:s.count})]},r))})]})})})]}),e.jsxs(o,{children:[e.jsx(c,{children:e.jsx(d,{children:"ملخص المالية"})}),e.jsx(x,{children:e.jsx(A,{width:"100%",height:300,children:e.jsxs(G,{data:[{name:"الملخص",المبيعات:a.totalRevenue,التكلفة:a.totalCOGS,الربح:a.totalProfit}],children:[e.jsx(B,{strokeDasharray:"3 3"}),e.jsx(K,{dataKey:"name"}),e.jsx(L,{}),e.jsx(k,{}),e.jsx(q,{}),e.jsx(u,{dataKey:"المبيعات",fill:"#10b981"}),e.jsx(u,{dataKey:"التكلفة",fill:"#f97316"}),e.jsx(u,{dataKey:"الربح",fill:"#3b82f6"})]})})})]}),e.jsxs(I,{className:"w-full",children:[e.jsx(P,{className:"ml-2 w-4 h-4"}),"تحميل التقرير"]})]})}export{W as default};
